'use strict';(function(n){function U(){return Array.prototype.slice.call(this)}function P(h,f){if(h.constructor===f)return h;if(h.constructor!==Array)return f=f||Float32Array,new f(h);f=f||Float32Array;for(var a=h[0].length,b=new f(h.length*a),c=0;c<h.length;++c)for(var d=0;d<a;++d)b[c*a+d]=h[c][d];return b}function G(h,f,a,b){this.gl=b=b||n.gl;this._context_id=b.context_id;if(h&&h.constructor!==Array)throw"FBO textures must be an Array";this.handler=null;this.height=this.width=-1;this.color_textures=
[];this.depth_texture=null;this.stencil=!!a;this._stencil_enabled=!1;this._num_binded_textures=0;(h&&h.length||f)&&this.setTextures(h,f);this._old_fbo_handler=null;this._old_viewport=new Float32Array(4)}var g=n.GL={};n.requestAnimationFrame=n.requestAnimationFrame||n.mozRequestAnimationFrame||n.webkitRequestAnimationFrame||function(h){setTimeout(h,1E3/60)};g.blockable_keys={Up:!0,Down:!0,Left:!0,Right:!0};g.LEFT_MOUSE_BUTTON=1;g.MIDDLE_MOUSE_BUTTON=2;g.RIGHT_MOUSE_BUTTON=3;g.last_context_id=0;g.COLOR_BUFFER_BIT=
16384;g.DEPTH_BUFFER_BIT=256;g.STENCIL_BUFFER_BIT=1024;g.TEXTURE_2D=3553;g.TEXTURE_CUBE_MAP=34067;g.TEXTURE_3D=32879;g.TEXTURE_MAG_FILTER=10240;g.TEXTURE_MIN_FILTER=10241;g.TEXTURE_WRAP_S=10242;g.TEXTURE_WRAP_T=10243;g.BYTE=5120;g.UNSIGNED_BYTE=5121;g.SHORT=5122;g.UNSIGNED_SHORT=5123;g.INT=5124;g.UNSIGNED_INT=5125;g.FLOAT=5126;g.HALF_FLOAT_OES=36193;g.HALF_FLOAT=5131;g.DEPTH_COMPONENT16=33189;g.DEPTH_COMPONENT24=33190;g.DEPTH_COMPONENT32F=36012;g.FLOAT_VEC2=35664;g.FLOAT_VEC3=35665;g.FLOAT_VEC4=35666;
g.INT_VEC2=35667;g.INT_VEC3=35668;g.INT_VEC4=35669;g.BOOL=35670;g.BOOL_VEC2=35671;g.BOOL_VEC3=35672;g.BOOL_VEC4=35673;g.FLOAT_MAT2=35674;g.FLOAT_MAT3=35675;g.FLOAT_MAT4=35676;g.TYPE_LENGTH={};g.TYPE_LENGTH[g.FLOAT]=g.TYPE_LENGTH[g.INT]=g.TYPE_LENGTH[g.BYTE]=g.TYPE_LENGTH[g.BOOL]=1;g.TYPE_LENGTH[g.FLOAT_VEC2]=g.TYPE_LENGTH[g.INT_VEC2]=g.TYPE_LENGTH[g.BOOL_VEC2]=2;g.TYPE_LENGTH[g.FLOAT_VEC3]=g.TYPE_LENGTH[g.INT_VEC3]=g.TYPE_LENGTH[g.BOOL_VEC3]=3;g.TYPE_LENGTH[g.FLOAT_VEC4]=g.TYPE_LENGTH[g.INT_VEC4]=
g.TYPE_LENGTH[g.BOOL_VEC4]=4;g.TYPE_LENGTH[g.FLOAT_MAT3]=9;g.TYPE_LENGTH[g.FLOAT_MAT4]=16;g.SAMPLER_2D=35678;g.SAMPLER_3D=35679;g.SAMPLER_CUBE=35680;g.DEPTH_COMPONENT=6402;g.ALPHA=6406;g.RGB=6407;g.RGBA=6408;g.LUMINANCE=6409;g.LUMINANCE_ALPHA=6410;g.DEPTH_STENCIL=34041;g.UNSIGNED_INT_24_8_WEBGL=34042;g.R8=33321;g.R16F=33325;g.R32F=33326;g.R8UI=33330;g.RG8=33323;g.RG16F=33327;g.RG32F=33328;g.RGB8=32849;g.SRGB8=35905;g.RGB565=36194;g.R11F_G11F_B10F=35898;g.RGB9_E5=35901;g.RGB16F=34843;g.RGB32F=34837;
g.RGB8UI=36221;g.RGBA8=32856;g.RGB5_A1=32855;g.RGBA16F=34842;g.RGBA32F=34836;g.RGBA8UI=36220;g.RGBA16I=36232;g.RGBA16UI=36214;g.RGBA32I=36226;g.RGBA32UI=36208;g.NEAREST=9728;g.LINEAR=9729;g.NEAREST_MIPMAP_NEAREST=9984;g.LINEAR_MIPMAP_NEAREST=9985;g.NEAREST_MIPMAP_LINEAR=9986;g.LINEAR_MIPMAP_LINEAR=9987;g.REPEAT=10497;g.CLAMP_TO_EDGE=33071;g.MIRRORED_REPEAT=33648;g.ZERO=0;g.ONE=1;g.SRC_COLOR=768;g.ONE_MINUS_SRC_COLOR=769;g.SRC_ALPHA=770;g.ONE_MINUS_SRC_ALPHA=771;g.DST_ALPHA=772;g.ONE_MINUS_DST_ALPHA=
773;g.DST_COLOR=774;g.ONE_MINUS_DST_COLOR=775;g.SRC_ALPHA_SATURATE=776;g.CONSTANT_COLOR=32769;g.ONE_MINUS_CONSTANT_COLOR=32770;g.CONSTANT_ALPHA=32771;g.ONE_MINUS_CONSTANT_ALPHA=32772;g.VERTEX_SHADER=35633;g.FRAGMENT_SHADER=35632;g.FRONT=1028;g.BACK=1029;g.FRONT_AND_BACK=1032;g.NEVER=512;g.LESS=513;g.EQUAL=514;g.LEQUAL=515;g.GREATER=516;g.NOTEQUAL=517;g.GEQUAL=518;g.ALWAYS=519;g.KEEP=7680;g.REPLACE=7681;g.INCR=7682;g.DECR=7683;g.INCR_WRAP=34055;g.DECR_WRAP=34056;g.INVERT=5386;g.STREAM_DRAW=35040;g.STATIC_DRAW=
35044;g.DYNAMIC_DRAW=35048;g.ARRAY_BUFFER=34962;g.ELEMENT_ARRAY_BUFFER=34963;g.POINTS=0;g.LINES=1;g.LINE_LOOP=2;g.LINE_STRIP=3;g.TRIANGLES=4;g.TRIANGLE_STRIP=5;g.TRIANGLE_FAN=6;g.CW=2304;g.CCW=2305;g.CULL_FACE=2884;g.DEPTH_TEST=2929;g.BLEND=3042;g.temp_vec3=vec3.create();g.temp2_vec3=vec3.create();g.temp_vec4=vec4.create();g.temp_quat=quat.create();g.temp_mat3=mat3.create();g.temp_mat4=mat4.create();n.DEG2RAD=0.0174532925;n.RAD2DEG=57.295779578552306;n.EPSILON=1E-6;n.isPowerOfTwo=g.isPowerOfTwo=function(h){return 0==
Math.log(h)/Math.log(2)%1};[Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array].forEach(function(h){h.prototype.toJSON||Object.defineProperty(h.prototype,"toJSON",{value:U,enumerable:!1})});n.getTime="undefined"!=typeof performance?performance.now.bind(performance):Date.now.bind(Date);g.getTime=n.getTime;n.isFunction=function(h){return!!(h&&h.constructor&&h.call&&h.apply)};n.isArray=function(h){return h&&h.constructor===Array};n.isNumber=function(h){return null!=
h&&h.constructor===Number};n.getClassName=function(h){if(h){if(h.name)return h.name;if(h.toString&&(h=h.toString().match(/function\s*(\w+)/))&&2==h.length)return h[1]}};n.cloneObject=g.cloneObject=function(h,f){if(h.constructor!==Object)throw"cloneObject only can clone pure javascript objects, not classes";f=f||{};for(var a in h){var b=h[a];if(null===b)f[a]=null;else switch(b.constructor){case Int8Array:case Uint8Array:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:f[a]=
new b.constructor(b);break;case Boolean:case Number:case String:f[a]=b;break;case Array:f[a]=b.concat();break;case Object:f[a]=g.cloneObject(b)}}return f};n.regexMap=function(h,f,a){for(var b;null!=(b=h.exec(f));)a(b)};n.createCanvas=g.createCanvas=function(h,f){var a=document.createElement("canvas");a.width=h;a.height=f;return a};n.cloneCanvas=g.cloneCanvas=function(h){var f=document.createElement("canvas");f.width=h.width;f.height=h.height;f.getContext("2d").drawImage(h,0,0);return f};"undefined"!=
typeof Image&&(Image.prototype.getPixels=function(){var h=document.createElement("canvas");h.width=this.width;h.height=this.height;h=h.getContext("2d");h.drawImage(this,0,0);return h.getImageData(0,0,this.width,this.height).data});String.prototype.hasOwnProperty("replaceAll")||Object.defineProperty(String.prototype,"replaceAll",{value:function(h){var f=this,a;for(a in h)f=f.split(a).join(h[a]);return f},enumerable:!1});String.prototype.hasOwnProperty("hashCode")||Object.defineProperty(String.prototype,
"hashCode",{value:function(){var h=0,f,a,b;if(0==this.length)return h;f=0;for(b=this.length;f<b;++f)a=this.charCodeAt(f),h=(h<<5)-h+a,h|=0;return h},enumerable:!1});Array.prototype.hasOwnProperty("subarray")||Object.defineProperty(Array.prototype,"subarray",{value:Array.prototype.slice,enumerable:!1});Array.prototype.hasOwnProperty("clone")||Object.defineProperty(Array.prototype,"clone",{value:Array.prototype.concat,enumerable:!1});Float32Array.prototype.hasOwnProperty("clone")||Object.defineProperty(Float32Array.prototype,
"clone",{value:function(){return new Float32Array(this)},enumerable:!1});n.wipeObject=function(h){for(var f in h)h.hasOwnProperty(f)&&delete h[f]};n.extendClass=g.extendClass=function(h,f){for(var a in f)h.hasOwnProperty(a)||(h[a]=f[a]);if(f.prototype){var b=Object.getOwnPropertyNames(f.prototype);for(a=0;a<b.length;++a){var c=b[a];h.prototype.hasOwnProperty(c)||(f.prototype.__lookupGetter__(c)?h.prototype.__defineGetter__(c,f.prototype.__lookupGetter__(c)):h.prototype[c]=f.prototype[c],f.prototype.__lookupSetter__(c)&&
h.prototype.__defineSetter__(c,f.prototype.__lookupSetter__(c)))}}h.hasOwnProperty("superclass")||Object.defineProperty(h,"superclass",{get:function(){return f},enumerable:!1})};n.HttpRequest=g.request=function(h,f,a,b,c){var d=!0;c&&void 0!==c.async&&(d=c.async);if(f){var e=null,e=[],k;for(k in f)e.push(k+"="+f[k]);e=e.join("&");h=h+"?"+e}var g=new XMLHttpRequest;g.open("GET",h,d);g.onload=function(c){this.getResponseHeader("Content-Type");200!=this.status?(v.trigger(g,"fail",this.status),b&&b(this.status)):
(v.trigger(g,"done",this.response),a&&a(this.response))};g.onerror=function(a){v.trigger(g,"fail",a)};if(c){for(k in c)g[k]=c[k];c.binary&&(g.responseType="arraybuffer")}g.send();return g};n.XMLHttpRequest&&(XMLHttpRequest.prototype.hasOwnProperty("done")||Object.defineProperty(XMLHttpRequest.prototype,"done",{enumerable:!1,value:function(h){v.bind(this,"done",function(f,a){h(a)});return this}}),XMLHttpRequest.prototype.hasOwnProperty("fail")||Object.defineProperty(XMLHttpRequest.prototype,"fail",
{enumerable:!1,value:function(h){v.bind(this,"fail",function(f,a){h(a)});return this}}));n.getFileExtension=function(h){var f=h.indexOf("?");-1!=f&&(h=h.substr(0,f));f=h.lastIndexOf(".");return-1==f?"":h.substr(f+1).toLowerCase()};n.loadFileAtlas=g.loadFileAtlas=function(h,f,a){var b=null;HttpRequest(h,null,function(a){a=g.processFileAtlas(a);f&&f(a);b&&b(a)},alert,a);return{done:function(a){b=a}}};n.processFileAtlas=g.processFileAtlas=function(h,f){for(var a=h.split("\n"),b={},c=[],d="",e=0,k=a.length;e<
k;e++){var g=f?a[e]:a[e].trim();g.length&&("\\"!=g[0]?c.push(g):(c.length&&(b[d]=c.join("\n")),c.length=0,d=g.substr(1)))}c.length&&(b[d]=c.join("\n"));return b};n.typedArrayToArray=function(h){var f=[];f.length=h.length;for(var a=0;a<h.length;a++)f[a]=h[a];return f};n.RGBToHex=function(h,f,a){h=Math.min(255,255*h)|0;f=Math.min(255,255*f)|0;a=Math.min(255,255*a)|0;return"#"+(16777216+(h<<16)+(f<<8)+a).toString(16).slice(1)};n.hexColorToRGBA=function(){function h(a,c,d){0>d&&(d+=1);1<d&&(d-=1);return d<
1/6?a+6*(c-a)*d:0.5>d?c:d<2/3?a+(c-a)*(2/3-d)*6:a}function f(a,c,d,e){e=e||vec3.create();if(0==c)d=c=a=d;else{var f=0.5>d?d*(1+c):d+c-d*c,g=2*d-f;d=h(g,f,a+1/3);c=h(g,f,a);a=h(g,f,a-1/3)}e[0]=d;e[1]=c;e[2]=a;return e}var a={white:[1,1,1],black:[0,0,0],gray:[0.501960813999176,0.501960813999176,0.501960813999176],red:[1,0,0],orange:[1,0.6470588445663452,0],pink:[1,0.7529411911964417,0.7960784435272217],green:[0,0.501960813999176,0],lime:[0,1,0],blue:[0,0,1],violet:[0.9333333373069763,0.5098039507865906,
0.9333333373069763],magenta:[1,0,1],cyan:[0,1,1],yellow:[1,1,0],brown:[0.6470588445663452,0.16470588743686676,0.16470588743686676],silver:[0.7529411911964417,0.7529411911964417,0.7529411911964417],gold:[1,0.843137264251709,0],transparent:[0,0,0,0]};return function(b,c,d){d=void 0===d?1:d;c=c||new Float32Array(4);c[3]=d;if("string"!=typeof b)return c;var e=a[b];if(void 0!==e)return c.set(e),c[3]=3==c.length?d:c[3]*d,c;e=b.indexOf("rgba(");if(-1!=e)return b=b.substr(5),b=b.split(","),c[0]=parseInt(b[0])/
255,c[1]=parseInt(b[1])/255,c[2]=parseInt(b[2])/255,c[3]=parseFloat(b[3])*d,c;e=b.indexOf("hsla(");if(-1!=e)return b=b.substr(5),b=b.split(","),f(parseInt(b[0])/360,parseInt(b[1])/100,parseInt(b[2])/100,c),c[3]=parseFloat(b[3])*d,c;c[3]=d;e=b.indexOf("rgb(");if(-1!=e)return b=b.substr(3),b=b.split(","),c[0]=parseInt(b[0])/255,c[1]=parseInt(b[1])/255,c[2]=parseInt(b[2])/255,c;e=b.indexOf("hsl(");if(-1!=e)return b=b.substr(5),b=b.split(","),f(parseInt(b[0])/360,parseInt(b[1])/100,parseInt(b[2])/100,
c),c;b=b.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(a,b,c,d){return b+b+c+c+d+d});d=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(b);if(!d)return c;c[0]=parseInt(d[1],16)/255;c[1]=parseInt(d[2],16)/255;c[2]=parseInt(d[3],16)/255;return c}}();var O=function(){function h(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}function f(a,b,c,d){var e=new Uint16Array(4),f=new Uint16Array(c*d),h=0,k=0,l=0,g=k=h=0,t=0,m=0,s=0,p=c/4;d/=4;for(var q=0;q<d;q++)for(var r=
0;r<p;r++)l=b+4*(q*p+r),e[0]=a[l],e[1]=a[l+1],h=e[0]&31,k=e[0]&2016,g=e[0]&63488,t=e[1]&31,m=e[1]&2016,s=e[1]&63488,e[2]=5*h+3*t>>3|5*k+3*m>>3&2016|5*g+3*s>>3&63488,e[3]=5*t+3*h>>3|5*m+3*k>>3&2016|5*s+3*g>>3&63488,h=a[l+2],k=4*q*c+4*r,f[k]=e[h&3],f[k+1]=e[h>>2&3],f[k+2]=e[h>>4&3],f[k+3]=e[h>>6&3],k+=c,f[k]=e[h>>8&3],f[k+1]=e[h>>10&3],f[k+2]=e[h>>12&3],f[k+3]=e[h>>14],h=a[l+3],k+=c,f[k]=e[h&3],f[k+1]=e[h>>2&3],f[k+2]=e[h>>4&3],f[k+3]=e[h>>6&3],k+=c,f[k]=e[h>>8&3],f[k+1]=e[h>>10&3],f[k+2]=e[h>>12&3],
f[k+3]=e[h>>14];return f}function a(a){for(var b=0,c=a.length,d=0;b<c;b+=4)d=a[b],a[b]=a[b+2],a[b+2]=d}function b(b,c,d,h){var L=new Int32Array(d,0,r),H,B,D,F,E,v,J,C,y;if(L[u]!=e)return console.error("Invalid magic number in DDS header"),0;if(!L[A]&l)return console.error("Unsupported format, must contain a FourCC code"),0;H=L[K];switch(H){case m:B=8;D=c?c.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case p:B=16;D=c?c.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case q:B=16;D=c?c.COMPRESSED_RGBA_S3TC_DXT5_EXT:
null;break;default:B=4,H=null,D=b.RGBA}J=1;L[s]&k&&!1!==h&&(J=Math.max(1,L[M]));F=L[x];E=L[z];v=L[w]+4;if(L[n+1]&g)for(y=0;6>y;++y)for(F=L[x],E=L[z],C=0;C<J;++C)H?(h=Math.max(4,F)/4*Math.max(4,E)/4*B,c=new Uint8Array(d,v,h),b.compressedTexImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+y,C,D,F,E,0,c)):(b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!1),h=F*E*B,c=new Uint8Array(d,v,h),a(c),b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+y,C,D,F,E,0,b.RGBA,b.UNSIGNED_BYTE,c)),v+=h,F*=0.5,E*=0.5;else if(c)for(b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,
!0),C=0;C<J;++C)H?(h=Math.max(4,F)/4*Math.max(4,E)/4*B,c=new Uint8Array(d,v,h),b.compressedTexImage2D(b.TEXTURE_2D,C,D,F,E,0,c)):(h=F*E*B,c=new Uint8Array(d,v,h),a(c),b.texImage2D(b.TEXTURE_2D,C,D,F,E,0,D,b.UNSIGNED_BYTE,c)),v+=h,F*=0.5,E*=0.5;else if(H==m)Math.max(4,F),Math.max(4,E),c=new Uint16Array(d),d=f(c,v/2,F,E),b.texImage2D(b.TEXTURE_2D,0,b.RGB,F,E,0,b.RGB,b.UNSIGNED_SHORT_5_6_5,d),h&&b.generateMipmap(b.TEXTURE_2D);else return console.error("No manual decoder for",String.fromCharCode(H&255,
H>>8&255,H>>16&255,H>>24&255),"and no native support"),0;return J}function c(b,c){var d=new Int32Array(b,0,r),h,v,H,B,D,F,E,y,J,C,G;if(d[u]!=e)return console.error("Invalid magic number in DDS header"),0;if(!d[A]&l)return console.error("Unsupported format, must contain a FourCC code"),0;h=d[K];switch(h){case m:v=8;H="COMPRESSED_RGB_S3TC_DXT1_EXT";break;case p:v=16;H="COMPRESSED_RGBA_S3TC_DXT3_EXT";break;case q:v=16;H="COMPRESSED_RGBA_S3TC_DXT5_EXT";break;default:v=4,H="RGBA"}J=1;d[s]&k&&!1!==loadMipmaps&&
(J=Math.max(1,d[M]));B=d[x];D=d[z];E=d[w]+4;var I=[];if(d[n+1]&g)for(G=0;6>G;++G)for(B=d[x],D=d[z],C=0;C<J;++C)h?(F=Math.max(4,B)/4*Math.max(4,D)/4*v,new Uint8Array(b,E,F),I.push({tex:"TEXTURE_CUBE_MAP",face:G,mipmap:C,internalFormat:H,width:B,height:D,offset:0,dataOffset:E,dataLength:F})):(F=B*D*v,y=new Uint8Array(b,E,F),a(y),I.push({tex:"TEXTURE_CUBE_MAP",face:G,mipmap:C,internalFormat:H,width:B,height:D,offset:0,type:"UNSIGNED_BYTE",dataOffset:E,dataLength:F})),E+=F,B*=0.5,D*=0.5;else if(c)if(h==
m)Math.max(4,B),Math.max(4,D),y=new Uint16Array(b),d=f(y,E/2,B,D),I.push({tex:"TEXTURE_2D",mipmap:0,internalFormat:"RGB",width:B,height:D,offset:0,format:"RGB",type:"UNSIGNED_SHORT_5_6_5",data:d});else return console.error("No manual decoder for",String.fromCharCode(h&255,h>>8&255,h>>16&255,h>>24&255),"and no native support"),0;else for(C=0;C<J;++C)F=Math.max(4,B)/4*Math.max(4,D)/4*v,new Uint8Array(b,E,F),I.push({tex:"TEXTURE_2D",mipmap:C,internalFormat:H,width:B,height:D,offset:0,type:"UNSIGNED_BYTE",
dataOffset:E,dataLength:F}),E+=F,B*=0.5,D*=0.5;return I}function d(a,c,d,e,f,h){var k=new XMLHttpRequest;k.open("GET",d,!0);k.responseType="arraybuffer";k.onload=function(){if(200==this.status){var d=new Int32Array(this.response,0,r),k=d[n+1]&g?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;a.bindTexture(k,e);var l=b(a,c,this.response,f);a.texParameteri(k,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(k,a.TEXTURE_MIN_FILTER,1<l?a.LINEAR_MIPMAP_LINEAR:a.LINEAR);a.bindTexture(k,null);e.texture_type=k;e.width=d[x];
e.height=d[z]}h&&h(e)};k.send(null);return e}var e=542327876,k=131072,g=512,l=4,m=h("DXT1"),p=h("DXT3"),q=h("DXT5"),r=31,u=0,w=1,s=2,z=3,x=4,M=7,A=20,K=21,n=27;return{dxtToRgb565:f,uploadDDSLevels:b,loadDDSTextureEx:d,loadDDSTexture:function(a,b,c,e){var f=a.createTexture();b=a.getExtension("WEBGL_compressed_texture_s3tc");d(a,b,c,f,!0,e);return f},loadDDSTextureFromMemoryEx:function(a,c,d,e,f){var h=new Int32Array(d,0,r),k=!!(h[n+1]&g),l=k?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;a.bindTexture(l,e.handler);
c=b(a,c,d,f);a.texParameteri(l,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(l,a.TEXTURE_MIN_FILTER,1<c?a.LINEAR_MIPMAP_LINEAR:a.LINEAR);k&&(a.texParameteri(l,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(l,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE));a.bindTexture(l,null);e.handler&&(e.texture_type=l,e.width=h[x],e.height=h[z]);return e},getDDSTextureFromMemoryEx:function(a){var b=new Int32Array(a,0,r),d=b[n+1]&g?"TEXTURE_CUBE_MAP":"TEXTURE_2D",e=c(a);return{type:d,buffers:e,data:a,width:b[x],height:b[z]}}}}();
"undefined"!=typeof n&&(n.DDS=O);if("undefined"==typeof glMatrix)throw"You must include glMatrix on your project";Math.clamp=function(h,f,a){return f>h?f:a<h?a:h};vec3.ZERO=vec3.fromValues(0,0,0);vec3.FRONT=vec3.fromValues(0,0,-1);vec3.UP=vec3.fromValues(0,1,0);vec3.RIGHT=vec3.fromValues(1,0,0);vec2.rotate=function(h,f,a){var b=f[0];f=f[1];var c=Math.cos(a);a=Math.sin(a);h[0]=b*c-f*a;h[1]=b*a+f*c;return h};vec3.zero=function(h){h[0]=h[1]=0;return h};vec2.perpdot=function(h,f){return h[1]*f[0]+-h[0]*
f[1]};vec2.computeSignedAngle=function(h,f){return Math.atan2(vec2.perpdot(h,f),vec2.dot(h,f))};vec2.random=function(h,f){f=f||1;h[0]=Math.random()*f;h[1]=Math.random()*f;return h};vec3.zero=function(h){h[0]=h[1]=h[2]=0;return h};vec3.minValue=function(h){return h[0]<h[1]&&h[0]<h[2]?h[0]:h[1]<h[2]?h[1]:h[2]};vec3.maxValue=function(h){return h[0]>h[1]&&h[0]>h[2]?h[0]:h[1]>h[2]?h[1]:h[2]};vec3.minValue=function(h){return h[0]<h[1]&&h[0]<h[2]?h[0]:h[1]<h[2]?h[1]:h[2]};vec3.addValue=function(h,f,a){h[0]=
f[0]+a;h[1]=f[1]+a;h[2]=f[2]+a};vec3.subValue=function(h,f,a){h[0]=f[0]-a;h[1]=f[1]-a;h[2]=f[2]-a};vec3.toArray=function(h){return[h[0],h[1],h[2]]};vec3.rotateX=function(h,f,a){var b=f[1],c=f[2],d=Math.cos(a);a=Math.sin(a);h[0]=f[0];h[1]=b*d-c*a;h[2]=b*a+c*d;return h};vec3.rotateY=function(h,f,a){var b=f[0],c=f[2],d=Math.cos(a);a=Math.sin(a);h[0]=b*d-c*a;h[1]=f[1];h[2]=b*a+c*d;return h};vec3.rotateZ=function(h,f,a){var b=f[0],c=f[1],d=Math.cos(a);a=Math.sin(a);h[0]=b*d-c*a;h[1]=b*a+c*d;h[2]=f[2];
return h};vec3.angle=function(h,f){return Math.acos(vec3.dot(h,f))};vec3.random=function(h,f){f=f||1;h[0]=Math.random()*f;h[1]=Math.random()*f;h[2]=Math.random()*f;return h};vec3.polarToCartesian=function(h,f){var a=f[0],b=f[1],c=f[2];h[0]=a*Math.cos(b)*Math.sin(c);h[1]=a*Math.sin(b);h[2]=a*Math.cos(b)*Math.cos(c);return h};vec3.reflect=function(h,f,a){var b=f[0],c=f[1],d=f[2];vec3.scale(h,a,-2*vec3.dot(f,a));h[0]+=b;h[1]+=c;h[2]+=d;return h};vec4.random=function(h,f){f=f||1;h[0]=Math.random()*f;
h[1]=Math.random()*f;h[2]=Math.random()*f;h[3]=Math.random()*f;return h};vec4.toArray=function(h){return[h[0],h[1],h[2],h[3]]};mat3.IDENTITY=mat3.create();mat4.IDENTITY=mat4.create();mat4.toArray=function(h){return[h[0],h[1],h[2],h[3],h[4],h[5],h[6],h[7],h[8],h[9],h[10],h[11],h[12],h[13],h[14],h[15]]};mat4.setUpAndOrthonormalize=function(h,f,a){f!=h&&mat4.copy(h,f);f=h.subarray(0,3);vec3.normalize(h.subarray(4,7),a);h=h.subarray(8,11);vec3.cross(f,a,h);vec3.normalize(f,f);vec3.cross(h,f,a);vec3.normalize(h,
h)};mat4.multiplyVec3=function(h,f,a){var b=a[0],c=a[1];a=a[2];h[0]=f[0]*b+f[4]*c+f[8]*a+f[12];h[1]=f[1]*b+f[5]*c+f[9]*a+f[13];h[2]=f[2]*b+f[6]*c+f[10]*a+f[14];return h};mat4.projectVec3=function(h,f,a){var b=a[0],c=a[1];a=a[2];var d=f[1]*b+f[5]*c+f[9]*a+f[13],e=f[2]*b+f[6]*c+f[10]*a+f[14],k=f[3]*b+f[7]*c+f[11]*a+f[15];h[0]=((f[0]*b+f[4]*c+f[8]*a+f[12])/k+1)/2;h[1]=(d/k+1)/2;h[2]=(e/k+1)/2;return h};vec3.project=function(h,f,a,b){b=b||gl.viewport_data;var c=f[0],d=f[1];f=f[2];var e=a[3]*c+a[7]*d+
a[11]*f+a[15],k=1-((a[1]*c+a[5]*d+a[9]*f+a[13])/e+1)/2;h[0]=((a[0]*c+a[4]*d+a[8]*f+a[12])/e+1)/2*b[2]+b[0];h[1]=k*b[3]+b[1];h[2]=e;return h};var Q=mat4.create(),y=vec4.create();vec3.unproject=function(h,f,a,b){y[0]=2*(f[0]-b[0])/b[2]-1;y[1]=2*(f[1]-b[1])/b[3]-1;y[2]=2*f[2]-1;y[3]=1;if(!mat4.invert(Q,a))return null;vec4.transformMat4(y,y,Q);if(0===y[3])return null;h[0]=y[0]/y[3];h[1]=y[1]/y[3];h[2]=y[2]/y[3];return h};mat4.rotateVec3=function(h,f,a){var b=a[0],c=a[1];a=a[2];h[0]=f[0]*b+f[4]*c+f[8]*
a;h[1]=f[1]*b+f[5]*c+f[9]*a;h[2]=f[2]*b+f[6]*c+f[10]*a;return h};mat4.fromTranslationFrontTop=function(h,f,a,b){vec3.cross(h.subarray(0,3),a,b);h.set(b,4);h.set(a,8);h.set(f,12);return h};mat4.translationMatrix=function(h){var f=mat4.create();f[12]=h[0];f[13]=h[1];f[14]=h[2];return f};mat4.setTranslation=function(h,f){h[12]=f[0];h[13]=f[1];h[14]=f[2];return h};mat4.getTranslation=function(h,f){h[0]=f[12];h[1]=f[13];h[2]=f[14];return h};mat4.toRotationMat4=function(h,f){mat4.copy(h,f);h[12]=h[13]=
h[14]=0;return h};mat4.swapRows=function(h,f,a,b){if(h!=f)return mat4.copy(h,f),h[4*a]=f[4*b],h[4*a+1]=f[4*b+1],h[4*a+2]=f[4*b+2],h[4*a+3]=f[4*b+3],h[4*b]=f[4*a],h[4*b+1]=f[4*a+1],h[4*b+2]=f[4*a+2],h[4*b+3]=f[4*a+3],h;f=new Float32Array(matrix.subarray(4*a,5*a));matrix.set(matrix.subarray(4*b,5*b),4*a);matrix.set(f,4*b);return h};mat4.scaleAndAdd=function(h,f,a,b){h[0]=f[0]+a[0]*b;h[1]=f[1]+a[1]*b;h[2]=f[2]+a[2]*b;h[3]=f[3]+a[3]*b;h[4]=f[4]+a[4]*b;h[5]=f[5]+a[5]*b;h[6]=f[6]+a[6]*b;h[7]=f[7]+a[7]*
b;h[8]=f[8]+a[8]*b;h[9]=f[9]+a[9]*b;h[10]=f[10]+a[10]*b;h[11]=f[11]+a[11]*b;h[12]=f[12]+a[12]*b;h[13]=f[13]+a[13]*b;h[14]=f[14]+a[14]*b;h[15]=f[15]+a[15]*b;return h};quat.fromAxisAngle=function(h,f){var a=quat.create();f*=0.5;var b=Math.sin(f);a[0]=b*h[0];a[1]=b*h[1];a[2]=b*h[2];a[3]=Math.cos(f);return a};quat.toEuler=function(h,f){var a=Math.atan2(2*f[1]*f[3]-2*f[0]*f[2],1-2*f[1]*f[1]-2*f[2]*f[2]),b=Math.asin(2*f[0]*f[1]+2*f[2]*f[3]),c=Math.atan2(2*f[0]*f[3]-2*f[1]*f[2],1-2*f[0]*f[0]-2*f[2]*f[2]);
h||(h=vec3.create());vec3.set(h,a,b,c);return h};quat.fromEuler=function(h,f){var a=f[0],b=f[1],c=f[2],d=Math.cos(a),e=Math.cos(b),k=Math.cos(c),a=Math.sin(a),b=Math.sin(b),c=Math.sin(c),g=0.5*Math.sqrt(1+d*e+d*k-a*b*c+e*k);0==g&&(g=1E-6);quat.set(h,(e*c+d*c+a*b*k)/(4*g),(a*e+a*k+d*b*c)/(4*g),(-a*c+d*b*k+b)/(4*g),g);quat.normalize(h,h);return h};quat.fromMat4=function(h,f){var a=f[0]+f[5]+f[10];if(0<a){var b=Math.sqrt(a+1);h[3]=0.5*b;b=0.5/b;h[0]=(f[9]-f[6])*b;h[1]=(f[2]-f[8])*b;h[2]=(f[4]-f[1])*
b}else{a=0;f[5]>f[0]&&(a=1);f[10]>f[4*a+a]&&(a=2);var c=(a+1)%3,d=(c+1)%3,b=Math.sqrt(f[4*a+a]-f[4*c+c]-f[4*d+d]+1);h[a]=0.5*b;b=0.5/b;h[3]=(f[4*d+c]-f[4*c+d])*b;h[c]=(f[4*c+a]+f[4*a+c])*b;h[d]=(f[4*d+a]+f[4*a+d])*b}quat.normalize(h,h)};quat.fromMat4.lookAt=function(){var h=vec3.create();return function(f,a,b){b=vec3.dot(vec3.FRONT,a);if(1E-6>Math.abs(b- -1))return f.set(vec3.UP),f[3]=Math.PI,f;if(1E-6>Math.abs(b-1))return quat.identity(f);b=Math.acos(b);vec3.cross(h,vec3.FRONT,a);vec3.normalize(h,
h);quat.setAxisAngle(f,h,b);return f}}();g.Indexer=function(){this.unique=[];this.indices=[];this.map={}};g.Indexer.prototype={add:function(h){var f=JSON.stringify(h);f in this.map||(this.map[f]=this.unique.length,this.unique.push(h));return this.map[f]}};g.Buffer=function(h,f,a,b,c){g.debug&&console.log("GL.Buffer created");null!==c&&(c=c||n.gl);this.gl=c;this.buffer=null;this.target=h;this.attribute=null;this.data=f;this.spacing=a||3;this.data&&this.gl&&this.upload(b)};g.Buffer.prototype.forEach=
function(h){for(var f=this.data,a=0,b=this.spacing,c=f.length;a<c;a+=b)h(f.subarray(a,a+b),a);return this};g.Buffer.prototype.applyTransform=function(h){for(var f=this.data,a=0,b=this.spacing,c=f.length;a<c;a+=b){var d=f.subarray(a,a+b);vec3.transformMat4(d,d,h)}return this};g.Buffer.prototype.upload=function(h){var f=this.spacing||3,a=this.gl;if(a){if(!this.data)throw"No data supplied";var b=this.data;if(!b.buffer)throw"Buffers must be typed arrays";if(this.buffer=this.buffer||a.createBuffer()){this.buffer.length=
b.length;this.buffer.spacing=f;switch(b.constructor){case Int8Array:this.buffer.gl_type=a.BYTE;break;case Uint8ClampedArray:case Uint8Array:this.buffer.gl_type=a.UNSIGNED_BYTE;break;case Int16Array:this.buffer.gl_type=a.SHORT;break;case Uint16Array:this.buffer.gl_type=a.UNSIGNED_SHORT;break;case Int32Array:this.buffer.gl_type=a.INT;break;case Uint32Array:this.buffer.gl_type=a.UNSIGNED_INT;break;case Float32Array:this.buffer.gl_type=a.FLOAT;break;default:throw"unsupported buffer type";}a.bindBuffer(this.target,
this.buffer);a.bufferData(this.target,b,h||this.stream_type||a.STATIC_DRAW)}}};g.Buffer.prototype.compile=g.Buffer.prototype.upload;g.Buffer.prototype.setData=function(h,f){if(!h.buffer)throw"Data must be typed array";f=f||0;if(this.data){if(this.data.length<h.length)throw"buffer is not big enough, you cannot set data to a smaller buffer";if(this.data!=h)if(this.data.length==h.length)this.data.set(h),this.upload();else{var a=new Uint8Array(h.buffer,h.buffer.byteOffset,h.buffer.byteLength);(new Uint8Array(this.data.buffer)).set(a,
f);this.uploadRange(f,a.length)}}else this.data=h,this.upload()};g.Buffer.prototype.uploadRange=function(h,f){if(!this.data)throw"No data stored in this buffer";if(!this.data.buffer)throw"Buffers must be typed arrays";var a=new Uint8Array(this.data.buffer,h,f),b=this.gl;b.bindBuffer(this.target,this.buffer);b.bufferSubData(this.target,h,a)};g.Buffer.prototype.clone=function(h){var f=new g.Buffer;if(h)for(var a in this)f[a]=this[a];else this.target&&(f.target=this.target),this.gl&&(f.gl=this.gl),this.spacing&&
(f.spacing=this.spacing),this.data&&(f.data=new n[this.data.constructor](this.data),f.upload());return f};g.Buffer.prototype.toJSON=function(){return this.data?{data_type:getClassName(this.data),data:this.data.toJSON(),target:this.target,attribute:this.attribute,spacing:this.spacing}:(console.error("cannot serialize a mesh without data"),null)};g.Buffer.prototype.fromJSON=function(h){this.data=new (n[h.data_type]||Float32Array)(h.data);this.target=h.target;this.spacing=h.spacing||3;this.attribute=
h.attribute;this.upload(g.STATIC_DRAW)};g.Buffer.prototype.delete=function(){this.gl.deleteBuffer(this.buffer);this.buffer=null};n.Mesh=g.Mesh=function(h,f,a,b){g.debug&&console.log("GL.Mesh created");null!==b&&(this.gl=b=b||n.gl);this._context_id=b.context_id;this.vertexBuffers={};this.indexBuffers={};this.info={groups:[]};this._bounding=BBox.create();(h||f)&&this.addBuffers(h,f,a?a.stream_type:null);if(a)for(var c in a)this[c]=a[c]};Mesh.common_buffers={vertices:{spacing:3,attribute:"a_vertex"},
vertices2D:{spacing:2,attribute:"a_vertex2D"},normals:{spacing:3,attribute:"a_normal"},coords:{spacing:2,attribute:"a_coord"},coords1:{spacing:2,attribute:"a_coord1"},coords2:{spacing:2,attribute:"a_coord2"},colors:{spacing:4,attribute:"a_color"},tangents:{spacing:3,attribute:"a_tangent"},bone_indices:{spacing:4,attribute:"a_bone_indices",type:Uint8Array},weights:{spacing:4,attribute:"a_weights"},extra:{spacing:1,attribute:"a_extra"},extra2:{spacing:2,attribute:"a_extra2"},extra3:{spacing:3,attribute:"a_extra3"},
extra4:{spacing:4,attribute:"a_extra4"}};Mesh.default_datatype=Float32Array;Object.defineProperty(Mesh.prototype,"bounding",{set:function(h){if(h){if(13>h.length)throw"Bounding must use the BBox bounding format of 13 floats: center, halfsize, min, max, radius";this._bounding.set(h)}},get:function(){return this._bounding}});Mesh.prototype.addBuffer=function(h,f){f.target==gl.ARRAY_BUFFER?this.vertexBuffers[h]=f:this.indexBuffers[h]=f;f.attribute||(f.attribute=g.Mesh.common_buffers[h].attribute)};Mesh.prototype.addBuffers=
function(h,f,a){var b=0;this.vertexBuffers.vertices&&(b=this.vertexBuffers.vertices.data.length/3);for(var c in h){var d=h[c];if(d){if(d.constructor==g.Buffer)d=d.data;else if("number"!=typeof d[0]){for(var e=[],k=0,t=1E4;k<d.length;k+=t)e=Array.prototype.concat.apply(e,d.slice(k,k+t));d=e}e=g.Mesh.common_buffers[c];d.constructor===Array&&(k=g.Mesh.default_datatype,e&&e.type&&(k=e.type),d=new k(d));"vertices"==c&&(b=d.length/3);k=d.length/b;e&&e.spacing&&(k=e.spacing);t="a_"+c;e&&e.attribute&&(t=
e.attribute);this.vertexBuffers[c]?this.updateVertexBuffer(c,t,k,d,a):this.createVertexBuffer(c,t,k,d,a)}}if(f)for(c in f)if(d=f[c]){d.constructor==g.Buffer&&(d=d.data);if("number"!=typeof d[0]){e=[];c=0;for(t=1E4;c<d.length;c+=t)e=Array.prototype.concat.apply(e,d.slice(c,c+t));d=e}d.constructor===Array&&(k=Uint16Array,65536<b&&(k=Uint32Array),d=new k(d));this.createIndexBuffer(c,d)}};Mesh.prototype.createVertexBuffer=function(h,f,a,b,c){var d=g.Mesh.common_buffers[h];!f&&d&&(f=d.attribute);if(!f)throw"Buffer added to mesh without attribute name";
!a&&d&&(a=d&&d.spacing?d.spacing:3);if(!b){b=this.getNumVertices();if(!b)throw"Cannot create an empty buffer in a mesh without vertices (vertices are needed to know the size)";b=new g.Mesh.default_datatype(b*a)}if(!b.buffer)throw"Buffer data MUST be typed array";a=this.vertexBuffers[h]=new g.Buffer(gl.ARRAY_BUFFER,b,a,c,this.gl);a.name=h;a.attribute=f;return a};Mesh.prototype.updateVertexBuffer=function(h,f,a,b,c){var d=this.vertexBuffers[h];d?b.length&&(d.attribute=f,d.spacing=a,d.data=b,d.upload(c)):
console.log("buffer not found: ",h)};Mesh.prototype.removeVertexBuffer=function(h,f){var a=this.vertexBuffers[h];a&&(f&&a.delete(),delete this.vertexBuffers[h])};Mesh.prototype.getVertexBuffer=function(h){return this.vertexBuffers[h]};Mesh.prototype.createIndexBuffer=function(h,f,a){if(f.constructor===Array){var b=Uint16Array,c=this.vertexBuffers.vertices;c&&(65536<c.data.length/3&&(b=Uint32Array),f=new b(f))}return this.indexBuffers[h]=new g.Buffer(gl.ELEMENT_ARRAY_BUFFER,f,0,a,this.gl)};Mesh.prototype.getBuffer=
function(h){return this.vertexBuffers[h]};Mesh.prototype.getIndexBuffer=function(h){return this.indexBuffers[h]};Mesh.prototype.removeIndexBuffer=function(h,f){var a=this.indexBuffers[h];a&&(f&&a.delete(),delete this.indexBuffers[h])};Mesh.prototype.upload=function(h){for(var f in this.vertexBuffers){var a=this.vertexBuffers[f];a.upload(h)}for(var b in this.indexBuffers)a=this.indexBuffers[b],a.upload()};Mesh.prototype.compile=Mesh.prototype.upload;Mesh.prototype.deleteBuffers=function(){for(var h in this.vertexBuffers){var f=
this.vertexBuffers[h];f.delete()}this.vertexBuffers={};for(h in this.indexBuffers)f=this.indexBuffers[h],f.delete();this.indexBuffers={}};Mesh.prototype.delete=Mesh.prototype.deleteBuffers;Mesh.prototype.bindBuffers=function(h){for(var f in this.vertexBuffers){var a=this.vertexBuffers[f],b=h.attributes[a.attribute||f];null!=b&&a.buffer&&(gl.bindBuffer(gl.ARRAY_BUFFER,a.buffer),gl.enableVertexAttribArray(b),gl.vertexAttribPointer(b,a.buffer.spacing,a.buffer.gl_type,!1,0,0))}};Mesh.prototype.unbindBuffers=
function(h){for(var f in this.vertexBuffers){var a=this.vertexBuffers[f],b=a.attribute||f;null!=h.attributes[b]&&a.buffer&&gl.disableVertexAttribArray(h.attributes[b])}};Mesh.prototype.clone=function(h){h=h||n.gl;var f={},a={},b;for(b in this.vertexBuffers){var c=this.vertexBuffers[b];f[b]=new c.data.constructor(c.data)}for(b in this.indexBuffers)c=this.indexBuffers[b],a[b]=new c.data.constructor(c.data);return new g.Mesh(f,a,void 0,h)};Mesh.prototype.cloneShared=function(h){h=h||n.gl;return new g.Mesh(this.vertexBuffers,
this.indexBuffers,void 0,h)};Mesh.prototype.toObject=function(){var h={},f={},a;for(a in this.vertexBuffers){var b=this.vertexBuffers[a];h[a]={spacing:b.spacing,data:new b.data.constructor(b.data)}}for(a in this.indexBuffers)b=this.indexBuffers[a],f[a]={data:new b.data.constructor(b.data)};return{vertexBuffers:h,indexBuffers:f,info:this.info?cloneObject(this.info):null,bounding:this._bounding.toJSON()}};Mesh.prototype.toJSON=function(){var h={vertexBuffers:{},indexBuffers:{},info:this.info?cloneObject(this.info):
null,bounding:this._bounding.toJSON()},f;for(f in this.vertexBuffers)h.vertexBuffers[f]=this.vertexBuffers[f].toJSON();for(f in this.indexBuffers)h.indexBuffers[f]=this.indexBuffers[f].toJSON();return h};Mesh.prototype.fromJSON=function(h){this.vertexBuffers={};this.indexBuffers={};for(var f in h.vertexBuffers)if(h.vertexBuffers[f]){var a=new g.Buffer;a.fromJSON(h.vertexBuffers[f]);!a.attribute&&g.Mesh.common_buffers[f]&&(a.attribute=g.Mesh.common_buffers[f].attribute);this.vertexBuffers[f]=a}for(f in h.indexBuffers)h.indexBuffers[f]&&
(a=new g.Buffer,a.fromJSON(h.indexBuffers[f]),this.indexBuffers[f]=a);h.info&&(this.info=cloneObject(h.info));h.bounding&&(this.bounding=h.bounding)};Mesh.prototype.generateMetadata=function(){var h={},f=this.vertexBuffers.vertices.data,a=this.indexBuffers.triangles.data;h.vertices=f.length/3;h.faces=a?a.length/3:f.length/9;h.indexed=!!this.metadata.faces;this.metadata=h};Mesh.prototype.computeWireframe=function(){var h=this.indexBuffers.triangles,f=this.vertexBuffers.vertices.data.length/3;if(h){for(var a=
h.data,b=new g.Indexer,h=0;h<a.length;h+=3)for(var c=a.subarray(h,h+3),d=0;d<c.length;d++){var e=c[d],k=c[(d+1)%c.length];b.add([Math.min(e,k),Math.max(e,k)])}a=b.unique;b=65536<f?new Uint32Array(2*a.length):new Uint16Array(2*a.length);h=0;for(f=a.length;h<f;++h)b.set(a[h],2*h)}else for(h=f/3,b=65536<f?new Uint32Array(6*h):new Uint16Array(6*h),h=0;h<f;h+=3)b[2*h]=h,b[2*h+1]=h+1,b[2*h+2]=h+1,b[2*h+3]=h+2,b[2*h+4]=h+2,b[2*h+5]=h;this.createIndexBuffer("wireframe",b);return this};Mesh.prototype.flipNormals=
function(h){var f=this.vertexBuffers.normals;if(f){for(var a=f.data,b=a.length,c=0;c<b;++c)a[c]*=-1;f.upload(h);this.indexBuffers.triangles||this.computeIndices();f=this.indexBuffers.triangles;a=f.data;b=a.length;for(c=0;c<b;c+=3){var d=a[c];a[c]=a[c+1];a[c+1]=d}f.upload(h)}};Mesh.prototype.computeIndices=function(){var h=[],f=[],a=[],b=[],c=this.vertexBuffers.normals,d=this.vertexBuffers.coords,e=this.vertexBuffers.vertices.data,k=null;c&&(k=c.data);c=null;d&&(c=d.data);for(var d={},t=e.length/3,
l=0;l<t;++l){var m=e.subarray(3*l,3*(l+1)),p=1E3*m[0]|0,q=0,r=d[p];if(r)for(var u=r.length;q<u;q++)if(0.01>vec3.sqrDist(m,h[r[q]])){b.push(q);break}r&&q!=u||(h.push(m),d[p]?d[p].push(q):d[p]=[q],k&&f.push(k.subarray(3*l,3*(l+1))),c&&a.push(c.subarray(2*l,2*(l+1))),b.push(q))}this.vertexBuffers={};this.createVertexBuffer("vertices",g.Mesh.common_buffers.vertices.attribute,3,P(h));k&&this.createVertexBuffer("normals",g.Mesh.common_buffers.normals.attribute,3,P(f));c&&this.createVertexBuffer("coords",
g.Mesh.common_buffers.coords.attribute,2,P(a));this.createIndexBuffer("triangles",b)};Mesh.prototype.explodeIndices=function(h){h=h||"triangles";var f=this.getIndexBuffer(h);if(f){var f=f.data,a=new Float32Array(3*f.length),b=null,c=null,d=this.vertexBuffers.vertices.data,e=this.vertexBuffers.normals,k=null;e&&(k=e.data,b=new Float32Array(3*f.length));var t=this.vertexBuffers.coords,e=null;t&&(e=t.data,c=new Float32Array(2*f.length));for(var t=0,l=f.length;t<l;++t){var m=f[t];a.set(d.subarray(3*m,
3*m+3),3*t);k&&b.set(k.subarray(3*m,3*m+3),3*t);e&&c.set(e.subarray(2*m,2*m+2),2*t)}this.vertexBuffers={};this.createVertexBuffer("vertices",g.Mesh.common_buffers.vertices.attribute,3,a);b&&this.createVertexBuffer("normals",g.Mesh.common_buffers.normals.attribute,3,b);c&&this.createVertexBuffer("coords",g.Mesh.common_buffers.coords.attribute,2,c);delete this.indexBuffers[h]}};Mesh.prototype.computeNormals=function(h){if(!this.vertexBuffers.vertices)return console.error("Cannot compute normals of a mesh without vertices");
var f=this.vertexBuffers.vertices.data,a=new Float32Array(f.length),b=null;this.indexBuffers.triangles&&(b=this.indexBuffers.triangles.data);for(var c=g.temp_vec3,d=g.temp2_vec3,e,k,t,l,m,p,q=b?b.length:f.length,r=0;r<q;r+=3)b?(e=b[r],k=b[r+1],t=b[r+2],l=f.subarray(3*e,3*e+3),m=f.subarray(3*k,3*k+3),p=f.subarray(3*t,3*t+3),e=a.subarray(3*e,3*e+3),k=a.subarray(3*k,3*k+3),t=a.subarray(3*t,3*t+3)):(l=f.subarray(3*r,3*r+3),m=f.subarray(3*r+3,3*r+6),p=f.subarray(3*r+6,3*r+9),e=a.subarray(3*r,3*r+3),k=
a.subarray(3*r+3,3*r+6),t=a.subarray(3*r+6,3*r+9)),vec3.sub(c,m,l),vec3.sub(d,p,l),vec3.cross(c,c,d),vec3.normalize(c,c),vec3.add(e,e,c),vec3.add(k,k,c),vec3.add(t,t,c);if(b)for(r=0,q=a.length;r<q;r+=3)f=a.subarray(r,r+3),vec3.normalize(f,f);if(q=this.vertexBuffers.normals)q.data=a,q.upload(h);else return this.createVertexBuffer("normals",g.Mesh.common_buffers.normals.attribute,3,a);return q};Mesh.prototype.computeTangents=function(){var h=this.vertexBuffers.vertices;if(!h)return console.error("Cannot compute tangents of a mesh without vertices");
var f=this.vertexBuffers.normals;if(!f)return console.error("Cannot compute tangents of a mesh without normals");var a=this.vertexBuffers.coords;if(!a)return console.error("Cannot compute tangents of a mesh without uvs");var b=this.indexBuffers.triangles;if(!b)return console.error("Cannot compute tangents of a mesh without indices");var h=h.data,f=f.data,c=a.data,d=b.data;if(h&&f&&c){var e=h.length/3,b=new Float32Array(4*e),a=new Float32Array(6*e),e=a.subarray(3*e),k,g,l=vec3.create(),m=vec3.create(),
p=vec3.create(),q=vec3.create();k=0;for(g=d.length;k<g;k+=3){var r=d[k],u=d[k+1],n=d[k+2],s=h.subarray(3*r,3*r+3),z=h.subarray(3*u,3*u+3),x=h.subarray(3*n,3*n+3),M=c.subarray(2*r,2*r+2),A=c.subarray(2*u,2*u+2),K=c.subarray(2*n,2*n+2),S=z[0]-s[0],v=x[0]-s[0],y=z[1]-s[1],G=x[1]-s[1],z=z[2]-s[2],s=x[2]-s[2],x=A[0]-M[0],N=K[0]-M[0],A=A[1]-M[1],M=K[1]-M[1],K=x*M-N*A,K=1E-9>Math.abs(K)?0:1/K;vec3.copy(l,[(M*S-A*v)*K,(M*y-A*G)*K,(M*z-A*s)*K]);vec3.copy(m,[(x*v-N*S)*K,(x*G-N*y)*K,(x*s-N*z)*K]);vec3.add(a.subarray(3*
r,3*r+3),a.subarray(3*r,3*r+3),l);vec3.add(a.subarray(3*u,3*u+3),a.subarray(3*u,3*u+3),l);vec3.add(a.subarray(3*n,3*n+3),a.subarray(3*n,3*n+3),l);vec3.add(e.subarray(3*r,3*r+3),e.subarray(3*r,3*r+3),m);vec3.add(e.subarray(3*u,3*u+3),e.subarray(3*u,3*u+3),m);vec3.add(e.subarray(3*n,3*n+3),e.subarray(3*n,3*n+3),m)}k=0;for(g=h.length;k<g;k+=3)h=f.subarray(k,k+3),c=a.subarray(k,k+3),vec3.subtract(p,c,vec3.scale(p,h,vec3.dot(h,c))),vec3.normalize(p,p),h=0>vec3.dot(vec3.cross(q,h,c),e.subarray(k,k+3))?
-1:1,b.set([p[0],p[1],p[2],h],k/3*4);this.createVertexBuffer("tangents",Mesh.common_buffers.tangents.attribute,4,b)}};Mesh.prototype.computeTextureCoordinates=function(h){var f=this.vertexBuffers.vertices;if(!f)return console.error("Cannot compute uvs of a mesh without vertices");this.explodeIndices("triangles");var f=f.data,a=this.vertexBuffers.coords,b=new Float32Array(f.length/3*2),c=this.indexBuffers.triangles,d=null;c&&(d=c.data);var c=vec3.create(),e=vec3.create(),k=vec3.create(),g=this.getBoundingBox(),
l=BBox.getCenter(g),m=vec3.create();m.set(BBox.getHalfsize(g));vec3.scale(m,m,2);for(var g=d?d.length:f.length/3,p=0;p<g;p+=3){if(d)var q=d[p],r=d[p+1],u=d[p+2],n=f.subarray(3*q,3*q+3),s=f.subarray(3*r,3*r+3),z=f.subarray(3*u,3*u+3),q=b.subarray(2*q,2*q+2),r=b.subarray(2*r,2*r+2),u=b.subarray(2*u,2*u+2);else n=f.subarray(3*p,3*p+3),s=f.subarray(3*(p+1),3*(p+1)+3),z=f.subarray(3*(p+2),3*(p+2)+3),q=b.subarray(2*p,2*p+2),r=b.subarray(2*(p+1),2*(p+1)+2),u=b.subarray(2*(p+2),2*(p+2)+2);vec3.sub(e,n,s);
vec3.sub(k,n,z);vec3.cross(c,e,k);c[0]=Math.abs(c[0]);c[1]=Math.abs(c[1]);c[2]=Math.abs(c[2]);c[0]>c[1]&&c[0]>c[2]?(q[0]=(n[2]-l[2])/m[2],q[1]=(n[1]-l[1])/m[1],r[0]=(s[2]-l[2])/m[2],r[1]=(s[1]-l[1])/m[1],u[0]=(z[2]-l[2])/m[2],u[1]=(z[1]-l[1])/m[1]):c[1]>c[2]?(q[0]=(n[0]-l[0])/m[0],q[1]=(n[2]-l[2])/m[2],r[0]=(s[0]-l[0])/m[0],r[1]=(s[2]-l[2])/m[2],u[0]=(z[0]-l[0])/m[0],u[1]=(z[2]-l[2])/m[2]):(q[0]=(n[0]-l[0])/m[0],q[1]=(n[1]-l[1])/m[1],r[0]=(s[0]-l[0])/m[0],r[1]=(s[1]-l[1])/m[1],u[0]=(z[0]-l[0])/m[0],
u[1]=(z[1]-l[1])/m[1])}a?(a.data=b,a.upload(h)):this.createVertexBuffer("coords",Mesh.common_buffers.coords.attribute,2,b)};Mesh.prototype.getNumVertices=function(){var h=this.vertexBuffers.vertices;return h?h.data.length/h.spacing:0};Mesh.computeBoundingBox=function(h,f,a){if(h){var b=0;if(a){for(var c=0;c<a.length;++c)if(a[c]){b=c;break}if(b==a.length){console.warn("mask contains only zeros, no vertices marked");return}}for(var d=vec3.clone(h.subarray(3*b,3*b+3)),e=vec3.clone(h.subarray(3*b,3*b+
3)),c=3*b;c<h.length;c+=3)if(!a||a[c/3])b=h.subarray(c,c+3),vec3.min(d,b,d),vec3.max(e,b,e);if(isNaN(d[0])||isNaN(d[1])||isNaN(d[2])||isNaN(e[0])||isNaN(e[1])||isNaN(e[2]))d[0]=d[1]=d[2]=0,e[0]=e[1]=e[2]=0,console.warn("Warning: GL.Mesh has NaN values in vertices");h=vec3.add(vec3.create(),d,e);vec3.scale(h,h,0.5);e=vec3.subtract(vec3.create(),e,h);return BBox.setCenterHalfsize(f||BBox.create(),h,e)}};Mesh.prototype.getBoundingBox=function(){if(this._bounding)return this._bounding;this.updateBoundingBox();
return this._bounding};Mesh.prototype.updateBoundingBox=function(){var h=this.vertexBuffers.vertices;h&&(g.Mesh.computeBoundingBox(h.data,this._bounding),this.info&&this.info.groups&&this.info.groups.length&&this.computeGroupsBoundingBoxes())};Mesh.prototype.computeGroupsBoundingBoxes=function(){var h=null,f=this.getIndexBuffer("triangles");f&&(h=f.data);f=this.getVertexBuffer("vertices");if(!f)return!1;f=f.data;if(!f.length)return!1;for(var a=this.info.groups,b=0;b<a.length;++b){var c=a[b];c.bounding=
c.bounding||BBox.create();var d=null;if(h){for(var d=new Uint8Array(f.length/3),e=c.start,k=0,t=c.length;k<t;k+=3)d[h[e+k]]=1,d[h[e+k+1]]=1,d[h[e+k+2]]=1;g.Mesh.computeBoundingBox(f,c.bounding,d)}else d=f.subarray(3*c.start,3*(c.start+c.length)),g.Mesh.computeBoundingBox(d,c.bounding)}return!0};Mesh.prototype.setBoundingBox=function(h,f){BBox.setCenterHalfsize(this._bounding,h,f)};Mesh.prototype.freeData=function(){for(var h in this.vertexBuffers)this.vertexBuffers[h].data=null,delete this[this.vertexBuffers[h].name];
for(var f in this.indexBuffers)this.indexBuffers[f].data=null,delete this[this.indexBuffers[f].name]};Mesh.prototype.configure=function(h,f){var a={},b={};f=f||{};for(var c in h)if(h[c])if("vertexBuffers"==c||"vertex_buffers"==c)for(d in h[c])a[d]=h[c][d];else if("indexBuffers"==c||"index_buffers"==c)for(d in h[c])b[d]=h[c][d];else"indices"==c||"lines"==c||"wireframe"==c||"triangles"==c?b[c]=h[c]:g.Mesh.common_buffers[c]?a[c]=h[c]:f[c]=h[c];this.addBuffers(a,b,f.stream_type);for(var d in f)this[d]=
f[d];f.bounding||this.updateBoundingBox()};Mesh.prototype.totalMemory=function(){var h=0,f;for(f in this.vertexBuffers)h+=this.vertexBuffers[f].data.buffer.byteLength;for(f in this.indexBuffers)h+=this.indexBuffers[f].data.buffer.byteLength;return h};Mesh.prototype.simplify=function(){var h=this.getBoundingBox(),f=BBox.getMin(h),h=BBox.getHalfsize(h),h=vec3.scale(vec3.create(),h,2),a=new g.Mesh,b=vec3.create(),c;for(c in this.vertexBuffers){var d=this.vertexBuffers[c].data,e=new Float32Array(d.length);
if("vertices"==c)for(var k=0,t=d.length;k<t;k+=3){var l=d.subarray(k,k+3);vec3.sub(b,l,f);vec3.div(b,b,h);b[0]=Math.round(256*b[0])/256;b[1]=Math.round(256*b[1])/256;b[2]=Math.round(256*b[2])/256;vec3.mul(b,b,h);vec3.add(b,b,f);e.set(b,k)}a.addBuffer()}};Mesh.load=function(h,f,a,b){f=f||{};f.no_gl&&(b=null);a=a||new g.Mesh(null,null,null,b);a.configure(h,f);return a};Mesh.mergeMeshes=function(h,f){function a(a,b,c,d){for(c=b+c;b<c;b+=3){var e=a.subarray(b,b+3);vec3.transformMat4(e,e,d)}}function b(a,
b,c,d){for(c=b+c;b<c;b+=2){var e=a.subarray(b,b+2);vec2.transformMat3(e,e,d)}}function c(a,b,c,d){for(c=b+c;b<c;++b)a[b]+=d}f=f||{};for(var d={},e={},k={},t=[],l=0,m=[],p=0;p<h.length;++p){var q=h[p],r=q.mesh,u=l;t.push(u);var n=r.vertexBuffers.vertices.data.length/3,l=l+n,s;for(s in r.vertexBuffers)d[s]=d[s]?d[s]+r.vertexBuffers[s].data.length:r.vertexBuffers[s].data.length;for(s in r.indexBuffers)e[s]=e[s]?e[s]+r.indexBuffers[s].data.length:r.indexBuffers[s].data.length;m.push({name:"mesh_"+p,start:u,
length:n,material:""})}for(s in d)p=f[s],null===p?delete d[s]:(p||(p=Float32Array),d[s]=new p(d[s]),k[s]=0);for(s in e)e[s]=new Uint32Array(e[s]),k[s]=0;for(p=0;p<h.length;++p){q=h[p];r=q.mesh;n=u=0;for(s in r.vertexBuffers)d[s]&&("vertices"==s&&(n=r.vertexBuffers[s].data.length/3),d[s].set(r.vertexBuffers[s].data,k[s]),q[s+"_matrix"]&&(l=q[s+"_matrix"],16==l.length?a(d[s],k[s],r.vertexBuffers[s].data.length,l):9==l.length&&b(d[s],k[s],r.vertexBuffers[s].data.length,l)),k[s]+=r.vertexBuffers[s].data.length);
for(s in r.indexBuffers)e[s].set(r.indexBuffers[s].data,k[s]),c(e[s],k[s],r.indexBuffers[s].data.length,t[p]),k[s]+=r.indexBuffers[s].data.length}k={info:{groups:m}};return"undefined"!=typeof gl||f.only_data?new g.Mesh(d,e,k):{vertexBuffers:d,indexBuffers:e,info:{groups:m}}};Mesh.parsers={};Mesh.encoders={};Mesh.binary_file_formats={};Mesh.compressors={};Mesh.decompressors={};Mesh.fromURL=function(h,f,a,b){b=b||{};a=a||n.gl;var c=new g.Mesh(void 0,void 0,void 0,a);c.ready=!1;a=h.lastIndexOf(".");
var d=h.substr(a+1).toLowerCase();b.binary=Mesh.binary_file_formats[d];HttpRequest(h,null,function(a){c.parse(a,d);delete c.ready;f&&f.call(c,c,h)},function(a){f&&f(null)},b);return c};Mesh.prototype.parse=function(h,f){f=f.toLowerCase();var a=g.Mesh.parsers[f];if(a)return a.call(null,h,{mesh:this});throw"GL.Mesh.parse: no parser found for format "+f;};Mesh.prototype.encode=function(h,f){h=h.toLowerCase();var a=g.Mesh.encoders[h];if(a)return a.call(null,this,f);throw"GL.Mesh.encode: no encoder found for format "+
h;};Mesh.getScreenQuad=function(h){h=h||n.gl;var f=h.meshes[":screen_quad"];if(f)return f;var f=new Float32Array([0,0,0,1,1,0,0,1,0,0,0,0,1,0,0,1,1,0]),a=new Float32Array([0,0,1,1,0,1,0,0,1,0,1,1]),f=new g.Mesh({vertices:f,coords:a},void 0,void 0,h);return h.meshes[":screen_quad"]=f};g.Mesh.EXTENSION="wbin";g.Mesh.enable_wbin_compression=!0;Mesh.plane=function(h,f){h=h||{};h.triangles=[];var a=h.detailX||h.detail||1,b=h.detailY||h.detail||1,c=h.width||h.size||1,d=h.height||h.size||1,e=h.xz,c=0.5*
c,d=0.5*d,k=[],t=[],l=[],m=[],p=vec3.fromValues(0,0,1);e&&p.set([0,1,0]);for(var q=0;q<=b;q++)for(var r=q/b,u=0;u<=a;u++){var n=u/a;e?t.push((2*n-1)*c,0,-(2*r-1)*d):t.push((2*n-1)*c,(2*r-1)*d,0);l.push(n,r);m.push(p[0],p[1],p[2]);u<a&&q<b&&(n=u+q*(a+1),e?(k.push(n+1,n+a+1,n),k.push(n+1,n+a+2,n+a+1)):(k.push(n,n+1,n+a+1),k.push(n+a+1,n+1,n+a+2)))}a=BBox.fromCenterHalfsize([0,0,0],e?[c,0,d]:[c,d,0]);return g.Mesh.load({vertices:t,normals:m,coords:l,triangles:k},{bounding:a},f)};Mesh.plane2D=function(h,
f){var a=new Float32Array([-1,1,1,-1,1,1,-1,1,-1,-1,1,-1]),b=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0]);if(h&&h.size)for(var c=0.5*h.size,d=0;d<a.length;++d)a[d]*=c;return new g.Mesh({vertices2D:a,coords:b},null,f)};Mesh.point=function(h){return new g.Mesh({vertices:[0,0,0]})};Mesh.cube=function(h,f){h=h||{};var a=0.5*(h.size||1),b={};b.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,
1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var c=0,d=b.vertices.length;c<d;++c)b.vertices[c]*=a;b.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);b.coords=new Float32Array([0,1,1,0,1,1,0,1,
0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);h.wireframe&&(b.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11]));h.bounding=BBox.fromCenterHalfsize([0,0,0],[a,a,a]);return g.Mesh.load(b,h,f)};Mesh.box=function(h,f){h=h||{};var a=h.sizex||1,b=h.sizey||1,c=h.sizez||1,a=0.5*a,b=0.5*b,c=0.5*c,d={};d.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,
1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var e=0,k=d.vertices.length;e<k;e+=3)d.vertices[e]*=a,d.vertices[e+1]*=b,d.vertices[e+2]*=c;d.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,
0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);d.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);h.wireframe&&(d.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11]));h.bounding=BBox.fromCenterHalfsize([0,0,0],[a,b,c]);return g.Mesh.load(d,h,f)};Mesh.circle=function(h,f){h=h||{};var a=h.size||h.radius||1,b=Math.ceil(h.slices||
24),c=h.xz||!1,d=h.empty||!1;3>b&&(b=3);var e=2*Math.PI/b,k=vec3.create(),t=vec3.create(),l=vec3.fromValues(0,0,1),m=vec2.fromValues(0.5,0.5),p=vec2.create();c&&l.set([0,1,0]);var q=c?2:1,r=new Float32Array(3*(b+1)),n=new Float32Array(3*(b+1)),w=new Float32Array(2*(b+1)),s=null;r.set(k,0);n.set(l,0);w.set(m,0);for(k=m=s=0;k<b;++k)s=Math.sin(e*k),m=Math.cos(e*k),t[0]=s*a,t[q]=m*a,p[0]=0.5*s+0.5,p[1]=0.5*m+0.5,r.set(t,3*k+3),n.set(l,3*k+3),w.set(p,2*k+2);if(d)r=r.subarray(3),n=r.subarray(3),w=r.subarray(2),
s=null;else{s=new Uint16Array(3*b);d=2;e=1;c&&(d=1,e=2);for(k=0;k<b-1;++k)s[3*k]=0,s[3*k+1]=k+d,s[3*k+2]=k+e;s[3*k]=0;c?(s[3*k+1]=k+1,s[3*k+2]=1):(s[3*k+1]=1,s[3*k+2]=k+1)}h.bounding=BBox.fromCenterHalfsize([0,0,0],c?[a,0,a]:[a,a,0]);a={vertices:r,normals:n,coords:w,triangles:s};if(h.wireframe){c=new Uint16Array(2*b);for(k=0;k<b;k++)c[2*k]=k,c[2*k+1]=k+1;c[0]=b;a.wireframe=c}return g.Mesh.load(a,h,f)};Mesh.cylinder=function(h,f){h=h||{};for(var a=h.radius||h.size||1,b=h.height||h.size||2,c=h.subdivisions||
64,d=new Float32Array(36*c),e=new Float32Array(36*c),k=new Float32Array(24*c),g=2*Math.PI/c,l=null,m=0;m<c;++m){var p=m*g,l=[Math.sin(p),0,Math.cos(p)];d.set([l[0]*a,0.5*b,l[2]*a],18*m);e.set(l,18*m);k.set([m/c,1],12*m);l=[Math.sin(p),0,Math.cos(p)];d.set([l[0]*a,-0.5*b,l[2]*a],18*m+3);e.set(l,18*m+3);k.set([m/c,0],12*m+2);l=[Math.sin(p+g),0,Math.cos(p+g)];d.set([l[0]*a,-0.5*b,l[2]*a],18*m+6);e.set(l,18*m+6);k.set([(m+1)/c,0],12*m+4);l=[Math.sin(p+g),0,Math.cos(p+g)];d.set([l[0]*a,0.5*b,l[2]*a],18*
m+9);e.set(l,18*m+9);k.set([(m+1)/c,1],12*m+6);l=[Math.sin(p),0,Math.cos(p)];d.set([l[0]*a,0.5*b,l[2]*a],18*m+12);e.set(l,18*m+12);k.set([m/c,1],12*m+8);l=[Math.sin(p+g),0,Math.cos(p+g)];d.set([l[0]*a,-0.5*b,l[2]*a],18*m+15);e.set(l,18*m+15);k.set([(m+1)/c,0],12*m+10)}var l=18*m,q=12*m;if(!1===h.caps)d=d.subarray(0,l),e=e.subarray(0,l),k=k.subarray(0,q);else for(var r=vec3.fromValues(0,0.5*b,0),n=vec3.fromValues(0,-0.5*b,0),w=vec3.fromValues(0,1,0),s=vec3.fromValues(0,-1,0),m=0;m<c;++m){var p=m*g,
z=vec3.fromValues(Math.sin(p),0,Math.cos(p)),p=vec3.fromValues(Math.sin(p+g),0,Math.cos(p+g));d.set([z[0]*a,0.5*b,z[2]*a],l+18*m);e.set(w,l+18*m);k.set([0.5*-z[0]+0.5,0.5*z[2]+0.5],q+12*m);d.set([p[0]*a,0.5*b,p[2]*a],l+18*m+3);e.set(w,l+18*m+3);k.set([0.5*-p[0]+0.5,0.5*p[2]+0.5],q+12*m+2);d.set(r,l+18*m+6);e.set(w,l+18*m+6);k.set([0.5,0.5],q+12*m+4);d.set([p[0]*a,-0.5*b,p[2]*a],l+18*m+9);e.set(s,l+18*m+9);k.set([0.5*p[0]+0.5,0.5*p[2]+0.5],q+12*m+6);d.set([z[0]*a,-0.5*b,z[2]*a],l+18*m+12);e.set(s,
l+18*m+12);k.set([0.5*z[0]+0.5,0.5*z[2]+0.5],q+12*m+8);d.set(n,l+18*m+15);e.set(s,l+18*m+15);k.set([0.5,0.5],q+12*m+10)}c={vertices:d,normals:e,coords:k};h.bounding=BBox.fromCenterHalfsize([0,0,0],[a,0.5*b,a]);h.info={groups:[]};!1!==h.caps&&(h.info.groups.push({name:"side",start:0,length:l/3}),h.info.groups.push({name:"caps",start:l/3,length:(d.length-l)/3}));return Mesh.load(c,h,f)};Mesh.cone=function(h,f){h=h||{};for(var a=h.radius||h.size||1,b=h.height||h.size||2,c=h.subdivisions||64,d=new Float32Array(18*
c),e=new Float32Array(18*c),k=new Float32Array(12*c),g=2*Math.PI/c,l=null,m=a/b,p=0;p<c;++p){var q=p*g,l=[Math.sin(q+0.5*g),m,Math.cos(q+0.5*g)];vec3.normalize(l,l);d.set([0,b,0],18*p);e.set(l,18*p);k.set([p/c,1],12*p);l=[Math.sin(q),m,Math.cos(q)];d.set([l[0]*a,0,l[2]*a],18*p+3);vec3.normalize(l,l);e.set(l,18*p+3);k.set([p/c,0],12*p+2);l=[Math.sin(q+g),m,Math.cos(q+g)];d.set([l[0]*a,0,l[2]*a],18*p+6);vec3.normalize(l,l);e.set(l,18*p+6);k.set([(p+1)/c,0],12*p+4)}l=vec3.fromValues(0,0,0);m=vec3.fromValues(0,
-1,0);for(p=0;p<c;++p){var q=p*g,r=vec3.fromValues(Math.sin(q),0,Math.cos(q)),q=vec3.fromValues(Math.sin(q+g),0,Math.cos(q+g));d.set([q[0]*a,0,q[2]*a],18*p+9);e.set(m,18*p+9);k.set([0.5*q[0]+0.5,0.5*q[2]+0.5],12*p+6);d.set([r[0]*a,0,r[2]*a],18*p+12);e.set(m,18*p+12);k.set([0.5*r[0]+0.5,0.5*r[2]+0.5],12*p+8);d.set(l,18*p+15);e.set(m,18*p+15);k.set([0.5,0.5],12*p+10)}c={vertices:d,normals:e,coords:k};h.bounding=BBox.fromCenterHalfsize([0,0.5*b,0],[a,0.5*b,a]);return Mesh.load(c,h,f)};Mesh.sphere=function(h,
f){h=h||{};for(var a=h.radius||h.size||1,b=h.lat||h.subdivisions||16,c=h["long"]||h.subdivisions||16,d=new Float32Array((b+1)*(c+1)*3),e=new Float32Array((b+1)*(c+1)*3),k=new Float32Array((b+1)*(c+1)*2),t=new Uint16Array(b*c*6),l=h.hemi?0.5*Math.PI:Math.PI,m=0,p=0,q=0;q<=b;q++)for(var r=q*l/b,n=Math.sin(r),w=Math.cos(r),r=0;r<=c;r++){var s=2*r*Math.PI/c,z=Math.sin(s),s=Math.cos(s)*n,x=w,z=z*n,M=1-r/c,A=1-q/b;d.set([a*s,a*x,a*z],m);e.set([s,x,z],m);k.set([M,A],p);m+=3;p+=2}for(q=m=0;q<b;q++)for(r=
0;r<c;r++)l=q*(c+1)+r,p=l+c+1,t.set([p,l,l+1],m),t.set([p+1,p,l+1],m+3),m+=6;d={vertices:d,normals:e,coords:k,triangles:t};if(h.wireframe){e=new Uint16Array(c*b*4);for(m=k=0;m<b;m++){for(t=0;t<c;t++)e[k]=m*(c+1)+t,e[k+1]=m*(c+1)+t+1,k+=2;e[k-2*c]=m*(c+1)+t}for(m=0;m<c;m++)for(t=0;t<b;t++)e[k]=t*(c+1)+m,e[k+1]=(t+1)*(c+1)+m,k+=2;d.wireframe=e}h.bounding=h.hemi?BBox.fromCenterHalfsize([0,0.5*a,0],[a,0.5*a,a],a):BBox.fromCenterHalfsize([0,0,0],[a,a,a],a);return g.Mesh.load(d,h,f)};Mesh.grid=function(h,
f){h=h||{};var a=h.lines||11;0>a&&(a=1);for(var b=h.size||10,c=new Float32Array(12*a),d=0.5*b,e=0,k=-d,b=b/(a-1),t=0;t<a;t++)c[e]=k,c[e+2]=-d,c[e+3]=k,c[e+5]=d,c[e+6]=d,c[e+8]=k,c[e+9]=-d,c[e+11]=k,k+=b,e+=12;return new g.Mesh({vertices:c},h,f)};Mesh.icosahedron=function(h,f){function a(a,c){var d=l[a]<l[c]?l[a]+":"+l[c]:l[c]+":"+l[a],f=w[d];if(f)return f;f=e.length/3;e.push(0.5*(e[3*l[a]]+e[3*l[c]]),0.5*(e[3*l[a]+1]+e[3*l[c]+1]),0.5*(e[3*l[a]+2]+e[3*l[c]+2]));var h=Math.sqrt(e[3*f]*e[3*f]+e[3*f+
1]*e[3*f+1]+e[3*f+2]*e[3*f+2]),g=e[3*f]/h,m=e[3*f+1]/h,s=e[3*f+2]/h;k.push(g,m,s);t.push(Math.atan2(g,s)/Math.PI*0.5,Math.acos(m)/Math.PI);e[3*f]*=b/h;e[3*f+1]*=b/h;e[3*f+2]*=b/h;return w[d]=f}h=h||{};var b=h.radius||h.size||1,c=void 0===h.subdivisions?0:h.subdivisions;6<c&&(c=6);for(var d=(1+Math.sqrt(5))/2,e=[-1,d,0,1,d,0,-1,-d,0,1,-d,0,0,-1,d,0,1,d,0,-1,-d,0,1,-d,d,0,-1,d,0,1,-d,0,-1,-d,0,1],k=[],t=[],l=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,
8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],d=e.length,m=0;m<d;m+=3){var p=Math.sqrt(e[m]*e[m]+e[m+1]*e[m+1]+e[m+2]*e[m+2]),q=e[m]/p,r=e[m+1]/p,n=e[m+2]/p;k.push(q,r,n);t.push(Math.atan2(q,n),Math.acos(r));e[m]*=b/p;e[m+1]*=b/p;e[m+2]*=b/p}for(var w={},p=0;p<c;++p){q=[];d=l.length;for(m=0;m<d;m+=3){var r=a(m,m+1),n=a(m+1,m+2),s=a(m+2,m);q.push(l[m],r,s);q.push(l[m+1],n,r);q.push(l[m+2],s,n);q.push(r,n,s)}l=q}h.bounding=BBox.fromCenterHalfsize([0,0,0],[b,b,b],b);return new g.Mesh.load({vertices:e,coords:t,
normals:k,triangles:l},h,f)};n.Texture=g.Texture=function f(a,b,c,d){c=c||{};this.gl=d=d||n.gl;this._context_id=d.context_id;a=parseInt(a);b=parseInt(b);g.debug&&console.log("GL.Texture created: ",a,b);this.handler=d.createTexture();this.width=a;this.height=b;c.depth&&(this.depth=c.depth);this.texture_type=c.texture_type||d.TEXTURE_2D;this.format=c.format||f.DEFAULT_FORMAT;this.internalFormat=c.internalFormat;this.type=c.type||f.DEFAULT_TYPE;this.magFilter=c.magFilter||c.filter||f.DEFAULT_MAG_FILTER;
this.minFilter=c.minFilter||c.filter||f.DEFAULT_MIN_FILTER;this.wrapS=c.wrap||c.wrapS||f.DEFAULT_WRAP_S;this.wrapT=c.wrap||c.wrapT||f.DEFAULT_WRAP_T;this.data=null;f.MAX_TEXTURE_IMAGE_UNITS||(f.MAX_TEXTURE_IMAGE_UNITS=d.getParameter(d.MAX_TEXTURE_IMAGE_UNITS));this.has_mipmaps=!1;if(this.format==d.DEPTH_COMPONENT&&1==d.webgl_version&&!d.extensions.WEBGL_depth_texture)throw"Depth Texture not supported";if(this.type==d.FLOAT&&!d.extensions.OES_texture_float&&1==d.webgl_version)throw"Float Texture not supported";
if(this.type==d.HALF_FLOAT_OES){if(!d.extensions.OES_texture_half_float&&1==d.webgl_version)throw"Half Float Texture extension not supported.";1<d.webgl_version&&(console.warn("using HALF_FLOAT_OES in WebGL2 is deprecated, suing HALF_FLOAT instead"),this.type=this.format==d.RGB?d.RGB16F:d.RGBA16F)}if(!(isPowerOfTwo(this.width)&&isPowerOfTwo(this.height)||(this.minFilter==d.NEAREST||this.minFilter==d.LINEAR)&&this.wrapS==d.CLAMP_TO_EDGE&&this.wrapT==d.CLAMP_TO_EDGE))if(c.ignore_pot)this.minFilter=
this.magFilter=d.LINEAR,this.wrapS=this.wrapT=d.CLAMP_TO_EDGE;else throw"Cannot use texture-wrap or mipmaps in Non-Power-of-Two textures";if(a&&b){this.internalFormat||this.computeInternalFormat();d.activeTexture(d.TEXTURE0+f.MAX_TEXTURE_IMAGE_UNITS-1);d.bindTexture(this.texture_type,this.handler);d.texParameteri(this.texture_type,d.TEXTURE_MAG_FILTER,this.magFilter);d.texParameteri(this.texture_type,d.TEXTURE_MIN_FILTER,this.minFilter);d.texParameteri(this.texture_type,d.TEXTURE_WRAP_S,this.wrapS);
d.texParameteri(this.texture_type,d.TEXTURE_WRAP_T,this.wrapT);c.anisotropic&&d.extensions.EXT_texture_filter_anisotropic&&d.texParameterf(g.TEXTURE_2D,d.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,c.anisotropic);var e=c.pixel_data;e&&!e.buffer&&(this.data=e=new (this.type==d.FLOAT?Float32Array:Uint8Array)(e));if(this.texture_type==g.TEXTURE_2D)d.texImage2D(g.TEXTURE_2D,0,this.internalFormat,a,b,0,this.format,this.type,e||null),g.isPowerOfTwo(a)&&g.isPowerOfTwo(b)&&c.minFilter&&
c.minFilter!=d.NEAREST&&c.minFilter!=d.LINEAR&&(d.generateMipmap(this.texture_type),this.has_mipmaps=!0);else if(this.texture_type==g.TEXTURE_CUBE_MAP)d.texImage2D(d.TEXTURE_CUBE_MAP_POSITIVE_X,0,this.internalFormat,this.width,this.height,0,this.format,this.type,e||null),d.texImage2D(d.TEXTURE_CUBE_MAP_POSITIVE_Y,0,this.internalFormat,this.width,this.height,0,this.format,this.type,e||null),d.texImage2D(d.TEXTURE_CUBE_MAP_POSITIVE_Z,0,this.internalFormat,this.width,this.height,0,this.format,this.type,
e||null),d.texImage2D(d.TEXTURE_CUBE_MAP_NEGATIVE_X,0,this.internalFormat,this.width,this.height,0,this.format,this.type,e||null),d.texImage2D(d.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,this.internalFormat,this.width,this.height,0,this.format,this.type,e||null),d.texImage2D(d.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,this.internalFormat,this.width,this.height,0,this.format,this.type,e||null);else if(this.texture_type==g.TEXTURE_3D){if(1==this.gl.webgl_version)throw"TEXTURE_3D not supported in WebGL 1. Enable WebGL 2 in the context by pasing webgl2:true";
if(!c.depth)throw"3d texture depth must be set in the options.depth";d.texImage3D(g.TEXTURE_3D,0,this.internalFormat,a,b,c.depth,0,this.format,this.type,e||null)}d.bindTexture(this.texture_type,null);d.activeTexture(d.TEXTURE0)}};Texture.DEFAULT_TYPE=g.UNSIGNED_BYTE;Texture.DEFAULT_FORMAT=g.RGBA;Texture.DEFAULT_MAG_FILTER=g.LINEAR;Texture.DEFAULT_MIN_FILTER=g.LINEAR;Texture.DEFAULT_WRAP_S=g.CLAMP_TO_EDGE;Texture.DEFAULT_WRAP_T=g.CLAMP_TO_EDGE;Texture.EXTENSION="png";Texture.framebuffer=null;Texture.renderbuffer=
null;Texture.loading_color=new Uint8Array([0,0,0,0]);Texture.use_renderbuffer_pool=!0;Texture.prototype.computeInternalFormat=function(){this.internalFormat=this.format;if(this.format==g.DEPTH_COMPONENT)if(this.minFilter=this.magFilter=g.NEAREST,2==gl.webgl_version)if(this.type==g.UNSIGNED_SHORT)this.internalFormat=g.DEPTH_COMPONENT16;else if(this.type==g.UNSIGNED_INT)this.internalFormat=g.DEPTH_COMPONENT24;else if(this.type==g.FLOAT)this.internalFormat=g.DEPTH_COMPONENT32F;else throw"unsupported type for a depth texture";
else{if(1==gl.webgl_version){if(this.type==g.FLOAT)throw"WebGL 1.0 does not support float depth textures";this.internalFormat=g.DEPTH_COMPONENT}}else this.format==gl.RGBA&&(2==gl.webgl_version?this.type==g.FLOAT?this.internalFormat=g.RGBA32F:this.type==g.HALF_FLOAT?this.internalFormat=g.RGBA16F:this.type==g.HALF_FLOAT_OES&&(console.warn("webgl 2 does not use HALF_FLOAT_OES, converting to HALF_FLOAT"),this.type=g.HALF_FLOAT,this.internalFormat=g.RGBA16F):1==gl.webgl_version&&this.type==g.HALF_FLOAT&&
(console.warn("webgl 1 does not use HALF_FLOAT, converting to HALF_FLOAT_OES"),this.type=g.HALF_FLOAT_OES))};Texture.prototype.delete=function(){gl.deleteTexture(this.handler);this.handler=null};Texture.prototype.getProperties=function(){return{width:this.width,height:this.height,type:this.type,format:this.format,texture_type:this.texture_type,magFilter:this.magFilter,minFilter:this.minFilter,wrapS:this.wrapS,wrapT:this.wrapT}};Texture.prototype.hasSameProperties=function(f){return f?f.width==this.width&&
f.height==this.height&&f.type==this.type&&f.format==this.format&&f.texture_type==this.texture_type:!1};Texture.prototype.hasSameSize=function(f){return f?f.width==this.width&&f.height==this.height:!1};Texture.prototype.toJSON=function(){return""};Texture.isDepthSupported=function(){return null!=gl.extensions.WEBGL_depth_texture};Texture.prototype.bind=function(f){void 0==f&&(f=0);var a=this.gl;a.activeTexture(a.TEXTURE0+f);a.bindTexture(this.texture_type,this.handler);return f};Texture.prototype.unbind=
function(f){void 0===f&&(f=0);var a=this.gl;a.activeTexture(a.TEXTURE0+f);a.bindTexture(this.texture_type,null)};Texture.prototype.setParameter=function(f,a){this.bind(0);this.gl.texParameteri(this.texture_type,f,a);switch(f){case this.gl.TEXTURE_MAG_FILTER:this.magFilter=a;break;case this.gl.TEXTURE_MIN_FILTER:this.minFilter=a;break;case this.gl.TEXTURE_WRAP_S:this.wrapS=a;break;case this.gl.TEXTURE_WRAP_T:this.wrapT=a}};Texture.setUploadOptions=function(f,a){a=a||n.gl;f?(a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,
!!f.premultiply_alpha),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!f.no_flip)):(a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0));a.pixelStorei(a.UNPACK_ALIGNMENT,1)};Texture.prototype.uploadImage=function(f,a){this.bind();var b=this.gl;if(!f)throw"uploadImage parameter must be Image";Texture.setUploadOptions(a,b);try{b.texImage2D(b.TEXTURE_2D,0,this.format,this.format,this.type,f),this.width=f.videoWidth||f.width,this.height=f.videoHeight||f.height,this.data=f}catch(c){if("file:"==
location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}this.minFilter&&this.minFilter!=b.NEAREST&&this.minFilter!=b.LINEAR&&(b.generateMipmap(this.texture_type),this.has_mipmaps=!0);b.bindTexture(this.texture_type,null)};Texture.prototype.uploadData=function(f,a,b){a=a||{};var c=this.gl;this.bind();Texture.setUploadOptions(a,
c);if(this.texture_type==g.TEXTURE_2D)c.texImage2D(this.texture_type,0,this.format,this.width,this.height,0,this.format,this.type,f);else if(this.texture_type==g.TEXTURE_3D)c.texImage3D(this.texture_type,0,this.format,this.width,this.height,this.depth,0,this.format,this.type,f);else if(this.texture_type==g.TEXTURE_CUBE_MAP)c.texImage2D(c.TEXTURE_CUBE_MAP_POSITIVE_X+(a.cubemap_face||0),0,this.format,this.width,this.height,0,this.format,this.type,f);else throw"cannot uploadData for this texture type";
this.data=f;!b&&this.minFilter&&this.minFilter!=c.NEAREST&&this.minFilter!=c.LINEAR&&(c.generateMipmap(texture.texture_type),this.has_mipmaps=!0);c.bindTexture(this.texture_type,null)};Texture.cubemap_camera_parameters=[{type:"posX",dir:vec3.fromValues(1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,-1)},{type:"negX",dir:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,1)},{type:"posY",dir:vec3.fromValues(0,1,0),up:vec3.fromValues(0,0,-1),right:vec3.fromValues(1,
0,0)},{type:"negY",dir:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,1),right:vec3.fromValues(1,0,0)},{type:"posZ",dir:vec3.fromValues(0,0,1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(1,0,0)},{type:"negZ",dir:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(-1,0,0)}];Texture.prototype.drawTo=function(f,a){function b(){6E4<=g.getTime()-this.time?(console.log("Buffer cleared"),c.deleteRenderbuffer(c._renderbuffers_pool[m]),delete c._renderbuffers_pool[m]):setTimeout(b.bind(this),
6E4)}var c=this.gl,d=c.getViewport(),e=g.getTime(),k=c.getParameter(c.FRAMEBUFFER_BINDING),t=c._framebuffer=c._framebuffer||c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,t);var l=null;if(Texture.use_renderbuffer_pool){c._renderbuffers_pool||(c._renderbuffers_pool={});var m=this.width+":"+this.height;c._renderbuffers_pool[m]?(l=c._renderbuffers_pool[m],l.time=e,c.bindRenderbuffer(c.RENDERBUFFER,l)):(c._renderbuffers_pool[m]=l=c.createRenderbuffer(),l.time=e,l.width=this.width,l.height=this.height,
c.bindRenderbuffer(c.RENDERBUFFER,l),setTimeout(b.bind(l),6E4))}else l=c._renderbuffer=c._renderbuffer||c.createRenderbuffer(),l.width=this.width,l.height=this.height,c.bindRenderbuffer(c.RENDERBUFFER,l);this.format===c.DEPTH_COMPONENT?c.renderbufferStorage(c.RENDERBUFFER,c.RGBA4,this.width,this.height):c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,this.width,this.height);c.viewport(0,0,this.width,this.height);c._current_texture_drawto=this;c._current_fbo_color=t;c._current_fbo_depth=l;
if(this.texture_type==c.TEXTURE_2D)this.format!==c.DEPTH_COMPONENT?(c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,this.handler,0),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,l)):(c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,l),c.framebufferTexture2D(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.TEXTURE_2D,this.handler,0)),f(this,a);else if(this.texture_type==c.TEXTURE_CUBE_MAP)for(this.format!==c.DEPTH_COMPONENT?c.framebufferRenderbuffer(c.FRAMEBUFFER,
c.DEPTH_ATTACHMENT,c.RENDERBUFFER,l):c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,l),e=0;6>e;e++)this.format!==c.DEPTH_COMPONENT?c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+e,this.handler,0):c.framebufferTexture2D(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.TEXTURE_CUBE_MAP_POSITIVE_X+e,this.handler,0),f(this,e,a);this.data=null;c._current_texture_drawto=null;c._current_fbo_color=null;c._current_fbo_depth=null;c.bindFramebuffer(c.FRAMEBUFFER,
k);c.bindRenderbuffer(c.RENDERBUFFER,null);c.viewport(d[0],d[1],d[2],d[3]);return this};Texture.drawTo=function(f,a,b){var c=-1,d=-1,e=null;if(!f&&!b)throw"Textures missing in drawTo";if(f&&f.length)for(var k=0;k<f.length;k++){var g=f[k];if(-1==c)c=g.width;else if(c!=g.width)throw"Cannot use Texture.drawTo if textures have different dimensions";if(-1==d)d=g.height;else if(d!=g.height)throw"Cannot use Texture.drawTo if textures have different dimensions";if(null==e)e=g.type;else if(e!=g.type)throw"Cannot use Texture.drawTo if textures have different data type, all must have the same type";
}else c=b.width,d=b.height;var l=gl.extensions.WEBGL_draw_buffers;if(!l&&f&&1<f.length)throw"Rendering to several textures not supported";e=gl.getViewport();gl._framebuffer=gl._framebuffer||gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,gl._framebuffer);gl.viewport(0,0,c,d);k=null;if(b&&b.format!==gl.DEPTH_COMPONENT||b.type!=gl.UNSIGNED_INT)throw"Depth texture must be of format: gl.DEPTH_COMPONENT and type: gl.UNSIGNED_INT";b?gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,
b.handler,0):(k=gl._renderbuffer=gl._renderbuffer||gl.createRenderbuffer(),k.width=c,k.height=d,gl.bindRenderbuffer(gl.RENDERBUFFER,k),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,c,d),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,k));if(f){c=[];for(k=0;k<f.length;k++)g=f[k],gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+k,gl.TEXTURE_2D,g.handler,0),c.push(gl.COLOR_ATTACHMENT0+k);1<f.length&&l.drawBuffersWEBGL(c)}else b=this._color_renderbuffer=
this._color_renderbuffer||gl.createRenderbuffer(),b.width=c,b.height=d,gl.bindRenderbuffer(gl.RENDERBUFFER,b),gl.renderbufferStorage(gl.RENDERBUFFER,gl.RGBA4,c,d),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,b);c=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(c!==gl.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+c;a();if(f.length)for(k=0;k<f.length;++k)f[k].data=null;gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.viewport(e[0],e[1],e[2],e[3])};Texture.drawToColorAndDepth=
function(f,a,b){var c=f.gl;if(a.width!=f.width||a.height!=f.height)throw"Different size between color texture and depth texture";var d=c.getViewport();c._framebuffer=c._framebuffer||c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,c._framebuffer);c.viewport(0,0,f.width,f.height);c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,f.handler,0);c.framebufferTexture2D(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.TEXTURE_2D,a.handler,0);b();f.data=null;a.data=null;c.bindFramebuffer(c.FRAMEBUFFER,
null);c.viewport(d[0],d[1],d[2],d[3])};Texture.prototype.copyTo=function(f,a,b){var c=this.gl,d=c.getParameter(c.FRAMEBUFFER_BINDING),e=c.getViewport();a||(a=this.texture_type==c.TEXTURE_2D?g.Shader.getScreenShader():g.Shader.getCubemapCopyShader());c.disable(c.BLEND);c.disable(c.DEPTH_TEST);a&&b&&a.uniforms(b);b=c.__copy_fbo;b||(b=c.__copy_fbo=c.createFramebuffer());c.bindFramebuffer(c.FRAMEBUFFER,b);c.viewport(0,0,f.width,f.height);if(this.texture_type==c.TEXTURE_2D)if(this.format!==c.DEPTH_COMPONENT&&
this.format!==c.DEPTH_STENCIL)c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,f.handler,0),this.toViewport(a);else{a=c._color_renderbuffer=c._color_renderbuffer||c.createRenderbuffer();b=a.width=f.width;var k=a.height=f.height;c.bindRenderbuffer(c.RENDERBUFFER,a);c.renderbufferStorage(c.RENDERBUFFER,c.RGBA4,b,k);c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,a);b=f.format==c.DEPTH_STENCIL?c.DEPTH_STENCIL_ATTACHMENT:c.DEPTH_ATTACHMENT;c.framebufferTexture2D(c.FRAMEBUFFER,
b,c.TEXTURE_2D,f.handler,0);a=c.checkFramebufferStatus(c.FRAMEBUFFER);if(a!==c.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+a;c.enable(c.DEPTH_TEST);c.depthFunc(c.ALWAYS);c.colorMask(!1,!1,!1,!1);a=g.Shader.getCopyDepthShader();this.toViewport(a);c.colorMask(!0,!0,!0,!0);c.disable(c.DEPTH_TEST);c.depthFunc(c.LEQUAL);c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,null);c.framebufferTexture2D(c.FRAMEBUFFER,b,c.TEXTURE_2D,null,0)}else if(this.texture_type==c.TEXTURE_CUBE_MAP)for(a.uniforms({u_texture:0}),
b=g.temp_mat3,k=0;6>k;k++){c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+k,f.handler,0);var t=g.Texture.cubemap_camera_parameters[k];mat3.identity(b);b.set(t.right,0);b.set(t.up,3);b.set(t.dir,6);this.toViewport(a,{u_rotation:b})}c.setViewport(e);c.bindFramebuffer(c.FRAMEBUFFER,d);f.minFilter&&f.minFilter!=c.NEAREST&&f.minFilter!=c.LINEAR&&(f.bind(),c.generateMipmap(f.texture_type),f.has_mipmaps=!0);f.data=null;c.bindTexture(f.texture_type,null);return this};
Texture.prototype.toViewport=function(f,a){f=f||Shader.getScreenShader();var b=Mesh.getScreenQuad();this.bind(0);a&&f.uniforms(a);f.draw(b,gl.TRIANGLES)};Texture.prototype.fill=function(f,a){var b=gl.getParameter(gl.COLOR_CLEAR_VALUE);gl.clearColor(f[0],f[1],f[2],f[3]);this.drawTo(function(){gl.clear(gl.COLOR_BUFFER_BIT)});gl.clearColor(b[0],b[1],b[2],b[3]);!a&&this.minFilter&&this.minFilter!=gl.NEAREST&&this.minFilter!=gl.LINEAR&&(this.bind(),gl.generateMipmap(this.texture_type),this.has_mipmaps=
!0)};Texture.prototype.renderQuad=function(){var f=mat3.create(),a=vec2.create(),b=vec2.create(),c=vec4.fromValues(1,1,1,1);return function(d,e,k,g,l,m){a[0]=d;a[1]=e;b[0]=k;b[1]=g;l=l||Shader.getQuadShader(this.gl);d=Mesh.getScreenQuad(this.gl);this.bind(0);l.uniforms({u_texture:0,u_position:a,u_color:c,u_size:b,u_viewport:gl.viewport_data.subarray(2,4),u_transform:f});m&&l.uniforms(m);l.draw(d,gl.TRIANGLES)}}();Texture.prototype.applyBlur=function(f,a,b,c,d){var e=this.gl;void 0===f&&(f=1);void 0===
a&&(a=1);f/=this.width;a/=this.height;e.disable(e.DEPTH_TEST);e.disable(e.BLEND);if(this===d&&this.texture_type===e.TEXTURE_CUBE_MAP)throw"cannot use applyBlur in a texture with itself when blurring a CUBE_MAP";if(d&&this.texture_type!==d.texture_type)throw"cannot use applyBlur with textures of different texture_type";var k=null,t=e.getParameter(e.FRAMEBUFFER_BINDING),l=e.getViewport(),m=e.__copy_fbo;m||(m=e.__copy_fbo=e.createFramebuffer());e.bindFramebuffer(e.FRAMEBUFFER,m);e.viewport(0,0,this.width,
this.height);if(this.texture_type===e.TEXTURE_2D)k=g.Shader.getBlurShader(),c||(c=new g.Texture(this.width,this.height,this.getProperties())),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,c.handler,0),this.toViewport(k,{u_texture:0,u_intensity:b,u_offset:[0,a]}),d=d||this,e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,d.handler,0),c.toViewport(k,{u_intensity:b,u_offset:[f,0]}),k=c;else if(this.texture_type===e.TEXTURE_CUBE_MAP){k=g.Shader.getCubemapBlurShader();
k.uniforms({u_texture:0,u_intensity:b,u_offset:[f,a]});this.bind(0);f=Mesh.getScreenQuad();f.bindBuffers(k);k.bind();d||(d=new g.Texture(this.width,this.height,this.getProperties()));a=g.temp_mat3;for(b=0;6>b;++b)e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+b,d.handler,0),c=g.Texture.cubemap_camera_parameters[b],mat3.identity(a),a.set(c.right,0),a.set(c.up,3),a.set(c.dir,6),k._setUniform("u_rotation",a),e.drawArrays(e.TRIANGLES,0,6);f.unbindBuffers(k);k=d}e.setViewport(l);
e.bindFramebuffer(e.FRAMEBUFFER,t);d.data=null;d.minFilter&&d.minFilter!=e.NEAREST&&d.minFilter!=e.LINEAR&&(d.bind(),e.generateMipmap(d.texture_type),d.has_mipmaps=!0);e.bindTexture(d.texture_type,null);return k};Texture.fromURL=function(f,a,b,c){c=c||n.gl;a=a||{};a=Object.create(a);var d=a.texture||new g.Texture(1,1,a,c);64>f.length&&(d.url=f);d.bind();var e=a.temp_color||Texture.loading_color;c.pixelStorei(c.UNPACK_ALIGNMENT,4);e=a.type==c.FLOAT?new Float32Array(e):new Uint8Array(e);c.texImage2D(c.TEXTURE_2D,
0,d.format,d.width,d.height,0,d.format,d.type,e);c.bindTexture(d.texture_type,null);d.ready=!1;e=null;a.extension&&(e=a.extension);if(!e&&512>f.length){var k=f,t=f.indexOf("?");-1!=t&&(k=f.substr(0,t));t=k.lastIndexOf(".");-1!=t&&(e=k.substr(t+1).toLowerCase())}"dds"==e?(e=c.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||c.getExtension("WEBGL_compressed_texture_s3tc"),k=new g.Texture(0,0,a,c),O.loadDDSTextureEx(c,e,f,k.handler,!0,function(a){d.texture_type=a.texture_type;d.handler=a;delete d.ready;
b&&b(d,f)})):"tga"==e?HttpRequest(f,null,function(e){if(e=g.Texture.parseTGA(e))a.texture=d,"RGB"==e.format&&(d.format=c.RGB),d=g.Texture.fromMemory(e.width,e.height,e.pixels,a),delete d.ready,b&&b(d,f)},null,{binary:!0}):(e=new Image,e.src=f,e.onload=function(){a.texture=d;g.Texture.fromImage(this,a);delete d.ready;b&&b(d,f)},e.onerror=function(){b&&b(null)});return d};Texture.parseTGA=function(f){if(!f||f.constructor!==ArrayBuffer)throw"TGA: data must be ArrayBuffer";f=new Uint8Array(f);for(var a=
new Uint8Array([0,0,2,0,0,0,0,0,0,0,0,0]),b=f.subarray(0,12),c=0;c<b.length;c++)if(a[c]!=b[c])return console.error("TGA header is not valid"),null;a=f.subarray(12,18);b={};b.width=256*a[1]+a[0];b.height=256*a[3]+a[2];b.bpp=a[4];b.bytesPerPixel=b.bpp/8;b.imageSize=b.width*b.height*b.bytesPerPixel;b.pixels=f.subarray(18,18+b.imageSize);b.pixels=new Uint8Array(b.pixels);if(0==(a[5]&16)){for(c=0;c<b.imageSize;c+=b.bytesPerPixel)f=b.pixels[c],b.pixels[c]=b.pixels[c+2],b.pixels[c+2]=f;a[5]|=16}b.format=
32==b.bpp?"RGBA":"RGB";b.flipY=!0;return b};Texture.fromImage=function(f,a){a=a||{};var b=a.texture||new g.Texture(f.width,f.height,a);b.uploadImage(f,a);b.bind();gl.texParameteri(b.texture_type,gl.TEXTURE_MAG_FILTER,b.magFilter);gl.texParameteri(b.texture_type,gl.TEXTURE_MIN_FILTER,b.minFilter);gl.texParameteri(b.texture_type,gl.TEXTURE_WRAP_S,b.wrapS);gl.texParameteri(b.texture_type,gl.TEXTURE_WRAP_T,b.wrapT);g.isPowerOfTwo(b.width)&&g.isPowerOfTwo(b.height)?a.minFilter&&a.minFilter!=gl.NEAREST&&
a.minFilter!=gl.LINEAR&&(b.bind(),gl.generateMipmap(b.texture_type),b.has_mipmaps=!0):(gl.texParameteri(b.texture_type,gl.TEXTURE_MIN_FILTER,g.LINEAR),gl.texParameteri(b.texture_type,gl.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),gl.texParameteri(b.texture_type,gl.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE),b.has_mipmaps=!1);gl.bindTexture(b.texture_type,null);b.data=f;a.keep_image&&(b.img=f);return b};Texture.fromVideo=function(f,a){a=a||{};var b=a.texture||new g.Texture(f.videoWidth,f.videoHeight,a);b.bind();b.uploadImage(f,
a);a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(b.bind(),gl.generateMipmap(b.texture_type),b.has_mipmaps=!0,b.data=f);gl.bindTexture(b.texture_type,null);return b};Texture.fromTexture=function(f,a){a=a||{};var b=new g.Texture(f.width,f.height,a);f.copyTo(b);return b};Texture.prototype.clone=function(f){var a=this.getProperties();if(f)for(var b in f)a[b]=f[b];return Texture.fromTexture(this,a)};Texture.fromMemory=function(f,a,b,c){c=c||{};var d=c.texture||new g.Texture(f,a,c);Texture.setUploadOptions(c);
d.bind();try{gl.texImage2D(gl.TEXTURE_2D,0,d.format,f,a,0,d.format,d.type,b),d.width=f,d.height=a,d.data=b}catch(e){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}c.minFilter&&c.minFilter!=gl.NEAREST&&c.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_2D),d.has_mipmaps=!0);gl.bindTexture(d.texture_type,
null);return d};Texture.fromDDSInMemory=function(f,a){a=a||{};var b=a.texture||new g.Texture(0,0,a);g.Texture.setUploadOptions(a);b.bind();var c=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||gl.getExtension("WEBGL_compressed_texture_s3tc");O.loadDDSTextureFromMemoryEx(gl,c,f,b,!0);gl.bindTexture(b.texture_type,null);return b};Texture.fromShader=function(f,a,b,c){c=c||{};f=new g.Texture(f,a,c);f.drawTo(function(){gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);var a=
Mesh.getScreenQuad();b.draw(a)});return f};Texture.cubemapFromImages=function(f,a){a=a||{};if(6!=f.length)throw"missing images to create cubemap";var b=f[0].width,c=f[0].height;a.texture_type=gl.TEXTURE_CUBE_MAP;var d=null;a.texture?(d=a.texture,d.width=b,d.height=c):d=new g.Texture(b,c,a);Texture.setUploadOptions(a);d.bind();try{for(b=0;6>b;b++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+b,0,d.format,d.format,d.type,f[b]);d.data=f}catch(e){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';
throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_CUBE_MAP),d.has_mipmaps=!0);d.unbind();return d};Texture.cubemapFromImage=function(f,a){a=a||{};if(f.width!=f.height/6&&0!=f.height%6&&!a.faces)return console.error("Cubemap image not valid, only 1x6 (vertical) or 6x3 (cross) formats. Check size:",f.width,f.height),null;
var b=f.width,c=f.height;void 0!==a.is_cross?(a.faces=Texture.generateCubemapCrossFacesInfo(f.width,a.is_cross),b=c=f.width/4):a.faces?(b=a.width||a.faces[0].width,c=a.height||a.faces[0].height):c/=6;if(b!=c)return console.log("Texture not valid, width and height for every face must be square"),null;var d=b;a.no_flip=!0;for(var e=[],k=0;6>k;k++){var g=createCanvas(d,d),l=g.getContext("2d");a.faces?l.drawImage(f,a.faces[k].x,a.faces[k].y,a.faces[k].width||d,a.faces[k].height||d,0,0,d,d):l.drawImage(f,
0,c*k,b,c,0,0,d,d);e.push(g)}b=Texture.cubemapFromImages(e,a);a.keep_image&&(b.img=f);return b};Texture.generateCubemapCrossFacesInfo=function(f,a){void 0===a&&(a=1);var b=f/4;return[{x:2*b,y:b,width:b,height:b},{x:0,y:b,width:b,height:b},{x:a*b,y:0,width:b,height:b},{x:a*b,y:2*b,width:b,height:b},{x:b,y:b,width:b,height:b},{x:3*b,y:b,width:b,height:b}]};Texture.cubemapFromURL=function(f,a,b){a=a||{};a.texture_type=gl.TEXTURE_CUBE_MAP;var c=a.texture||new g.Texture(1,1,a);a=Object.create(a);c.bind();
Texture.setUploadOptions(a);for(var d=a.temp_color||[0,0,0,255],d=a.type==gl.FLOAT?new Float32Array(d):new Uint8Array(d),e=0;6>e;e++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,c.format,1,1,0,c.format,c.type,d);gl.bindTexture(c.texture_type,null);c.ready=!1;d=new Image;d.src=f;d.onload=function(){a.texture=c;(c=g.Texture.cubemapFromImage(this,a))&&delete c.ready;b&&b(c)};return c};Texture.prototype.getPixels=function(f,a,b){a=this.gl;var c=a.getViewport(),d=a.getParameter(a.FRAMEBUFFER_BINDING);
f=f||this.type;if(this.format==a.DEPTH_COMPONENT)throw"cannot use getPixels in depth textures";a.disable(a.DEPTH_TEST);var e=a.__copy_fbo;e||(e=a.__copy_fbo=a.createFramebuffer());a.bindFramebuffer(a.FRAMEBUFFER,e);e=null;a.viewport(0,0,this.width,this.height);this.texture_type==a.TEXTURE_2D?a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.handler,0):this.texture_type==a.TEXTURE_CUBE_MAP&&a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_CUBE_MAP_POSITIVE_X+
(b||0),this.handler,0);b=this.format==a.RGB?3:4;b=4;e=f==a.UNSIGNED_BYTE?new Uint8Array(this.width*this.height*b):new Float32Array(this.width*this.height*b);a.readPixels(0,0,this.width,this.height,3==b?a.RGB:a.RGBA,f,e);a.bindFramebuffer(a.FRAMEBUFFER,d);a.viewport(c[0],c[1],c[2],c[3]);return e};Texture.prototype.setPixels=function(f,a,b,c){a={no_flip:a};c&&(a.cubemap_face=c);this.uploadData(f,a,b)};Texture.prototype.toCanvas=function(f,a,b){b=b||8192;var c=this.gl,d=Math.min(this.width,b),e=Math.min(this.height,
b);this.texture_type==c.TEXTURE_CUBE_MAP&&(d*=4,e*=3);f=f||createCanvas(d,e);f.width!=d&&(f.width=d);f.height!=e&&(f.height=e);var k=null;if(this.texture_type==c.TEXTURE_2D){this.width!=d||this.height!=e?(k=new g.Texture(d,e,{format:c.RGBA,filter:c.NEAREST}),this.copyTo(k),k=k.getPixels(c.UNSIGNED_BYTE,!0)):k=this.getPixels(c.UNSIGNED_BYTE,!0);b=f.getContext("2d");var t=b.getImageData(0,0,d,e);t.data.set(k);b.putImageData(t,0,0);a&&(k=createCanvas(d,e),a=k.getContext("2d"),a.translate(0,k.height),
a.scale(1,-1),a.drawImage(f,0,0,k.width,k.height),b.drawImage(k,0,0))}else if(this.texture_type==c.TEXTURE_CUBE_MAP){d=createCanvas(this.width,this.height);a=d.getContext("2d");e=g.Texture.generateCubemapCrossFacesInfo(f.width,1);b=f.getContext("2d");b.fillStyle="black";b.fillRect(0,0,f.width,f.height);for(var l=0;6>l;l++)k=this.getPixels(c.UNSIGNED_BYTE,!0,l),t=a.getImageData(0,0,d.width,d.height),t.data.set(k),a.putImageData(t,0,0),b.drawImage(d,e[l].x,e[l].y,d.width,d.height)}return f};Texture.binary_extension=
"png";Texture.prototype.toBinary=function(f,a){for(var b=this.toCanvas(null,f).toDataURL(a),c=b.indexOf(","),b=b.substr(c+1),b=atob(b),c=b.length,d=new Uint8Array(c),e=0;e<c;++e)d[e]=b.charCodeAt(e);return d};Texture.prototype.toBlob=function(f,a){var b=this.toBinary(f);return new Blob([b],{type:a||"image/png"})};Texture.prototype.toBlobAsync=function(f,a,b){var c=this.toCanvas(null,f);c.toBlob?c.toBlob(b,a):(f=this.toBlob(f,a),b&&b(f))};Texture.prototype.toBase64=function(f){var a=this.width,b=this.height,
c=this.getPixels(),d=createCanvas(a,b),e=d.getContext("2d"),k=e.getImageData(0,0,a,b);k.data.set(c);e.putImageData(k,0,0);f&&(f=createCanvas(a,b),a=f.getContext("2d"),a.translate(0,b),a.scale(1,-1),a.drawImage(d,0,0),d=f);return d.toDataURL("image/png")};Texture.prototype.generateMetadata=function(){var f={};f.width=this.width;f.height=this.height;this.metadata=f};Texture.compareFormats=function(f,a){return f&&a?f==a?!0:f.width!=a.width||f.height!=a.height||f.type!=a.type||f.format!=a.format||f.texture_type!=
a.texture_type?!1:!0:!1};Texture.blend=function(f,a,b,c){if(!f||!a)return!1;if(f==a)return c?f.copyTo(c):f.toViewport(),!0;gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);var d=g.Shader.getBlendShader(),e=g.Mesh.getScreenQuad();a.bind(1);d.uniforms({u_texture:0,u_texture2:1,u_factor:b});if(c)return c.drawTo(function(){if(f==c||a==c)throw"Blend output cannot be the same as the input";f.bind(0);d.draw(e,gl.TRIANGLES)}),!0;f.bind(0);d.draw(e,gl.TRIANGLES);return!0};Texture.getWhiteTexture=
function(f){f=f||n.gl;var a=f.textures[":white"];if(a)return a;a=new Uint8Array([255,255,255,255]);return f.textures[":white"]=new g.Texture(1,1,{pixel_data:a})};Texture.getBlackTexture=function(f){f=f||n.gl;var a=f.textures[":black"];if(a)return a;a=new Uint8Array([0,0,0,255]);return f.textures[":black"]=new g.Texture(1,1,{pixel_data:a})};Texture.getTemporary=function(f,a,b,c){c=c||n.gl;c._texture_pool||(c._texture_pool=[]);var d=g.TEXTURE_2D,e=Texture.DEFAULT_TYPE,k=Texture.DEFAULT_FORMAT;b&&(b.texture_type&&
(d=b.texture_type),b.type&&(e=b.type),b.format&&(k=b.format));b=(e&65535)+((f&65535)<<16)+((a&65535)<<32);c=c._texture_pool;for(var t=0;t<c.length;++t){var l=c[t];if(l._key==b&&l.texture_type==d&&l.format==k)return c.splice(t,1),l._pool=0,l}l=new g.Texture(f,a,{type:e,texture_type:d,format:k});l._key=b;l._pool=0;return l};Texture.releaseTemporary=function(f,a){a=a||n.gl;a._texture_pool||(a._texture_pool=[]);0<f._pool&&console.warn("this texture is already in the textures pool");var b=a._texture_pool;
b||(b=a._texture_pool=[]);f._pool=getTime();b.push(f);15<b.length&&(b.sort(function(a,b){return b._pool-a._pool}),f=b.pop(),f._pool=0,f.delete())};Texture.nextPOT=function(f){return Math.pow(2,Math.ceil(Math.log(f)/Math.log(2)))};g.FBO=G;G.prototype.setTextures=function(f,a,b){if(a&&a.constructor===g.Texture){if(a.format!==g.DEPTH_COMPONENT&&a.format!==g.DEPTH_STENCIL&&a.format!==g.DEPTH_COMPONENT16&&a.format!==g.DEPTH_COMPONENT24&&a.format!==g.DEPTH_COMPONENT32F)throw"FBO Depth texture must be of format: gl.DEPTH_COMPONENT, gl.DEPTH_STENCIL or gl.DEPTH_COMPONENT16/24/32F (only in webgl2)";
if(a.type!=g.UNSIGNED_SHORT&&a.type!=g.UNSIGNED_INT&&a.type!=g.UNSIGNED_INT_24_8_WEBGL&&a.type!=g.FLOAT)throw"FBO Depth texture must be of type: gl.UNSIGNED_SHORT, gl.UNSIGNED_INT, gl.UNSIGNED_INT_24_8_WEBGL";}var c=this.depth_texture==a;if(c&&f){if(f.constructor!==Array)throw"FBO: color_textures parameter must be an array containing all the textures to be binded in the color";if(f.length==this.color_textures.length)for(var d=0;d<f.length;++d){if(f[d]!=this.color_textures[d]){c=!1;break}}else c=!1}this._stencil_enabled!==
this.stencil&&(c=!1);if(!c){this.color_textures.length=f?f.length:0;if(f)for(d=0;d<f.length;++d)this.color_textures[d]=f[d];this.depth_texture=a;this.update(b)}};G.prototype.update=function(f){this._old_fbo_handler=gl.getParameter(gl.FRAMEBUFFER_BINDING);this.handler||(this.handler=gl.createFramebuffer());var a=-1,b=-1,c=null,d=this.color_textures,e=this.depth_texture;if(d&&d.length)for(var k=0;k<d.length;k++){var t=d[k];if(t.constructor!==g.Texture)throw"FBO can only bind instances of GL.Texture";
if(-1==a)a=t.width;else if(a!=t.width)throw"Cannot bind textures with different dimensions";if(-1==b)b=t.height;else if(b!=t.height)throw"Cannot bind textures with different dimensions";if(null==c)c=t.type;else if(c!=t.type)throw"Cannot bind textures to a FBO with different pixel formats";if(t.texture_type!=gl.TEXTURE_2D)throw"Cannot bind a Cubemap to a FBO";}else a=e.width,b=e.height;this.width=a;this.height=b;gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);var l=gl.extensions.WEBGL_draw_buffers;
if(1==gl.webgl_version&&!l&&d&&1<d.length)throw"Rendering to several textures not supported by your browser";c=1==gl.webgl_version?gl.FRAMEBUFFER:gl.DRAW_FRAMEBUFFER;gl.framebufferRenderbuffer(c,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,null);gl.framebufferRenderbuffer(c,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,null);if(e&&e.constructor===g.Texture){if(1==gl.webgl_version&&!gl.extensions.WEBGL_depth_texture)throw"Rendering to depth texture not supported by your browser";this.stencil&&e.format!==gl.DEPTH_STENCIL&&
console.warn("Stencil cannot be enabled if there is a depth texture with a DEPTH_STENCIL format");e.format==gl.DEPTH_STENCIL?gl.framebufferTexture2D(c,gl.DEPTH_STENCIL_ATTACHMENT,gl.TEXTURE_2D,e.handler,0):gl.framebufferTexture2D(c,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,e.handler,0)}else k=null,e&&e.constructor===WebGLRenderbuffer&&e.width==a&&e.height==b?k=this._depth_renderbuffer=e:(k=this._depth_renderbuffer=this._depth_renderbuffer||gl.createRenderbuffer(),k.width=a,k.height=b),gl.bindRenderbuffer(gl.RENDERBUFFER,
k),this.stencil?(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,a,b),gl.framebufferRenderbuffer(c,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,k)):(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,a,b),gl.framebufferRenderbuffer(c,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,k));if(d&&d.length)for(this.order=[],k=0;k<d.length;k++)t=d[k],gl.framebufferTexture2D(c,gl.COLOR_ATTACHMENT0+k,gl.TEXTURE_2D,t.handler,0),this.order.push(gl.COLOR_ATTACHMENT0+k);else e=this._color_renderbuffer=this._color_renderbuffer||
gl.createRenderbuffer(),e.width=a,e.height=b,gl.bindRenderbuffer(gl.RENDERBUFFER,e),gl.renderbufferStorage(gl.RENDERBUFFER,gl.RGBA4,a,b),gl.framebufferRenderbuffer(c,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,e);for(k=a=d?d.length:0;k<this._num_binded_textures;++k)gl.framebufferTexture2D(c,gl.COLOR_ATTACHMENT0+k,gl.TEXTURE_2D,null,0);this._num_binded_textures=a;this._stencil_enabled=this.stencil;d&&1<d.length&&(l?l.drawBuffersWEBGL(this.order):gl.drawBuffers(this.order));d=gl.checkFramebufferStatus(c);
if(d!==gl.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+d;gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);f||gl.bindFramebuffer(c,this._old_fbo_handler)};G.prototype.bind=function(f){if(!this.color_textures.length&&!this.depth_texture)throw"FBO: no textures attached to FBO";this._old_viewport.set(gl.viewport_data);this._old_fbo_handler=f?gl.getParameter(gl.FRAMEBUFFER_BINDING):null;this._old_fbo_handler!=this.handler&&gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);for(f=
0;f<this.color_textures.length;++f)this.color_textures[f]._in_current_fbo=!0;this.depth_texture&&(this.depth_texture._in_current_fbo=!0);gl.viewport(0,0,this.width,this.height)};G.prototype.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo_handler);this._old_fbo_handler=null;gl.setViewport(this._old_viewport);for(var f=0;f<this.color_textures.length;++f)this.color_textures[f]._in_current_fbo=!1;this.depth_texture&&(this.depth_texture._in_current_fbo=!1)};G.prototype.switchTo=function(f){f._old_fbo_handler=
this._old_fbo_handler;f._old_viewport.set(this._old_viewport);gl.bindFramebuffer(gl.FRAMEBUFFER,f.handler);this._old_fbo_handler=null;gl.viewport(0,0,this.width,this.height);for(var a=0;a<this.color_textures.length;++a)this.color_textures[a]._in_current_fbo=!1;this.depth_texture&&(this.depth_texture._in_current_fbo=!1);for(a=0;a<f.color_textures.length;++a)f.color_textures[a]._in_current_fbo=!0;f.depth_texture&&(f.depth_texture._in_current_fbo=!0)};G.prototype.delete=function(){gl.deleteFramebuffer(this.handler);
this.handler=null};n.Shader=g.Shader=function a(b,c,d){g.debug&&console.log("GL.Shader created");if(!b||!c)throw"GL.Shader source code parameter missing";this._context_id=n.gl.context_id;var e=this.gl=n.gl,k=a.expandMacros(d);d=b.constructor===String?a.injectCode(k,b,e):b;k=c.constructor===String?a.injectCode(k,c,e):c;this.program=e.createProgram();b=b.constructor===String?g.Shader.compileSource(e.VERTEX_SHADER,d):b;c=c.constructor===String?g.Shader.compileSource(e.FRAGMENT_SHADER,k):c;e.attachShader(this.program,
b,e);e.attachShader(this.program,c,e);e.linkProgram(this.program);if(!e.getProgramParameter(this.program,e.LINK_STATUS))throw"link error: "+e.getProgramInfoLog(this.program);this.vs_shader=b;this.fs_shader=c;this.attributes={};this.uniformInfo={};this.samplers={};this.extractShaderInfo()};Shader.expandMacros=function(a){var b="";if(a)for(var c in a)b+="#define "+c+" "+(a[c]?a[c]:"")+"\n";return b};Shader.injectCode=function(a,b,c){var d=b.indexOf("\n");c=c?"#define WEBGL"+c.webgl_version+"\n":"";
var e=b.substr(0,d).trim();return-1==e.indexOf("#version")?c+a+b:e+"\n"+c+a+b.substr(d)};Shader.compileSource=function(a,b,c,d){c=c||n.gl;d=d||c.createShader(a);c.shaderSource(d,b);c.compileShader(d);if(!c.getShaderParameter(d,c.COMPILE_STATUS))throw(a==c.VERTEX_SHADER?"Vertex":"Fragment")+" shader compile error: "+c.getShaderInfoLog(d);return d};Shader.parseError=function(a,b,c){if(!a)return null;var d=a.split(" "),e=d[5].split(":");return{type:d[0],line_number:parseInt(e[1]),line_pos:parseInt(e[0]),
line_code:("Fragment"==d[0]?c:b).split("\n")[parseInt(e[1])],err:a}};Shader.prototype.updateShader=function(a,b,c){var d=this.gl||n.gl,e=Shader.expandMacros(c);this.program&&(this.program=d.createProgram());e=Shader.expandMacros(c);c=a.constructor===String?Shader.injectCode(e,a,d):a;e=b.constructor===String?Shader.injectCode(e,b,d):b;a=a.constructor===String?g.Shader.compileSource(d.VERTEX_SHADER,c):a;b=b.constructor===String?g.Shader.compileSource(d.FRAGMENT_SHADER,e):b;d.attachShader(this.program,
a,d);d.attachShader(this.program,b,d);d.linkProgram(this.program);if(!d.getProgramParameter(this.program,d.LINK_STATUS))throw"link error: "+d.getProgramInfoLog(this.program);this.vs_shader=a;this.fs_shader=b;this.attributes={};this.uniformInfo={};this.samplers={};this.extractShaderInfo()};Shader.prototype.extractShaderInfo=function(){for(var a=this.gl,b=a.getProgramParameter(this.program,a.ACTIVE_UNIFORMS),c=0;c<b;++c){var d=a.getActiveUniform(this.program,c);if(!d)break;var e=d.name,k=e.indexOf("[");
-1!=k&&-1==e.indexOf("].")&&(e=e.substr(0,k));if(d.type==a.SAMPLER_2D||d.type==a.SAMPLER_CUBE)this.samplers[e]=d.type;var k=Shader.getUniformFunc(d),t=!1;if(d.type==a.FLOAT_MAT2||d.type==a.FLOAT_MAT3||d.type==a.FLOAT_MAT4)t=!0;var l=g.TYPE_LENGTH[d.type]||1;this.uniformInfo[e]={type:d.type,func:k,size:d.size,type_length:l,is_matrix:t,loc:a.getUniformLocation(this.program,e),data:new Float32Array(l*d.size)}}c=0;for(b=a.getProgramParameter(this.program,a.ACTIVE_ATTRIBUTES);c<b;++c){d=a.getActiveAttrib(this.program,
c);if(!d)break;k=Shader.getUniformFunc(d);l=g.TYPE_LENGTH[d.type]||1;this.uniformInfo[d.name]={type:d.type,func:k,type_length:l,size:d.size,loc:null};this.attributes[d.name]=a.getAttribLocation(this.program,d.name)}};Shader.prototype.hasUniform=function(a){return this.uniformInfo[a]};Shader.prototype.hasAttribute=function(a){return this.attributes[a]};Shader.getUniformFunc=function(a){var b=null;switch(a.type){case g.FLOAT:b=1==a.size?gl.uniform1f:gl.uniform1fv;break;case g.FLOAT_MAT2:b=gl.uniformMatrix2fv;
break;case g.FLOAT_MAT3:b=gl.uniformMatrix3fv;break;case g.FLOAT_MAT4:b=gl.uniformMatrix4fv;break;case g.FLOAT_VEC2:b=gl.uniform2fv;break;case g.FLOAT_VEC3:b=gl.uniform3fv;break;case g.FLOAT_VEC4:b=gl.uniform4fv;break;case g.UNSIGNED_INT:case g.INT:b=1==a.size?gl.uniform1i:gl.uniform1iv;break;case g.INT_VEC2:b=gl.uniform2iv;break;case g.INT_VEC3:b=gl.uniform3iv;break;case g.INT_VEC4:b=gl.uniform4iv;break;case g.SAMPLER_2D:case g.SAMPLER_3D:case g.SAMPLER_CUBE:b=gl.uniform1i;break;default:b=gl.uniform1f}return b};
Shader.fromURL=function(a,b,c){function d(){var a=new g.Shader(k,t),b;for(b in a)e[b]=a[b];e.ready=!0}var e=new g.Shader("\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t","\n\t\t\tprecision highp float;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t");e.ready=!1;var k=null,t=null;HttpRequest(a,null,function(a){k=a;t&&d()});HttpRequest(b,
null,function(a){t=a;k&&d()});return e};Shader.prototype.bind=function(){var a=this.gl;a.useProgram(this.program);a._current_shader=this};Shader.prototype.getLocation=function(a){return this.uniformInfo[a]?this.uniformInfo[a].loc:null};Shader._temp_uniform=new Float32Array(16);Shader.prototype.uniforms=function(a){var b=this.gl;b.useProgram(this.program);b._current_shader=this;for(var c in a)this.uniformInfo[c]&&this._setUniform(c,a[c]);return this};Shader.prototype.uniformsArray=function(a){var b=
this.gl;b.useProgram(this.program);b._current_shader=this;for(var b=0,c=a.length;b<c;++b){var d=a[b],e;for(e in d)this._setUniform(e,d[e])}return this};Shader.prototype.setUniform=function(){return function(a,b){this.gl._current_shader!=this&&this.bind();var c=this.uniformInfo[a];c&&null!==c.loc&&null!=b&&(b.constructor===Array&&(c.data.set(b),b=c.data),c.is_matrix?c.func.call(this.gl,c.loc,!1,b):c.func.call(this.gl,c.loc,b))}}();Shader.prototype._setUniform=function(){return function(a,b){var c=
this.uniformInfo[a];c&&null!==c.loc&&null!=b&&(b.constructor===Array&&(c.data.set(b),b=c.data),c.is_matrix?c.func.call(this.gl,c.loc,!1,b):c.func.call(this.gl,c.loc,b))}}();Shader.prototype.draw=function(a,b,c){c=void 0===c?b==gl.LINES?"lines":"triangles":c;this.drawBuffers(a.vertexBuffers,c?a.indexBuffers[c]:null,2>arguments.length?gl.TRIANGLES:b)};Shader.prototype.drawRange=function(a,b,c,d,e){e=void 0===e?b==gl.LINES?"lines":"triangles":e;this.drawBuffers(a.vertexBuffers,e?a.indexBuffers[e]:null,
b,c,d)};var I=new Uint8Array(16),T=new Uint8Array(16);Shader.prototype.drawBuffers=function(a,b,c,d,e){if(0!=e){var k=this.gl;k.useProgram(this.program);var g=0;I.set(T);for(var l in a){var m=a[l],p=m.attribute||l,q=this.attributes[p];null!=q&&m.buffer&&(I[q]=1,k.bindBuffer(k.ARRAY_BUFFER,m.buffer),k.enableVertexAttribArray(q),k.vertexAttribPointer(q,m.buffer.spacing,m.buffer.gl_type,!1,0,0),g=m.buffer.length/m.buffer.spacing)}a=0;0<d&&(a=d);b&&(g=b.buffer.length-a);0<e&&e<g&&(g=e);a*=b&&b.data?b.data.constructor.BYTES_PER_ELEMENT:
1;for(p in this.attributes)q=this.attributes[p],I[q]||k.disableVertexAttribArray(this.attributes[p]);!g||b&&!b.buffer||(b?(k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,b.buffer),k.drawElements(c,g,b.buffer.gl_type,a),k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,null)):k.drawArrays(c,a,g));return this}};Shader._instancing_arrays=[];Shader.prototype.drawInstanced=function(a,b,c,d,e,k){if(0!=k){var g=this.gl;if(1==g.webgl_version&&!g.extensions.ANGLE_instanced_arrays)throw"instancing not supported";g.useProgram(this.program);
var l=0;I.set(T);var m=a.vertexBuffers,p;for(p in m){var q=m[p],r=q.attribute||p,n=this.attributes[r];null!=n&&q.buffer&&(I[n]=1,g.bindBuffer(g.ARRAY_BUFFER,q.buffer),g.enableVertexAttribArray(n),g.vertexAttribPointer(n,q.buffer.spacing,q.buffer.gl_type,!1,0,0),l=q.buffer.length/q.buffer.spacing)}a=c?a.getIndexBuffer(c):null;c=0;0<e&&(c=e);a&&(l=a.buffer.length-c);0<k&&k<l&&(l=k);c*=a&&a.data?a.data.constructor.BYTES_PER_ELEMENT:1;for(r in this.attributes)n=this.attributes[r],I[n]||g.disableVertexAttribArray(this.attributes[r]);
e=g.extensions.ANGLE_instanced_arrays;k=n=0;for(var w in d){p=d[w];n=p.length;r=this.attributes[w];if(null==r)return;var s=m=0;p.constructor===Array?(m=p[0].constructor===Number?1:p[0].length,s=m*p.length):(m=this.uniformInfo[w].type_length,s=p.length,n=s/m);q=Shader._instancing_arrays[k];if(!q||q.data.length<s)q=Shader._instancing_arrays[k]={data:new Float32Array(s),buffer:g.createBuffer()};q.uniform=w;q.element_size=m;if(p.constructor===Array)for(s=0;s<p.length;++s)q.data.set(p[s],s*m);else q.data.set(p);
g.bindBuffer(g.ARRAY_BUFFER,q.buffer);g.bufferData(g.ARRAY_BUFFER,q.data,g.STREAM_DRAW);if(16==m)for(m=0;4>m;++m)g.enableVertexAttribArray(r+m),g.vertexAttribPointer(r+m,4,g.FLOAT,!1,64,16*m),e?e.vertexAttribDivisorANGLE(r+m,1):g.vertexAttribDivisor(r+m,1);else g.enableVertexAttribArray(r),g.vertexAttribPointer(r,m,g.FLOAT,!1,4*m,4*m),e?e.vertexAttribDivisorANGLE(r,1):g.vertexAttribDivisor(r,1);k+=1}e?a?(g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,a.buffer),e.drawElementsInstancedANGLE(b,l,a.buffer.gl_type,
c,n),g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,null)):e.drawArraysInstancedANGLE(b,c,l,n):a?(g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,a.buffer),g.drawElementsInstanced(b,l,a.buffer.gl_type,c,n),g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,null)):g.drawArraysInstanced(b,c,l,n);for(b=0;b<k;++b)if(d=Shader._instancing_arrays[b],r=this.attributes[d.uniform],m=d.element_size,16==m)for(m=0;4>m;++m)g.disableVertexAttribArray(r+m),e?e.vertexAttribDivisorANGLE(r+m,0):g.vertexAttribDivisor(r+m,0);else g.enableVertexAttribArray(r),
e?e.vertexAttribDivisorANGLE(r,0):g.vertexAttribDivisor(r,0);return this}};Shader.expandImports=function(a,b){b=b||Shader.files;var c={};if(!b)throw"Shader.files not initialized, assign files there";return a.replace(/#import\s+\"([a-zA-Z0-9_\.]+)\"\s*\n/g,function(a){a=a.split('"')[1];if(c[a])return"//already imported: "+a+"\n";var e=b[a];c[a]=!0;return e?e+"\n":"//import code not found: "+a+"\n"})};Shader.dumpErrorToConsole=function(a,b,c){console.error(a);var d=null,d=-1!=a.indexOf("Fragment")?
c:b;a=d.split("\n");for(var e in a)a[e]=e+"| "+a[e];console.groupCollapsed("Shader code");console.log(a.join("\n"));console.groupEnd()};Shader.convertTo100=function(a,b){};Shader.convertTo300=function(a,b){};Shader.validateValue=function(a,b){if(null===a||void 0===a)return!1;switch(b.type){case g.INT:case g.FLOAT:case g.SAMPLER_2D:case g.SAMPLER_CUBE:return isNumber(a);case g.INT_VEC2:case g.FLOAT_VEC2:return 2===a.length;case g.INT_VEC3:case g.FLOAT_VEC3:return 3===a.length;case g.INT_VEC4:case g.FLOAT_VEC4:case g.FLOAT_MAT2:return 4===
a.length;case g.FLOAT_MAT3:return 8===a.length;case g.FLOAT_MAT4:return 16===a.length}return!0};Shader.DEFAULT_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec3 a_normal;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec3 v_position;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform mat4 u_model;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() {\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\t\t\tv_coord = a_coord;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\n\t\t\t";
Shader.SCREEN_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() { \n\t\t\t\tv_coord = a_coord; \n\t\t\t\tgl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0); \n\t\t\t}\n\t\t\t";Shader.SCREEN_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";
Shader.SCREEN_FRAGMENT_FX="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\t#ifdef FX_UNIFORMS\n\t\t\t\tFX_UNIFORMS\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord;\n\t\t\t\tvec4 color = texture2D(u_texture, uv);\n\t\t\t\t#ifdef FX_CODE\n\t\t\t\t\tFX_CODE ;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t\t";Shader.SCREEN_COLORED_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";
Shader.BLEND_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_texture2;\n\t\t\tuniform float u_factor;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = mix( texture2D(u_texture, v_coord), texture2D(u_texture2, v_coord), u_factor);\n\t\t\t}\n\t\t\t";Shader.SCREEN_FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t";
Shader.QUAD_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_position;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);\n\t\t\t\tv_coord = a_coord; \n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";
Shader.QUAD_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.QUAD2_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform vec4 u_texture_area;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t    vec2 uv = vec2( mix(u_texture_area.x, u_texture_area.z, v_coord.x), 1.0 - mix(u_texture_area.w, u_texture_area.y, v_coord.y) );\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, uv);\n\t\t\t}\n\t\t\t";
Shader.PRIMITIVE2D_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = a_vertex;\n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";Shader.FLAT_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t\t";
Shader.FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t";Shader.createFX=function(a,b,c){a=g.Shader.removeComments(a,!0);a={FX_CODE:a,FX_UNIFORMS:b||""};if(!c)return new g.Shader(g.Shader.SCREEN_VERTEX_SHADER,g.Shader.SCREEN_FRAGMENT_FX,a);c.updateShader(g.Shader.SCREEN_VERTEX_SHADER,g.Shader.SCREEN_FRAGMENT_FX,a);return c};Shader.removeComments=function(a,b){if(!a)return"";a=a.replace(/(\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/)|(\/\/.*)/g,
"");for(var c=a.split("\n"),d=[],e=0;e<c.length;++e){var k=c[e],g=k.indexOf("//");-1!=g&&(k=c[e].substr(0,g));k=k.trim();k.length&&d.push(k)}return d.join(b?"":"\n")};Shader.prototype.toViewport=function(a){var b=g.Mesh.getScreenQuad();a&&this.uniforms(a);this.draw(b)};Shader.getScreenShader=function(a){a=a||n.gl;var b=a.shaders[":screen"];if(b)return b;b=a.shaders[":screen"]=new g.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_FRAGMENT_SHADER);return b.uniforms({u_texture:0})};Shader.getColoredScreenShader=
function(a){a=a||n.gl;var b=a.shaders[":colored_screen"];if(b)return b;b=a.shaders[":colored_screen"]=new g.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_COLORED_FRAGMENT_SHADER);return b.uniforms({u_texture:0,u_color:vec4.fromValues(1,1,1,1)})};Shader.getQuadShader=function(a){a=a||n.gl;var b=a.shaders[":quad"];return b?b:a.shaders[":quad"]=new g.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD_FRAGMENT_SHADER)};Shader.getPartialQuadShader=function(a){a=a||n.gl;var b=a.shaders[":quad2"];return b?
b:a.shaders[":quad2"]=new g.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD2_FRAGMENT_SHADER)};Shader.getBlendShader=function(a){a=a||n.gl;var b=a.shaders[":blend"];return b?b:a.shaders[":blend"]=new g.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.BLEND_FRAGMENT_SHADER)};Shader.getBlurShader=function(a){a=a||n.gl;var b=a.shaders[":blur"];if(b)return b;b=new g.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t   vec4 sum = vec4(0.0);\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -1.0) * 0.15/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord) * 0.16/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 1.0) * 0.15/0.98;\n\t\t\t   gl_FragColor = u_intensity * sum;\n\t\t\t}\n\t\t\t");
return a.shaders[":blur"]=b};Shader.getCopyDepthShader=function(a){a=a||n.gl;var b=a.shaders[":copy_depth"];if(b)return b;b=new g.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\t#extension GL_EXT_frag_depth : enable\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvoid main() {\n\t\t\t   gl_FragDepthEXT = texture2D( u_texture, v_coord ).x;\n\t\t\t   gl_FragColor = vec4(1.0);\n\t\t\t}\n\t\t\t");return a.shaders[":copy_depth"]=b};Shader.getCubemapShowShader=
function(a){a=a||n.gl;var b=a.shaders[":show_cubemap"];if(b)return b;b=new g.Shader(Shader.DEFAULT_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec3 v_normal;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = textureCube( u_texture, v_normal );\n\t\t\t}\n\t\t\t");b.uniforms({u_texture:0});return a.shaders[":show_cubemap"]=b};Shader.getCubemapCopyShader=function(a){a=a||n.gl;var b=a.shaders[":copy_cubemap"];if(b)return b;b=new g.Shader(Shader.SCREEN_VERTEX_SHADER,
"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tuniform mat3 u_rotation;\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = vec2( v_coord.x, 1.0 - v_coord.y );\n\t\t\t\tvec3 dir = vec3( uv - vec2(0.5), 0.5 );\n\t\t\t\tdir = u_rotation * dir;\n\t\t\t   gl_FragColor = textureCube( u_texture, dir );\n\t\t\t}\n\t\t\t");return a.shaders[":copy_cubemap"]=b};Shader.getCubemapBlurShader=function(a){a=a||n.gl;var b=a.shaders[":blur_cubemap"];if(b)return b;b=new g.Shader(Shader.SCREEN_VERTEX_SHADER,
"\n\t\t\t#ifndef NUM_SAMPLES\n\t\t\t\t#define NUM_SAMPLES 4\n\t\t\t#endif\n\t\t\t\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tuniform mat3 u_rotation;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t\tvec4 sum = vec4(0.0);\n\t\t\t\tvec2 uv = vec2( v_coord.x, 1.0 - v_coord.y ) - vec2(0.5);\n\t\t\t\tvec3 dir = vec3(0.0);\n\t\t\t\tvec4 color = vec4(0.0);\n\t\t\t\tfor( int x = -2; x <= 2; x++ )\n\t\t\t\t{\n\t\t\t\t\tfor( int y = -2; y <= 2; y++ )\n\t\t\t\t\t{\n\t\t\t\t\t\tdir.xy = uv + vec2( u_offset.x * float(x), u_offset.y * float(y)) * 0.5;\n\t\t\t\t\t\tdir.z = 0.5;\n\t\t\t\t\t\tdir = u_rotation * dir;\n\t\t\t\t\t\tcolor = textureCube( u_texture, dir );\n\t\t\t\t\t\tcolor.xyz = color.xyz * color.xyz;/*linearize*/\n\t\t\t\t\t\tsum += color;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tsum /= 25.0;\n\t\t\t   gl_FragColor = vec4( sqrt( sum.xyz ), sum.w ) ;\n\t\t\t}\n\t\t\t");
return a.shaders[":blur_cubemap"]=b};Shader.FXAA_FUNC="\n\tuniform vec2 u_viewportSize;\n\tuniform vec2 u_iViewportSize;\n\t#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n\t#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n\t#define FXAA_SPAN_MAX     8.0\n\t\n\t/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */\n\tvec4 applyFXAA(sampler2D tex, vec2 fragCoord)\n\t{\n\t\tvec4 color = vec4(0.0);\n\t\t/*vec2 u_iViewportSize = vec2(1.0 / u_viewportSize.x, 1.0 / u_viewportSize.y);*/\n\t\tvec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbM  = texture2D(tex, fragCoord  * u_iViewportSize).xyz;\n\t\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\t\tfloat lumaNW = dot(rgbNW, luma);\n\t\tfloat lumaNE = dot(rgbNE, luma);\n\t\tfloat lumaSW = dot(rgbSW, luma);\n\t\tfloat lumaSE = dot(rgbSE, luma);\n\t\tfloat lumaM  = dot(rgbM,  luma);\n\t\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\t\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\t\t\n\t\tvec2 dir;\n\t\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\t\tdir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\t\t\n\t\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\t\t\n\t\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\t\tdir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * u_iViewportSize;\n\t\t\n\t\tvec3 rgbA = 0.5 * (texture2D(tex, fragCoord * u_iViewportSize + dir * (1.0 / 3.0 - 0.5)).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * (2.0 / 3.0 - 0.5)).xyz);\n\t\tvec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * u_iViewportSize + dir * -0.5).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * 0.5).xyz);\n\t\t\n\t\treturn vec4(rgbA,1.0);\n\t\tfloat lumaB = dot(rgbB, luma);\n\t\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\t\t\tcolor = vec4(rgbA, 1.0);\n\t\telse\n\t\t\tcolor = vec4(rgbB, 1.0);\n\t\treturn color;\n\t}\n";
Shader.getFXAAShader=function(a){a=a||n.gl;var b=a.shaders[":fxaa"];if(b)return b;var b=new g.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\t"+Shader.FXAA_FUNC+"\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = applyFXAA( u_texture, v_coord * u_viewportSize) ;\n\t\t\t}\n\t\t\t"),c=vec2.fromValues(a.viewport_data[2],a.viewport_data[3]),d=vec2.fromValues(1/a.viewport_data[2],1/a.viewport_data[3]);b.setup=
function(){c[0]=a.viewport_data[2];c[1]=a.viewport_data[3];d[0]=1/a.viewport_data[2];d[1]=1/a.viewport_data[3];this.uniforms({u_viewportSize:c,u_iViewportSize:d})};return a.shaders[":fxaa"]=b};Shader.getFlatShader=function(a){a=a||n.gl;var b=a.shaders[":flat"];if(b)return b;b=new g.Shader(Shader.FLAT_VERTEX_SHADER,Shader.FLAT_FRAGMENT_SHADER);b.uniforms({u_color:[1,1,1,1]});return a.shaders[":flat"]=b};g.create=function(a){function b(a){var c=l.mouse.buttons;g.augmentEvent(a,e);a.eventType=a.eventType||
a.type;var d=getTime();q.dragging=a.dragging;q.position[0]=a.canvasx;q.position[1]=a.canvasy;q.x=a.canvasx;q.y=a.canvasy;q.clientx=a.mousex;q.clienty=a.mousey;q.left_button=!!(q.buttons&1<<g.LEFT_MOUSE_BUTTON);q.middle_button=!!(q.buttons&1<<g.MIDDLE_MOUSE_BUTTON);q.right_button=!!(q.buttons&1<<g.RIGHT_MOUSE_BUTTON);if("mousedown"==a.eventType){0==c&&(e.removeEventListener("mousemove",b),c=e.ownerDocument,c.addEventListener("mousemove",b),c.addEventListener("mouseup",b));p=d;if(l.onmousedown)l.onmousedown(a);
v.trigger(l,"mousedown")}else if("mousemove"==a.eventType){if(l.onmousemove)l.onmousemove(a);v.trigger(l,"mousemove",a)}else if("mouseup"==a.eventType){0==l.mouse.buttons&&(e.addEventListener("mousemove",b),c=e.ownerDocument,c.removeEventListener("mousemove",b),c.removeEventListener("mouseup",b));a.click_time=d-p;if(l.onmouseup)l.onmouseup(a);v.trigger(l,"mouseup",a)}else if("mousewheel"==a.eventType||"wheel"==a.eventType||"DOMMouseScroll"==a.eventType){a.eventType="mousewheel";a.wheel="wheel"==a.type?
-a.deltaY:null!=a.wheelDeltaY?a.wheelDeltaY:-60*a.detail;a.delta=void 0!==a.wheelDelta?a.wheelDelta/40:a.deltaY?-a.deltaY/3:0;if(l.onmousewheel)l.onmousewheel(a);v.trigger(l,"mousewheel",a)}if(l.onmouse)l.onmouse(a);"mousemove"!=a.eventType&&a.stopPropagation();a.preventDefault();return!1}function c(a){var b=a.changedTouches,c=b[0],d="";if(!(l.ontouch&&!0===l.ontouch(a)||!0===v.trigger(l,a.type,a)||!r||a.touches.length&&a.changedTouches[0].identifier!==a.touches[0].identifier||1<b)){switch(a.type){case "touchstart":d=
"mousedown";break;case "touchmove":d="mousemove";break;case "touchend":d="mouseup";break;default:return}b=document.createEvent("MouseEvent");b.initMouseEvent(d,!0,!0,window,1,c.screenX,c.screenY,c.clientX,c.clientY,!1,!1,!1,!1,0,null);b.originalEvent=b;b.is_touch=!0;c.target.dispatchEvent(b);a.preventDefault()}}function d(a){a.eventType=a.type;l.ongesture&&!1===l.ongesture(a)||!1!==v.trigger(l,a.type,a)&&a.preventDefault()}a=a||{};var e=null;if(a.canvas)if("string"==typeof a.canvas){if(e=document.getElementById(a.canvas),
!e)throw"Canvas element not found: "+a.canvas;}else e=a.canvas;else{var k=null;a.container&&(k=a.container.constructor===String?document.querySelector(a.container):a.container);if(k&&!a.width){var t=k.getBoundingClientRect();a.width=t.width;a.height=t.height}e=createCanvas(a.width||800,a.height||600);k&&k.appendChild(e)}"alpha"in a||(a.alpha=!1);var l=null,k=null;2==a.version?k=["webgl2","experimental-webgl2"]:1==a.version||void 0===a.version?k=["webgl","experimental-webgl"]:0===a.version&&(k=["webgl2",
"experimental-webgl2","webgl","experimental-webgl"]);if(!k)throw"Incorrect WebGL version, must be 1 or 2";a={alpha:void 0===a.alpha?!0:a.alpha,depth:void 0===a.depth?!0:a.depth,stencil:void 0===a.stencil?!0:a.stencil,antialias:void 0===a.antialias?!0:a.antialias,premultipliedAlpha:void 0===a.premultipliedAlpha?!0:a.premultipliedAlpha,preserveDrawingBuffer:void 0===a.preserveDrawingBuffer?!0:a.preserveDrawingBuffer};for(t=0;t<k.length;++t){try{l=e.getContext(k[t],a)}catch(m){}if(l)break}if(!l){if(e.getContext("webgl"))throw"WebGL supported but not with those parameters";
throw"WebGL not supported";}l.webgl_version="WebGL2RenderingContext"===l.constructor.name?2:1;n.gl=l;e.is_webgl=!0;e.gl=l;l.context_id=this.last_context_id++;l.extensions={};l.extensions.OES_standard_derivatives=l.derivatives_supported=l.getExtension("OES_standard_derivatives")||!1;l.extensions.WEBGL_depth_texture=l.getExtension("WEBGL_depth_texture")||l.getExtension("WEBKIT_WEBGL_depth_texture")||l.getExtension("MOZ_WEBGL_depth_texture");l.extensions.OES_element_index_uint=l.getExtension("OES_element_index_uint");
l.extensions.WEBGL_draw_buffers=l.getExtension("WEBGL_draw_buffers");l.extensions.EXT_shader_texture_lod=l.getExtension("EXT_shader_texture_lod");l.extensions.EXT_sRGB=l.getExtension("EXT_sRGB");l.extensions.EXT_texture_filter_anisotropic=l.getExtension("EXT_texture_filter_anisotropic")||l.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||l.getExtension("MOZ_EXT_texture_filter_anisotropic");l.extensions.EXT_frag_depth=l.getExtension("EXT_frag_depth")||l.getExtension("WEBKIT_EXT_frag_depth")||
l.getExtension("MOZ_EXT_frag_depth");l.extensions.WEBGL_lose_context=l.getExtension("WEBGL_lose_context")||l.getExtension("WEBKIT_WEBGL_lose_context")||l.getExtension("MOZ_WEBGL_lose_context");l.extensions.ANGLE_instanced_arrays=l.getExtension("ANGLE_instanced_arrays");l.extensions.OES_texture_float_linear=l.getExtension("OES_texture_float_linear");l.extensions.OES_texture_float_linear&&(l.extensions.OES_texture_float=l.getExtension("OES_texture_float"));l.extensions.EXT_color_buffer_float=l.getExtension("EXT_color_buffer_float");
l.extensions.OES_texture_half_float_linear=l.getExtension("OES_texture_half_float_linear");l.extensions.OES_texture_half_float_linear&&(l.extensions.OES_texture_half_float=l.getExtension("OES_texture_half_float"));l.HIGH_PRECISION_FORMAT=1==l.webgl_version?l.extensions.OES_texture_half_float?g.HALF_FLOAT_OES:l.extensions.OES_texture_float?g.FLOAT:g.UNSIGNED_BYTE:g.HALF_FLOAT_OES;l.max_texture_units=l.getParameter(l.MAX_TEXTURE_IMAGE_UNITS);l._viewport_func?console.warn("Creating LiteGL context over the same canvas twice"):
(l._viewport_func=l.viewport,l.viewport_data=new Float32Array([0,0,l.canvas.width,l.canvas.height]),l.viewport=function(a,b,c,d){var e=this.viewport_data;e[0]=a|0;e[1]=b|0;e[2]=c|0;e[3]=d|0;this._viewport_func(a,b,c,d)},l.getViewport=function(a){return a?(a[0]=l.viewport_data[0],a[1]=l.viewport_data[1],a[2]=l.viewport_data[2],a[3]=l.viewport_data[3],a):new Float32Array(l.viewport_data)},l.setViewport=function(a,b){l.viewport_data.set(a);b&&(l.viewport_data[1]=this.drawingBufferHeight-a[1]-a[3]);this._viewport_func(a[0],
l.viewport_data[1],a[2],a[3])});if("undefined"==typeof glMatrix)throw"glMatrix not found, LiteGL requires glMatrix to be included";var p=0;l.shaders={};l.textures={};l.meshes={};l.makeCurrent=function(){n.gl=this};l.execute=function(a){var b=n.gl;n.gl=this;a();n.gl=b};l.animate=function(a){function b(){if(!l.destroyed){e._requestFrame_id=c(b);var a=getTime(),k=0.001*(a-d);if(e.onupdate)e.onupdate(k);v.trigger(l,"update",k);e.ondraw&&(k=n.gl,n.gl=e,e.ondraw(),v.trigger(l,"draw"),n.gl=k);d=a}}if(!1===
a)n.cancelAnimationFrame(this._requestFrame_id),this._requestFrame_id=null;else{var c=n.requestAnimationFrame,d=getTime(),e=this;this._requestFrame_id=c(b)}};l.destroy=function(){u&&(document.removeEventListener("keydown",u),document.removeEventListener("keyup",u));this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);this.destroyed=!0;n.gl==this&&(n.gl=null)};var q=l.mouse={buttons:0,left_button:!1,middle_button:!1,right_button:!1,position:new Float32Array(2),x:0,y:0,deltax:0,deltay:0,
clientx:0,clienty:0,isInsideRect:function(a,b,c,d,e){var k=this.y;e&&(k=l.canvas.height-k);return this.x>a&&this.x<a+c&&k>b&&k<b+d?!0:!1},isButtonPressed:function(a){return this.buttons&1<<g.RIGHT_MOUSE_BUTTON}};l.captureMouse=function(a,c){e.addEventListener("mousedown",b);e.addEventListener("mousemove",b);a&&(e.addEventListener("mousewheel",b,!1),e.addEventListener("wheel",b,!1));e.addEventListener("contextmenu",function(a){a.preventDefault();return!1});c&&this.captureTouch(!0)};var r=!1;l.captureTouch=
function(a){r=a;e.addEventListener("touchstart",c,!0);e.addEventListener("touchmove",c,!0);e.addEventListener("touchend",c,!0);e.addEventListener("touchcancel",c,!0);e.addEventListener("gesturestart",d);e.addEventListener("gesturechange",d);e.addEventListener("gestureend",d)};l.keys={};var u=null;l.captureKeys=function(a,b){function c(b){var d=a;b.eventType=b.type;var e=b.target.nodeName.toLowerCase();if("input"!==e&&"textarea"!==e&&"select"!==e){b.character=String.fromCharCode(b.keyCode).toLowerCase();
var e=!1,k=g.mapKeyCode(b.keyCode);k||(k=b.character);b.altKey||b.ctrlKey||b.metaKey||(k&&(l.keys[k]="keydown"==b.type),e=l.keys[b.keyCode],l.keys[b.keyCode]="keydown"==b.type);if(e!=l.keys[b.keyCode]){if("keydown"==b.type&&l.onkeydown)l.onkeydown(b);else if("keyup"==b.type&&l.onkeyup)l.onkeyup(b);v.trigger(l,b.type,b)}if(l.onkey)l.onkey(b);d&&(b.isChar||g.blockable_keys[b.keyIdentifier||b.key])&&b.preventDefault()}}u||(l.keys={},document.addEventListener("keydown",c),document.addEventListener("keyup",
c),u=c)};l.gamepads=null;l.captureGamepads=function(){var a=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;a&&(this.gamepads=a.call(navigator))};l.getGamepads=function(a){var b=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(b){b=b.call(navigator);this.gamepads||(this.gamepads=[]);for(var c=0;4>c;c++){var d=b[c];if(d&&!a){var e=d,k={axes:[],buttons:{},hat:""};k.axes.lx=e.axes[0];k.axes.ly=e.axes[1];k.axes.rx=e.axes[2];k.axes.ry=e.axes[3];
k.axes.triggers=e.axes[4];for(var g=0;g<e.buttons.length;g++)switch(g){case 0:k.buttons.a=e.buttons[g].pressed;break;case 1:k.buttons.b=e.buttons[g].pressed;break;case 2:k.buttons.x=e.buttons[g].pressed;break;case 3:k.buttons.y=e.buttons[g].pressed;break;case 4:k.buttons.lb=e.buttons[g].pressed;break;case 5:k.buttons.rb=e.buttons[g].pressed;break;case 6:k.buttons.lt=e.buttons[g].pressed;break;case 7:k.buttons.rt=e.buttons[g].pressed;break;case 8:k.buttons.back=e.buttons[g].pressed;break;case 9:k.buttons.start=
e.buttons[g].pressed;break;case 10:k.buttons.ls=e.buttons[g].pressed;break;case 11:k.buttons.rs=e.buttons[g].pressed;break;case 12:e.buttons[g].pressed&&(k.hat+="up");break;case 13:e.buttons[g].pressed&&(k.hat+="down");break;case 14:e.buttons[g].pressed&&(k.hat+="left");break;case 15:e.buttons[g].pressed&&(k.hat+="right");break;case 16:k.buttons.home=e.buttons[g].pressed}e.xbox=k}e=this.gamepads[c];if(!e&&d){k=new CustomEvent("gamepadconnected");k.eventType=k.type;k.gamepad=d;if(this.ongamepadconnected)this.ongamepadconnected(k);
v.trigger(l,"gamepadconnected",k)}else if(e&&!d){k=new CustomEvent("gamepaddisconnected");k.eventType=k.type;k.gamepad=e;if(this.ongamepaddisconnected)this.ongamepaddisconnected(k);v.trigger(l,"gamepaddisconnected",k)}if(d)for(g=0;g<d.buttons.length;++g){var m=d.buttons[g];if(m.pressed&&(!e||!e.buttons[g].pressed)){k=new CustomEvent("gamepadButtonDown");k.eventType=k.type;k.button=m;k.which=g;k.gamepad=d;if(l.onbuttondown)l.onbuttondown(k);v.trigger(l,"buttondown",k)}else if(!m.pressed&&e&&e.buttons[g].pressed){k=
new CustomEvent("gamepadButtonUp");k.eventType=k.type;k.button=m;k.which=g;k.gamepad=d;if(l.onbuttondown)l.onbuttondown(k);v.trigger(l,"buttonup",k)}}}return this.gamepads=b}};l.fullscreen=function(){var a=this.canvas;a.requestFullScreen?a.requestFullScreen():a.webkitRequestFullScreen?a.webkitRequestFullScreen():a.mozRequestFullScreen?a.mozRequestFullScreen():console.error("Fullscreen not supported")};l.snapshot=function(a,b,c,d,e){var k=createCanvas(c,d),g=k.getContext("2d"),m=g.getImageData(0,0,
k.width,k.height),t=new Uint8Array(c*d*4);l.readPixels(a,b,k.width,k.height,l.RGBA,l.UNSIGNED_BYTE,t);m.data.set(t);g.putImageData(m,0,0);if(e)return k;a=createCanvas(c,d);g=a.getContext("2d");g.translate(0,d);g.scale(1,-1);g.drawImage(k,0,0);return a};var w={};l.loadTexture=function(a,b,c){if(this.textures[a])return this.textures[a];if(w[a])return null;var d=new Image;d.url=a;d.onload=function(){var a=g.Texture.fromImage(this,b);a.img=this;l.textures[this.url]=a;delete w[this.url];c&&c(a)};d.src=
a;w[a]=!0;return null};l.drawTexture=function(){var a=mat3.create(),b=vec2.create(),c=vec2.create(),d=vec4.create(),e=vec4.fromValues(1,1,1,1),k=vec2.create(),g={u_texture:0,u_position:b,u_color:e,u_size:c,u_texture_area:d,u_viewport:k,u_transform:a};return function(a,e,m,t,p,q,r,n,s,u,w){b[0]=e;b[1]=m;void 0===t&&(t=a.width);void 0===p&&(p=a.height);c[0]=t;c[1]=p;void 0===q&&(q=0);void 0===r&&(r=0);void 0===n&&(n=a.width);void 0===s&&(s=a.height);d[0]=q/a.width;d[1]=r/a.height;d[2]=(q+n)/a.width;
d[3]=(r+s)/a.height;k[0]=this.viewport_data[2];k[1]=this.viewport_data[3];u=u||Shader.getPartialQuadShader(this);e=Mesh.getScreenQuad(this);a.bind(0);u.uniforms(g);w&&u.uniforms(w);u.draw(e,l.TRIANGLES)}}();l.canvas.addEventListener("webglcontextlost",function(a){a.preventDefault();l.context_lost=!0;if(l.onlosecontext)l.onlosecontext(a)},!1);l.reset=function(){l.viewport(0,0,this.canvas.width,this.canvas.height);l.disable(l.BLEND);l.disable(l.CULL_FACE);l.disable(l.DEPTH_TEST);l.frontFace(l.CCW);
l._current_texture_drawto=null;l._current_fbo_color=null;l._current_fbo_depth=null};l.dump=function(){console.log("userAgent: ",navigator.userAgent);console.log("Supported extensions:");var a=l.getSupportedExtensions();console.log(a.join(","));a="VENDOR VERSION MAX_VERTEX_ATTRIBS MAX_VARYING_VECTORS MAX_VERTEX_UNIFORM_VECTORS MAX_VERTEX_TEXTURE_IMAGE_UNITS MAX_FRAGMENT_UNIFORM_VECTORS MAX_TEXTURE_SIZE MAX_TEXTURE_IMAGE_UNITS".split(" ");console.log("WebGL info:");for(var b in a)console.log(" * "+
a[b]+": "+l.getParameter(l[a[b]]));console.log("*************************************************")};l.reset();return l};g.mapKeyCode=function(a){return{8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",17:"CTRL",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"}[a]||(65<=a&&90>=a?String.fromCharCode(a):null)};g.dragging=!1;g.last_pos=[0,0];g.augmentEvent=function(a,b){var c=null;b=b||a.target||gl.canvas;c=b.getBoundingClientRect();a.mousex=a.clientX-c.left;a.mousey=a.clientY-c.top;a.canvasx=
a.mousex;a.canvasy=c.height-a.mousey;a.deltax=0;a.deltay=0;"mousedown"==a.type?(this.dragging=!0,gl.mouse.buttons|=1<<a.which):"mousemove"!=a.type&&"mouseup"==a.type&&(gl.mouse.buttons&=~(1<<a.which),0==gl.mouse.buttons&&(this.dragging=!1));void 0===a.movementX||g.isMobile()?(a.deltax=a.mousex-this.last_pos[0],a.deltay=a.mousey-this.last_pos[1]):(a.deltax=a.movementX,a.deltay=a.movementY);this.last_pos[0]=a.mousex;this.last_pos[1]=a.mousey;a.dragging=this.dragging;a.buttons_mask=gl.mouse.buttons;
a.leftButton=!!(gl.mouse.buttons&1<<g.LEFT_MOUSE_BUTTON);a.middleButton=!!(gl.mouse.buttons&1<<g.MIDDLE_MOUSE_BUTTON);a.rightButton=!!(gl.mouse.buttons&1<<g.RIGHT_MOUSE_BUTTON);a.isButtonPressed=function(a){return this.buttons_mask&1<<a}};g.isMobile=function(){return void 0!==this.mobile?this.mobile:n.navigator?navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/Android/i)?this.mobile=!0:this.mobile=!1:this.mobile=
!1};var v=n.LEvent=g.LEvent={bind:function(a,b,c,d){if(!a)throw"cannot bind event to null";if(!c)throw"cannot bind to null callback";if(a.constructor===String)throw"cannot bind event to a string";var e=a.__levents;e||(Object.defineProperty(a,"__levents",{value:{},enumerable:!1}),e=a.__levents);e.hasOwnProperty(b)?e[b].push([c,d]):e[b]=[[c,d]];if(a.onLEventBinded)a.onLEventBinded(b,c,d)},unbind:function(a,b,c,d){if(!a)throw"cannot unbind event to null";if(!c)throw"cannot unbind from null callback";
if(a.constructor===String)throw"cannot bind event to a string";var e=a.__levents;if(e&&e.hasOwnProperty(b)){for(var k=0,g=e[b].length;k<g;++k){var l=e[b][k];if(l[0]===c&&l[1]===d){e[b].splice(k,1);break}}0==e[b].length&&delete e[b];if(a.onLEventUnbinded)a.onLEventUnbinded(b,c,d)}},unbindAll:function(a,b,c){if(!a)throw"cannot unbind events in null";var d=a.__levents;if(d){if(a.onLEventUnbindAll)a.onLEventUnbindAll(b,c);if(b)for(var e in d){a=d[e];for(var k=a.length-1;0<=k;--k)a[k][1]!=b||c&&c!==a[k][0]||
a.splice(k,1)}else delete a.__levents}},unbindAllEvent:function(a,b){if(!a)throw"cannot unbind events in null";var c=a.__levents;if(c&&(delete c[b],a.onLEventUnbindAll))a.onLEventUnbindAll(b,target_instance,callback)},isBind:function(a,b,c,d){if(!a)throw"LEvent cannot have null as instance";if(a=a.__levents){if(!a.hasOwnProperty(b))return!1;for(var e=0,k=a[b].length;e<k;++e){var g=a[b][e];if(g[0]===c&&g[1]===d)return!0}return!1}},hasBind:function(a,b){if(!a)throw"LEvent cannot have null as instance";
var c=a.__levents;return c&&c.hasOwnProperty(b)&&c[b].length?!0:!1},hasBindTo:function(a,b){if(!a)throw"LEvent cannot have null as instance";var c=a.__levents;if(!c)return!1;for(var d in c)for(var e=c[d],k=0;k<e.length;++k)if(e[k][1]===b)return!0;return!1},trigger:function(a,b,c,d,e){if(!a)throw"cannot trigger event from null";if(a.constructor===String)throw"cannot bind event to a string";a=a.__levents;if(!a||!a.hasOwnProperty(b))return!1;a=a[b];if(d)for(d=a.length-1;0<=d;--d){var k=a[d];if(e){if(k&&
!0===k[0].apply(k[1],c))return!0}else if(k&&!0===k[0].call(k[1],b,c))return!0}else{d=0;for(var g=a.length;d<g;++d)if(k=a[d],e){if(k&&!0===k[0].apply(k[1],c))return!0}else if(k&&!0===k[0].call(k[1],b,c))return!0}return!1},triggerArray:function(a,b,c,d,e){for(var k=!1,g=0,l=a.length;g<l;++g){var m=a[g];if(!m)throw"cannot trigger event from null";if(m.constructor===String)throw"cannot bind event to a string";if((m=m.__levents)&&m.hasOwnProperty(b))if(d)for(var p=m[b].length-1;0<=p;--p){var q=m[b][p];
if(e){if(!0===q[0].apply(q[1],c)){k=!0;break}}else if(!0===q[0].call(q[1],b,c)){k=!0;break}}else for(var p=0,r=m[b].length;p<r;++p)if(q=m[b][p],e){if(!0===q[0].apply(q[1],c)){k=!0;break}}else if(!0===q[0].call(q[1],b,c)){k=!0;break}}return k},extendObject:function(a){a.bind=function(a,c,d){return v.bind(this,a,c,d)};a.trigger=function(a,c){return v.trigger(this,a,c)};a.unbind=function(a,c,d){return v.unbind(this,a,c,instance)};a.unbindAll=function(a,c){return v.unbindAll(this,a,c)}},extendClass:function(a){this.extendObject(a.prototype)}};
n.CLIP_INSIDE=g.CLIP_INSIDE=0;n.CLIP_OUTSIDE=g.CLIP_OUTSIDE=1;n.CLIP_OVERLAP=g.CLIP_OVERLAP=2;n.geo={createPlane:function(a,b){return new Float32Array([b[0],b[1],b[2],-vec3.dot(a,b)])},distancePointToPlane:function(a,b){return(vec3.dot(a,b)+b[3])/Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])},distance2PointToPlane:function(a,b){return(vec3.dot(a,b)+b[3])/(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])},projectPointOnLine:function(a,b,c,d){d=d||vec3.create();a=vec3.fromValues(a[0]-b[0],a[1]-b[1],a[2]-b[2]);c=vec3.fromValues(c[0]-
b[0],c[1]-b[1],c[2]-b[2]);a=vec3.dot(a,c)/vec3.dot(c,c);d[0]=b[0]+a[0]*c[0];d[1]=b[1]+a[1]*c[1];d[2]=b[2]+a[2]*c[2];return d},project2DPointOnLine:function(a,b,c,d){d=d||vec2.create();a=vec2.fromValues(a[0]-b[0],a[1]-b[1]);c=vec2.fromValues(c[0]-b[0],c[1]-b[1]);a=vec2.dot(a,c)/vec2.dot(c,c);d[0]=b[0]+a[0]*c[0];d[1]=b[1]+a[1]*c[1];return d},projectPointOnPlane:function(a,b,c,d){d=d||vec3.create();b=vec3.subtract(vec3.create(),a,b);b=vec3.dot(b,c);return vec3.subtract(d,a,vec3.scale(vec3.create(),c,
b))},reflectPointInPlane:function(a,b,c){b=-(-1*(b[0]*c[0]+b[1]*c[1]+b[2]*c[2])+c[0]*a[0]+c[1]*a[1]+c[2]*a[2])/(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]);return vec3.fromValues(a[0]+b*c[0]*2,a[1]+b*c[1]*2,a[2]+b*c[2]*2)},testRayPlane:function(a,b,c,d,e){c=vec3.dot(c,d)-vec3.dot(d,a);d=vec3.dot(d,b);if(Math.abs(d)<EPSILON)return!1;d=c/d;if(0>d)return!1;e&&vec3.add(e,a,vec3.scale(e,b,d));return!0},testSegmentPlane:function(){var a=vec3.create();return function(b,c,d,e,k){d=vec3.dot(d,e)-vec3.dot(e,b);c=vec3.sub(a,
c,b);e=vec3.dot(e,c);if(Math.abs(e)<EPSILON)return!1;e=d/e;if(0>e||1<e)return!1;k&&vec3.add(k,b,vec3.scale(k,c,e));return!0}}(),testRaySphere:function(){var a=vec3.create();return function(b,c,d,e,k,g){var l=vec3.subtract(a,b,d),m=c[0]*c[0]+c[1]*c[1]+c[2]*c[2];d=2*l[0]*c[0]+2*l[1]*c[1]+2*l[2]*c[2];e=d*d-4*m*(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]-e*e);if(0>e)return!1;if(k){e=Math.sqrt(e);l=1/(2*m);m=(-d+e)*l;d=(-d-e)*l;d=m<d?m:d;if(d>g)return!1;vec3.add(k,b,vec3.scale(k,c,d))}return!0}}(),testRayCylinder:function(a,
b,c,d,e,k){var g=vec3.clone(a);a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,1E5));var l=0;b=vec3.subtract(vec3.create(),d,c);var m=vec3.subtract(vec3.create(),g,c);c=vec3.subtract(vec3.create(),a,g);d=vec3.dot(m,b);a=vec3.dot(c,b);b=vec3.dot(b,b);if(0>d&&0>d+a||d>b&&d+a>b)return!1;var p=vec3.dot(c,c),q=vec3.dot(m,c),l=b*p-a*a;e=vec3.dot(m,m)-e*e;var r=b*e-d*d;if(Math.abs(l)<EPSILON){if(0<r)return!1;l=0>d?-q/p:d>b?(a-q)/p:0;k&&vec3.add(k,g,vec3.scale(vec3.create(),c,l));return!0}m=b*q-a*d;
r=m*m-l*r;if(0>r)return!1;l=(-m-Math.sqrt(r))/l;if(0>l||1<l)return!1;if(0>d+l*a){if(0>=a)return!1;l=-d/a;k&&vec3.add(k,g,vec3.scale(vec3.create(),c,l));return 0>=e+2*l*(q+l*p)}if(d+l*a>b){if(0<=a)return!1;l=(b-d)/a;k&&vec3.add(k,g,vec3.scale(vec3.create(),c,l));return 0>=e+b-2*d+l*(2*(q-a)+l*p)}k&&vec3.add(k,g,vec3.scale(vec3.create(),c,l));return!0},testRayBox:function(){var a=new Float32Array(3),b=new Float32Array(3),c=new Float32Array(3);return function(d,e,k,g,l,m){m=m||Number.MAX_VALUE;var p=
!0,q=0;a.fill(0);c.fill(0);b.fill(0);for(q=0;3>q;++q)d[q]<k[q]?(a[q]=1,b[q]=k[q],p=!1):d[q]>g[q]?(a[q]=0,b[q]=g[q],p=!1):a[q]=2;if(p)return l&&vec3.copy(l,d),!0;for(q=0;3>q;++q)c[q]=2!=a[q]&&0!=e[q]?(b[q]-d[q])/e[q]:-1;p=0;for(q=1;3>q;q++)c[p]<c[q]&&(p=q);if(0>c[p]||c[p]>m)return!1;for(q=0;3>q;++q)if(p!=q){m=d[q]+c[p]*e[q];if(m<k[q]||m>g[q])return!1;l&&(l[q]=m)}else l&&(l[q]=b[q]);return!0}}(),testRayBBox:function(){var a=mat4.create(),b=vec3.create(),c=vec3.create();return function(d,e,k,g,l,m,p){if(!d||
!e||!k)throw"parameters missing";g&&(mat4.invert(a,g),vec3.add(b,d,e),d=vec3.transformMat4(c,d,a),vec3.transformMat4(b,b,a),vec3.sub(b,b,d),e=vec3.normalize(b,b));d=this.testRayBox(d,e,k.subarray(6,9),k.subarray(9,12),l,m);!p&&g&&l&&vec3.transformMat4(l,l,g);return d}}(),testPointBBox:function(a,b){return a[0]<b[6]||a[0]>b[9]||a[1]<b[7]||a[0]>b[10]||a[2]<b[8]||a[0]>b[11]?!1:!0},testBBoxBBox:function(a,b){if(Math.abs(b[0]-a[0])>a[3]+b[3]||Math.abs(b[1]-a[1])>a[4]+b[4]||Math.abs(b[2]-a[2])>a[5]+b[5])return!1;
var c=BBox.getMin(b);geo.testPointBBox(c,a)&&(c=BBox.getMax(b),geo.testPointBBox(c,a));return!0},testSphereBBox:function(a,b,c){for(var d=0,e=BBox.getMin(c),k=BBox.getMax(c),g=0;3>g;++g)a[g]<e[g]?(c=a[g]-e[g],d+=c*c):a[g]>k[g]&&(c=a[g]-k[g],d+=c*c);return d<=b*b?!0:!1},closestPointBetweenLines:function(a,b,c,d,e,k){b=vec3.subtract(vec3.create(),b,a);d=vec3.subtract(vec3.create(),d,c);var g=vec3.subtract(vec3.create(),a,c),l=vec3.dot(b,b),m=vec3.dot(b,d),p=vec3.dot(d,d),q=vec3.dot(b,g),r=vec3.dot(d,
g),n=l*p-m*m,w;n<EPSILON?(w=0,l=m>p?q/m:r/p):(w=(m*r-p*q)/n,l=(l*r-m*q)/n);e&&vec3.add(e,a,vec3.scale(vec3.create(),b,w));k&&vec3.add(k,c,vec3.scale(vec3.create(),d,l));a=vec3.add(vec3.create(),g,vec3.subtract(vec3.create(),vec3.scale(vec3.create(),b,w),vec3.scale(vec3.create(),d,l)));return vec3.length(a)},extractPlanes:function(a,b){function c(a){var c=b.subarray(a,a+3),c=vec3.length(c);0!==c&&(c=1/c,b[a]*=c,b[a+1]*=c,b[a+2]*=c,b[a+3]*=c)}b=b||new Float32Array(24);b.set([a[3]-a[0],a[7]-a[4],a[11]-
a[8],a[15]-a[12]],0);c(0);b.set([a[3]+a[0],a[7]+a[4],a[11]+a[8],a[15]+a[12]],4);c(4);b.set([a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]],8);c(8);b.set([a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]],12);c(12);b.set([a[3]-a[2],a[7]-a[6],a[11]-a[10],a[15]-a[14]],16);c(16);b.set([a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]],20);c(20);return b},frustumTestBox:function(a,b){var c=0,d=0,c=planeBoxOverlap(a.subarray(0,4),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(4,8),b);if(c==
CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(8,12),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(12,16),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(16,20),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(20,24),b);return c==CLIP_OUTSIDE?CLIP_OUTSIDE:0==d+c?CLIP_INSIDE:CLIP_OVERLAP},frustumTestSphere:function(a,b,c){var d,e=!1;d=distanceToPlane(a.subarray(0,4),b);if(d<-c)return CLIP_OUTSIDE;
d>=-c&&d<=c&&(e=!0);d=distanceToPlane(a.subarray(4,8),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(e=!0);d=distanceToPlane(a.subarray(8,12),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(e=!0);d=distanceToPlane(a.subarray(12,16),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(e=!0);d=distanceToPlane(a.subarray(16,20),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(e=!0);d=distanceToPlane(a.subarray(20,24),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(e=!0);return e?CLIP_OVERLAP:CLIP_INSIDE},testPoint2DInPolygon:function(a,
b){for(var c=!1,d=-1,e=a.length,k=e-1;++d<e;k=d)(a[d][1]<=b[1]&&b[1]<a[k][1]||a[k][1]<=b[1]&&b[1]<a[d][1])&&b[0]<(a[k][0]-a[d][0])*(b[1]-a[d][1])/(a[k][1]-a[d][1])+a[d][0]&&(c=!c);return c}};n.BBox=g.BBox={center:0,halfsize:3,min:6,max:9,radius:12,data_length:13,corners:new Float32Array([1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1]),tmp_corners:new Float32Array(24),create:function(){return new Float32Array(13)},clone:function(a){return new Float32Array(a)},copy:function(a,b){a.set(b);
return a},fromPoint:function(a){var b=this.create();b.set(a,0);b.set(a,6);b.set(a,9);return b},fromMinMax:function(a,b){var c=this.create();this.setMinMax(c,a,b);return c},fromCenterHalfsize:function(a,b){var c=this.create();this.setCenterHalfsize(c,a,b);return c},fromPoints:function(a){var b=this.create();this.setFromPoints(b,a);return b},setFromPoints:function(a,b){var c=a.subarray(6,9),d=a.subarray(9,12);c.set(b.subarray(0,3));d.set(c);for(var e=0,k=3,g=b.length;k<g;k+=3)e=b.subarray(k,k+3),vec3.min(c,
e,c),vec3.max(d,e,d);c=vec3.add(a.subarray(0,3),c,d);vec3.scale(c,c,0.5);vec3.subtract(a.subarray(3,6),d,c);a[12]=vec3.length(a.subarray(3,6));return a},setMinMax:function(a,b,c){a[6]=b[0];a[7]=b[1];a[8]=b[2];a[9]=c[0];a[10]=c[1];a[11]=c[2];var d=a.subarray(3,6);vec3.sub(d,c,b);vec3.scale(d,d,0.5);a[0]=c[0]-d[0];a[1]=c[1]-d[1];a[2]=c[2]-d[2];a[12]=vec3.length(a.subarray(3,6));return a},setCenterHalfsize:function(a,b,c,d){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=c[0];a[4]=c[1];a[5]=c[2];vec3.sub(a.subarray(6,
9),a.subarray(0,3),a.subarray(3,6));vec3.add(a.subarray(9,12),a.subarray(0,3),a.subarray(3,6));a[12]=d?d:vec3.length(c);return a},transformMat4:function(a,b,c){var d=b.subarray(3,6),e=this.tmp_corners;e.set(this.corners);for(var k=0;8>k;++k){var g=e.subarray(3*k,3*k+3);vec3.multiply(g,d,g);vec3.add(g,g,b);mat4.multiplyVec3(g,c,g)}return this.setFromPoints(a,e)},getCorners:function(a,b){var c=a.subarray(3,6),d=null;b?(b.set(this.corners),d=b):d=new Float32Array(this.corners);for(var e=0;8>e;++e){var k=
d.subarray(3*e,3*e+3);vec3.multiply(k,c,k);vec3.add(k,k,a)}return d},merge:function(a,b,c){var d=a.subarray(6,9),e=a.subarray(9,12);vec3.min(d,b.subarray(6,9),c.subarray(6,9));vec3.max(e,b.subarray(9,12),c.subarray(9,12));return BBox.setMinMax(a,d,e)},extendToPoint:function(a,b){b[0]<a[6]?a[6]=b[0]:b[0]>a[9]&&(a[9]=b[0]);b[1]<a[7]?a[7]=b[1]:b[1]>a[10]&&(a[10]=b[1]);b[2]<a[8]?a[8]=b[2]:b[2]>a[11]&&(a[11]=b[2]);var c=a.subarray(6,9),d=a.subarray(9,12),c=vec3.add(a.subarray(0,3),c,d);vec3.scale(c,c,
0.5);vec3.subtract(a.subarray(3,6),d,c);a[12]=vec3.length(a.subarray(3,6));return a},getCenter:function(a){return a.subarray(0,3)},getHalfsize:function(a){return a.subarray(3,6)},getMin:function(a){return a.subarray(6,9)},getMax:function(a){return a.subarray(9,12)},getRadius:function(a){return a[12]}};n.distanceToPlane=g.distanceToPlane=function(a,b){return vec3.dot(a,b)+a[3]};n.planeBoxOverlap=g.planeBoxOverlap=function(a,b){var c=a[3],d=vec3.fromValues(Math.abs(b[3]*a[0]),Math.abs(b[4]*a[1]),Math.abs(b[5]*
a[2])),d=d[0]+d[1]+d[2],c=vec3.dot(a,b)+c;return c<=-d?CLIP_OUTSIDE:c<=d?CLIP_OVERLAP:CLIP_INSIDE};n.Octree=g.Octree=function(a){this.root=null;this.total_nodes=this.total_depth=0;a&&(this.buildFromMesh(a),this.total_nodes=this.trim())};Octree.MAX_NODE_TRIANGLES_RATIO=0.1;Octree.MAX_OCTREE_DEPTH=8;Octree.OCTREE_MARGIN_RATIO=0.01;Octree.OCTREE_MIN_MARGIN=0.1;Octree.prototype.buildFromMesh=function(a){this.total_nodes=this.total_depth=0;var b=a.getBuffer("vertices").data;if(a=a.getIndexBuffer("triangles"))a=
a.data;var c=this.computeAABB(b);this.root=c;this.total_nodes=1;this.total_triangles=a?a.length/3:b.length/9;this.max_node_triangles=this.total_triangles*Octree.MAX_NODE_TRIANGLES_RATIO;var d=vec3.create();vec3.scale(d,c.size,Octree.OCTREE_MARGIN_RATIO);d[0]<Octree.OCTREE_MIN_MARGIN&&(d[0]=Octree.OCTREE_MIN_MARGIN);d[1]<Octree.OCTREE_MIN_MARGIN&&(d[1]=Octree.OCTREE_MIN_MARGIN);d[2]<Octree.OCTREE_MIN_MARGIN&&(d[2]=Octree.OCTREE_MIN_MARGIN);vec3.sub(c.min,c.min,d);vec3.add(c.max,c.max,d);c.faces=[];
c.inside=0;if(a)for(d=0;d<a.length;d+=3){var e=new Float32Array([b[3*a[d]],b[3*a[d]+1],b[3*a[d]+2],b[3*a[d+1]],b[3*a[d+1]+1],b[3*a[d+1]+2],b[3*a[d+2]],b[3*a[d+2]+1],b[3*a[d+2]+2]]);this.addToNode(e,c,0)}else for(d=0;d<b.length;d+=9)e=new Float32Array(b.subarray(d,d+9)),this.addToNode(e,c,0);return c};Octree.prototype.addToNode=function(a,b,c){b.inside+=1;if(b.c){var d=this.computeAABB(a),e=!1,k;for(k in b.c){var g=b.c[k];if(Octree.isInsideAABB(d,g)){this.addToNode(a,g,c+1);e=!0;break}}e||(null==b.faces&&
(b.faces=[]),b.faces.push(a))}else if(null==b.faces&&(b.faces=[]),b.faces.push(a),b.faces.length>this.max_node_triangles&&c<Octree.MAX_OCTREE_DEPTH){this.splitNode(b);this.total_depth<c+1&&(this.total_depth=c+1);var l=b.faces.concat();b.faces=null;for(k in l){a=l[k];var d=this.computeAABB(a),e=!1,m;for(m in b.c)if(g=b.c[m],Octree.isInsideAABB(d,g)){this.addToNode(a,g,c+1);e=!0;break}e||(null==b.faces&&(b.faces=[]),b.faces.push(a))}}};Octree.prototype.octree_pos_ref=[[0,0,0],[0,0,1],[0,1,0],[0,1,1],
[1,0,0],[1,0,1],[1,1,0],[1,1,1]];Octree.prototype.splitNode=function(a){a.c=[];var b=[0.5*(a.max[0]-a.min[0]),0.5*(a.max[1]-a.min[1]),0.5*(a.max[2]-a.min[2])],c;for(c in this.octree_pos_ref){var d=this.octree_pos_ref[c],e={};this.total_nodes+=1;e.min=[a.min[0]+b[0]*d[0],a.min[1]+b[1]*d[1],a.min[2]+b[2]*d[2]];e.max=[e.min[0]+b[0],e.min[1]+b[1],e.min[2]+b[2]];e.faces=null;e.inside=0;a.c.push(e)}};Octree.prototype.computeAABB=function(a){for(var b=new Float32Array([a[0],a[1],a[2]]),c=new Float32Array([a[0],
a[1],a[2]]),d=0;d<a.length;d+=3)for(var e=0;3>e;e++)b[e]>a[d+e]&&(b[e]=a[d+e]),c[e]<a[d+e]&&(c[e]=a[d+e]);return{min:b,max:c,size:vec3.sub(vec3.create(),c,b)}};Octree.prototype.trim=function(a){a=a||this.root;if(!a.c)return 1;for(var b=1,c=[],d=a.c,e=0;e<d.length;++e)d[e].inside&&(c.push(d[e]),b+=this.trim(d[e]));a.c=c;return b};Octree.prototype.testRay=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create();return function(e,k,g,l,m){if(!this.root)throw"Error: octree not build";
a.set(e);b.set(k);c.set(this.root.min);d.set(this.root.max);g=Octree.hitTestBox(a,b,c,d);if(!g)return null;g=Octree.testRayInNode(this.root,a,b,m);return null!=g?(k=vec3.scale(vec3.create(),k,g.t),vec3.add(k,k,e),g.pos=k,g):null}}();Octree.prototype.testSphere=function(a,b){a=vec3.clone(a);if(!this.root)throw"Error: octree not build";var c=b*b;return Octree.testSphereBox(a,c,vec3.clone(this.root.min),vec3.clone(this.root.max))?Octree.testSphereInNode(this.root,a,c):!1};Octree.testRayInNode=function(a,
b,c,d){var e=null,k=null;if(a.faces)for(var g=0,l=a.faces.length;g<l;++g){var m=a.faces[g],e=Octree.hitTestTriangle(b,c,m.subarray(0,3),m.subarray(3,6),m.subarray(6,9),d);null!=e&&(e.face=m,k?k.mergeWith(e):k=e)}var l=vec3.create(),m=vec3.create(),p;if(a.c)for(g=0;g<a.c.length;++g)p=a.c[g],l.set(p.min),m.set(p.max),e=Octree.hitTestBox(b,c,l,m),null==e||k&&e.t>k.t||(e=Octree.testRayInNode(p,b,c,d),null!=e&&(k?k.mergeWith(e):k=e));return k};Octree.testSphereInNode=function(a,b,c){if(a.faces)for(var d=
0,e=a.faces.length;d<e;++d){var k=a.faces[d];if(Octree.testSphereTriangle(b,c,k.subarray(0,3),k.subarray(3,6),k.subarray(6,9)))return!0}var e=vec3.create(),k=vec3.create(),g;if(a.c)for(d=0;d<a.c.length;++d)if(g=a.c[d],e.set(g.min),k.set(g.max),Octree.testSphereBox(b,c,e,k)&&Octree.testSphereInNode(g,b,c))return!0;return!1};Octree.isInsideAABB=function(a,b){return a.min[0]<b.min[0]||a.min[1]<b.min[1]||a.min[2]<b.min[2]||a.max[0]>b.max[0]||a.max[1]>b.max[1]||a.max[2]>b.max[2]?!1:!0};Octree.hitTestBox=
function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create(),e=vec3.create(),k=vec3.create(),g=vec3.fromValues(1E-6,1E-6,1E-6);return function(l,m,p,q){vec3.subtract(a,p,l);vec3.subtract(b,q,l);if(0>vec3.maxValue(a)&&0<vec3.minValue(b))return new HitTest(0,l,m);c[0]=1/m[0];c[1]=1/m[1];c[2]=1/m[2];vec3.multiply(a,a,c);vec3.multiply(b,b,c);vec3.min(d,a,b);vec3.max(e,a,b);var r=vec3.maxValue(d),n=vec3.minValue(e);return 0<r&&r<n?(l=vec3.add(vec3.create(),vec3.scale(k,m,r),l),vec3.add(p,
p,g),vec3.subtract(p,p,g),new HitTest(r,l,vec3.fromValues((l[0]>q[0])-(l[0]<p[0]),(l[1]>q[1])-(l[1]<p[1]),(l[2]>q[2])-(l[2]<p[2])))):null}}();Octree.hitTestTriangle=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create();return function(e,k,g,l,m,p){vec3.subtract(a,l,g);vec3.subtract(b,m,g);l=vec3.cross(vec3.create(),a,b);vec3.normalize(l,l);if(!p&&0<vec3.dot(l,k))return null;p=vec3.dot(l,vec3.subtract(d,g,e))/vec3.dot(l,k);if(0<p){k=vec3.scale(vec3.create(),k,p);vec3.add(k,
k,e);vec3.subtract(c,k,g);e=vec3.dot(b,b);g=vec3.dot(b,a);m=vec3.dot(b,c);var q=vec3.dot(a,a),r=vec3.dot(a,c),n=e*q-g*g,q=(q*m-g*r)/n;e=(e*r-g*m)/n;if(0<=q&&0<=e&&1>=q+e)return new HitTest(p,k,l)}return null}}();Octree.testSphereTriangle=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create(),e=vec3.create(),k=vec3.create(),g=vec3.create(),l=vec3.create();return function(m,p,q,r,n){vec3.sub(a,q,m);vec3.sub(b,r,m);vec3.sub(c,n,m);vec3.sub(d,b,a);vec3.sub(e,c,a);vec3.cross(l,
d,e);m=vec3.dot(a,l);q=vec3.dot(l,l);m=m*m>p*q;var w=vec3.dot(a,a),s=vec3.dot(a,b),z=vec3.dot(a,c),x=vec3.dot(b,b),v=vec3.dot(b,c),A=vec3.dot(c,c);q=w>p&s>w&z>w;r=x>p&s>x&v>x;n=A>p&z>A&v>A;var w=s-w,s=v-x,y=z-A;vec3.sub(k,c,b);vec3.sub(g,a,c);x=vec3.dot(d,d);A=vec3.dot(k,k);z=vec3.dot(g,g);v=vec3.scale(vec3.create(),a,x);vec3.sub(v,v,vec3.scale(vec3.create(),d,w));w=vec3.scale(vec3.create(),b,A);vec3.sub(w,w,vec3.scale(vec3.create(),k,s));s=vec3.scale(vec3.create(),c,z);vec3.sub(s,s,vec3.scale(vec3.create(),
g,y));var G=vec3.scale(vec3.create(),c,x),G=vec3.sub(G,G,v),I=vec3.scale(vec3.create(),a,A),I=vec3.sub(I,I,w),y=vec3.scale(vec3.create(),b,z),y=vec3.sub(y,y,s),x=vec3.dot(v,v)>p*x*x&0<vec3.dot(v,G),A=vec3.dot(w,w)>p*A*A&0<vec3.dot(w,I);p=vec3.dot(s,s)>p*z*z&0<vec3.dot(s,y);return!(m|q|r|n|x|A|p)}}();Octree.testSphereBox=function(a,b,c,d){for(var e,k=0,g=0;3>g;++g)a[g]<c[g]?(e=a[g]-c[g],k+=e*e):a[g]>d[g]&&(e=a[g]-d[g],k+=e*e);return k<=b?!0:!1};n.HitTest=g.HitTest=function(a,b,c){this.t=arguments.length?
a:Number.MAX_VALUE;this.hit=b;this.normal=c;this.face=null};HitTest.prototype={mergeWith:function(a){0<a.t&&a.t<this.t&&(this.t=a.t,this.hit=a.hit,this.normal=a.normal,this.face=a.face)}};n.Ray=g.Ray=function(a,b){this.origin=vec3.create();this.direction=vec3.create();this.collision_point=vec3.create();a&&this.origin.set(a);b&&this.direction.set(b)};Ray.prototype.testPlane=function(a,b){return geo.testRayPlane(this.origin,this.direction,a,b,this.collision_point)};Ray.prototype.testSphere=function(a,
b,c){return geo.testRaySphere(this.origin,this.direction,a,b,this.collision_point,c)};n.Raytracer=g.Raytracer=function(a,b){this.viewport=vec4.create();this.ray00=vec3.create();this.ray10=vec3.create();this.ray01=vec3.create();this.ray11=vec3.create();this.eye=vec3.create();this.setup(a,b)};Raytracer.prototype.setup=function(a,b){b=b||gl.viewport_data;this.viewport.set(b);var c=b[0],d=c+b[2],e=b[1],g=e+b[3];vec3.set(this.ray00,c,e,1);vec3.set(this.ray10,d,e,1);vec3.set(this.ray01,c,g,1);vec3.set(this.ray11,
d,g,1);vec3.unproject(this.ray00,this.ray00,a,b);vec3.unproject(this.ray10,this.ray10,a,b);vec3.unproject(this.ray01,this.ray01,a,b);vec3.unproject(this.ray11,this.ray11,a,b);c=this.eye;vec3.unproject(c,c,a,b);vec3.subtract(this.ray00,this.ray00,c);vec3.subtract(this.ray10,this.ray10,c);vec3.subtract(this.ray01,this.ray01,c);vec3.subtract(this.ray11,this.ray11,c)};Raytracer.prototype.getRayForPixel=function(){var a=vec3.create(),b=vec3.create();return function(c,d,e){e=e||vec3.create();c=(c-this.viewport[0])/
this.viewport[2];d=1-(d-this.viewport[1])/this.viewport[3];vec3.lerp(a,this.ray00,this.ray10,c);vec3.lerp(b,this.ray01,this.ray11,c);vec3.lerp(e,a,b,d);return vec3.normalize(e,e)}}();var V=mat4.create();Raytracer.hitTestBox=function(a,b,c,d,e){var g=new Float32Array(30);e&&(e=mat4.invert(V,e),a=mat4.multiplyVec3(g.subarray(3,6),e,a),b=mat4.rotateVec3(g.subarray(6,9),e,b));var n=vec3.subtract(g.subarray(9,12),c,a);vec3.divide(n,n,b);var l=vec3.subtract(g.subarray(12,15),d,a);vec3.divide(l,l,b);e=vec3.min(g.subarray(15,
18),n,l);n=vec3.max(g.subarray(18,21),n,l);e=vec3.maxValue(e);n=vec3.minValue(n);return 0<e&&e<=n?(b=vec3.scale(g.subarray(21,24),b,e),vec3.add(b,a,b),vec3.addValue(g.subarray(24,27),c,1E-6),vec3.subValue(g.subarray(27,30),d,1E-6),new HitTest(e,b,vec3.fromValues((b[0]>d[0])-(b[0]<c[0]),(b[1]>d[1])-(b[1]<c[1]),(b[2]>d[2])-(b[2]<c[2])))):null};Raytracer.hitTestSphere=function(a,b,c,d){var e=vec3.subtract(vec3.create(),a,c),g=vec3.dot(b,b),n=2*vec3.dot(b,e),e=vec3.dot(e,e)-d*d,e=n*n-4*g*e;return 0<e?
(g=(-n-Math.sqrt(e))/(2*g),a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,g)),new HitTest(g,a,vec3.scale(vec3.create(),vec3.subtract(vec3.create(),a,c),1/d))):null};Raytracer.hitTestTriangle=function(a,b,c,d,e){var g=vec3.subtract(vec3.create(),d,c),n=vec3.subtract(vec3.create(),e,c);e=vec3.cross(vec3.create(),g,n);vec3.normalize(e,e);d=vec3.dot(e,vec3.subtract(vec3.create(),c,a))/vec3.dot(e,b);if(0<d){a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,d));var l=vec3.subtract(vec3.create(),
a,c);c=vec3.dot(n,n);b=vec3.dot(n,g);var n=vec3.dot(n,l),m=vec3.dot(g,g),g=vec3.dot(g,l),l=c*m-b*b,m=(m*n-b*g)/l,g=(c*g-b*n)/l;if(0<=m&&0<=g&&1>=m+g)return new HitTest(d,a,e)}return null};Mesh.parseOBJ=function(a,b){b=b||{};for(var c=[],d=[],e=[],g=[],n=[],l=[],m=[],p={},q=0,r=null,u=null,w=0,s=0,v=0,x=u=0,y=0,A=null,G=!1,I=!1,P=!1,O=!1,R=0,N=b.noindex?b.noindex:1E7<a.length?!0:!1,L=b.flipAxis,H=L||b.flipNormals,B=null,D=[],F={v:1,vt:2,vn:3,f:4,g:5,o:6},E=a.split("\n"),Q=E.length,J=0;J<Q;++J)if(r=
E[J].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),"#"!=r[0]&&""!=r){var A=r.split(" "),C=F[A[0]];O&&1==C&&(O=!1);3>=C&&(u=parseFloat(A[1]),x=parseFloat(A[2]),2!=C&&("\\"==A[3]?(++J,r=E[J].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),y=parseFloat(r)):y=parseFloat(A[3])));if(1==C)L?n.push(-1*u,y,x):n.push(u,x,y);else if(2==C)l.push(u,x);else if(3==C)H?m.push(-x,-y,u):m.push(u,x,y);else if(4==C){if(O=!0,!(4>A.length)){C=[];for(r=1;r<A.length;++r){if(!(A[r]in p)||N){u=A[r].split("/");if(1==u.length)v=s=
w=parseInt(u[0])-1;else if(2==u.length)w=parseInt(u[0])-1,s=parseInt(u[1])-1,v=-1;else if(3==u.length)w=parseInt(u[0])-1,s=parseInt(u[1])-1,v=parseInt(u[2])-1;else return console.err("Problem parsing: unknown number of values per face"),!1;3<r&&N&&(u=c.length,c.push(c[u-9*(r-3)],c[u-9*(r-3)+1],c[u-9*(r-3)+2]),c.push(c[u-3],c[u-2],c[u-1]),u=d.length,d.push(d[u-6*(r-3)],d[u-6*(r-3)+1]),d.push(d[u-2],d[u-1]),u=e.length,e.push(e[u-9*(r-3)],e[u-9*(r-3)+1],e[u-9*(r-3)+2]),e.push(e[u-3],e[u-2],e[u-1]));
y=x=u=0;3*w+2<n.length&&(G=!0,u=n[3*w+0],x=n[3*w+1],y=n[3*w+2]);c.push(u,x,y);x=u=0;2*s+1<l.length&&(I=!0,u=l[2*s+0],x=l[2*s+1]);d.push(u,x);x=u=0;y=1;-1!=v&&(3*v+2<m.length&&(P=!0,u=m[3*v+0],x=m[3*v+1],y=m[3*v+2]),e.push(u,x,y));N||(p[A[r]]=q++)}N||(w=p[A[r]],C.push(w),R<w&&(R=w))}if(!N)for(r=2;r<C.length;r++)g.push(C[0],C[r-1],C[r])}}else 5==C||"usemtl"==A[0]?1<A.length&&(null!=B&&(B.length=g.length-B.start,0<B.length&&D.push(B)),B={name:A[1],start:g.length,length:-1,material:""}):"usemtl"==A[0]&&
B&&(B.material=A[1])}if(!n.length)return console.error("OBJ doesnt have vertices, maybe the file is not a OBJ"),null;B&&1<g.length-B.start&&(B.length=g.length-B.start,D.push(B));if((65536<R||N)&&0<g.length){console.log("Deindexing mesh...");n=new Float32Array(3*g.length);l=e&&e.length?new Float32Array(3*g.length):null;m=d&&d.length?new Float32Array(2*g.length):null;for(r=0;r<g.length;r+=1)n.set(c.slice(3*g[r],3*g[r]+3),3*r),l&&l.set(e.slice(3*g[r],3*g[r]+3),3*r),m&&m.set(d.slice(2*g[r],2*g[r]+2),
2*r);c=n;l&&(e=l);m&&(d=m);g=null}n={};G&&(n.vertices=new Float32Array(c));P&&0<e.length&&(n.normals=new Float32Array(e));I&&0<d.length&&(n.coords=new Float32Array(d));g&&0<g.length&&(n.triangles=new Uint16Array(g));c={};1<D.length&&(c.groups=D);n.info=c;if(b.only_data)return n;D=null;D=Mesh.load(n,null,b.mesh);D.updateBoundingBox();return D};Mesh.parsers.obj=Mesh.parseOBJ;Mesh.encoders.obj=function(a,b){var c=a.getBuffer("vertices");if(!c)return null;for(var d="# Generated with liteGL.js by Javi Agenjo\n\n",
c=c.data,e=0;e<c.length;e+=3)d+="v "+c[e].toFixed(4)+" "+c[e+1].toFixed(4)+" "+c[e+2].toFixed(4)+"\n";if(e=a.getBuffer("normals"))for(var d=d+"\n",g=e.data,e=0;e<g.length;e+=3)d+="vn "+g[e].toFixed(4)+" "+g[e+1].toFixed(4)+" "+g[e+2].toFixed(4)+"\n";if(e=a.getBuffer("coords"))for(d+="\n",g=e.data,e=0;e<g.length;e+=2)d+="vt "+g[e].toFixed(4)+" "+g[e+1].toFixed(4)+"  0.0000\n";d+="\ng mesh\n";if(e=a.getIndexBuffer("triangles"))for(c=e.data,e=0;e<c.length;e+=3)d+="f "+(c[e]+1)+"/"+(c[e]+1)+"/"+(c[e]+
1)+" "+(c[e+1]+1)+"/"+(c[e+1]+1)+"/"+(c[e+1]+1)+" "+(c[e+2]+1)+"/"+(c[e+2]+1)+"/"+(c[e+2]+1)+"\n";else for(e=0;e<c.length/3;e+=3)d+="f "+(e+1)+"/"+(e+1)+"/"+(e+1)+" "+(e+2)+"/"+(e+2)+"/"+(e+2)+" "+(e+3)+"/"+(e+3)+"/"+(e+3)+"\n";return d};n.WBin&&(n.WBin.classes.Mesh=Mesh);Mesh.binary_file_formats.wbin=!0;Mesh.parsers.wbin=Mesh.fromBinary=function(a,b){if(!n.WBin)throw"To use binary meshes you need to install WBin.js from https://github.com/jagenjo/litescene.js/blob/master/src/utils/wbin.js ";b=b||
{};var c=null,c=a.constructor==ArrayBuffer?WBin.load(a,!0):a;c.info||console.warn("This WBin doesn't seem to contain a mesh. Classname: ",c["@classname"]);c.format&&g.Mesh.decompress(c);var d={};if(c.vertex_buffers)for(var e in c.vertex_buffers)d[c.vertex_buffers[e]]=c[c.vertex_buffers[e]];else c.vertices&&(d.vertices=c.vertices),c.normals&&(d.normals=c.normals),c.coords&&(d.coords=c.coords),c.weights&&(d.weights=c.weights),c.bone_indices&&(d.bone_indices=c.bone_indices);var k={};if(c.index_buffers)for(e in c.index_buffers)k[c.index_buffers[e]]=
c[c.index_buffers[e]];else c.triangles&&(k.triangles=c.triangles),c.wireframe&&(k.wireframe=c.wireframe);d={vertex_buffers:d,index_buffers:k,bounding:c.bounding,info:c.info};if(c.bones){d.bones=c.bones;for(e=0;e<d.bones.length;++e)d.bones[e][1]=mat4.clone(d.bones[e][1]);c.bind_matrix&&(d.bind_matrix=mat4.clone(c.bind_matrix))}c.morph_targets&&(d.morph_targets=c.morph_targets);if(b.only_data)return d;c=b.mesh||new g.Mesh;c.configure(d);return c};Mesh.encoders.wbin=function(a,b){return a.toBinary(b)};
Mesh.prototype.toBinary=function(a){if(!n.WBin)throw"to use Mesh.toBinary you need to have WBin included. Check the repository for wbin.js";this.info||(this.info={});a={object_class:"Mesh",info:this.info,groups:this.groups};if(this.bones){for(var b=[],c=0;c<this.bones.length;++c)b.push([this.bones[c][0],mat4.toArray(this.bones[c][1])]);a.bones=b;this.bind_matrix&&(a.bind_matrix=this.bind_matrix)}this.bounding||this.updateBoundingBox();a.bounding=this.bounding;var b=[],d=[];for(c in this.vertexBuffers){var e=
this.vertexBuffers[c];a[e.name]=e.data;b.push(e.name);"vertices"==e.name&&(a.info.num_vertices=e.data.length/3)}for(c in this.indexBuffers)e=this.indexBuffers[c],a[c]=e.data,d.push(c);a.vertex_buffers=b;a.index_buffers=d;g.Mesh.enable_wbin_compression&&g.Mesh.compress(a);return WBin.create(a,"Mesh")};Mesh.compress=function(a,b){b=b||"bounding_compressed";a.format={type:b};var c=Mesh.compressors[b];if(!c)throw"compression format not supported:"+b;return c(a)};Mesh.decompress=function(a){if(a.format){var b=
Mesh.decompressors[a.format.type];if(!b)throw"decompression format not supported:"+a.format.type;return b(a)}};Mesh.compressors.bounding_compressed=function(a){if(!a.vertex_buffers)throw"buffers not found";for(var b=BBox.getMin(a.bounding),c=BBox.getMax(a.bounding),d=vec3.sub(vec3.create(),c,b),e=a.vertices,g=new Uint16Array(e.length),c=0;c<e.length;c+=3)g[c]=(e[c]-b[0])/d[0]*65535,g[c+1]=(e[c+1]-b[1])/d[1]*65535,g[c+2]=(e[c+2]-b[2])/d[2]*65535;a.vertices=g;if(a.normals){d=a.normals;b=new Uint8Array(d.length);
e=b.constructor==Uint8Array?255:65535;for(c=0;c<d.length;c+=3)b[c]=(0.5*d[c]+0.5)*e,b[c+1]=(0.5*d[c+1]+0.5)*e,b[c+2]=(0.5*d[c+2]+0.5)*e;a.normals=b}if(a.coords){b=a.coords;e=[1E4,1E4,-1E4,-1E4];for(c=0;c<b.length;c+=2)d=b[c],e[0]>d?e[0]=d:e[2]<d&&(e[2]=d),d=b[c+1],e[1]>d?e[1]=d:e[3]<d&&(e[3]=d);a.format.uvs_bounding=e;g=new Uint16Array(b.length);d=[e[2]-e[0],e[3]-e[1]];for(c=0;c<b.length;c+=2)g[c]=(b[c]-e[0])/d[0]*65535,g[c+1]=(b[c+1]-e[1])/d[1]*65535;a.coords=g}if(a.weights){d=a.weights;b=new Uint16Array(d.length);
e=b.constructor==Uint8Array?255:65535;for(c=0;c<d.length;c+=4)b[c]=d[c]*e,b[c+1]=d[c+1]*e,b[c+2]=d[c+2]*e,b[c+3]=d[c+3]*e;a.weights=b}};Mesh.decompressors.bounding_compressed=function(a){var b=a.bounding;if(!b)throw"error in mesh decompressing data: bounding not found, cannot use the bounding decompression.";for(var c=BBox.getMin(b),b=BBox.getMax(b),d=vec3.sub(vec3.create(),b,c),e=a.format,g=1/255,n=1/65535,l=a.vertices,m=new Float32Array(l.length),b=0,p=l.length;b<p;b+=3)m[b]=l[b]*n*d[0]+c[0],m[b+
1]=l[b+1]*n*d[1]+c[1],m[b+2]=l[b+2]*n*d[2]+c[2];a.vertices=m;if(a.normals&&a.normals.constructor!=Float32Array){d=a.normals;c=new Float32Array(d.length);l=d.constructor==Uint8Array?g:n;b=0;for(p=d.length;b<p;b+=3)c[b]=d[b]*l*2-1,c[b+1]=d[b+1]*l*2-1,c[b+2]=d[b+2]*l*2-1,m=c.subarray(b,b+3),vec3.normalize(m,m);a.normals=c}if(a.coords&&e.uvs_bounding&&a.coords.constructor!=Float32Array){c=a.coords;e=e.uvs_bounding;d=[e[2]-e[0],e[3]-e[1]];l=new Float32Array(c.length);b=0;for(p=c.length;b<p;b+=2)l[b]=c[b]*
n*d[0]+e[0],l[b+1]=c[b+1]*n*d[1]+e[1];a.coords=l}if(a.weights&&a.weights.constructor!=Float32Array){e=a.weights;d=new Float32Array(e.length);g=e.constructor==Uint8Array?g:n;b=0;for(p=e.length;b<p;b+=4)d[b]=e[b]*g,d[b+1]=e[b+1]*g,d[b+2]=e[b+2]*g,d[b+3]=e[b+3]*g;a.weights=d}}})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
