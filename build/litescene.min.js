(function(Y){function Z(){this.code="function update(dt) {\n\n}";this.exported_callbacks=[];this.extracode="";this.extra_methods=null}function Ba(a){return Ba.get(a)}function fb(a){this.dependency_blocks=[];this.flag_id=-1;this.flag_mask=0;this.events=null;if(!a)throw"ShaderBlock must have a name";if(-1!=a.indexOf(" "))throw"ShaderBlock name cannot have spaces: "+a;this.name=a;this.code_map=new Map;this.context_macros=null}function fa(a){this.code=a;this.blocks=[];this.pragmas={};this.uniforms={};
this.attributes={};this.includes={};this.snippets={};this.shader_blocks={};this.is_dynamic=!1;a&&this.parse()}function x(a){this.uid=e.generateUId("MAT-");this._must_update=!0;this._index=-1;this._local_id=x.last_index++;this._last_frame_update=-1;this._color=new Float32Array([1,1,1,1]);this._queue=e.RenderQueue.DEFAULT;this._render_state=new e.RenderState;this._light_mode=e.Material.NO_LIGHTS;this.uvs_matrix=new Float32Array([1,0,0,0,1,0,0,0,1]);this.textures={};this.flags={cast_shadows:!0,receive_shadows:!0,
ignore_frustum:!1};Object.defineProperty(this,"color",{get:function(){return this._color.subarray(0,3)},set:function(a){vec3.copy(this._color,a)},enumerable:!0});Object.defineProperty(this,"opacity",{get:function(){return this._color[3]},set:function(a){this._color[3]=a},enumerable:!0});Object.defineProperty(this,"queue",{get:function(){return this._queue},set:function(a){!isNaN(a)&&isNumber(a)&&(this._queue=a)},enumerable:!0});Object.defineProperty(this,"render_state",{get:function(){return this._render_state},
set:function(a){if(a)for(var c in a)this._render_state[c]=a[c]},enumerable:!0});a&&this.configure(a)}function R(a){x.call(this,null);this._shader="";this._shader_version=-1;this._shader_flags=0;this._shader_code=null;this._uniforms={};this._samplers=[];this._properties=[];this._properties_by_name={};this._passes={};this._light_mode=0;this._primitive=-1;this._allows_instancing=!1;this._shader_version=this._version=-1;a&&this.configure(a)}function P(a){R.call(this,null);this.blend_mode=e.Blend.NORMAL;
this.createProperty("diffuse",new Float32Array([1,1,1]),"color");this.createProperty("ambient",new Float32Array([1,1,1]),"color");this.createProperty("emissive",new Float32Array([0,0,0,0]),"color");this._specular_data=vec4.fromValues(0.1,10,0,0);this.specular_on_alpha=this.specular_on_top=!1;this.reflection_factor=this.backlight_factor=0;this.reflection_fresnel=1;this.reflection_specular=!1;this.createProperty("velvet",new Float32Array([0.5,0.5,0.5]),"color");this.velvet_exp=0;this.velvet_additive=
!1;this._velvet_info=vec4.create();this._detail=new Float32Array([0,10,10]);this.normalmap_factor=1;this.normalmap_tangent=!0;this.bumpmap_factor=1;this.displacementmap_factor=0.1;this.use_scene_ambient=!0;this.createProperty("extra",new Float32Array([1,1,1,1]),"color");this.flags={alpha_test:!1,alpha_test_shadows:!1,two_sided:!1,flip_normals:!1,depth_test:!0,depth_write:!0,ignore_lights:!1,cast_shadows:!0,receive_shadows:!0,ignore_frustum:!1};this._uniforms={u_material_color:this._color,u_ambient_color:this._ambient,
u_emissive_color:this._emissive,u_specular:this._specular_data,u_reflection_info:vec2.create(),u_velvet_info:vec4.create(),u_normal_info:vec2.create(),u_detail_info:this._detail,u_texture_matrix:this.uvs_matrix,u_extra_color:this._extra};this._samplers=[];this.needsUpdate=this._allows_instancing=!0;a&&this.configure(a)}function qa(a){x.call(this,null);this.shader_name="surface";this.blend_mode=e.Blend.NORMAL;this._light_mode=1;this.flags={alpha_test:!1,alpha_test_shadows:!1,two_sided:!1,flip_normals:!1,
depth_test:!0,depth_write:!0,ignore_lights:!1,cast_shadows:!0,receive_shadows:!0,ignore_frustum:!1};this._code="void surf(in Input IN, inout SurfaceOutput o) {\n\to.Albedo = vec3(1.0) * IN.color.xyz;\n\to.Normal = IN.worldNormal;\n\to.Emission = vec3(0.0);\n\to.Specular = 1.0;\n\to.Gloss = 40.0;\n\to.Reflectivity = max(0.0, 0.5 - dot(IN.viewDir,o.Normal));\n\to.Alpha = IN.color.a;\n}\n";this._uniforms={};this._samplers=[];this._mustUpdate=!1;this.properties=[];a&&this.configure(a);this.computeCode()}
function oa(a){R.call(this,null);this.blend_mode=e.Blend.NORMAL;this._shader=this._filename="";this._shader_version=-1;this._shader_flags=0;this._uniforms={};this._samplers=[];this._properties=[];this._properties_by_name={};this._passes={};this._light_mode=x.ONE_LIGHT;this._primitive=-1;this._allows_instancing=!1;this._shader_version=this._version=-1;this._loading=!1;a&&this.configure(a)}function wa(){this._components=[];this._missing_components=null}function ma(){}function Ha(a){a&&this.configure(a)}
function Ca(){this._data=this.remotepath=this.fullpath=this.filename=null}function $(a){this.name="";this.takes={};a&&this.configure(a)}function pa(a){this.name=null;this.tracks=[];this.duration=e.Animation.DEFAULT_DURATION;a&&this.configure(a)}function Q(a){this.enabled=!0;this.name="";this._type_index=this._type=null;this.interpolation=e.NONE;this.packed_data=this.looped=!1;this.value_size=0;this.data_table=this.data=null;Object.defineProperty(this,"_property",{value:"",enumerable:!1,writable:!0});
Object.defineProperty(this,"_property_path",{value:[],enumerable:!1,writable:!0});a&&this.configure(a)}function ka(a){this.resource_names=[];this.metadata=null;this._data={};this._resources_data={};a&&this.configure(a)}function na(a,b){this.filename=b||null;this.fullpath=b||null;this.resource_names=[];this.prefab_data=this.prefab_json=null;this._resources_data={};a&&this.configure(a)}function ba(a){this._code=null;this._functions={};this._global_uniforms={};this._code_parts={};this._subfiles={};this._compiled_shaders=
{};this._shaderblock_flags_num=0;this._shaderblock_flags={};this._version=0;a&&(this.code=a)}function ua(a){this._data={object_class:"GraphCode"};this._modified=!1;this._graph=new LiteGraph.LGraph;this._graph._graphcode=this;this.extra={type:ua.LOGIC_GRAPH};this._version=0;a&&this.setData(a,!0)}function Da(){this.points=[];this.closed=!1;this.type=Da.LINE}function X(a){this.apply_fxaa=!1;this.filter=!0;this.fx=[];this._uniforms={u_aspect:1,u_viewport:vec2.create(),u_iviewport:vec2.create(),u_texture:0,
u_depth_texture:1,u_random:vec2.create()};this._passes=null;this._must_update_passes=!0;a&&this.configure(a)}function nb(){this.active_entries=[]}function ib(){this.time=0;this.weight=1;this._take_name=this._animation_name=this._animation_take=null;this._last_time=0;this._must_update=!1}function gb(){this.size=1E5;this.root=[];this.objects_cell_by_id=new WeakMap}function Na(a){this.renderer_name=null;this.default_shadowmap_resolution=e.RenderSettings.default_shadowmap_resolution;this.keep_viewport=
this.ignore_clear=this.ignore_viewports=!1;this.update_shadowmaps=this.shadows_enabled=!0;this.lights_disabled=this.force_wireframe=this.update_all_shadowmaps=!1;this.quality=Na.AUTO_QUALITY;this.render_helpers=this.render_gui=this.render_fx=this.render_all_cameras=!0;this.layers=255;this.z_pass=!1;this.in_player=this.frustum_culling=!0;a&&this.configure(a)}function D(a){this._data=new Uint32Array(25);this.init();a&&this.configure(a)}function $a(){this.shader=null;this.uniforms_containers=[];this.index_buffer=
this.vertex_buffers=null;this.primitive=this.offset_range=this.offset_start=-1;this.renderState=null}function da(a,b){this.uid=e.generateUId("RINS");this.layers=3;this.version=this.index=-1;this.vertex_buffers={};this.wireframe_index_buffer=this.index_buffer=null;this.range=new Int32Array([0,-1]);this.primitive=GL.TRIANGLES;this.collision_mesh=this.mesh=this.transform=null;this.node=a;this.component=b;this.priority=10;this.sort_mode=da.NO_SORT;this.matrix=mat4.create();this.normal_matrix=mat4.create();
this.center=vec3.create();this.oobb=BBox.create();this.aabb=BBox.create();this.material=null;this.use_bounding=!0;this.uniforms={};this.samplers=[];this.instanced_models=[];this.shader_block_flags=0;this.shader_blocks=[];this.picking_node=null;this._camera_visibility=0;this._is_visible=!1;this._dist=0}function I(a){this.height=this.width=0;this.precision=I.DEFAULT_PRECISION;this.filter_texture=!0;this.format=GL.RGB;this.use_depth_texture=!0;this.use_stencil_buffer=!1;this.num_extra_textures=0;this.name=
null;this.clone_after_unbind=this.adjust_aspect=this.generate_mipmaps=!1;this._depth_texture=this._color_texture=this._fbo=null;this._textures=[];this._cloned_textures=null;this._version=1;this._minFilter=gl.NEAREST;a&&this.configure(a)}function va(a){this.sort_mode=a||e.RenderQueue.NO_SORT;this.instances=[]}function Qa(){this.debug_points=[];this._points=[];this._points_color=[];this._points_nodepth=[];this._points_color_nodepth=[];this._lines=[];this._lines_color=[];this._names=[];this.grid_texture_url=
"imgs/grid.png";this.camera2D=new e.Camera({eye:[0,0,0],center:[0,0,-1]});this.createMeshes();this.colors={selected:vec4.fromValues(1,1,1,1),node:vec4.fromValues(1,0.5,0,1),bone:vec4.fromValues(1,0,0.5,1)};this.settings={render_grid:!0,grid_scale:1,grid_alpha:0.5,grid_plane:"xz",render_names:!1,render_skeletons:!0,render_tree:!1,render_components:!0,render_null_nodes:!0,render_axis:!1,render_colliders:!0,render_paths:!0,render_origin:!0,render_colliders_aabb:!1};this._in_scene=!1}function Hb(){this.shader_block=
null;this.macros={};this.uniforms={}}function Ib(a,b,c,d,f,e){this.position=vec3.create();c&&this.position.set(c);this.node=a||null;this.instance=b||null;this.distance=d||0;this.normal=f;this.hit=e}function Pa(a,b){this.uid=e.generateUId("PHSX");this.layers=3;this.type=Pa.BOX;this.mesh=null;this.node=a;this.component=b;this.matrix=mat4.create();this.center=vec3.create();this.oobb=BBox.create();this.aabb=BBox.create()}function z(a){this._data=new Float32Array(10);this._position=this._data.subarray(0,
3);this._rotation=this._data.subarray(3,7);quat.identity(this._rotation);this._scaling=this._data.subarray(7,10);this._scaling[0]=this._scaling[1]=this._scaling[2]=1;this._local_matrix=mat4.create();this._global_matrix=mat4.create();this._parent=this._root=this._uid=null;this._must_update=!1;this._version=0;a&&this.configure(a)}function y(a){this.enabled=!0;this.layers=3;this.clear_depth=this.clear_color=!0;this._type=y.PERSPECTIVE;this._eye=vec3.clone(y.DEFAULT_EYE);this._center=vec3.clone(y.DEFAULT_CENTER);
this._up=vec3.clone(y.DEFAULT_UP);this._global_eye=vec3.clone(this._eye);this._global_center=vec3.clone(this._center);this._global_up=vec3.clone(this._up);this._global_front=vec3.create();vec3.sub(this._global_front,this._global_center,this._global_eye);vec3.normalize(this._global_front,this._global_front);this._near=0.1;this._far=1E3;this._ortho=new Float32Array([-1,1,-1,1]);this._aspect=1;this._fov=45;this._frustum_size=50;this._final_aspect=1;this._viewport=new Float32Array([0,0,1,1]);this._viewport_in_pixels=
vec4.create();this._background_color=vec4.fromValues(0,0,0,1);this._use_custom_projection_matrix=!1;this.overwrite_material=null;this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._model_matrix=mat4.create();this._previous_viewprojection_matrix=mat4.create();this._must_update_projection_matrix=this._must_update_view_matrix=!0;this._rendering_index=-1;this._frame=null;this.show_frame=!0;a&&this.configure(a);this._uniforms={u_view:this._view_matrix,
u_viewprojection:this._viewprojection_matrix,u_camera_eye:this._global_eye,u_camera_front:this._global_front,u_camera_planes:vec2.fromValues(this.near,this.far),u_camera_perspective:vec3.create(),u_background_color:this._background_color,u_previous_viewprojection:this._previous_viewprojection_matrix};this.updateMatrices();this._frustum_planes=geo.extractPlanes(this._viewprojection_matrix)}function sa(a){this.enabled=!0;this.fx=new e.FXStack(a?a.fx:null);this.frame=new e.RenderFrameContext;this.frame.use_depth_texture=
!0;this.use_antialiasing=!1;this.shader_material=null;a&&this.configure(a)}function Ea(a){this.enabled=!0;this.fx=new e.FXStack(a?a.fx:null);this.frame=new e.RenderFrameContext;this.frame.use_depth_texture=!0;this.use_antialiasing=!1;this.shader_material=null;a&&this.configure(a)}function u(a){this._position=vec3.create();this._target=vec3.fromValues(0,0,1);this._up=vec3.fromValues(0,1,0);this.enabled=!0;this.layers=255;this.near=1;this.far=500;this.angle=45;this.angle_end=60;this.constant_diffuse=
!1;this.use_specular=!0;this.att_start=0;this.att_end=1E3;this.attenuation_type=u.RANGE_ATTENUATION;this.offset=0;this._spot_cone=!0;this.projective_texture=null;this._attenuation_info=new Float32Array([this.att_start,this.att_end,this.attenuation_type,0]);this.use_target=!1;this._color=vec3.fromValues(1,1,1);this.intensity=1;this._type=u.OMNI;this.frustum_size=50;this.cast_shadows=!1;this.shadow_bias=0.05;this.shadowmap_resolution=0;this.shadow_type="hard";this.force_light_matrix=!1;this._light_matrix=
mat4.create();this.extra_texture=null;this._front=vec3.clone(e.FRONT);this._right=vec3.clone(e.RIGHT);this._top=vec3.clone(e.TOP);this._samplers=[];this._uniforms={u_light_info:vec4.fromValues(this._type,this._spot_cone?1:0,0,0),u_light_front:this._front,u_light_angle:vec4.fromValues(this.angle*DEG2RAD,this.angle_end*DEG2RAD,Math.cos(this.angle*DEG2RAD*0.5),Math.cos(this.angle_end*DEG2RAD*0.5)),u_light_position:this._position,u_light_color:vec3.create(),u_light_att:this._attenuation_info,u_light_offset:this.offset,
u_light_extra:vec4.create(),u_light_matrix:this._light_matrix};a&&(this.configure(a),void 0!==a.shadowmap_resolution&&(this.shadowmap_resolution=parseInt(a.shadowmap_resolution)));Y.gl&&!gl.extensions.WEBGL_depth_texture&&(u.use_shadowmap_depth_texture=!1)}function U(a){this._enabled=!0;this._lod_mesh=this._mesh=null;this._submesh_id=-1;this._material=null;this._primitive=-1;this._must_update_static=!0;this._transform_version=-1;this.use_submaterials=!1;this.submaterials=[];a&&this.configure(a);this._RI=
new e.RenderInstance(null,this);this._is_attached=!1}function V(a){this.apply_skinning=this.enabled=!0;this.cpu_skinning=!1;this.lod_mesh=this.mesh=null;this.submesh_id=-1;this.material=null;this._primitive=-1;this.point_size=0.1;this.two_sided=!1;this.ignore_transform=!0;!V.num_supported_uniforms&&Y.gl&&(V.num_supported_uniforms=gl.getParameter(gl.MAX_VERTEX_UNIFORM_VECTORS),V.num_supported_textures=gl.getParameter(gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),V.num_supported_uniforms<3*V.MAX_BONES&&0==V.num_supported_textures&&
(V.gpu_skinning_supported=!1));a&&this.configure(a);U._identity||(U._identity=mat4.create())}function H(a){this.enabled=!0;this.mode=H.AUTOMATIC;this.morph_targets=[];Y.gl&&(void 0===H.max_supported_vertex_attribs&&(H.max_supported_vertex_attribs=gl.getParameter(gl.MAX_VERTEX_ATTRIBS)),void 0===H.max_supported_morph_targets_using_streams&&(H.max_supported_morph_targets_using_streams=(gl.getParameter(gl.MAX_VERTEX_ATTRIBS)-6)/2));a&&this.configure(a)}function L(a){this.search_bones_in_parent=this.enabled=
!0;this.skeleton_root_node=null;this.cpu_skinning=!1;this.ignore_transform=!0;this._last_bones=this._mesh=null;this._ris_skinned=[];!L._initialized&&Y.gl&&(L.num_supported_uniforms=gl.getParameter(gl.MAX_VERTEX_UNIFORM_VECTORS),L.num_supported_textures=gl.getParameter(gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),L.num_supported_uniforms<3*L.MAX_BONES&&0==L.num_supported_textures&&(L.gpu_skinning_supported=!1),L._initialized=!0);a&&this.configure(a)}function Ra(a){this.enabled=!0;this.svg=null;a&&this.configure(a);
this._RI=new e.RenderInstance(null,this);this._svg_data=this._mesh=null}function xa(a){this.enabled=!0;this.material=this.texture=null;this._intensity=1;this.use_environment=!0;this._bake_to_cubemap=this.gamma=!1;a&&this.configure(a)}function Ua(a){this.enabled=!0;this.texture=null;this.createProperty("color",vec3.fromValues(1,1,1),"color");this.opacity=1;this.blend_mode=Wa.NORMAL;this.material_name=null;a&&this.configure(a)}function ya(a){this.enabled=!0;this.shape=1;this.mesh=null;this.size=vec3.fromValues(0.5,
0.5,0.5);this.center=vec3.create();this.use_mesh_bounding=!1;a&&this.configure(a)}function La(a){this._properties=[];this._properties_by_name={};a&&this.configure(a)}function Ia(a){this.enabled=!0;this.texture=null;this.blend_mode=e.Blend.ALPHA;this._size=vec2.fromValues(100,100);this.frame=null;this.flip_x=!1;this.filtering=!0;this._area=vec4.fromValues(0,0,1,1);this._atlas_component=this._atlas=null;a&&this.configure(a)}function za(a){this.enabled=!0;this.texture=null;this.areas=[];this._sprites=
[];this._max_sprites=256;a&&this.configure(a)}function B(a){this.include_lights=this.include_cameras=this.include_instances=this.enabled=!0;this._frame_fx_binded=this._frame_fx=!1;this.send_events=!0;this._scene_path=null;this._scene_is_ready=!1;e.Scene&&(this._scene=new e.Scene,this._scene.root.removeAllComponents(),LEvent.bind(this._scene,"requestFrame",function(){this._root.scene&&this._root.scene.requestFrame()},this));a&&this.configure(a)}function Fa(a){this.text="";this.notes=[];this._screen_pos=
vec3.create();this._selected=null;this.configure(a)}function ob(a){this.enabled=!0;this.speed=10;this.axis=[0,1,0];this.local_space=!0;this.swing=!1;this.swing_amplitude=45;a&&this.configure(a)}function A(a){this.enabled=!0;this.no_button_action=A.NONE;this.left_button_action=A.ORBIT;this.middle_button_action=this.right_button_action=A.PAN;this.mouse_wheel_action=A.CHANGE_DISTANCE;this.lock_mouse=this.keyboard_walk=!1;this.rot_speed=1;this.walk_speed=10;this.wheel_speed=1;this.smooth=!1;this._moving=
vec3.fromValues(0,0,0);this._collision_none=vec3.create();this._collision_left=vec3.create();this._collision_middle=vec3.create();this._collision_right=vec3.create();this._dragging=!1;this._camera=null;this.configure(a)}function jb(a){this.rot_speed=[1,1];this.smooth=!1;a&&this.configure(a)}function J(a){this.enabled=!0;this.node_id=null;this.cylindrical=this.face_camera=!1;this.front=J.NEGZ;this.up=J.POSY;this._global_position=vec3.create();this._target_position=vec3.create();a&&this.configure(a)}
function Ja(a){this.enabled=!0;this.start=100;this.end=1E3;this.density=0.001;this.type=Ja.LINEAR;this.color=vec3.fromValues(0.5,0.5,0.5);this._uniforms={u_fog_info:vec3.create(),u_fog_color:this.color};a&&this.configure(a)}function pb(a){this.node_uid="";this.follow_camera=this.fixed_y=!1;a&&this.configure(a)}function F(a){this.enabled=!0;this._subdivisions=this._size=10;this._geometry=F.CUBE;this._custom_mesh=null;this._primitive=-1;this._point_size=0.1;this._version=1;this._mesh=null;this._mesh_version=
0;a&&this.configure(a)}function Ma(a){this.createProperty("ambient_color",Ma.DEFAULT_AMBIENT_COLOR,"color");this._render_settings=null;this._textures={};a&&this.configure(a)}function la(a){this.enabled=!0;this.force_redraw=this.from_file=!1;this._graph_properties=this._graphcode=this._filename=null;this.on_event="update";if("undefined"==typeof LiteGraph)return console.error("Cannot use GraphComponent if LiteGraph is not installed");this._graph_version=-1;this._graph=new LGraph;this._graph.getScene=
function(){return this._scene||e.GlobalScene};this._graph._scenenode=null;this._loading=!1;a?this.configure(a):this.from_file||(a=this._default_node=LiteGraph.createNode("scene/node"),this._graph.add(a));LEvent.bind(this,"trigger",this.trigger,this)}function ia(a){this.enabled=!0;this.frame=new e.RenderFrameContext;this.use_node_camera=this.use_antialiasing=!1;if("undefined"==typeof LGraphTexture)return console.error("Cannot use FXGraphComponent if LiteGraph is not installed");this._graph=new LGraph;
this._graph.getScene=function(){return this._scene};a?this.configure(a):(this._graph_frame_node=LiteGraph.createNode("scene/frame","Rendered Frame"),this._graph_frame_node.ignore_remove=!0,this._graph_frame_node.ignore_rename=!0,this._graph.add(this._graph_frame_node),this._graph_viewport_node=LiteGraph.createNode("texture/toviewport","Viewport"),this._graph_viewport_node.pos[0]=500,this._graph_viewport_node.properties.disable_alpha=!0,this._graph.add(this._graph_viewport_node),this._graph_frame_node.connect(0,
this._graph_viewport_node));null==ia.high_precision_format&&Y.gl&&(ia.high_precision_format=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.float_ext?gl.FLOAT:gl.UNSIGNED_BYTE)}function tb(){this.id=0;this._pos=vec3.fromValues(0,0,0);this._vel=vec3.fromValues(0,0,0);this.life=1;this.angle=0;this.size=1;this.rot=0}function W(a){this.enabled=!0;this.max_particles=1024;this.warm_up_time=0;this.point_particles=!1;this.emissor_type=W.BOX_EMISSOR;this.emissor_rate=5;this.emissor_size=vec3.fromValues(10,10,10);this.emissor_mesh=
null;this.particle_life=5;this.particle_speed=10;this.particle_size=5;this.particle_rotation=0;this.particle_size_curve=[[1,1]];this._particle_start_color=vec3.fromValues(1,1,1);this._particle_end_color=vec3.fromValues(1,1,1);this.particle_opacity_curve=[[0.5,1]];this.texture_grid_size=1;this.physics_gravity=[0,0,0];this.physics_friction=0;this.opacity=1;this.additive_blending=!1;this.texture=null;this.animation_fps=1;this.premultiplied_alpha=this.independent_color=this.loop_animation=this.animated_texture=
this.use_node_material=this.soft_particles=!1;this.align_with_camera=!0;this.follow_emitter=this.align_always=!1;this.sort_in_z=!0;this.ignore_lights=this.stop_update=!1;this.onUpdateParticle=this.onCreateParticle=null;a&&this.configure(a);"number"==typeof this.emissor_size&&(this.emissor_size=[this.emissor_size,this.emissor_size,this.emissor_size]);this._emissor_pos=vec3.create();this._particles=[];this._visible_particles=this._remining_dt=0;this._min_particle_size=0.001;this._last_id=0;Y.gl&&this.createMesh()}
function ab(a){this.className=this.text="";this.use_html=!1;this._world_pos=vec3.create();this._screen_pos=vec3.create();this.configure(a)}function ca(a){this.enabled=!0;this.max_points=1024;this.mesh=null;this._points=[];this.texture_grid_size=this.size=1;this.texture=null;this.global_opacity=1;this.color=vec3.fromValues(1,1,1);this.sort_in_z=this.in_world_coordinates=this.premultiplied_alpha=this.use_node_material=this.additive_blending=!1;this.serialize_points=!0;a&&this.configure(a);this._last_id=
0;Y.gl&&this.createMesh()}function Aa(a){this.enabled=!0;this.max_lines=1024;this._lines=[];this.global_opacity=1;this.color=vec3.fromValues(1,1,1);this.in_world_coordinates=this.use_node_material=!1;a&&this.configure(a);this._last_id=0;Y.gl&&this.createMesh()}function N(a){this.enabled=!0;this._animation="";this._take="default";this.root_node="@";this.playback_speed=1;this.mode=N.LOOP;this.playing=!0;this.blend_time=this.current_time=0;this.onApplySample=this.onPreApply=this.range=null;this._last_time=
0;this._use_blend_animation=!1;this._blend_take=this._blend_animation=null;this._blend_remaining_time=this._blend_current_time=0;this._blend_updated_frame=-1;this.disabled_tracks={};a&&this.configure(a)}function bb(a){this.enabled=!0;this.texture_size=512;this.clip_offset=0.5;this.texture_name="";this.all_cameras=this.use_cubemap=!1;this.blur=0;this.use_mesh_info=this.generate_mipmaps=!1;this.offset=vec3.create();this.ignore_this_mesh=!0;this.high_precision=!1;this.refresh_rate=1;this.layers=255;
this._textures={};a&&this.configure(a)}function aa(a){this._enabled=!0;this.texture_size=512;this.high_precision=!1;this.texture_name="";this.generate_irradiance=!0;this.generate_mipmaps=!1;this.refresh_rate=1;this.layers=255;this.near=0.1;this.far=1E3;this.background_color=vec4.create();this._position=vec3.create();this._current=vec3.create();this._version=-1;this._irradiance_texture=this._texture=null;this._texid=":probe_"+aa.last_id;aa.last_id++;a&&this.configure(a)}function ea(a){this.enabled=
!0;this.corner=vec3.create();this.size=vec3.fromValues(10,10,10);this.subdivisions=new Uint8Array([4,4,4]);this.layers=255;this.high_precision=!1;this.near=0.1;this.far=1E3;this.background_color=vec4.create();this.mode=ea.VERTEX_MODE;this._irradiance_texture=null;this._irradiance_cubemaps=[];a&&this.configure(a)}function w(a){this.enabled=!0;this.code=this.constructor.templates.script;this._blocked_functions=new Set;this._name="";this._script=new Z;this._script.extra_methods={getComponent:function(a,
c){return arguments.length?this._root?this._root.getComponent(a,c):null:this}.bind(this),getLocator:function(){return this.getComponent().getLocator()+"/context"},createProperty:e.BaseComponent.prototype.createProperty,createAction:e.BaseComponent.prototype.createAction,bind:e.BaseComponent.prototype.bind,unbind:e.BaseComponent.prototype.unbind,trigger:function(a,c){return LEvent.trigger(this,a,c)}.bind(this),unbindAll:e.BaseComponent.prototype.unbindAll};this._script.onerror=this.onError.bind(this);
this._script.exported_functions=[];this._breakpoints=this._last_error=null;a&&this.configure(a)}function ra(a){this.enabled=!0;this._name=this._filename="";this._script=new Z;this._blocked_functions=new Set;this._script.extra_methods={getComponent:function(){return this}.bind(this),getLocator:function(){return this.getComponent().getLocator()+"/context"},createProperty:e.BaseComponent.prototype.createProperty,createAction:e.BaseComponent.prototype.createAction,bind:e.BaseComponent.prototype.bind,
unbind:e.BaseComponent.prototype.unbind,unbindAll:e.BaseComponent.prototype.unbindAll};this._script.onerror=this.onError.bind(this);this._script.exported_functions=[];this._last_error=null;a&&this.configure(a)}function Ga(a){this.height=2;this.size=10;this.subdivisions=100;this.heightmap="";this._primitive=-1;this.auto_update=!0;this.action="Update";this._mesh=null;a&&this.configure(a)}function T(a){this.enabled=!0;this.mode=T.GRID_MODE;this.createProperty("count",vec3.fromValues(10,1,1));this.createProperty("size",
vec3.fromValues(100,100,100));this.material=this.lod_mesh=this.mesh=null;this._custom_matrices=[];a&&this.configure(a);T._identity||(T._identity=mat4.create())}function Va(a){this.enabled=!0;this.eye_distance=1;a&&this.configure(a)}function Sa(a){this.only_internal_nodes=this.enabled=!0;this.base_nodes=[];this.poses={};a&&this.configure(a)}function cb(a){this.enabled=!0;this._render_in_viewport=!1;this.path=new e.Path;this._type=e.Path.LINE;this._must_update=!1;a&&this.configure(a);this._max_points=
1024;this._range=0}function Ka(a){this.autoclear=this.enabled=!0;this._code=Ka.default_code;Y.gl&&("undefined"==typeof THREE?this.loadLibrary(function(){this.setupContext()}):this.setupContext());this._script=new Z;this._script.catch_exceptions=!1;a&&this.configure(a)}function ga(a){this.enabled=!0;this.mode=1;this.height=this.width=512;this.texture_name=":canvas3D";this.input_active=this.visible=!0;this.generate_mipmaps=this.use_node_material=!1;this._skip_backside=this._clear_buffer=!0;this._standard_material=
this._RI=this._fbo=this._texture=null;this._mouse=vec3.create();this._is_mouse_inside=!1;this._local_mouse={mousex:0,mousey:0};this._local_mouse_click={mousex:0,mousey:0};a&&this.configure(a)}function S(a){this._enabled=!0;this._video=document.createElement("video");this._video.muted=!1;this._video.autoplay=!1;this.bindVideoEvents(this._video);this._autoplay=!0;this.generate_mipmaps=!1;this._src="";this._url_loading=null;this.texture_name=":video";this.render_mode=!0;this._playback_rate=1;this._ignore_proxy=
!1;this._texture=null;a&&this.configure(a)}function ta(a){this.enabled=!0;this.mode=ta.PICKING;this.layers=3;this._last_collision=null;a&&this.configure(a)}function E(){this.uid=e.generateUId("TREE-");this._root=new e.SceneNode("root");this._root.removeAllComponents();this._root._is_root=!0;this._root._in_tree=this;this._nodes=[this._root];this._nodes_by_name={root:this._root};this._nodes_by_uid={};this._nodes_by_uid[this._root.uid]=this._root;this._components_by_uid={};this._instances=[];this._lights=
[];this._cameras=[];this._colliders=[];this.external_repository=null;this._spatial_container=new e.SpatialContainer;this.external_scripts=[];this.global_scripts=[];this.preloaded_resources={};this.animation=null;this._paths=[];this._local_resources={};this.texture_atlas=null;this.layer_names=["main","secondary"];LEvent.bind(this,"treeItemAdded",this.onNodeAdded,this);LEvent.bind(this,"treeItemRemoved",this.onNodeRemoved,this);this._shaderblock_info=null;this.init()}function M(a){a&&a.constructor!==
String&&(a=null,console.warn("SceneNode constructor first parameter must be a String with the name"));this._name=a||"node_"+(1E4*Math.random()).toFixed(0);this._uid=e.generateUId("NODE-");this._classList={};this.layers=3;this._material=this._prefab=this.node_type=null;this._components=[];this._in_tree=this._children=this._parentNode=this._missing_components=null;this._instances=[];this.flags={visible:!0,is_static:!1,selectable:!0,locked:!1};this.init(!1,!0)}function ja(a){this.options=a=a||{};if(!a.canvas){var b=
a.container;a.container_id&&(b=document.getElementById(a.container_id));b||(console.log("No container specified in LS.Player, using BODY as container"),b=document.body);var c=document.createElement("canvas");c.width=b.offsetWidth;c.height=b.offsetHeight;c.width||(c.width=a.width||1);c.height||(c.height=a.height||1);b.appendChild(c);a.canvas=c}this.debug=!1;this.gl=GL.create(a);this.canvas=this.gl.canvas;this.render_settings=new e.RenderSettings;this.scene=e.GlobalScene;this._file_drop_enabled=!1;
e.Shaders.init();e.Renderer.init();this.state=e.Player.STOPPED;if(this.gl.ondraw)throw"There is already a litegl attached to this context";this.configure(a);this.gl.ondraw=e.Player.prototype._ondraw.bind(this);this.gl.onupdate=e.Player.prototype._onupdate.bind(this);b=e.Player.prototype._onmouse.bind(this);this.gl.onmousedown=b;this.gl.onmousemove=b;this.gl.onmouseup=b;this.gl.onmousewheel=b;b=e.Player.prototype._onkey.bind(this);this.gl.onkeydown=b;this.gl.onkeyup=b;b=e.Player.prototype._ontouch.bind(this);
this.gl.ontouch=b;b=e.Player.prototype._ongamepad.bind(this);this.gl.ongamepadconnected=b;this.gl.ongamepaddisconnected=b;this.gl.ongamepadButtonDown=b;this.gl.ongamepadButtonUp=b;gl.captureMouse(!0);gl.captureKeys(!0);gl.captureTouch(!0);gl.captureGamepads(!0);e.Input&&e.Input.init();!1!==a.enableFileDrop&&this.setFileDrop(!0);gl.animate()}(function(a){function b(){}b.classes={};b.HEADER_SIZE=64;b.FOUR_CC="WBIN";b.VERSION=0.3;b.CLASSNAME_SIZE=32;b.LUMPNAME_SIZE=54;b.LUMPHEADER_SIZE=10+b.LUMPNAME_SIZE;
b.CODES={ArrayBuffer:"AB",Int8Array:"I1",Uint8Array:"i1",Int16Array:"I2",Uint16Array:"i2",Int32Array:"I4",Uint32Array:"i4",Float32Array:"F4",Float64Array:"F8",Object:"OB",WideObject:"WO",String:"ST",WideString:"WS",Number:"NU","null":"00"};b.REVERSE_CODES={};for(var c in b.CODES)b.REVERSE_CODES[b.CODES[c]]=c;b.FULL_BINARY=1;b.isWBin=function(a){a=a.subarray(0,4);for(var c=0;c<a.length;c++)if(0!=a[c]&&a[c]!=b.FOUR_CC.charCodeAt(c))return!1;return!0};b.create=function(a,c){if(!a)throw"WBin null origin passed";
var e=new Uint8Array([0,0]),g=new Uint8Array((new Float32Array([b.VERSION])).buffer);c=c||"";if(a.toBinary){var k=a.toBinary();if(!k)return null;if(k.constructor==ArrayBuffer){e[0]|=b.FULL_BINARY;var m=b.getObjectClassName(a),l=new Uint8Array(b.HEADER_SIZE+k.length);l.set(b.stringToUint8Array(b.FOUR_CC));l.set(g,4);l.set(e,8);l.set(b.stringToUint8Array(m,b.CLASSNAME_SIZE),14);l.set(k,b.HEADER_SIZE);return l}a=k}var n=b.HEADER_SIZE,k=[],p=0,q;for(q in a)if(l=a[q],null!=l){if(l.constructor===Blob||
l.constructor===File)throw"Wbin does not allow Blobs or Files as data to store, conver to ArrayBuffer";m=b.getObjectClassName(l);(m=b.CODES[m])||(m="OB");"NU"==m?l=new Float64Array([l]):"OB"==m&&(l=JSON.stringify(l));var r=0;l&&l.constructor==String&&(l=b.stringToTypedArray(l),l.constructor===Uint16Array&&(m="OB"==m?"WO":"WS"));if(l.buffer&&l.buffer.constructor==ArrayBuffer)l=new Uint8Array(new Uint8Array(l.buffer,l.byteOffset,l.byteLength)),r=l.byteLength;else if(l.constructor==ArrayBuffer)r=l.byteLength;
else throw"WBin: cannot be anything different to ArrayBuffer";var s=q.substring(0,b.LUMPNAME_SIZE);s.length<q.length&&console.error("Lump name is too long (max is "+b.LUMPNAME_SIZE+"), it has been cut down, this could lead to an error in the future");k.push({code:m,name:s,data:l,start:p,size:r});p+=r;n+=b.LUMPHEADER_SIZE+r}l=new Uint8Array(n);l.set(b.stringToUint8Array(b.FOUR_CC));l.set(g,4);l.set(e,8);l.set(new Uint8Array((new Uint16Array([k.length])).buffer),10);c&&l.set(b.stringToUint8Array(c,
b.CLASSNAME_SIZE),12);var e=b.HEADER_SIZE+k.length*b.LUMPHEADER_SIZE,g=b.HEADER_SIZE,t;for(t in k)q=k[t],n=new Uint8Array(b.LUMPHEADER_SIZE),n.set(new Uint8Array((new Uint32Array([q.start])).buffer),0),n.set(new Uint8Array((new Uint32Array([q.size])).buffer),4),n.set(b.stringToUint8Array(q.code,2),8),n.set(b.stringToUint8Array(q.name,b.LUMPNAME_SIZE),10),l.set(n,g),g+=b.LUMPHEADER_SIZE,n=new Uint8Array(q.data),l.set(n,e+q.start);return l};b.load=function(a,c,e){if(!a||a.constructor!==Uint8Array&&
a.constructor!==ArrayBuffer)throw"WBin data must be ArrayBuffer or Uint8Array";a=new Uint8Array(a);var g=b.getHeaderInfo(a);if(!g)return console.error("Wrong WBin Header"),null;g.version>(new Float32Array([b.VERSION]))[0]&&console.log("ALERT: WBin version is higher that code version");a=null;for(var k in g.lumps){a||(a={});var m=g.lumps[k],l=g.lump_data.subarray(m.start,m.start+m.size);if(m.size!=l.length)throw"WBin: incorrect wbin lump size";var n=null,p=b.REVERSE_CODES[m.code];if(!p)throw"WBin: Incorrect data code";
switch(p){case "null":break;case "WideString":l=new Uint16Array((new Uint8Array(l)).buffer);case "String":n=b.TypedArrayToString(l);break;case "Number":n=0.3>g.version?parseFloat(b.TypedArrayToString(l)):(new Float64Array(l.buffer))[0];break;case "WideObject":l=new Uint16Array((new Uint8Array(l)).buffer);case "Object":(l=b.TypedArrayToString(l))?n=JSON.parse(l):console.warn('WBIN: lump "'+m.name+'" string is empty, skipping.');break;case "ArrayBuffer":n=(new Uint8Array(l)).buffer;break;default:l=
new Uint8Array(l);n=b.classes[p]||window[p];if(!n)throw"WBin referenced class not found: "+p;if(0!=l.length/n.BYTES_PER_ELEMENT%1)throw"WBin: size do not match type";n=new n(l.buffer)}a[m.name]=n}if(!c&&g.classname){if((n=b.classes[g.classname]||window[g.classname])&&n.fromBinary)return n.fromBinary(a,e);if(n&&n.prototype.fromBinary)return c=new n,c.fromBinary(a,e),c;a["@classname"]=g.classname}return a};b.getHeaderInfo=function(a){for(var c=a.subarray(0,4),e=0;e<c.length;e++)if(0!=c[e]&&c[e]!=b.FOUR_CC.charCodeAt(e))return null;
for(var c=b.readFloat32(a,4),g=new Uint8Array(a.subarray(8,10)),k=b.readUint16(a,10),m=b.TypedArrayToString(a.subarray(12,12+b.CLASSNAME_SIZE)),l=[],e=0;e<k;++e){var n=b.HEADER_SIZE+e*b.LUMPHEADER_SIZE,n=a.subarray(n,n+b.LUMPHEADER_SIZE),p={};p.start=b.readUint32(n,0);p.size=b.readUint32(n,4);p.code=b.TypedArrayToString(n.subarray(8,10));p.name=b.TypedArrayToString(n.subarray(10));l.push(p)}a=a.subarray(b.HEADER_SIZE+k*b.LUMPHEADER_SIZE);return{version:c,flags:g,classname:m,numlumps:k,lumps:l,lump_data:a}};
b.getObjectClassName=function(a){if(a&&a.constructor&&a.constructor.toString&&(a=a.constructor.toString().match(/function\s*(\w+)/))&&2==a.length)return a[1]};b.stringToUint8Array=function(a,b){for(var c=new Uint8Array(b?b:a.length),e=!1,k=0;k<a.length;k++){var m=a.charCodeAt(k);255<m&&(e=!0);c[k]=m}e&&console.warn("WBin: there are characters in the string that cannot be encoded in 1 byte.");return c};b.TypedArrayToString=function(a,b){for(var c="",e=0;e<a.length;e++)if(0!=a[e]||b)c+=String.fromCharCode(a[e]);
else break;return c};b.stringToTypedArray=function(a,b){for(var c=new Uint8Array(b?b:a.length),e=!1,k=0;k<a.length;k++){var m=a.charCodeAt(k);255<m&&(e=!0);c[k]=m}if(!e)return c;c=new Uint16Array(b?b:a.length);for(k=0;k<a.length;k++)m=a.charCodeAt(k),c[k]=m;return c};b.readUint16=function(a,b){return(new DataView(a.buffer,a.byteOffset)).getUint16(b,!0)};b.readUint32=function(a,b){return(new DataView(a.buffer,a.byteOffset)).getUint32(b,!0)};b.readFloat32=function(a,b){return(new DataView(a.buffer,
a.byteOffset)).getFloat32(b,!0)};a.WBin=b})("undefined"!=typeof Y?Y:this);Z.onerror=null;Z.eval=function(a,b){return eval("(function("+a+"){\n"+b+"\n})")};Z.catch_exceptions=!1;Z.show_errors_in_console=!0;Z.prototype.compile=function(a,b){var c=[],d=[];if(a)for(var f in a)c.push(f),d.push(a[f]);var c=c.join(","),e=this.code,e=Z.expandCode(e),g="";for(f in this.exported_callbacks)var k=this.exported_callbacks[f],g=g+("\tif(typeof("+k+") != 'undefined' && "+k+' != window["'+k+'"] ) this.'+k+" = "+k+
";\n");this._last_executed_code=e+=g;g=this._context;if(Z.catch_exceptions)try{this._class=new Function(c,e),l=Z.applyToConstructor(this._class,d,this.extra_methods),this._context=new l}catch(m){this._class||console.error("Parsing error in script\n"+m);this._context=this._class=null;Z.show_errors_in_console&&(c=Z.computeLineFromError(m),console.error("Error in script\n"+m),console.groupCollapsed?(console.groupCollapsed("Error line: "+c+" Watch code"),Z.showCodeInConsole(this._last_executed_code,c),
console.groupEnd()):console.error("Error line: "+c));if(this.onerror)this.onerror(m,this._last_executed_code);if(Z.onerror)Z.onerror(m,this._last_executed_code,this);return!1}else{this._class=new Function(c,e);var l=Z.applyToConstructor(this._class,d,this.extra_methods);this._context=new l}if(b&&g)for(f in g)void 0===this._context[f]||!g[f]||g[f].constructor===Function||this._context[f]&&this._context[f].constructor===Function||(this._context[f]=g[f]);return!0};Z.prototype.hasMethod=function(a){return this._context&&
this._context[a]&&"function"==typeof this._context[a]?!0:!1};Z.prototype.callMethod=function(a,b,c,d){if(this._context&&this._context[a]){if(!Z.catch_exceptions)return b&&b.constructor===Array&&c?this._context[a].apply(this._context,b):this._context[a].call(this._context,b);try{return b&&b.constructor===Array&&c?this._context[a].apply(this._context,b):this._context[a].call(this._context,b)}catch(f){if(b=Z.computeLineFromError(f),c="",d&&d.toInfoString&&(c=" from "+d.toInfoString()),console.error("Error from function "+
a+c+": ",f.toString()),console.groupCollapsed?(console.groupCollapsed("Error line: "+b+" Watch code"),Z.showCodeInConsole(this._last_executed_code,b),console.groupEnd()):console.error("Error line: "+b),this.onerror)this.onerror({error:f,msg:f.toString(),line:b,lscript:this,code:this._last_executed_code,method_name:a})}}};Z.applyToConstructor=function(a,b,c){b=[null].concat(b);if(c)for(var d in c)Object.defineProperty(a.prototype,d,{value:c[d],enumerable:!0});return a.bind.apply(a,b)};Z.showCodeInConsole=
function(a,b){if(a)for(var c=a.split("\n"),d=0;d<c.length;d++)d==b?console.log("%c "+d+". "+c[d],"background-color: #A33; color: #FAA;"):console.log("%c "+d+". ","display: inline-block; width: 40px; background-color:#999; color: white;",c[d])};Z.cleanCode=function(a){if(!a)return"";a=a.replace(/\*([^*]|[\r\n]|(\*+([^*/]|[\r\n])))*\*+/g,"");a=a.split("\n");for(var b=[],c=0;c<a.length;++c){var d=a[c],f=d.indexOf("//");-1!=f&&-1==d.substr(0,f).indexOf('"')&&(d=d.substr(0,f));d=d.trim();d.length&&b.push(d)}return b.join("\n")};
Z.expandCode=function(a){if(!a)return"";if(-1!=a.indexOf("'''")){var b=a.split("'''");a="";for(var c=0;c<b.length;c++)a=0==c%2?a+b[c]:a+('"'+b[c].split("\n").join("\\n\\\n")+'"')}for(var b=a.split("\n"),d=!1,c=0;c<b.length;++c){var f=b[c].trim(),h=f.indexOf(" "),h=f.substr(0,h);if("public"==h||"private"==h||"hidden"==h)if(h=f.indexOf("//"),-1!=h&&(f=f.substr(0,h)),h=f.lastIndexOf(";"),-1!=h&&(f=f.substr(0,h)),"var"==f.split(" ")[1]){var g=f,f=null,h="undefined",k=g.indexOf("=");-1!=k&&(h=g.substr(k+
1).trim(),g=g.substr(0,k).trim());k=g.indexOf(":");-1!=k&&(f=g.substr(k+1).trim(),g=g.substr(0,k).trim());g=g.split(" ");if(k=g[2]){d={};if(f){var m=f.indexOf("[]");-1!=m?(d.type=e.TYPES.ARRAY,d.data_type=f.substr(0,m),h&&"undefined"!==h||(h="[]")):d.type=f;if(e.Components[f])d.component_class=f,d.type=e.TYPES.COMPONENT,h||(h="null");else if(e.ResourceClasses[f])d.resource_classname=f,d.type=e.TYPES.RESOURCE,h||(h="null");else if("int"==f||"integer"==f)d.step=1,d.type=e.TYPES.NUMBER,h||(h=0)}if("private"==
g[0]||"hidden"==g[0])d.widget="null";b[c]="this.createProperty('"+k+"',"+h+", "+JSON.stringify(d)+" );";d=!0}}}d&&(a=b.join("\n"));return a};Z.computeLineFromError=function(a){if(void 0!==a.lineNumber)return a.lineNumber;if(a.stack){a=a.stack.split("\n")[1].trim();if(-1!=a.indexOf("(native)"))return-1;var b=a.split(" "),c=a.lastIndexOf(":"),d=a.lastIndexOf(":",c-1),d=parseInt(a.substr(d+1,c-d-1));parseInt(a.substr(c+1,a.length-2-c));if("Object.CodingModule.eval"==b[1])return-1;if(-1!=a.indexOf("LScript")||
-1!=a.indexOf("<anonymous>"))d-=3;return d}return-1};Y.LScript=Z;Uint8Array.prototype.toJSON||[Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array].forEach(function(a){a.prototype.toJSON=function(){return Array.prototype.slice.call(this)}});"undefined"===typeof GL&&console.error("LiteScene requires to include LiteGL first. More info: https://github.com/jagenjo/litegl.js");var e={ResourcesManager:null,Picking:null,Player:null,GUI:null,Network:null,Input:null,
Renderer:null,Physics:null,ShadersManager:null,Formats:null,Tween:null,Classes:{},ResourceClasses:{},ResourceClasses_by_extension:{},Globals:{},Components:{},MaterialClasses:{},_last_uid:1,_uid_prefix:"@",debug:!1,allow_static:!0,_gui_element:null,_gui_style:null,generateUId:function(a,b){b=b||"";var c=this._uid_prefix+(a||"")+(window.navigator.userAgent.hashCode()%16777216).toString(16)+"-",c=c+((GL.getTime()|0).toString(16)+"-"),c=c+(Math.floor(16777216*(1+Math.random())).toString(16)+"-"),c=c+
(this._last_uid++).toString(16);return c+b},validateName:function(a){return a.match(/^[a-z\s0-9-_.]+$/i)},valid_property_types:"String Number Boolean color vec2 vec3 vec4 quat mat3 mat4 Resource Animation Texture Prefab Mesh ShaderCode node component".split(" "),validatePropertyType:function(a){return-1==this.valid_property_types.indexOf(a)?(console.error(a+" is not a valid property value type."),!1):!0},_catch_exceptions:!1,registerComponent:function(a,b){var c=e.getClassName(a);if(b&&b.constructor!==
String)throw"old_classname must be null or a String";this.Components[c]=a;a.is_component=!0;a.resource_type="Component";!!a.prototype.onAddedToNode==!!a.prototype.onRemovedFromNode&&!!a.prototype.onAddedToScene==!!a.prototype.onRemovedFromScene||console.warn("%c Component "+c+" could have a bug, check events: "+c,"font-size: 2em");a.prototype.getResources&&!a.prototype.onResourceRenamed&&console.warn("%c Component "+c+" could have a bug, it uses resources but doesnt implement onResourceRenamed, this could lead to problems when resources are renamed.",
"font-size: 1.2em");a.actions||(a.actions={});e.extendClass(a,e.BaseComponent);Ha.addExtraMethods(a);e.debug&&((new a).serialize().object_class||console.warn("%c Component "+c+" could have a bug, serialize() method has object_class missing.","font-size: 1.2em"));LEvent.trigger(e,"component_registered",a);e.GlobalScene&&(this.replaceComponentClass(e.GlobalScene,b||c,c),b!=c&&this.unregisterComponent(b))},unregisterComponent:function(a){this.Components[a]&&delete this.Components[a]},isClassComponent:function(a){a=
this.getClassName(a);return!!this.Components[a]},replaceComponentClass:function(a,b,c){var d=c.constructor===String?e.Components[c]:c;if(!d)return 0;var f=null;b.constructor===String&&(f=e.Components[b],b=e.getClassName(f));for(var h=f=0;h<a._nodes.length;++h){for(var g=a._nodes[h],k=0;k<g._components.length;++k){var m=g._components[k];if(m.constructor!==d){var l=e.getObjectClassName(m);if(l==b||l==c)l=m.serialize(),g.removeComponent(m),m=new d,g.addComponent(m,k<g._components.length?k:void 0),m.configure(l),
f++}}if(g._missing_components)for(k=0;k<g._missing_components.length;++k)l=g._missing_components[k],l[0]===b&&(g._missing_components.splice(k,1),m=new d,g.addComponent(m,l[2]<g._components.length?l[2]:void 0),m.configure(l[1]),k--,f++)}return f},registerResourceClass:function(a){var b=e.getClassName(a);this.ResourceClasses[b]=a;this.Classes[b]=a;a.is_resource=!0;a.EXTENSION&&(this.ResourceClasses_by_extension[a.EXTENSION.toLowerCase()]=a)},coroutines:{},addWaitingCoroutine:function(a,b){b=b||"render";
var c=this.coroutines[b];c||(c=this.coroutines[b]=[]);c.push(a)},triggerCoroutines:function(a,b){var c=this.coroutines[a||"render"];if(c){for(var d=0;d<c.length;++d)e.safeCall(c[d],b);c.length=0}},createCoroutine:function(a){return new Promise(function(b){e.addWaitingCoroutine(b,a)})},sleep:function(a){return new Promise(function(b){setTimeout(b,a)})},nextFrame:function(a){a||e.GlobalScene.requestFrame();return new Promise(function(a){e.addWaitingCoroutine(a,"render")})},safeCall:function(a,b,c){if(!e.catch_exceptions)return c?
a.apply(c,b):a(b);try{return a.apply(c,b)}catch(d){LEvent.trigger(e,"exception",d),console.error(d.stack)}},setTimeout:function(a,b){if(!e.catch_exceptions)return setTimeout(a,b);try{return setTimeout(a,b)}catch(c){LEvent.trigger(e,"exception",c)}},setInterval:function(a,b){if(!e.catch_exceptions)return setInterval(a,b);try{return setInterval(a,b)}catch(c){LEvent.trigger(e,"exception",c)}},extendClass:function(a,b){for(var c in b)a.hasOwnProperty(c)||(a[c]=b[c]);if(b.prototype)for(c in b.prototype)b.prototype.hasOwnProperty(c)&&
!a.prototype.hasOwnProperty(c)&&(b.prototype.__lookupGetter__(c)?a.prototype.__defineGetter__(c,b.prototype.__lookupGetter__(c)):a.prototype[c]=b.prototype[c],b.prototype.__lookupSetter__(c)&&a.prototype.__defineSetter__(c,b.prototype.__lookupSetter__(c)))},cloneObject:function(a,b,c,d,f){if(void 0!==a){if(null===a)return null;switch(a.constructor){case String:case Number:case Boolean:return a}if(a.constructor.BYTES_PER_ELEMENT){if(!b)return new a.constructor(a);if(b.set)b.set(a);else if(b.construtor===
Array)for(var h=0;h<a.length;++h)b[h]=a[h];else throw"cloneObject: target has no set method";return b}var g=b;if(void 0===g||null===g)g=a.constructor===Array?[]:{};for(h in a)if("@"!=h[0]&&"_"!=h[0]&&"jQuery"!=h.substr(0,6)&&(!d||b.hasOwnProperty(h)||b.__proto__.hasOwnProperty(h))){var k=a[h];if(null==k)g[h]=null;else if(!isFunction(k))if(k.constructor===Number||k.constructor===String||k.constructor===Boolean)g[h]=k;else if(k.buffer&&k.byteLength&&k.buffer.constructor===ArrayBuffer)g[h]&&k&&d?g[h].length==
k.length&&g[h].set(k):g[h]=new k.constructor(k);else if(k.constructor===Array)g[h]&&g[h].set&&g[h].length>=k.length?g[h].set(k):g[h]=f&&b&&"@ENC"==k[0]?e.decodeObject(k):e.cloneObject(k);else if(k.constructor.is_resource)console.error("Resources cannot be saved as a property of a component nor script, they must be saved individually as files in the file system. If assigning them to a component/script use private variables (name start with underscore) to avoid being serialized.");else if(f&&!b)g[h]=
e.encodeObject(k);else if(k.constructor===Object||b||k.toJSON)if(k.toJSON)g[h]=k.toJSON();else if(c)g[h]=e.cloneObject(k,null,!0);else if(k.constructor!==Object&&e.Classes[e.getObjectClassName(k)]&&console.warn("Cannot clone internal classes:",e.getObjectClassName(k)," When serializing an object I found a var with a class that doesnt support serialization. If this var shouldnt be serialized start the name with underscore.'"),e.catch_exceptions)try{g[h]=JSON.parse(JSON.stringify(k))}catch(m){console.error(m)}else g[h]=
JSON.parse(JSON.stringify(k));else console.warn("Cannot clone internal classes:",e.getObjectClassName(k)," When serializing an object I found a var with a class that doesnt support serialization. If this var shouldnt be serialized start the name with underscore.'")}return g}},encodeObject:function(a){if(!a||a.constructor===Number||a.constructor===String||a.constructor===Boolean||a.constructor===Object)return a;if(a.constructor.is_component&&a._root)return["@ENC",e.TYPES.COMPONENT,a.getLocator(),e.getObjectClassName(a)];
if(a.constructor==e.SceneNode&&a._in_tree)return["@ENC",e.TYPES.NODE,a.uid];if(a.constructor==e.Scene)return["@ENC",e.TYPES.SCENE,a.fullpath];if(a.serialize||a.toJSON)return["@ENC",e.TYPES.OBJECT,a.serialize?a.serialize():a.toJSON(),e.getObjectClassName(a)];console.warn("Cannot clone internal classes:",e.getObjectClassName(a)," When serializing an object I found a property with a class that doesnt support serialization. If this property shouldn't be serialized start the name with underscore.'");return null},
decodeObject:function(a){if(!a||a.constructor!==Array||"@ENC"!=a[0])return null;switch(a[1]){case e.TYPES.COMPONENT:case e.TYPES.NODE:var b=Ba.get(a[2]);if(b)return b;b||console.warn("Object UID referencing object not found in the scene:",a[2]);return a[2];case e.TYPES.SCENE:return null;default:if(!a[2]||!a[2].object_class)return null;b=e.Classes[a[2].object_class];if(!b)return null;b=new b;b.configure(a[2]);return b}},clearUIds:function(a,b){b=b||{};a.uid&&(b[a.uid]=a,delete a.uid);a.material&&a.material.uid&&
(b[a.material.uid]=a.material,delete a.material.uid);var c=a.components;!c&&a.getComponents&&(c=a.getComponents());if(c){if(c)for(var d in c){var f=c[d];f[1].uid&&(b[f[1].uid]=f[1],delete f[1].uid);f[1]._uid&&(b[f[1]._uid]=f[1],delete f[1]._uid)}c=a.children;!c&&a.getChildren&&(c=a.getChildren());if(c){for(d in c)e.clearUIds(c[d],b);return b}}},getObjectClassName:function(a){if(a){if(a.constructor.fullname)return a.constructor.fullname;if(a.constructor.name)return a.constructor.name;if((a=a.constructor.toString().match(/function\s*(\w+)/))&&
2==a.length)return a[1]}},getClassName:function(a){if(a){if(a.name)return a.name;if(a.toString&&(a=a.toString().match(/function\s*(\w+)/))&&2==a.length)return a[1]}},getObjectProperties:function(a){if(a.getPropertiesInfo)return a.getPropertiesInfo();var b=a.constructor;if(b.properties)return b.properties;var c={},d;for(d in a)if("_"!=d[0]&&"@"!=d[0]&&"jQuery"!=d.substr(0,6)){if(b!=Object){var f=b["@"+d];if(f&&f.type){c[d]=f.type;continue}}f=a[d];null==f?c[d]=null:isFunction(f)||(c[d]=f.constructor===
Boolean?e.TYPES.BOOLEAN:f.constructor===Number?e.TYPES.NUMBER:f.constructor===String?e.TYPES.STRING:f.buffer&&f.buffer.constructor===ArrayBuffer?2==f.length?e.TYPES.VEC2:3==f.length?e.TYPES.VEC3:4==f.length?e.TYPES.VEC4:9==f.length?e.TYPES.MAT3:16==f.length?e.TYPES.MAT4:0:0)}return c},setObjectProperty:function(a,b,c){if(a.setProperty)return a.setProperty(b,c);a[b]=c;if(a.onPropertyChanged)a.onPropertyChanged(b,c)},registerMaterialClass:function(a){var b=e.getClassName(a);this.MaterialClasses[b]=
a;this.Classes[b]=a;e.extendClass(a,x);LEvent.trigger(e,"materialclass_registered",a);a.resource_type="Material";a.is_material=!0},getScript:function(a){return(a=e.Script.active_scripts[a])?a.context:null},dispatchCodeError:function(a,b,c,d){a={error:a,line:b,resource:c,extra:d};console.error(a);LEvent.trigger(this,"code_error",a)},convertToString:function(a){if(!a)return"";if(a.constructor===String)return a;if(a.constructor===Object)return JSON.stringify(object.serialize?object.serialize():object);
a.constructor===ArrayBuffer&&(a=new Uint8Array(a));return String.fromCharCode.apply(null,a)},checkLocatorBelongsToPrefab:function(a,b){b=b||e.GlobalScene.root;var c=a.split("/");return c.length?(c=Ba.get(c[0],b))?c.insidePrefab():null:null},convertLocatorFromUIDsToName:function(a,b,c){c=c||e.GlobalScene.root;a=a.split("/");if(!a.length||a[0][0]!==e._uid_prefix&&(1==a.length||a[1][0]!==e._uid_prefix))return null;c=Ba.get(a[0],c);if(!c)return console.warn("getIDasName: node not found in LS.GlobalScene: "+
a[0]),!1;if(!c.name)return console.warn("getIDasName: node without name?"),!1;if(1<a.length&&a[1][0]==e._uid_prefix){var d=e.GlobalScene.findComponentByUId(a[1]);if(d){var f=d.constructor.name;if("Script"==f||"ScriptFromFile"==f)f=d.name,"unnamed"==f&&(console.error("converting component UIDs to component name, but property belongs to a Script without name. You must name the script to avoid errors."),f=d.constructor.name);a[1]=f}}a=a.concat();a[0]=b?c.name:c.fullname;return a.join("/")},reset:function(){e.GlobalScene.clear();
e.ResourcesManager.reset();LEvent.trigger(e,"reset")},log:function(){console.log.apply(console,arguments)},stringToValue:function(a){var b=a;try{b=JSON.parse(a)}catch(c){console.error("Not a valid value: "+a)}return b},isValueOfType:function(a,b){if(null===a||void 0===a){switch(b){case "float":case "sampler2D":case "samplerCube":case e.TYPES.NUMBER:case e.TYPES.VEC2:case e.TYPES.VEC3:case e.TYPES.VEC4:case e.TYPES.COLOR:case e.TYPES.COLOR4:case "mat3":case "mat4":return!1}return!0}switch(b){case "float":case "sampler2D":case "samplerCube":case e.TYPES.NUMBER:return isNumber(a);
case e.TYPES.VEC2:return 2===a.length;case e.TYPES.VEC3:return 3===a.length;case e.TYPES.VEC4:return 4===a.length;case e.TYPES.COLOR:return 3===a.length;case e.TYPES.COLOR4:return 4===a.length;case "mat3":return 9===a.length;case "mat4":return 16===a.length}return!0},queryString:function(){for(var a={},b=window.location.search.substring(1).split("&"),c=0;c<b.length;c++){var d=b[c].split("=");if("undefined"===typeof a[d[0]])a[d[0]]=decodeURIComponent(d[1]);else if("string"===typeof a[d[0]]){var f=
[a[d[0]],decodeURIComponent(d[1])];a[d[0]]=f}else a[d[0]].push(decodeURIComponent(d[1]))}return a}(),downloadFile:function(a,b,c){if(b){c||(c=b.constructor===String?"text/plain":"application/octet-stream");var d=null,d=b.constructor!==File&&b.constructor!==Blob?new Blob([b],{type:c}):b,f=URL.createObjectURL(d);b=document.createElement("a");b.setAttribute("href",f);b.setAttribute("download",a);b.style.display="none";document.body.appendChild(b);b.click();document.body.removeChild(b);setTimeout(function(){URL.revokeObjectURL(f)},
6E4)}else console.warn("No file provided to download")}};Object.defineProperty(e,"catch_exceptions",{set:function(a){this._catch_exceptions=a;Z.catch_exceptions=a;Z.catch_important_exceptions=a},get:function(){return this._catch_exceptions},enumerable:!0});Object.defineProperty(e,"block_scripts",{set:function(a){e._block_scripts=a;Z.block_execution=a},get:function(){return!!e._block_scripts},enumerable:!0});e.Classes.WBin=e.WBin=Y.WBin=WBin;Ba.set=function(a,b,c,d){d=d||e.GlobalScene;if(!c)d.setPropertyValue(a,
b);else if(c.constructor===e.SceneNode)return a=a.split("/"),(c=c.findNodeByUId(a[0]))?c.setPropertyValueFromPath(a.slice(1),b):null;d.requestFrame()};Ba.get=function(a,b,c){if(!a)return null;c=c||e.GlobalScene;var d;if(!b)d=c.getPropertyInfo(a);else if(b.constructor===e.SceneNode){a=a.split("/");b=b.findNodeByUId(a[0]);if(!b)return null;d=b.getPropertyInfoFromPath(a.slice(1))}return d?d.value:null};Ba.shortify=function(a,b){if(a){var c=a.split("/"),d=null;if(c[0][0]!=e._uid_prefix)return a;b=b||
e.GlobalScene;d=b._nodes_by_uid[c[0]];if(!d)return a;c[0]=d.getPathName();c[1]&&c[1][0]==e._uid_prefix&&(d=d.getComponentByUId(c[1]))&&(c[1]=e.getObjectClassName(d));return c.join("/")}};Ba.setFromInfo=function(a,b){if(a&&a.target){var c=a.target;if(c.setPropertyValue&&!0===c.setPropertyValue(a.name,b))return c;void 0!==c[a.name]&&(c[a.name]=b)}};Ba.getFromInfo=function(a){if(a&&a.target){var b=a.target;a=a.name;var c=void 0;b.getPropertyValue&&(c=b.getPropertyValue(a));return void 0===c&&void 0===
b[a]?null:void 0!==c?c:b[a]}};Y.GL&&(e.registerResourceClass(GL.Mesh),e.registerResourceClass(GL.Texture),e.Mesh=GL.Mesh,e.Texture=GL.Texture,e.Buffer=GL.Buffer);Y.LSQ=Ba;if("undefined"==typeof GL)throw"LiteSCENE requires to have litegl.js included before litescene.js";var Wa={AUTOMATIC:1,NORMAL:2,ALPHA:3,ADD:4,MULTIPLY:5,SCREEN:6,CUSTOM:7};e.Blend=Wa;e.BlendFunctions={};e.BlendFunctions[Wa.AUTOMATIC]=[GL.ONE,GL.ZERO];e.BlendFunctions[Wa.NORMAL]=[GL.ONE,GL.ZERO];e.BlendFunctions[Wa.ALPHA]=[GL.SRC_ALPHA,
GL.ONE_MINUS_SRC_ALPHA];e.BlendFunctions[Wa.ADD]=[GL.SRC_ALPHA,GL.ONE];e.BlendFunctions[Wa.MULTIPLY]=[GL.DST_COLOR,GL.ONE_MINUS_SRC_ALPHA];e.BlendFunctions[Wa.SCREEN]=[GL.SRC_ALPHA,GL.ONE];e.BlendFunctions[Wa.CUSTOM]=[GL.SRC_ALPHA,GL.ONE_MINUS_SRC_ALPHA];e.STOPPED=0;e.PLAYING=1;e.PAUSED=2;e.LOADING=3;e.RUNNING=1;e.ZEROS=vec3.create();e.ZEROS4=vec4.create();e.ONES=vec3.fromValues(1,1,1);e.TOP=vec3.fromValues(0,1,0);e.BOTTOM=vec3.fromValues(0,-1,0);e.RIGHT=vec3.fromValues(1,0,0);e.LEFT=vec3.fromValues(-1,
0,0);e.FRONT=vec3.fromValues(0,0,-1);e.BACK=vec3.fromValues(0,0,1);e.IDENTITY=mat4.create();e.WHITE=e.ONES;e.BLACK=e.ZEROS;e.TYPES={BOOLEAN:"boolean",NUMBER:"number",STRING:"string",VEC2:"vec2",VEC3:"vec3",VEC4:"vec3",COLOR:"color",COLOR4:"color4",EVENT:"event",RESOURCE:"resource",TEXTURE:"texture",MESH:"mesh",OBJECT:"object",SCENE:"scene",SCENENODE:"node",SCENENODE_ID:"node_id",COMPONENT:"component",COMPONENT_ID:"component_id",MATERIAL:"material",ANIMATION:"animation",ARRAY:"array",QUAT:"quat",TRANS10:"trans10",
POSITION:"position"};e.TYPES_INDEX={};var Wb=0,Jb;for(Jb in e.TYPES)e.TYPES_INDEX[e.TYPES[Jb]]=Wb++;e.RESOURCE_TYPES={};e.RESOURCE_TYPES[e.TYPES.RESOURCE]=!0;e.RESOURCE_TYPES[e.TYPES.TEXTURE]=!0;e.RESOURCE_TYPES[e.TYPES.MESH]=!0;e.RESOURCE_TYPES[e.TYPES.ANIMATION]=!0;e.Ray=GL.Ray;e.Network={default_dataType:"arraybuffer",protocol:null,withCredentials:!1,request:function(a){if("string"===typeof a)throw"LS.Network.request expects object, not string. Use LS.Network.requestText or LS.Network.requestJSON";
var b=a.url;a.use_proxy&&(b=e.ResourcesManager.getFullURL(b));null===this.protocol&&(this.protocol=e.ResourcesManager.getProtocol(location.href));var c=e.ResourcesManager.getProtocol(b);"https"==this.protocol&&c&&"https"!=c&&(b="https"+b.substr(b.indexOf(":")));c=a.dataType||this.default_dataType;if("json"==c)c="text";else if("xml"==c)c="text";else if("binary"==c)c="arraybuffer",a.mimeType="application/octet-stream";else if("image"==c)return c=new Image,c.onload=function(){a.success&&a.success.call(this)},
c.onerror=a.error,c.src=b,c;var d=new XMLHttpRequest;d.open(a.method||(a.data?"POST":"GET"),b,!0);d.withCredentials=this.withCredentials;void 0!==a.withCredentials&&(d.withCredentials=a.withCredentials);c&&(d.responseType=c);a.mimeType&&d.overrideMimeType(a.mimeType);a.nocache&&d.setRequestHeader("Cache-Control","no-cache");d.onload=function(c){c=this.response;if(this.status&&200!=this.status)c="Error "+this.status,a.error&&a.error(c);else{if("json"==a.dataType)try{c=JSON.parse(c)}catch(h){a.error&&
a.error(h)}else if("xml"==a.dataType)try{c=(new DOMParser).parseFromString(c,"text/xml")}catch(g){a.error&&a.error(g)}else"blob"==a.dataType&&(c.name=e.ResourcesManager.getFilename(b));if(e.catch_errors)try{a.success&&a.success.call(this,c,a.url),LEvent.trigger(d,"done",c)}catch(k){LEvent.trigger(e,"code_error",k)}else a.success&&a.success.call(this,c,a.url),LEvent.trigger(d,"done",c)}};d.onerror=function(b){a.error&&a.error(b);LEvent.trigger(this,"fail",b)};a.uploadProgress&&d.upload.addEventListener("progress",
function(b){var c=0;b.lengthComputable&&(c=b.loaded/b.total);a.uploadProgress(b,c)},!1);a.progress&&d.addEventListener("progress",function(b){var c=0;b.lengthComputable&&(c=b.loaded/b.total);a.progress(b,c)});d.send(a.data);return d},requestText:function(a,b,c,d){"function"==typeof b&&(d=c,c=b);return e.Network.request({url:a,dataType:"text",success:c,error:d})},requestJSON:function(a,b,c,d){"function"==typeof b&&(d=c,c=b,b=null);return e.Network.request({url:a,data:b,dataType:"json",success:c,error:d})},
requestFile:function(a,b,c,d,f){"function"==typeof b&&(d=c,c=b,b=null);return e.Network.request({url:a,dataType:f?"blob":"binary",data:b,success:c,error:d})},requestScript:function(a,b,c,d){if(!a)throw"No url";if(e._block_scripts)console.error("Safety: LS.block_scripts enabled, cannot request script");else{a.constructor===String&&(a=[a]);var f=a.length,h;for(h in a){var g=document.createElement("script");g.num=h;g.type="text/javascript";g.src=a[h];g.async=!1;g.charset="UTF-8";g.onload=function(a){f--;
f?d&&d(this.src,this.num):b&&b()};c&&(g.onerror=function(a){c(a,this.src,this.num)});document.getElementsByTagName("head")[0].appendChild(g)}}},requestFont:function(a,b){if(!a||!b)throw"LS.Network.requestFont: Wrong font name or url";var c=this._loaded_fonts;c||(c=this._loaded_fonts={});if(c[a]!=b){c[a]=b;var d=document.getElementById("ls_fonts");d||(d=document.createElement("style"),d.id="ls_fonts",d.setAttribute("type","text/css"),document.head.appendChild(d));var f="",e;for(e in c)b=c[e],f+='@font-face {\n\tfont-family: "'+
e+"\";\n\tsrc: url('"+b+"');\n}\n";d.innerHTML=f}}};Object.defineProperty(MouseEvent.prototype,"getRay",{value:function(){var a=e.Renderer.getCameraAtPosition(this.mousex,this.mousey,e.Renderer._visible_cameras);return a?a.getRay(this.mousex,this.mousey):null},enumerable:!1});e.Input={mapping:{A_BUTTON:0,B_BUTTON:1,X_BUTTON:2,Y_BUTTON:3,LB_BUTTON:4,RB_BUTTON:5,BACK_BUTTON:6,START_BUTTON:7,LS_BUTTON:8,RS_BUTTON:9,LX:0,LY:1,RX:2,RY:3,TRIGGERS:4,LEFT_TRIGGER:4,RIGHT_TRIGGER:5,JUMP:0,FIRE:1,LEFT:0,MIDDLE:1,
RIGHT:2},LEFT_MOUSE_BUTTON:1,MIDDLE_MOUSE_BUTTON:2,RIGHT_MOUSE_BUTTON:3,Keyboard:[],Keyboard_previous:[],Mouse:{},Gamepads:[],last_mouse:null,last_click:null,current_click:null,current_key:null,keys_buffer:[],_last_frame:-1,init:function(){this.Keyboard=gl.keys;this.Mouse=gl.mouse;this.Gamepads=gl.getGamepads()},reset:function(){this.Gamepads=gl.gamepads=[]},update:function(){for(var a=0,b=this.Keyboard.length;a<b;++a)this.Keyboard_previous[a]=this.Keyboard[a];this.Mouse.last_buttons=this.Mouse.buttons;
this.Gamepads=gl.getGamepads()},isKeyPressed:function(a){return!!this.Keyboard[a]},wasKeyPressed:function(a){return this.Keyboard[a]&&!this.Keyboard_previous[a]},isMouseButtonPressed:function(a){var b=0,b=a&&a.constructor===String?this.mapping[a]:a;return void 0===a?!1:this.Mouse.isButtonPressed(b)},wasMouseButtonPressed:function(a){var b=0,b=a&&a.constructor===String?this.mapping[a]:a;return void 0===a?!1:this.Mouse.wasButtonPressed(b)},lockMouse:function(a){a?gl.canvas.requestPointerLock():document.exitPointerLock()},
onMouse:function(a){this.last_mouse=a;this.Mouse.mousex=a.mousex;this.Mouse.mousey=a.mousey;"mousedown"==a.type?(this.current_click=a,e.triggerCoroutines("click",a)):"mouseup"==a.type&&(this.current_click=null);return e.GUI.testEventInBlockedArea(a)},onKey:function(a){"keydown"==a.type?(this.current_key=a,e.Renderer._frame!=this._last_frame&&(this.keys_buffer.length=0,e.Renderer._frame=this._last_frame),10>this.keys_buffer.length&&this.keys_buffer.push(a)):this.current_key=null},isMouseInRect:function(a,
b,c,d,f){return this.Mouse.isInsideRect(a,b,c,d,f)},isEventInRect:function(a,b,c){var d=0,f=0;c&&(d=c[0],f=c[1]);return a.mousex-d>=b[0]&&a.mousex-d<b[0]+b[2]&&a.mousey-f>=b[1]&&a.mousey-f<b[1]+b[3]},getAxis:function(a){if("vertical"==a){if(this.isKeyPressed(38)||this.isKeyPressed("W"))return 1;if(this.isKeyPressed(40)||this.isKeyPressed("S"))return-1}else if("horizontal"==a){if(this.isKeyPressed(37)||this.isKeyPressed("A"))return-1;if(this.isKeyPressed(39)||this.isKeyPressed("D"))return 1}var b=
this.Gamepads[0];if(b){if("horizontal"==a)return b.axes[0];if("vertical"==a)return b.axes[1]}return 0},getGamepad:function(a){return this.Gamepads[a||0]},getGamepadAxis:function(a,b,c){a=this.Gamepads[a];if(!a)return 0;var d=0,d=b&&b.constructor===String?this.mapping[b]:b;if(void 0===d)return 0;b=a.axes[d];return!c&&-0.1<b&&0.1>b?0:b},isGamepadButtonPressed:function(a,b){var c=this.Gamepads[a];if(!c)return null;var d=0,d=b&&b.constructor===String?this.mapping[b]:b;return void 0===d?0:(c=c.buttons[d])&&
c.pressed},mouseClick:function(){return new Promise(function(a){e.addWaitingCoroutine(a,"click")})}};var Xa={_root:null,_allow_change_cursor:!0,_is_on_top_of_immediate_widget:!1,GUIStyle:{font:"Arial",color:"#FFF",colorTextOver:"#FFF",backgroundColor:"#333",backgroundColorOver:"#AAA",selected:"#AAF",unselected:"#AAA",outline:"#000",margin:0.2},_offset:[0,0],_gui_areas:{data:new Float32Array(1024),offset:0},_ctx:null,pressed_enter:!1,getHTMLRoot:function(){if(this._root)return!this._root.parentNode&&
gl.canvas.parentNode&&gl.canvas.parentNode.appendChild(a),this._root;e.GlobalScene._state!=e.PLAYING&&console.warn("GUI element created before the scene is playing will be deleted once the app starts. Only create the GUI elements from onStart or after, otherwise the GUI elements will be lost.");var a=document.createElement("div");a.className="litescene-gui";a.style.position="absolute";a.style.top="0";a.style.left="0";a.style.color="#999";a.style.font="20px Arial";a.style.width="100%";a.style.height=
"100%";a.style.overflow="hidden";a.style.pointerEvents="none";if(!this._style){var b=this._style=document.createElement("style");b.appendChild(document.createTextNode(""));document.head.appendChild(b);b.sheet.insertRule(".litescene-gui button, .litescene-gui input { pointer-events: auto; }",0)}gl.canvas.parentNode.appendChild(a);return this._root=a},createElement:function(a,b){var c=document.createElement(a||"div");c.style.pointerEvents="auto";return this.attach(c,b)},attach:function(a,b){if(a){a.style.position=
"absolute";b=b||"none";switch(b){case "bottom":case "bottom-left":a.style.bottom="0";a.style.left="0";break;case "bottom-right":a.style.bottom="0";a.style.right="0";break;case "bottom-middle":a.style.bottom="0";a.style.width="50%";a.style.margin="0 auto";break;case "right":case "top-right":a.style.top="0";a.style.right="0";break;case "top-middle":a.style.top="0";a.style.width="50%";a.style.margin="0 auto";break;case "left":case "top":case "top-left":a.style.top="0";a.style.left="0";break;case "none":break;
default:console.warn("invalid GUI anchor position: ",b)}this.getHTMLRoot().appendChild(a);return a}console.error("attachToGUI: element cannot be null")},detach:function(a){a&&a.parentNode&&a.parentNode.removeChild(a)},reset:function(){this._root&&(this._root.parentNode&&this._root.parentNode.removeChild(this._root),this._root=null,this._style&&(this._style.parentNode.removeChild(this._style),this._style=null))},showHTML:function(){this._root&&(this._root.style.display="")},hideHTML:function(){this._root&&
(this._root.style.display="none")},loadHTML:function(a,b){e.ResourcesManager.load(a,function(a){var d=e.GUI.getHTMLRoot(),f=a.getAsHTML();f?(f.style.pointerEvents="none",f.style.width="100%",f.style.height="100%",d.appendChild(f),e.GUI.replaceHTMLSources(d),b&&b(f,a)):console.error("html resource is not a string")})},replaceHTMLSources:function(a){a=a.querySelectorAll("*[src]");for(var b=0;b<a.length;++b){var c=a[b],d=c.getAttribute("src");if(d&&"@"==d[0]){var d=d.substr(1),f=e.ResourcesManager.getResource(d),
d=f&&f._local_url?f._local_url:e.ResourcesManager.getFullURL(d);c.setAttribute("src",d)}}},ResetImmediateGUI:function(a){this._is_on_top_of_immediate_widget=!1;this.setCursor(null);this.pressed_enter=!1;this._offset[0]=0;this._offset[1]=0;this._gui_areas.offset=0;this._ctx=gl;a||e.GlobalScene.requestFrame()},blockEventArea:function(a){var b=this._gui_areas.data,c=this._gui_areas.offset;c>b.length||(b[c]=a[0]+this._offset[0],b[c+1]=a[1]+this._offset[1],b[c+2]=a[2],b[c+3]=a[3],this._gui_areas.offset+=
4,this._gui_areas.offset>=b.length&&24576>b.length&&(this._gui_areas.data=new Float32Array(2*b.length),this._gui_areas.data.set(b)))},testEventInBlockedArea:function(a){if("mousedown"!=a.type)return!1;for(var b=this._gui_areas.data,c=0;c<this._gui_areas.offset;c+=4)if(a.mousex>=b[c]&&a.mousex<b[c]+b[c+2]&&a.mousey>=b[c+1]&&a.mousey<b[c+1]+b[c+3])return!0;return!1},Box:function(a,b){if(!a)throw"No area";this.blockEventArea(a);var c=gl;c.fillStyle=b||"#333";c.fillRect(a[0]+this._offset[0],a[1]+this._offset[1],
a[2],a[3])},Label:function(a,b){if(!a)throw"No area";if(null!=b){var c=this._ctx;b.constructor===GL.Texture?(c.constructor===CanvasRenderingContext2D&&(b=!b.data||b.data.constructor!==HTMLImageElement&&b.data.constructor!==Image?null:b.data),b&&c.drawImage(b,a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3])):b.constructor===HTMLImageElement||b.constructor===Image?c.constructor===CanvasRenderingContext2D&&c.drawImage(b,a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3]):(b.constructor===Number?
b=b.toFixed(3):b.constructor!==String&&(b=String(b)),c.fillStyle=this.GUIStyle.color,c.font=(0.75*a[3]).toFixed(0)+"px "+this.GUIStyle.font,c.textAlign="left",c.fillText(b,a[0]+0.2*a[3]+this._offset[0],a[1]+0.75*a[3]+this._offset[1]))}},Button:function(a,b,c){if(!a)throw"No area";this.blockEventArea(a);var d=this._ctx,f=e.Input.isEventInRect(e.Input.Mouse,a,this._offset);f&&(this._is_on_top_of_immediate_widget=!0,this.setCursor("pointer"));var h=e.Input.current_click,g=!1;h&&(g=e.Input.isEventInRect(h,
a,this._offset))&&(e.Input.current_click=!1);if(null==b)return g;b.constructor===String&&(d.fillStyle=g?"#FFF":f?this.GUIStyle.backgroundColorOver:this.GUIStyle.backgroundColor,d.fillRect(a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3]));b.constructor===GL.Texture?(f&&c&&c.constructor===GL.Texture&&(b=c),d.drawImage(b,a[0]+this._offset[0],a[1]+this._offset[0],a[2],a[3])):b.constructor===String&&(d.fillStyle=f?this.GUIStyle.colorTextOver:this.GUIStyle.color,d.font=(0.75*a[3]).toFixed(0)+"px "+
this.GUIStyle.font,d.textAlign="center",d.fillText(b,a[0]+0.5*a[2]+this._offset[0],a[1]+0.75*a[3]+this._offset[1]),d.textAlign="left");return g},Toolbar:function(a,b,c){if(!a)throw"No area";if(!c||c.constructor!==Array)throw"No options";this.blockEventArea(a);var d=this._ctx;e.Input.isEventInRect(e.Input.Mouse,a,this._offset)&&(this._is_on_top_of_immediate_widget=!0,this.setCursor("pointer"));var f=e.Input.current_click,h=c.length,g=a[0],k=a[2];a[2]=k/h;for(var m=0;m<h;++m){var l=c[m],n=b==m,p=!1;
a[0]=g+a[2]*m;f&&(p=e.Input.isEventInRect(f,a,this._offset))&&(b=m,n=!0,e.Input.current_click=!1);l&&l.constructor!==String||(d.fillStyle=n?this.GUIStyle.backgroundColorOver:this.GUIStyle.backgroundColor,d.fillRect(a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3]));l&&(l.constructor===GL.Texture?(n||(d.globalAlpha=0.5),d.drawImage(l,a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3]),d.globalAlpha=1):l.constructor===String&&(d.fillStyle=this.GUIStyle.color,d.font=(0.75*a[3]).toFixed(0)+"px "+
this.GUIStyle.font,d.textAlign="center",d.fillText(l,a[0]+0.5*a[2]+this._offset[0],a[1]+0.75*a[3]+this._offset[1]),d.textAlign="left"))}a[0]=g;a[2]=k;return b},Toggle:function(a,b,c,d){if(!a)throw"No area";b=!!b;this.blockEventArea(a);var f=this._ctx;e.Input.isEventInRect(e.Input.Mouse,a,this._offset)&&(this._is_on_top_of_immediate_widget=!0,this.setCursor("pointer"));var h=e.Input.current_click,g=!1;h&&(g=e.Input.isEventInRect(h,a,this._offset))&&(e.Input.current_click=!1);h=0.2*a[3];c&&(c.constructor===
GL.Texture?(!b&&d&&d.constructor===GL.Texture&&(c=d),f.drawImage(c,a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3])):c.constructor===String&&(f.fillStyle=this.GUIStyle.color,f.font=(0.75*a[3]).toFixed(0)+"px "+this.GUIStyle.font,f.fillText(c,a[0]+h+this._offset[0],a[1]+0.75*a[3]+this._offset[1]),d=0.6*a[3],f.fillStyle=this.GUIStyle.backgroundColor,f.fillRect(a[0]+a[2]-1.5*h-d+this._offset[0],a[1]+0.5*h+this._offset[1],d+h,a[3]-h),f.fillStyle=b?this.GUIStyle.selected:"#000",f.fillRect(a[0]+a[2]-
h-d+this._offset[0],a[1]+h+this._offset[1],d,a[3]-2*h)));return g?!b:b},TextField:function(a,b,c,d){if(!a)throw"No area";this.blockEventArea(a);b=void 0===b?"":String(b);c=c||1024;var f=this._ctx;e.Input.isEventInRect(e.Input.Mouse,a,this._offset)&&(this._is_on_top_of_immediate_widget=!0,this.setCursor("pointer"));var h=e.Input.current_click,g=!1;h&&(g=e.Input.isEventInRect(h,a,this._offset))&&(e.Input.current_click=null,e.Input.last_click=h);h=!1;e.Input.last_click&&e.Input.isEventInRect(e.Input.last_click,
a,this._offset)&&(h=!0);this.pressed_enter=!1;if(h){for(var k=e.Input.keys_buffer,g=0;g<k.length;++g){var m=k[g];switch(m.keyCode){case 8:b=b.substr(0,b.length-1);break;case 13:this.pressed_enter=!0;break;case 32:b.length<c&&(b+=" ");break;default:b.length<c&&m.key&&1==m.key.length&&(b+=m.key)}}k.length=0;e.Input.current_key=null}g=0.02*a[3];c=0.2*a[3];f.fillStyle=this.GUIStyle.backgroundColor;f.fillRect(a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3]);f.fillStyle="#000";f.fillRect(a[0]+g+this._offset[0],
a[1]+g+this._offset[1],a[2]-2*g,a[3]-2*g);f.fillStyle=this.GUIStyle.color;f.font=(0.75*a[3]).toFixed(0)+"px "+this.GUIStyle.font;f.textAlign="left";k="";h&&0==(0.002*getTime()|0)%2&&(k="|");h=b;if(d)for(h="",g=0;g<b.length;++g)h+="*";f.fillText(h+k,a[0]+2*c+this._offset[0],a[1]+0.75*a[3]+this._offset[1]);return b},HorizontalSlider:function(a,b,c,d,f){if(!a)throw"No area";this.blockEventArea(a);void 0===c&&(c=0);void 0===d&&(d=1);b=Number(b);c=Number(c);d=Number(d);var h=this._ctx,g=e.Input.isEventInRect(e.Input.Mouse,
a,this._offset);g&&(this._is_on_top_of_immediate_widget=!0,this.setCursor("pointer"));var k=e.Input.current_click,m=!1;d-=c;var l=(b-c)/d;0>l&&(l=0);1<l&&(l=1);var n=a[3]*this.GUIStyle.margin;k&&(m=e.Input.isEventInRect(k,a,this._offset))&&(l=(e.Input.Mouse.mousex-this._offset[0]-(a[0]+n))/(a[2]-2*n),0>l&&(l=0),1<l&&(l=1),b=l*d+c);h.fillStyle=this.GUIStyle.backgroundColor;h.fillRect(a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3]);h.fillStyle=g?this.GUIStyle.selected:this.GUIStyle.unselected;
h.fillRect(a[0]+n+this._offset[0],a[1]+n+this._offset[1],Math.max(2,(a[2]-2*n)*l),a[3]-2*n);f&&(h.textAlign="center",h.fillStyle=this.GUIStyle.color,h.font=(0.5*a[3]).toFixed(0)+"px "+this.GUIStyle.font,h.fillText(b.toFixed(2),a[0]+0.5*a[2]+this._offset[0],a[1]+0.7*a[3]+this._offset[1]));return b},VerticalSlider:function(a,b,c,d){if(!a)throw"No area";this.blockEventArea(a);b=Number(b);void 0===c&&(c=0);void 0===d&&(d=1);c=Number(c);d=Number(d);var f=this._ctx,h=e.Input.isEventInRect(e.Input.Mouse,
a,this._offset);h&&(this._is_on_top_of_immediate_widget=!0,this.setCursor("pointer"));var g=e.Input.current_click,k=!1,m=d-c,l=(b-c)/m;0>l&&(l=0);1<l&&(l=1);d=a[2]*this.GUIStyle.margin;g&&(k=e.Input.isEventInRect(g,a,this._offset))&&(l=(e.Input.Mouse.mousey-this._offset[1]-(a[1]+d))/(a[3]-2*d),0>l&&(l=0),1<l&&(l=1),l=1-l,b=l*m+c);f.fillStyle=this.GUIStyle.backgroundColor;f.fillRect(a[0]+this._offset[0],a[1]+this._offset[1],a[2],a[3]);f.fillStyle=h?this.GUIStyle.selected:this.GUIStyle.unselected;c=
Math.max(2,(a[3]-2*d)*l);f.fillRect(a[0]+d+this._offset[0],a[1]+a[3]-c-d+this._offset[1],a[2]-2*d,c);return b},Knob:function(a,b,c,d,f,h){if(!a)throw"No area";this.blockEventArea(a);b=Number(b);void 0===c&&(c=0);void 0===d&&(d=1);f=f||0;c=Number(c);d=Number(d);var g=this._ctx,k=e.Input.isEventInRect(e.Input.Mouse,a,this._offset);k&&(this._is_on_top_of_immediate_widget=!0,this.setCursor("pointer"));var m=e.Input.current_click,l=!1,n=d-c;d=(b-c)/n;0>d&&(d=0);1<d&&(d=1);var p=0.75*-Math.PI,q=1.5*Math.PI;
m&&(l=e.Input.isEventInRect(m,a,this._offset))&&(d=(Math.atan2(e.Input.Mouse.mousex-(a[0]+0.5*a[2])-this._offset[0],-(e.Input.Mouse.mousey-(a[1]+0.5*a[3])-this._offset[1]))-p)/q,0>d&&(d=0),1<d&&(d=1),b=d*n+c);f&&(d=Math.round(d*f)/f);void 0!==h?null!==h&&(c=null,h.constructor===GL.Texture?(g.constructor===CanvasRenderingContext2D&&(h=!h.data||h.data.constructor!==HTMLImageElement&&h.data.constructor!==Image?null:h.data),h&&(c=h)):h.constructor!==HTMLImageElement&&h.constructor!==Image||g.constructor!==
CanvasRenderingContext2D||(c=h),c&&(g.save(),g.translate(a[0]+0.5*a[2]+this._offset[0],a[1]+0.5*a[3]+this._offset[1]),g.rotate(d*q+p),g.scale(a[3]/c.height,a[3]/c.height),g.drawImage(c,0.5*-c.width,0.5*-c.height),g.restore())):(g.strokeStyle=this.GUIStyle.outline,g.fillStyle=this.GUIStyle.backgroundColor,g.beginPath(),g.arc(a[0]+0.5*a[2]+this._offset[0],a[1]+0.5*a[3]+this._offset[1],0.45*a[3],0,2*Math.PI,!1),g.fill(),g.stroke(),g.lineWidth=0.1*a[3],g.strokeStyle=k?this.GUIStyle.selected:this.GUIStyle.unselected,
g.beginPath(),p=1.25*-Math.PI,g.arc(a[0]+0.5*a[2]+this._offset[0],a[1]+0.5*a[3]+this._offset[1],0.35*a[3],p,p+Math.max(DEG2RAD,q*d),!1),g.stroke(),g.lineWidth=1);return b},DragArea:function(a,b){if(!a)throw"No area";if(!b)throw"No value";this.blockEventArea(a);e.Input.isEventInRect(e.Input.Mouse,a,this._offset)&&(this._is_on_top_of_immediate_widget=!0,this.setCursor("pointer"));var c=e.Input.current_click,d=!1;c&&(d=e.Input.isEventInRect(c,a,this._offset))&&(e.Input.current_click=null,e.Input.last_click=
c);e.Input.last_click&&e.Input.isEventInRect(e.Input.last_click,a,this._offset)&&e.Input.Mouse.dragging&&(b[0]+=e.Input.Mouse.deltax||0,b[1]+=e.Input.Mouse.deltay||0);return b},setCursor:function(a){this._allow_change_cursor&&(gl.canvas.style.cursor=a||"")}};Object.defineProperty(Xa,"GUIOffset",{set:function(a){!a.length||2>a.length||(this._offset[0]=a[0],this._offset[1]=a[1])},get:function(){return this._offset},enumerable:!0});Xa.show=Xa.showHTML;Xa.hide=Xa.hideHTML;Xa.load=Xa.loadHTML;Xa.getRoot=
function(){console.warn("LS.GUI.getRoot() deprecated, use LS.GUI.getHTMLRoot() instead.");return e.GUI.getHTMLRoot()};e.GUI=Xa;var ub={path:"",proxy:"",ignore_cache:!1,free_data:!1,keep_files:!1,keep_urls:!1,allow_base_files:!1,scene_external_repository:null,resources:{},meshes:{},textures:{},materials:{},materials_by_uid:{},resources_not_found:{},resources_being_loaded:{},resources_being_processed:{},resources_renamed_recently:{},num_resources_being_loaded:0,MAX_TEXTURE_SIZE:4096,resource_pre_callbacks:{},
resource_post_callbacks:{},resource_once_callbacks:{},virtual_file_systems:{},skip_proxy_extensions:["mp3","wav","ogg"],force_nocache_extensions:["js","glsl","json"],nocache_files:{},valid_resource_name_reg:/^[A-Za-z\d\s\/\_\-\.]+$/,getNoCache:function(a){return this.ignore_cache||a?"nocache="+getTime()+Math.floor(1E3*Math.random()):""},reset:function(){this.resources={};this.meshes={};this.textures={};this.materials={};this.materials_by_uid={};this.scene_external_repository=null},registerResourcePreProcessor:function(a,
b,c,d){if(a){a=a.split(",");for(var f in a)c=a[f].toLowerCase(),this.resource_pre_callbacks[c]=b}},registerResourcePostProcessor:function(a,b){this.resource_post_callbacks[a]=b},getExtension:function(a,b){if(!a)return"";var c=a.indexOf("?");-1!=c&&(a=a.substr(0,c));c=b?a.indexOf("."):a.lastIndexOf(".");return-1==c?"":a.substr(c+1).toLowerCase().trim()},removeExtension:function(a,b){if(!a)return"";var c=a.indexOf("?");-1!=c&&(a=a.substr(0,c));c=b?a.indexOf("."):a.lastIndexOf(".");return-1==c?a:a.substr(0,
c)},replaceExtension:function(a,b){if(!a)return"";b=b||"";var c=this.getFolder(a),d=this.getFilename(a);return this.cleanFullpath((c?c+"/":"")+d+"."+b)},getFilename:function(a){if(!a)return"";var b=a.lastIndexOf("/"),c=a.lastIndexOf("?"),c=(-1==c?a.length:c-1)-b;return a.substr(b+1,c)},getFolder:function(a){if(!a)return"";var b=a.lastIndexOf("/");return a.substr(0,b)},getBasename:function(a){if(!a)return"";a=this.getFilename(a);var b=a.indexOf(".");return-1==b?a:a.substr(0,b)},getProtocol:function(a){if(!a)return"";
var b=a.substr(0,10).indexOf(":"),c="";-1!=b&&(c=a.substr(0,b));return c},cleanFullpath:function(a){return a?-1==a.indexOf("//")?47==a.charCodeAt(0)?a.substr(1):a:-1==a.indexOf("://")?a.split("/").filter(function(a){return!!a}).join("/"):a:""},loadResources:function(a,b){if(a){if(a.constructor===Array)for(var c=0;c<a.length;++c){var d=a[c];d&&":"!=d[0]&&"_"!=d[0]&&this.load(d,b)}else for(c in a)c&&":"!=c[0]&&"_"!=c[0]&&this.load(c,b);this._total_resources_to_load=this.num_resources_being_loaded;LEvent.trigger(this,
"start_loading_resources",this._total_resources_to_load);this._total_resources_to_load||LEvent.trigger(this,"end_loading_resources");return this._total_resources_to_load}},setPath:function(a){this.path=a},setProxy:function(a){a?(-1!=a.indexOf("@")?this.proxy=location.protocol+"//"+a.replace("@",window.location.host):this.proxy=a,"undefined"!==typeof LiteGraph&&(LiteGraph.proxy=this.proxy)):this.proxy=null},getFullURL:function(a,b){if(!a)return null;var c=a.substr(0,10).indexOf(":"),d="";-1!=c&&(d=
a.substr(0,c));var f=this.path;this.scene_external_repository&&(f=this.scene_external_repository);b&&b.force_local_url&&(f=".");b&&b.external_repository&&(f=b.external_repository);if(d)switch(d){case "http":case "https":return c=this.getExtension(a).toLowerCase(),this.proxy&&-1==this.skip_proxy_extensions.indexOf(c)&&(!b||b&&!b.ignore_proxy)?this.proxy+a:a;case "blob":return a;case "":return a;default:return":"==a[0]||"_"==a[0]?a:(this.virtual_file_systems[d]||f)+"/"+a.substr(c+1)}else return f+"/"+
a},registerFileSystem:function(a,b){this.virtual_file_systems[a]=b},getResource:function(a,b){if(!a)return null;a=this.cleanFullpath(a);if(!b)return this.resources[a];var c=this.resources[a];return c&&c.constructor===b?c:null},getResourceType:function(a){return a?a.object_class?a.object_class:a.constructor.resource_type?a.constructor.resource_type:e.getObjectClassName(a):null},getResourcesData:function(a,b){for(var c={},d=0;d<a.length;++d){var f=a[d],h=e.ResourcesManager.resources[f];if(h){var g=
null;if(g=h._original_data?h._original_data:e.Resource.getDataToStore(h).data){if(g.constructor===Blob||g.constructor===File){if(!(b||g.data&&g.data.constructor===ArrayBuffer)){console.warn("Not support to store File or Blob, please, use ArrayBuffer");continue}g=g.data}c[f]=g}else console.warn("Wrong data in resource")}}return c},resourceModified:function(a){if(a)if(a.constructor===String)console.warn("resourceModified parameter must be a resource, not a string");else{delete a._original_data;delete a._original_file;
a.remotepath&&(a._modified=!0);LEvent.trigger(this,"resource_modified",a);if(a.from_pack&&a.from_pack.constructor===String){var b=e.ResourcesManager.getResource(a.from_pack);b&&this.resourceModified(b)}a.from_prefab&&a.from_prefab.constructor===String&&(a=e.ResourcesManager.getResource(a.from_prefab))&&this.resourceModified(a)}},resourceSaved:function(a){a&&(delete a._modified,a.remotepath=a.fullpath,LEvent.trigger(this,"resource_saved",a))},load:function(a,b,c,d,f){if(!a)return console.error("LS.ResourcesManager.load requires url");
b&&b.constructor===Function&&!c&&(c=b,b=null);var h=this.resources[a];if(null!=h&&!(h.is_preview||b&&b.force||d))return c&&c(h,a),!0;b=b||{};d=this.getExtension(a);if(!d&&!this.resources[a])return console.warn("Cannot load a file without extension: "+a),!1;if(!this.resources_not_found[a])if(this.resources_being_loaded[a])c&&this.resources_being_loaded[a].push({options:b,callback:c});else if(!this.resources_being_processed[a]){if(this.allow_base_files||-1!=a.indexOf("/")){this.resources_being_loaded[a]=
[{options:b,callback:c}];LEvent.trigger(e.ResourcesManager,"resource_loading",a);this.num_resources_being_loaded++;h=this.getFullURL(a);(c=e.Formats.getFileFormatInfo(d))&&c.has_preview&&!b.is_preview&&LEvent.trigger(this,"load_resource_preview",a);h={url:h,success:function(c){e.ResourcesManager.processResource(a,c,b,e.ResourcesManager._resourceLoadedEnd,!0)},error:function(b){e.ResourcesManager._resourceLoadedError(a,b);f&&f(a)},progress:function(b){var c=0;b.total&&(c=b.loaded/b.total);LEvent.hasBind(e.ResourcesManager,
"resource_loading_progress")&&LEvent.trigger(e.ResourcesManager,"resource_loading_progress",{url:a,event:b,progress:c});LEvent.hasBind(e.ResourcesManager,"loading_resources_progress")&&LEvent.trigger(e.ResourcesManager,"loading_resources_progress",1-(e.ResourcesManager.num_resources_being_loaded-c)/e.ResourcesManager._total_resources_to_load)}};h.nocache=this.ignore_cache||-1!=this.force_nocache_extensions.indexOf[d]||this.nocache_files[a];if(c=e.Formats.supported[d])c.dataType&&(h.dataType=c.dataType),
c.mimeType&&(h.mimeType=c.mimeType),c["native"]&&(h.dataType=null);e.Network.request(h);return!1}this._parsing_local_file||console.warn("Cannot load resource, filename has no folder and LS.ResourcesManager.allow_base_files is set to false: ",a)}},processResource:function(a,b,c,d,f){if((c=c||{})&&c.constructor!==Object)throw"processResource options must be object";if(null===b||void 0===b)throw"No data found when processing resource: "+a;var h=null,g=this.getExtension(a),k=null;g&&(k=e.Formats.supported[g]);
var m=function(a,c,h){c?(k&&k.convert_to&&g!=k.convert_to&&(a+="."+k.convert_to,c.filename+="."+k.convert_to,c.fullpath&&(c.fullpath+="."+k.convert_to),h.filename&&(h.filename+="."+k.convert_to)),e.ResourcesManager.processFinalResource(a,c,h,d,f),!e.ResourcesManager.keep_files||b.constructor!=ArrayBuffer&&b.constructor!=String||c._original_data||c._original_file||g!=e.ResourcesManager.getExtension(c.filename)||(c._original_data=b)):e.ResourcesManager._resourceLoadedEnd(a,null)};this.resources_being_processed[a]=
!0;if(!g)return this.processDataResource(a,b,c,m);if(h=this.resource_pre_callbacks[g.toLowerCase()])h=h(a,b,c,m),!0!==h&&(h?m(a,h,c):(console.warn("resource preprocessor_callback returned null"),this._resourceLoadedError(a,"Resource couldn't be processed")));else if(k&&(k.type||k.parse)){h=null;switch(k.type){case "scene":h=e.ResourcesManager.processScene(a,b,c,m);break;case "mesh":h=e.ResourcesManager.processTextMesh(a,b,c,m);break;case "texture":case "image":h=e.ResourcesManager.processImage(a,
b,c,m);break;default:k.parse?(h=k.parse(b))&&m(a,h,c):console.warn("Format Info without parse function")}h&&!0!==h&&m(a,h,c)}else{h=null;k&&k.resourceClass?h=new k.resourceClass:(h=this.resources[a])&&h.constructor===e.Resource?(delete h._original_data,delete h._original_file,h._modified=!1):h=new e.Resource;if(h.setData)h.setData(b,!0);else throw"Resource without setData, cannot assign";h&&(h.filename=h.fullpath=a,m(a,h,c))}},processFinalResource:function(a,b,c,d,f){if(!b||b.constructor===String)return e.ResourcesManager._resourceLoadedError(a,
"error processing the resource");b.filename=a;c.filename&&(b.filename=c.filename);c.is_local?a=b.fullpath=b.filename:b.fullpath=a;c.from_prefab&&(b.from_prefab=c.from_prefab);c.from_pack&&(b.from_pack=c.from_pack);f&&(b.remotepath=a);c.is_preview&&(b.is_preview=!0);e.ResourcesManager.resources_being_processed[a]&&delete e.ResourcesManager.resources_being_processed[a];b.getResources&&e.ResourcesManager.loadResources(b.getResources({}));e.ResourcesManager.registerResource(a,b);c.preview_of&&e.ResourcesManager.registerResource(c.preview_of,
b);d&&d(a,b,c)},registerResource:function(a,b){if(!a||!b)throw"registerResource missing filename or resource";":"!=a[0]&&!1==this.valid_resource_name_reg.test(a)&&"http"!=a.substr(0,4)&&console.warn("invalid filename for resource: ",a);a=this.cleanFullpath(a);if(!(this.resources[a]===b||b.is_preview&&this.resources[a])){b.filename=a;b.object_class||(b.object_class=e.getObjectClassName(b));var c=b.object_class;b.constructor.resource_type&&(c=b.constructor.resource_type);this.resources[a]=b;(c=this.resource_post_callbacks[c])&&
c(a,b);b.is_preview||LEvent.trigger(this,"resource_registered",b);e.GlobalScene.requestFrame()}},unregisterResource:function(a){var b=this.resources[a];if(!b)return!1;delete this.resources[a];this.meshes[a]&&delete this.meshes[a];this.textures[a]&&delete this.textures[a];this.materials[a]&&delete this.materials[a];b.constructor!==e.Pack&&b.constructor!==e.Prefab||b.setResourcesLink(null);LEvent.trigger(this,"resource_unregistered",b);e.GlobalScene.requestFrame();return!0},getURLasFile:function(a,
b){var c=new XMLHttpRequest;c.open("GET",this.getFullURL(a),!0);c.responseType="blob";c.onload=function(d){d=c.response;b&&b(d,a)};c.send()},renameResource:function(a,b,c){var d=this.resources[a];if(!d)return!1;this.resources[b]&&console.warn("There is a resource already with this name, overwritting it: "+b);d.filename=b;d.fullpath&&(d.fullpath=b);this.resources[b]=d;delete this.resources[a];c||e.GlobalScene.sendResourceRenamedEvent(a,b,d);for(var f in this.resources){var h=this.resources[f];if(h!=
d&&h.onResourceRenamed)h.onResourceRenamed(a,b,d)}this.meshes[a]&&(delete this.meshes[a],this.meshes[b]=d);this.textures[a]&&(delete this.textures[a],this.textures[b]=d);this.materials[a]&&(delete this.materials[a],this.materials[b]=d);this.resources_renamed_recently[a]=b;c||LEvent.trigger(e.ResourcesManager,"resource_renamed",[a,b,d]);return!0},isLoading:function(a){return a?this.resources_being_loaded[a]||this.resources_being_processed[a]?!0:!1:0<this.num_resources_being_loaded},clearNotFoundResources:function(){this.resources_not_found=
{}},computeImageMetadata:function(a){return{width:a.width,height:a.height}},getMesh:function(a){return a?a.constructor===String?this.meshes[a]:a.constructor===GL.Mesh?a:null:null},getTexture:function(a){return a?a.constructor===String?this.textures[a]:a.constructor===GL.Texture?a:null:null},getMaterial:function(a){if(a)return"@"==a[0]?this.materials_by_uid[a]:this.materials[a]},onceLoaded:function(a,b){var c=this.resource_once_callbacks[a];if(!c)this.resource_once_callbacks[a]=[b];else if(-1==c.indexOf(b))return c.push(b),
c.length-1},cancelOnceLoaded:function(a,b){var c=this.resource_once_callbacks[a];c&&(c[b]=null)},_resourceLoadedEnd:function(a,b){e.ResourcesManager.debug&&console.log("RES: "+a+" ---\x3e "+e.ResourcesManager.num_resources_being_loaded);if(b){var c=e.ResourcesManager.resources_being_loaded[a];if(c)for(var d=0;d<c.length;++d)null!=c[d].callback&&c[d].callback(b,a);if(c=e.ResourcesManager.resource_once_callbacks[a]){for(d=0;d<c.length;++d)if(c[d])c[d](a,b);delete e.ResourcesManager.resource_once_callbacks[a]}}e.ResourcesManager.resources_being_loaded[a]&&
(delete e.ResourcesManager.resources_being_loaded[a],e.ResourcesManager.num_resources_being_loaded--,b?LEvent.trigger(e.ResourcesManager,"resource_loaded",a):LEvent.trigger(e.ResourcesManager,"resource_problem_loading",a),LEvent.trigger(e.ResourcesManager,"loading_resources_progress",1-e.ResourcesManager.num_resources_being_loaded/e.ResourcesManager._total_resources_to_load),0==e.ResourcesManager.num_resources_being_loaded&&(LEvent.trigger(e.ResourcesManager,"end_loading_resources",!0),e.ResourcesManager._total_resources_to_load=
0));e.GlobalScene.requestFrame()},_resourceLoadedError:function(a,b){console.log("Error loading "+a);delete e.ResourcesManager.resources_being_loaded[a];delete e.ResourcesManager.resource_once_callbacks[a];e.ResourcesManager.resources_not_found[a]=!0;LEvent.trigger(e.ResourcesManager,"resource_not_found",a);e.ResourcesManager.num_resources_being_loaded--;0==e.ResourcesManager.num_resources_being_loaded&&LEvent.trigger(e.ResourcesManager,"end_loading_resources",!1)}};e.RM=e.ResourcesManager=ub;e.getTexture=
function(a){return e.ResourcesManager.getTexture(a)};e.ResourcesManager.registerResourcePreProcessor("wbin",function(a,b,c){if(b.constructor===Object&&b.object_class){if(e.Classes[b.object_class]){if((c=e.Classes[b.object_class]||window[b.object_class])&&c.fromBinary)return c.fromBinary(b,a);c&&c.prototype.fromBinary&&(b=new c,b.fromBinary(object,a))}return b}return WBin.load(b,!1,a)},"binary");e.ResourcesManager.registerResourcePreProcessor("json",function(a,b,c){c=b;if(b.constructor===String)try{b=
JSON.parse(b)}catch(d){return console.error("invalid JSON"),null}c=b.object_class||b.object_type;!c&&b.material_class&&(c=b.material_class);if(!c){var f=e.ResourcesManager.getExtension(a,!0);(f=e.ResourceClasses_by_extension[f])&&(c=e.getClassName(f))}if(c&&!b.is_data)if(f=e.Classes[c]||window[c])f.prototype.configure?(c=new f,c.configure(b)):c=new f(b);else return console.error("JSON object_class class not found: "+c),null;else c=new e.Resource,c.filename=a,c._data=b,c.type="json",c.category="json";
return c});e.ResourcesManager.registerResourcePreProcessor("zip",function(a,b,c){if(!Y.JSZip)throw"JSZip not found. To use ZIPs you must have the JSZip.js library included in the website.";(new JSZip).loadAsync(b).then(function(a){a.forEach(function(a,b){if(!b.dir){var d=e.ResourcesManager.getExtension(a),d=e.Formats.supported[d];b.async(d&&"text"==d.dataType?"string":"arraybuffer").then(function(b){"scene.json"!=a||c&&c.to_memory?e.ResourcesManager.processResource(a,b):e.GlobalScene.configure(JSON.parse(b))})}})});
return!0},"binary");e.ResourcesManager.processDataResource=function(a,b,c,d){b.constructor===String&&(b=JSON.parse(b));if(b.constructor==ArrayBuffer){if(!b.byteLength)return console.warn("Empty WBin?"),null;h=WBin.load(b);d&&d(a,h,c);return h}var f=b.object_class;if(f&&e.Classes[f]){var h=null;e.Classes[f].prototype.configure?(h=new e.Classes[f],h.configure(b)):h=new e.Classes[f](b);d&&d(a,h,c);return h}console.warn("Resource Class name unknown: "+f);return!1};e.ResourcesManager.processImage=function(a,
b,c,d){function f(f){f&&e.ResourcesManager.keep_files&&(f._original_data=b);e.ResourcesManager.keep_urls?f._local_url=k:URL.revokeObjectURL(k);d&&d(a,f,c)}var h=e.ResourcesManager.getExtension(a),g="application/octet-stream";if("jpg"==h||"jpeg"==h)g="image/jpg";else if("webp"==h)g="image/webp";else if("gif"==h)g="image/gif";else if("png"==h)g="image/png";else if(h=e.Formats.supported[h],h.mimetype)g=h.mimetype;else{h=this.processImageNonNative(a,b,c);f(h);return}var h=new Blob([b],{type:g}),k=URL.createObjectURL(h),
h=new Image;h.src=k;h.real_filename=a;h.onload=function(){var a=e.ResourcesManager.processTexture(this.real_filename,this,c);f(a)};h.onerror=function(b){URL.revokeObjectURL(k);d&&d(a,null,c);console.error("Error while loading image, file is not native image format: "+a)};return!0};e.ResourcesManager.processImageNonNative=function(a,b,c){b=(new Uint8Array(b)).buffer;c=e.Formats.parse(a,b,c);return c?c.constructor==GL.Texture?(c.filename=a,c._original_data=b,c):c=e.ResourcesManager.processTexture(a,
c):(console.error("Cannot parse image format"),null)};e.ResourcesManager.processTexture=function(a,b,c){if(b.width==b.height/6||-1!=a.indexOf("CUBECROSS"))c={wrapS:gl.MIRROR,wrapT:gl.MIRROR,magFilter:gl.LINEAR,minFilter:gl.LINEAR_MIPMAP_LINEAR},-1!=a.indexOf("CUBECROSSL")&&(c.is_cross=1),c=GL.Texture.cubemapFromImage(b,c);else{c=gl.LINEAR;var d=gl.REPEAT,f=gl.LINEAR_MIPMAP_LINEAR;isPowerOfTwo(b.width)&&isPowerOfTwo(b.height)||(f=gl.LINEAR,d=gl.CLAMP_TO_EDGE);c=b.pixels?GL.Texture.fromMemory(b.width,
b.height,b.pixels,{format:24==b.bpp?gl.RGB:gl.RGBA,no_flip:b.flipY,wrapS:d,wrapT:d,magFilter:c,minFilter:f}):GL.Texture.fromImage(b,{format:gl.RGBA,wrapS:d,wrapT:d,magFilter:c,minFilter:f})}if(c)return c.img=b,c.filename=a,c.generateMetadata(),c};e.ResourcesManager.processTextMesh=function(a,b,c){b=e.Formats.parse(a,b,c);return null==b?(console.error("Error parsing mesh: "+a),null):GL.Mesh.load(b)};e.ResourcesManager.processScene=function(a,b,c){b=e.Formats.parse(a,b,c);if(null==b)return console.error("Error parsing scene: "+
a),null;if(b&&b.constructor===e.Scene)throw"processScene must receive object, no Scene";if(!b.root)throw"this is not an scene, root property missing";e.ResourcesManager._parsing_local_file=!0;for(var d in b.meshes)e.ResourcesManager.processResource(d,b.meshes[d]);for(d in b.resources)e.ResourcesManager.processResource(d,b.resources[d]);for(d in b.materials)e.ResourcesManager.processResource(d,b.materials[d]);a=new e.SceneNode;a.configure(b.root);c&&c.filename&&"json"!=e.RM.getExtension(c.filename)&&
(c.filename+=".json");e.ResourcesManager._parsing_local_file=!1;return a};e.ResourcesManager.loadTextureAtlas=function(a,b,c){var d=new Image;d.src=this.getFullURL(a.filename);d.onload=function(){var d=a.thumbnail_size,h=document.createElement("canvas");h.width=d;h.height=d;var d=h.getContext("2d"),g;for(g in a.textures){var k=a.textures[g];d.clearRect(0,0,h.width,h.height);d.drawImage(this,-k.pos[0],-k.pos[1]);var m=GL.Texture.fromImage(h,{format:GL.RGBA,magFilter:gl.LINEAR,minFilter:gl.LINEAR_MIPMAP_LINEAR,
wrap:gl.REPEAT});c||(m.is_preview=!0);e.ResourcesManager.registerResource(k.name,m)}e.GlobalScene.requestFrame();b&&b()}};e.ResourcesManager.registerResourcePostProcessor("Mesh",function(a,b){b.object_class="Mesh";b.metadata&&(b.metadata={},b.generateMetadata());if(!b.bounding||b.bounding.length!=BBox.data_length||b.info&&b.info.groups&&b.info.groups.length&&!b.info.groups[0].bounding)b.bounding=null,b.updateBoundingBox();b.getBuffer("normals")||b.computeNormals();e.ResourcesManager.free_data&&b.freeData();
e.ResourcesManager.meshes[a]=b});e.ResourcesManager.registerResourcePostProcessor("Texture",function(a,b){e.ResourcesManager.textures[a]=b});e.ResourcesManager.registerResourcePostProcessor("Material",function(a,b){e.ResourcesManager.materials[a]=b;e.ResourcesManager.materials_by_uid[b.uid]=b;b.prepare&&b.prepare(e.GlobalScene)});e.ResourcesManager.registerResourcePostProcessor("Pack",function(a,b){b.flagResources()});e.ResourcesManager.registerResourcePostProcessor("Prefab",function(a,b){b.applyToNodes()});
e.ResourcesManager.registerResourcePostProcessor("ShaderCode",function(a,b){b.applyToMaterials()});GL.Mesh.load_priority=-10;var Xb={snippets:{},shader_blocks_by_id:new Map,shader_blocks:[],num_shaderblocks:0,global_extra_code:null,dump_compile_errors:!0,on_compile_error:null,init:function(a,b){this.global_extra_code=String.fromCharCode(10)+"#define WEBGL\n";if(2==gl.webgl_version||gl.extensions.OES_standard_derivatives)this.global_extra_code+="#define STANDARD_DERIVATIVES\n";if(2==gl.webgl_version||
gl.extensions.WEBGL_draw_buffers)this.global_extra_code+="#define DRAW_BUFFERS\n"},reloadShaders:function(a){},compile:function(a,b,c){if(!c)throw"compileShader must have a name specified";if(!gl)return null;var d=null;try{a=this.global_extra_code+a;b=this.global_extra_code+b;var f=this.compiled_shaders[c+":VS"];f||(f=this.compiled_shaders[c+":VS"]=GL.Shader.compileSource(gl.VERTEX_SHADER,a));var e=this.compiled_shaders[c+":FS"];e||(e=this.compiled_shaders[c+":FS"]=GL.Shader.compileSource(gl.FRAGMENT_SHADER,
b));var g=getTime(),d=new GL.Shader(f,e);this.debug&&console.log("Shader compile time: ",(getTime()-g).toFixed(3),"ms");d.name=c}catch(k){this.dump_compile_errors&&(this.dumpShaderError(c,k,a,b),this.dump_compile_errors=!1);if(this.on_compile_error)this.on_compile_error(k);return null}return d},clearShaderCodeCache:function(){var a=[],b=e.StandardMaterial.shader_codes,c;for(c in b)a.push(b[c]);b=e.ResourcesManager.resources;for(c in b)b[c].constructor===e.ShaderCode&&a.push(b[c]);for(c in a)a[c].clearCache()},
dumpShaderError:function(a,b,c,d){console.error("Error compiling shader: "+a);console.log(b);console.groupCollapsed("Vertex Shader Code");a=(this.global_extra_code+c).split("\n");for(var f in a)console.log(f+": "+a[f]);console.groupEnd();console.groupCollapsed("Fragment Shader Code");a=(this.global_extra_code+d).split("\n");for(f in a)console.log(f+": "+a[f]);console.groupEnd()},registerSnippet:function(a,b){this.snippets[a]={id:a,code:b}},getSnippet:function(a){return this.snippets[a]},registerShaderBlock:function(a,
b){var c=-1;this.shader_blocks_by_id.get(a)?(console.warn("There is already a ShaderBlock with that name, replacing it: ",a),c=this.shader_blocks_by_id.get(a).flag_id,this.clearShaderCodeCache()):c=this.num_shaderblocks++;64<=c&&console.warn("Too many shaderblocks registered, not enought bits in a 64bits variable");b.flag_id=c;b.flag_mask=1<<c;this.shader_blocks_by_id.set(a,b);this.shader_blocks[c]=b},getShaderBlock:function(a){return a.constructor===String?this.shader_blocks_by_id.get(a):this.shader_blocks[a]},
common_vscode:"\n\t\tprecision mediump float;\n\t\tattribute vec3 a_vertex;\n\t\tattribute vec3 a_normal;\n\t\tattribute vec2 a_coord;\n\t\tuniform mat4 u_model;\n\t\tuniform mat4 u_viewprojection;\n\t",common_fscode:"\n\t\tprecision mediump float;\n\t"};e.Shaders=Xb;fb.prototype.defineContextMacros=function(a){this.context_macros=a};fb.prototype.addCode=function(a,b,c,d){c=c||"";b={enabled:new e.GLSLCode(b||""),disabled:new e.GLSLCode(c),macros:d};this.code_map.set(a,b)};fb.prototype.bindEvent=function(a,
b){this.events||(this.events={});this.events[a]=b};fb.prototype.getFinalCode=function(a,b,c){b=b||0;var d=this.code_map.get(a);if(!d)return null;a=(b&this.flag_mask?d.enabled:d.disabled).getFinalCode(a,b,c);if(d.macros){b="";for(var f in d.macros)b+="#define "+f+d.macros[f]+"\n";a=b+a}return a};fb.prototype.register=function(){e.Shaders.registerShaderBlock(this.name,this)};fb.prototype.checkDependencies=function(a){};e.ShaderBlock=fb;e.GLSLCode=fa;fa.pragma_methods={};fa.CODE=1;fa.PRAGMA=2;fa.INCLUDE=
1;fa.SHADERBLOCK=2;fa.SNIPPET=3;fa.EVENT=4;fa.prototype.parse=function(){var a=this.code.replace(/(\/\*([\s\S]*?)\*\/)|(\/\/(.*)$)/gm,"");this.fragments=[];this.pragmas={};this.uniforms={};this.streams={};this.includes={};this.snippets={};this.shader_blocks={};this.is_dynamic=!1;for(var b=[],a=a.split("\n"),c=0;c<a.length;c++){var d=a[c].trim();if(d.length)if("#"!=d[0]){var f=d.split(" ");if("uniform"==f[0]){var h=f[2].split(";");this.uniforms[h[0]]=f[1]}else"attribute"==f[0]&&(h=f[2].split(";"),
this.attributes[h[0]]=f[1]);b.push(d)}else if(f=d.split(" "),"#pragma"==f[0]){h=b.join("\n");h.trim()&&this.fragments.push({type:fa.CODE,code:h});this.is_dynamic=!0;this.pragmas[f[2]]=!0;h=f[1];b.length=0;var d={type:fa.PRAGMA,line:d,action:h,param:f[2]},g=e.GLSLCode.pragma_methods[h];g&&g.parse?!1!==g.parse.call(this,d,f)&&this.fragments.push(d):console.warn("#pragma action unknown: ",h)}else b.push(d)}b.length&&(h=b.join("\n"),h.trim()&&this.fragments.push({type:fa.CODE,code:h}));return!0};fa.prototype.getFinalCode=
function(a,b,c){if(!this.is_dynamic)return this.code;var d="";c=c||{};for(var f=this.fragments,e=0;e<f.length;++e){var g=f[e];if(g.type===fa.CODE)d+=g.code;else{var k=fa.pragma_methods[g.action];k&&k.getCode&&(g=k.getCode.call(this,a,g,b,c))&&(d+=g)}}return d};fa.pragma_methods.include={parse:function(a,b){if(!b[2])return console.error("shader include without path"),!1;a.action_type=fa.INCLUDE;var c=b[2].substr(1,b[2].length-2).split(":"),d=c[1];a.include=c[0];a.include_subfile=d;this.includes[a.include]=
!0},getCode:function(a,b,c,d){a="";a=b.include;if(e.ResourcesManager.getExtension(a)){c=e.ResourcesManager.getResource(a,e.ShaderCode);if(!c)return e.ResourcesManager.load(a),null;if(b.include_subfile){b=c._subfiles[b.include_subfile];if(void 0===b)return null;a="\n"+b+"\n"}else a="\n"+c._subfiles[""]+"\n"}else{b=e.Shaders.getSnippet(a);if(!b)return null;a="\n"+b.code+"\n"}return a}};fa.pragma_methods.define={parse:function(a,b){var c=b[2],d=b[3];if(!c||!d)return console.error("#pragma define missing parameters"),
!1;a.define=[c,d.substr(1,d.length-2)]},getCode:function(a,b,c,d){d[b.define[0]]=b.define[1]}};fa.pragma_methods.shaderblock={parse:function(a,b){if(!b[2])return console.error("#pragma shaderblock without name"),!1;a.action_type=fa.SHADERBLOCK;var c=b[2];'"'==c[0]?(a.shader_block=[1,c.substr(1,c.length-2)],this.shader_blocks[a.shader_block[1]]=!0):(a.shader_block=[2,c],b[3]&&(a.shader_block.push(b[3].substr(1,b[3].length-2)),this.shader_blocks[a.shader_block[2]]=!0))},getCode:function(a,b,c,d){var f=
b.shader_block[1];if(2==b.shader_block[0]&&(f=d[f]?d[f]:b.shader_block[2],!f))return console.error("ShaderBlock: no context var found: "+f),null;b=e.Shaders.getShaderBlock(f);return b?(a=b.getFinalCode(a,c,d))?b.flag_mask&c?"\n#define BLOCK_"+b.name.toUpperCase()+"\n"+a+"\n":a+"\n":null:null}};fa.pragma_methods.snippet={parse:function(a,b){if(!b[2])return console.error("#pragma snippet without name"),!1;a.action_type=fa.SNIPPET;var c=b[2].substr(1,b[2].length-2);a.snippet=c;this.snippets[c]=!0},getCode:function(a,
b,c,d){a=e.Shaders.getSnippet(b.snippet);return a?"\n"+a.code+"\n":(console.error("ShaderCode uses unknown Snippet: ",b.snippet),null)}};fa.pragma_methods.event={parse:function(a,b){if(!b[2])return console.error("#pragma event without name"),!1;a.action_type=fa.EVENT;var c=b[2].substr(1,b[2].length-2);a.event=c},getCode:function(a,b,c,d){a="\n";d=0;for(var f=e.Shaders.shader_blocks.length;d<f;++d){var h=e.Shaders.shader_blocks[d];c&h.flag_mask&&h.events&&(h=h.events[b.event])&&(a+=h+"\n")}return a}};
fa.breakLines=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c].trim();if(d){var f=d.lastIndexOf(";");if(-1==f||f==a.length-1)b.push(d);else for(d=d.split(";"),f=0;f<d.length;++f)d[f]&&b.push(d[f]+";")}}return b};e.Shaders.registerSnippet("input","\n\t\t\t//used to store topology input information\n\t\t\tstruct Input {\n\t\t\t\tvec4 color;\n\t\t\t\tvec3 vertex;\n\t\t\t\tvec3 normal;\n\t\t\t\tvec2 uv;\n\t\t\t\tvec2 uv1;\n\t\t\t\t\n\t\t\t\tvec3 camPos;\n\t\t\t\tvec3 viewDir;\n\t\t\t\tvec3 worldPos;\n\t\t\t\tvec3 worldNormal;\n\t\t\t\tvec4 screenPos;\n\t\t\t};\n\t\t\t\n\t\t\tInput getInput()\n\t\t\t{\n\t\t\t\tInput IN;\n\t\t\t\tIN.color = vec4(1.0);\n\t\t\t\tIN.vertex = v_pos;\n\t\t\t\tIN.normal = v_normal;\n\t\t\t\tIN.uv = v_uvs;\n\t\t\t\tIN.uv1 = IN.uv;\n\t\t\t\t\n\t\t\t\tIN.camPos = u_camera_eye;\n\t\t\t\tIN.viewDir = normalize(u_camera_eye - v_pos);\n\t\t\t\tIN.worldPos = v_pos;\n\t\t\t\tIN.worldNormal = normalize(v_normal);\n\t\t\t\t//IN.screenPos = vec4( (v_screenpos.xy / v_screenpos.w) * 0.5 + vec2(0.5), v_screenpos.zw );  //sometimes we need also z and w, thats why we pass all\n\t\t\t\tIN.screenPos = vec4( (gl_FragCoord.xy / gl_FragCoord.w) * 0.5 + vec2(0.5), gl_FragCoord.zw );  //sometimes we need also z and w, thats why we pass all\n\t\t\t\treturn IN;\n\t\t\t}\n\t");
e.Shaders.registerSnippet("structs","\n\t\t\t//used to store topology input information\n\t\t\tstruct Input {\n\t\t\t\tvec4 color;\n\t\t\t\tvec3 vertex;\n\t\t\t\tvec3 normal;\n\t\t\t\tvec2 uv;\n\t\t\t\tvec2 uv1;\n\t\t\t\t\n\t\t\t\tvec3 camPos;\n\t\t\t\tvec3 viewDir;\n\t\t\t\tvec3 worldPos;\n\t\t\t\tvec3 worldNormal;\n\t\t\t\tvec4 screenPos;\n\t\t\t};\n\t\t\t\n\t\t\t//used to store surface shading properties\n\t\t\tstruct SurfaceOutput {\n\t\t\t\tvec3 Albedo;\n\t\t\t\tvec3 Normal; //separated in case there is a normal map\n\t\t\t\tvec3 Emission;\n\t\t\t\tvec3 Ambient;\n\t\t\t\tfloat Specular;\n\t\t\t\tfloat Gloss;\n\t\t\t\tfloat Alpha;\n\t\t\t\tfloat Reflectivity;\n\t\t\t\tvec4 Extra; //for special purposes\n\t\t\t};\n\t\t\t\n\t\t\t//used to store light contribution\n\t\t\t//CAREFUL: this one is different than \n\t\t\tstruct FinalLight {\n\t\t\t\tvec3 Color;\n\t\t\t\tvec3 Ambient;\n\t\t\t\tfloat Diffuse; //NdotL\n\t\t\t\tfloat Specular; //RdotL\n\t\t\t\tvec3 Emission;\n\t\t\t\tvec3 Reflection;\n\t\t\t\tfloat Attenuation;\n\t\t\t\tfloat Shadow; //1.0 means fully lit\n\t\t\t};\n\t");
e.Shaders.registerSnippet("spotFalloff","\n\t\t\tfloat spotFalloff(vec3 spotDir, vec3 lightDir, float angle_phi, float angle_theta)\n\t\t\t{\n\t\t\t\tfloat sqlen = dot(lightDir,lightDir);\n\t\t\t\tfloat atten = 1.0;\n\t\t\t\t\n\t\t\t\tvec4 spotParams = vec4( angle_phi, angle_theta, 1.0, 0.0 );\n\t\t\t\tspotParams.w = 1.0 / (spotParams.x-spotParams.y);\n\t\t\t\t\n\t\t\t\tvec3 dirUnit = lightDir * sqrt(sqlen); //we asume they are normalized\n\t\t\t\tfloat spotDot = dot(spotDir, -dirUnit);\n\t\t\t\tif (spotDot <= spotParams.y)// spotDot <= cos phi/2\n\t\t\t\t\treturn 0.0;\n\t\t\t\telse if (spotDot > spotParams.x) // spotDot > cos theta/2\n\t\t\t\t\treturn 1.0;\n\t\t\t\t\n\t\t\t\t// vertex lies somewhere beyond the two regions\n\t\t\t\tfloat ifallof = pow( (spotDot-spotParams.y)*spotParams.w,spotParams.z );\n\t\t\t\treturn ifallof;\n\t\t\t}\n\t");
e.Shaders.registerSnippet("getFlatNormal","\n\t\t\t#ifdef STANDARD_DERIVATIVES\n\t\t\t\t#extension GL_OES_standard_derivatives : enable \n\t\t\t\tvec3 getFlatNormal(vec3 pos)\n\t\t\t\t{\n\t\t\t\t\tvec3 A = dFdx( pos );\n\t\t\t\t\tvec3 B = dFdy( pos );\n\t\t\t\t\treturn normalize( cross(A,B) );\n\t\t\t\t}\n\t\t\t#else\n\t\t\t\tvec3 getFlatNormal(vec3 pos)\n\t\t\t\t{\n\t\t\t\t\treturn vec3(0.0);\n\t\t\t\t}\n\t\t\t#endif\n\t");e.Shaders.registerSnippet("perturbNormal","\n\t\t\t#ifdef STANDARD_DERIVATIVES\n\t\t\t\t#extension GL_OES_standard_derivatives : enable \n\t\t\t#endif\n\t\t\t\n\t\t\t\tmat3 cotangent_frame(vec3 N, vec3 p, vec2 uv)\n\t\t\t\t{\n\t\t\t\t\t// get edge vectors of the pixel triangle\n\t\t\t\t\t#ifdef STANDARD_DERIVATIVES\n\t\t\t\t\t\n\t\t\t\t\tvec3 dp1 = dFdx( p );\n\t\t\t\t\tvec3 dp2 = dFdy( p );\n\t\t\t\t\tvec2 duv1 = dFdx( uv );\n\t\t\t\t\tvec2 duv2 = dFdy( uv );\n\t\t\t\t\t\n\t\t\t\t\t// solve the linear system\n\t\t\t\t\tvec3 dp2perp = cross( dp2, N );\n\t\t\t\t\tvec3 dp1perp = cross( N, dp1 );\n\t\t\t\t\tvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n\t\t\t\t\tvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\t\t\t\t\t#else\n\t\t\t\t\tvec3 T = vec3(1.0,0.0,0.0); //this is wrong but its a fake solution\n\t\t\t\t\tvec3 B = cross(N,T);\n\t\t\t\t\tT = cross(B,N);\n\t\t\t\t\t#endif\n\t\t\t\t\t \n\t\t\t\t\t// construct a scale-invariant frame \n\t\t\t\t\tfloat invmax = inversesqrt( max( dot(T,T), dot(B,B) ) );\n\t\t\t\t\treturn mat3( T * invmax, B * invmax, N );\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tvec3 perturbNormal( vec3 N, vec3 V, vec2 texcoord, vec3 normal_pixel )\n\t\t\t\t{\n\t\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t\t\treturn N;\n\t\t\t\t\t#endif\n\t\t\t\t\t\n\t\t\t\t\t// assume N, the interpolated vertex normal and \n\t\t\t\t\t// V, the view vector (vertex to eye)\n\t\t\t\t\t//vec3 normal_pixel = texture2D(normalmap, texcoord ).xyz;\n\t\t\t\t\tnormal_pixel = normal_pixel * 255./127. - 128./127.;\n\t\t\t\t\tmat3 TBN = cotangent_frame(N, V, texcoord);\n\t\t\t\t\treturn normalize(TBN * normal_pixel);\n\t\t\t\t}\n\t\t");
e.Shaders.registerSnippet("bumpNormal","\n\t\t\t#ifdef STANDARD_DERIVATIVES\n\t\t\t\t#extension GL_OES_standard_derivatives : enable \n\t\t\t#endif\n\t\t\t\t\n\t\t\t\t// Calculate the surface normal using screen-space partial derivatives of the height field\n\t\t\t\tvec3 bumpNormal(vec3 position, vec3 normal, sampler2D texture, vec2 uvs, float factor)\n\t\t\t\t{\n\t\t\t\t#ifdef STANDARD_DERIVATIVES\n\t\t\t        vec3 dpdx = dFdx(position);\n\t\t\t        vec3 dpdy = dFdy(position);\n\t\t\t\t\tvec3 r1 = cross(dpdy, normal);\n\t\t\t\t\tvec3 r2 = cross(normal, dpdx);\n\t\t\t\t\t\n\t\t\t\t\tvec2 dtdx = dFdx(uvs) * factor;\n\t\t\t\t\tvec2 dtdy = dFdy(uvs) * factor;\n\t\t\t\t\t\n\t\t\t        float h = texture2D( texture,  uvs ).r;\n\t\t\t        float hdx = texture2D( texture,  uvs + dtdx ).r;\n\t\t\t        float hdy = texture2D( texture,  uvs + dtdy ).r;\n\t\t\t\t\t\n\t\t\t\t\treturn normalize(normal + (r1 * (hdx - h) - r2 * (hdy - h)) / dot(dpdx, r1));\n\t\t\t\t#else\n\t\t\t\t\treturn normal;\n\t\t\t\t#endif\n\t\t\t\t}\n\t\t");
e.Shaders.registerSnippet("computePointSize","\n\t\t\tfloat computePointSize(float radius, float w)\n\t\t\t{\n\t\t\t\tif(radius < 0.0)\n\t\t\t\t\treturn -radius;\n\t\t\t\treturn u_viewport.w * u_camera_perspective.z * radius / w;\n\t\t\t}\n\t");GL.Mesh.prototype.convertBoneNames=function(a,b){if(!this.bones||!this.bones.length)return 0;a=a||e.GlobalScene;a.constructor==e.Scene&&(a=a.root);if(!a.findNode)return console.error("convertBoneNames first parameter must be node or scene"),0;for(var c=!1,
d=0;d<this.bones.length;++d){var f=this.bones[d],h=f[0];if(b)h[0]!=e._uid_prefix&&((g=a.findNode(h))?(f[0]=g.uid,c=!0):console.warn("Bone node not found: "+h));else if(h[0]==e._uid_prefix){var g=a.findNode(h);g?(f[0]=g.name,c=!0):console.warn("Bone node not found: "+h)}}c&&e.RM.resourceModified(this)};x["@color"]={type:"color"};x.icon="mini-icon-material.png";x.last_index=0;x.NO_LIGHTS=0;x.ONE_LIGHT=1;x.SEVERAL_LIGHTS=2;x.COLOR="color";x.OPACITY="opacity";x.SPECULAR_FACTOR="specular_factor";x.SPECULAR_GLOSS=
"specular_gloss";x.OPACITY_TEXTURE="opacity";x.COLOR_TEXTURE="color";x.AMBIENT_TEXTURE="ambient";x.SPECULAR_TEXTURE="specular";x.EMISSIVE_TEXTURE="emissive";x.ENVIRONMENT_TEXTURE="environment";x.IRRADIANCE_TEXTURE="irradiance";x.COORDS_UV0="0";x.COORDS_UV1="1";x.COORDS_UV_TRANSFORMED="transformed";x.COORDS_SCREEN="screen";x.COORDS_SCREENCENTERED="screen_centered";x.COORDS_FLIPPED_SCREEN="flipped_screen";x.COORDS_POLAR="polar";x.COORDS_POLAR_REFLECTED="polar_reflected";x.COORDS_POLAR_VERTEX="polar_vertex";
x.COORDS_WORLDXZ="worldxz";x.COORDS_WORLDXY="worldxy";x.COORDS_WORLDYZ="worldyz";x.TEXTURE_COORDINATES=[x.COORDS_UV0,x.COORDS_UV1,x.COORDS_UV_TRANSFORMED,x.COORDS_SCREEN,x.COORDS_SCREENCENTERED,x.COORDS_FLIPPED_SCREEN,x.COORDS_POLAR,x.COORDS_POLAR_REFLECTED,x.COORDS_POLAR_VERTEX,x.COORDS_WORLDXY,x.COORDS_WORLDXZ,x.COORDS_WORLDYZ];x.DEFAULT_UVS={normal:x.COORDS_UV0,displacement:x.COORDS_UV0,environment:x.COORDS_POLAR_REFLECTED,irradiance:x.COORDS_POLAR};x.available_shaders="default global lowglobal phong_texture flat normal phong flat_texture cell_outline".split(" ");
x.prototype.fillUniforms=function(a,b){var c={},d=[];c.u_material_color=this._color;c.u_ambient_color=a.info?a.info.ambient_color:e.ONES;c.u_texture_matrix=this.uvs_matrix;c.u_specular=vec2.create([1,50]);var f=c.u_reflection=0,h;for(h in this.textures){var g=this.getTextureSampler(h);if(g){var k=x.getTextureFromSampler(g);k&&(d[f]=g,c[h+(k.texture_type==gl.TEXTURE_2D?"_texture":"_cubemap")]=f,f++)}}for(h in this.extra_uniforms)c[h]=this.extra_uniforms[h];this._uniforms=c;this._samplers=d};x.prototype.configure=
function(a){for(var b in a)"function"!==typeof a[b]&&!this.setProperty(b,a[b])&&e.debug&&console.warn("Material property not assigned: "+b)};x.prototype.serialize=function(a){var b=e.cloneObject(this);delete b.filename;delete b.fullpath;delete b.remotepath;b.material_class=e.getObjectClassName(this);a&&(delete b.render_state,delete b.flags,b.uvs_matrix&&b.uvs_matrix.equal([1,0,0,0,1,0,0,0,1])&&delete b.uvs_matrix);return b};x.prototype.clone=function(){var a=this.serialize();a.uid&&delete a.uid;return new this.constructor(JSON.parse(JSON.stringify(a)))};
x.prototype.loadAndSetTexture=function(a,b,c){c=c||{};var d=this;if(b&&b.constructor===String)":"!=b[0]?e.ResourcesManager.load(b,c,function(b){d.setTexture(a,b);if(c.on_complete)c.on_complete()}):this.setTexture(a,b);else if(this.setTexture(a,b),c.on_complete)c.on_complete()};x.prototype.getPropertiesInfo=function(){var a={color:"vec3",opacity:"number",uvs_matrix:"mat3"},b=this.getTextureChannels(),c;for(c in b)a["tex_"+b[c]]="Texture";return a};x.prototype.getProperty=function(a){return"tex_"==
a.substr(0,4)?this.textures[a.substr(4)]:this[a]};x.prototype.setProperty=function(a,b){if(void 0!==b){if("tex_"==a.substr(0,4))return(!b||b.constructor!==String&&b.constructor!==GL.Texture)&&b||this.setTexture(a.substr(4),b),!0;switch(a){case "queue":case "opacity":null!==b&&b.constructor===Number&&(this[a]=b);break;case "uid":this[a]=b;break;case "uvs_matrix":case "color":this[a].length==b.length&&this[a].set(b);break;case "textures":for(var c in b){var d=b[c];d&&d.constructor===String&&(d={texture:d,
uvs:"0",wrap:0,minFilter:0,magFilter:0});d._must_update=!0;this.textures[c]=d;this.textures[c]&&this.textures[c].texture&&(this.textures[c].texture=e.ResourcesManager.cleanFullpath(this.textures[c].texture))}break;case "flags":for(c in b)this.flags[c]=b[c];break;case "transparency":this.opacity=1-b;break;case "render_state":this._render_state.configure(b);break;case "material_class":case "object_type":break;default:return!1}return!0}};x.prototype.setPropertyValueFromPath=function(a,b,c){c=c||0;a.length<
c+1||this.setProperty(a[c],b)};x.prototype.getPropertyInfoFromPath=function(a){if(!(1>a.length)){a=a[0];var b=null;switch(a){case "queue":case "opacity":case "transparency":b="number";break;case "uvs_matrix":b="mat3";break;case "color":b="vec3";break;case "textures":b="Texture";break;default:return null}return{node:this._root,target:this,name:a,value:this[a],type:b}}};x.prototype.getTextureChannels=function(){return[]};x.prototype.setTexture=function(a,b,c){if(!a)throw"Material.prototype.setTexture channel must be specified";
if(b){b.constructor===String&&(b=e.ResourcesManager.cleanFullpath(b));var d=this.textures[a];if(d)if(d.texture!=b||c)d.texture=b;else return d;else this.textures[a]=d={texture:b,uvs:x.DEFAULT_UVS[a]||"0",wrap:0,minFilter:0,magFilter:0,missing:"white"};if(c)for(var f in c)d[f]=c[f];d._must_update=!0;b.constructor===String&&":"!=b[0]&&e.ResourcesManager.load(b);return d}delete this.textures[a]};x.prototype.setTextureProperty=function(a,b,c){var d=this.textures[a];d?d[b]=c:"texture"==b&&(this.textures[a]=
{texture:c,uvs:x.DEFAULT_UVS[a]||"0",wrap:0,minFilter:0,magFilter:0})};x.prototype.getTexture=function(a){a=a||x.COLOR_TEXTURE;a=this.textures[a];return a?a.constructor===String?e.ResourcesManager.textures[a]:(a=a.texture)?a.constructor===String?e.ResourcesManager.textures[a]:a.constructor==Texture?a:null:null:null};x.prototype.getTextureSampler=function(a){return this.textures[a]};x.getTextureFromSampler=function(a){a=a.constructor===String?a:a.texture;if(!a)return null;a.constructor===String&&(a=
e.ResourcesManager.textures[a]);return a&&a.constructor==GL.Texture?a:null};x.prototype.setTextureSampler=function(a,b){if(!a)throw"Cannot call Material setTextureSampler without channel";b?this.textures[a]=b:delete this.textures[a]};x.prototype.getResources=function(a){for(var b in this.textures){var c=this.textures[b];c&&"string"==typeof c.texture&&(a[c.texture]=GL.Texture)}return a};x.prototype.onResourceRenamed=function(a,b,c){c=!1;for(var d in this.textures){var f=this.textures[d];f&&f.texture==
a&&(f.texture=b,c=!0)}return c};x.prototype.loadTextures=function(){var a=this.getResources({}),b;for(b in a)e.ResourcesManager.load(b)};x.prototype.registerMaterial=function(a){this.name=a;e.ResourcesManager.registerResource(a,this);this.material=a};x.prototype.getCategory=function(){return this.category||"Material"};x.prototype.updatePreview=function(a,b){b=b||{};var c={};this.getResources(c);for(var d in c)if(!e.ResourcesManager.resources[d])return console.warn("Cannot generate preview with resources missing."),
null;e.GlobalScene.info.textures.environment&&(b.environment=e.GlobalScene.info.textures.environment);if(c=e.Renderer.renderMaterialPreview(this,a||256,b,this._preview))this._preview=c,c.toDataURL&&(this._preview_url=c.toDataURL("image/png"))};x.prototype.getLocator=function(){return this._root?this._root.uid+"/material":this.uid};x.prototype.assignToNode=function(a){if(!a)return!1;var b=this.fullpath||this.filename;a.material=b?b:this;return!0};x.prototype.createProperty=function(a,b,c,d){c&&(e.validatePropertyType(c),
this.constructor["@"+a]={type:c});d&&(this.constructor["@"+a]||(this.constructor["@"+a]={}),e.cloneObject(d,this.constructor["@"+a]));null!=b&&(b.constructor===Number||b.constructor===String||b.constructor===Boolean?this[a]=b:b.constructor===Float32Array&&(c="_"+a,b=new Float32Array(b),this[c]=b,Object.defineProperty(this,a,{get:function(){return b},set:function(a){b.set(a)},enumerable:!0,configurable:!0})))};x.prototype.prepare=function(a){this._uniforms||(this._uniforms={},this._samplers=[]);if(this.onPrepare)this.onPrepare(a);
this.fillUniforms(a)};x.prototype.getShader=function(a){a=x._shader_color;a||(a=x._shader_color=new GL.Shader(e.Shaders.common_vscode+"void main(){ vec4 vertex = u_model * a_vertex;\ngl_Position = u_viewprojection * vertex;\n }",e.Shaders.common_vscode+"uniform vec4 u_color;\n\void main(){ gl_FragColor = u_color;\n }"));return a};x.prototype.renderInstance=function(a,b,c){b=e.Renderer;var d=e.Renderer._current_camera,f=e.Renderer._current_scene,h=e.Renderer._render_uniforms;h.u_model=a.matrix;h.u_normal_model=
a.normal_matrix;this._render_state.enable();e.Renderer.bindSamplers(this._samplers);if(this.onRenderInstance)this.onRenderInstance(a);c=shader_code.getShader(c.name);if(!c)return!1;c.uniformsArray([f._uniforms,d._uniforms,h,this._uniforms,a.uniforms]);a.render(c,-1!=this._primitive?this._primitive:void 0);b._rendercalls+=1;return!0};e.registerResourceClass(x);e.Material=x;Object.defineProperty(R.prototype,"shader",{enumerable:!0,get:function(){return this._shader},set:function(a){a&&(a=e.ResourcesManager.cleanFullpath(a));
this._shader!=a&&(this._shader_code=null,this._shader=a,this.processShaderCode())}});Object.defineProperty(R.prototype,"shader_code",{enumerable:!1,get:function(){return this._shader_code},set:function(a){this._shader=null;this._shader_code=a;this.processShaderCode()}});Object.defineProperty(R.prototype,"properties",{enumerable:!0,get:function(){return this._properties},set:function(a){if(a){this._properties=a;this._properties_by_name={};for(var b in this._properties)a=this._properties[b],this._properties_by_name[a.name]=
a}}});Object.defineProperty(R.prototype,"enableLights",{enumerable:!0,get:function(){return 0!=this._light_mode},set:function(a){this._light_mode=a?1:0}});Object.defineProperty(R.prototype,"version",{enumerable:!1,get:function(){return this._version},set:function(a){console.error("version cannot be set manually")}});R.prototype.addPass=function(a,b,c,d){this._passes[a]={vertex:b,fragment:c,macros:d}};R.prototype.prepare=function(a){this.fillUniforms();if(this.onPrepare)this.onPrepare(a)};R.prototype.fillUniforms=
function(){var a=this._samplers;a.length=0;this._uniforms.u_material_color=this._color;for(var b=0;b<this._properties.length;++b){var c=this._properties[b];c.internal||(c.is_texture?(this._uniforms[c.uniform]=a.length,c.value?a.push(c.value):a.push(" ")):this._uniforms[c.uniform]=c.value)}};R.prototype.setProperty=function(a,b){if(x.prototype.setProperty.call(this,a,b))return!0;if("shader"==a)this.shader=b;else if("properties"==a){this.properties.length=0;this._properties_by_name={};for(var c=0;c<
b.length;++c){var d=b[c];d.is_texture&&d.value&&d.value.constructor===String&&(d.value={texture:d.value});this.properties[c]=d;this._properties_by_name[d.name]=d}}else if(this._properties_by_name[a])d=this._properties_by_name[a],d.value&&d.value.constructor!==String&&d.value.length?d.value.set(b):d.value=b;else return!1;return!0};R.prototype.processShaderCode=function(){if(!this._shader_code&&!this._shader)return this._properties.length=0,this._properties_by_name={},this._passes={},this._samplers.length=
0,!1;var a=this._shader_code;!a&&this._shader&&(a=e.ResourcesManager.getResource(this.shader));if(!a||a.constructor!==e.ShaderCode)return!1;var b=this._properties_by_name;this._properties.length=0;this._properties_by_name={};this._passes={};this._light_mode=this._samplers.length=0;this._primitive=-1;this._queue=e.RenderQueue.GEOMETRY;this._render_state.init();for(var c in this)this.hasOwnProperty(c)&&this[c]&&this[c].constructor===Function&&delete this[c];if(a._functions.init)if(e.catch_exceptions)try{a._functions.init.call(this)}catch(d){e.dispatchCodeError(d)}else a._functions.init.call(this);
for(c in a._global_uniforms){var f=a._global_uniforms[c];f.disabled||this.createUniform(f.name,f.uniform,f.type,f.value,f.options)}this._shader_version=a._version;this._version++;this.assignOldProperties(b)};R.prototype.assignOldProperties=function(a){var b=null,c=this.getShaderCode();c&&(b=c.getShader());for(c=0;c<this._properties.length;++c){var d=this._properties[c];if(a[d.name]){var f=a[d.name];if(void 0!==f.value){if(!f.internal&&b&&!d.is_texture){var e=b.uniformInfo[d.uniform];if(!e)continue;
if(void 0!==d.value&&!GL.Shader.validateValue(d.value,e)){d.value=void 0;continue}}d.value&&d.value.set?f.value&&f.value.length&&d.value.length&&f.value.length<=d.value.length?d.value.set(f.value):d.value=f.value:d.value=f.value}}}};R.prototype.renderInstance=function(a,b,c){var d=this.getShaderCode(a,b,c);if(!d||d.constructor!==e.ShaderCode)return!0;d._version!==this._shader_version&&this.processShaderCode&&this.processShaderCode();var f=e.Renderer,h=e.Renderer._current_camera,g=e.Renderer._current_scene,
k=e.Renderer._render_uniforms;k.u_model=a.matrix;k.u_normal_model=a.normal_matrix;var m=a.computeShaderBlockFlags(),m=m|e.Renderer._global_block_flags;this._render_state.enable();e.Renderer.bindSamplers(this._samplers);e.Renderer.bindSamplers(a.samplers);var l=e.Renderer._global_shader_blocks_flags;c==hb&&(l|=e.ShaderMaterial.reflection_block.flag_mask,e.Renderer._global_textures.environment&&(l=e.Renderer._global_textures.environment.texture_type==GL.TEXTURE_2D?l|vb.flag_mask:l|wb.flag_mask),e.Renderer._global_textures.irradiance&&
(l|=xb.flag_mask));if(this.onRenderInstance)this.onRenderInstance(a);var n=null,p=c!=hb||b.lights_disabled||this._light_mode===x.NO_LIGHTS;p||(n=e.Renderer.getNearLights(a));if(!n||0==n.length||p){p||(m|=l);m=d.getShader(c.name,m);if(!m)return!1;m.uniformsArray([g._uniforms,h._uniforms,k,this._uniforms,a.uniforms]);m.setUniform("u_light_info",e.ZEROS4);p&&m.setUniform("u_ambient_light",e.ONES);a.render(m,-1!=this._primitive?this._primitive:void 0);f._rendercalls+=1;return!0}p=m;h=[g._uniforms,h._uniforms,
k,null,this._uniforms,a.uniforms];g=null;for(k=0;k<n.length;++k){var q=n[k],m=q.applyShaderBlockFlags(p,c,b),m=m|l;(m=d.getShader(null,m))?(e.Renderer.bindSamplers(q._samplers),q._uniforms.u_light_info[2]=k,q._uniforms.u_light_info[3]=n.length,h[3]=q._uniforms,g!=m?m.uniformsArray(h):m.uniforms(q._uniforms),g=m,1==k&&(gl.depthMask(!1),gl.depthFunc(gl.EQUAL),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE)),a.render(m,-1!=this._primitive?this._primitive:void 0),f._rendercalls+=1):console.warn("material without pass: "+
c.name)}gl.disable(gl.BLEND);gl.depthMask(!0);gl.depthFunc(gl.LESS);return!0};R.prototype.renderPickingInstance=function(a,b,c){var d=this.getShaderCode(a,b,c);if(d&&d.constructor===e.ShaderCode){b=e.Renderer;var f=e.Renderer._current_camera,h=a.node,g=e.Renderer._render_uniforms;g.u_model=a.matrix;g.u_normal_model=a.normal_matrix;var k=a.computeShaderBlockFlags();this._render_state.enable();e.Renderer.bindSamplers(this._samplers);e.Renderer.bindSamplers(a.samplers);d=d.getShader(c.name,k);if(!d&&
(d=e.ShaderMaterial.getDefaultPickingShaderCode(),d=d.getShader(c.name,k),!d))return!1;d.uniformsArray([f._uniforms,g,this._uniforms,a.uniforms]);c=e.Picking.getNextPickingColor(a.picking_node||h);d.setUniform("u_material_color",c);a.render(d,-1!=this._primitive?this._primitive:void 0);b._rendercalls+=1;gl.disable(gl.BLEND);gl.depthMask(!0);gl.depthFunc(gl.LESS);return!0}};R.prototype.getTextureChannels=function(){var a=[],b;for(b in this._properties){var c=this._properties[b];c.is_texture&&a.push(c.name)}return a};
R.prototype.getResources=function(a){this.shader&&(a[this.shader]=e.ShaderCode);for(var b in this._properties){var c=this._properties[b];if(c.value&&c.is_texture&&c.value){var d=null;(d=c.value.texture?c.value.texture:a[c.value])&&d.constructor===String&&(a[d]=GL.Texture)}}return a};R.prototype.getPropertyInfoFromPath=function(a){if(!(1>a.length)){var b=x.prototype.getPropertyInfoFromPath.call(this,a);if(b)return b;a=a[0];for(var b=0,c=this.properties.length;b<c;++b){var d=this.properties[b];if(d.name==
a)return{node:this._root,target:this,name:d.name,value:d.value,type:d.type}}}};R.prototype.getShaderCode=function(a,b,c){a=this._shader_code||e.ResourcesManager.getResource(this._shader);if(!a||a.constructor!==e.ShaderCode)return null;a._version!==this._shader_version&&this.processShaderCode&&(a._version=this._shader_version,this.processShaderCode());return a};R.prototype.applyToTexture=function(a,b){if(!this.shader||!a)return!1;var c=this.getShaderCode();if(!c)return!1;var d=c.getShader("fx");if(!d)return!1;
this.fillUniforms();this._uniforms.u_time=e.GlobalScene._time;this._uniforms.u_viewport=gl.viewport_data;e.Renderer.bindSamplers(this._samplers);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);b?b.drawTo(function(){a.toViewport(d,this._uniforms)}):a.toViewport(d,this._uniforms)};R.prototype.createUniform=function(a,b,c,d,f){if(!a||!b)throw"parameter missing in createUniform";c=c||"Number";if(c.constructor!==String)throw"type must be string";if((d=d||0)&&d.length)d=new Float32Array(d);else switch(c){case "vec2":d=
vec2.create();break;case "color":case "vec3":d=vec3.create();break;case "color4":case "vec4":d=vec4.create();break;case "mat3":d=mat3.create();break;case "mat4":d=mat4.create()}b={name:a,uniform:b,value:d,type:c,is_texture:0};if("texture"==c.toLowerCase()||"sampler2D"==c||"samplerCube"==c||"sampler"==c)b.is_texture="samplerCube"==c?2:1;b.is_texture&&(b.sampler={},b.type="sampler",b.sampler_slot=this._samplers.length,this._samplers.push(b.sampler));if(f)for(var e in f)b[e]=f[e];this._properties.push(b);
this._properties_by_name[a]=b};R.prototype.createSampler=function(a,b,c,d){if(!a||!b)throw"parameter missing in createSampler";var f="sampler";c&&c.type&&(f=c.type);var e=null;if(this._properties_by_name[a]){var g=this._properties_by_name[a];g.type==f&&g.value&&(e=g.value)}e||(e={texture:d});b={name:a,uniform:b,value:e,type:f,is_texture:1,sampler_slot:-1};if(c){c.filter&&(e.magFilter=c.filter,e.minFilter=c.filter,delete c.filter);c.wrap&&(e.wrapS=c.wrap,e.wrapT=c.wrap,delete c.wrap);for(var k in c)e[k]=
c[k]}b.sampler_slot=this._samplers.length;this._properties.push(b);this._properties_by_name[a]=b;this._samplers.push(b.value)};R.prototype.createProperty=function(a,b,c,d){var f=this._properties_by_name[a];if(!f||f.type!=c){f={name:a,type:c,internal:!0,value:b};if(d)for(var e in d)f[e]=d[e];this._properties.push(f);this._properties_by_name[a]=f;Object.defineProperty(this,a,{get:function(){var b=this._properties_by_name[a];if(b)return b.value},set:function(b){var c=this._properties_by_name[a];c&&(c.value&&
c.value.set?c.value.set(b):c.value=b)},enumerable:!1,configurable:!0})}};R.prototype.onResourceRenamed=function(a,b,c){c=x.prototype.onResourceRenamed.call(this,a,b,c);this.shader==a&&(this.shader=b,c=!0);for(var d=0;d<this._properties.length;++d){var f=this._properties[d];!f.internal&&f.is_texture&&f.value&&f.value.texture==a&&(f.value.texture=b,c=!0)}return c};R.getDefaultPickingShaderCode=function(){if(R.default_picking_shader_code)return R.default_picking_shader_code;var a=new e.ShaderCode;a.code=
e.ShaderCode.flat_code;return R.default_picking_shader_code=a};e.registerMaterialClass(R);e.ShaderMaterial=R;Object.defineProperty(P.prototype,"detail_factor",{get:function(){return this._detail[0]},set:function(a){this._detail[0]=a},enumerable:!0});Object.defineProperty(P.prototype,"detail_scale",{get:function(){return this._detail.subarray(1,3)},set:function(a){this._detail[1]=a[0];this._detail[2]=a[1]},enumerable:!0});Object.defineProperty(P.prototype,"emissive_extra",{get:function(){return this._emissive[3]},
set:function(a){this._emissive[3]=a},enumerable:!0});Object.defineProperty(P.prototype,"specular_factor",{get:function(){return this._specular_data[0]},set:function(a){null!=a&&a.constructor===Number&&(this._specular_data[0]=a)},enumerable:!0});Object.defineProperty(P.prototype,"specular_gloss",{get:function(){return this._specular_data[1]},set:function(a){this._specular_data[1]=a},enumerable:!0});P["@blend_mode"]={type:"enum",values:e.Blend};P.actions={};P.DETAIL_TEXTURE="detail";P.NORMAL_TEXTURE=
"normal";P.DISPLACEMENT_TEXTURE="displacement";P.BUMP_TEXTURE="bump";P.REFLECTIVITY_TEXTURE="reflectivity";P.EXTRA_TEXTURE="extra";P.IRRADIANCE_TEXTURE="irradiance";P.prototype.renderInstance=R.prototype.renderInstance;P.prototype.renderShadowInstance=R.prototype.renderShadowInstance;P.prototype.renderPickingInstance=R.prototype.renderPickingInstance;P.prototype.prepare=function(a){var b=this.flags,c=this._render_state;c.cull_face=!b.two_sided;c.front_face=b.flip_normals?GL.CW:GL.CCW;c.depth_test=
b.depth_test;c.depth_mask=b.depth_write;c.blend=this.blend_mode!=e.Blend.NORMAL;this.blend_mode!=e.Blend.NORMAL&&(b=e.BlendFunctions[this.blend_mode])&&(c.blendFunc0=b[0],c.blendFunc1=b[1]);this._light_mode=this.flags.ignore_lights?x.NO_LIGHTS:1;this.fillUniforms(a)};P.FLAGS={COLOR_TEXTURE:2,OPACITY_TEXTURE:4,SPECULAR_TEXTURE:8,REFLECTIVITY_TEXTURE:16,AMBIENT_TEXTURE:32,EMISSIVE_TEXTURE:64,DETAIL_TEXTURE:128,NORMAL_TEXTURE:256,DISPLACEMENT_TEXTURE:512,EXTRA_TEXTURE:1024,ENVIRONMENT_TEXTURE:2048,ENVIRONMENT_CUBEMAP:4096,
IRRADIANCE_CUBEMAP:8192,COLOR_TEXTURE_OPTIONS:65536,OPACITY_TEXTURE_OPTIONS:131072,SPECULAR_TEXTURE_OPTIONS:262144,REFLECTIVITY_TEXTURE_OPTIONS:524288,AMBIENT_TEXTURE_OPTIONS:1048576,EMISSIVE_TEXTURE_OPTIONS:2097152,NORMAL_TEXTURE_OPTIONS:4194304,DISPLACEMENT_TEXTURE_OPTIONS:8388608,EXTRA_TEXTURE_OPTIONS:16777216,DEGAMMA_COLOR:67108864,SPEC_ON_ALPHA:134217728,SPEC_ON_TOP:268435456,ALPHA_TEST:536870912};P.shader_codes={};P.prototype.getShaderCode=function(a,b,c){c=P.FLAGS;a=0;this.textures.color&&
(a|=c.COLOR_TEXTURE,this.textures.color.degamma&&(a|=c.DEGAMMA_COLOR));this.textures.opacity&&(a|=c.OPACITY_TEXTURE);this.textures.displacement&&(a|=c.DISPLACEMENT_TEXTURE);this.textures.normal&&(a|=c.NORMAL_TEXTURE);this.textures.specular&&(a|=c.SPECULAR_TEXTURE);0<this.reflection_factor&&this.textures.reflectivity&&(a|=c.REFLECTIVITY_TEXTURE);this.textures.emissive&&(a|=c.EMISSIVE_TEXTURE);this.textures.ambient&&(a|=c.AMBIENT_TEXTURE);this.textures.detail&&(a|=c.DETAIL_TEXTURE);this.textures.extra&&
(a|=c.EXTRA_TEXTURE);this.specular_on_alpha&&(a|=c.SPEC_ON_ALPHA);this.specular_on_top&&(a|=c.SPEC_ON_TOP);this.flags.alpha_test&&(a|=c.ALPHA_TEST);var d=e.StandardMaterial.shader_codes[a];if(d)return d;b={vs_local:"",fs:"",fs_shadows:""};a&c.DISPLACEMENT_TEXTURE&&(b.vs_local+="\tvertex4.xyz += v_normal * texture2D( displacement_texture, v_uvs ).x * u_displacementmap_factor;\n");b.fs+="vec2 uv0 = (vec3(IN.uv,1.0) * u_texture_matrix).xy;\n";b.fs_shadows+="vec2 uv0 = (vec3(IN.uv,1.0) * u_texture_matrix).xy;\n";
a&c.NORMAL_TEXTURE&&(b.fs+="\tvec3 normal_pixel = texture2D( normal_texture, uv0 ).xyz;\n\t\tnormal_pixel.xy = vec2(1.0) - normal_pixel.xy;\n\t\tif( u_normal_info.y > 0.0 )\n\t\t\tnormal_pixel = normalize( perturbNormal( IN.worldNormal, IN.viewDir, uv0, normal_pixel ));\n\t\to.Normal = normalize( mix( o.Normal, normal_pixel, u_normal_info.x ) );\n");a&c.COLOR_TEXTURE&&(d="\tvec4 tex_color = texture2D( color_texture, uv0 );\n",b.fs+=d,b.fs_shadows+=d,a&c.DEGAMMA_COLOR&&(b.fs+="\ttex_color.xyz = pow( tex_color.xyz, vec3(2.0) );\n"),
d="\to.Albedo *= tex_color.xyz;\n\to.Alpha *= tex_color.w;\n",b.fs+=d,b.fs_shadows+=d);a&c.OPACITY_TEXTURE&&(d="\to.Alpha *= texture2D( opacity_texture, uv0 ).x;\n",b.fs+=d,b.fs_shadows+=d);a&c.SPECULAR_TEXTURE&&(b.fs+="\tvec4 spec_info = texture2D( specular_texture, uv0 );\n\to.Specular *= spec_info.x;\n\to.Gloss *= spec_info.y;\n");a&c.REFLECTIVITY_TEXTURE&&(b.fs+="\to.Reflectivity *= texture2D( reflectivity_texture, uv0 ).x;\n");a&c.EMISSIVE_TEXTURE&&(b.fs+="\to.Emission *= texture2D( emissive_texture, uv0 ).xyz;\n");
a&c.AMBIENT_TEXTURE&&(b.fs+="\to.Ambient *= texture2D( ambient_texture, uv0 ).xyz;\n");a&c.DETAIL_TEXTURE&&(b.fs+="\to.Albedo += (texture2D( detail_texture, uv0 * u_detail_info.yz).xyz - vec3(0.5)) * u_detail_info.x;\n");a&c.EXTRA_TEXTURE&&(b.fs+="\tif(u_light_info.z == 0.0) o.Extra = u_extra_color * texture2D( extra_texture, uv0 );\n");a&c.ALPHA_TEST&&(d="\tif(o.Alpha < 0.01) discard;\n",b.fs+=d,b.fs_shadows+=d);a&c.SPEC_ON_TOP&&(b.fs+="\t#define SPEC_ON_TOP\n");a&c.SPEC_ON_ALPHA&&(b.fs+="\t#define SPEC_ON_ALPHA\n");
d=new e.ShaderCode;c=P.code_template;if(P.onShaderCode)P.onShaderCode(b,this,a);d.code=ba.replaceCode(c,b);return e.StandardMaterial.shader_codes[a]=d};P.prototype.fillUniforms=function(a,b){var c=this._uniforms;c.u_reflection_info[0]=this.reflection_factor;c.u_reflection_info[1]=this.reflection_fresnel;c.u_backlight_factor=this.backlight_factor;c.u_normal_info[0]=this.normalmap_factor;c.u_normal_info[1]=this.normalmap_tangent?1:0;c.u_displacementmap_factor=this.displacementmap_factor;c.u_velvet_info.set(this._velvet);
c.u_velvet_info[3]=this.velvet_additive?this.velvet_exp:-this.velvet_exp;var d=0,f=this._samplers;f.length=0;for(var h in this.textures){var g=this.getTextureSampler(h);if(g){var k=g.texture;if(k){if(k.constructor===String)k=e.ResourcesManager.textures[k];else if(k.constructor!=Texture)continue;k||(g={texture:":missing"});k=d;"environment"==h?k=e.Renderer.ENVIRONMENT_TEXTURE_SLOT:"irradiance"==h?k=e.Renderer.IRRADIANCE_TEXTURE_SLOT:d++;f[k]=g;c[h+"_texture"]=k}}}};P.prototype.getTextureChannels=function(){return[x.COLOR_TEXTURE,
x.OPACITY_TEXTURE,x.AMBIENT_TEXTURE,x.SPECULAR_TEXTURE,x.EMISSIVE_TEXTURE,P.DETAIL_TEXTURE,P.NORMAL_TEXTURE,P.DISPLACEMENT_TEXTURE,P.BUMP_TEXTURE,P.REFLECTIVITY_TEXTURE,P.EXTRA_TEXTURE,x.ENVIRONMENT_TEXTURE,P.IRRADIANCE_TEXTURE]};P.prototype.setProperty=function(a,b){if(x.prototype.setProperty.call(this,a,b))return!0;switch(a){case "render_state":case "specular_factor":case "specular_gloss":case "backlight_factor":case "reflection_factor":case "reflection_fresnel":case "velvet_exp":case "velvet_additive":case "normalmap_tangent":case "normalmap_factor":case "bumpmap_factor":case "displacementmap_factor":case "detail_factor":case "emissive_extra":case "shader_name":case "specular_on_top":case "specular_on_alpha":case "normalmap_tangent":case "reflection_specular":case "use_scene_ambient":case "blend_mode":null!==
b&&(this[a]=b);break;case "flags":if(b)for(var c in b)this.flags[c]=b[c];break;case "ambient":case "emissive":case "velvet":case "extra":case "detail_scale":this[a].length>=b.length&&this[a].set(b);break;default:return!1}return!0};P.prototype.getPropertiesInfo=function(){var a=x.prototype.getPropertiesInfo.call(this);a.merge({shader_name:e.TYPES.STRING,blend_mode:e.TYPES.NUMBER,specular_factor:e.TYPES.NUMBER,specular_gloss:e.TYPES.NUMBER,backlight_factor:e.TYPES.NUMBER,reflection_factor:e.TYPES.NUMBER,
reflection_fresnel:e.TYPES.NUMBER,velvet_exp:e.TYPES.NUMBER,normalmap_factor:e.TYPES.NUMBER,bumpmap_factor:e.TYPES.NUMBER,displacementmap_factor:e.TYPES.NUMBER,emissive_extra:e.TYPES.NUMBER,ambient:e.TYPES.VEC3,emissive:e.TYPES.VEC3,velvet:e.TYPES.VEC3,extra:e.TYPES.VEC4,detail_factor:e.TYPES.NUMBER,detail_scale:e.TYPES.VEC2,specular_on_top:e.TYPES.BOOLEAN,normalmap_tangent:e.TYPES.BOOLEAN,reflection_specular:e.TYPES.BOOLEAN,use_scene_ambient:e.TYPES.BOOLEAN,velvet_additive:e.TYPES.BOOLEAN});return a};
P.prototype.getPropertyInfoFromPath=function(a){if(!(1>a.length)){var b=x.prototype.getPropertyInfoFromPath.call(this,a);if(b)return b;a=a[0];switch(a){case "blend_mode":case "backlight_factor":case "reflection_factor":case "reflection_fresnel":case "velvet_exp":case "normalmap_factor":case "bumpmap_factor":case "displacementmap_factor":case "emissive_extra":case "detail_factor":b=e.TYPES.NUMBER;break;case "extra":b=e.TYPES.VEC4;break;case "ambient":case "emissive":case "velvet":b=e.TYPES.VEC3;break;
case "detail_scale":b=e.TYPES.VEC2;break;case "specular_on_top":case "specular_on_alpha":case "normalmap_tangent":case "reflection_specular":case "use_scene_ambient":case "velvet_additive":b=e.TYPES.BOOLEAN;break;default:return null}return{node:this._root,target:this,name:a,value:this[a],type:b}}};P.clearShadersCache=function(){e.log("StandardMaterial ShaderCode cache cleared");P.shader_codes={}};e.registerMaterialClass(P);e.StandardMaterial=P;e.Classes.newStandardMaterial=P;P.code_template='\n\n\n\\color.vs\n\nprecision mediump float;\nattribute vec3 a_vertex;\nattribute vec3 a_normal;\nattribute vec2 a_coord;\n#ifdef USE_COLORS\nattribute vec4 a_color;\n#endif\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec2 v_uvs;\n\n//matrices\n#ifdef BLOCK_INSTANCING\n\tattribute mat4 u_model;\n#else\n\tuniform mat4 u_model;\n#endif\nuniform mat4 u_normal_model;\nuniform mat4 u_view;\nuniform mat4 u_viewprojection;\n//material\nuniform float u_displacementmap_factor;\nuniform sampler2D displacement_texture;\n\n//globals\nuniform float u_time;\nuniform vec4 u_viewport;\nuniform float u_point_size;\n\n#pragma shaderblock "light"\n#pragma shaderblock "morphing"\n#pragma shaderblock "skinning"\n\n//camera\nuniform vec3 u_camera_eye;\nuniform vec2 u_camera_planes;\n\n#pragma event "vs_functions"\n\n//special cases\n{{vs_out}}\n\nvoid main() {\n\t\n\tvec4 vertex4 = vec4(a_vertex,1.0);\n\tv_normal = a_normal;\n\tv_uvs = a_coord;\n\t\n\t//local deforms\n\t{{vs_local}}\n\tapplyMorphing( vertex4, v_normal );\n\tapplySkinning( vertex4, v_normal );\n\t\n\t//vertex\n\tv_pos = (u_model * vertex4).xyz;\n\t\n\tapplyLight(v_pos);\n\t\n\t//normal\n\t#ifdef SHADERBLOCK_INSTANCING\n\t\tv_normal = (u_model * vec4(v_normal,0.0)).xyz;\n\t#else\n\t\tv_normal = (u_normal_model * vec4(v_normal,0.0)).xyz;\n\t#endif\n\t//world deform\n\t{{vs_global}}\n\t\n\t#pragma event "vs_final_pass"\n\t\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\tgl_PointSize = u_point_size;\n\t#pragma event "vs_final"\n}\n\n\\color.fs\n\n#ifdef DRAW_BUFFERS\n\t#extension GL_EXT_draw_buffers : require \n#endif\n\nprecision mediump float;\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec2 v_uvs;\n\n//globals\nuniform vec3 u_camera_eye;\nuniform vec4 u_clipping_plane;\nuniform vec4 u_background_color;\nuniform vec4 u_material_color;\n\nuniform vec3 u_ambient_color;\nuniform vec4 u_emissive_color;\nuniform vec4 u_specular;\nuniform vec2 u_reflection_info;\nuniform vec4 u_velvet_info;\nuniform vec2 u_normal_info;\nuniform vec3 u_detail_info;\nuniform mat3 u_texture_matrix;\nuniform vec4 u_extra_color;\nuniform float u_backlight_factor;\n\nuniform sampler2D color_texture;\nuniform sampler2D opacity_texture;\nuniform sampler2D specular_texture;\nuniform sampler2D ambient_texture;\nuniform sampler2D emissive_texture;\nuniform sampler2D reflectivity_texture;\nuniform sampler2D detail_texture;\nuniform sampler2D normal_texture;\nuniform sampler2D extra_texture;\n\nuniform vec4 u_color_texture_settings;\nuniform vec4 u_opacity_texture_settings;\nuniform vec4 u_specular_texture_settings;\nuniform vec4 u_ambient_texture_settings;\nuniform vec4 u_emissive_texture_settings;\nuniform vec4 u_reflectivity_texture_settings;\nuniform vec4 u_normal_texture_settings;\n\n\n#pragma shaderblock "light"\n#pragma shaderblock "light_texture"\n#pragma shaderblock "applyReflection"\n\n#pragma snippet "perturbNormal"\n\n#pragma shaderblock "extraBuffers"\n\nvoid surf(in Input IN, out SurfaceOutput o)\n{\n\to.Albedo = u_material_color.xyz;\n\to.Alpha = u_material_color.a;\n\to.Normal = normalize( v_normal );\n\to.Specular = u_specular.x;\n\to.Gloss = u_specular.y;\n\to.Ambient = u_ambient_color;\n\to.Emission = u_emissive_color.xyz;\n\to.Reflectivity = u_reflection_info.x;\n\to.Extra = u_extra_color;\n\t\n\t{{fs}}\n\t\n\tif(u_velvet_info.w > 0.0)\n\t\to.Albedo += u_velvet_info.xyz * ( 1.0 - pow( max(0.0, dot( IN.viewDir, o.Normal )), u_velvet_info.w ));\n\telse if(u_velvet_info.w < 0.0)\n\t\to.Albedo = mix( o.Albedo, u_velvet_info.xyz, 1.0 - pow( max(0.0, dot( IN.viewDir, o.Normal )), abs(u_velvet_info.w) ) );\n\tif(u_emissive_color.w > 0.0)\n\t\to.Emission *= o.Albedo;\n\to.Reflectivity *= max(0.0, pow( 1.0 - clamp(0.0, dot(IN.viewDir,o.Normal),1.0), u_reflection_info.y ));\n}\n\n#pragma event "fs_functions"\n\n{{fs_out}}\n\nvoid main() {\n\tInput IN = getInput();\n\tSurfaceOutput o = getSurfaceOutput();\n\tsurf(IN,o);\n\tLight LIGHT = getLight();\n\tapplyLightTexture( IN, LIGHT );\n\tFinalLight FINALLIGHT = computeLight( o, IN, LIGHT );\n\tFINALLIGHT.Diffuse += u_backlight_factor * max(0.0, dot(FINALLIGHT.Vector, -o.Normal));\n\tvec4 final_color = vec4( 0.0,0.0,0.0, o.Alpha );\n\t#ifdef SPEC_ON_ALPHA\n\t\tfinal_color.a += FINALLIGHT.Specular;\n\t#endif\n\t#ifdef SPEC_ON_TOP\n\t\tfloat specular = FINALLIGHT.Specular;\n\t\tFINALLIGHT.Specular = 0.0;\n\t#endif\n\tfinal_color.xyz = applyLight( o, FINALLIGHT );\n\t#ifdef SPEC_ON_TOP\n\t\tfinal_color.xyz += specular * LIGHT.Color * FINALLIGHT.Shadow;\n\t#endif\n\tfinal_color = applyReflection( IN, o, final_color );\n\t#pragma event "fs_final_pass"\n\t{{fs_encode}}\n\t#ifdef DRAW_BUFFERS\n\t  gl_FragData[0] = final_color;\n\t  if(u_light_info.z == 0.0)\n\t\t  gl_FragData[1] = o.Extra;\n\t#else\n\t  gl_FragColor = final_color;\n\t#endif\n\t#pragma event "fs_final"\n}\n\\shadow.vs\n\nprecision mediump float;\nattribute vec3 a_vertex;\nattribute vec3 a_normal;\nattribute vec2 a_coord;\n#ifdef USE_COLORS\nattribute vec4 a_color;\n#endif\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec2 v_uvs;\n\n//matrices\n#ifdef BLOCK_INSTANCING\n\tattribute mat4 u_model;\n#else\n\tuniform mat4 u_model;\n#endif\nuniform mat4 u_normal_model;\nuniform mat4 u_view;\nuniform mat4 u_viewprojection;\n//material\nuniform float u_displacementmap_factor;\nuniform sampler2D displacement_texture;\n\n//globals\nuniform float u_time;\nuniform vec4 u_viewport;\nuniform float u_point_size;\n\n#pragma shaderblock "light"\n#pragma shaderblock "morphing"\n#pragma shaderblock "skinning"\n\n//camera\nuniform vec3 u_camera_eye;\n\n{{vs_out}}\n\nvoid main() {\n\t\n\tvec4 vertex4 = vec4(a_vertex,1.0);\n\tv_normal = a_normal;\n\tv_uvs = a_coord;\n  \n  //deforms\n  {{vs_local}}\n  applyMorphing( vertex4, v_normal );\n  applySkinning( vertex4, v_normal );\n\t\n\t//vertex\n\tv_pos = (u_model * vertex4).xyz;\n  \n  applyLight(v_pos);\n  \n\t//normal\n\t#ifdef SHADERBLOCK_INSTANCING\n\t\tv_normal = (u_model * vec4(v_normal,0.0)).xyz;\n\t#else\n\t\tv_normal = (u_normal_model * vec4(v_normal,0.0)).xyz;\n\t#endif\n  {{vs_global}}\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n}\n\\shadow.fs\n\nprecision mediump float;\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec2 v_uvs;\n\n//globals\nuniform vec3 u_camera_eye;\nuniform vec4 u_clipping_plane;\nuniform vec4 u_material_color;\n\nuniform mat3 u_texture_matrix;\n\nuniform sampler2D color_texture;\nuniform sampler2D opacity_texture;\n\n#pragma snippet "input"\n#pragma snippet "surface"\n\nvoid surf(in Input IN, out SurfaceOutput o)\n{\n\to.Albedo = u_material_color.xyz;\n\to.Alpha = u_material_color.a;\n\t\n\t{{fs_shadows}}\n}\n\n{{fs_shadow_out}}\n\nvoid main() {\n  Input IN = getInput();\n  SurfaceOutput o = getSurfaceOutput();\n  surf(IN,o);\n  {{fs_shadow_encode}}\n  gl_FragColor = vec4(o.Albedo,o.Alpha);\n}\n\\picking.vs\n\nprecision mediump float;\nattribute vec3 a_vertex;\nattribute vec3 a_normal;\nattribute vec2 a_coord;\n#ifdef USE_COLORS\nattribute vec4 a_color;\n#endif\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec2 v_uvs;\n\n//matrices\n#ifdef BLOCK_INSTANCING\n\tattribute mat4 u_model;\n#else\n\tuniform mat4 u_model;\n#endif\nuniform mat4 u_normal_model;\nuniform mat4 u_view;\nuniform mat4 u_viewprojection;\n//material\nuniform float u_displacementmap_factor;\nuniform sampler2D displacement_texture;\n\n//globals\nuniform float u_time;\nuniform vec4 u_viewport;\nuniform float u_point_size;\n\n#pragma shaderblock "light"\n#pragma shaderblock "morphing"\n#pragma shaderblock "skinning"\n\n//camera\nuniform vec3 u_camera_eye;\n\n{{vs_out}}\n\n#pragma event "vs_functions"\n\nvoid main() {\n\t\n\tvec4 vertex4 = vec4(a_vertex,1.0);\n\tv_normal = a_normal;\n\tv_uvs = a_coord;\n  \n  //deforms\n  {{vs_local}}\n  applyMorphing( vertex4, v_normal );\n  applySkinning( vertex4, v_normal );\n\t\n\t//vertex\n\tv_pos = (u_model * vertex4).xyz;\n  \n  applyLight(v_pos);\n  \n\t//normal\n\t#ifdef SHADERBLOCK_INSTANCING\n\t\tv_normal = (u_model * vec4(v_normal,0.0)).xyz;\n\t#else\n\t\tv_normal = (u_normal_model * vec4(v_normal,0.0)).xyz;\n\t#endif\n  {{vs_global}}\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n\t#pragma event "vs_final"\n}\n\\picking.fs\n\tprecision mediump float;\n\tuniform vec4 u_material_color;\n\tvoid main() {\n\t\tgl_FragColor = u_material_color;\n\t}\n';
qa.prototype.prepare=P.prototype.prepare;qa.icon="mini-icon-material.png";qa.prototype.onCodeChange=function(){this._mustUpdate=!0};Object.defineProperty(qa.prototype,"code",{enumerable:!0,get:function(){return this._code},set:function(a){this._code=String(a);this._mustUpdate=!0}});qa.prototype.getCode=function(){return this._code};qa.prototype.computeCode=function(){for(var a="",b=0,c=this.properties.length;b<c;++b){var d="uniform ",f=this.properties[b];switch(f.type){case "number":d+="float ";break;
case "vec2":d+="vec2 ";break;case "color":case "vec3":d+="vec3 ";break;case "color4":case "vec4":d+="vec4 ";break;case "sampler":case "texture":d+="sampler2D ";break;case "cubemap":d+="samplerCube ";break;default:continue}d+=f.name+";\n";a+=d}this.surf_code=a+"\n"+this._code;a=e.ShaderCode.replaceCode(e.SurfaceMaterial.code_template,{fs_out:this.surf_code});this._shadercode||(this._shadercode=new e.ShaderCode);this._shadercode.code=a;this._mustUpdate=!1};qa.prototype.renderInstance=R.prototype.renderInstance;
qa.prototype.getShaderCode=function(a,b,c){this._shadercode&&!this._mustUpdate||this.computeCode();return this._shadercode};qa.prototype.fillUniforms=function(a,b){for(var c=this._samplers,d=c.length=0,f=0,e=this.properties.length;f<e;++f){var g=this.properties[f];"texture"==g.type||"cubemap"==g.type||"sampler"==g.type?(c[d]=g.value,this._uniforms[g.name]=d,d++):this._uniforms[g.name]=g.value}this._uniforms.u_material_color=this._color};qa.prototype.configure=function(a){void 0!==a.flags&&a.flags.constructor===
Number&&delete a.flags;x.prototype.configure.call(this,a);a.properties&&(this.properties=e.cloneObject(a.properties));this.computeCode()};qa.prototype.getPropertiesInfo=function(){var a={color:e.TYPES.VEC3,opacity:e.TYPES.NUMBER,shader_name:e.TYPES.STRING,blend_mode:e.TYPES.NUMBER,code:e.TYPES.STRING},b;for(b in this.properties){var c=this.properties[b];a[c.name]=c.type}return a};qa.prototype.onResourceRenamed=function(a,b,c){x.prototype.onResourceRenamed.call(this,a,b,c);c=0;for(var d=this.properties.length;c<
d;++c){var f=this.properties[c];f.value==a&&(f.value=b)}};qa.prototype.getProperty=function(a){if(this[a])return this[a];if("tex_"==a.substr(0,4))return(a=this.textures[a.substr(4)])?a.texture:null;for(var b=0,c=this.properties.length;b<c;++b){var d=this.properties[b];if(d.name==a)return d.value}return null};qa.prototype.setProperty=function(a,b){if(x.prototype.setProperty.call(this,a,b))return!0;"shader_name"==a&&(this.shader_name=b);for(var c=0,d=this.properties.length;c<d;++c){var f=this.properties[c];
if(f.name==a)return f.value=b,!0}if(void 0!==this[a])this[a]=b;else return!1;return!0};qa.prototype.getPropertyInfoFromPath=function(a){if(!(1>a.length)){var b=x.prototype.getPropertyInfoFromPath.call(this,a);if(b)return b;a=a[0];for(var b=0,c=this.properties.length;b<c;++b){var d=this.properties[b];if(d.name==a)return{node:this._root,target:this,name:d.name,value:d.value,type:d.type}}}};qa.prototype.getTextureChannels=function(){for(var a=[],b=0,c=this.properties.length;b<c;++b){var d=this.properties[b];
"texture"!=d.type&&"cubemap"!=d.type&&"sampler"!=d.type||a.push(d.name)}return a};qa.prototype.setTexture=function(a,b,c){if(!a)throw"SurfaceMaterial.prototype.setTexture channel must be specified";var d=null;if("environment"==a)return x.prototype.setTexture.call(this,a,b,c);for(var f=0;f<this.properties.length;++f){var h=this.properties[f];if("texture"==h.type||"cubemap"==h.type||"sampler"==h.type)if(!a||h.name==a){(d=this.textures[a])||(d=this.textures[a]={texture:b,uvs:"0",wrap:0,minFilter:0,magFilter:0});
if(c)for(f in c)d[f]=c[f];h.value="sampler"==h.type?d:b;break}}b&&b.constructor==String&&":"!=b[0]&&e.ResourcesManager.load(b);return d};qa.prototype.getResources=function(a){for(var b=0,c=this.properties.length;b<c;++b){var d=this.properties[b];"texture"!=d.type&&"cubemap"!=d.type&&"sampler"!=d.type||!d.value||(d="sampler"==d.type?d.value.texture:d.value,"string"==typeof d&&(a[d]=GL.Texture))}return a};e.registerMaterialClass(qa);e.SurfaceMaterial=qa;qa.code_template='\n\n\n\\color.vs\n\nprecision mediump float;\nattribute vec3 a_vertex;\nattribute vec3 a_normal;\nattribute vec2 a_coord;\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec2 v_uvs;\n\n//matrices\nuniform mat4 u_model;\nuniform mat4 u_normal_model;\nuniform mat4 u_view;\nuniform mat4 u_viewprojection;\n\n//globals\nuniform float u_time;\nuniform vec4 u_viewport;\nuniform float u_point_size;\n\n#pragma shaderblock "light"\n#pragma shaderblock "morphing"\n#pragma shaderblock "skinning"\n\n//camera\nuniform vec3 u_camera_eye;\n{{vs_out}}\nvoid main() {\n\t\n\tvec4 vertex4 = vec4(a_vertex,1.0);\n\tv_normal = a_normal;\n\tv_uvs = a_coord;\n  \n  //deforms\n  {{vs_local}}\n  applyMorphing( vertex4, v_normal );\n  applySkinning( vertex4, v_normal );\n\t\n\t//vertex\n\tv_pos = (u_model * vertex4).xyz;\n  \n  applyLight(v_pos);\n  \n\t//normal\n\tv_normal = (u_normal_model * vec4(v_normal,0.0)).xyz;\n    {{vs_global}}\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n}\n\n\\color.fs\n\nprecision mediump float;\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec2 v_uvs;\n\n//globals\nuniform vec3 u_camera_eye;\nuniform vec4 u_clipping_plane;\nuniform float u_time;\nuniform vec4 u_background_color;\nuniform vec4 u_material_color;\n\n#pragma shaderblock "light"\n#pragma shaderblock "applyReflection"\n\n#pragma snippet "perturbNormal"\n\n{{fs_out}}\n\nvoid main() {\n\tInput IN = getInput();\n\tSurfaceOutput o = getSurfaceOutput();\n\tsurf(IN,o);\n\tvec4 final_color = vec4(0.0);\n\tLight LIGHT = getLight();\n\tFinalLight final_light = computeLight( o, IN, LIGHT );\n\tfinal_color.xyz = applyLight( o, final_light );\n\tfinal_color.a = o.Alpha;\n\tif( o.Reflectivity > 0.0 )\n\t\tfinal_color = applyReflection( IN, o, final_color );\n\t\n\tgl_FragColor = final_color;\n}\n\n\\shadow.vs\n\nprecision mediump float;\nattribute vec3 a_vertex;\nattribute vec3 a_normal;\nattribute vec2 a_coord;\n#ifdef USE_COLORS\nattribute vec4 a_color;\n#endif\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec2 v_uvs;\n\n//matrices\nuniform mat4 u_model;\nuniform mat4 u_normal_model;\nuniform mat4 u_view;\nuniform mat4 u_viewprojection;\n\n//globals\nuniform float u_time;\nuniform vec4 u_viewport;\nuniform float u_point_size;\n\n#pragma shaderblock "light"\n#pragma shaderblock "morphing"\n#pragma shaderblock "skinning"\n\n//camera\nuniform vec3 u_camera_eye;\n{{vs_out}}\nvoid main() {\n\t\n\tvec4 vertex4 = vec4(a_vertex,1.0);\n\tv_normal = a_normal;\n\tv_uvs = a_coord;\n  \n  //deforms\n  {{vs_local}}\n  applyMorphing( vertex4, v_normal );\n  applySkinning( vertex4, v_normal );\n\t\n\t//vertex\n\tv_pos = (u_model * vertex4).xyz;\n  \n  applyLight(v_pos);\n  \n\t//normal\n\tv_normal = (u_normal_model * vec4(v_normal,0.0)).xyz;\n    {{vs_global}}\n\tgl_Position = u_viewprojection * vec4(v_pos,1.0);\n}\n\\shadow.fs\n\nprecision mediump float;\n\n//varyings\nvarying vec3 v_pos;\nvarying vec3 v_normal;\nvarying vec2 v_uvs;\n\n//globals\nuniform vec3 u_camera_eye;\nuniform vec4 u_clipping_plane;\nuniform vec4 u_material_color;\n\nuniform mat3 u_texture_matrix;\n\n#pragma snippet "input"\n#pragma snippet "surface"\n#pragma snippet "perturbNormal"\n#define SHADOWMAP\n\n{{fs_out}}\n\nvoid main() {\n  Input IN = getInput();\n  SurfaceOutput o = getSurfaceOutput();\n  surf(IN,o);\n  gl_FragColor = vec4(o.Albedo,o.Alpha);\n}\n';
oa.icon="mini-icon-graph.png";oa["@filename"]={type:"resource",data_type:"graph"};oa.prototype.renderInstance=R.prototype.renderInstance;oa.prototype.renderShadowInstance=R.prototype.renderShadowInstance;oa.prototype.renderPickingInstance=R.prototype.renderPickingInstance;Object.defineProperty(oa.prototype,"filename",{enumerable:!1,get:function(){return this._filename},set:function(a){this._filename!=a&&(a&&(a=e.ResourcesManager.cleanFullpath(a)),this._filename=a,this._loading=!1,this.processGraph())}});
Object.defineProperty(oa.prototype,"graphcode",{enumerable:!1,get:function(){return this._graphcode},set:function(a){this._loading=!1;this._filename=(this._graphcode=a)?this._graphcode.fullpath||this._graphcode.filename:null;this.processGraph()}});Object.defineProperty(oa.prototype,"graph",{enumerable:!1,get:function(){return this._graphcode?this._graphcode.graph:null},set:function(a){throw"graph cannot be set to a material, you must assign a graphcode instead";}});oa.shader_codes={};oa.prototype.getShaderCode=
function(a,b,c){return this._graphcode?this._graphcode.getShaderCode():null};oa.prototype.getResources=function(a){if(!this._graphcode)return a;a[this.filename]=!0;this._graphcode&&this._graphcode.graph.sendEventToAllNodes("getResources",a);return a};oa.prototype.serialize=function(){return{uid:this.uid,material_class:e.getObjectClassName(this),filename:this.filename,properties:null}};oa.prototype.configure=function(a){e.cloneObject(a,this);this.processGraph()};oa.prototype.processGraph=function(a,
b){if(this._filename){var c=this;this._graphcode=e.ResourcesManager.getResource(this._filename);this._graphcode||this._loading||(this._loading=!0,e.ResourcesManager.load(this._filename,null,function(a,f){this._loading=!1;f==c.filename&&(a&&a.type==ua.SHADER_GRAPH?c._graphcode=a:console.error("Shader Graph not found or now a Shader Graph"),b&&b(c))}))}else this._graphcode=null};oa.prototype.getProperties=function(){var a={color:"vec3",opacity:"number",shader_name:"string",blend_mode:"number",code:"string"},
b;for(b in this.properties){var c=this.properties[b];a[c.name]=c.type}return a};oa.prototype.onResourceRenamed=function(a,b,c){x.prototype.onResourceRenamed.call(this,a,b,c);for(var d in this.properties)c=this.properties[d],c.value==a&&(c.value=b)};oa.prototype.getProperty=function(a){if(this[a])return this[a];if("tex_"==a.substr(0,4))return this.textures[a.substr(4)];for(var b in this.properties){var c=this.properties[b];if(c.name==a)return c.value}return null};oa.prototype.setProperty=function(a,
b){if(x.prototype.setProperty.call(this,a,b))return!0;for(var c in this.properties){var d=this.properties[c];if(d.name==a)return d.value=b,!0}return!1};oa.prototype.getTextureChannels=function(){var a=[],b;for(b in this.properties){var c=this.properties[b];"texture"!=c.type&&"cubemap"!=c.type||a.push(c.name)}return a};oa.prototype.setTexture=function(a,b,c){for(var d in this.properties)if(c=this.properties[d],"texture"==c.type||"cubemap"==c.type)if(!b||c.name==b)if(c.value=a,this.textures&&(this.textures[b]=
a),!b)break;a&&a.constructor==String&&":"!=a[0]&&ub.load(a)};e.registerMaterialClass(oa);e.GraphMaterial=oa;wa.prototype.configureComponents=function(a){if(a.components){for(var b=[],c=0,d=a.components.length;c<d;++c){var f=a.components[c],h=f[0],g=null;if("Transform"==h&&0==c&&this.transform)g=this.transform;else{g=e.Components[h];if(!g){console.error("Unknown component found: "+h);this._missing_components||(this._missing_components=[]);f[2]=c;this._missing_components.push(f);continue}g=new g;this.addComponent(g)}b.push(g,
f[1]);g.constructor===e.Components.ScriptFromFile&&(g._filename=f[1].filename);f[1].editor&&(g._editor=f[1].editor);f[1].uid&&f[1].uid!==g.uid&&(g.uid=f[1].uid)}c=0;for(d=b.length;c<d;c+=2)b[c].configure(b[c+1])}};wa.prototype.serializeComponents=function(a,b){if(this._components){a.components=[];for(var c=0,d=this._components.length;c<d;++c){var f=this._components[c];if(f.serialize&&!f.skip_serialize){var h=f.serialize(b);f._editor&&!b&&(h.editor=f._editor);f.hasOwnProperty("_uid")&&!h.uid&&(h.uid=
f.uid);f=e.getObjectClassName(f);e.debug&&f!=h.object_class&&console.warn("Component serialize without object_class:",f);h.object_class||(h.object_class=f);a.components.push([f,h])}}if(this._missing_components&&this._missing_components.length)for(c=0;c<this._missing_components.length;++c)d=this._missing_components[c],a.components.splice(d[2]||0,0,d)}};wa.prototype.getComponents=function(a){if(a){var b=[];a.constructor===String&&(a=e.Components[a]);for(var c=0,d=this._components.length;c<d;++c){var f=
this._components[c];f.constructor===a&&b.push(f)}return b}return this._components};wa.prototype.addComponent=function(a,b){if(!a)throw"addComponent cannot receive null";if(a.constructor===String&&(a=e.Components[a],!a))throw"component class not found: "+a;a.is_component&&(a=new a);a._root=this;a.uid||(a.uid=e.generateUId("COMP-"));if(a.onAddedToNode)a.onAddedToNode(this);if(this._in_tree&&(a.uid?this._in_tree._components_by_uid[a.uid]=a:console.warn("component without uid?",a),a.onAddedToScene))a.onAddedToScene(this.constructor==
e.Scene?this:this._in_tree);this._components||Object.defineProperty(this,"_components",{value:[],enumerable:!1});if(-1!=this._components.indexOf(a))throw"inserting the same component twice";void 0!==b&&b<=this._components.length?this._components.splice(b,0,a):this._components.push(a);LEvent.trigger(this,"componentAdded",a);return a};wa.prototype.removeComponent=function(a){if(!a)throw"removeComponent cannot receive null";a._root=null;if(a.onRemovedFromNode)a.onRemovedFromNode(this);if(this._in_tree&&
(delete this._in_tree._components_by_uid[a.uid],a.onRemovedFromScene))a.onRemovedFromScene(this._in_tree);LEvent.unbindAll(this,a);var b=this._components.indexOf(a);-1!=b?this._components.splice(b,1):console.warn("removeComponent: Component not found in node");LEvent.trigger(this,"componentRemoved",a)};wa.prototype.removeAllComponents=function(){for(;this._components.length;)this.removeComponent(this._components[0]);this._missing_components=null};wa.prototype.hasComponent=function(a,b){if(!this._components&&
!this._missing_components)return!1;if(b&&this._missing_components&&this._missing_components.length){a.constructor!==String&&(a=e.getClassName(a));for(var c=0,d=this._missing_components.length;c<d;++c)if(this._missing_components[c][0]==a)return!0}if(a.constructor===String&&(a=e.Components[a],!a))return!1;c=0;for(d=this._components.length;c<d;++c)if(this._components[c].constructor===a)return!0;return!1};wa.prototype.getComponent=function(a,b){if(!this._components||!a)return null;if(a.constructor===
String){if("_"==a[0]){a=a.substr(1);for(var c=0,d=this._components.length;c<d;++c)if(this._components[c].name==a)if(void 0!==b&&0<b)b--;else return this._components[c];return!1}a=e.Components[a];if(!a)return}c=0;for(d=this._components.length;c<d;++c)if(this._components[c].constructor===a)if(void 0!==b&&0<b)b--;else return this._components[c];return null};wa.prototype.getComponentByUId=function(a){if(!this._components)return null;for(var b=0,c=this._components.length;b<c;++b)if(this._components[b].uid==
a)return this._components[b];return null};wa.prototype.getIndexOfComponent=function(a){return this._components?this._components.indexOf(a):-1};wa.prototype.getComponentByIndex=function(a){return this._components?this._components[a]:null};wa.prototype.findComponents=function(a,b){b=b||[];if(!a)return b;a.constructor===String&&(a=e.Components[a]);if(!a)return b;for(var c=0;c<this._components.length;++c){var d=this._components[c];d&&d.constructor===a&&b.push(d)}if(this._children)for(c=0;c<this._children.length;++c)this._children[c].findComponents(a,
b);return b};wa.prototype.setComponentIndex=function(a,b){if(!this._components)return null;0>b&&(b=0);var c=this._components.indexOf(a);-1!=c&&(this._components.splice(c,1),b>=this._components.length?this._components.push(a):this._components.splice(b,0,a))};wa.prototype.requireComponent=function(a,b){if(!a)throw"no component class specified";if(a.constructor===String&&(a=e.Components[a],!a))return console.error("component class not found:",a),null;for(var c=this._components.length,d=0;d<c;++d)if(this._components[d].constructor===
a)return this._components[d];d=new a;this.addComponent(d,c);b&&d.configure(b);return d};wa.prototype.requireScript=function(a){if(!a)throw"no url specified";var b=e.Components.ScriptFromFile;a=e.ResourcesManager.cleanFullpath(a);for(var c=this._components.length,d=0;d<c;++d){var f=this._components[d];if(f.constructor===b&&f._filename==a)return f}b=new b;b.filename=a;this.addComponent(b,c);return b};wa.prototype.processActionInComponents=function(a,b,c){if(this._components&&this._components.length)for(var d=
0,f=this._components.length;d<f;++d){var e=this._components[d];e[a]&&e[a].constructor===Function?b&&b.constructor===Array?e[a].apply(e,b):e[a].call(e,b):c||e._script&&e._script.callMethod(a,b,!0)}};wa.prototype.broadcastMessage=function(a,b){this.processActionInComponents(a,b);if(this._children&&this._children.length)for(var c=0,d=this._children.length;c<d;++c)this._children[c].broadcastMessage(a,b)};ma.prototype.compositeCtor=function(){this._in_tree=this._children=this._parentNode=null};ma.prototype.addChild=
function(a,b,c){function d(a){if(a._children)for(var b in a._children){var c=a._children[b];c._in_tree||(LEvent.trigger(e,"treeItemAdded",c),c._in_tree=e);d(c)}}if(!a)throw"cannot addChild of null";if(a.constructor!==this.constructor)throw"added child must be of the same type";for(var f=this;f._parentNode;){if(f==a)return console.error("addChild: Cannot insert a node as his own child"),!1;f=f._parentNode}a._parentNode&&a._parentNode.removeChild(a,c);a._parentNode=this;this._children?void 0==b?this._children.push(a):
this._children.splice(b,0,a):this._children=[a];var e=this._in_tree;if(e&&a._in_tree&&a._in_tree!=e)throw"Cannot add a node that belongs to another scene tree";a._in_tree=e;this._onChildAdded&&this._onChildAdded(a,c);LEvent.trigger(this,"childAdded",a);e&&(LEvent.trigger(e,"treeItemAdded",a),d(a))};ma.prototype.removeChild=function(a,b,c){function d(a){if(a._children)for(var b=0,c=a._children.length;b<c;++b){var f=a._children[b];f._in_tree&&(LEvent.trigger(f._in_tree,"treeItemRemoved",f),f._in_tree=
null);d(f)}}if(!a)throw"cannot removeChild of null";if(!this._children||a._parentNode!=this||a._parentNode!=this)return!1;var f=this._children.indexOf(a);if(-1==f)return!1;this._children.splice(f,1);this._onChildRemoved&&this._onChildRemoved(a,b,c);LEvent.trigger(this,"childRemoved",a);a._in_tree&&(LEvent.trigger(a._in_tree,"treeItemRemoved",a),d(a));a._in_tree=null;return!0};ma.prototype.removeAllChildren=function(a,b){if(this._children)for(;this._children.length;)this.removeChild(this._children[0],
a,b)};ma.prototype.serializeChildren=function(a){var b=[];if(this._children)for(var c in this._children)b.push(this._children[c].serialize(!1,a));return b};ma.prototype.configureChildren=function(a){if(a.children)for(var b=0;b<a.children.length;++b){var c=a.children[b],d=new this.constructor(c.id);c.uid&&(d.uid=c.uid);c.editor&&(d._editor=c.editor);this.addChild(d);d.configure(c)}};ma.prototype.getParent=function(){return this._parentNode};ma.prototype.getChildren=function(){return this._children||
[]};ma.prototype.getChildIndex=function(a){return this._children?this._children.indexOf(a):-1};ma.prototype.getChildByIndex=function(a){return this._children&&this._children.length>a?this._children[a]:null};ma.prototype.getChildByName=function(a){if(!this._children)return null;for(var b=0;b<this._children.length;++b)if(this._children[b].name==a)return this._children[b];return null};ma.prototype.getPathName=function(){if(!this._in_tree)return null;if(this===this._in_tree.root)return"";for(var a=this.name,
b=this._parentNode;b;){if(b===this._in_tree.root)return a;a=b.name+"|"+a;b=b._parentNode}return null};Object.defineProperty(ma.prototype,"childNodes",{enumerable:!0,get:function(){return this._children||[]},set:function(a){}});Object.defineProperty(ma.prototype,"parentNode",{enumerable:!0,get:function(){return this._parentNode},set:function(a){}});Object.defineProperty(ma.prototype,"scene",{enumerable:!0,get:function(){return this._in_tree},set:function(a){throw"Scene cannot be set, you must use addChild in parent";
}});ma.prototype.getDescendants=function(){if(!this._children||0==this._children.length)return[];for(var a=this._children.concat(),b=0;b<this._children.length;++b)a=a.concat(this._children[b].getDescendants());return a};ma.prototype.moveBefore=function(a){if(!this._parentNode||a&&this._parentNode!==a._parentNode)return-1;var b=this._parentNode._children,c=b.indexOf(this);if(-1==c)throw"moveBefore node not found in parent, this is impossible";var d=c-1;if(a){d=b.indexOf(a);if(-1==d)return-1;d-=1}if(c==
d||0>d)return d;b.splice(c,1);d>c&&(d-=1);b.splice(d,0,this);LEvent.trigger(this._in_tree,"node_rearranged",this);return d};ma.prototype.moveAfter=function(a){if(!this._parentNode||a&&this._parentNode!==a._parentNode)return-1;var b=this._parentNode._children,c=b.indexOf(this);if(-1==c)throw"moveBefore node not found in parent, this is impossible";var d=c+1;if(a){d=b.indexOf(a);if(-1==d)return-1;d+=1}if(c==d||d>=b.length)return d;b.splice(c,1);d>c&&(d-=1);b.splice(d,0,this);LEvent.trigger(this._in_tree,
"node_rearranged",this);return d};ma.prototype.findNode=function(a){return""==a?this:a?a.charAt(0)!=e._uid_prefix?this.findNodeByName(a):this.findNodeByUId(a):null};ma.prototype.findNodeByName=function(a){if(!a)return null;if(this.name==a)return this;var b=this._children;if(b)for(var c=0,d=b.length;c<d;++c){var f=b[c];if(f.name==a||f._children&&(f=f.findNodeByName(a)))return f}return null};ma.prototype.findNodeByUId=function(a){if(!a)return null;if(this.uid==a)return this;var b=this._children;if(b)for(var c=
0;c<b.length;++c){var d=b[c];if(d.uid==a||d._children&&(d=d.findNodeByUId(a)))return d}return null};ma.prototype.getHierarchyLevel=function(){return this._parentNode?this._parentNode.getHierarchyLevel()+1:0};Ha.prototype.getRootNode=function(){return this._root};Ha.prototype.configure=function(a){a&&(a.uid&&(this.uid=a.uid),e.cloneObject(a,this,!1,!0),this.afterConfigure&&this.afterConfigure(a))};Ha.prototype.serialize=function(){var a=e.cloneObject(this,null,!1,!1,!0);this.uid&&(a.uid=this.uid);
a.object_class||(a.object_class=e.getObjectClassName(this));this.afterSerialize&&this.afterSerialize(a);return a};Ha.prototype.clone=function(){var a=this.serialize();a.uid=null;return new this.constructor(a)};Ha.prototype.createProperty=function(a,b,c,d,f){if(void 0===this[a]){if(c){if("String"==c||"Number"==c||"Boolean"==c)console.warn("createProperty: Basic types must be in lowercase -> "+c),c=c.toLowerCase();this.constructor["@"+a]="object"==typeof c?c:{type:c};if(c==e.TYPES.COMPONENT||e.Components[c]||
c.constructor.is_component||c.type==e.TYPES.COMPONENT){var h="_"+a;Object.defineProperty(this,a,{get:function(){return this[h]?Ba.get(this[h],null,this._root&&this._root.scene?this._root._in_tree:e.GlobalScene):null},set:function(a){this[h]=a?a.constructor===String?a:a.uid:a},enumerable:!0});if(e.Components[c]||c.constructor.is_component)c={type:e.TYPES.COMPONENT,component_class:c.constructor===String?c:e.getClassName(c)};this.constructor["@"+a]="object"==typeof c?c:{type:c};return}}null!==b&&void 0!==
b&&b.constructor!==Number&&b.constructor!==String&&b.constructor!==Boolean||d||f?(h="_"+a,Object.hasOwnProperty(this,h)||(c=this,b&&b.constructor===Float32Array?(b=new Float32Array(b),this[h]=b,Object.defineProperty(c,a,{get:f||function(){return b},set:d||function(a){b.set(a)},enumerable:!0})):(Object.defineProperty(c,h,{value:b,enumerable:!1,writable:!0}),Object.defineProperty(c,a,{get:f||function(){return this[h]},set:d||function(a){this[h]=a},enumerable:!0})))):this[a]=b}};Ha.prototype.createAction=
function(a,b,c){b||console.error("action '"+a+"' with no callback associated. Remember to create the action after the callback is defined.");var d=a.replace(/ /gi,"_");this[d]=b;this.constructor["@"+d]=c||{type:"function",button_text:a,widget:"button",callback:b}};Ha.prototype.getLocator=function(a){return this._root?a?(void 0===this[a]&&console.warn("No property found in this component with that name:",a),this._root.uid+"/"+this.uid+"/"+a):this._root.uid+"/"+this.uid:""};Ha.prototype.getPropertyInfoFromPath=
function(a){if(!a.length)return null;var b,c=a[0];this.getPropertyValue&&(b=this.getPropertyValue(c));if(void 0===b&&1<a.length&&this[c]&&this[c].getPropertyInfoFromPath&&(a=this[c].getPropertyInfoFromPath(a.slice(1))))return a.node=this.root,a;if(void 0===b&&void 0===this[c])return null;b=void 0!==b?b:this[c];a=this.constructor["@"+c];var d="";a&&(d=a.type);d||null===b||void 0===b||(b.constructor===String?d="string":b.constructor===Boolean?d="boolean":b.length?d="vec"+b.length:b.constructor===Number&&
(d="number"));return{node:this.root,target:this,name:c,value:b,type:d}};Ha.prototype.broadcastMessage=function(a,b){var c=this._root;c&&c.broadcastMessage(a,b)};Ha.prototype.getComponent=function(a){return this._root?this._root.getComponent(a):null};Ha.prototype.bind=function(a,b,c){if(3<arguments.length)console.error("Component.bind cannot use a fourth parameter, all callbacks will be binded to the component");else if(a){if(c)return this.__targeted_instances||Object.defineProperty(this,"__targeted_instances",
{value:[],enumerable:!1,writable:!0}),-1==this.__targeted_instances.indexOf(a)&&this.__targeted_instances.push(a),LEvent.bind(a,b,c,this);console.error("You cannot bind a method before defining it.")}else console.error("Cannot bind to null.")};Ha.prototype.unbind=function(a,b,c){b=LEvent.unbind(a,b,c,this);if(this.__targeted_instances){if(!LEvent.hasBindTo(a,this))return b;a=this.__targeted_instances.indexOf(a);-1==a&&this.__targeted_instances.splice(a,1);0==this.__targeted_instances.length&&delete this.__targeted_instances}return b};
Ha.prototype.unbindAll=function(){if(this.__targeted_instances){for(var a=0;a<this.__targeted_instances.length;++a)LEvent.unbindAll(this.__targeted_instances[a],this);this.__targeted_instances=null}};Ha.addExtraMethods=function(a){Object.defineProperty(a.prototype,"uid",{set:function(a){a&&(a[0]!=e._uid_prefix&&(console.warn("Invalid UID, renaming it to: "+a),a=e._uid_prefix+a),a!=this._uid&&(this._uid=a))},get:function(){return this._uid},enumerable:!1});Object.defineProperty(a.prototype,"root",
{set:function(a){throw"root cannot be set, call addComponent to the root";},get:function(){return this._root},enumerable:!1});Object.defineProperty(a.prototype,"parentNode",{set:function(){throw"parentNode cannot be set, call addComponent to the parentNode";},get:function(){return this._root},enumerable:!1})};e.BaseComponent=Ha;Object.defineProperty(Ca.prototype,"data",{set:function(a){this._data=a;this._modified=!0},get:function(){return this._data},enumerable:!0});Ca.prototype.register=function(){e.ResourcesManager.registerResource(this.fullpath||
this.filename,this)};Ca.prototype.rename=function(a){e.ResourcesManager.renameResource(this.fullpath||this.filename,a)};Object.defineProperty(Ca.prototype,"uid",{get:function(){return this.fullpath||this.filename},set:function(a){},enumerable:!0});Ca.getDataToStore=function(a,b){var c=null,d="text",f="";a.getDataToStore?(c=a.getDataToStore())&&c.constructor==ArrayBuffer&&(d="binary"):a._original_file?((c=a._original_file)&&c.constructor!==File&&c.constructor!==Blob&&console.warn("Resource._original_file is not File or Blob"),
d="file"):a._original_data?(c=a._original_data)&&c.constructor===ArrayBuffer&&(d="binary"):a.toBinary?(c=a.constructor===GL.Texture?a.toBinary(!0):a.toBinary(),d="binary",f=a.constructor.binary_extension?a.constructor.binary_extension:"wbin"):a.toBlob&&b?(c=a.toBlob(),d="file"):a.toBase64?(c=a.toBase64(),d="base64"):a.serialize?(c=a.serialize(),delete c.filename,delete c.fullpath,delete c.remotepath,delete c.preview_url,c=JSON.stringify(c)):c=a.data?a.data:JSON.stringify(a);c.buffer&&c.buffer.constructor==
ArrayBuffer&&(c=c.buffer);return{data:c,encoding:d,extension:f}};Ca.prototype.getData=function(){return this._data};Ca.prototype.setData=function(a,b){this._original_data&&(this._original_data=null);this._data=a;b||(this._modified=!0)};Ca.prototype.getDataToStore=function(){var a=this.data||"";a.constructor===Object&&(a=JSON.stringify(a));return a};Ca.prototype.clone=function(){var a=new e.Resource;a._data=this._data;return a};Ca.prototype.getCategory=function(){return"js"==e.ResourcesManager.getExtension(this.fullpath||
this.filename)?"Script":"Data"};Ca.prototype.assignToNode=function(a){if(!a)return!1;var b=this.fullpath||this.filename;"Script"==this.getCategory()&&(b=new e.Components.ScriptFromFile({filename:b}),a.addComponent(b));return!0};Ca.prototype.getAsSubfiles=function(){return this._data?GL.processFileAtlas(this._data):null};Ca.prototype.getAsHTML=function(){if(!this._data||this._data.constructor!==String)return null;var a=document.createElement("div");a.innerHTML=this._data;return a};Ca.prototype.hasEditableText=
function(){return this._data&&this._data.constructor===String};Ca.hasPreview=!1;e.Resource=Ca;e.registerResourceClass(Ca);e.NONE=0;e.LINEAR=1;e.TRIGONOMETRIC=2;e.BEZIER=3;e.SPLINE=4;$.EXTENSION="wbin";$.DEFAULT_SCENE_NAME="@scene";$.DEFAULT_DURATION=10;$.prototype.createTake=function(a,b){if(!a)throw"Animation Take name missing";var c=new $.Take;c.name=a;c.duration=b;void 0===b&&(c.duration=$.DEFAULT_DURATION);this.addTake(c);return c};$.prototype.addTake=function(a){return this.takes[a.name]=a};
$.prototype.getTake=function(a){return this.takes[a]};$.prototype.renameTake=function(a,b){var c=this.takes[a];c&&(delete this.takes[a],c.name=b,this.takes[b]=c,LEvent.trigger(this,"take_renamed",[a,b]))};$.prototype.removeTake=function(a){this.takes[a]&&(delete this.takes[a],LEvent.trigger(this,"take_removed",a))};$.prototype.getNumTakes=function(){var a=0,b;for(b in this.takes)a++;return a};$.prototype.addTrackToTake=function(a,b){var c=this.takes[a];c||(c=this.createTake(a));c.addTrack(b)};$.prototype.configure=
function(a){a.name&&(this.name=a.name);if(a.takes){var b=0;this.takes={};for(var c in a.takes){var d=new e.Animation.Take(a.takes[c]);d.name?(this.addTake(d),d.loadResources()):console.warn("Take without name");b++}b||this.createTake("default",e.Animation.DEFAULT_DURATION)}};$.prototype.serialize=function(){return e.cloneObject(this,null,!0)};$.fromBinary=function(a){a.constructor==ArrayBuffer&&(a=WBin.load(a,!0));var b=a["@json"];b||(b=a);for(var c in b.takes){var d=b.takes[c],f;for(f in d.tracks){var h=
d.tracks[f],g="@take_"+c+"_track_"+f;a[g]&&(h.data=a[g])}}return new e.Animation(b)};$.prototype.toBinary=function(){var a={},b=[],c;for(c in this.takes){var d=this.takes[c],f;for(f in d.tracks){var h=d.tracks[f];h.packData();if(h.packed_data){var g=h.data,k="@take_"+c+"_track_"+f;a[k]=g;h.data=null;b.push(g)}}}a["@json"]=e.cloneObject(this,null,!0);b=WBin.create(a,"Animation");for(c in this.takes)for(f in d=this.takes[c],d.tracks)h=d.tracks[f],k="@take_"+c+"_track_"+f,a[k]&&(h.data=a[k]);return b};
$.prototype.convertNamesToIDs=function(a,b){var c=0,d;for(d in this.takes)c+=this.takes[d].convertNamesToIDs(a,b);return c};$.prototype.convertIDsToNames=function(a,b){var c=0,d;for(d in this.takes)c+=this.takes[d].convertIDsToNames(a,b);return c};$.prototype.setTracksPacking=function(a){var b=0,c;for(c in this.takes)b+=this.takes[c].setTracksPacking(a);return b};$.prototype.optimizeTracks=function(){var a=0,b;for(b in this.takes)a+=this.takes[b].optimizeTracks();return a};$.prototype.assignToNode=
function(a){var b=a.getComponent(e.Components.PlayAnimation);b||(b=a.addComponent(e.Components.PlayAnimation));b.animation=this.fullpath||this.filename};e.Classes.Animation=e.Animation=$;pa.prototype.configure=function(a){a.name&&(this.name=a.name);if(a.tracks){this.tracks=[];for(var b in a.tracks){var c=new e.Animation.Track(a.tracks[b]);this.addTrack(c)}}a.duration&&(this.duration=a.duration)};pa.prototype.serialize=pa.prototype.toJSON=function(){return e.cloneObject(this,null,!0)};pa.prototype.createTrack=
function(a){if(!a)throw"Data missing when creating track";var b=this.getTrack(a.property);if(b)return b;b=new e.Animation.Track(a);this.addTrack(b);return b};pa.prototype.applyTracks=function(a,b,c,d,f,h,g,k){f=f||e.GlobalScene;if(0!==h){h=h||1;for(var m=0;m<this.tracks.length;++m){var l=this.tracks[m];if(!1!==l.enabled&&l.data&&(!g||!1!==g(l,a,d,h)))if(l._type_index==Q.EVENT){var n=l.getKeyframeByTime(a);if(!n||n[0]<b||n[0]>a)break;l=f.getPropertyInfoFromPath(l._property_path);if(!l)break;var p=
n[1];1==p[2]?l.node&&l.target&&l.target[p[0]]&&l.target[p[0]].call(l.target,p[1]):l.target?LEvent.trigger(l.target,n[1],n[1][1]):l.node&&LEvent.trigger(l.node,n[1][0],n[1][1])}else n=l.getSample(a,!c),1!==h&&(p=f.getPropertyValueFromPath(l._property_path,n,d,0),n=e.Animation.interpolateLinear(n,p,h,null,l._type,l.value_size,l)),void 0===n||k&&!1===k(l,n,d,h)||(l._target=f.setPropertyValueFromPath(l._property_path,n,d,0))}}};pa.prototype.addTrack=function(a){this.tracks.push(a)};pa.prototype.getTrack=
function(a){for(var b=0;b<this.tracks.length;++b)if(this.tracks[b].property==a)return this.tracks[b];return null};pa.prototype.removeTrack=function(a){for(var b=0;b<this.tracks.length;++b)if(this.tracks[b]==a){this.tracks.splice(b,1);break}};pa.prototype.getPropertiesSample=function(a,b){b=b||[];for(var c=0;c<this.tracks.length;++c){var d=this.tracks[c],f=d.getSample(a);b.push([d.property,f])}return b};pa.prototype.actionPerSample=function(a,b,c){for(var d=0;d<this.tracks.length;++d){var f=this.tracks[d],
e=f.getSample(a,!0);c.disabled_tracks&&c.disabled_tracks[f.property]||b(f.property,e,c)}};pa.prototype.loadResources=function(){for(var a=0;a<this.tracks.length;++a){var b=this.tracks[a];if("texture"==b._type)for(var c=b.getNumberOfKeyframes(),d=0;d<c;++d){var f=b.getKeyframe(d);f&&f[1]&&":"!=f[1][0]&&e.ResourcesManager.load(f[1])}}};pa.prototype.convertNamesToIDs=function(a,b){for(var c=0,d=0;d<this.tracks.length;++d)c+=this.tracks[d].convertNameToID(a,b);return c};pa.prototype.convertIDsToNames=
function(a,b){for(var c=0,d=0;d<this.tracks.length;++d)c+=this.tracks[d].convertIDtoName(a,b);return c};pa.prototype.setTracksPacking=function(a){for(var b=0,c=0;c<this.tracks.length;++c){var d=this.tracks[c];d.packed_data!=a&&(a?d.packData():d.unpackData(),b+=1)}return b};pa.prototype.optimizeTracks=function(){var a=0;new Float32Array(10);for(var b=0;b<this.tracks.length;++b)this.tracks[b].convertToTrans10()&&(a+=1);return a};pa.prototype.matchTranslation=function(a){for(var b=0,c=0;c<this.tracks.length;++c){var d=
this.tracks[c];if(("trans10"==d._type||"mat4"==d._type)&&d._property_path&&d._property_path.length){var f=Ba.get(d._property_path[0],a);if(f){var f=f.transform.position,e=d.value_size+1,g=d.data,k=g.length/e;if("trans10"==d._type)for(d=0;d<k;++d)g.set(f,d*e+1);else if("mat4"==d._type)for(d=0;d<k;++d)g.set(f,d*e+13);b+=1}}}return b};pa.prototype.onlyRotations=function(){for(var a=0,b=0;b<this.tracks.length;++b)this.tracks[b].onlyRotations()&&(a+=1);return a};pa.prototype.removeScaling=function(){for(var a=
0,b=0;b<this.tracks.length;++b)this.tracks[b].removeScaling()&&(a+=1);return a};pa.prototype.setInterpolationToAllTracks=function(a){for(var b=0,c=0;c<this.tracks.length;++c){var d=this.tracks[c];d.interpolation!=a&&(d.interpolation=a,b+=1)}return b};pa.prototype.trimTracks=function(a,b){for(var c=0,d=0;d<this.tracks.length;++d)c+=this.tracks[d].trim(a,b);this.duration=b-a;return c};pa.prototype.stretchTracks=function(a){if(0>=a||0==this.duration)return 0;a/=this.duration;this.duration*=a;for(var b=
0;b<this.tracks.length;++b)this.tracks[b].stretch(a);return this.tracks.length};$.Take=pa;Q.FRAMERATE=30;Q.QUAT=e.TYPES_INDEX.quat;Q.TRANS10=e.TYPES_INDEX.trans10;Q.EVENT=e.TYPES_INDEX.event;Object.defineProperty(Q.prototype,"property",{set:function(a){this._property=a.trim();this._property_path=this._property.split("/")},get:function(){return this._property},enumerable:!0});Object.defineProperty(Q.prototype,"type",{set:function(a){this._type=a;this._type_index=e.TYPES_INDEX[a]},get:function(){return this._type},
enumerable:!0});Q.prototype.configure=function(a){a.property||console.warn("Track with property name");void 0!==a.enabled&&(this.enabled=a.enabled);a.name&&(this.name=a.name);a.property&&(this.property=a.property);a.type&&(this.type=a.type);a.looped&&(this.looped=a.looped);this.interpolation=void 0!==a.interpolation?a.interpolation:e.LINEAR;a.data_table&&(this.data_table=a.data_table);a.value_size&&(this.value_size=a.value_size);a.data&&(this.data=a.data,this.packed_data=void 0===a.packed_data&&this.data.constructor!==
Array?!0:!!a.packed_data,a.data.constructor==Array&&this.packed_data&&(this.data=new Float32Array(a.data)));a.interpolation&&!this.value_size&&(a.interpolation=e.NONE)};Q.prototype.serialize=function(){var a={enabled:this.enabled,name:this.name,property:this.property,type:this._type,interpolation:this.interpolation,looped:this.looped,value_size:this.value_size,packed_data:this.packed_data,data_table:this.data_table};this.data&&(1>=this.value_size?a.data=this.data.concat?this.data.concat():new this.data.constructor(a.data):
(this.packData(),a.data=new Float32Array(this.data),a.packed_data=this.packed_data));return a};Q.prototype.toJSON=Q.prototype.serialize;Q.prototype.clear=function(){this.data=[];this.packed_data=!1};Q.prototype.getIDasName=function(a,b){return this._property_path&&this._property_path.length?e.convertLocatorFromUIDsToName(this._property,a,b):null};Q.prototype.convertNameToID=function(a){if(this._property_path[0][0]===e._uid_prefix)return!1;a=Ba.get(this._property_path[0],a);if(!a)return!1;this._property_path[0]=
a.uid;1<this._property_path.length&&(a=a.getComponent(this._property_path[1]))&&(this._property_path[1]=a.uid);this._property=this._property_path.join("/");return!0};Q.prototype.convertIDtoName=function(a,b){var c=this.getIDasName(a,b);if(!c)return!1;this._property=c;this._property_path=this._property.split("/");return!0};Q.prototype.addKeyframe=function(a,b,c){1<this.value_size&&(b=new Float32Array(b));this.packed_data&&this.unpackData();this.data||(this.data=[]);for(var d=0;d<this.data.length;++d)if(!(this.data[d][0]<
a))return this.data[d][0]!=a||c?this.data.splice(d,0,[a,b]):this.data[d][1]=b,d;this.data.push([a,b]);return this.data.length-1};Q.prototype.getKeyframe=function(a){return 0>a||a>=this.data.length?(console.warn("keyframe index out of bounds"),null):this.packed_data?(a*=1+this.value_size,a>this.data.length-this.value_size?null:[this.data[a],this.data.subarray(a+1,a+this.value_size+1)]):this.data[a]};Q.prototype.getKeyframeByTime=function(a){a=this.findTimeIndex(a);if(-1!=a)return this.getKeyframe(a)};
Q.prototype.moveKeyframe=function(a,b){if(this.packed_data)return console.warn("Cannot move keyframes if packed"),-1;if(0>a||a>=this.data.length)return console.warn("keyframe index out of bounds"),-1;var c=this.findTimeIndex(b),d=this.data[a],f=d[0];if(f==b)return a;d[0]=b;f>b&&(c+=1);if(a==c)return a;this.data.splice(a,1);a=this.addKeyframe(d[0],d[1],!0);this.sortKeyframes();return a};Q.prototype.sortKeyframes=function(){this.packed_data&&(this.unpackData(),this.sortKeyframes(),this.packData());
this.data.sort(function(a,b){return a[0]-b[0]})};Q.prototype.removeKeyframe=function(a){this.packed_data&&this.unpackData();0>a||a>=this.data.length?console.warn("keyframe index out of bounds"):this.data.splice(a,1)};Q.prototype.getNumberOfKeyframes=function(){return this.data&&0!=this.data.length?this.packed_data?this.data.length/(1+this.value_size):this.data.length:0};Q.prototype.computeDuration=function(){if(!this.data||0==this.data.length)return 0;if(this.packed_data){var a=this.data[this.data.length-
2-this.value_size];return this.duration=a}return(a=this.data[this.data.length-1])?a[0]:0};Q.prototype.isInterpolable=function(){return 0<this.value_size||e.Interpolators[this._type]?!0:!1};Q.prototype.packData=function(){if(!this.data||0==this.data.length)return 0;if(!this.packed_data&&0!=this.value_size){for(var a=this.value_size+1,b=this.data,c=new Float32Array(b.length*a),d=0;d<b.length;++d)c[d*a]=b[d][0],1==this.value_size?c[d*a+1]=b[d][1]:c.set(b[d][1],d*a+1);this.data=c;this.packed_data=!0}};
Q.prototype.unpackData=function(){if(!this.data||0==this.data.length)return 0;if(this.packed_data){for(var a=this.value_size+1,b=this.data,c=Array(b.length/a),d=0;d<b.length;d+=a)c[d/a]=[b[d],b.subarray(d+1,d+a)];this.data=c;this.packed_data=!1}};Q.prototype.findTimeIndex=function(a){var b=this.data;if(!b||0==b.length)return-1;if(this.packed_data){var c=this.value_size+1,d=b.length/c,f=0,e=0,g=d;if(0==d)return-1;if(1==d)return 0;if(b[(g-1)*c]<a)return g-1;for(;g>=f;){e=0.5*(g+f)|0;d=b[e*c];if(d==
a)break;if(f==g-1)return f;d<a?f=e:g=e}return e}d=b.length;e=f=0;g=d;if(0==d)return-1;if(1==d)return 0;if(b[g-1][0]<a)return g-1;for(;g>=f;){e=0.5*(g+f)|0;d=b[e][0];if(d==a)break;if(f==g-1)return f;d<a?f=e:g=e}return e};Q.prototype.getSample=function(a,b,c){return this.data&&0!==this.data.length?this.packed_data?this.getSamplePacked(a,b,c):this.getSampleUnpacked(a,b,c):void 0};Q.prototype.getSampleUnpacked=function(a,b,c){a=Math.clamp(a,0,this.duration);var d=this.findTimeIndex(a);-1===d&&(d=0);var f=
d,h=d+1,g=this.data,k=this.value_size;b=b&&this.interpolation&&(0<this.value_size||e.Interpolators[this._type]);if(!b||1==g.length||h==g.length||0==f&&this.data[0][0]>a)return this.data[d][1];b=g[f];h=g[h];a=(h[0]-a)/(h[0]-b[0]);1<k&&(c=c||this._result,c&&c.length==k||(c=this._result=new Float32Array(k)));if(this.interpolation===e.LINEAR)return 1==k?b[1]*a+h[1]*(1-a):e.Animation.interpolateLinear(b[1],h[1],a,c,this._type,k,this);if(this.interpolation===e.BEZIER){if(0===k&&e.Interpolators[this._type])return this._last_value=
c=(0,e.Interpolators[this._type])(b[1],h[1],a,this._last_value);f=0<d?g[d-1]:b;d=d<g.length-2?g[d+2]:h;if(1===k)return $.EvaluateHermiteSpline(b[1],h[1],f[1],d[1],1-a);c=$.EvaluateHermiteSplineVector(b[1],h[1],f[1],d[1],1-a,c);this._type_index==Q.QUAT?(quat.slerp(c,h[1],b[1],a),quat.normalize(c,c)):this._type_index==Q.TRANS10&&(k=c.subarray(3,7),d=b[1].subarray(3,7),g=h[1].subarray(3,7),quat.slerp(k,g,d,a),quat.normalize(k,k));return c}return null};Q.prototype.getSamplePacked=function(a,b,c){a=Math.clamp(a,
0,this.duration);var d=this.findTimeIndex(a);-1==d&&(d=0);var f=this.value_size,h=f+1,g=d,k=d+1,m=this.data,l=m.length/h;b=b&&this.interpolation&&(0<f||e.Interpolators[this._type]);if(!b||1==l||k==l||0==g&&this.data[0]>a)return this.getKeyframe(d)[1];1<f&&(c=c||this._result,c&&c.length==f||(c=this._result=new Float32Array(f)));g=m.subarray(g*h,(g+1)*h);b=m.subarray(k*h,(k+1)*h);a=(b[0]-a)/(b[0]-g[0]);if(this.interpolation===e.LINEAR){if(1==f)return g[1]*a+b[1]*(1-a);h=g.subarray(1,f+1);b=b.subarray(1,
f+1);return e.Animation.interpolateLinear(h,b,a,c,this._type,f,this)}if(this.interpolation===e.BEZIER){if(0===f)return g[1];d=0<d?m.subarray((d-1)*h,d*h):g;k=k<l-1?m.subarray((k+1)*h,(k+2)*h):b;if(1===f)return $.EvaluateHermiteSpline(g[1],b[1],d[1],k[1],1-a);f=g.subarray(1,h);b=b.subarray(1,h);c=$.EvaluateHermiteSplineVector(f,b,d.subarray(1,h),k.subarray(1,h),1-a,c);this._type_index==Q.QUAT?(quat.slerp(c,b,f,a),quat.normalize(c,c)):this._type_index==Q.TRANS10&&(h=c.subarray(3,7),f=f.subarray(3,7),
b=b.subarray(3,7),quat.slerp(h,b,f,a),quat.normalize(h,h));return c}return null};Q.prototype.getPropertyInfo=function(a){a=a||e.GlobalScene;return a.getPropertyInfo(this.property)};Q.prototype.getSampledData=function(a,b,c){b=(b-a)/c;if(0>=b)return null;for(var d=[],f=0;f<c;++f){var e=this.getSample(f*b+a,!0);1<this.value_size&&(e=new e.constructor(e));d.push(e)}return d};Q.prototype.trim=function(a,b){this.packed_data&&this.unpackData();for(var c=this.data.length,d=[],f=0;f<c;++f){var e=this.data[f];
e[0]<a||e[0]>b||(e[0]-=a,d.push(e))}this.data=d;return this.data.length!=c?1:0};Q.prototype.stretch=function(a){this.packed_data&&this.unpackData();for(var b=this.data.length,c=0;c<b;++c)this.data[c][0]*=a;return 1};Q.prototype.convertToTrans10=function(){if(16!=this.value_size)return!1;this.packed_data||this.packData();var a=this.property.split("/");if("matrix"!=a[a.length-1])return!1;a[a.length-1]="Transform/data";this.property=a.join("/");this.type="trans10";this.value_size=10;for(var a=new Float32Array(10),
b=this.data,c=b.length/17,d=0;d<c;++d){var f=b.subarray(17*d+1,17*d+17);e.Transform.fromMatrix4ToTransformData(f,a);b[11*d]=b[17*d];b.set(a,11*d+1)}this.data=new Float32Array(b.subarray(0,11*c));return!0};Q.prototype.removeScaling=function(){var a=!1;"matrix"==this.type&&(this.convertToTrans10(),a=!0);if("trans10"!=this.type&&a)return!0;for(var a=this.getNumberOfKeyframes(),b=0;b<a;++b){var c=this.getKeyframe(b);c[1][7]=c[1][8]=c[1][9]=1}return!0};Q.prototype.onlyRotations=function(){var a=new Float32Array(10),
b=new Float32Array(4);return function(){var c=this.property.split("/"),d=c[c.length-1],f=this.value_size;if("mat4"!=this.type&&"trans10"!=this.type)return!1;"matrix"==d?c[c.length-1]="Transform/rotation":"data"==d&&(c[c.length-1]="rotation");this.packed_data||this.packData();this.property=c.join("/");d=this._type;this.type="quat";this.value_size=4;c=this.data;f=c.length/(f+1);if("mat4"==d)for(d=0;d<f;++d){var h=c.subarray(17*d+1,17*d+17);e.Transform.fromMatrix4ToTransformData(h,a);b.set(a.subarray(3,
7));c[5*d]=c[17*d];c.set(b,5*d+1)}else if("trans10"==d)for(d=0;d<f;++d)h=c.subarray(11*d+4,11*d+8),c[5*d]=c[11*d],c.set(h,5*d+1);this.data=new Float32Array(c.subarray(0,5*f));return!0}}();$.Track=Q;$.interpolateLinear=function(a,b,c,d,f,h,g){if(1==h)return a*c+b*(1-c);if(e.Interpolators[f])return c=(0,e.Interpolators[f])(a,b,c,g._last_v),g._last_v=c;d=d||g._result;d&&d.length==h||(d=g._result=new Float32Array(h));switch(e.TYPES_INDEX[f]){case Q.QUAT:quat.slerp(d,b,a,c);quat.normalize(d,d);break;case Q.TRANS10:for(g=
0;3>g;g++)d[g]=a[g]*c+b[g]*(1-c);for(g=7;10>g;g++)d[g]=a[g]*c+b[g]*(1-c);a=a.subarray(3,7);b=b.subarray(3,7);h=d.subarray(3,7);quat.slerp(h,b,a,c);quat.normalize(h,h);break;default:for(g=0;g<h;g++)d[g]=a[g]*c+b[g]*(1-c)}return d};$.EvaluateHermiteSpline=function(a,b,c,d,f){var e=f*f,g=e*f;return(2*g-3*e+1)*a+(-2*g+3*e)*b+(g-2*e+f)*(b-c)+(g-e)*(d-a)};$.EvaluateHermiteSplineVector=function(a,b,c,d,f,e){e=e||new Float32Array(e.length);var g=f*f,k=g*f,m=2*k-3*g+1,l=-2*k+3*g;f=k-2*g+f;for(var g=k-g,k=
0,n=e.length;k<n;++k)e[k]=m*a[k]+l*b[k]+f*(b[k]-c[k])+g*(d[k]-a[k]);return e};e.registerResourceClass($);e.Interpolators={};e.Interpolators.texture=function(a,b,c,d){var f=a?e.getTexture(a):null,h=b?e.getTexture(b):null;a&&!f&&":"!=a[0]&&e.ResourcesManager.load(a);b&&!h&&":"!=b[0]&&e.ResourcesManager.load(b);a=f||h;(b=gl.textures[":black"])||(b=gl.textures[":black"]=new GL.Texture(1,1,{format:gl.RGB,pixel_data:[0,0,0],filter:gl.NEAREST}));if(!a)return b;var g=a?a.width:256,k=a?a.height:256;f||(f=
b);h||(h=b);d&&d.width==g&&d.height==k&&d.format==a.format||(d=new GL.Texture(g,k,{format:a.format,type:a.type,filter:gl.LINEAR}));var m=gl.shaders[":interpolate_texture"];m||(m=gl.shaders[":interpolate_texture"]=GL.Shader.createFX("color = mix( texture2D( u_texture_b, uv ), color , u_factor );","uniform sampler2D u_texture_b; uniform float u_factor;"));gl.disable(gl.DEPTH_TEST);d.drawTo(function(){gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);h.bind(1);f.toViewport(m,{u_texture_b:1,u_factor:c})});
return d};ka.version="0.2";ka.prototype.configure=function(a){this._data=e.cloneObject(a);this.resource_names=a["@resource_names"];this._resources_data={};if(this.resource_names){delete this._data["@resource_names"];for(var b in this.resource_names)this._resources_data[this.resource_names[b]]=a["@RES_"+b],delete this._data["@RES_"+b]}this.processResources()};Object.defineProperty(ka.prototype,"bindata",{set:function(a){throw"Pack bindata cannot be assigned";},get:function(){this._original_data||(this._original_data=
e.Pack.packResources(this.resource_names,this._data));return this._original_data},enumerable:!0});ka.fromBinary=function(a){a.constructor==ArrayBuffer&&(a=WBin.load(a,!0));return new e.Pack(a)};ka.prototype.processResources=function(){if(this.resource_names){for(var a=this.fullpath||this.filename,b=0;b<this.resource_names.length;++b){var c=this.resource_names[b];e.ResourcesManager.resources[c]||(e.ResourcesManager.resources_being_processed[c]=!0)}for(b=0;b<this.resource_names.length;++b)if(c=this.resource_names[b],
!e.ResourcesManager.resources[c]){var d=this._resources_data[c];d?e.ResourcesManager.processResource(c,d,{is_local:!0,from_pack:a}):console.warn("resource data in Pack is undefined, skipping it:"+c)}}};ka.prototype.setResources=function(a,b){this.resource_names=[];this._resources_data={};for(var c=this.fullpath||this.filename,d=0;d<a.length;++d){var f=a[d];if(-1==this.resource_names.indexOf(f)){var h=e.ResourcesManager.resources[f];h&&(b&&(h.from_pack=c),this.resource_names.push(f))}}this._original_data=
e.Pack.packResources(a,this.getBaseData());this._modified=!0};ka.prototype.getBaseData=function(){return{"@metadata":this.metadata,"@version":e.Pack.version}};ka.prototype.setResourcesLink=function(a){for(var b=0;b<this.resource_names.length;++b){var c=e.ResourcesManager.resources[this.resource_names[b]];c&&(a?c.from_pack=a:delete c.from_pack)}};ka.prototype.addResources=function(a,b){a&&(a.constructor!==Array&&(a=[a]),this.setResources(this.resource_names.concat(a),b))};ka.prototype.addResource=
function(a){a=e.ResourcesManager.cleanFullpath(a);-1==this.resource_names.indexOf(a)&&this.resource_names.push(a)};ka.prototype.removeResource=function(a){a=e.ResourcesManager.cleanFullpath(a);a=this.resource_names.indexOf(a);-1!=a&&this.resource_names.splice(a,1)};ka.createPack=function(a,b,c,d){if(a){if(!b||b.constructor!==Array)throw"Pack.createPack resources must be array with names";if(c&&c.constructor!==Object)throw"Pack.createPack extra_data must be an object with the chunks to store";a=a.replace(/ /gi,
"_");var f=new e.Pack;f.filename=a+".wbin";c&&(f._data=c);f.resource_names=b;for(a=0;a<b.length;++a){var h=e.ResourcesManager.resources[b[a]];h&&d&&(h.from_pack=f.filename)}this.metadata=c;b=e.Pack.packResources(b,f.getBaseData());f._original_data=b;return f}};ka.packResources=function(a,b){for(var c=b||{},d=[],f=0;f<a.length;++f){var h=a[f],g=e.ResourcesManager.resources[h];if(g){var k=null;if(k=g._original_data?g._original_data:e.Resource.getDataToStore(g).data){if(k.constructor===Blob||k.constructor===
File){if(!k.data||k.data.constructor!==ArrayBuffer){console.warn("WBin does not support to store File or Blob, please, use ArrayBuffer");continue}k=k.data}c["@RES_"+d.length]=k;d.push(h)}else console.warn("Wrong data in resource")}}c["@resource_names"]=d;return WBin.create(c,"Pack")};ka.prototype.flagResources=function(){if(this.resource_names)for(var a=0;a<this.resource_names.length;++a){var b=e.ResourcesManager.resources[this.resource_names[a]];b&&(b.from_pack=this.fullpath||this.filename)}};ka.prototype.getDataToStore=
function(){return e.Pack.packResources(this.resource_names,this.getBaseData())};ka.prototype.checkResourceNames=function(){if(!this.resource_names)return 0;for(var a=0,b=0;b<this.resource_names.length;++b){var c=this.resource_names[b],d=c,f=e.ResourcesManager.resources[c];if(f){!1==e.ResourcesManager.valid_resource_name_reg.test(c)&&(console.warn("Invalid filename in pack/prefab: ",c),c=c.replace(/[^a-zA-Z0-9-_\.\/]/g,"_"));var h=e.ResourcesManager.getExtension(c);h||((h=f.constructor.EXTENSION)?
c=c+"."+h:console.warn("Resource without extension and not known default extension: ",c,f.constructor.name));d!=c&&(this.resource_names[b]=c,e.ResourcesManager.renameResource(d,c),a++)}}a&&e.ResourcesManager.resourceModified(this);return a};ka.prototype.onResourceRenamed=function(a,b,c){this.resource_names&&(a=this.resource_names[a],-1!=a&&(this.resource_names[a]=b,e.ResourcesManager.resourceModified(this)))};ka.prototype.containsResources=function(){return this.resource_names&&0<this.resource_names.length?
!0:!1};e.Pack=ka;e.registerResourceClass(ka);na.version="0.2";na.prototype.setData=function(a){a&&a.constructor===e.SceneNode&&(a=a.serialize());a.object_class="SceneNode";this.prefab_data=a;this.prefab_json=JSON.stringify(a)};na.prototype.configure=function(a){if(!a)throw"No prefab data found";if(a.hasOwnProperty("prefab_data"))this.prefab_data=a.prefab_data,this.prefab_json=a.prefab_json||JSON.stringify(this.prefab_data);else{var b=a["@json"];if(!b){console.warn("No JSON found in prefab");return}var c=
a["@version"];this.prefab_json=b;this.prefab_data=JSON.parse(b)}this.resource_names=a["@resources_name"]||a.resource_names||[];var b={},d;for(d in this.resource_names)b[this.resource_names[d]]=c?a["@RES_"+d]:a[this.resource_names[d]];this._resources_data=b;this.processResources()};na.fromBinary=function(a,b){a.constructor==ArrayBuffer&&(a=WBin.load(a,!0));return new e.Prefab(a,b)};na.prototype.processResources=function(){if(this._resources_data){var a=this.fullpath||this.filename,b=this._resources_data,
c;for(c in b)e.ResourcesManager.resources[c]||(e.ResourcesManager.resources_being_processed[c]=!0);for(c in b)if(!e.ResourcesManager.resources[c]){var d=b[c];d?e.ResourcesManager.processResource(c,d,{is_local:!0,from_prefab:a}):console.warn("resource data in prefab is undefined, skipping it:"+c)}}};na.prototype.createObject=function(){if(!this.prefab_json)throw"No prefab_json data found";var a=JSON.parse(this.prefab_json);if(!a)return console.error("Prefab data is null"),null;var b=new e.SceneNode;
b.configure(a);e.ResourcesManager.loadResources(b.getResources({},!0));this.fullpath&&(b.prefab=this.fullpath);return b};na.prototype.addResource=function(a){a=e.ResourcesManager.cleanFullpath(a);-1==this.resource_names.indexOf(a)&&this.resource_names.push(a)};na.prototype.removeResource=function(a){a=e.ResourcesManager.cleanFullpath(a);a=this.resource_names.indexOf(a);-1!=a&&this.resource_names.splice(a,1)};na.createPrefab=function(a,b,c){if(a){if(!b)throw"No node_data in prefab";a=a.replace(/ /gi,
"_");c=c||[];var d=new e.Prefab;"wbin"!=e.ResourcesManager.getExtension(a)&&(a+=".wbin");d.filename=a;d.resource_names=c;d.setData(b);a=e.Prefab.packResources(c,{"@json":d.prefab_json,"@version":na.version},this);d._original_data=a;return d}};na.packResources=function(a,b,c){b=b||{};c=[];if(a&&a.length)for(var d=0;d<a.length;++d){var f=a[d],h=e.ResourcesManager.resources[f];if(h){var g=null;if(h._original_data)g=h._original_data;else{g=e.Resource.getDataToStore(h);if(!g){console.warn("Data to store from resource is null, skipping: ",
f);continue}if(g.extension&&g.extension!=e.ResourcesManager.getExtension(f)){console.warn("The resource extension has changed while saving, this could lead to problems: ",f,g.extension);var k=f,f=f+"."+g.extension;a[d]=f;e.GlobalScene.sendResourceRenamedEvent(k,f,h)}g=g.data}g?g.constructor===Blob||g.constructor===File?console.warn("WBin does not support to store File or Blob, please convert to ArrayBuffer using FileReader"):(b["@RES_"+c.length]=g,c.push(f)):console.warn("Wrong data in resource")}}b["@resources_name"]=
c;return WBin.create(b,"Prefab")};na.prototype.updateFromNode=function(a,b){var c=a.serialize(!0);b&&e.clearUIds(c);this.prefab_data=c;this.prefab_json=JSON.stringify(c)};na.prototype.flagResources=function(){if(this.resource_names)for(var a=0;a<this.resource_names.length;++a){var b=e.ResourcesManager.resources[this.resource_names[a]];b&&(b.from_prefab=this.fullpath||this.filename)}};na.prototype.setResourcesLink=function(a){if(this.resource_names)for(var b=0;b<this.resource_names.length;++b){var c=
e.ResourcesManager.resources[this.resource_names[b]];c&&(a?c.from_prefab=a:delete c.from_prefab)}};na.prototype.applyToNodes=function(a){a=a||e.GlobalScene;for(var b=this.fullpath||this.filename,c=0;c<a._nodes.length;++c){var d=a._nodes[c];d.prefab==b&&d.reloadFromPrefab()}};na.prototype.getDataToStore=function(){this.prefab_json=JSON.stringify(this.prefab_data);var a=this.fullpath||this.filename;return this.resource_names&&this.resource_names.length||!a||"json"!=e.RM.getExtension(a)?e.Prefab.packResources(this.resource_names,
this.getBaseData(),this):JSON.stringify({object_class:e.getObjectClassName(this),"@json":this.prefab_json})};na.prototype.getBaseData=function(){return{"@json":this.prefab_json,"@version":e.Prefab.version}};na.prototype.containsResources=ka.prototype.containsResources;na.prototype.onResourceRenamed=ka.prototype.onResourceRenamed;na.prototype.checkResourceNames=ka.prototype.checkResourceNames;na.prototype.setResources=ka.prototype.setResources;e.Prefab=na;e.registerResourceClass(na);ba.help_url="https://github.com/jagenjo/litescene.js/blob/master/guides/shaders.md";
ba.CODE=1;ba.PRAGMA=2;ba.INCLUDE=1;ba.SHADERBLOCK=2;ba.SNIPPET=3;Object.defineProperty(ba.prototype,"code",{enumerable:!0,get:function(){return this._code},set:function(a){this._code!=a&&(this._code=a,this.processCode())}});Object.defineProperty(ba.prototype,"version",{enumerable:!1,get:function(){return this._version},set:function(a){console.error("version cannot be set manually")}});ba.prototype.processCode=function(){this._global_uniforms={};this._code_parts={};this._compiled_shaders={};this._functions=
{};this._shaderblock_flags_num=0;this._shaderblock_flags={};this._shaderblock_vars=null;this._has_error=!1;var a=GL.processFileAtlas(this._code);this._subfiles=a;var b=0,c=null,d;for(d in a){var f=d,h=a[d];b++;if(f)if("js"==f)c=h;else if("uniforms"==f)for(var f=h.split("/n"),g=0;g<f.length;++g){var k=f[g].trim(),m=k.split(" "),h=m[0],l=m[1],n=m[2],m=m[3];void 0!==m&&(m=e.stringToValue(m));var p=null,q=k.indexOf("{");-1!=q&&(p=e.stringToValue(k.substr(q)));this._global_uniforms[h]={name:h,uniform:l,
type:n,value:m,options:p}}else if(l=e.ResourcesManager.removeExtension(f),"default"==l&&(l="color"),f=e.ResourcesManager.getExtension(f),"vs"==f||"fs"==f){(k=this._code_parts[l])||(k=this._code_parts[l]={});h=new fa(h);for(g in h.blocks)(l=h.blocks[g])&&l.type==ba.PRAGMA&&(l.shader_block_flag=this._shaderblock_flags_num,this._shaderblock_flags[l.shader_block]=l.shader_block_flag,this._shaderblock_flags_num+=1);k[f]=h}}if(a=this.getShader()){if(c&&(c=e.ShaderCode.removeComments(c)))if(e.catch_exceptions)try{this._functions.init=
new Function(c)}catch(r){e.dispatchCodeError(r,Z.computeLineFromError(r),this)}else this._functions.init=new Function(c);this.validatePublicUniforms(a);LEvent.trigger(e.ShaderCode,"modified",this);this._version+=1}};ba.prototype.setData=function(a,b){this.code=a;b||(this._modified=!0)};ba.prototype.getData=function(){return this._code};ba.prototype.getDataToStore=function(){return this._code};ba.prototype.getShader=function(a,b){if(this._has_error)return null;a=a||"color";b=b||0;var c=this._compiled_shaders[a];
if(c){var d=c.get(b);if(d)return d}d=this._code_parts[a];if(!d)return null;for(var c={},f=0,h=e.Shaders.shader_blocks.length;f<h;++f)if(b&1<<f){var g=e.Shaders.shader_blocks[f];if(g&&g.context_macros)for(var k in g.context_macros)c[k]=g.context_macros[k]}k=null;if("fx"==a)k=GL.Shader.SCREEN_VERTEX_SHADER;else if(d.vs)k=d.vs.getFinalCode(GL.VERTEX_SHADER,b,c);else return null;if(d.fs){h=d.fs.getFinalCode(GL.FRAGMENT_SHADER,b,c);if(!k||!h)return this._has_error=!0,null;f="";if(2==gl.webgl_version||
gl.extensions.OES_standard_derivatives)f+="#define STANDARD_DERIVATIVES\n";if(2==gl.webgl_version||gl.extensions.WEBGL_draw_buffers)f+="#define DRAW_BUFFERS\n";f&&(h=f+h);d=this.compileShader(k,h);if(!d)return null;if(e.debug){for(var m=[],f=0;f<e.Shaders.num_shaderblocks;++f)b&1<<f&&(g=e.Shaders.shader_blocks[f])&&m.push(g);d._shadercode_info={vs:k,fs:h,context:c,blocks:m,flags:b}}this._compiled_shaders[a]||(this._compiled_shaders[a]=new Map);this._compiled_shaders[a].set(b,d);return d}};ba.prototype.compileShader=
function(a,b){if(this._has_error)return null;e.Debug&&(console.log("Shader Compiled: ",this.fullpath||this.filename),console.groupCollapsed("VS shader"),console.log(a),console.groupEnd(),console.groupCollapsed("FS shader"),console.log(b),console.groupEnd());if(e.catch_exceptions)try{return new GL.Shader(a,b)}catch(c){this._has_error=!0;e.Shaders.dumpShaderError(this.filename,c,a,b);var d=GL.Shader.parseError(c,a,b),f=this._code.split("\n"),h=-1;if(d.line_code){d=d.line_code.trim();for(h=0;h<f.length;++h)f[h]=
f[h].trim();h=f.indexOf(d)}e.dispatchCodeError(c,h,this,"shader")}else return new GL.Shader(a,b);return null};ba.prototype.clearCache=function(){this._compiled_shaders={}};ba.prototype.validatePublicUniforms=function(a){if(!a)throw"ShaderCode: Shader cannot be null";for(var b in this._global_uniforms)a.uniformInfo[this._global_uniforms[b].uniform]||(info.disabled=!0)};ba.prototype.register=function(){e.ResourcesManager.registerResource(this.fullpath||this.filename,this)};ba.prototype.applyToMaterials=
function(a){a=a||e.GlobalScene;var b=this.fullpath||this.filename,c;for(c in e.ResourcesManager.resources){var d=e.ResourcesManager.resources[c];d.constructor===e.ShaderMaterial&&d._shader==b&&d.processShaderCode()}a=a.getNodes();for(c=0;c<a.length;++c)d=a[c],d.material&&d.material.constructor===e.ShaderMaterial&&d.material._shader==b&&d.material.processShaderCode()};ba.prototype.hasEditableText=function(){return!0};ba.removeComments=function(a){return a.replace(/(\/\*([\s\S]*?)\*\/)|(\/\/(.*)$)/gm,
"")};ba.replaceCode=function(a,b){return a.replace(/\{\{[a-zA-Z0-9_]*\}\}/g,function(a){a=a.replace(/[\{\}]/g,"");return b[a]||""})};ba.parseShaderLab=function(a){var b={},c=b,d=[],f=[],e=0,g="";a=ba.removeComments(a).split("\n");for(var k=0;k<a.length;++k){var m=a[k].trim(),l=m.match(/[^\s"]+|"([^"]*)"/gi);if(l)if(0!=e){var n=l[0].trim();"ENDGLSL"==n||"ENDCG"==n?(e=0,c.codetype=e,c.code=g,g=""):g+=m+"\n"}else for(m=0;m<l.length;++m)if(n=l[m],"{"==n)n={name:d[0],params:d.slice(1).join(" "),content:{}},
c[n.name]=n,d=[],f.push(c),c=n.content;else if("}"==n){if(0==f.length)return console.error("error parsing ShaderLab code, the number of { do not matches the }"),null;d.length&&(c[d[0]]=d.join(" "),d=[]);c=f.pop()}else"{}"==n?(n={name:d[0],params:d.slice(1).join(" "),content:{}},c[n.name]=n,d=[]):"GLSLPROGRAM"==n||"CGPROGRAM"==n?(e="GLSLPROGRAM"==n?1:2,g=""):d.push(n)}return b};ba.flat_code="\\color.vs\n\tprecision mediump float;\n\tattribute vec3 a_vertex;\n\tuniform mat4 u_model;\n\tuniform mat4 u_viewprojection;\n\tvoid main() {\n\t\tvec4 vertex4 = vec4(a_vertex,1.0);\n\t\tgl_Position = (u_viewprojection * u_model) * vertex4;\n\t}\n\\color.fs\n\tprecision mediump float;\n\tuniform vec4 u_material_color;\n\tvoid main() {\n\t\tgl_FragColor = u_material_color;\n\t}\n\\picking.vs\n\tprecision mediump float;\n\tattribute vec3 a_vertex;\n\tuniform mat4 u_model;\n\tuniform mat4 u_viewprojection;\n\tvoid main() {\n\t\tvec4 vertex4 = vec4(a_vertex,1.0);\n\t\tgl_Position = (u_viewprojection * u_model) * vertex4;\n\t}\n\\picking.fs\n\tprecision mediump float;\n\tuniform vec4 u_material_color;\n\tvoid main() {\n\t\tgl_FragColor = u_material_color;\n\t}\n\\shadow.vs\n\tprecision mediump float;\n\tattribute vec3 a_vertex;\n\tuniform mat4 u_model;\n\tuniform mat4 u_viewprojection;\n\tvoid main() {\n\t\tvec4 vertex4 = vec4(a_vertex,1.0);\n\t\tgl_Position = (u_viewprojection * u_model) * vertex4;\n\t}\n\\shadow.fs\n\tprecision mediump float;\n\tuniform vec4 u_material_color;\n\tvoid main() {\n\t\tgl_FragColor = u_material_color;\n\t}\n";
e.ShaderCode=ba;e.registerResourceClass(ba);ua.LOGIC_GRAPH=1;ua.SHADER_GRAPH=2;ua.EXTENSION="GRAPH.json";ua.hasPreview=!1;Object.defineProperty(ua.prototype,"graph",{enumerable:!1,get:function(){return this._graph},set:function(a){console.error("graph cannot be set manually")}});Object.defineProperty(ua.prototype,"data",{enumerable:!1,get:function(){return this.getData()},set:function(a){this.setData(a)}});Object.defineProperty(ua.prototype,"version",{enumerable:!1,get:function(){return this._version},
set:function(a){console.error("version cannot be set manually")}});Object.defineProperty(ua.prototype,"type",{enumerable:!1,get:function(){return this.extra.type},set:function(a){this.extra.type=a}});ua.prototype.setData=function(a,b){if(a){if(e.catch_exceptions)try{this._data=a.constructor===String?JSON.parse(a):JSON.parse(JSON.stringify(a))}catch(c){console.error("error in graph data");return}else this._data=a.constructor===String?JSON.parse(a):JSON.parse(JSON.stringify(a));this._graph.configure(this._data);
this._data.extra&&(this.extra=this._data.extra);b||(this._version++,this._modified=!0)}else this._data=null};ua.prototype.getData=function(){var a=this.graph.serialize();a.object_class="GraphCode";a.extra=this.extra;return a};ua.prototype.getDataToStore=function(){return JSON.stringify(this.getData())};ua.prototype.getCategory=function(){return"Graph"};ua.prototype.propagate=function(){if(this.type==ua.LOGIC_GRAPH)for(var a=e.GlobalScene.findNodeComponents(e.Components.GraphComponent),b=0;b<a.length;++b){var c=
a[b];c.filename==this.filename&&(c.graphcode=this)}};ua.prototype.getShaderCode=function(a){if(this._shader_code&&this._code_version==this._graph._version&&!a)return this._shader_code;this._shader_code||(this._shader_code=new e.ShaderCode);var b=e.SurfaceMaterial.code_template,c={uniforms:[]},d="",f=this._graph._nodes_in_order;if(f)for(var h=0;h<f.length;++h){var g=f[h];g.onGetCode&&(d+=g.onGetCode("glsl",c))}f="";for(h=0;h<c.uniforms.length;++h)g=c.uniforms[h],f+="uniform "+g.type+" "+g.link_name+
";\n";c={fs_out:f+"\n\nvoid surf( in Input IN, inout SurfaceOutput o ) {\n\to.Albedo = vec3(1.0) * IN.color.xyz;\n\to.Normal = IN.worldNormal;\n\to.Emission = vec3(0.0);\n\to.Specular = 1.0;\n\to.Gloss = 40.0;\n\to.Reflectivity = 0.0;\n\to.Alpha = IN.color.a;\n\n"+d+"\n}\n"};if(a)return c.fs_out;this._shader_code.code=e.ShaderCode.replaceCode(b,c);this._code_version=this._graph._version;return this._shader_code};e.GraphCode=ua;e.registerResourceClass(ua);"undefined"!=typeof LiteGraph&&(Y.LGraphScene=
function(){this.addOutput("Time","number");this._scene=null},LGraphScene.title="Scene",LGraphScene.desc="Scene",LGraphScene.getComponents=function(a,b){b=b||[];var c=a.getComponents();if(!c)return b;for(var d=0;d<c.length;++d){var f=e.getClassName(c[d].constructor);b.push([f,f])}return b},LGraphScene.prototype.onAdded=function(a){this.bindEvents(this.graph.getScene?this.graph.getScene():e.GlobalScene)},LGraphScene.prototype.onRemoved=function(){this.bindEvents(null)},LGraphScene.prototype.onConnectionsChange=
function(){this.bindEvents(this.graph.getScene?this.graph.getScene():e.GlobalScene)},LGraphScene.prototype.bindEvents=function(a){this._scene&&LEvent.unbindAll(this._scene,this);if((this._scene=a)&&this.outputs&&this.outputs.length)for(a=0;a<this.outputs.length;++a){var b=this.outputs[a];b.type===LiteGraph.EVENT&&(b=b.name.substr(3),LEvent.bind(this._scene,b,this.onEvent,this))}},LGraphScene.prototype.onEvent=function(a,b){this.trigger("on_"+a,b)},LGraphScene.prototype.onExecute=function(){var a=
this.graph.getScene?this.graph.getScene():e.GlobalScene;if(this.inputs)for(var b=0;b<this.inputs.length;++b)this.getInputData(b);if(this.outputs)for(b=0;b<this.outputs.length;++b){var c=this.outputs[b];if(c.links&&c.links.length&&c.type!=LiteGraph.EVENT){var d=null;switch(c.name){case "Time":d=a.getTime();break;case "Elapsed":d=null!=a._last_dt?a._last_dt:0;break;case "Frame":d=null!=a._frame?a._frame:0;break;default:d=a.root.getComponent(c.name)}this.setOutputData(b,d)}}},LGraphScene.prototype.onGetOutputs=
function(){var a=[["Elapsed","number"],["Frame","number"],["on_start",LiteGraph.EVENT],["on_finish",LiteGraph.EVENT]];return LGraphScene.getComponents(this.graph.getScene().root,a)},LiteGraph.registerNodeType("scene/scene",LGraphScene),Y.LGraphSceneNode=function(){this.properties={node_id:""};this.size=[100,20];this._node=null},LGraphSceneNode.title="SceneNode",LGraphSceneNode.desc="Node on the scene",LGraphSceneNode.prototype.onRemoved=function(){this._node&&this.bindNodeEvents(null)},LGraphSceneNode.prototype.onConnectionsChange=
function(){this.bindNodeEvents(this._component)},LGraphSceneNode.prototype.getNode=function(){var a=null;if(!this.graph)return null;this.inputs&&this.inputs[0]&&(a=this.getInputData(0));a&&(this.properties.node_id=a);!a&&this.properties.node_id&&(a=this.properties.node_id);if("@"==a)return this.graph._scenenode?this.graph._scenenode:null;var b=this.graph&&this.graph.getScene?this.graph.getScene():e.GlobalScene;if(b){var c=null;a&&(c=b.getNode(a));this._node!=c&&this.bindNodeEvents(c);return c}},LGraphSceneNode.prototype.onExecute=
function(){var a=this.getNode();if(a){if(this.inputs)for(var b=0;b<this.inputs.length;++b){var c=this.inputs[b];if(c.type!==LiteGraph.ACTION){var d=this.getInputData(b);if(void 0!==d)switch(c.name){case "UID":this.properties.node_id=d;break;case "SceneNode":this.properties.node_id=d?d.uid:null;d&&(a=d);break;case "Transform":a.transform.copyFrom(d);break;case "Material":a.material=d;break;case "Visible":a.flags.visible=d}}}if(this.outputs)for(b=0;b<this.outputs.length;++b)if(c=this.outputs[b],c.links&&
c.links.length&&c.type!=LiteGraph.EVENT)switch(c.name){case "SceneNode":this.setOutputData(b,a);break;case "Material":this.setOutputData(b,a.getMaterial());break;case "Transform":this.setOutputData(b,a.transform);break;case "Name":this.setOutputData(b,a.name);break;case "Children":this.setOutputData(b,a.children);break;case "UID":this.setOutputData(b,a.uid);break;case "Mesh":this.setOutputData(b,a.getMesh());break;case "Visible":this.setOutputData(b,a.flags.visible);break;default:d=a.getComponentByUId(c.name);
if(!d){var f=a.scene.findComponentByUId(c.name);f&&(d=e.getObjectClassName(f),d=a.getComponent(d))&&(c.name=d.uid)}this.setOutputData(b,d)}}},LGraphSceneNode.prototype.getComponents=function(a){a=a||[];var b=this.getNode();if(!b)return a;b=b.getComponents();if(!b)return a;for(var c=0;c<b.length;++c){var d=e.getClassName(b[c].constructor);a.push([b[c].uid,d,{label:d}])}return a},LGraphSceneNode.prototype.onDropItem=function(a){if(a=a.dataTransfer.getData("node_uid"))return this.properties.node_id=
a,this.onExecute(),!0},LGraphSceneNode.prototype.onPropertyChanged=function(a,b){"node_id"==a&&this.getNode()},LGraphSceneNode.prototype.bindNodeEvents=function(a){this._node&&LEvent.unbindAll(this._node,this);if((this._node=a)&&this.outputs&&this.outputs.length)for(a=0;a<this.outputs.length;++a){var b=this.outputs[a];b.type===LiteGraph.EVENT&&(b=b.name.substr(3),LEvent.bind(this._node,b,this.onNodeEvent,this))}},LGraphSceneNode.prototype.onNodeEvent=function(a,b){this.trigger("on_"+a,b)},LGraphSceneNode.prototype.onGetInputs=
function(){return this.getComponents([["Visible","boolean"],["UID","string"],["SceneNode","SceneNode"],["Material","Material"]])},LGraphSceneNode.prototype.onGetOutputs=function(){return this.getComponents([["SceneNode","SceneNode"],["Visible","boolean"],["Material","Material"],["Name","string"],["UID","string"],["Children","scenenode[]"],["on_clicked",LiteGraph.EVENT]])},LiteGraph.registerNodeType("scene/node",LGraphSceneNode),Y.LGraphComponent=function(){this.properties={node_id:"",component_id:""};
this._component=null},LGraphComponent.title="Component",LGraphComponent.desc="A component from a node",LGraphComponent.prototype.onRemoved=function(){this.bindComponentEvents(null)},LGraphComponent.prototype.onConnectionsChange=function(a){this.bindComponentEvents(this._component)},LGraphComponent.prototype.onInit=function(){var a=this.getComponent();a&&this.processOutputs(a)},LGraphComponent.prototype.processOutputs=function(a){if(this.outputs&&this.outputs.length)for(var b=0;b<this.outputs.length;b++){var c=
this.outputs[b];c.links&&c.links.length&&c.type!=LiteGraph.EVENT&&("Component"==c.name?this.setOutputData(b,a):this.setOutputData(b,a[c.name]))}},LGraphComponent.prototype.onExecute=function(){var a=this.getComponent();if(a){if(this.inputs)for(var b=0;b<this.inputs.length;b++){var c=this.inputs[b];if(c.type!==LiteGraph.ACTION){var d=this.getInputData(b);void 0!==d&&e.setObjectProperty(a,c.name,d)}}this.processOutputs(a)}},LGraphComponent.updateOutputData=function(a){if(this.outputs&&!(a>=this.outputs.length)){var b=
this.outputs[Jb];if(b.links&&b.links.length&&b.type!=LiteGraph.EVENT){var c=this.getComponent();c&&("Component"==b.name?this.setOutputData(a,c):this.setOutputData(a,c[b.name]))}}},LGraphComponent.prototype.onDrawBackground=function(){var a=this.getComponent();a&&(this.title=e.getClassName(a.constructor))},LGraphComponent.prototype.onConnectionsChange=function(a,b,c,d,f){a==LiteGraph.INPUT&&f&&"Component"==f.name&&(a=this.getInputNode(b))&&a.onExecute&&(a.onExecute(),this.setDirtyCanvas(!0,!0))},LGraphComponent.prototype.getComponent=
function(){var a=this.graph._scene;if(!a)return null;var b=this.properties.node_id;if(!b)return this.inputs&&this.inputs.length&&(a=this.findInputSlot("Component"),-1!=a)?(a=this.getInputData(a))?a:null:null;a=a.getNode(b);if(!a)return null;var b=this.properties.component_id,c=null;if("@"==b.charAt(0))c=a.getComponentByUId(b);else if(e.Components[b])c=a.getComponent(e.Components[b]);else return null;if(c&&!c.constructor.is_component)return null;this._component!=c&&this.bindComponentEvents(c);return this._component=
c},LGraphComponent.prototype.bindComponentEvents=function(a){this._component&&LEvent.unbindAll(this._component,this);if((this._component=a)&&this.outputs&&this.outputs.length)for(a=0;a<this.outputs.length;++a){var b=this.outputs[a];b.type===LiteGraph.EVENT&&(b=b.name.substr(3),LEvent.bind(this._component,b,this.onComponentEvent,this))}},LGraphComponent.prototype.onComponentEvent=function(a,b){this.trigger("on_"+a,b)},LGraphComponent.prototype.getComponentProperties=function(a,b){var c=this.getComponent();
if(!c)return null;var d=null,d=c.getPropertiesInfo?c.getPropertiesInfo(a):e.getObjectProperties(c);b=b||[];for(var f in d)b.push([f,d[f]]);return b},LGraphComponent.prototype.onAction=function(a,b){if(a){var c=this.getComponent();if(c)if(c.onAction)c.onAction(a,b);else if(c[a])c[a]()}},LGraphComponent.prototype.onSetValue=function(a,b){var c=this.getComponent();if(c){var d=c[a],f;if(null==d)b&&b.constructor===String&&(f=b);else switch(d.constructor){case Number:f=Number(b);break;case Boolean:f="true"==
b||"1"==b;break;case String:f=String(b);break;case Array:case Float32Array:f=null!=b?b.constructor===String?JSON.parse("["+b+"]"):b.constructor===Number?[b]:b:b}void 0!==f&&(c.setPropertyValue?c.setPropertyValue(a,f):c[a]=f)}},LGraphComponent.prototype.onGetInputs=function(){var a=[["Node",0],["Component",0],null];this.getComponentProperties("input",a);var b=this.getComponent();if(b&&b.getActions&&(b=b.getActions({})))if(b.constructor===Array)for(var c=0;c<b.length;++c)a.push([b[c],LiteGraph.ACTION]);
else for(c in b)a.push([c,LiteGraph.ACTION]);return a},LGraphComponent.prototype.onGetOutputs=function(){var a=[];a.push(["Component","Component"],null);this.getComponentProperties("output",a);var b=this.getComponent();if(b&&b.getEvents&&(b=b.getEvents()))if(b.constructor===Array)for(var c=0;c<b.length;++c)a.push(["on_"+b[c],LiteGraph.EVENT]);else for(c in b)a.push(["on_"+c,LiteGraph.EVENT]);return a},LiteGraph.registerNodeType("scene/component",LGraphComponent),Y.LGraphTransform=function(){this.properties=
{node_id:""};LGraphSceneNode._current_node_id&&(this.properties.node_id=LGraphSceneNode._current_node_id);this.addInput("Transform","Transform",{locked:!0});this.addOutput("Position","vec3")},LGraphTransform.title="Transform",LGraphTransform.desc="Transform info of a node",LGraphTransform.prototype.onExecute=function(){var a=null;this.inputs&&this.inputs[0]&&(a=this.getInputData(0));if(!a){a=this.graph.getScene();if(!a)return;var b=this._node;if(this.properties.node_id&&(b=a.getNode(this.properties.node_id),
!b))return;b||(b=this.graph._scenenode);a=b.transform}if(a){if(this.inputs)for(b=1;b<this.inputs.length;++b){var c=this.inputs[b],d=this.getInputData(b);if(void 0!==d)switch(c.name){case "x":a.x=d;break;case "y":a.y=d;break;case "z":a.z=d;break;case "Position":a.setPosition(d);break;case "Rotation":a.setRotation(d);break;case "Scale":a.setScale(d);break;case "Matrix":a.fromMatrix(d);break;case "Mult.Matrix":a.applyTransformMatrix(d);break;case "Translate":a.translate(d);break;case "Translate Global":a.translateGlobal(d);
break;case "Rotate":quat.multiply(a._rotation,a._rotation,d);a._must_update=!0;break;case "RotateX":a.rotateX(d);break;case "RotateY":a.rotateY(d);break;case "RotateZ":a.rotateZ(d)}}if(this.outputs)for(b=0;b<this.outputs.length;++b)if(c=this.outputs[b],c.links&&c.links.length){d=void 0;switch(c.name){case "x":d=a.x;break;case "y":d=a.y;break;case "z":d=a.z;break;case "Position":d=a.position;break;case "Global Position":d=a.getGlobalPosition();break;case "Rotation":d=a.rotation;break;case "Global Rotation":d=
a.getGlobalRotation();break;case "Scale":d=a.scaling;break;case "Matrix":d=a.getMatrix()}void 0!==d&&this.setOutputData(b,d)}}},LGraphTransform.prototype.onGetInputs=function(){return[["Position","vec3"],["Rotation","quat"],["Scale","number"],["x","number"],["y","number"],["z","number"],["Global Position","vec3"],["Global Rotation","quat"],["Matrix","mat4"],["Mult.Matrix","mat4"],["Translate","vec3"],["Translate Global","vec3"],["Rotate","quat"],["RotateX","number"],["RotateY","number"],["RotateZ",
"number"]]},LGraphTransform.prototype.onGetOutputs=function(){return[["Position","vec3"],["Rotation","quat"],["Scale","number"],["x","number"],["y","number"],["z","number"],["Global Position","vec3"],["Global Rotation","quat"],["Matrix","mat4"]]},LiteGraph.registerNodeType("scene/transform",LGraphTransform),Y.LGraphMaterial=function(){this.properties={material_id:"",node_id:""};this.addInput("Material","Material");this.size=[100,20]},LGraphMaterial.title="Material",LGraphMaterial.desc="Material of a node",
LGraphMaterial.prototype.onExecute=function(){var a=this.getMaterial();if(a){for(var b=0;b<this.inputs.length;++b){var c=this.inputs[b],d=this.getInputData(b);void 0!==d&&"Material"!=c.name&&a.setProperty(c.name,d)}if(this.outputs)for(b=0;b<this.outputs.length;++b)c=this.outputs[b],c.links&&c.links.length&&(d=a.getProperty(c.name),this.setOutputData(b,d))}},LGraphMaterial.prototype.getMaterial=function(){var a=this.findInputSlot("Material");return-1!=a?this.getInputData(a):this.properties.material_id&&
e.RM.materials[this.properties.material_id]?e.RM.materials[this.properties.material_id]:this.properties.node_id&&(a=this.graph.getScene().getNode(this.properties.node_id))?a.getMaterial():null},LGraphMaterial.prototype.onGetInputs=function(){var a=this.getMaterial();if(a){var a=a.getPropertiesInfo(),b=[["Material","Material"]],c;for(c in a)b.push([c,a[c]]);return b}},LGraphMaterial.prototype.onGetOutputs=function(){var a=this.getMaterial();if(a){var a=a.getPropertiesInfo(),b=[["Material","Material"]],
c;for(c in a)b.push([c,a[c]]);return b}},LiteGraph.registerNodeType("scene/material",LGraphMaterial),Y.LGraphMaterial=LGraphMaterial,Y.LGraphGlobal=function(){this.addOutput("Value");this.properties={name:"myvar",value:0,type:"number",widget:"default",min:0,max:1}},LGraphGlobal.title="Global",LGraphGlobal.desc="Global var for the graph",LGraphGlobal["@type"]={type:"enum",values:"number boolean string node vec2 vec3 vec4 color texture".split(" ")},LGraphGlobal["@widget"]={type:"enum",values:["default",
"slider","pad"]},LGraphGlobal.prototype.onExecute=function(){this.properties.name&&this.setOutputData(0,this.properties.value)},LGraphGlobal.prototype.onDrawBackground=function(){this.outputs[0].label=this.properties.name},LiteGraph.registerNodeType("scene/global",LGraphGlobal),Y.LGraphSceneTime=function(){this.addOutput("Time","number");this._scene=null},LGraphSceneTime.title="Time",LGraphSceneTime.desc="Time",LGraphSceneTime.prototype.onExecute=function(){var a=this.graph.getScene();if(a){if(this.inputs)for(var b=
0;b<this.inputs.length;++b)this.getInputData(b);if(this.outputs)for(b=0;b<this.outputs.length;++b){var c=this.outputs[b];if(c.links&&c.links.length&&c.type!=LiteGraph.EVENT){var d=null;switch(c.name){case "Time":d=a.getTime();break;case "Elapsed":d=null!=a._last_dt?a._last_dt:0;break;case "Frame":d=null!=a._frame?a._frame:0;break;default:continue}this.setOutputData(b,d)}}}},LGraphSceneTime.prototype.onGetOutputs=function(){return[["Elapsed","number"],["Time","number"]]},LiteGraph.registerNodeType("scene/time",
LGraphSceneTime),Y.LGraphLocatorProperty=function(){this.addInput("in");this.addOutput("out");this.size=[80,20];this.properties={locator:""}},LGraphLocatorProperty.title="Property",LGraphLocatorProperty.desc="A property of a node or component of the scene specified by its locator string",LGraphLocatorProperty.prototype.getLocatorInfo=function(){var a=this.properties.locator;if(this.properties.locator)return this._locator_info=(this.graph._scene||e.GlobalScene).getPropertyInfo(a)},LGraphLocatorProperty.prototype.onAction=
function(a,b){var c=this.getLocatorInfo();Ba.setFromInfo(c,!Ba.getFromInfo(c))},LGraphLocatorProperty.prototype.onExecute=function(){var a=this.getLocatorInfo();a&&a.target&&(this.title=a.name,this.inputs.length&&null!==this.inputs[0].link&&Ba.setFromInfo(a,this.getInputData(0)),this.outputs.length&&this.outputs[0].links&&this.outputs[0].links.length&&this.setOutputData(0,Ba.getFromInfo(a)))},LiteGraph.registerNodeType("scene/property",LGraphLocatorProperty),Y.LGraphToggleValue=function(){this.addInput("target",
"Component");this.addInput("toggle",LiteGraph.ACTION);this.properties={property_name:"enabled"}},LGraphToggleValue.title="Toggle",LGraphToggleValue.desc="Toggle a property value",LGraphToggleValue.prototype.getTitle=function(){return"Toggle: "+this.properties.property_name},LGraphToggleValue.prototype.onAction=function(a,b){var c=this.getInputData(0,!0);if(c){var d=this.properties.property_name||"enabled";void 0!==c[d]&&(c[d]=!c[d])}},LiteGraph.registerNodeType("scene/toggle",LGraphToggleValue),Y.LGraphFrame=
function(){this.addOutput("Color","Texture");this.addOutput("Depth","Texture");this.addOutput("Extra","Texture");this.addOutput("Camera","Camera");this.properties={}},LGraphFrame.title="Frame",LGraphFrame.desc="One frame rendered from the scene renderer",LGraphFrame.prototype.onExecute=function(){this.setOutputData(0,LGraphTexture.getTexture(this._color_texture));this.setOutputData(1,LGraphTexture.getTexture(this._depth_texture));this.setOutputData(2,LGraphTexture.getTexture(this._extra_texture));
this.setOutputData(3,this._camera)},LGraphFrame.prototype.onDrawBackground=function(a){if(!(this.flags.collapsed||20>=this.size[1])&&this._color_texture&&a.webgl){if(this._last_preview_tex!=this._last_tex||!this._last_preview_tex)if(a.webgl&&this._canvas&&this._canvas.constructor===GL.Texture)this._canvas=this._last_tex;else{var b=LGraphTexture.getTexture(this._color_texture);if(!b)return;b=LGraphTexture.generateLowResTexturePreview(b);if(!b)return;this._last_preview_tex=this._last_tex;this._canvas=
cloneCanvas(b)}if(this._canvas){a.save();if(!a.webgl){if(this._canvas.constructor===GL.Texture){this._canvas=null;return}a.translate(0,this.size[1]);a.scale(1,-1)}a.drawImage(this._canvas,0,0,this.size[0],this.size[1]);a.restore()}}},LiteGraph.registerNodeType("scene/frame",LGraphFrame));"undefined"!=typeof LiteGraph&&(Y.LGraphSetValue=function(){this.properties={property_name:"",value:"",type:"String"};this.addInput("on_set",LiteGraph.ACTION);this.addOutput("on",LiteGraph.EVENT);this.addOutput("node",
0);this.mode=LiteGraph.ON_TRIGGER},LGraphSetValue.prototype.onAction=function(a,b){if(this.properties.property_name){var c=this.getOutputNodes(1);if(c){for(var d=0;d<c.length;++d){var f=c[d];if(f.onSetValue)f.onSetValue(this.properties.property_name,this.properties.value)}this.trigger("on")}}},LGraphSetValue.title="SetValue",LGraphSetValue.desc="sets a value to a node",LiteGraph.registerNodeType("logic/setValue",LGraphSetValue));if("undefined"!=typeof LiteGraph){var Qb=!1;"undefined"==typeof LGraphTexture?
console.error("LiteGraph found but no LGraphTexture, this means LiteGL wasnt not included BEFORE litegraph. Be sure to include LiteGL before LiteGraph to ensure all functionalities."):Qb=!0;var db=function(){this.addInput("Color","Texture");this.addInput("Depth","Texture");this.addInput("Intensity","number");this.addOutput("Final","Texture");this.properties={intensity:1,preserve_aspect:!0};this._fx_stack=new e.FXStack;this._fx_options={}};db.title="FXStack";db.desc="Apply FXs to Texture";db.prototype.onExecute=
function(){var a=this.getInputData(0);if(a&&this.isOutputConnected(0)){var b=this._final_texture;b&&b.width==a.width&&b.height==a.height&&b.type==a.type||(this._final_texture=new GL.Texture(a.width,a.height,{type:a.type,format:gl.RGBA,filter:gl.LINEAR}));this.isInputConnected(1)&&(this._fx_options.depth_texture=this.getInputData(1));b=this.properties.intensity;this.isInputConnected(2)&&(b=this.getInputData(2),this.properties.intensity=b);this._fx_stack.applyFX(a,this._final_texture,this._fx_options);
this.setOutputData(0,this._final_texture)}};db.prototype.inspect=function(a){return this._fx_stack.inspect(a)};db.prototype.getResources=function(a){return this._fx_stack.getResources(a)};db.prototype.onSerialize=function(a){a.stack=this._fx_stack.serialize()};db.prototype.onConfigure=function(a){a.stack&&this._fx_stack.configure(a.stack)};LiteGraph.registerNodeType("texture/fxstack",db);var Oa=function(){this.addInput("color","Texture");this.addInput("depth","Texture");this.addInput("camera","Camera");
this.addOutput("out","Texture");this.properties={enabled:!0,intensity:1,ghosting_mitigation:!0,ghosting_threshold:0.4,freeze_camera:!1,precision:LGraphTexture.DEFAULT};this._inv_matrix=mat4.create();this._previous_viewprojection_matrix=mat4.create();this._uniforms={u_color_texture:0,u_depth_texture:1,u_inv_vp:this._inv_matrix,u_intensity:1,u_camera_planes:null,u_viewprojection_matrix:null,u_previous_viewprojection_matrix:this._previous_viewprojection_matrix}};Oa.widgets_info={precision:{widget:"combo",
values:Qb?LGraphTexture.MODE_VALUES:[]}};Oa.title="Camera Motion Blur";Oa.desc="A motion blur but only for camera movement";Oa.prototype.onExecute=function(){var a=this.getInputData(0),b=this.getInputData(1),c=this.getInputData(2);if(this.isOutputConnected(0)&&a&&b&&c){var d=this.getInputData(3);null!=d&&(this.properties.enabled=Boolean(d));if(this.properties.precision===LGraphTexture.PASS_THROUGH||!1===this.properties.enabled)this.setOutputData(0,a);else{var d=a.width,f=a.height,e=this.precision===
LGraphTexture.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT;this.precision===LGraphTexture.DEFAULT&&(e=a.type);this._tex&&this._tex.width==d&&this._tex.height==f&&this._tex.type==e||(this._tex=new GL.Texture(d,f,{type:e,format:gl.RGBA,filter:gl.LINEAR}));Oa._shader||(Oa._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,Oa.pixel_shader),Oa._shader_no_ghosting=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,Oa.pixel_shader,{GHOST_CORRECTION:""}));var g=this.properties.ghosting_mitigation?Oa._shader_no_ghosting:
Oa._shader,d=this._inv_matrix,f=c._viewprojection_matrix,e=this._previous_viewprojection_matrix,k=this._uniforms;k.u_intensity=this.properties.intensity;k.u_viewprojection_matrix=c._viewprojection_matrix;k.u_camera_planes=c._uniforms.u_camera_planes;k.u_ghosting_threshold=this.properties.ghosting_threshold||0.4;for(var m=0,l=0;l<e.length;++l)m+=Math.abs(f[l]-e[l]);mat4.invert(d,c._viewprojection_matrix);this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);
a.bind(0);b.bind(1);var c=Mesh.getScreenQuad();g.uniforms(k).draw(c)});this.properties.freeze_camera||e.set(c._viewprojection_matrix);this.setOutputData(0,this._tex)}}};Oa.prototype.onGetInputs=function(){return[["enabled","boolean"]]};Oa.pixel_shader="precision highp float;\n\t\t\n\t\tuniform sampler2D u_color_texture;\n\t\tuniform sampler2D u_depth_texture;\n\t\tvarying vec2 v_coord;\n\t\tuniform mat4 u_inv_vp;\n\t\tuniform mat4 u_viewprojection_matrix;\n\t\tuniform mat4 u_previous_viewprojection_matrix;\n\t\tuniform vec2 u_camera_planes;\n\t\tuniform float u_intensity;\n\t\tuniform float u_ghosting_threshold;\n\t\t#define SAMPLES 16\n\t\t\n\t\tvoid main() {\n\t\t\tvec2 uv = v_coord;\n\t\t\tfloat depth = texture2D(u_depth_texture, uv).x;\n\t\t\tfloat zNear = u_camera_planes.x;\n\t\t\tfloat zFar = u_camera_planes.y;\n\t\t\t//float z = (2.0 * zNear) / (zFar + zNear - depth * (zFar - zNear));\n\t\t\tdepth = depth * 2.0 - 1.0;\n\t\t\tfloat z = zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));\n\t\t\tvec4 screenpos = vec4( uv * 2.0 - vec2(1.0), depth, 1.0 );\n\t\t\tvec4 pos = u_inv_vp * screenpos;\n\t\t\tpos /= pos.w;\n\t\t\tvec4 old_screenpos = u_previous_viewprojection_matrix * pos;\n\t\t\told_screenpos /= old_screenpos.w;\n\t\t\tvec2 uv_final = old_screenpos.xy * 0.5 + vec2(0.5);\n\t\t\tvec2 uv_delta = (uv_final - uv);\n\t\t\tuv -= uv_delta * 0.5;\n\t\t\t//uv_delta *= 1.0 - z;\n\t\t\tuv_delta *= u_intensity / float(SAMPLES);\n\t\t\tvec4 color = vec4(0.0);\n\t\t\tfloat total = 0.0;\n\t\t\tfloat amount = 1.0;\n\t\t\tfor(int i = 0; i < SAMPLES; ++i)\n\t\t\t{\n\t\t\t\t#ifdef GHOST_CORRECTION\n\t\t\t\t\tfloat old_depth = texture2D(u_depth_texture, uv).x;\n\t\t\t\t\told_depth = old_depth * 2.0 - 1.0;\n\t\t\t\t\tfloat old_z = zNear * (old_depth + 1.0) / (zFar + zNear - old_depth * (zFar - zNear));\n\t\t\t\t\tif( abs(old_z - z) > u_ghosting_threshold )\n\t\t\t\t\t{\n\t\t\t\t\t\tuv += uv_delta;\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\tcolor += texture2D( u_color_texture, uv );\n\t\t\t\tuv += uv_delta;\n\t\t\t\ttotal += amount;\n\t\t\t}\n\t\t\tgl_FragColor = color / total;\n\t\t\t//gl_FragColor = vec4( abs( old_screenpos.xy ), 1.0, 1.0 );\n\t\t\t//gl_FragColor = texture2D( u_color_texture, uv_final );\n\t\t\t//gl_FragColor = vec4( abs( pos.xyz * 0.001 ), 1.0 );\n\t\t\t//gl_FragColor = vec4( vec3( abs(old_z - z) ), 1.0);\n\t\t}\n\t\t";
LiteGraph.registerNodeType("texture/motionBlur",Oa)}if("undefined"!=typeof LiteGraph){var ha=function(){this.addInput("text");this.properties={text:"",font:"",color:[1,1,1,1],position:[20,20],corner:ha.CORNER_TOP_LEFT}};ha.title="GUIText";ha.desc="renders text on webgl canvas";ha.priority=2;ha.CORNER_TOP_LEFT=0;ha.CORNER_TOP_RIGHT=1;ha.CORNER_BOTTOM_LEFT=2;ha.CORNER_BOTTOM_RIGHT=3;ha.CORNER_TOP_CENTER=4;ha.CORNER_BOTTOM_CENTER=5;ha["@corner"]={type:"enum",values:{"top-left":ha.CORNER_TOP_LEFT,"top-right":ha.CORNER_TOP_RIGHT,
"bottom-left":ha.CORNER_BOTTOM_LEFT,"bottom-right":ha.CORNER_BOTTOM_RIGHT,"top-center":ha.CORNER_TOP_CENTER,"bottom-center":ha.CORNER_BOTTOM_CENTER}};ha["@color"]={type:"color"};ha.prototype.onGetInputs=function(){return[["enabled","boolean"]]};ha.prototype.onExecute=function(){var a=window.gl;if(a&&window.LS&&e.Renderer._current_render_settings&&e.Renderer._current_render_settings.render_gui&&!1!==this.getInputData(1)){var b=this.getInputData(0);null==b&&(b="");b.constructor===Number&&(b=b.toFixed(3));
b=(this.properties.text||"")+b;if(""!==b){a.font=this.properties.font||"20px Arial";a.fillColor=this.properties.color||[1,1,1,1];var c=this.properties.position[0],d=this.properties.position[1];switch(this.properties.corner){case ha.CORNER_TOP_RIGHT:c=gl.canvas.width-c;break;case ha.CORNER_BOTTOM_LEFT:d=gl.canvas.height-d;break;case ha.CORNER_BOTTOM_RIGHT:c=gl.canvas.width-c;d=gl.canvas.height-d;break;case ha.CORNER_TOP_CENTER:c=0.5*gl.canvas.width;break;case ha.CORNER_BOTTOM_CENTER:c=0.5*gl.canvas.width,
d=gl.canvas.height-d}gl.disable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);a.fillText(b,c,d)}}};LiteGraph.registerNodeType("gui/text",ha)}if("undefined"!=typeof LiteGraph){var Ya=LiteGraph.getInputLinkID=function(a,b){var c=a.getInputInfo(b);return c&&-1!=c.link?(c=a.graph.links[c.link])?"LINK_"+c.origin_id+"_"+c.origin_slot:null:null},Za=LiteGraph.getOutputLinkID=function(a,b,c){var d=a.getOutputInfo(b);return d&&d.links&&d.links.length||c?"LINK_"+a.id+"_"+
b:null};LiteGraph.registerShaderNode=function(a,b){b.filter="shader";b.color="#2a363b";b.bgcolor="#3f4a4e";b.title_text_color="#AAA";LiteGraph.registerNodeType("shader/"+a,b)};var Kb={number:"float",color:"vec3",color4:"vec4"};LiteGraph.generatePreviewShader=function(a){for(var b=a.graph.getAncestors(a),c={uniforms:[]},d="",b=this._graph._nodes_in_order,f=0;f<b.length;++f)a=b[f],a.onGetCode&&(d+=a.onGetCode("glsl",c));for(f=0;f<c.uniforms.length;++f);};var eb=function(a,b){var c=a,d;d='this.addOutput("v","'+
a+'");\n'+("this.properties = { value: "+JSON.stringify(b)+', uniform:""};\n');d=new Function(d);a=Kb[a]||a;var f;f='if( lang != "glsl" ) return "";\nvar output = LiteGraph.getOutputLinkID( this, 0, true );\n'+('if(this.properties.uniform)\n \t{ context.uniforms.push({ name: this.properties.uniform, link_name: output, type: "'+a+'", value: this.properties.value });\n return "";\t}');f+='return "\\t '+a+' "+output+" = '+a+'("+String(this.properties.value)+");\\n";\n';d.prototype.onGetCode=new Function("lang",
"context",f);LiteGraph.registerShaderNode(c.toLowerCase(),d);d.title=c;d.desc="Shader constant "+c;d.prototype.getTitle=function(){return this.flags.collapsed?String(this.properties.value):this.title};d.prototype.onDrawBackground=function(){5>this.properties.value.length&&(this.outputs[0].label=String(this.properties.value))};return d};eb("number",1);eb("vec2",[0,0]);eb("vec3",[0,0,0]);eb("color",[1,1,1]);eb("vec4",[0,0,0,0]);eb("color4",[1,1,1,1]);eb("mat3",[1,0,0,0,1,0,0,0,1]);eb("mat4",[1,0,0,
0,0,1,0,0,0,0,1,0,0,0,0,1]);var Ta=function(a,b,c,d){if(10<=b.length)throw"cannot be used with more than 10 vars, regexp not supporting it";for(var f='this.addOutput("v","'+c+'");\n',e=0;e<b.length;++e)f+='this.addInput("'+String.fromCharCode(65+e)+'","'+b[e]+'");\n';var f=new Function(f),g;g='\tif( lang != "glsl" ) return "";\n\tvar code = "";\n';for(e=0;e<b.length;++e){var k=Kb[b[e]]||b[e];g+="var input_"+e+" = LiteGraph.getInputLinkID( this, "+e+" );\n";g+="if(input_"+e+" == null) input_"+e+' = "'+
k+'(1.0)";\n';d=d.replace(RegExp("@"+e,"gi"),'" + input_'+e+' + "')}g=g+"\tvar output = LiteGraph.getOutputLinkID(this, 0, true);\n"+('\treturn "\\t  '+(Kb[c]||c)+' "+output+" = '+d+';\\n";\n');f.prototype.onGetCode=new Function("lang",g);f.title=a;f.filter="shader";LiteGraph.registerShaderNode(a.toLowerCase(),f);return f};Ta("Add Float",["number","number"],"number","@0 + @1").title="A+B";Ta("Add Vec3",["vec3","vec3"],"vec3","@0 + @1");Ta("Sub Vec3",["vec3","vec3"],"vec3","@0 - @1");Ta("Sub Float",
["number","number"],"number","@0 - @1").title="A-B";Ta("Normalize Vec2",["vec2"],"vec2","normalize(@0)");Ta("Normalize Vec3",["vec3"],"vec3","normalize(@0)");Ta("Exp Float",["number"],"number","exp(@0)");Ta("Pow Float",["number","number"],"number","pow(@0,@1)");Ta("Pow Vec3",["vec3","number"],"vec3","pow(@0,@1)");Ta("Float->Vec3",["number"],"vec3","vec3(@0)");Ta("Dot",["vec3","vec3"],"number","dot(@0,@1)");var qb=function(){this.addInput("Albedo","vec3");this.addInput("Emission","vec3");this.addInput("Normal",
"vec3");this.addInput("Specular","number");this.addInput("Gloss","number");this.addInput("Reflectivity","number");this.addInput("Alpha","number");this.size=[90,110];this.properties={}};qb.title="Surface";qb.desc="Surface properties";qb.prototype.onExecute=function(){};qb.prototype.onGetCode=function(a){if("glsl"!=a)return"";a="\n";var b=Ya(this,0);b&&(a+="\t o.Albedo = "+b+";\n");(b=Ya(this,1))&&(a+="\t o.Emission = "+b+";\n");(b=Ya(this,2))&&(a+="\t o.Normal = "+b+";\n");(b=Ya(this,3))&&(a+="\t o.Specular = "+
b+";\n");(b=Ya(this,4))&&(a+="\t o.Gloss = "+b+";\n");(b=Ya(this,5))&&(a+="\t o.Reflectivity = "+b+";\n");(b=Ya(this,6))&&(a+="\t o.Alpha = "+b+";\n");return a};LiteGraph.registerShaderNode("surface",qb);var rb=function(){this.addInput("in","vec3");this.addInput("f","number");this.addOutput("out","vec3")};rb.title="Scale";rb.desc="Multiply by number";rb.filter="shader";rb.prototype.onGetCode=function(a){if("glsl"!=a)return"";a=Ya(this,0);var b=Ya(this,1),c=Za(this,0);return a&&b&&c?"vec3 "+c+" = "+
a+" * "+b+";\n":""};LiteGraph.registerShaderNode("scale",rb);var yb=function(){this.addOutput("position","vec3");this.addOutput("local_position","vec3");this.addOutput("normal","vec3");this.addOutput("local_normal","vec3");this.addOutput("uv","vec2");this.addOutput("screen","vec4");this.addOutput("viewDir","vec3");this.addOutput("camPos","vec3");this.size=[97,126]};yb.title="Vertex";yb.desc="Reads info from vertex shader";yb.prototype.onGetCode=function(a,b){if("glsl"!=a)return"";var c="",d=Za(this,
0);d&&(c+="\t vec3 "+d+" = IN.worldPos;\n");(d=Za(this,1))&&(c+="\t vec3 "+d+" = IN.vertex;\n");(d=Za(this,2))&&(c+="\t vec3 "+d+" = IN.worldNormal;\n");(d=Za(this,3))&&(c+="\t vec3 "+d+" = IN.normal;\n");(d=Za(this,4))&&(c+="\t vec2 "+d+" = IN.uv;\n");(d=Za(this,5))&&(c+="\t vec4 "+d+" = IN.screenPos;\n");(d=Za(this,6))&&(c+="\t vec3 "+d+" = IN.viewDir;\n");(d=Za(this,7))&&(c+="\t vec3 "+d+" = IN.camPos;\n");return c};LiteGraph.registerShaderNode("vertex",yb)}Da.LINE=1;Da.SPLINE=2;Da.BEZIER=3;Da.prototype.addPoint=
function(a){var b=vec3.create();b[0]=a[0];b[1]=a[1];2<a.length&&(b[2]=a[2]);this.points.push(b)};Da.prototype.getSegments=function(){var a=this.points.length;switch(this.type){case Da.LINE:if(2>a)break;return a-1;case Da.SPLINE:if(3>a)break;return(a-1)/3|0}return 0};Da.prototype.computePoint=function(a,b){switch(this.type){case Da.LINE:return this.getLinearPoint(a,b);default:return this.getSplinePoint(a,b)}};Da.prototype.getLinearPoint=function(a,b){b=b||vec3.create();var c=this.points.length;if(2>
c)return b;if(0>=a)return vec3.copy(b,this.points[0]);if(1<=a)return vec3.copy(b,this.points[c-1]);var c=(c-1)*a,d=c|0;return vec3.lerp(b,this.points[d],this.points[d+1],c-d)};Da.prototype.getSplinePoint=function(a,b){b=b||vec3.create();var c=this.points.length;if(4>c)return b;c=3*((c-1)/3|0)+1;if(0>=a)return vec3.copy(b,this.points[0]);if(1<=a)return vec3.copy(b,this.points[c-1]);var c=(c-1)/3*a,d=c|0,f=c-d,c=this.points[d],e=this.points[d+1],g=this.points[d+2],d=this.points[d+3],k=(1-f)*(1-f)*(1-
f),m=3*f*(1-f)*(1-f),l=3*f*f*(1-f),f=f*f*f;b[0]=c[0]*k+e[0]*m+g[0]*l+d[0]*f;b[1]=c[1]*k+e[1]*m+g[1]*l+d[1]*f;b[2]=c[2]*k+e[2]*m+g[2]*l+d[2]*f;return b};Da.prototype.samplePoints=function(a){0>=a&&(a=this.getSegments(),a=this.type==e.Path.LINE?a+1:20*a);for(var b=Array(a),c=0;c<a;c++)b[c]=this.computePoint(c/(a-1));return b};Da.prototype.samplePointsTyped=function(a,b){b&&b.length<3*a&&(a=Math.floor(b.length/3));if(0>=a){var c=this.getSegments();a=this.type==e.Path.LINE?c+1:20*c}b=b||new Float32Array(3*
a);for(c=0;c<a;c++)this.computePoint(c/(a-1),b.subarray(3*c,3*c+3));return b};Da.prototype.serialize=function(){for(var a={},b=Array(3*this.points.length),c=0;c<this.points.length;c++){var d=this.points[c];b[3*c]=d[0];b[3*c+1]=d[1];b[3*c+2]=d[2]}a.points=b;a.type=this.type;a.closed=this.closed;return a};Da.prototype.configure=function(a){this.type=a.type;this.closed=a.closed;if(a.points){this.points.length=a.points.length/3;a=a.points;for(var b=0;b<this.points.length;b++)this.points[b]=vec3.fromValues(a[3*
b],a[3*b+1],a[3*b+2])}};e.Path=Da;X.available_fx={brightness_contrast:{name:"Brightness & Contrast",uniforms:{brightness:{name:"u_brightness",type:"float",value:1,step:0.01},contrast:{name:"u_contrast",type:"float",value:1,step:0.01}},code:"color.xyz = (color.xyz * u_brightness@ - vec3(0.5)) * u_contrast@ + vec3(0.5);"},hue_saturation:{name:"Hue & Saturation",functions:["HSV"],uniforms:{hue:{name:"u_hue",type:"float",value:0,step:0.01},saturation:{name:"u_saturation",type:"float",value:1,step:0.01},
brightness:{name:"u_brightness",type:"float",value:0,step:0.01}},code:"color.xyz = rgb2hsv(color.xyz); color.xz += vec2(u_hue@,u_brightness@); color.y *= u_saturation@; color.xyz = hsv2rgb(color.xyz);"},invert:{name:"Invert color",code:"color.xyz = vec3(1.0) - color.xyz;"},threshold:{name:"Threshold",uniforms:{threshold:{name:"u_threshold",type:"float",value:0.5,min:0,max:2,step:0.01},threshold_width:{name:"u_threshold_width",type:"float",value:0.01,min:0,max:1,step:0.001}},code:"color.xyz = vec3( smoothstep( u_threshold@ - u_threshold_width@ * 0.5, u_threshold@ + u_threshold_width@ * 0.5,  length(color.xyz) ));"},
colorize:{name:"Colorize",uniforms:{colorize:{name:"u_colorize",type:"color3",value:[1,1,1]},vibrance:{name:"u_vibrance",type:"float",value:0,min:0,max:2,step:0.01}},code:"color.xyz = color.xyz * (u_colorize@ + vec3(u_vibrance@ * 0.1)) * (1.0 + u_vibrance@);"},color_add:{name:"Color add",uniforms:{color_add:{name:"u_coloradd",type:"color3",value:[0.1,0.1,0.1]}},code:"color.xyz = color.xyz + u_coloradd@;"},fog:{name:"fog",uniforms:{fog_color:{name:"u_fog_color",type:"color3",value:[0.1,0.1,0.1]},fog_start:{name:"u_fog_start",
type:"float",value:10},fog_density:{name:"u_fog_density",type:"float",precision:1E-5,value:0.001,step:1E-5}},code:"float z_n@ = 2.0 * texture2D( u_depth_texture, v_coord).x - 1.0;float cam_dist@ = 2.0 * u_depth_range.x * u_depth_range.y / (u_depth_range.y + u_depth_range.x - z_n@ * (u_depth_range.y - u_depth_range.x));float fog_factor@ = 1. - 1.0 / exp(max(0.0,cam_dist@ - u_fog_start@) * u_fog_density@);color.xyz = mix( color.xyz, u_fog_color@, fog_factor@ );"},vigneting:{name:"Vigneting",uniforms:{radius:{name:"u_radius",
type:"float",value:1},intensity:{name:"u_vigneting",type:"float",value:1,min:0,max:2,step:0.01}},code:"color.xyz = mix( color.xyz * max( 1.0 - (dist_to_center * u_radius@ / 0.7071), 0.0), color.xyz, u_vigneting@);"},aberration:{name:"Chromatic Aberration",break_pass:!0,uniforms:{difraction:{name:"u_difraction",type:"float",value:1}},code:"color.x = texture2D(u_texture, uv - to_center * 0.001 * u_difraction@ ).x;color.z = texture2D(u_texture, uv + to_center * 0.001 * u_difraction@ ).z;"},halftone:{name:"Halftone",
uniforms:{"Halftone angle":{name:"u_halftone_angle",type:"float",value:0,step:0.01},"Halftone size":{name:"u_halftone_size",type:"float",value:1,step:0.01}},functions:["pattern"],code:"color.x = ( (color.x * 10.0 - 5.0) + pattern( u_halftone_angle@, u_halftone_size@ ) );color.y = ( (color.y * 10.0 - 5.0) + pattern( u_halftone_angle@ + 0.167, u_halftone_size@ ) );color.z = ( (color.z * 10.0 - 5.0) + pattern( u_halftone_angle@ + 0.333, u_halftone_size@ ) );"},halftoneBN:{name:"Halftone B/N",uniforms:{"Halftone angle":{name:"u_halftone_angle",
type:"float",value:0,step:0.01},"Halftone size":{name:"u_halftone_size",type:"float",value:1,step:0.01}},functions:["pattern"],code:"color.xyz = vec3( (length(color.xyz) * 10.0 - 5.0) + pattern( u_halftone_angle@, u_halftone_size@ ) );"},lens:{name:"Lens Distortion",break_pass:!0,uniforms:{lens_k:{name:"u_lens_k",type:"float",value:-0.15},lens_kcube:{name:"u_lens_kcube",type:"float",value:0.8},lens_scale:{name:"u_lens_scale",type:"float",value:1}},uv_code:"float r2 = u_aspect * u_aspect * (uv.x-0.5) * (uv.x-0.5) + (uv.y-0.5) * (uv.y-0.5); float distort@ = 1. + r2 * (u_lens_k@ + u_lens_kcube@ * sqrt(r2)); uv = vec2( u_lens_scale@ * distort@ * (uv.x-0.5) + 0.5, u_lens_scale@  * distort@ * (uv.y-0.5) + 0.5 );"},
image:{name:"Image",uniforms:{image_texture:{name:"u_image_texture",type:"sampler2D",widget:"Texture",value:""},image_alpha:{name:"u_image_alpha",type:"float",value:1,step:0.001},image_scale:{name:"u_image_scale",type:"vec2",value:[1,1],step:0.001}},code:"vec4 image@ = texture2D( u_image_texture@, (uv - vec2(0.5)) * u_image_scale@ + vec2(0.5)); color.xyz = mix(color.xyz, image@.xyz, image@.a * u_image_alpha@ );"},warp:{name:"Warp",break_pass:!0,uniforms:{warp_amp:{name:"u_warp_amp",type:"float",value:0.01,
step:0.001},warp_offset:{name:"u_warp_offset",type:"vec2",value:[0,0],step:0.001},warp_scale:{name:"u_warp_scale",type:"vec2",value:[1,1],step:0.001},warp_texture:{name:"u_warp_texture",type:"sampler2D",widget:"Texture",value:""}},uv_code:"uv = uv + u_warp_amp@ * (texture2D( u_warp_texture@, uv * u_warp_scale@ + u_warp_offset@ ).xy - vec2(0.5));"},LUT:{name:"LUT",functions:["LUT"],uniforms:{lut_intensity:{name:"u_lut_intensity",type:"float",value:1,step:0.01},lut_texture:{name:"u_lut_texture",type:"sampler2D",
filter:"nearest",wrap:"clamp",widget:"Texture",value:""}},code:"color.xyz = mix(color.xyz, LUT( color.xyz, u_lut_texture@ ), u_lut_intensity@);"},pixelate:{name:"Pixelate",uniforms:{width:{name:"u_width",type:"float",value:256,step:1,min:1},height:{name:"u_height",type:"float",value:256,step:1,min:1}},uv_code:"uv = vec2( floor(uv.x * u_width@) / u_width@, floor(uv.y * u_height@) / u_height@ );"},quantize:{name:"Quantize",uniforms:{levels:{name:"u_levels",type:"float",value:8,step:1,min:1}},code:"color.xyz = floor(color.xyz * u_levels@) / u_levels@;"},
edges:{name:"Edges",break_pass:!0,uniforms:{"Edges factor":{name:"u_edges_factor",type:"float",value:1}},code:"vec4 color@ = texture2D(u_texture, uv );\n\t\t\t\tvec4 color_up@ = texture2D(u_texture, uv + vec2(0., u_iviewport.y));\n\t\t\t\tvec4 color_right@ = texture2D(u_texture, uv + vec2(u_iviewport.x,0.));\n\t\t\t\tvec4 color_down@ = texture2D(u_texture, uv + vec2(0., -u_iviewport.y));\n\t\t\t\tvec4 color_left@ = texture2D(u_texture, uv + vec2(-u_iviewport.x,0.));\n\t\t\t\tcolor = u_edges_factor@ * (abs(color@ - color_up@) + abs(color@ - color_down@) + abs(color@ - color_left@) + abs(color@ - color_right@));"},
depth:{name:"Depth",uniforms:{near:{name:"u_near",type:"float",value:0.01,step:0.1},far:{name:"u_far",type:"float",value:1E3,step:1}},code:"color.xyz = vec3( (2.0 * u_near@) / (u_far@ + u_near@ - texture2D( u_depth_texture, uv ).x * (u_far@ - u_near@)) );"},logarithmic:{name:"Logarithmic",uniforms:{"Log. A Factor":{name:"u_logfactor_a",type:"float",value:2,step:0.01},"Log. B Factor":{name:"u_logfactor_b",type:"float",value:2,step:0.01}},code:"color.xyz = log( color.xyz * u_logfactor_a@ ) * u_logfactor_b@;"},
ditherBN:{name:"dither B/N",functions:["dither"],code:"color.xyz = vec3( dither( color.x ) );"},dither:{name:"Dither",functions:["dither"],code:"color.xyz = vec3( dither( color.x ), dither( color.y ), dither( color.z ) );"},gamma:{name:"Gamma",uniforms:{Gamma:{name:"u_gamma",type:"float",value:2.2,step:0.01}},code:"color.xyz = pow( color.xyz, vec3( 1.0 / u_gamma@) );"},noiseBN:{name:"Noise B&N",functions:["noise"],uniforms:{noise:{name:"u_noise",type:"float",value:0.1,step:0.01}},code:"color.xyz += u_noise@ * vec3( noise( (u_random + v_coord) * u_viewport) );"}};
X.available_functions={pattern:"float pattern(float angle, float size) {\n\t\t\t\tfloat s = sin(angle * 3.1415), c = cos(angle * 3.1415);\n\t\t\t\tvec2 tex = v_coord * u_viewport.xy;\n\t\t\t\tvec2 point = vec2( c * tex.x - s * tex.y , s * tex.x + c * tex.y ) * size;\n\t\t\t\treturn (sin(point.x) * sin(point.y)) * 4.0;\n\t\t\t}\n\t\t",dither:"float dither(float v) {\n\t\t\t\tvec2 pixel = v_coord * u_viewport;\n\t\t\t\tint i = int(floor(clamp(v,0.0,1.0) * 16.0 + 0.5));\n\t\t\t\tif(i < 1)\n\t\t\t\t\treturn 0.0;\n\t\t\t\tif(i >= 15)\n\t\t\t\t\treturn 1.0;\n\t\t\t\tfloat x = floor(pixel.x);\n\t\t\t\tfloat y = floor(pixel.y);\n\t\t\t\tbool xmod4 = mod(x, 4.0) == 0.0;\n\t\t\t\tbool ymod4 = mod(y, 4.0) == 0.0;\n\t\t\t\tbool xmod2 = mod(x, 2.0) == 0.0;\n\t\t\t\tbool ymod2 = mod(y, 2.0) == 0.0;\n\t\t\t\tbool xmod4_2 = mod(x + 2.0, 4.0) == 0.0;\n\t\t\t\tbool ymod4_2 = mod(y + 2.0, 4.0) == 0.0;\n\t\t\t\tbool xmod2_1 = mod(x + 1.0, 2.0) == 0.0;\n\t\t\t\tbool ymod2_1 = mod(y + 1.0, 2.0) == 0.0;\n\t\t\t\tbool xmod4_1 = mod(x + 1.0, 4.0) == 0.0;\n\t\t\t\tbool ymod4_1 = mod(y + 1.0, 4.0) == 0.0;\n\t\t\t\tbool xmod4_3 = mod(x + 3.0, 4.0) == 0.0;\n\t\t\t\tbool ymod4_3 = mod(y + 3.0, 4.0) == 0.0;\n\t\t\t\t\n\t\t\t\tif(i < 9)\n\t\t\t\t{\n\t\t\t\t\tif(i >= 1 && xmod4 && ymod4 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 2 && xmod4_2 && ymod4_2)\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 3 && xmod4_2 && ymod2 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 4 && xmod2 && ymod2 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 5 && xmod4_1 && ymod4_1 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 6 && xmod4_3 && ymod4_3 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 7 && xmod4_1 && ymod4_3 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\tif(i >= 8 && xmod4_3 && ymod4_1 )\n\t\t\t\t\t\treturn 1.0;\n\t\t\t\t\treturn 0.0;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif(i < 15 && xmod4_1 && ymod4 )\n\t\t\t\t\t\treturn 0.0;\n\t\t\t\t\tif(i < 14 && xmod4_3 && ymod4_2)\n\t\t\t\t\t\treturn 0.0;\n\t\t\t\t\tif(i < 13 && xmod4_3 && ymod2 )\n\t\t\t\t\t\treturn 0.0;\n\t\t\t\t\tif(i < 12 && xmod2_1 && ymod2 )\n\t\t\t\t\t\treturn 0.0;\n\t\t\t\t\tif(i < 11 && xmod4_2 && ymod4_1 )\n\t\t\t\t\t\treturn 0.0;\n\t\t\t\t\tif(i < 10 && xmod4 && ymod4_3 )\n\t\t\t\t\t\treturn 0.0;\n\t\t\t\t\treturn 1.0;\n\t\t\t\t}\n\t\t\t}\n\t\t",
LUT:"vec3 LUT(in vec3 color, in sampler2D textureB) {\n\t\t lowp vec3 textureColor = clamp( color, vec3(0.0), vec3(1.0) );\n\t\t mediump float blueColor = textureColor.b * 63.0;\n\t\t mediump vec2 quad1;\n\t\t quad1.y = floor(floor(blueColor) / 8.0);\n\t\t quad1.x = floor(blueColor) - (quad1.y * 8.0);\n\t\t mediump vec2 quad2;\n\t\t quad2.y = floor(ceil(blueColor) / 8.0);\n\t\t quad2.x = ceil(blueColor) - (quad2.y * 8.0);\n\t\t highp vec2 texPos1;\n\t\t texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n\t\t texPos1.y = 1.0 - ((quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n\t\t highp vec2 texPos2;\n\t\t texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);\n\t\t texPos2.y = 1.0 - ((quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));\n\t\t lowp vec3 newColor1 = texture2D(textureB, texPos1).xyz;\n\t\t lowp vec3 newColor2 = texture2D(textureB, texPos2).xyz;\n\t\t lowp vec3 newColor = mix(newColor1, newColor2, fract(blueColor));\n\t\t return newColor.rgb;\n\t }",
noise:"\n\t\tfloat hash(float n) { return fract(sin(n) * 1e4); }\n\t\tfloat hash(vec2 p) { return fract(1e4 * sin(17.0 * p.x + p.y * 0.1) * (0.1 + abs(sin(p.y * 13.0 + p.x)))); }\n\t\tfloat noise(float x) {\n\t\t\tfloat i = floor(x);\n\t\t\tfloat f = fract(x);\n\t\t\tfloat u = f * f * (3.0 - 2.0 * f);\n\t\t\treturn mix(hash(i), hash(i + 1.0), u);\n\t\t}\n\t\tfloat noise(vec2 x) {\n\t\t\tvec2 i = floor(x);\n\t\t\tvec2 f = fract(x);\n\t\t\tfloat a = hash(i);\n\t\t\tfloat b = hash(i + vec2(1.0, 0.0));\n\t\t\tfloat c = hash(i + vec2(0.0, 1.0));\n\t\t\tfloat d = hash(i + vec2(1.0, 1.0));\n\t\t\tvec2 u = f * f * (3.0 - 2.0 * f);\n\t\t\treturn mix(a, b, u.x) + (c - a) * u.y * (1.0 - u.x) + (d - b) * u.x * u.y;\n\t\t}\n\t",
HSV:"vec3 rgb2hsv(vec3 c)\n\t\t{\n\t\t\tvec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\n\t\t\tvec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\n\t\t\tvec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\n\t\t\t\n\t\t\tfloat d = q.x - min(q.w, q.y);\n\t\t\tfloat e = 1.0e-10;\n\t\t\treturn vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\n\t\t}\n\t\t\n\t\tvec3 hsv2rgb(vec3 c)\n\t\t{\n\t\t\tvec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\n\t\t\tvec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n\t\t\treturn c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n\t\t}"};
X.prototype.configure=function(a){this.apply_fxaa=!!a.apply_fxaa;a.fx&&(this.fx=a.fx.concat());this._must_update_passes=!0};X.prototype.serialize=X.prototype.toJSON=function(){return{apply_fxaa:this.apply_fxaa,fx:this.fx.concat()}};X.prototype.getResources=function(a){for(var b=this.fx,c=0;c<b.length;c++){var d=b[c],f=X.available_fx[d.name];if(f&&f.uniforms)for(var e in f.uniforms)"sampler2D"==f.uniforms[e].type&&d[e]&&(a[d[e]]=GL.Texture)}return a};X.prototype.onResourceRenamed=function(a,b,c){c=
this.fx;for(var d=0;d<c.length;d++){var f=c[d],e=X.available_fx[f.name];if(e&&e.uniforms)for(var g in e.uniforms)"sampler2D"==e.uniforms[g].type&&f[g]==a&&(f[g]=b)}};X.prototype.addFX=function(a){a&&(X.available_fx[a]?(this.fx.push({name:a}),this._must_update_passes=!0):console.warn("FXStack not found: "+a))};X.prototype.getFX=function(a){return this.fx[a]};X.prototype.moveFX=function(a,b){b=b||-1;var c=this.fx.indexOf(a);-1!=c&&(this.fx.splice(c,1),c+=b,0<=c&&c<this.fx.length?this.fx.splice(c,0,
a):this.fx.push(a),this._must_update_passes=!0)};X.prototype.removeFX=function(a){for(var b=0;b<this.fx.length;b++)if(this.fx[b]===a){this.fx.splice(b,1);this._must_update_passes=!0;break}};X.prototype.buildPasses=function(){for(var a=this.fx,b=[],c={fxs:[],uniforms:{},shader:null,first_fx_id:0},d="",f="",e="",g={},k=!0,m=0,l=0;l<a.length;l++){var n=a[l],m=l,p=X.available_fx[n.name];if(p){p.break_pass&&!k?(c.uv_code=d,c.color_code=f,c.uniforms_code=e,c.included_functions=g,b.push(c),this.buildPassShader(c),
e=f=d="",g={},c={fxs:[],uniforms:{},first_fx_id:m},k=!0):k=!1;if(p.functions)for(var q in p.functions)g[p.functions[q]]=!0;p.code&&(f+=p.code.split("@").join(m)+";\n");p.uv_code&&(d+=p.uv_code.split("@").join(m)+";\n");if(p.uniforms)for(var r in p.uniforms)var s=p.uniforms[r],e=e+("uniform "+s.type+" "+(s.name+m)+";\n");c.fxs.push(n)}}k||(c.uv_code=d,c.color_code=f,c.included_functions=g,b.push(c),this.buildPassShader(c));this._passes=b};X.prototype.buildPassShader=function(a){var b="",c;for(c in a.included_functions){var d=
X.available_functions[c];d?b+=d+"\n":console.error("FXStack: Function not found: "+c)}b="\n\t\t#extension GL_OES_standard_derivatives : enable\n\t\tprecision highp float;\n\t\t#define color3 vec3\n\t\t#define color4 vec4\n\t\tuniform sampler2D u_texture;\n\t\tuniform sampler2D u_depth_texture;\n\t\tvarying vec2 v_coord;\n\t\tuniform vec2 u_viewport;\n\t\tuniform vec2 u_iviewport;\n\t\tuniform float u_aspect;\n\t\tuniform vec2 u_depth_range;\n\t\tuniform vec2 u_random;\n\t\tvec2 uv;\n\t\t"+a.uniforms_code+
"\n\t\t"+b+"\n\t\tvoid main() {\n\t\t\tuv = v_coord;\n\t\t\tvec2 to_center = vec2(0.5) - uv;\n\t\t\tfloat dist_to_center = length(to_center);\n\t\t\t"+a.uv_code+"\n\t\t\tvec4 color = texture2D(u_texture, uv);\n\t\t\tfloat temp = 0.0;\n\t\t\t"+a.color_code+"\n\t\t\tgl_FragColor = color;\n\t\t}\n\t\t";this._must_update_passes=!1;a.shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,b);return a.shader};X.prototype.applyFX=function(a,b,c){var d=c.depth_texture,f=this._uniforms;f.u_viewport[0]=a.width;
f.u_viewport[1]=a.height;f.u_iviewport[0]=1/a.width;f.u_iviewport[1]=1/a.height;f.u_aspect=a.width/a.height;f.u_random[0]=Math.random();f.u_random[1]=Math.random();this._passes&&!this._must_update_passes||this.buildPasses();if(this._passes.length){var h=b?b.width:a.width,g=b?b.height:a.height;c=GL.Texture.getTemporary(h,g,{type:a.type,format:a.format});h=GL.Texture.getTemporary(h,g,{type:a.type,format:a.format});a.copyTo(c);for(var k=0,g=0;g<this._passes.length;g++){for(var m=this._passes[g],l=2,
n=m.uniforms,p=0;p<m.fxs.length;++p){var q=m.fxs[p],k=m.first_fx_id+p,r=X.available_fx[q.name];if(r&&r.uniforms)for(var s in r.uniforms){var t=r.uniforms[s],K=t.name+k;"sampler2D"==t.type?(n[K]=l,(K=this.getTexture(q[s]))?(K.bind(l),"nearest"==t.filter&&(gl.texParameteri(K.texture_type,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(K.texture_type,gl.TEXTURE_MIN_FILTER,gl.NEAREST)),"clamp"==t.wrap&&(gl.texParameteri(K.texture_type,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(K.texture_type,
gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE))):(K=e.Renderer._missing_texture)&&K.bind(l),l++):n[K]=void 0!==q[p]?q[p]:t.value}}m=m.shader;if(!m){a.toViewport();break}d&&m.hasUniform("u_depth_texture")&&(d.bind(1),d.near_far_planes&&(n.u_depth_range=d.near_far_planes));m.uniforms(f);c.copyTo(h,m,n);k=c;c=h;h=k}a=h;a.setParameter(gl.TEXTURE_MAG_FILTER,this.filter?gl.LINEAR:gl.NEAREST);a.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);gl.disable(gl.CULL_FACE);this.apply_fxaa?
(n=GL.Shader.getFXAAShader(),n.setup(),b?a.copyTo(b,n):a.toViewport(n)):b?(m.uniforms(n),a.copyTo(b,m)):a.toViewport();GL.Texture.releaseTemporary(c);GL.Texture.releaseTemporary(h)}else b?a.copyTo(b):(b=GL.Shader.getFXAAShader(),b.setup(),a.toViewport(this.apply_fxaa?b:null))};X.prototype.applyFX=function(a,b,c){c=c.depth_texture;var d=this.fx,f=this._must_update_passes;this._must_update_passes=!1;var h=this._uniforms;h.u_viewport[0]=a.width;h.u_viewport[1]=a.height;h.u_iviewport[0]=1/a.width;h.u_iviewport[1]=
1/a.height;h.u_aspect=a.width/a.height;h.u_random[0]=Math.random();h.u_random[1]=Math.random();for(var g="",k="",m={},l="",n=2,p=0,q=0;q<d.length;q++){var r=d[q],p=q,s=X.available_fx[r.name];if(s){if(f){if(s.functions)for(var t in s.functions)m[s.functions[t]]=!0;s.code&&(k+=s.code.split("@").join(p)+";\n");s.uv_code&&(g+=s.uv_code.split("@").join(p)+";\n")}if(s.uniforms)for(var K in s.uniforms){var G=s.uniforms[K],O=G.name+p;f&&(l+="uniform "+G.type+" "+O+";\n");"sampler2D"==G.type?(h[O]=n,(O=this.getTexture(r[K]))?
(O.bind(n),"nearest"==G.filter&&(gl.texParameteri(O.texture_type,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(O.texture_type,gl.TEXTURE_MIN_FILTER,gl.NEAREST)),"clamp"==G.wrap&&(gl.texParameteri(O.texture_type,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(O.texture_type,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE))):(O=e.Renderer._missing_texture)&&O.bind(n),n++):h[O]=void 0!==r[K]?r[K]:G.value}}}var C=null;if(f){t="";for(q in m)(m=X.available_functions[q])?t+=m+"\n":console.error("FXStack: Function not found: "+
q);this._last_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,"\n\t\t\t#extension GL_OES_standard_derivatives : enable\n\t\t\tprecision highp float;\n\t\t\t#define color3 vec3\n\t\t\t#define color4 vec4\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_depth_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform vec2 u_iviewport;\n\t\t\tuniform float u_aspect;\n\t\t\tuniform vec2 u_depth_range;\n\t\t\tuniform vec2 u_random;\n\t\t\tvec2 uv;\n\t\t\t"+l+
"\n\t\t\t"+t+"\n\t\t\tvoid main() {\n\t\t\t\tuv = v_coord;\n\t\t\t\tvec2 to_center = vec2(0.5) - uv;\n\t\t\t\tfloat dist_to_center = length(to_center);\n\t\t\t\t"+g+"\n\t\t\t\tvec4 color = texture2D(u_texture, uv);\n\t\t\t\tfloat temp = 0.0;\n\t\t\t\t"+k+"\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t\t")}C=this._last_shader;gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);gl.disable(gl.CULL_FACE);C?(C.hasUniform("u_depth_texture")&&c&&(c.bind(1),c.near_far_planes&&(h.u_depth_range=c.near_far_planes)),
a.setParameter(gl.TEXTURE_MAG_FILTER,this.filter?gl.LINEAR:gl.NEAREST),a.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR),this.apply_fxaa?(this.temp_tex&&this.temp_tex.width==gl.viewport_data[2]&&this.temp_tex.height==gl.viewport_data[3]||(this.temp_tex=new GL.Texture(gl.viewport_data[2],gl.viewport_data[3])),this.temp_tex.drawTo(function(){a.toViewport(C,h)}),c=GL.Shader.getFXAAShader(),c.setup(),b?this.temp_tex.copyTo(b,c):this.temp_tex.toViewport(c)):(this.temp_tex=null,b?(C.uniforms(h),a.copyTo(b,
C)):a.toViewport(C,h))):a.toViewport()};X.prototype.getTexture=function(a){return e.ResourcesManager.getTexture(a)};X.prototype.getPropertyInfoFromPath=function(a){if(2>a.length)return null;var b=parseInt(a[0]);if(b>=this.fx.length)return null;var b=this.fx[b],c=X.available_fx[b.name];if(!c)return null;a=a[1];return"name"==a?null:(c=c.uniforms[a])?{target:b,name:a,value:b[a],type:c.type||"number"}:null};X.prototype.setPropertyValueFromPath=function(a,b,c){c=c||0;if(a.length<c+1)return null;var d=
parseInt(a[c]);if(d>=this.fx.length)return null;d=this.fx[d];if(!d)return null;a=a[c+1];if(void 0===d[a])return null;void 0!==d[a]&&void 0!==b&&d[a].constructor===b.constructor&&(d[a]=b)};X.registerFX=function(a,b){b.name||(b.name=a);if(void 0===b.code)throw"FXStack must have a code";b.uniforms&&Object.keys(b.uniforms)&&b.code&&-1==b.code.indexOf("@")&&console.warn("FXStack using uniforms must use the character '@' at the end of every use to avoid collisions with other variables with the same name.");
X.available_fx[a]=b};X.registerFunction=function(a,b){X.available_functions[a]=b};e.FXStack=X;e.TextureFX=X;e.Tween={MAX_EASINGS:256,EASE_IN_QUAD:1,EASE_OUT_QUAD:2,EASE_IN_OUT_QUAD:3,QUAD:3,EASE_IN_CUBIC:4,EASE_OUT_CUBIC:5,EASE_IN_OUT_CUBIC:6,CUBIC:6,EASE_IN_QUART:7,EASE_OUT_QUART:8,EASE_IN_OUT_QUART:9,QUART:9,EASE_IN_SINE:10,EASE_OUT_SINE:11,EASE_IN_OUT_SINE:12,SINE:12,EASE_IN_EXPO:13,EASE_OUT_EXPO:14,EASE_IN_OUT_EXPO:15,EXPO:15,EASE_IN_BACK:16,EASE_OUT_BACK:17,EASE_IN_OUT_BACK:18,BACK:18,current_easings:[],
_alife:[],reset:function(){this.current_easings=[];this._alife=[]},easeProperty:function(a,b,c,d,f,h,g){if(!a)throw"ease object cannot be null";if(void 0===c)throw"target vaue must be defined";if(void 0===a[b])throw"property not found in object, must be initialized to a value";if(this.current_easings.length)for(var k=0;k<this.current_easings.length;++k){var m=this.current_easings[k];if(m.object===a&&m.property==b){this.current_easings.splice(k,1);break}}f=f||this.EASE_IN_OUT_QUAD;k=null;k=b?e.cloneObject(a[b]):
e.cloneObject(a);c=e.cloneObject(c);m=0;c.constructor===Number?m=-1:c&&void 0!==c.length&&(m=c.length);var l=null,n=a.constructor["@"+b];n&&(l=n.type);c={object:a,property:b,origin:k,target:c,current:0,time:d,easing:f,on_complete:h,on_progress:g,size:m,type:l,running:!0};for(k=0;k<this.current_easings.length;++k)if(this.current_easings[k].object==a&&this.current_easings[k].property==b){this.current_easings[k]=c;break}this.current_easings.length>=this.MAX_EASINGS&&this.current_easings.shift();this.current_easings.push(c);
return c},easeObject:function(a,b,c,d,f,h){if(!a||!b)throw"ease object cannot be null";d=d||this.EASE_IN_OUT_QUAD;var g=e.cloneObject(a);b=e.cloneObject(b);var k=0;void 0!==b.length&&(k=b.length);b={object:a,origin:g,target:b,current:0,time:c,easing:d,on_complete:f,on_progress:h,size:k};for(c=0;c<this.current_easings.length;++c)if(this.current_easings[c].object==a){this.current_easings[c]=b;break}this.current_easings.length>=this.MAX_EASINGS&&this.current_easings.shift();this.current_easings.push(b);
return b},update:function(a){if(this.current_easings.length){var b=this.current_easings,c=this._alife;c.length=b.length;for(var d=0,f=0,e=b.length;f<e;++f){var g=b[f];g.current+=a;var k=1;g.current<g.time&&(k=g.current/g.time,c[d]=g,d+=1);var m=this.getEaseFactor(k,g.easing);if(g.size){if(-1==g.size)g.object[g.property]=g.target*m+g.origin*(1-m);else{var l=g.object[g.property];if(g.type&&"quat"==g.type)quat.slerp(l,g.origin,g.target,m);else for(var n=0;n<g.size;++n)l[n]=g.target[n]*m+g.origin[n]*
(1-m)}void 0!==g.object.mustUpdate&&(g.object.mustUpdate=!0)}if(g.on_progress)g.on_progress(g);if(1<=k){if(g.on_complete)g.on_complete(g);g.running=!1}}c.length=d;this.current_easings=c;this._alife=b}},getEaseFactor:function(a,b){1<a?a=1:0>a&&(a=0);var c=1.70158;b=b||this.QUAD;switch(b){case this.EASE_IN_QUAD:return a*a;case this.EASE_OUT_QUAD:return 1-a*a;case this.EASE_IN_OUT_QUAD:a*=2;if(1>a)return 0.5*a*a;a-=1;return-0.5*(a*(a-2)-1);case this.EASE_IN_CUBIC:return a*a*a;case this.EASE_OUT_CUBIC:return a-=
1,a*a*a+1;case this.EASE_IN_OUT_CUBIC:a*=2;if(1>a)return 0.5*a*a*a;a-=2;return 0.5*(a*a*a+2);case this.EASE_IN_QUART:return a*a*a*a;case this.EASE_OUT_QUART:return a-=1,-(a*a*a*a-1);case this.EASE_IN_OUT_QUART:a*=2;if(1>a)return 0.5*a*a*a*a;a-=2;return-0.5*(a*a*a*a-2);case this.EASE_IN_SINE:return 1-Math.cos(a*Math.PI/2);case this.EASE_OUT_SINE:return Math.sin(a*Math.PI/2);case this.EASE_IN_OUT_SINE:return-0.5*(Math.cos(Math.PI*a)-1);case this.EASE_IN_EXPO:return 0==a?0:Math.pow(2,10*(a-1));case this.EASE_OUT_EXPO:return 1==
a?1:1-Math.pow(2,-10*a);case this.EASE_IN_OUT_EXPO:if(0==a)return 0;if(1==a)return 1;a*=2;return 1>a?0.5*Math.pow(2,10*(a-1)):0.5*(-Math.pow(2,-10*(a-1))+2);case this.EASE_IN_BACK:return a*a*((c+1)*a-c);case this.EASE_OUT_BACK:return a*a*((c+1)*a+c)+1;case this.EASE_IN_OUT_BACK:a*=2;if(1>a)return c*=1.525,0.5*a*a*((c+1)*a-c);a-=2;c*=1.525;return 0.5*(a*a*((c+1)*a+c)+2)}return a}};nb.prototype.addEntry=function(a,b,c){if(a.constructor===e.AnimationBlender.Entry)this.active_entries.push(a);else{var d=
new e.AnimationBlender.Entry;d.animation_name=a;d.take_name=b;d.time=c;this.active_entries.push(d);return d}};nb.prototype.removeEntry=function(a){a=this.active_entries.indexOf(a);-1!=a&&this.active_entries.splice(a,1)};nb.prototype.execute=function(a,b){for(var c={},d=0,f=0;f<this.active_entries.length;++f){var e=this.active_entries[f];if(e._animation_take)for(var d=d+e.weight,e=e._animation_take,g=0;g<e.tracks.length;++g){var k=e.tracks[g],m=c[k.property];m||(m=c[k.property]=[]);k=k.getSample();
m.push(k)}}for(f=0;f<this.active_entries.length;++f)e=this.active_entries[f],d+=e.weight;for(f=0;f<this.active_entries.length;++f)e=this.active_entries[f],e.execute(remaining/d,!1,a,b),remaining-=e.weight};e.AnimationBlender=nb;Object.defineProperty(ib.prototype,"take_name",{set:function(a){this._take_name!=a&&(this._take_name=a,this._must_update=!0)},get:function(){return this._take_name},enumerable:!1});Object.defineProperty(ib.prototype,"animation_name",{set:function(a){this._animation_name!=a&&
(this._animation_name=a,this._must_update=!0)},get:function(){return this._animation_name},enumerable:!1});Object.defineProperty(ib.prototype,"duration",{set:function(a){throw"duration cannot be set. It depends in the animation duration";},get:function(){return this._animation_take?this._animation_take.duration:-1},enumerable:!1});Object.defineProperty(ib.prototype,"loaded",{set:function(a){throw"duration cannot be set. It depends in the animation duration";},get:function(){return!!this._animation_take},
enumerable:!1});ib.prototype.execute=function(a,b,c,d){if(!this._animation_name||!this._take_name)return!1;if(this._must_update){var f=e.ResourcesManager.get(this._animation_name);if(!f)return!1;this._animation_take=f.takes[this._take_name]}if(this._animation_take)return this._animation_take.applyTracks(this.time,this._last_time,b,c,d,a),this._last_time=this.time,!0};nb.Entry=ib;gb.prototype.add=function(a,b){var c=this.root;c.push(a);this.objects_cell_by_id.set(a,c);return a.uid};gb.prototype.updateBounding=
function(a,b){};gb.prototype.remove=function(a,b){var c=this.objects_cell_by_id.get(a);if(c){var d=c.indexOf(a);-1!==d&&c.splice(d,1);this.objects_cell_by_id["delete"](a)}};gb.prototype.retrieve=function(a){return this.root};gb.prototype.retrieveFromCamera=function(a){return this.root};gb.prototype.clear=function(){this.root.length=0;this.objects_cell_by_id=new WeakMap};e.SpatialContainer=gb;Na.AUTO_QUALITY=0;Na.HIGH_QUALITY=1;Na.MEDIUM_QUALITY=2;Na.LOW_QUALITY=3;Na.default_shadowmap_resolution=1024;
Na["@default_shadowmap_resolution"]={widget:"combo",values:[0,256,512,1024,2048,4096]};Na["@layers"]={type:"layers"};Na.prototype.serialize=function(){return e.cloneObject(this)};Na.prototype.configure=function(a){if(a)for(var b in a)this[b]=a[b];null===this.layers&&(this.layers=255)};Na.prototype.toJSON=Na.prototype.serialize;e.RenderSettings=Na;Object.defineProperty(D.prototype,"front_face",{set:function(a){this._data[0]=a},get:function(){return this._data[0]},enumerable:!0});D.SKIP_BLEND=1;D.SKIP_DEPTH=
2;D.SKIP_STENCIL=4;D["@front_face"]={widget:"combo",values:{CW:GL.CW,CCW:GL.CCW}};Object.defineProperty(D.prototype,"cull_face",{set:function(a){this._data[1]=a?1:0},get:function(){return 0!==this._data[1]},enumerable:!0});Object.defineProperty(D.prototype,"cull_face_mode",{set:function(a){this._data[2]=a},get:function(){return this._data[2]},enumerable:!0});D["@cull_face_mode"]={widget:"combo",values:{FRONT:GL.FRONT,BACK:GL.BACK,FRONT_AND_BACK:GL.FRONT_AND_BACK}};Object.defineProperty(D.prototype,
"depth_test",{set:function(a){this._data[4]=a?1:0},get:function(){return 0!==this._data[4]},enumerable:!0});Object.defineProperty(D.prototype,"depth_mask",{set:function(a){this._data[5]=a?1:0},get:function(){return 0!==this._data[5]},enumerable:!0});Object.defineProperty(D.prototype,"depth_func",{set:function(a){this._data[6]=a},get:function(){return this._data[6]},enumerable:!0});D["@depth_func"]={widget:"combo",values:{LESS:GL.LESS,LEQUAL:GL.LEQUAL,EQUAL:GL.EQUAL,NOTEQUAL:GL.NOTEQUAL,GREATER:GL.GREATER,
GEQUAL:GL.GEQUAL,ALWAYS:GL.ALWAYS,NEVER:GL.NEVER}};Object.defineProperty(D.prototype,"depth_range",{set:function(a){a&&2==a.length&&(this._data[7]=a[0],this._data[8]=a[1])},get:function(){return this._data.subarray(7,9)},enumerable:!0});Object.defineProperty(D.prototype,"blend",{set:function(a){this._data[9]=a?1:0},get:function(){return 0!==this._data[9]},enumerable:!0});Object.defineProperty(D.prototype,"blendFunc0",{set:function(a){this._data[10]=a},get:function(){return this._data[10]},enumerable:!0});
D["@blendFunc0"]={widget:"combo",values:{ZERO:GL.ZERO,ONE:GL.ONE,SRC_COLOR:GL.SRC_COLOR,ONE_MINUS_SRC_COLOR:GL.ONE_MINUS_SRC_COLOR,DST_COLOR:GL.DST_COLOR,ONE_MINUS_DST_COLOR:GL.ONE_MINUS_DST_COLOR,SRC_ALPHA:GL.SRC_ALPHA,ONE_MINUS_SRC_ALPHA:GL.ONE_MINUS_SRC_ALPHA,DST_ALPHA:GL.DST_ALPHA,ONE_MINUS_DST_ALPHA:GL.ONE_MINUS_DST_ALPHA,CONSTANT_COLOR:GL.CONSTANT_COLOR,ONE_MINUS_CONSTANT_COLOR:GL.ONE_MINUS_CONSTANT_COLOR,CONSTANT_ALPHA:GL.CONSTANT_ALPHA,ONE_MINUS_CONSTANT_ALPHA:GL.ONE_MINUS_CONSTANT_ALPHA,
SRC_ALPHA_SATURATE:GL.SRC_ALPHA_SATURATE}};Object.defineProperty(D.prototype,"blendFunc1",{set:function(a){this._data[11]=a},get:function(){return this._data[11]},enumerable:!0});D["@blendFunc1"]={widget:"combo",values:{ZERO:GL.ZERO,ONE:GL.ONE,SRC_COLOR:GL.SRC_COLOR,ONE_MINUS_SRC_COLOR:GL.ONE_MINUS_SRC_COLOR,DST_COLOR:GL.DST_COLOR,ONE_MINUS_DST_COLOR:GL.ONE_MINUS_DST_COLOR,SRC_ALPHA:GL.SRC_ALPHA,ONE_MINUS_SRC_ALPHA:GL.ONE_MINUS_SRC_ALPHA,DST_ALPHA:GL.DST_ALPHA,ONE_MINUS_DST_ALPHA:GL.ONE_MINUS_DST_ALPHA,
CONSTANT_COLOR:GL.CONSTANT_COLOR,ONE_MINUS_CONSTANT_COLOR:GL.ONE_MINUS_CONSTANT_COLOR,CONSTANT_ALPHA:GL.CONSTANT_ALPHA,ONE_MINUS_CONSTANT_ALPHA:GL.ONE_MINUS_CONSTANT_ALPHA,SRC_ALPHA_SATURATE:GL.SRC_ALPHA_SATURATE}};Object.defineProperty(D.prototype,"blendFunc",{set:function(a){a&&2==a.length&&(this._data[10]=a[0],this._data[11]=a[1])},get:function(){return this._data.subarray(10,12)},enumerable:!1});Object.defineProperty(D.prototype,"colorMask0",{set:function(a){this._data[12]=a?1:0},get:function(){return 0!==
this._data[12]},enumerable:!0});Object.defineProperty(D.prototype,"colorMask1",{set:function(a){this._data[13]=a?1:0},get:function(){return 0!==this._data[13]},enumerable:!0});Object.defineProperty(D.prototype,"colorMask2",{set:function(a){this._data[14]=a?1:0},get:function(){return 0!==this._data[14]},enumerable:!0});Object.defineProperty(D.prototype,"colorMask3",{set:function(a){this._data[15]=a?1:0},get:function(){return 0!==this._data[15]},enumerable:!0});Object.defineProperty(D.prototype,"colorMask",
{set:function(a){a&&4==a.length&&(this._data[12]=a[0],this._data[13]=a[1],this._data[14]=a[2],this._data[15]=a[3])},get:function(){return this._data.subarray(12,16)},enumerable:!1});Object.defineProperty(D.prototype,"stencil_test",{set:function(a){this._data[16]=a?1:0},get:function(){return 0!==this._data[16]},enumerable:!0});Object.defineProperty(D.prototype,"stencil_mask",{set:function(a){this._data[17]=a},get:function(){return this._data[17]},enumerable:!0});Object.defineProperty(D.prototype,"skip_blend",
{set:function(a){this._data[25]=a?this._data[25]|D.SKIP_BLEND:this._data[25]&~D.SKIP_BLEND},get:function(){return Boolean(this._data[25]&D.SKIP_BLEND)},enumerable:!0});Object.defineProperty(D.prototype,"skip_depth",{set:function(a){this._data[25]=a?this._data[25]|D.SKIP_DEPTH:this._data[25]&~D.SKIP_DEPTH},get:function(){return Boolean(this._data[25]&D.SKIP_DEPTH)},enumerable:!0});Object.defineProperty(D.prototype,"skip_stencil",{set:function(a){this._data[25]=a?this._data[25]|D.SKIP_STENCIL:this._data[25]&
~D.SKIP_STENCIL},get:function(){return Boolean(this._data[25]&D.SKIP_STENCIL)},enumerable:!0});D["@stencil_mask"]={widget:"number",min:0,max:256,step:1,precision:0};Object.defineProperty(D.prototype,"stencil_func",{set:function(a){a&&3==a.length&&(this._data[18]=a[0],this._data[19]=a[1],this._data[20]=a[2])},get:function(){return this._data.subarray(18,21)},enumerable:!1});Object.defineProperty(D.prototype,"stencil_func_func",{set:function(a){this._data[18]=a},get:function(){return this._data[18]},
enumerable:!0});D["@stencil_func_func"]={widget:"combo",values:{LESS:GL.LESS,LEQUAL:GL.LEQUAL,EQUAL:GL.EQUAL,NOTEQUAL:GL.NOTEQUAL,GREATER:GL.GREATER,GEQUAL:GL.GEQUAL,ALWAYS:GL.ALWAYS,NEVER:GL.NEVER}};Object.defineProperty(D.prototype,"stencil_func_ref",{set:function(a){this._data[19]=a},get:function(){return this._data[19]},enumerable:!0});D["@stencil_func_ref"]={widget:"number",min:0,max:256,step:1,precision:0};Object.defineProperty(D.prototype,"stencil_func_mask",{set:function(a){this._data[20]=
a},get:function(){return this._data[20]},enumerable:!0});D["@stencil_func_mask"]={widget:"number",min:0,max:256,step:1,precision:0};Object.defineProperty(D.prototype,"stencil_op",{set:function(a){a&&3==a.length&&(this._data[21]=a[0],this._data[22]=a[1],this._data[23]=a[2])},get:function(){return this._data.subarray(21,24)},enumerable:!1});Object.defineProperty(D.prototype,"stencil_op_sfail",{set:function(a){this._data[21]=a},get:function(){return this._data[21]},enumerable:!0});D["@stencil_op_sfail"]=
{widget:"combo",values:{KEEP:GL.KEEP,ZERO:GL.ZERO,REPLACE:GL.REPLACE,INCR:GL.INCR,INCR_WRAP:GL.INCR_WRAP,DECR:GL.DECR_WRAP,INVERT:GL.INVERT}};Object.defineProperty(D.prototype,"stencil_op_dpfail",{set:function(a){this._data[22]=a},get:function(){return this._data[22]},enumerable:!0});D["@stencil_op_dpfail"]={widget:"combo",values:{KEEP:GL.KEEP,ZERO:GL.ZERO,REPLACE:GL.REPLACE,INCR:GL.INCR,INCR_WRAP:GL.INCR_WRAP,DECR:GL.DECR_WRAP,INVERT:GL.INVERT}};Object.defineProperty(D.prototype,"stencil_op_dppass",
{set:function(a){this._data[23]=a},get:function(){return this._data[23]},enumerable:!0});Object.defineProperty(D.prototype,"flags",{set:function(a){this._data[24]=a},get:function(){return this._data[24]},enumerable:!0});D["@stencil_op_dppass"]={widget:"combo",values:{KEEP:GL.KEEP,ZERO:GL.ZERO,REPLACE:GL.REPLACE,INCR:GL.INCR,INCR_WRAP:GL.INCR_WRAP,DECR:GL.DECR_WRAP,INVERT:GL.INVERT}};D.default_state={front_face:GL.CCW,cull_face:!0,depth_test:!0,depth_func:GL.LESS,depth_mask:!0,blend:!1,blendFunc0:GL.SRC_ALPHA,
blendFunc1:GL.ONE_MINUS_SRC_ALPHA,colorMask0:!0,colorMask1:!0,colorMask2:!0,colorMask3:!0,stencil_test:!1,stencil_mask:255,stencil_func_func:GL.ALWAYS,stencil_func_ref:0,stencil_func_mask:255,stencil_op_sfail:GL.KEEP,stencil_op_dpfail:GL.KEEP,stencil_op_dppass:GL.KEEP};D.last_state=null;D.prototype.init=function(){this.front_face=GL.CCW;this.depth_mask=this.depth_test=this.cull_face=!0;this.depth_func=GL.LESS;this.blend=!1;this.blendFunc0=GL.SRC_ALPHA;this.blendFunc1=GL.ONE_MINUS_SRC_ALPHA;this.colorMask3=
this.colorMask2=this.colorMask1=this.colorMask0=!0;this.stencil_test=!1;this.stencil_mask=255;this.stencil_func_func=GL.ALWAYS;this.stencil_func_ref=0;this.stencil_func_mask=255;this.stencil_op_dppass=this.stencil_op_dpfail=this.stencil_op_sfail=GL.KEEP;this.flags=0};D.prototype.setBlendMode=function(a){a&&a!=e.Blend.NORMAL?(this.blend=!0,this.blendFunc0=a[0],this.blendFunc1=a[1]):this.blend=!1};D.prototype.enable=function(){D.enable(this)};D.enable=function(a,b){var c=a.flags;b?(b.front_face!==a.front_face&&
gl.frontFace(a.front_face),b.cull_face!==a.cull_face&&(a.cull_face?gl.enable(gl.CULL_FACE):gl.disable(gl.CULL_FACE)),c&D.SKIP_DEPTH||(b.depth_test!==a.depth_test&&(a.depth_test?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST)),b.depth_mask!==a.depth_mask&&gl.depthMask(a.depth_mask),b.depth_func!==a.depth_func&&gl.depthFunc(a.depth_func)),c&D.SKIP_BLEND||(b.blend!==a.blend&&(a.blend?gl.enable(gl.BLEND):gl.disable(gl.BLEND)),b.blendFunc0===a.blendFunc0&&b.blendFunc1===a.blendFunc1||gl.blendFunc(a.blendFunc0,
a.blendFunc1)),b.colorMask0===a.colorMask0&&b.colorMask1===a.colorMask1&&b.colorMask2===a.colorMask2&&b.colorMask3===a.colorMask3||gl.colorMask(a.colorMask0,a.colorMask1,a.colorMask2,a.colorMask3),c&D.SKIP_STENCIL||(b.stencil_test!=a.stencil_test&&(a.stencil_test?gl.enable(gl.STENCIL_TEST):gl.disable(gl.STENCIL_TEST)),a.stencil_test&&(a.stencil_func_func===b.stencil_func_func&&a.stencil_func_ref===b.stencil_func_ref&&a.stencil_func_mask===b.stencil_func_mask||gl.stencilFunc(a.stencil_func_func,a.stencil_func_ref,
a.stencil_func_mask),a.stencil_op_sfail===b.stencil_op_sfail&&a.stencil_op_dpfail===stencil_op_dpfail&&a.stencil_op_dppass===stencil_op_dppass||gl.stencilOp(a.stencil_op_sfail,a.stencil_op_dpfail,a.stencil_op_dppass),a.stencil_mask!==b.stencil_mask&&gl.stencilMask(b.stencil_mask)))):(gl.frontFace(a.front_face),a.cull_face?gl.enable(gl.CULL_FACE):gl.disable(gl.CULL_FACE),c&D.SKIP_DEPTH||(a.depth_test?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST),gl.depthMask(a.depth_mask),gl.depthFunc(a.depth_func)),
c&D.SKIP_BLEND||(a.blend?gl.enable(gl.BLEND):gl.disable(gl.BLEND),gl.blendFunc(a.blendFunc0,a.blendFunc1)),gl.colorMask(a.colorMask0,a.colorMask1,a.colorMask2,a.colorMask3),c&D.SKIP_STENCIL||(a.stencil_test?(gl.enable(gl.STENCIL_TEST),gl.stencilFunc(a.stencil_func_func,a.stencil_func_ref,a.stencil_func_mask),gl.stencilOp(a.stencil_op_sfail,a.stencil_op_dpfail,a.stencil_op_dppass),gl.stencilMask(a.stencil_mask)):gl.disable(gl.STENCIL_TEST)));this.last_state=a};D.reset=function(){this.enable(this.default_state)};
D.prototype.serialize=function(){return e.cloneObject(this)};D.prototype.toJSON=D.prototype.serialize;D.prototype.configure=function(a){e.cloneObject(a,this)};D.prototype.copyFrom=function(a){this._data.set(a._data)};e.RenderState=D;$a.prototype.draw=function(){this.renderState.enable();this.shader.uniforms(this.uniforms).drawBuffers(this.vertex_buffers,this.index_buffer,this.primitive,this.offset_start,this.offset_range)};$a.pool=[];$a.get=function(){return 0<$a.pool.length?$a.pool.pop():new $a};
$a.prototype.release=function(){$a.pool.push(this)};da.NO_SORT=0;da.SORT_NEAR_FIRST=1;da.SORT_FAR_FIRST=2;da.fast_normalmatrix=!1;da.prototype.fromNode=function(a){if(!a)throw"no node";this.node=a;a.transform?this.setMatrix(a.transform._global_matrix):this.setMatrix(e.IDENTITY);mat4.multiplyVec3(this.center,this.matrix,e.ZEROS);this.layers=a.layers};da.prototype.setMatrix=function(a,b){this.matrix.set(a);b?this.normal_matrix.set(b):this.computeNormalMatrix()};da.prototype.computeNormalMatrix=function(){if(da.fast_normalmatrix)this.normal_matrix.set(this.matrix),
mat4.setTranslation(this.normal_matrix,e.ZEROS);else{var a=mat4.invert(this.normal_matrix,this.matrix);a&&mat4.transpose(this.normal_matrix,a)}};da.prototype.applyTransform=function(a,b){mat4.mul(this.matrix,this.matrix,a);b?mat4.mul(this.normal_matrix,this.normal_matrix,b):this.computeNormalMatrix()};da.prototype.setMaterial=function(a){(!a||a.constructor.is_material)&&(this.material=a)&&a.applyToRenderInstance&&a.applyToRenderInstance(this)};da.prototype.setMesh=function(a,b){if(-1==b||void 0===
b)b=gl.TRIANGLES;this.primitive=b;a!=this.mesh&&(this.mesh=a,this.vertex_buffers={});if(this.mesh){for(var c in a.vertexBuffers)this.vertex_buffers[c]=a.vertexBuffers[c];switch(b){case gl.TRIANGLES:this.index_buffer=a.indexBuffers.triangles;break;case gl.LINES:this.index_buffer=a.indexBuffers.lines;break;case 10:this.primitive=gl.LINES;a.indexBuffers.wireframe||a.computeWireframe();this.index_buffer=a.indexBuffers.wireframe;break;default:this.index_buffer=null}a.bounding?(this.oobb.set(a.bounding),
this.use_bounding=!0):this.use_bounding=!1}};da.prototype.setBoundingBox=function(a){this.oobb.set(a)};da.prototype.setRange=function(a,b){this.range[0]=a;this.range[1]=b};da.prototype.enableFlag=function(a){this.flags|=a};da.prototype.disableFlag=function(a){this.flags&=~a};da.prototype.isFlag=function(a){return this.flags&a};da.prototype.updateAABB=function(){BBox.transformMat4(this.aabb,this.oobb,this.matrix)};da.prototype.update=function(){this.node&&this.node.transform&&this.setMatrix(this.node.transform._global_matrix)};
da.prototype.render=function(a,b){a.attributes.a_normal&&!this.vertex_buffers.normals&&(this.mesh.computeNormals(),this.vertex_buffers.normals=this.mesh.vertexBuffers.normals);a.attributes.a_tangent&&!this.vertex_buffers.tangents&&(this.mesh.computeTangents(),this.vertex_buffers.tangents=this.mesh.vertexBuffers.tangents);a.attributes.a_coord1&&!this.vertex_buffers.coords1&&(this.mesh.createVertexBuffer("coords1",2,vertex_buffers.coords.data),this.vertex_buffers.coords1=this.mesh.vertexBuffers.coords1);
a.attributes.a_extra&&!this.vertex_buffers.extra&&(this.mesh.createVertexBuffer("a_extra",1),this.vertex_buffers.extra=this.mesh.vertexBuffers.extra);a.attributes.a_extra2&&!this.vertex_buffers.extra2&&(this.mesh.createVertexBuffer("a_extra2",2),this.vertex_buffers.extra2=this.mesh.vertexBuffers.extra2);a.attributes.a_extra3&&!this.vertex_buffers.extra3&&(this.mesh.createVertexBuffer("a_extra3",3),this.vertex_buffers.extra3=this.mesh.vertexBuffers.extra3);a.drawBuffers(this.vertex_buffers,this.index_buffer,
void 0!==b?b:this.primitive,this.range[0],this.range[1])};da.prototype.addShaderBlock=function(a,b){if(!(a.flag_mask&this.shader_block_flags&&void 0===b)){for(var c=0;c<this.shader_blocks.length;++c)if(this.shader_blocks[c]&&this.shader_blocks[c].block==a)return void 0!==b&&(this.shader_blocks[c].uniforms=b),c;this.shader_blocks.push({block:a,uniforms:b});this.shader_block_flags|=a.flag_mask;return this.shader_blocks.length-1}};da.prototype.removeShaderBlock=function(a){if(a.flag_mask&this.shader_block_flags)for(var b=
0;b<this.shader_blocks.length;++b)if(this.shader_blocks[b]&&this.shader_blocks[b].block===a){this.shader_blocks.splice(b,1);this.shader_block_flags&=~a.flag_mask;break}};da.prototype.computeShaderBlockFlags=function(){return this.shader_block_flags};da.prototype.overlapsSphere=function(a,b){return this.use_bounding?geo.testSphereBBox(a,b,this.aabb):!0};da.prototype.wasVisibleByCamera=function(a){return a?this._camera_visibility|1<<a._rendering_index?!0:!1:0!=this._camera_visibility};e.RenderInstance=
da;I.current=null;I.stack=[];I.DEFAULT_PRECISION=0;I.LOW_PRECISION=1;I.MEDIUM_PRECISION=2;I.HIGH_PRECISION=3;I.DEFAULT_PRECISION_WEBGL_TYPE=GL.UNSIGNED_BYTE;I["@width"]={type:"number",step:1,precision:0};I["@height"]={type:"number",step:1,precision:0};I["@precision"]={widget:"combo",values:{"default":I.DEFAULT_PRECISION,low:I.LOW_PRECISION,medium:I.MEDIUM_PRECISION,high:I.HIGH_PRECISION}};I["@format"]={widget:"combo",values:{RGB:GL.RGB,RGBA:GL.RGBA}};I["@num_extra_textures"]={type:"number",step:1,
min:0,max:4,precision:0};I["@name"]={type:"string"};I.prototype.clear=function(){if(this.name){for(var a=0;a<this._textures.length;++a)delete e.ResourcesManager.textures[this.name+(1<a?a:"")];this._depth_texture&&delete e.ResourcesManager.textures[this.name+"_depth"]}this._fbo=null;this._textures=[];this._depth_textures=this._color_texture=null};I.prototype.configure=function(a){this.width=a.width||0;this.height=a.height||0;this.format=a.format||GL.RGBA;this.precision=a.precision||0;this.filter_texture=
!!a.filter_texture;this.adjust_aspect=!!a.adjust_aspect;this.use_depth_texture=!!a.use_depth_texture;this.use_stencil_buffer=!!a.use_stencil_buffer;this.num_extra_textures=a.num_extra_textures||0;this.name=a.name;this.clone_after_unbind=!!a.clone_after_unbind};I.prototype.serialize=function(){return{width:this.width,height:this.height,filter_texture:this.filter_texture,precision:this.precision,format:this.format,adjust_aspect:this.adjust_aspect,use_depth_texture:this.use_depth_texture,use_stencil_buffer:this.use_stencil_buffer,
num_extra_textures:this.num_extra_textures,clone_after_unbind:this.clone_after_unbind,name:this.name}};I.prototype.prepare=function(a,b){var c=this.width,d=this.height;0==c?c=a:0>c&&(c=a>>Math.abs(this.width));0==d?d=b:0>d&&(d=b>>Math.abs(this.height));var f=this.format,e=this.filter_texture?gl.LINEAR:gl.NEAREST,g=0,k=gl.LINEAR;this.generate_mipmaps&&GL.isPowerOfTwo(c)&&GL.isPowerOfTwo(d)&&(k=gl.LINEAR_MIPMAP_LINEAR);this._minFilter=k;switch(this.precision){case I.LOW_PRECISION:g=gl.UNSIGNED_BYTE;
break;case I.MEDIUM_PRECISION:g=gl.HIGH_PRECISION_FORMAT;break;case I.HIGH_PRECISION:g=gl.FLOAT;break;case I.DEFAULT_PRECISION:g=I.DEFAULT_PRECISION_WEBGL_TYPE;break;default:g=this.precision}var m=this._textures;this._color_texture&&this._color_texture.width==c&&this._color_texture.height==d&&this._color_texture.type==g&&this._color_texture.format==f&&this._color_texture.minFilter==k?this._color_texture.setParameter(gl.TEXTURE_MAG_FILTER,e):this._color_texture=new GL.Texture(c,d,{minFilter:k,magFilter:e,
format:f,type:g});m[0]=this._color_texture;var l=Math.min(this.num_extra_textures,4);1!=gl.webgl_version||gl.extensions.WEBGL_draw_buffers||(l=0);for(var n=0;n<l;++n){var p=m[1+n];p&&p.width==c&&p.height==d&&p.type==g&&p.format==f&&p.minFilter==k?p.setParameter(gl.TEXTURE_MAG_FILTER,e):p=new GL.Texture(c,d,{minFilter:k,magFilter:e,format:f,type:g});m[1+n]=p}f=gl.DEPTH_COMPONENT;e=gl.UNSIGNED_INT;this.use_stencil_buffer&&gl.extensions.WEBGL_depth_texture&&(f=gl.DEPTH_STENCIL,e=gl.extensions.WEBGL_depth_texture.UNSIGNED_INT_24_8_WEBGL);
!this.use_depth_texture||this._depth_texture&&this._depth_texture.width==c&&this._depth_texture.height==d&&this._depth_texture.format==f&&this._depth_texture.type==e||!gl.extensions.WEBGL_depth_texture?this.use_depth_texture||(this._depth_texture=null):this._depth_texture=new GL.Texture(c,d,{filter:gl.NEAREST,format:f,type:e});this._depth_texture&&!this._depth_texture.near_far_planes&&(this._depth_texture.near_far_planes=vec2.create());this._fbo||(this._fbo=new GL.FBO);m.length=1+l;this._fbo.stencil=
this.use_stencil_buffer;this._fbo.setTextures(m,this._depth_texture);this._version+=1};I.prototype.enable=function(a,b,c){b=b||gl.viewport_data;this.prepare(b[2],b[3]);if(!this._fbo)throw"No FBO created in RenderFrameContext";I.enableFBO(this._fbo,this.adjust_aspect);e.RenderFrameContext.current&&I.stack.push(e.RenderFrameContext.current);e.RenderFrameContext.current=this;c=c||e.Renderer._current_camera;this._depth_texture&&c&&(this._depth_texture.near_far_planes[0]=c.near,this._depth_texture.near_far_planes[1]=
c.far)};I.prototype.cloneBuffers=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null);if(this._textures.length){this._cloned_textures||(this._cloned_textures=[]);var a=this._textures;this._cloned_textures.length=a.length;for(var b=0;b<a.length;++b){var c=a[b],d=this._cloned_textures[b];d&&!d.hasSameSize(c[b])&&d.hasSameProperties(c)||(d=this._cloned_textures[b]=new GL.Texture(c.width,c.height,c.getProperties()));c.copyTo(d);0==b&&(e.ResourcesManager.textures[":color_buffer"]=d)}}this._depth_texture&&
(a=this._depth_texture,this._cloned_depth_texture&&this._cloned_depth_texture.width==a.width&&this._cloned_depth_texture.height==a.height&&this._cloned_depth_texture.hasSameProperties(a)||(this._cloned_depth_texture=new GL.Texture(a.width,a.height,a.getProperties())),a.copyTo(this._cloned_depth_texture),e.ResourcesManager.textures[":depth_buffer"]=this._cloned_depth_texture);gl.bindFramebuffer(gl.FRAMEBUFFER,this._fbo.handler)};I.prototype.disable=function(){I.disableFBO(this._fbo);if(this.name){for(var a=
this._textures,b=0;b<a.length;++b){var c=this.name+(0<b?b:"");a[b].filename=c;var d=a[b];this.clone_after_unbind&&0===b&&(this._cloned_texture&&this._cloned_texture.width===d.width&&this._cloned_texture.height===d.height&&this._cloned_texture.type===d.type?d.copyTo(this._cloned_texture):this._cloned_texture=d.clone(),d=this._cloned_texture);this._minFilter==gl.LINEAR_MIPMAP_LINEAR&&(d.bind(0),gl.generateMipmap(gl.TEXTURE_2D),d.has_mipmaps=!0);e.ResourcesManager.textures[c]=d}this._depth_texture&&
(c=this.name+"_depth",this._depth_texture.filename=c,e.ResourcesManager.textures[c]=this._depth_texture)}e.RenderFrameContext.current=I.stack.length?I.stack.pop():null};I.prototype.getColorTexture=function(a){return this._textures[a||0]||null};I.prototype.getDepthTexture=function(){return this._depth_texture||null};I.prototype.clearTextures=function(){for(var a=0;a<this._textures.length;++a){var b=this._textures[a];b&&b.fill([0,0,0,0])}};I.enableFBO=function(a,b){a.bind(!0);e.Renderer._full_viewport.set(gl.viewport_data);
b?(a._old_aspect=e.Renderer.global_aspect,e.Renderer.global_aspect=gl.canvas.width/gl.canvas.height/(a.color_textures[0].width/a.color_textures[0].height)):delete a._old_aspect};I.disableFBO=function(a){a.unbind();e.Renderer._full_viewport.set(a._old_viewport);a._old_aspect&&(e.Renderer.global_aspect=a._old_aspect)};I.prototype.show=function(a){var b=this._color_texture;if(a){a=gl.getViewport();var c=GL.Shader.getFXAAShader(),d=GL.Mesh.getScreenQuad();b.bind(0);c.uniforms({u_texture:0,uViewportSize:a.subarray(2,
4),u_iViewportSize:[1/b.width,1/b.height]}).draw(d)}else b.toViewport()};I.reset=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null);e.RenderFrameContext.current=null;e.RenderFrameContext.stack.length=0};e.RenderFrameContext=I;va.prototype.sort=function(){var a=null;switch(this.sort_mode){case 1:a=e.RenderQueue.sort_near_to_far_func;break;case 2:a=e.RenderQueue.sort_far_to_near_func;break;case 3:a=e.RenderQueue.sort_by_priority_func}a&&this.instances.sort(a)};va.prototype.add=function(a){this.instances.push(a)};
va.prototype.clear=function(){this.instances.length=0};va.DEFAULT=0;va.BACKGROUND=5;va.GEOMETRY=10;va.TRANSPARENT=15;va.READBACK_COLOR=20;va.OVERLAY=25;va.NO_SORT=0;va.SORT_NEAR_TO_FAR=1;va.SORT_FAR_TO_NEAR=2;va.SORT_BY_PRIORITY=3;va.sort_far_to_near_func=function(a,b){return b._dist-a._dist};va.sort_near_to_far_func=function(a,b){return a._dist-b._dist};va.sort_by_priority_func=function(a,b){return b.priority-a.priority};va.sort_by_priority_and_near_to_far_func=function(a,b){var c=b.priority-a.priority;
return c?c:a._dist-b._dist};va.sort_by_priority_and_far_to_near_func=function(a,b){var c=b.priority-a.priority;return c?c:b._dist-a._dist};e.RenderQueue=va;var hb=e.COLOR_PASS={name:"color",id:1},Rb=e.SHADOW_PASS={name:"shadow",id:2},Lb=e.PICKING_PASS={name:"picking",id:3},Mb={default_render_settings:new e.RenderSettings,default_material:new e.StandardMaterial,global_aspect:1,default_point_size:1,_global_viewport:vec4.create(),_full_viewport:vec4.create(),_current_scene:null,_current_render_settings:null,
_current_camera:null,_current_target:null,_current_pass:hb,_global_textures:{},_global_shader_blocks:[],_global_shader_blocks_flags:0,_queues:[],_main_camera:null,_visible_cameras:null,_visible_lights:null,_visible_instances:null,_visible_materials:[],_near_lights:[],_active_samples:[],_reflection_probes:[],_frame_cpu_time:0,_rendercalls:0,_rendered_instances:0,_rendered_passes:0,_frame:0,_collect_frequency:1,_view_matrix:mat4.create(),_projection_matrix:mat4.create(),_viewprojection_matrix:mat4.create(),
_2Dviewprojection_matrix:mat4.create(),_temp_matrix:mat4.create(),_temp_cameye:vec3.create(),_identity_matrix:mat4.create(),_render_uniforms:{},_instancing_data:[],_is_rendering_frame:!1,allow_textures:!0,_sphere_mesh:null,SHADOWMAP_TEXTURE_SLOT:6,ENVIRONMENT_TEXTURE_SLOT:5,IRRADIANCE_TEXTURE_SLOT:4,LIGHTPROJECTOR_TEXTURE_SLOT:3,LIGHTEXTRA_TEXTURE_SLOT:2,BONES_TEXTURE_SLOT:3,MORPHS_TEXTURE_SLOT:2,MORPHS_TEXTURE2_SLOT:1,init:function(){this._black_texture=new GL.Texture(1,1,{pixel_data:[0,0,0,255]});
this._gray_texture=new GL.Texture(1,1,{pixel_data:[128,128,128,255]});this._white_texture=new GL.Texture(1,1,{pixel_data:[255,255,255,255]});this._normal_texture=new GL.Texture(1,1,{pixel_data:[128,128,255,255]});this._missing_texture=this._gray_texture;[this._black_texture,this._gray_texture,this._white_texture,this._normal_texture,this._missing_texture].forEach(function(a){a._is_internal=!0});e.ResourcesManager.textures[":black"]=this._black_texture;e.ResourcesManager.textures[":gray"]=this._gray_texture;
e.ResourcesManager.textures[":white"]=this._white_texture;e.ResourcesManager.textures[":flatnormal"]=this._normal_texture;this._sphere_mesh=GL.Mesh.sphere({size:1,detail:32});e.Draw&&(e.Draw.init(),e.Draw.onRequestFrame=function(){e.GlobalScene.requestFrame()});Y.enableWebGLCanvas&&!gl.canvas.canvas2DtoWebGL_enabled&&Y.enableWebGLCanvas(gl.canvas);var a=this._max_texture_units=gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS);this.SHADOWMAP_TEXTURE_SLOT=a-2;this.ENVIRONMENT_TEXTURE_SLOT=a-3;this.IRRADIANCE_TEXTURE_SLOT=
a-4;this.LIGHTPROJECTOR_TEXTURE_SLOT=a-5;this.LIGHTEXTRA_TEXTURE_SLOT=a-6;this.BONES_TEXTURE_SLOT=a-7;this.MORPHS_TEXTURE_SLOT=a-8;this.MORPHS_TEXTURE2_SLOT=a-9;this._active_samples.length=a;this.createRenderQueue(e.RenderQueue.BACKGROUND,e.RenderQueue.NO_SORT);this.createRenderQueue(e.RenderQueue.GEOMETRY,e.RenderQueue.SORT_NEAR_TO_FAR);this.createRenderQueue(e.RenderQueue.TRANSPARENT,e.RenderQueue.SORT_FAR_TO_NEAR);this.createRenderQueue(e.RenderQueue.READBACK_COLOR,e.RenderQueue.SORT_FAR_TO_NEAR,
{onStart:function(a,c){e.RenderFrameContext.current&&"color"===c.name&&e.RenderFrameContext.current.cloneBuffers()}});this.createRenderQueue(e.RenderQueue.OVERLAY,e.RenderQueue.NO_SORT);this._full_viewport.set([0,0,gl.drawingBufferWidth,gl.drawingBufferHeight])},reset:function(){},resetState:function(){this._is_rendering_frame=!1},setFullViewport:function(a,b,c,d){a.constructor===Number?(this._full_viewport[0]=a,this._full_viewport[1]=b,this._full_viewport[2]=c,this._full_viewport[3]=d):a.length&&
this._full_viewport.set(a)},render:function(a,b,c){a=a||e.GlobalScene;if(this._is_rendering_frame)console.error("Last frame didn't finish and a new one was issued. Remember that you cannot call LS.Renderer.render from an event dispatched during the render, this would cause a recursive loop. Call LS.Renderer.reset() to clear from an error.");else{this._is_rendering_frame=!0;this._current_render_settings=b=b||this.default_render_settings;this._current_scene=a;this._main_camera=c?c[0]:null;a._frame+=
1;this._frame+=1;a._must_redraw=!1;var d=getTime();this._rendered_passes=this._rendered_instances=this._rendercalls=0;this._global_shader_blocks_flags=this._global_shader_blocks.length=0;for(var f in this._global_textures)this._global_textures[f]=null;this._current_pass||(this._current_pass=hb);b.ignore_reset||e.RenderFrameContext.reset();gl.canvas.canvas2DtoWebGL_enabled&&gl.resetTransform();b.keep_viewport?this.setFullViewport(gl.viewport_data):(gl.viewport(0,0,gl.drawingBufferWidth,gl.drawingBufferHeight),
this.setFullViewport(0,0,gl.drawingBufferWidth,gl.drawingBufferHeight));this._global_viewport.set(gl.viewport_data);LEvent.trigger(a,"beforeRender",b);this.processVisibleData(a,b,c);c=c&&c.length?c:this._visible_cameras;if(0==c.length)throw"no cameras";this._visible_cameras=c;this._main_camera=c[0];LEvent.trigger(a,"readyToRender",b);LEvent.trigger(a,"renderShadows",b);LEvent.trigger(a,"afterVisibility",b);LEvent.trigger(a,"renderReflections",b);LEvent.trigger(a,"beforeRenderMainPass",b);b.render_fx&&
LEvent.trigger(a,"enableFrameContext",b);this.renderFrameCameras(c,b);b.keep_viewport&&gl.setViewport(this._global_viewport);b.render_fx&&LEvent.trigger(a,"showFrameContext",b);this.renderGUI(b);this._frame_cpu_time=getTime()-d;e.Draw&&(this._rendercalls+=e.Draw._rendercalls);e.Draw._rendercalls=0;LEvent.trigger(a,"afterRender",b);this._is_rendering_frame=!1;e.triggerCoroutines("render")}},renderFrameCameras:function(a,b){for(var c=this._current_scene,d=0;d<a.length;++d){var f=a[d];LEvent.trigger(c,
"beforeRenderFrame",b);LEvent.trigger(f,"beforeRenderFrame",b);LEvent.trigger(f,"enableFrameContext",b);this.renderFrame(f,b);LEvent.trigger(f,"showFrameContext",b);LEvent.trigger(f,"afterRenderFrame",b);LEvent.trigger(c,"afterRenderFrame",b)}},renderFrame:function(a,b,c){b=b||this.default_render_settings;c&&(c._frame++,this.processVisibleData(c,b));this._current_scene=c=c||this._current_scene;this.enableCamera(a,b,b.skip_viewport,c);this.sortRenderQueues(a,b);this.clearBuffer(a,b);LEvent.trigger(c,
"beforeRenderScene",a);LEvent.trigger(this,"beforeRenderScene",a);LEvent.trigger(this,"computeVisibility",this._visible_instances);this.renderInstances(b,this._visible_instances);LEvent.trigger(c,"afterRenderScene",a);LEvent.trigger(this,"afterRenderScene",a);if(this.onRenderScene)this.onRenderScene(a,b,c);b.render_helpers&&LEvent.trigger(this,"renderHelpers",a)},showRenderFrameContext:function(a,b){LEvent.trigger(this,"beforeShowFrameContext",a);a.show()},enableCamera:function(a,b,c,d){d=d||this._current_scene||
e.GlobalScene;LEvent.trigger(a,"beforeEnabled",b);LEvent.trigger(d,"beforeCameraEnabled",a);var f=this._full_viewport[0],h=this._full_viewport[1],g=this._full_viewport[2],k=this._full_viewport[3];0==g&&0==k&&(console.warn("enableCamera: full viewport was 0, assigning to full viewport"),g=gl.viewport_data[2],k=gl.viewport_data[3]);var f=Math.floor(g*a._viewport[0]+f),h=Math.floor(k*a._viewport[1]+h),m=Math.ceil(g*a._viewport[2]),l=Math.ceil(k*a._viewport[3]);c||(b&&b.ignore_viewports?(a.final_aspect=
g/k*a._aspect*this.global_aspect,gl.viewport(this._full_viewport[0],this._full_viewport[1],this._full_viewport[2],this._full_viewport[3])):(a.final_aspect=m/l*a._aspect*this.global_aspect,gl.viewport(f,h,m,l)));a.updateMatrices();mat4.copy(this._view_matrix,a._view_matrix);mat4.copy(this._projection_matrix,a._projection_matrix);mat4.copy(this._viewprojection_matrix,a._viewprojection_matrix);for(c=0;16>c;++c)isNaN(this._viewprojection_matrix[c])&&console.warn("warning: viewprojection matrix contains NaN when enableCamera is used");
mat4.ortho(this._2Dviewprojection_matrix,-1,1,-1,1,1,-1);this._current_camera=a;e.Draw&&(e.Draw.reset(),e.Draw.setCamera(a));LEvent.trigger(a,"afterEnabled",b);LEvent.trigger(d,"afterCameraEnabled",a)},getCurrentCamera:function(){return this._current_camera},clearBuffer:function(a,b){b.ignore_clear||!a.clear_color&&!a.clear_depth||(gl.scissor(gl.viewport_data[0],gl.viewport_data[1],gl.viewport_data[2],gl.viewport_data[3]),gl.enable(gl.SCISSOR_TEST),gl.colorMask(!0,!0,!0,!0),gl.clearColor(a.background_color[0],
a.background_color[1],a.background_color[2],a.background_color[3]),gl.depthMask(!0),gl.enable(gl.STENCIL_TEST),gl.clearStencil(0),gl.clear((a.clear_color?gl.COLOR_BUFFER_BIT:0)|(a.clear_depth?gl.DEPTH_BUFFER_BIT:0)|gl.STENCIL_BUFFER_BIT),gl.disable(gl.SCISSOR_TEST),gl.disable(gl.STENCIL_TEST))},sortRenderQueues:function(a,b){var c=this._visible_instances;if(c){for(var d=a.getEye(this._temp_cameye),f=0,e=c.length;f<e;++f){var g=c[f];g&&(g._dist=vec3.dist(g.center,d))}f=0;for(e=this._queues.length;f<
e;++f)(c=this._queues[f])&&c.sort_mode&&c.sort()}},resetGLState:function(a){gl.enable(gl.CULL_FACE);gl.frontFace(gl.CCW);gl.colorMask(!0,!0,!0,!0);gl.enable(gl.DEPTH_TEST);gl.depthFunc(gl.LESS);gl.depthMask(!0);gl.disable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.disable(gl.STENCIL_TEST);gl.stencilMask(255);gl.stencilOp(gl.KEEP,gl.KEEP,gl.KEEP);gl.stencilFunc(gl.ALWAYS,1,255)},renderInstances:function(a,b,c){c=c||this._current_scene;if(!c)return console.warn("LS.Renderer.renderInstances: no scene found in LS.Renderer._current_scene"),
0;this._rendered_passes+=1;var d=this._current_pass,f=this._current_camera,e=-1!=f._rendering_index?1<<f._rendering_index:0,g=a.frustum_culling,k=f.updateFrustumPlanes(),m=f.layers&a.layers;LEvent.trigger(c,"beforeRenderInstances",a);this.fillSceneUniforms(c,a);this.resetGLState(a);LEvent.trigger(c,"renderInstances",a);LEvent.trigger(this,"renderInstances",a);this.resetGLState(a);b=b||this._visible_instances;this.bindSamplers(c._samplers);for(var l=0,n=b.length;l<n;++l){var p=b[l],q=p.node.flags;
p._is_visible=!1;d==Rb&&!p.material.flags.cast_shadows||d==Lb&&!1===q.selectable||0===(m&p.layers)||p.onPreRender&&!1===p.onPreRender(a)||!p.material||(q=f._overwrite_material||p.material,0>=q.opacity||g&&p.use_bounding&&!q.flags.ignore_frustum&&geo.frustumTestBox(k,p.aabb)==CLIP_OUTSIDE||(p._is_visible=!0,e&&(p._camera_visibility|=e)))}e=this._rendered_instances;for(g=0;g<this._queues.length;++g)if((k=this._queues[g])&&k.instances.length&&(!k.onStart||!1!==k.onStart(a,d))){b=k.instances;l=0;for(n=
b.length;l<n;++l)if(p=b[l],p._is_visible&&p.mesh){this._rendered_instances+=1;q=f._overwrite_material||p.material;if(d==Lb&&q.renderPickingInstance)q.renderPickingInstance(p,a,d);else if(q.renderInstance)q.renderInstance(p,a,d);else continue;if(p.onPostRender)p.onPostRender(a)}if(k.onFinish)k.onFinish(a,d)}this.resetGLState(a);LEvent.trigger(c,"renderScreenSpace",a);this.resetGLState(a);LEvent.trigger(c,"afterRenderInstances",a);LEvent.trigger(this,"afterRenderInstances",a);this.resetGLState(a);return this._rendered_instances-
e},renderGUI:function(a){gl.viewport(this._full_viewport[0],this._full_viewport[1],this._full_viewport[2],this._full_viewport[3]);gl.start2D&&gl.start2D();a.render_gui&&LEvent.hasBind(this._current_scene,"renderGUI")&&(e.GUI&&e.GUI.ResetImmediateGUI(),LEvent.trigger(this._current_scene,"renderGUI",gl));if(this.on_render_gui)this.on_render_gui(a);gl.finish2D&&gl.finish2D()},getNearLights:function(a,b){b=b||[];b.length=0;var c=this._visible_lights;if(!c||!c.length)return b;b.length=0;for(var d=c.length,
f=0;f<d;f++){var e=c[f];if(0!=(e.layers&a.layers)&&0!=(e.layers&this._current_camera.layers)&&!(1E-4>e.computeLightIntensity())){var g=e.computeLightRadius(),k=e.position;(-1==g||a.overlapsSphere(k,g))&&b.push(e)}}return b},regenerateShadowmaps:function(a,b){a=a||this._current_scene;b=b||this.default_render_settings;LEvent.trigger(a,"renderShadows",b);for(var c=0;c<this._visible_lights.length;++c)this._visible_lights[c].prepare(b)},mergeSamplers:function(a,b){b=b||[];b.length=this._max_texture_units;
for(var c=0;c<b.length;++c)for(var d=a.length-1;0<=d;--d)if(a[d][c]){b[c]=a[d][c];break}return b},clearSamplers:function(){for(var a=0;a<this._max_texture_units;++a)gl.activeTexture(gl.TEXTURE0+a),gl.bindTexture(gl.TEXTURE_2D,null),gl.bindTexture(gl.TEXTURE_CUBE_MAP,null),this._active_samples[a]=null},bindSamplers:function(a){if(a)for(var b=this.allow_textures,c=0;c<a.length;++c){var d=a[c];if(d){var f=null;d.constructor===String||d.constructor===GL.Texture?(f=d,d=null):d.texture&&(f=d.texture);f&&
f.constructor===String&&(f=e.ResourcesManager.textures[f]);b||(f=null);if(!f)if(d)switch(d.missing){case "black":f=this._black_texture;break;case "white":f=this._white_texture;break;case "gray":f=this._gray_texture;break;case "normal":f=this._normal_texture;break;default:f=this._missing_texture}else f=this._missing_texture;f._in_current_fbo&&(f=this._missing_texture);f.bind(c);this._active_samples[c]=f;d&&(d.minFilter&&(d.minFilter!==gl.LINEAR_MIPMAP_LINEAR||GL.isPowerOfTwo(f.width)&&GL.isPowerOfTwo(f.height))&&
gl.texParameteri(f.texture_type,gl.TEXTURE_MIN_FILTER,d.minFilter),d.magFilter&&gl.texParameteri(f.texture_type,gl.TEXTURE_MAG_FILTER,d.magFilter),d.wrap&&(gl.texParameteri(f.texture_type,gl.TEXTURE_WRAP_S,d.wrap),gl.texParameteri(f.texture_type,gl.TEXTURE_WRAP_T,d.wrap)),null!=d.anisotropic&&gl.extensions.EXT_texture_filter_anisotropic&&gl.texParameteri(f.texture_type,gl.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,d.anisotropic))}}},fillSceneUniforms:function(a,b){var c=
{u_point_size:this.default_point_size,u_time:a._time||0.001*getTime(),u_ambient_light:a.info.ambient_color,u_viewport:gl.viewport_data};a._uniforms=c;a._samplers=a._samplers||[];a._samplers.length=0;this._global_textures.environment=null;this._global_textures.irradiance=null;for(var d in a.info.textures)if(c=e.getTexture(a.info.textures[d])){var f=0;if("environment"==d)f=e.Renderer.ENVIRONMENT_TEXTURE_SLOT;else if("irradiance"==d)f=e.Renderer.IRRADIANCE_TEXTURE_SLOT;else continue;var h=c.texture_type==
gl.TEXTURE_2D?"_texture":"_cubemap";c.texture_type==gl.TEXTURE_2D&&(c.bind(0),c.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR));a._samplers[f]=c;a._uniforms[d+"_texture"]=f;a._uniforms[d+h]=f;"environment"==d?this._global_textures.environment=c:"irradiance"==d&&(this._global_textures.irradiance=c)}LEvent.trigger(a,"fillSceneUniforms",a._uniforms)},processVisibleData:function(a,b,c,d,f){var h=a._frame;this._current_scene=a;f||(0==this._frame%this._collect_frequency&&a.collectData(c),LEvent.trigger(a,
"afterCollectData",a));c=c&&c.length?c:a._cameras;if(0==c.length)console.error("no cameras found");else{f=this._visible_materials;for(var g=f.length=0,k=c.length;g<k;++g){var m=c[g];m._rendering_index=g;m.prepare();if(m.overwrite_material){var l=m.overwrite_material.constructor===String?e.ResourcesManager.resources[m.overwrite_material]:m.overwrite_material;l&&(m._overwrite_material=l,f.push(l))}else m._overwrite_material=null}this._main_camera||(this._main_camera=c.length?c[0]:new e.Camera);d=d||
a._instances;m=this._main_camera;m=m.getEye(this._temp_cameye);for(g=0;g<this._queues.length;++g)this._queues[g]&&this._queues[g].clear();g=0;for(k=d.length;g<k;++g)if(l=d[g])if(l.mesh){l.material||(l.material=this.default_material);l.material._last_frame_update!=h&&(l.material._last_frame_update=h,f.push(l.material));l._dist=vec3.dist(l.center,m);b.force_wireframe&&l.primitive!=gl.LINES&&(l.primitive=gl.LINES,l.mesh&&(l.mesh.indexBuffers.wireframe||l.mesh.computeWireframe(),l.index_buffer=l.mesh.indexBuffers.wireframe));
var n=l.material.queue,p=null;void 0===n||n===e.RenderQueue.DEFAULT?p=l.material._render_state.blend?this._queues[e.RenderQueue.TRANSPARENT]:this._queues[e.RenderQueue.GEOMETRY]:(p=this._queues[n])||e.Renderer.createRenderQueue(n);p&&(p.add(l),l._camera_visibility=0)}else console.warn("RenderInstance must always have mesh");for(g=0;g<f.length;++g)l=f[g],l._index=g,l.prepare&&l.prepare(a);LEvent.trigger(a,"prepareMaterials");g=0;for(k=d.length;g<k;++g)l=d[g],l.index=g;this._visible_instances=a._instances;
this._visible_lights=a._lights;this._visible_cameras=c;g=0;for(k=this._visible_lights.length;g<k;++g)this._visible_lights[g].prepare(b);LEvent.trigger(a,"afterCollectData",a)}},renderInstancesToRT:function(a,b,c,d){function f(){e.Renderer.clearBuffer(a,c);e.Renderer.renderInstances(c,d)}c=c||this.default_render_settings;this._current_target=b;b._in_current_fbo=!0;b.texture_type==gl.TEXTURE_2D?(this.enableCamera(a,c),b.drawTo(f)):b.texture_type==gl.TEXTURE_CUBE_MAP&&this.renderToCubemap(a.getEye(),
b.width,b,c,a.near,a.far);this._current_target=null;b._in_current_fbo=!1},renderToCubemap:function(a,b,c,d,f,h,g,k){b=b||256;f=f||1;h=h||1E3;if(d&&d.constructor!==e.RenderSettings)throw"render_settings parameter must be LS.RenderSettings.";c&&c.constructor==GL.Texture||(c=null);var m=this._current_scene;m||(m=this._current_scene=e.GlobalScene);var l=this._cubemap_camera;l||(l=this._cubemap_camera=new e.Camera);l.configure({fov:90,aspect:1,near:f,far:h});this._current_target=c=c||new GL.Texture(b,
b,{texture_type:gl.TEXTURE_CUBE_MAP,minFilter:gl.NEAREST});c._in_current_fbo=!0;c.drawTo(function(b,c){var f=e.Camera.cubemap_camera_parameters[c];b._is_shadowmap||!g?gl.clearColor(0,0,0,0):gl.clearColor(g[0],g[1],g[2],g[3]);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);l.configure({eye:a,center:[a[0]+f.dir[0],a[1]+f.dir[1],a[2]+f.dir[2]],up:f.up});e.Renderer.enableCamera(l,d,!0);e.Renderer.renderInstances(d,k,m)});this._current_target=null;c._in_current_fbo=!1;return c},renderMaterialPreview:function(a,
b,c,d){c=c||{};if(a){var f=this._material_scene;if(!f){f=this._material_scene=new e.Scene;f.root.camera.background_color.set([0,0,0,0]);c.environment_texture&&(f.info.textures.environment=c.environment_texture);var h=new e.SceneNode("sphere"),g=new e.Components.GeometricPrimitive({size:40,subdivisions:50,geometry:e.Components.GeometricPrimitive.SPHERE});h.addComponent(g);f.root.addChild(h)}this._preview_material_render_settings||(this._preview_material_render_settings=new e.RenderSettings({skip_viewport:!0,
render_helpers:!1,update_materials:!0}));var k=this._preview_material_render_settings;c.background_color&&f.root.camera.background_color.set(c.background_color);h=f.getNode("sphere");if(!h)return console.error("Node not found in Material Preview Scene"),null;c.rotate&&(h.transform.reset(),h.transform.rotateY(c.rotate));g=null;a.constructor===String?g=a:(g=new a.constructor,g.configure(a.serialize()));h.material=g;if(c.to_viewport)e.Renderer.renderFrame(f.root.camera,k,f);else return a=this._material_preview_texture||
new GL.Texture(b,b),this._material_preview_texture||(this._material_preview_texture=a),a.drawTo(function(){e.Renderer.renderFrame(f.root.camera,k,f)}),d=a.toCanvas(d,!0)}else console.error("No material provided to renderMaterialPreview")},getCameraAtPosition:function(a,b,c){c=c||this._visible_cameras;if(!c||!c.length)return null;for(var d=c.length-1;0<=d;--d){var f=c[d];if(f.enabled&&!f.render_to_texture&&f.isPointInCamera(a,b))return f}return null},createRenderQueue:function(a,b,c){if(void 0===a)throw"RenderQueue must have index";
b=new e.RenderQueue(b);this._queues[a]&&console.warn("There is already a RenderQueue in slot ",a);this._queues[a]=b;if(c)for(var d in c)b[d]=c[d]},setRenderPass:function(a){a||(a=hb);this._current_pass=a},enableFrameShaderBlock:function(a,b){var c=a.constructor===e.ShaderBlock?a:e.Shaders.getShaderBlock(a);if(c&&!(this._global_shader_blocks_flags&c.flag_mask)&&(this._global_shader_blocks.push(c),this._global_shader_blocks_flags|=c.flag_mask,b))for(var d in b)this._render_uniforms[d]=b[d]},blit:function(a,
b,c,d){if(!a||!b)throw"data missing in blit";if(a!=b)b.drawTo(function(){a.toViewport(c,d)});else{if(!c)throw"blitting texture to the same texture doesnt makes sense unless a shader is specified";b=GL.Texture.getTemporary(a.width,a.height,a);a.copyTo(b);b.copyTo(a,c,d);GL.Texture.releaseTemporary(b)}}};e.Renderer=Mb;Qa.prototype.enable=function(a){this._in_scene||(a=a||e.GlobalScene,LEvent.bind(a,"afterRenderInstances",this.onRender,this),this._in_scene=a)};Qa.prototype.disable=function(a){this._in_scene&&
(LEvent.unbind(this._in_scene,"afterRenderInstances",this.onRender,this),this._in_scene=null)};Qa.prototype.onRender=function(a,b){this.render(e.Renderer._current_camera)};Qa.prototype.render=function(a,b,c){var d=this.settings;c=c||e.GlobalScene;gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.enable(gl.DEPTH_TEST);gl.disable(gl.BLEND);gl.disable(gl.CULL_FACE);gl.depthFunc(gl.LEQUAL);var f=null;d.render_grid&&0<d.grid_alpha&&this.renderGrid();d.render_origin&&(e.Draw.setColor([0.3,0.3,0.3,1]),
e.Draw.push(),e.Draw.scale(0.01,0.01,0.01),e.Draw.rotate(-90,[1,0,0]),gl.blendFunc(gl.SRC_ALPHA,gl.ONE),e.Draw.renderText("Origin"),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),e.Draw.pop());if(d.render_components)for(var h=0,g=c._nodes.length;h<g;++h){var k=c._nodes[h],m=k._is_selected,f=k;k.renderEditor&&k.renderEditor(m);for(var l=0,n=k._components.length;l<n;++l){var p=k._components[l],q=!1;b&&(q=b(p));p.renderEditor&&p.renderEditor(m,q)}}b=vec3.create();h=0;for(g=c._nodes.length;h<g;++h)k=
c._nodes[h],!k._is_root&&k.flags.visible&&(m=k.transform?k.transform.getGlobalMatrixRef():mat4.create(),l=mat4.multiplyVec3(vec3.create(),m,b),d.render_null_nodes&&(k._is_selected?this.renderPoint(l,!0,this.colors.selected):k._is_bone?this.renderPoint(l,!0,this.colors.bone):this.renderPoint(l,!1,this.colors.node)),d.render_names&&this.renderText(l,k.name,k._is_selected?[0.94,0.8,0.4,1]:[0.8,0.8,0.8,0.9]),k._parentNode&&k._parentNode.transform&&(d.render_tree||d.render_skeletons&&k._is_bone&&k._parentNode._is_bone)&&
this.renderLine(l,k._parentNode.transform.getGlobalPosition(),this.colors.bone),d.render_axis&&(e.Draw.push(),e.Draw.multMatrix(m),e.Draw.setColor([1,1,1,1]),e.Draw.renderMesh(this.axis_mesh,gl.LINES),e.Draw.pop()));d.render_colliders&&this.renderColliders(c);d.render_paths&&this.renderPaths(c);this._points.length&&(e.Draw.setPointSize(4),e.Draw.setColor([1,1,1,1]),e.Draw.renderPoints(this._points,this._points_color),this._points.length=0,this._points_color.length=0);this._points_nodepth.length&&
(e.Draw.setPointSize(4),e.Draw.setColor([1,1,1,1]),gl.disable(gl.DEPTH_TEST),e.Draw.renderPoints(this._points_nodepth,this._points_color_nodepth),gl.enable(gl.DEPTH_TEST),this._points_nodepth.length=0,this._points_color_nodepth.length=0);this._lines.length&&(gl.disable(gl.DEPTH_TEST),e.Draw.setColor([1,1,1,1]),e.Draw.renderLines(this._lines,this._lines_color),gl.enable(gl.DEPTH_TEST),this._lines.length=0,this._lines_color.length=0);this.debug_points.length&&(e.Draw.setPointSize(5),e.Draw.setColor([1,
0,1,1]),e.Draw.renderPoints(this.debug_points));if(d.render_names&&gl.start2D){gl.disable(gl.DEPTH_TEST);h=this.camera2D;c=gl.getViewport();h.setOrthographic(0,c[2],0,c[3],-1,1);h.updateMatrices();gl.start2D();gl.font="14px Arial";g=vec4.fromValues(0,0,0,0.5);for(h=0;h<this._names.length;++h)k=a.project(this._names[h][1]),0>k[2]||(k[2]=0,b=gl.measureText(this._names[h][0]),gl.fillColor=g,gl.fillRect(Math.floor(k[0]+10),c[3]-Math.floor(k[1]+8),b.width,b.height),gl.fillColor=this._names[h][2],gl.fillText(this._names[h][0],
Math.floor(k[0]+10),c[3]-Math.floor(k[1]-4)));gl.finish2D();this._names.length=0}d.render_axis&&f&&(e.Draw.push(),a=f.transform.getGlobalRotation(),a=mat4.fromQuat(mat4.create(),a),e.Draw.setMatrix(a),e.Draw.setColor([1,1,1,1]),e.Draw.scale(10,10,10),e.Draw.renderMesh(this.axis_mesh,gl.LINES),e.Draw.pop());gl.depthFunc(gl.LESS)};Qa.prototype.renderPoint=function(a,b,c){c=c||[1,1,1,1];b?(this._points_nodepth.push(a[0],a[1],a[2]),this._points_color_nodepth.push(c[0],c[1],c[2],c[3])):(this._points.push(a[0],
a[1],a[2]),this._points_color.push(c[0],c[1],c[2],c[3]))};Qa.prototype.renderLine=function(a,b,c){c=c||[1,1,1,1];this._lines.push(a,b);this._lines_color.push(c,c)};Qa.prototype.renderText=function(a,b,c){c=c||[1,1,1,1];this._names.push([b,a,c])};Qa.prototype.renderGrid=function(){var a=this.settings;this.grid_shader||(this.grid_shader=e.Draw.createSurfaceShader("vec2 f = vec2(1.0/64.0,-1.0/64.0); float brightness = texture2D(u_texture, pos.xz + f).x * 0.6 + texture2D(u_texture, pos.xz * 0.1 + f ).x * 0.3 + texture2D(u_texture, pos.xz * 0.01 + f ).x * 0.2; brightness /= max(1.0,0.001 * length(u_camera_position.xz - pos.xz));vec4 color = u_color * vec4(vec3(1.0),brightness); if( abs(pos.x) < 0.1 ) color = mix(vec4(0.4,0.4,1.0,0.5),color,abs(pos.x/0.1)); if( abs(pos.z) < 0.1 ) color = mix(vec4(1.0,0.4,0.4,0.5),color,abs(pos.z/0.1)); return color;"),
this.grid_shader_xy=e.Draw.createSurfaceShader("vec2 f = vec2(1.0/64.0,-1.0/64.0); float brightness = texture2D(u_texture, pos.xy + f).x * 0.6 + texture2D(u_texture, pos.xy * 0.1 + f ).x * 0.3 + texture2D(u_texture, pos.xy * 0.01 + f ).x * 0.2; brightness /= max(1.0,0.001 * length(u_camera_position.xy - pos.xy));vec4 color = u_color * vec4(vec3(1.0),brightness);  if( abs(pos.x) < 0.025 ) color *= vec4(0.4,1.0,0.4,1.0); if( abs(pos.y) < 0.025 ) color *= vec4(1.0,0.4,0.4,1.0); return color;"),this.grid_shader_yz=
e.Draw.createSurfaceShader("vec2 f = vec2(1.0/64.0,-1.0/64.0); float brightness = texture2D(u_texture, pos.yz + f).x * 0.6 + texture2D(u_texture, pos.yz * 0.1 + f ).x * 0.3 + texture2D(u_texture, pos.yz * 0.01 + f ).x * 0.2; brightness /= max(1.0,0.001 * length(u_camera_position.yz - pos.yz)); vec4 color = u_color * vec4(vec3(1.0),brightness);  if( abs(pos.y) < 0.025 ) color *= vec4(0.4, 0.4, 1.0, 1.0); if( abs(pos.z) < 0.025 ) color *= vec4(0.4,1.0,0.4,1.0); return color;"),this.grid_shader.uniforms({u_texture:0}),
this.grid_texture=this.grid_img&&this.grid_img.loaded?GL.Texture.fromImage(this.grid_img,{format:gl.RGB,wrap:gl.REPEAT,anisotropic:4,minFilter:gl.LINEAR_MIPMAP_LINEAR}):GL.Texture.fromURL(this.grid_texture_url,{format:gl.RGB,wrap:gl.REPEAT,anisotropic:4,minFilter:gl.LINEAR_MIPMAP_LINEAR}));e.Draw.push();"xy"==a.grid_plane?e.Draw.rotate(90,1,0,0):"yz"==a.grid_plane&&e.Draw.rotate(90,0,0,1);this.grid_texture&&!1!==this.grid_texture.ready?(gl.enable(gl.BLEND),this.grid_texture.bind(0),gl.depthMask(!1),
e.Draw.setColor([1,1,1,this.settings.grid_alpha]),e.Draw.translate(e.Draw.camera_position[0],0,e.Draw.camera_position[2]),e.Draw.scale(1E4,1E4,1E4),e.Draw.renderMesh(this.plane_mesh,gl.TRIANGLES,"xy"==a.grid_plane?this.grid_shader_xy:"yz"==a.grid_plane?this.grid_shader_yz:this.grid_shader),gl.depthMask(!0)):(e.Draw.setColor([0.2,0.2,0.2,0.75]),e.Draw.scale(1,1,1),e.Draw.renderMesh(this.grid_mesh,gl.LINES),e.Draw.scale(10,10,10),e.Draw.renderMesh(this.grid_mesh,gl.LINES));e.Draw.pop()};Qa.prototype.renderColliders=
function(a){a=a||e.GlobalScene;if(a._colliders){e.Draw.setColor([0.33,0.71,0.71,0.5]);for(var b=0;b<a._colliders.length;++b){var c=a._colliders[b],d=c.oobb;if(this.settings.render_colliders_aabb){var f=c.aabb;e.Draw.push();var h=BBox.getCenter(f),f=BBox.getHalfsize(f);e.Draw.translate(h);e.Draw.renderWireBox(2*f[0],2*f[1],2*f[2]);e.Draw.pop()}e.Draw.push();e.Draw.multMatrix(c.matrix);f=BBox.getHalfsize(d);c.type==e.PhysicsInstance.BOX?(e.Draw.translate(BBox.getCenter(d)),e.Draw.renderWireBox(2*f[0],
2*f[1],2*f[2])):c.type==e.PhysicsInstance.SPHERE?(e.Draw.translate(BBox.getCenter(d)),e.Draw.renderWireSphere(f[0],20)):c.type==e.PhysicsInstance.MESH&&(c=c.mesh)&&(c.indexBuffers.wireframe||c.computeWireframe(),e.Draw.renderMesh(c,gl.LINES,null,"wireframe"));e.Draw.pop()}}};Qa.prototype.renderPaths=function(a){a=a||e.GlobalScene;if(a._paths){e.Draw.setColor([0.7,0.6,0.3,0.5]);for(var b=0;b<a._paths.length;++b){var c=a._paths[b].samplePoints(0);e.Draw.renderLines(c,null,!0)}}};Qa.prototype.createMeshes=
function(){this.plane_mesh=GL.Mesh.plane({xz:!0});for(var a=10,b=[],c=-10;10>=c;c++)b.push([c*a,0,10*a]),b.push([c*a,0,10*-a]),b.push([10*a,0,c*a]),b.push([10*-a,0,c*a]);this.grid_mesh=GL.Mesh.load({vertices:b});b=new Float32Array([-1,1,1,-1,1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1]);c=new Uint16Array([0,1,0,4,0,3,1,2,1,5,2,3,2,6,3,7,4,5,4,7,6,7,5,6]);this.box_mesh=GL.Mesh.load({vertices:b,lines:c});this.circle_mesh=GL.Mesh.circle({size:1,slices:50});this.circle_empty_mesh=GL.Mesh.circle({size:1,
slices:50,empty:1});this.sphere_mesh=GL.Mesh.icosahedron({size:1,subdivisions:3});b=[];b.push([0.5*-a,0,0],[0.5*+a,0,0]);b.push([0,0.5*-a,0],[0,0.5*+a,0]);b.push([0,0,0.5*-a],[0,0,0.5*+a]);this.dummy_mesh=GL.Mesh.load({vertices:b});b=[];b.push([-1,1,1],[1,1,1],[-1,1,-1],[1,1,-1],[-1,-1,1],[1,-1,1],[-1,-1,-1],[1,-1,-1]);b.push([1,-1,1],[1,1,1],[1,-1,-1],[1,1,-1],[-1,-1,1],[-1,1,1],[-1,-1,-1],[-1,1,-1]);b.push([1,1,1],[1,1,-1],[1,-1,1],[1,-1,-1],[-1,1,1],[-1,1,-1],[-1,-1,1],[-1,-1,-1]);this.cube_mesh=
GL.Mesh.load({vertices:b});for(c=1;0<=c;c-=0.02)a=2*(1-0.001/c)-1,b.push([-1,1,a],[1,1,a],[-1,-1,a],[1,-1,a]),b.push([1,-1,a],[1,1,a],[-1,-1,a],[-1,1,a]);this.frustum_mesh=GL.Mesh.load({vertices:b});this.cylinder_mesh=GL.Mesh.cylinder({radius:10,height:2});b=[];c=[];a=2;b.push([0,0,0],[0.5*+a,0,0]);c.push([1,0,0,1],[1,0,0,1]);b.push([0,0,0],[0,0.5*+a,0]);c.push([0,1,0,1],[0,1,0,1]);b.push([0,0,0],[0,0,0.5*+a]);c.push([0,0,1,1],[0,0,1,1]);this.axis_mesh=GL.Mesh.load({vertices:b,colors:c});b=[];b.push([0,
0,0],[0,0.5*+a,0]);b.push([0,0.5*+a,0],[0.1*a,0.4*+a,0]);b.push([0,0.5*+a,0],[-0.1*a,0.4*+a,0]);this.top_line_mesh=GL.Mesh.load({vertices:b});b=[];b.push([0,0,0],[0,0,0.5*+a]);b.push([0,0,0.5*+a],[0,0.1*a,0.4*+a]);b.push([0,0,0.5*+a],[0,-0.1*a,0.4*+a]);this.front_line_mesh=GL.Mesh.load({vertices:b})};e.DebugRender=Qa;var kb={ready:!1,images:{},image_last_id:1,onRequestFrame:null,reset_stack_on_reset:!0,_rendercalls:0,init:function(){if(!this.ready&&gl){this.color=new Float32Array(4);this.color[3]=
1;this.mvp_matrix=mat4.create();this.temp_matrix=mat4.create();this.point_size=2;this.line_width=1;this.stack=new Float32Array(512);this.model_matrix=new Float32Array(this.stack.buffer,0,16);mat4.identity(this.model_matrix);this.camera=null;this.camera_position=vec3.create();this.view_matrix=mat4.create();this.projection_matrix=mat4.create();this.viewprojection_matrix=mat4.create();this.camera_stack=[];this.uniforms={u_model:this.model_matrix,u_viewprojection:this.viewprojection_matrix,u_mvp:this.mvp_matrix,
u_color:this.color,u_camera_position:this.camera_position,u_point_size:this.point_size,u_point_perspective:0,u_perspective:1,u_texture:0};this._temp=vec3.create();this.quad_mesh=GL.Mesh.load({vertices:[[-1,1,0],[1,1,0],[1,-1,0],[-1,-1,0]],coords:[[0,1],[1,1],[1,0],[0,0]]});this.shader=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\t#ifdef USE_INSTANCING\n\t\t\t\tattribute mat4 u_model;\n\t\t\t#else\n\t\t\t\tuniform mat4 u_model;\n\t\t\t#endif\n\t\t\tuniform mat4 u_viewprojection;\n\t\t\tuniform float u_point_size;\n\t\t\tuniform float u_perspective;\n\t\t\tuniform float u_point_perspective;\n\t\t\tfloat computePointSize(float radius, float w)\n\t\t\t{\n\t\t\t\tif(radius < 0.0)\n\t\t\t\t\treturn -radius;\n\t\t\t\treturn u_perspective * radius / w;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tvec3 vertex = ( u_model * vec4( a_vertex, 1.0 )).xyz;\n\t\t\t\tgl_Position = u_viewprojection * vec4(vertex,1.0);\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\tif(u_point_perspective != 0.0)\n\t\t\t\t\tgl_PointSize = computePointSize( gl_PointSize, gl_Position.w );\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t");
this.shader_instancing=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\t#ifdef USE_INSTANCING\n\t\t\t\tattribute mat4 u_model;\n\t\t\t#else\n\t\t\t\tuniform mat4 u_model;\n\t\t\t#endif\n\t\t\tuniform mat4 u_viewprojection;\n\t\t\tuniform float u_point_size;\n\t\t\tuniform float u_perspective;\n\t\t\tuniform float u_point_perspective;\n\t\t\tfloat computePointSize(float radius, float w)\n\t\t\t{\n\t\t\t\tif(radius < 0.0)\n\t\t\t\t\treturn -radius;\n\t\t\t\treturn u_perspective * radius / w;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tvec3 vertex = ( u_model * vec4( a_vertex, 1.0 )).xyz;\n\t\t\t\tgl_Position = u_viewprojection * vec4(vertex,1.0);\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\tif(u_point_perspective != 0.0)\n\t\t\t\t\tgl_PointSize = computePointSize( gl_PointSize, gl_Position.w );\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t",
{USE_INSTANCING:""});this.shader_color=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\t#ifdef USE_INSTANCING\n\t\t\t\tattribute mat4 u_model;\n\t\t\t#else\n\t\t\t\tuniform mat4 u_model;\n\t\t\t#endif\n\t\t\tuniform mat4 u_viewprojection;\n\t\t\tuniform float u_point_size;\n\t\t\tuniform float u_perspective;\n\t\t\tuniform float u_point_perspective;\n\t\t\tfloat computePointSize(float radius, float w)\n\t\t\t{\n\t\t\t\tif(radius < 0.0)\n\t\t\t\t\treturn -radius;\n\t\t\t\treturn u_perspective * radius / w;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tvec3 vertex = ( u_model * vec4( a_vertex, 1.0 )).xyz;\n\t\t\t\tgl_Position = u_viewprojection * vec4(vertex,1.0);\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\tif(u_point_perspective != 0.0)\n\t\t\t\t\tgl_PointSize = computePointSize( gl_PointSize, gl_Position.w );\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t",
{USE_COLOR:""});this.shader_color_instancing=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\t#ifdef USE_INSTANCING\n\t\t\t\tattribute mat4 u_model;\n\t\t\t#else\n\t\t\t\tuniform mat4 u_model;\n\t\t\t#endif\n\t\t\tuniform mat4 u_viewprojection;\n\t\t\tuniform float u_point_size;\n\t\t\tuniform float u_perspective;\n\t\t\tuniform float u_point_perspective;\n\t\t\tfloat computePointSize(float radius, float w)\n\t\t\t{\n\t\t\t\tif(radius < 0.0)\n\t\t\t\t\treturn -radius;\n\t\t\t\treturn u_perspective * radius / w;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tvec3 vertex = ( u_model * vec4( a_vertex, 1.0 )).xyz;\n\t\t\t\tgl_Position = u_viewprojection * vec4(vertex,1.0);\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\tif(u_point_perspective != 0.0)\n\t\t\t\t\tgl_PointSize = computePointSize( gl_PointSize, gl_Position.w );\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t",
{USE_COLOR:"",USE_INSTANCING:""});this.shader_texture=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\t#ifdef USE_INSTANCING\n\t\t\t\tattribute mat4 u_model;\n\t\t\t#else\n\t\t\t\tuniform mat4 u_model;\n\t\t\t#endif\n\t\t\tuniform mat4 u_viewprojection;\n\t\t\tuniform float u_point_size;\n\t\t\tuniform float u_perspective;\n\t\t\tuniform float u_point_perspective;\n\t\t\tfloat computePointSize(float radius, float w)\n\t\t\t{\n\t\t\t\tif(radius < 0.0)\n\t\t\t\t\treturn -radius;\n\t\t\t\treturn u_perspective * radius / w;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tvec3 vertex = ( u_model * vec4( a_vertex, 1.0 )).xyz;\n\t\t\t\tgl_Position = u_viewprojection * vec4(vertex,1.0);\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\tif(u_point_perspective != 0.0)\n\t\t\t\t\tgl_PointSize = computePointSize( gl_PointSize, gl_Position.w );\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t",
{USE_TEXTURE:""});this.shader_texture_instancing=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\t#ifdef USE_INSTANCING\n\t\t\t\tattribute mat4 u_model;\n\t\t\t#else\n\t\t\t\tuniform mat4 u_model;\n\t\t\t#endif\n\t\t\tuniform mat4 u_viewprojection;\n\t\t\tuniform float u_point_size;\n\t\t\tuniform float u_perspective;\n\t\t\tuniform float u_point_perspective;\n\t\t\tfloat computePointSize(float radius, float w)\n\t\t\t{\n\t\t\t\tif(radius < 0.0)\n\t\t\t\t\treturn -radius;\n\t\t\t\treturn u_perspective * radius / w;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tvec3 vertex = ( u_model * vec4( a_vertex, 1.0 )).xyz;\n\t\t\t\tgl_Position = u_viewprojection * vec4(vertex,1.0);\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\tif(u_point_perspective != 0.0)\n\t\t\t\t\tgl_PointSize = computePointSize( gl_PointSize, gl_Position.w );\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t",
{USE_TEXTURE:"",USE_INSTANCING:""});this.shader_points=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\t#ifdef USE_INSTANCING\n\t\t\t\tattribute mat4 u_model;\n\t\t\t#else\n\t\t\t\tuniform mat4 u_model;\n\t\t\t#endif\n\t\t\tuniform mat4 u_viewprojection;\n\t\t\tuniform float u_point_size;\n\t\t\tuniform float u_perspective;\n\t\t\tuniform float u_point_perspective;\n\t\t\tfloat computePointSize(float radius, float w)\n\t\t\t{\n\t\t\t\tif(radius < 0.0)\n\t\t\t\t\treturn -radius;\n\t\t\t\treturn u_perspective * radius / w;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tvec3 vertex = ( u_model * vec4( a_vertex, 1.0 )).xyz;\n\t\t\t\tgl_Position = u_viewprojection * vec4(vertex,1.0);\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\tif(u_point_perspective != 0.0)\n\t\t\t\t\tgl_PointSize = computePointSize( gl_PointSize, gl_Position.w );\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t",
{USE_POINTS:""});this.shader_points_color=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\t#ifdef USE_INSTANCING\n\t\t\t\tattribute mat4 u_model;\n\t\t\t#else\n\t\t\t\tuniform mat4 u_model;\n\t\t\t#endif\n\t\t\tuniform mat4 u_viewprojection;\n\t\t\tuniform float u_point_size;\n\t\t\tuniform float u_perspective;\n\t\t\tuniform float u_point_perspective;\n\t\t\tfloat computePointSize(float radius, float w)\n\t\t\t{\n\t\t\t\tif(radius < 0.0)\n\t\t\t\t\treturn -radius;\n\t\t\t\treturn u_perspective * radius / w;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tvec3 vertex = ( u_model * vec4( a_vertex, 1.0 )).xyz;\n\t\t\t\tgl_Position = u_viewprojection * vec4(vertex,1.0);\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\tif(u_point_perspective != 0.0)\n\t\t\t\t\tgl_PointSize = computePointSize( gl_PointSize, gl_Position.w );\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t",
{USE_COLOR:"",USE_POINTS:""});this.shader_points_color_size=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tattribute vec4 a_color;\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tattribute vec2 a_coord;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t#endif\n\t\t\t#ifdef USE_SIZE\n\t\t\t\tattribute float a_extra;\n\t\t\t#endif\n\t\t\t#ifdef USE_INSTANCING\n\t\t\t\tattribute mat4 u_model;\n\t\t\t#else\n\t\t\t\tuniform mat4 u_model;\n\t\t\t#endif\n\t\t\tuniform mat4 u_viewprojection;\n\t\t\tuniform float u_point_size;\n\t\t\tuniform float u_perspective;\n\t\t\tuniform float u_point_perspective;\n\t\t\tfloat computePointSize(float radius, float w)\n\t\t\t{\n\t\t\t\tif(radius < 0.0)\n\t\t\t\t\treturn -radius;\n\t\t\t\treturn u_perspective * radius / w;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t\tv_coord = a_coord;\n\t\t\t\t#endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tv_color = a_color;\n\t\t\t\t#endif\n\t\t\t\tvec3 vertex = ( u_model * vec4( a_vertex, 1.0 )).xyz;\n\t\t\t\tgl_Position = u_viewprojection * vec4(vertex,1.0);\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\t#ifdef USE_SIZE\n\t\t\t\t\tgl_PointSize = a_extra;\n\t\t\t\t#endif\n\t\t\t\tif(u_point_perspective != 0.0)\n\t\t\t\t\tgl_PointSize = computePointSize( gl_PointSize, gl_Position.w );\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\t#ifdef USE_COLOR\n\t\t\t\tvarying vec4 v_color;\n\t\t\t#endif\n\t\t\t#ifdef USE_TEXTURE\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec4 color = u_color;\n\t\t\t\t#ifdef USE_TEXTURE\n\t\t\t\t  color *= texture2D(u_texture, v_coord);\n\t\t\t\t  if(color.a < 0.1)\n\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_POINTS\n\t\t\t\t    float dist = length( gl_PointCoord.xy - vec2(0.5) );\n\t\t\t\t\tif( dist > 0.45 )\n\t\t\t\t\t\tdiscard;\n\t\t\t    #endif\n\t\t\t\t#ifdef USE_COLOR\n\t\t\t\t\tcolor *= v_color;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\t\t",
{USE_COLOR:"",USE_SIZE:"",USE_POINTS:""});this.shader_image=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvoid main() {\n\t\t\t  vec4 tex = texture2D(u_texture, vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y) );\n\t\t\t  if(tex.a < 0.01)\n\t\t\t\tdiscard;\n\t\t\t  gl_FragColor = u_color * tex;\n\t\t\t}\t\t");
this.shader_points_color_texture_size=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec4 a_color;\n\t\t\tattribute float a_extra;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvarying vec4 v_color;\n\t\t\tvoid main() {\n\t\t\t\tv_color = a_color;\n\t\t\t\tgl_PointSize = u_point_size * a_extra;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec4 v_color;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvoid main() {\n\t\t\t  vec4 tex = texture2D(u_texture, vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y) );\n\t\t\t  if(tex.a < 0.1)\n\t\t\t\tdiscard;\n\t\t\t  vec4 color = u_color * v_color * tex;\n\t\t\t  gl_FragColor = color;\n\t\t\t}\t\t");
this.shader_text2D=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec4 a_extra4;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform float u_point_size;\n\t\t\tvoid main() {\n\t\t\t\tgl_PointSize = u_point_size;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvoid main() {\n\t\t\t  vec4 tex = texture2D(u_texture, vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y) );\n\t\t\t  if(tex.a < 0.1)\n\t\t\t\tdiscard;\n\t\t\t  vec4 color = u_color * tex;\n\t\t\t  gl_FragColor = color;\n\t\t\t}\t\t");
this.shader_phong=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec3 a_normal;\n\t\t\tvarying vec3 v_pos;\n\t\t\tvarying vec3 v_normal;\n\t\t\t#ifdef USE_INSTANCING\n\t\t\t\tattribute mat4 u_model;\n\t\t\t#else\n\t\t\t\tuniform mat4 u_model;\n\t\t\t#endif\n\t\t\tuniform mat4 u_viewprojection;\n\t\t\tvoid main() {\n\t\t\t\tv_pos = ( u_model * vec4( a_vertex, 1.0 )).xyz;\n\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\t\t\tgl_Position = u_viewprojection * vec4( v_pos, 1.0 );\n\t\t\t}\n",
"\n\t\t\tprecision mediump float;\n\t\t\tuniform vec3 u_ambient_color;\n\t\t\tuniform vec3 u_light_color;\n\t\t\tuniform vec3 u_light_dir;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec3 v_pos;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvoid main() {\n\t\t\t\tvec3 N = normalize(v_normal);\n\t\t\t\tfloat NdotL = max(0.0, dot(N,u_light_dir));\n\t\t\t\tgl_FragColor = u_color * vec4(u_ambient_color + u_light_color * NdotL, 1.0);\n\t\t\t}\n");this.shader_phong_instanced=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec3 a_normal;\n\t\t\tvarying vec3 v_pos;\n\t\t\tvarying vec3 v_normal;\n\t\t\t#ifdef USE_INSTANCING\n\t\t\t\tattribute mat4 u_model;\n\t\t\t#else\n\t\t\t\tuniform mat4 u_model;\n\t\t\t#endif\n\t\t\tuniform mat4 u_viewprojection;\n\t\t\tvoid main() {\n\t\t\t\tv_pos = ( u_model * vec4( a_vertex, 1.0 )).xyz;\n\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\t\t\tgl_Position = u_viewprojection * vec4( v_pos, 1.0 );\n\t\t\t}\n",
"\n\t\t\tprecision mediump float;\n\t\t\tuniform vec3 u_ambient_color;\n\t\t\tuniform vec3 u_light_color;\n\t\t\tuniform vec3 u_light_dir;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec3 v_pos;\n\t\t\tvarying vec3 v_normal;\n\t\t\tvoid main() {\n\t\t\t\tvec3 N = normalize(v_normal);\n\t\t\t\tfloat NdotL = max(0.0, dot(N,u_light_dir));\n\t\t\t\tgl_FragColor = u_color * vec4(u_ambient_color + u_light_color * NdotL, 1.0);\n\t\t\t}\n",{USE_INSTANCING:""});var a={u_ambient_color:[0.1,0.1,0.1],u_light_color:[0.8,
0.8,0.8],u_light_dir:[0,1,0]};this.shader_phong.uniforms(a);this.shader_phong_instanced.uniforms(a);this.shader_depth=new Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tvarying vec4 v_pos;\n\t\t\tuniform mat4 u_model;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() {\n\t\t\t\tv_pos = u_model * vec4(a_vertex,1.0);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t","\t\t\tprecision mediump float;\n\t\t\tvarying vec4 v_pos;\n\t\t\t\n\t\t\tvec4 PackDepth32(float depth)\n\t\t\t{\n\t\t\t\tconst vec4 bitSh  = vec4(   256*256*256, 256*256,   256,         1);\n\t\t\t\tconst vec4 bitMsk = vec4(   0,      1.0/256.0,    1.0/256.0,    1.0/256.0);\n\t\t\t\tvec4 comp;\n\t\t\t\tcomp\t= depth * bitSh;\n\t\t\t\tcomp\t= fract(comp);\n\t\t\t\tcomp\t-= comp.xxyz * bitMsk;\n\t\t\t\treturn comp;\n\t\t\t}\n\t\t\tvoid main() {\n\t\t\t\tfloat depth = (v_pos.z / v_pos.w) * 0.5 + 0.5;\n\t\t\t\tgl_FragColor = PackDepth32(depth);\n\t\t\t}\t\t");
this.ready=!0}},createSurfaceShader:function(a,b,c){-1==a.indexOf("surface_function")&&(a="vec4 surface_function( vec3 pos, vec3 normal, vec2 coord ) { "+a+"\n } ");if(b)if(b.constructor===String)a=b+";\n"+a;else for(var d in b)a+="uniform "+b[d]+" "+d+";\n";return new GL.Shader("\t\t\tprecision mediump float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec3 a_normal;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvarying vec3 v_pos;\n\t\t\tvarying vec3 v_normal;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tuniform mat4 u_model;\n\t\t\tvoid main() {\n\t\t\t\tv_coord = a_coord;\n\t\t\t\tv_pos = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t",
"\t\t\tprecision mediump float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvarying vec3 v_pos;\n\t\t\tvarying vec3 v_normal;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform vec3 u_camera_position;\n\t\t\tuniform sampler2D u_texture;\n\t\t\t"+a+"\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = surface_function(v_pos,v_normal,v_coord);\n\t\t\t}\t\t",c)},reset:function(a){this.ready?(this.color.set([1,1,1,1]),this.point_size=2,this.line_width=1):this.init();a&&(this.images={});this.reset_stack_on_reset&&(this.model_matrix=
new Float32Array(this.stack.buffer,0,16),this.uniforms.u_model=this.model_matrix,mat4.identity(this.model_matrix))},setColor:function(a){if(3<=arguments.length)this.color[0]=arguments[0],this.color[1]=arguments[1],this.color[2]=arguments[2],4==arguments.length&&(this.color[3]=arguments[3]);else for(var b=0;b<a.length;b++)this.color[b]=a[b]},setAlpha:function(a){this.color[3]=a},setPointSize:function(a,b){this.point_size=a;this.uniforms.u_point_size=a;this.uniforms.u_point_perspective=b?1:0},setLineWidth:function(a){gl.setLineWidth?
gl.setLineWidth(a):gl.lineWidth(a);this.line_width=a},setCamera:function(a){this.camera=a;a.updateMatrices();vec3.copy(this.camera_position,a.getEye());this.view_matrix.set(a._view_matrix);this.projection_matrix.set(a._projection_matrix);this.viewprojection_matrix.set(a._viewprojection_matrix);this.uniforms.u_perspective=gl.viewport_data[3]*this.projection_matrix[5]},setCameraPosition:function(a){vec3.copy(this.camera_position,a)},pushCamera:function(){this.camera_stack.push(mat4.create(this.viewprojection_matrix))},
popCamera:function(){if(0==this.camera_stack.length)throw"too many pops";this.viewprojection_matrix.set(this.camera_stack.pop())},setViewProjectionMatrix:function(a,b,c){mat4.copy(this.view_matrix,a);mat4.copy(this.projection_matrix,b);c?mat4.copy(this.viewprojection_matrix,c):mat4.multiply(this.viewprojection_matrix,a,c)},setMatrix:function(a){mat4.copy(this.model_matrix,a)},multMatrix:function(a){mat4.multiply(this.model_matrix,a,this.model_matrix)},renderLines:function(a,b,c,d){if(a&&a.length){var f=
null,f=a.constructor==Float32Array?a:this.linearize(a);b&&(b=b.constructor==Float32Array?b:this.linearize(b));b&&b.length/4!=f.length/3&&(b=null);a=gl.LINES;d?a=gl.LINE_LOOP:c&&(a=gl.LINE_STRIP);c=this.toGlobalMesh({vertices:f,colors:b});return this.renderMesh(c,a,b?this.shader_color:this.shader,void 0,0,f.length/3)}},renderPoints:function(a,b,c){if(a&&a.length){var d=null,d=a.constructor==Float32Array?a:a[0].length?this.linearize(a):new Float32Array(a);b&&b.constructor!=Float32Array&&(b=b.constructor===
Array&&b[0].constructor===Number?new Float32Array(b):this.linearize(b));a=this.toGlobalMesh({vertices:d,colors:b});c||(c=b?this.shader_color:this.shader);return this.renderMesh(a,gl.POINTS,c,void 0,0,d.length/3)}},renderRoundPoints:function(a,b,c){if(a&&a.length){var d=null,d=a.constructor==Float32Array?a:a[0].length?this.linearize(a):new Float32Array(a);b&&(b=b.constructor==Float32Array?b:this.linearize(b));a=this.toGlobalMesh({vertices:d,colors:b});c||(c=b?this.shader_points_color:this.shader_points);
return this.renderMesh(a,gl.POINTS,c,void 0,0,d.length/3)}},renderPointsWithSize:function(a,b,c,d,f){if(a&&a.length){var e=null,e=a.constructor==Float32Array?a:a[0].length?this.linearize(a):new Float32Array(a);if(!b)throw"colors required in Draw.renderPointsWithSize";b=b.constructor==Float32Array?b:this.linearize(b);if(!c)throw"sizes required in Draw.renderPointsWithSize";c=c.constructor==Float32Array?c:this.linearize(c);a=this.toGlobalMesh({vertices:e,colors:b,extra:c});f=f||(d?this.shader_points_color_texture_size:
this.shader_points_color_size);return this.renderMesh(a,gl.POINTS,f,void 0,0,e.length/3)}},createRectangleMesh:function(a,b,c,d){var f=new Float32Array(12);c?f.set([0.5*-a,0,0.5*b,0.5*a,0,0.5*b,0.5*a,0,0.5*-b,0.5*-a,0,0.5*-b]):f.set([0.5*-a,0.5*b,0,0.5*a,0.5*b,0,0.5*a,0.5*-b,0,0.5*-a,0.5*-b,0]);return d?this.toGlobalMesh({vertices:f}):GL.Mesh.load({vertices:f})},renderRectangle:function(a,b,c){a=this.createRectangleMesh(a,b,c,!0);return this.renderMesh(a,gl.LINE_LOOP,void 0,void 0,0,this._global_mesh_last_size)},
createCircleMesh:function(a,b,c,d){b=b||32;quat.create();for(var f=this._temp,e=new Float32Array(3*b),g=2*Math.PI/b,k=0;k<b;k++)f[0]=Math.sin(g*k)*a,c?(f[1]=0,f[2]=Math.cos(g*k)*a):(f[2]=0,f[1]=Math.cos(g*k)*a),e.set(f,3*k);return d?this.toGlobalMesh({vertices:e}):GL.Mesh.load({vertices:e})},renderCircle:function(a,b,c,d){a=this.createCircleMesh(a,b,c,!0);return this.renderMesh(a,d?gl.TRIANGLE_FAN:gl.LINE_LOOP,void 0,void 0,0,this._global_mesh_last_size)},renderSolidCircle:function(a,b,c){return this.renderCircle(a,
b,c,!0)},createWireSphereMesh:function(a,b,c){b=b||100;quat.create();for(var d=this._temp,f=new Float32Array(18*b),e=1/b*Math.PI*2,g=0;g<b;g++)d.set([Math.sin(g*e)*a,Math.cos(g*e)*a,0]),f.set(d,18*g),d.set([Math.sin((g+1)*e)*a,Math.cos((g+1)*e)*a,0]),f.set(d,18*g+3),d.set([Math.sin(g*e)*a,0,Math.cos(g*e)*a]),f.set(d,18*g+6),d.set([Math.sin((g+1)*e)*a,0,Math.cos((g+1)*e)*a]),f.set(d,18*g+9),d.set([0,Math.sin(g*e)*a,Math.cos(g*e)*a]),f.set(d,18*g+12),d.set([0,Math.sin((g+1)*e)*a,Math.cos((g+1)*e)*a]),
f.set(d,18*g+15);return c?this.toGlobalMesh({vertices:f}):GL.Mesh.load({vertices:f})},renderWireSphere:function(a,b){var c=this.createWireSphereMesh(a,b,!0);return this.renderMesh(c,gl.LINES,void 0,void 0,0,this._global_mesh_last_size)},renderSolidSphere:function(a){var b=this._sphere_mesh;this._sphere_mesh||(b=this._sphere_mesh=GL.Mesh.sphere({size:1}));this.push();this.scale(a,a,a);this.renderMesh(b,gl.TRIANGLES);this.pop()},createWireBoxMesh:function(a,b,c,d){a*=0.5;b*=0.5;c*=0.5;a=new Float32Array([-a,
b,c,-a,b,-c,a,b,-c,a,b,c,-a,-b,c,-a,-b,-c,a,-b,-c,a,-b,c]);b=new Uint16Array([0,1,0,4,0,3,1,2,1,5,2,3,2,6,3,7,4,5,4,7,6,7,5,6]);return d?this.toGlobalMesh({vertices:a},b):GL.Mesh.load({vertices:a,lines:b})},renderWireBox:function(a,b,c){a=this.createWireBoxMesh(a,b,c,!0);return this.renderMesh(a,gl.LINES,void 0,"indices",0,this._global_mesh_last_size)},createSolidBoxMesh:function(a,b,c,d){a*=0.5;b*=0.5;c*=0.5;a=[-a,b,-c,-a,-b,+c,-a,b,c,-a,b,-c,-a,-b,-c,-a,-b,+c,a,b,-c,a,b,c,a,-b,+c,a,b,-c,a,-b,+c,
a,-b,-c,-a,b,c,a,-b,c,a,b,c,-a,b,c,-a,-b,c,a,-b,c,-a,b,-c,a,b,-c,a,-b,-c,-a,b,-c,a,-b,-c,-a,-b,-c,-a,b,-c,a,b,c,a,b,-c,-a,b,-c,-a,b,c,a,b,c,-a,-b,-c,a,-b,-c,a,-b,c,-a,-b,-c,a,-b,c,-a,-b,c];return d?this.toGlobalMesh({vertices:a}):GL.Mesh.load({vertices:a})},renderSolidBox:function(a,b,c){a=this.createSolidBoxMesh(a,b,c,!0);return this.renderMesh(a,gl.TRIANGLES,void 0,void 0,0,this._global_mesh_last_size)},renderWireCube:function(a){return this.renderWireBox(a,a,a)},renderSolidCube:function(a){return this.renderSolidCube(a,
a,a)},renderPlane:function(a,b,c,d){if(!a||!b)throw"LS.Draw.renderPlane param missing";this.push();this.translate(a);this.scale(b[0],b[1],1);c&&c.bind(0);!d&&c&&(d=this.shader_texture);this.renderMesh(this.quad_mesh,gl.TRIANGLE_FAN,d);c&&c.unbind(0);this.pop()},createGridMesh:function(a,b){a=a||20;b=b||10;for(var c=new Float32Array(12*(2*b+1)),d=0,f=-b;f<=b;f++)c.set([f*a,0,a*b],d),c.set([f*a,0,-a*b],d+3),c.set([a*b,0,f*a],d+6),c.set([-a*b,0,f*a],d+9),d+=12;return GL.Mesh.load({vertices:c})},renderGrid:function(a,
b){var c=this.createGridMesh(a,b);return this.renderMesh(c,gl.LINES)},createConeMesh:function(a,b,c,d,f){var e=[0,1,0];c=c||100;var g=quat.create(),k=this._temp,m=new Float32Array(3*(c+2));m.set(d?[0,0,b]:[0,b,0],0);for(b=0;b<=c;b++)quat.setAxisAngle(g,e,b/c*Math.PI*2),vec3.transformQuat(k,[0,0,a],g),d&&vec3.set(k,k[0],k[2],k[1]),m.set(k,3*b+3);return f?this.toGlobalMesh({vertices:m}):GL.Mesh.load({vertices:m})},renderCone:function(a,b,c,d){a=this.createConeMesh(a,b,c,d,!0);return this.renderMesh(a,
gl.TRIANGLE_FAN,void 0,void 0,0,this._global_mesh_last_size)},createCylinderMesh:function(a,b,c,d,f){d=[0,1,0];c=c||100;for(var e=quat.create(),g=this._temp,k=new Float32Array(6*(c+1)),m=0;m<=c;m++)quat.setAxisAngle(e,d,m/c*Math.PI*2),vec3.transformQuat(g,[0,0,a],e),k.set(g,6*m+3),g[1]=b,k.set(g,6*m);return f?this.toGlobalMesh({vertices:k}):GL.Mesh.load({vertices:k})},renderCylinder:function(a,b,c,d){a=this.createCylinderMesh(a,b,c,d,!0);return this.renderMesh(a,gl.TRIANGLE_STRIP,void 0,void 0,0,
this._global_mesh_last_size)},renderImage:function(a,b,c,d){if(!a||!b)throw"LS.Draw.renderImage param missing";c=c||10;var f=null;if("string"==typeof b){f=this.images[b];if(null==f){kb.images[b]=1;a=new Image;a.src=b;a.onload=function(){var a=GL.Texture.fromImage(this);kb.images[b]=a;if(kb.onRequestFrame)kb.onRequestFrame()};return}if(1==f)return}else b.constructor==Image?(b.texture||(b.texture=GL.Texture.fromImage(this)),f=b.texture):b.constructor==Texture&&(f=b);f&&(d?(this.setPointSize(c),f.bind(0),
this.renderPoints(a,null,this.shader_image)):(this.push(),this.billboard(a),this.scale(c,c,c),f.bind(0),this.renderMesh(this.quad_mesh,gl.TRIANGLE_FAN,this.shader_texture),this.pop()))},renderMesh:function(a,b,c,d,f,e){if(!this.ready)throw"Draw.js not initialized, call Draw.init()";if(!a)throw"LS.Draw.renderMesh mesh cannot be null";c||(c=a===this._global_mesh&&this._global_mesh_ignore_colors?this.shader:a.vertexBuffers.colors?this.shader_color:this.shader);mat4.multiply(this.mvp_matrix,this.viewprojection_matrix,
this.model_matrix);c.uniforms(this.uniforms);void 0===f?c.draw(a,void 0===b?gl.TRIANGLES:b,d):c.drawRange(a,void 0===b?gl.TRIANGLES:b,f,e,d);this._last_mesh=a;this._last_primitive=b;this._last_shader=c;this._last_indices=d;this._last_range_start=f;this._last_range_length=e;this._rendercalls+=1;return this.last_mesh=a},renderMeshesInstanced:function(){var a={u_model:null},b=mat4.create();return function(c,d,f,e,g){if(!this.ready)throw"Draw.js not initialized, call Draw.init()";if(!c)throw"LS.Draw.renderMeshesInstanced mesh cannot be null";
if(1==gl.webgl_version&&!gl.extensions.ANGLE_instanced_arrays)return null;e||(e=c.vertexBuffers.colors?this.shader_color_instancing:this.shader_instancing);if(!e.attributes.u_model)throw"Shader does not support instancing, it must have a attribute u_model";a.u_model=d;b.set(this.viewprojection_matrix);mat4.multiply(this.viewprojection_matrix,this.viewprojection_matrix,this.model_matrix);e.uniforms(this.uniforms);e.drawInstanced(c,void 0===f?gl.TRIANGLES:f,g,a);this.viewprojection_matrix.set(b);this._rendercalls+=
1;return c}}(),repeatLastRender:function(){this.renderMesh(this._last_mesh,this._last_primitive,this._last_shader,this._last_indices,this._last_range_start,this._last_range_length)},renderText:function(a,b){b=b||e.ZEROS;kb.font_atlas||this.createFontAtlas();for(var c=this.font_atlas,d=a.length,f=c.atlas.char_size,h=c.atlas.spacing,g=0,k=0;k<d;++k)null!=c.atlas[a.charCodeAt(k)]&&g++;for(var m=new Float32Array(18*g),g=new Float32Array(12*g),l=0,n=0,p=0,k=0;k<d;++k){var q=c.atlas[a.charCodeAt(k)];q?
(m.set([n+b[0],p+b[1],b[2]],18*l),m.set([n+b[0],p+b[1]+f,b[2]],18*l+3),m.set([n+b[0]+f,p+b[1]+f,b[2]],18*l+6),m.set([n+b[0]+f,p+b[1],b[2]],18*l+9),m.set([n+b[0],p+b[1],b[2]],18*l+12),m.set([n+b[0]+f,p+b[1]+f,b[2]],18*l+15),g.set([q[0],q[1]],12*l),g.set([q[0],q[3]],12*l+2),g.set([q[2],q[3]],12*l+4),g.set([q[2],q[1]],12*l+6),g.set([q[0],q[1]],12*l+8),g.set([q[2],q[3]],12*l+10),n+=h,++l):10==a.charCodeAt(k)?(n=0,p-=f):n+=f}d=this.toGlobalMesh({vertices:m,coords:g});c.bind(0);return this.renderMesh(d,
gl.TRIANGLES,this.shader_texture,void 0,0,m.length/3)},createFontAtlas:function(){var a=createCanvas(512,512),b=0.09*a.width|0,c=0.1*a.width|0,d=a.getContext("2d");d.fillStyle="white";d.font=b+"px Courier New";d.textAlign="center";for(var f=0,e=0,b=-0.3*b,g={char_size:c,offset:c/a.width,spacing:0.6*c},k=6;100>k;k++){var m=String.fromCharCode(k+27);g[k+27]=[f/a.width,1-(e+c)/a.height,(f+c)/a.width,1-e/a.height];d.fillText(m,Math.floor(f+0.5*c),Math.floor(e+c+b),c);f+=c;f+c>a.width&&(f=0,e+=c)}this.font_atlas=
GL.Texture.fromImage(a,{magFilter:gl.LINEAR,minFilter:gl.LINEAR_MIPMAP_LINEAR});gl.colorMask(!0,!0,!0,!1);this.font_atlas.fill([1,1,1,0]);gl.colorMask(!0,!0,!0,!0);this.font_atlas.atlas=g},linearize:function(a){if(!a.length)return[];if(a[0].constructor===Number)return a.constructor===Float32Array?a:new Float32Array(a);for(var b=a[0].length,c=new Float32Array(a.length*b),d=a.length,f=0;f<d;++f)c.set(a[f],f*b);return c},push:function(){if(this.model_matrix.byteOffset>=this.stack.byteLength-64)throw"matrices stack overflow";
var a=this.model_matrix;this.model_matrix=new Float32Array(this.stack.buffer,this.model_matrix.byteOffset+64,16);this.uniforms.u_model=this.model_matrix;mat4.copy(this.model_matrix,a)},pop:function(){if(0==this.model_matrix.byteOffset)throw"too many pops";this.model_matrix=new Float32Array(this.stack.buffer,this.model_matrix.byteOffset-64,16);this.uniforms.u_model=this.model_matrix},identity:function(){mat4.identity(this.model_matrix)},scale:function(a,b,c){if(3==arguments.length){var d=this._temp;
d[0]=a;d[1]=b;d[2]=c;mat4.scale(this.model_matrix,this.model_matrix,d)}else a.length?mat4.scale(this.model_matrix,this.model_matrix,a):(d=this._temp,d[0]=d[1]=d[2]=a,mat4.scale(this.model_matrix,this.model_matrix,d))},translate:function(a,b,c){if(3==arguments.length){var d=this._temp;d[0]=a;d[1]=b;d[2]=c;mat4.translate(this.model_matrix,this.model_matrix,d)}else mat4.translate(this.model_matrix,this.model_matrix,a)},rotate:function(a,b,c,d){if(4==arguments.length){var f=this._temp;f[0]=b;f[1]=c;f[2]=
d;mat4.rotate(this.model_matrix,this.model_matrix,a*DEG2RAD,[b,c,d])}else mat4.rotate(this.model_matrix,this.model_matrix,a*DEG2RAD,b)},lookAt:function(a,b,c){mat4.lookAt(this.model_matrix,a,b,c);mat4.invert(this.model_matrix,this.model_matrix)},billboard:function(a){mat4.invert(this.model_matrix,this.view_matrix);mat4.setTranslation(this.model_matrix,a)},fromTranslationFrontTop:function(a,b,c){mat4.fromTranslationFrontTop(this.model_matrix,a,b,c)},project:function(a,b){b=b||vec3.create();return mat4.multiplyVec3(b,
this.mvp_matrix,a)},getPhongShader:function(a,b,c,d){d=d?this.shader_phong_instanced:this.shader_phong;vec3.normalize(c,c);d.uniforms({u_ambient_color:a,u_light_color:b,u_light_dir:c});return d},getDepthShader:function(){return this.shader_depth},toGlobalMesh:function(a,b){this._global_mesh||(this._global_mesh_max_vertices=1024,this._global_mesh=new GL.Mesh({vertices:new Float32Array(3*this._global_mesh_max_vertices),normals:new Float32Array(3*this._global_mesh_max_vertices),coords:new Float32Array(2*
this._global_mesh_max_vertices),colors:new Float32Array(4*this._global_mesh_max_vertices),extra:new Float32Array(1*this._global_mesh_max_vertices)},{indices:new Uint16Array(3*this._global_mesh_max_vertices)},{stream_type:gl.DYNAMIC_STREAM}));for(var c in a){var d=this._global_mesh.getBuffer(c);if(d){var f=a[c];f&&(f.buffer||(f=new Float32Array(f)),f.length>d.data.length&&(console.warn("Draw: data is too big, resizing"),this.resizeGlobalMesh(),d=this._global_mesh.getBuffer(c),f=f.subarray(0,d.data.length)),
d.setData(f))}else console.warn("Draw: global mesh lacks one buffer: "+c)}this._global_mesh_ignore_colors=!a.colors;b?(d=this._global_mesh.getIndexBuffer("indices"),d.setData(b),this._global_mesh_last_size=b.length):this._global_mesh_last_size=a.vertices.length/3;return this._global_mesh},resizeGlobalMesh:function(){if(!this._global_mesh)throw"No global mesh to resize";this._global_mesh_max_vertices*=2;this._global_mesh.deleteBuffers();this._global_mesh=new GL.Mesh({vertices:new Float32Array(3*this._global_mesh_max_vertices),
normals:new Float32Array(3*this._global_mesh_max_vertices),coords:new Float32Array(2*this._global_mesh_max_vertices),colors:new Float32Array(4*this._global_mesh_max_vertices),extra:new Float32Array(1*this._global_mesh_max_vertices)},{indices:new Uint16Array(3*this._global_mesh_max_vertices)},{stream_type:gl.DYNAMIC_STREAM})}};"undefined"!=typeof e&&(e.Draw=kb);Hb.prototype.applyToRenderInstance=function(a){};Hb.prototype.applyByCPU=function(a,b){};e.Deformer=Hb;var Yb={picking_color_offset:10,getNodeAtCanvasPosition:function(a,
b,c,d,f){return(a=this.getInstanceAtCanvasPosition(a,b,c,d,f))?a.constructor==e.SceneNode?a:a._root&&a._root.constructor==e.SceneNode?a._root:a.node?a.node:null:null},getInstanceAtCanvasPosition:function(a,b,c,d,f){f=f||e.GlobalScene;c||(c=e.Renderer.getCameraAtPosition(a,b,f._cameras));if(!c)return null;this._picking_nodes={};this.getPickingColorFromBuffer(f,c,a,b,d);this._picking_color[3]=0;a=(new Uint32Array(this._picking_color.buffer))[0];a=this._picking_nodes[a];this._picking_nodes={};return a},
getNextPickingColor:function(a){this._picking_next_color_id+=this.picking_color_offset;var b=new Uint32Array(1);b[0]=this._picking_next_color_id;b=new Uint8Array(b.buffer);this._picking_nodes[this._picking_next_color_id]=a;return vec4.fromValues(b[0]/255,b[1]/255,b[2]/255,1)},_pickingMap:null,_picking_color:new Uint8Array(4),_picking_depth:0,_picking_next_color_id:0,_picking_nodes:{},_picking_render_settings:new Na,getPickingColorFromBuffer:function(a,b,c,d,f){if(null==this._pickingMap||this._pickingMap.width!=
gl.canvas.width||this._pickingMap.height!=gl.canvas.height)this._pickingMap=new GL.Texture(gl.canvas.width,gl.canvas.height,{format:gl.RGBA,filter:gl.NEAREST}),this._pickingFBO=new GL.FBO([this._pickingMap]);e.Renderer._current_target=this._pickingMap;this._pickingFBO.bind();gl.scissor(c-1,d-1,2,2);gl.enable(gl.SCISSOR_TEST);this.renderPickingBuffer(a,b,f,[c,d]);gl.readPixels(c,d,1,1,gl.RGBA,gl.UNSIGNED_BYTE,this._picking_color);gl.disable(gl.SCISSOR_TEST);this._pickingFBO.unbind();e.Renderer._current_target=
null;return this._picking_color},renderPickingBuffer:function(a,b,c,d){void 0===c&&(c=65535);var f=this._picking_render_settings;e.Renderer.enableCamera(b,this._picking_render_settings);gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);this._picking_next_color_id=0;e.Renderer.setRenderPass(Lb);f.layers=c;c=null;if(d){if(b=b.getRayInPixel(d[0],d[1]),b=e.Physics.raycastRenderInstances(b.origin,b.direction)){c=Array(b.length);for(var h=0;h<b.length;++h)c[h]=b[h].instance}}else c=
a._instances;e.Renderer.renderInstances(f,c);LEvent.trigger(a,"renderPicking",d);LEvent.trigger(e.Renderer,"renderPicking",d);e.Renderer.setRenderPass(hb)}};e.Picking=Yb;Ib.isCloser=function(a,b){return a.distance-b.distance};e.Collision=Ib;Pa.BOX=1;Pa.SPHERE=2;Pa.PLANE=3;Pa.CAPSULE=4;Pa.MESH=5;Pa.FUNCTION=6;Pa.prototype.updateAABB=function(){BBox.transformMat4(this.aabb,this.oobb,this.matrix)};Pa.prototype.setMesh=function(a){this.mesh=a;this.type=Pa.MESH;BBox.setCenterHalfsize(this.oobb,BBox.getCenter(a.bounding),
BBox.getHalfsize(a.bounding))};e.PhysicsInstance=Pa;e.Physics={raycast:function(a,b,c){c=c||{};if(!a||!b)throw"Physics.raycast: origin or direction missing.";var d=c.layers;void 0===d&&(d=65535);var f=c.max_distance||Number.MAX_VALUE,h=c.scene||e.GlobalScene,g=c.first_collision,h=c.colliders||h._colliders,k=[];c=!!c.normal;if(!h)return null;for(var m=vec3.create(),l=vec3.create(),n=0;n<h.length;++n){var p=h[n];if(0!==(d&p.layers)){var q=vec3.create(),r=null;if(geo.testRayBBox(a,b,p.aabb,null,q,f)){var s=
p.matrix,t=null;if(p.type==Pa.SPHERE){if(!geo.testRaySphere(a,b,p.center,p.oobb[3],q,f))continue;c&&(r=vec3.sub(vec3.create(),q,p.center))}else{var K=mat4.invert(mat4.create(),s);mat4.multiplyVec3(m,K,a);mat4.rotateVec3(l,K,b);if(!geo.testRayBBox(m,l,p.oobb,null,q,f))continue;if(p.type==Pa.MESH){t=p.mesh.octree;t||(t=p.mesh.octree=new GL.Octree(p.mesh));t=t.testRay(m,l,0,f);if(!t)continue;mat4.multiplyVec3(q,s,t.pos);c&&(r=mat4.rotateVec3(vec3.create(),s,t.normal))}else vec3.transformMat4(q,q,s)}s=
vec3.distance(a,q);k.push(new e.Collision(p.node,p,q,s,r,t));if(g)return k}}}k.sort(Ib.isCloser);return k},testSphere:function(a,b,c){c=c||{};var d=c.layers;void 0===d&&(d=65535);var f=c.scene||e.GlobalScene;c=c.colliders||f._colliders;f=vec3.create();if(!c)return null;for(var h=0;h<c.length;++h){var g=c[h];if(0!==(d&g.layers)&&geo.testSphereBBox(a,b,g.aabb)){var k=g.matrix,k=mat4.invert(mat4.create(),k);mat4.multiplyVec3(f,k,a);if(g.type==e.PhysicsInstance.SPHERE){if(vec3.distance(a,f)>b+BBox.getRadius(g.oobb))continue}else{if(!geo.testSphereBBox(f,
b,g.oobb))continue;if(g.type==e.PhysicsInstance.MESH&&(k=g.mesh.octree,k||(k=g.mesh.octree=new GL.Octree(g.mesh)),!k.testSphere(f,b)))continue}return g}}return null},testCollision:function(a,b){return geo.testBBoxBBox(a.aabb,b.aabb)?!0:!1},testAllCollisions:function(a,b,c){void 0===b&&(b=65535);c=c||e.GlobalScene;c=c._colliders;for(var d=c.length,f=!1,h=0;h<d;++h){var g=c[h];if(0!==(b&g.layers))for(var k=h+1;k<d;++k){var m=c[k];0!==(b&m.layers)&&this.testCollision(g,m)&&(a&&a(g,m),f=!0)}}return f},
raycastRenderInstances:function(a,b,c){c=c||{};var d=c.layers;void 0===d&&(d=65535);var f=c.max_distance||Number.MAX_VALUE,h=c.scene||e.GlobalScene,g=!!c.triangle_collision,k=!!c.first_collision,m=!!c.normal,l=!!c.ignore_transparent;c=c.instances||h._instances;if(!c||!c.length)return null;for(var h=[],n=vec3.create(),p=vec3.create(),q=0,r=c.length;q<r;++q){var s=c[q];if(0!==(d&s.layers)&&!(s.material&&s.material.render_state.blend&&l)){var t=vec3.create();if(geo.testRayBBox(a,b,s.aabb,null,t,f)){var K=
s.matrix,G=null,O=mat4.invert(mat4.create(),K);mat4.multiplyVec3(n,O,a);mat4.rotateVec3(p,O,b);if(geo.testRayBBox(n,p,s.oobb,null,t,f)){O=null;if(g){var G=s.lod_mesh||s.mesh,C=G.octree;C||(C=G.octree=new GL.Octree(G));G=C.testRay(n,p,0,f);if(!G)continue;mat4.multiplyVec3(t,K,G.pos);m&&(O=mat4.rotateVec3(vec3.create(),K,G.normal))}else vec3.transformMat4(t,t,K);K=vec3.distance(a,t);K<f&&h.push(new e.Collision(s.node,s,t,K,O,G));if(k)return h}}}}h.sort(e.Collision.isCloser);return h},raycastNode:function(a,
b,c,d){d=d||{};d.instances=c._instances;return this.raycastRenderInstances(a,b,d)}};z.temp_matrix=mat4.create();z.icon="mini-icon-gizmo.png";z.ZERO=vec3.create();z.UP=vec3.fromValues(0,1,0);z.RIGHT=vec3.fromValues(1,0,0);z.FRONT=vec3.fromValues(0,0,-1);z["@position"]={type:"position"};z["@rotation"]={type:"quat"};z["@data"]={type:"trans10"};z.properties={position:"vec3",scaling:"vec3",rotation:"quat"};z.prototype.onAddedToNode=function(a){a.transform||(a.transform=this)};z.prototype.onRemovedFromNode=
function(a){a.transform==this&&delete a.transform};Object.defineProperty(z.prototype,"position",{get:function(){return this._position},set:function(a){a&&a.length&&(this._position.set(a),this._must_update=!0)},enumerable:!0});Object.defineProperty(z.prototype,"x",{get:function(){return this._position[0]},set:function(a){this._position[0]=a;this._must_update=!0},enumerable:!1});Object.defineProperty(z.prototype,"y",{get:function(){return this._position[1]},set:function(a){this._position[1]=a;this._must_update=
!0},enumerable:!1});Object.defineProperty(z.prototype,"z",{get:function(){return this._position[2]},set:function(a){this._position[2]=a;this._must_update=!0},enumerable:!1});Object.defineProperty(z.prototype,"rotation",{get:function(){return this._rotation},set:function(a){this._rotation.set(a);this._must_update=!0},enumerable:!0});Object.defineProperty(z.prototype,"scaling",{get:function(){return this._scaling},set:function(a){a.constructor===Number?this._scaling[0]=this._scaling[1]=this._scaling[2]=
a:this._scaling.set(a);this._must_update=!0},enumerable:!0});Object.defineProperty(z.prototype,"matrix",{get:function(){this._must_update&&this.updateMatrix();return this._local_matrix},set:function(a){this.fromMatrix(a)},enumerable:!0});Object.defineProperty(z.prototype,"data",{get:function(){return this._data},set:function(a){this._data.set(a);this._must_update=!0},enumerable:!1});Object.defineProperty(z.prototype,"xrotation",{get:function(){return 0},set:function(a){this.rotateX(a*DEG2RAD)},enumerable:!1});
Object.defineProperty(z.prototype,"yrotation",{get:function(){return 0},set:function(a){this.rotateY(a*DEG2RAD)},enumerable:!1});Object.defineProperty(z.prototype,"zrotation",{get:function(){return 0},set:function(a){this.rotateZ(a*DEG2RAD)},enumerable:!1});Object.defineProperty(z.prototype,"globalPosition",{get:function(){return this.getGlobalPosition()},set:function(a){},enumerable:!0});Object.defineProperty(z.prototype,"globalMatrix",{get:function(){this.updateGlobalMatrix();return this._global_matrix},
set:function(a){throw"globalMatrix cannot be set";},enumerable:!0});Object.defineProperty(z.prototype,"forward",{get:function(){this.updateGlobalMatrix();return mat4.rotateVec3(vec3.create(),this._global_matrix,e.FRONT)},set:function(a){throw"forward cannot be set";},enumerable:!1});Object.defineProperty(z.prototype,"mustUpdate",{get:function(){return this._must_update},set:function(a){this._must_update=!0},enumerable:!1});z.prototype.getPropertiesInfo=function(a){return"output"==a?{position:"vec3",
scaling:"vec3",rotation:"quat",matrix:"mat4",globalPosition:"vec3",globalMatrix:"mat4"}:{position:"vec3",scaling:"vec3",rotation:"quat",matrix:"mat4"}};z.prototype.copyFrom=function(a){this.configure(a.serialize())};z.prototype.configure=function(a){a.uid&&(this.uid=a.uid);a.position&&this._position.set(a.position);a.scaling&&this._scaling.set(a.scaling);a.rotation&&4==a.rotation.length&&this._rotation.set(a.rotation);if(a.rotation&&3==a.rotation.length){quat.identity(this._rotation);var b=quat.setAngleAxis(quat.create(),
[1,0,0],a.rotation[0]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b);quat.setAngleAxis(b,[0,1,0],a.rotation[1]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b);quat.setAngleAxis(b,[0,0,1],a.rotation[2]*DEG2RAD);quat.multiply(this._rotation,this._rotation,b)}this._must_update=!0;this.updateGlobalMatrix();this._on_change()};z.prototype.serialize=function(a){var b={object_class:"Transform",uid:this.uid,position:[this._position[0],this._position[1],this._position[2]],rotation:[this._rotation[0],
this._rotation[1],this._rotation[2],this._rotation[3]],scaling:[this._scaling[0],this._scaling[1],this._scaling[2]]};this.isIdentity()||a||(b.matrix=Array.apply([],this._local_matrix));return b};z.prototype.isIdentity=function(){for(var a=0;a<this._local_matrix.length;++a)if(0.001<Math.abs(this._local_matrix[a]-e.IDENTITY[a]))return!1;return!0};z.prototype.identity=function(){vec3.copy(this._position,e.ZEROS);quat.identity(this._rotation);vec3.copy(this._scaling,e.ONES);mat4.identity(this._local_matrix);
mat4.identity(this._global_matrix);this._version+=1;this._must_update=!1};z.prototype.reset=z.prototype.identity;z.prototype.resetRotation=function(){quat.identity(this._rotation);this._version+=1;this._must_update=!0;this._on_change()};z.prototype.resetPosition=function(){vec3.copy(this._position,e.ZEROS);this._version+=1;this._must_update=!0;this._on_change(!0)};z.prototype.resetScale=function(){vec3.copy(this._scaling,e.ONES);this._version+=1;this._must_update=!0;this._on_change(!0)};z.prototype.getPosition=
function(a){a=a||vec3.create();a.set(this._position);return a};z.prototype.getGlobalPosition=function(a){a=a||vec3.create();return this._parent?mat4.multiplyVec3(a,this.getGlobalMatrix(),z.ZERO):vec3.copy(a,this._position)};z.prototype.getRotation=function(a){a=a||quat.create();return vec3.copy(a,this._rotation)};z.prototype.getGlobalRotation=function(a){a=a||quat.create();if(!this._parent)return quat.copy(a,this._rotation),a;var b=this._parent;for(quat.copy(a,this._rotation);b;)quat.multiply(a,b._rotation,
a),b=b._parent;return a};z.prototype.getScale=function(a){a=a||vec3.create();return vec3.copy(a,this._scaling)};z.prototype.getGlobalScale=function(a){a=a||vec3.create();if(this._parent){var b=this;for(vec3.copy(a,this._scaling);b._parent;)vec3.multiply(a,a,b._scaling),b=b._parent;return a}return vec3.copy(a,this._scaling)};z.prototype.updateMatrix=function(){mat4.fromRotationTranslation(this._local_matrix,this._rotation,this._position);mat4.scale(this._local_matrix,this._local_matrix,this._scaling);
this._must_update=!1;this._version+=1;this.updateDescendants()};z.prototype.updateLocalMatrix=z.prototype.updateMatrix;z.prototype.updateGlobalMatrix=function(a){this._must_update&&this.updateMatrix();this._parent?mat4.multiply(this._global_matrix,a?this._parent._global_matrix:this._parent.getGlobalMatrix(this._parent._global_matrix),this._local_matrix):this._global_matrix.set(this._local_matrix)};z.prototype.getMatrix=function(a){a=a||mat4.create();this._must_update&&this.updateMatrix();return mat4.copy(a,
this._local_matrix)};z.prototype.getLocalMatrix=z.prototype.getMatrix;z.prototype.getLocalMatrixRef=function(){this._must_update&&this.updateMatrix();return this._local_matrix};z.prototype.getGlobalMatrix=function(a,b){this._must_update&&this.updateMatrix();a=a||mat4.create();this._parent?mat4.multiply(this._global_matrix,b?this._parent._global_matrix:this._parent.getGlobalMatrix(this._parent._global_matrix),this._local_matrix):mat4.copy(this._global_matrix,this._local_matrix);return mat4.copy(a,
this._global_matrix)};z.prototype.getGlobalMatrixRef=function(){this.updateGlobalMatrix();return this._global_matrix};z.prototype.getAncestors=function(){for(var a=[this],b=this;b=b._parent;)a.unshift(b);return a};z.prototype.getGlobalTranslationMatrix=function(){var a=this.getGlobalPosition();return mat4.fromValues(1,0,0,0,0,1,0,0,0,0,1,0,a[0],a[1],a[2],1)};z.prototype.getGlobalRotationMatrix=function(a){a=a||mat4.create();if(!this._parent)return mat4.fromQuat(a,this._rotation);for(var b=mat4.create(),
c=this;c;)mat4.fromQuat(b,c._rotation),mat4.multiply(a,a,b),c=c._parent;return a};z.prototype.getGlobalTranslationRotationMatrix=function(){var a=this.getGlobalPosition();return mat4.fromRotationTranslation(mat4.create(),this.getGlobalRotation(),a)};z.prototype.getGlobalMatrixWithoutScale=z.prototype.getGlobalTranslationRotationMatrix;z.prototype.getNormalMatrix=function(a){this._must_update&&this.updateMatrix();a=a||mat4.create();this._parent?mat4.multiply(this._global_matrix,this._parent.getGlobalMatrix(),
this._local_matrix):a.set(this._local_matrix);return mat4.transpose(a,mat4.invert(a,a))};z.prototype.fromMatrix=function(){var a=mat4.create(),b=mat4.create(),c=mat3.create(),d=vec3.create();return function(f,h){if(h&&this._parent){mat4.copy(this._global_matrix,f);var g=this._parent.getGlobalMatrix(a);if(!mat4.invert(g,g))return;f=mat4.multiply(this._local_matrix,g,f)}b.set(f);mat4.multiplyVec3(this._position,b,e.ZEROS);this._scaling[0]=vec3.length(mat4.rotateVec3(d,b,e.RIGHT));this._scaling[1]=vec3.length(mat4.rotateVec3(d,
b,e.TOP));this._scaling[2]=vec3.length(mat4.rotateVec3(d,b,e.BACK));vec3.normalize(b.subarray(0,3),b.subarray(0,3));vec3.normalize(b.subarray(4,7),b.subarray(4,7));vec3.normalize(b.subarray(8,11),b.subarray(8,11));g=mat3.fromMat4(c,b);mat3.transpose(g,g);quat.fromMat3(this._rotation,g);quat.normalize(this._rotation,this._rotation);f!=this._local_matrix&&mat4.copy(this._local_matrix,f);this._must_update=!1;this._version+=1;this._on_change(!0)}}();z.prototype.fromGlobalMatrix=function(a){this.fromMatrix(a,
!0)};z.fromMatrix4ToTransformData=function(){mat4.create();var a=mat4.create(),b=mat3.create(),c=vec3.create();return function(d,f){var h=f||new Float32Array(10),g=h.subarray(0,3),k=h.subarray(3,7);quat.identity(k);var m=h.subarray(7,10);a.set(d);mat4.multiplyVec3(g,a,e.ZEROS);m[0]=vec3.length(mat4.rotateVec3(c,a,e.RIGHT));m[1]=vec3.length(mat4.rotateVec3(c,a,e.TOP));m[2]=vec3.length(mat4.rotateVec3(c,a,e.BACK));vec3.normalize(a.subarray(0,3),a.subarray(0,3));vec3.normalize(a.subarray(4,7),a.subarray(4,
7));vec3.normalize(a.subarray(8,11),a.subarray(8,11));g=mat3.fromMat4(b,a);mat3.transpose(g,g);quat.fromMat3(k,g);quat.normalize(k,k);return h}}();z.prototype.setRotationFromEuler=function(a){quat.fromEuler(this._rotation,a);this._must_update=!0;this._on_change()};z.prototype.setPosition=function(a,b,c){3==arguments.length?vec3.set(this._position,a,b,c):vec3.copy(this._position,a);this._must_update=!0;this._on_change(!0)};z.prototype.setRotation=function(a,b){b?quat.setAxisAngle(this._rotation,b,
a):quat.copy(this._rotation,a);this._must_update=!0;this._on_change(!0)};z.prototype.setScale=function(a,b,c){3==arguments.length?vec3.set(this._scaling,a,b,c):vec3.set(this._scaling,a,a,a);this._must_update=!0;this._on_change(!0)};z.prototype.translate=function(){var a=vec3.create(),b=vec3.create();return function(c,d,f){3==arguments.length?(b[0]=c,b[1]=d,b[2]=f,vec3.add(this._position,this._position,this.transformVector(b,a))):vec3.add(this._position,this._position,this.transformVector(c,a));this._must_update=
!0;this._on_change(!0)}}();z.prototype.translateGlobal=function(a,b,c){3==arguments.length?vec3.add(this._position,this._position,[a,b,c]):vec3.add(this._position,this._position,a);this._must_update=!0;this._on_change(!0)};z.prototype.rotate=function(){var a=quat.create(),b=quat.create();return function(c,d,f){f&&(d=this.globalVectorToLocal(d,b));quat.setAxisAngle(a,d,0.0174532925*c);quat.multiply(this._rotation,this._rotation,a);this._must_update=!0;this._on_change(!0)}}();z.prototype.rotateX=function(a){quat.rotateX(this._rotation,
this._rotation,a);this._must_update=!0;this._on_change(!0)};z.prototype.rotateY=function(a){quat.rotateY(this._rotation,this._rotation,a);this._must_update=!0;this._on_change()};z.prototype.rotateZ=function(a){quat.rotateZ(this._rotation,this._rotation,a);this._must_update=!0;this._on_change(!0)};z.prototype.rotateGlobal=function(a,b){var c=quat.setAxisAngle(quat.create(),b,0.0174532925*a);quat.multiply(this._rotation,c,this._rotation);this._must_update=!0;this._on_change(!0)};z.prototype.rotateQuat=
function(a){quat.multiply(this._rotation,this._rotation,a);this._must_update=!0;this._on_change(!0)};z.prototype.rotateQuatGlobal=function(a){quat.multiply(this._rotation,a,this._rotation);this._must_update=!0;this._on_change(!0)};z.prototype.scale=function(a,b,c){3==arguments.length?vec3.multiply(this._scaling,this._scaling,[a,b,c]):vec3.multiply(this._scaling,this._scaling,a);this._must_update=!0;this._on_change(!0)};z.interpolate=function(a,b,c,d){vec3.lerp(d._scaling,a._scaling,b._scaling,c);
vec3.lerp(d._position,a._position,b._position,c);quat.slerp(d._rotation,a._rotation,b._rotation,c);this._must_update=!0;this._on_change()};z.prototype.orbit=function(){var a=quat.create(),b=vec3.create();return function(c,d,f){if(!f)throw"Transform orbit requires a center";c=quat.setAxisAngle(a,d,0.0174532925*c);b.set(this._position);vec3.sub(b,b,f);vec3.transformQuat(b,b,c);vec3.add(b,b,f);this._position.set(b);this._must_update=!0}}();z.prototype.lookAt=function(){var a=mat4.create(),b=mat4.create(),
c=vec3.create(),d=vec3.create(),f=vec3.create();return function(h,g,k,m){k=k||e.TOP;if(m&&this._parent){this._parent.getGlobalMatrix(a);m=mat4.invert(a,a);if(!m)return;mat4.multiplyVec3(c,m,h);mat4.multiplyVec3(d,m,g);mat4.rotateVec3(f,m,k)}else c.set(h),d.set(g),f.set(k);mat4.lookAt(b,c,d,f);quat.fromMat4(this._rotation,b);this._position.set(c);this._must_update=!0}}();z.prototype._on_change=function(a){a||(this._must_update=!0);LEvent.trigger(this,"changed",this);this._root&&LEvent.trigger(this._root,
"transformChanged",this)};z.prototype.getFront=function(a){return vec3.transformQuat(a||vec3.create(),z.FRONT,this.getGlobalRotation())};z.prototype.getTop=function(a){return vec3.transformQuat(a||vec3.create(),z.UP,this.getGlobalRotation())};z.prototype.getRight=function(a){return vec3.transformQuat(a||vec3.create(),z.RIGHT,this.getGlobalRotation())};z.prototype.transformPoint=function(a,b){b=b||vec3.create();this._must_update&&this.updateMatrix();return mat4.multiplyVec3(b,this._local_matrix,a)};
z.prototype.localToGlobal=function(a,b){b=b||vec3.create();this._must_update&&this.updateMatrix();return mat4.multiplyVec3(b,this.getGlobalMatrixRef(),a)};z.prototype.transformPointGlobal=z.prototype.localToGlobal;z.prototype.globalToLocal=function(){var a=mat4.create();return function(b,c){c=c||vec3.create();this._must_update&&this.updateMatrix();return mat4.invert(a,this.getGlobalMatrixRef())?mat4.multiplyVec3(c,a,b):a}}();z.prototype.transformVector=function(a,b){return vec3.transformQuat(b||vec3.create(),
a,this._rotation)};z.prototype.localVectorToGlobal=function(a,b){return vec3.transformQuat(b||vec3.create(),a,this.getGlobalRotation())};z.prototype.transformVectorGlobal=z.prototype.localVectorToGlobal;z.prototype.globalVectorToLocal=function(a,b){var c=this.getGlobalRotation();quat.invert(c,c);return vec3.transformQuat(b||vec3.create(),a,c)};z.prototype.applyTransform=function(a,b,c){vec3.add(this._position,this._position,a._position);quat.multiply(this._rotation,this._rotation,a._rotation);vec3.multiply(this._scaling,
this._scaling,a._scaling);this._must_update=!0};z.prototype.applyTransformMatrix=function(){var a=mat4.create(),b=vec3.create(),c=mat4.create();mat4.create();var d=mat4.create();return function(f,e,g){e&&(mat4.setTranslation(a,e),vec3.scale(b,e,-1),mat4.setTranslation(c,b),mat4.multiply(f,a,f),mat4.multiply(f,f,c));this._parent?(e=this.getGlobalMatrix(),g=this._parent._global_matrix,mat4.multiply(this._global_matrix,f,e),mat4.invert(d,g)&&(mat4.multiply(this._local_matrix,d,this._global_matrix),this.fromMatrix(this._local_matrix))):
this.applyLocalTransformMatrix(f)}}();z.prototype.applyLocalTransformMatrix=function(){var a=vec3.create(),b=mat3.create(),c=mat4.create(),d=quat.create();return function(f){vec3.transformMat4(this._position,this._position,f);mat4.rotateVec3(a,f,[1,0,0]);this._scaling[0]*=vec3.length(a);mat4.rotateVec3(a,f,[0,1,0]);this._scaling[1]*=vec3.length(a);mat4.rotateVec3(a,f,[0,0,1]);this._scaling[2]*=vec3.length(a);if(f=mat4.invert(c,f))mat4.transpose(f,f),f=mat3.fromMat4(b,f),f=quat.fromMat3(d,f),quat.normalize(f,
f),quat.multiply(this._rotation,f,this._rotation),this._must_update=!0,this._on_change()}}();z.prototype.updateDescendants=function(){if(this._root){var a=this._root._children;if(a)for(var b=0;b<a.length;++b){var c=a[b];c.transform&&(c.transform._must_update=!0,c.transform._version+=1,c._children&&c._children.length&&c.transform.updateDescendants())}}};e.registerComponent(z);e.Transform=z;y.icon="mini-icon-camera.png";y.PERSPECTIVE=1;y.ORTHOGRAPHIC=2;y.ORTHO2D=3;y.DEFAULT_EYE=[0,0,0];y.DEFAULT_CENTER=
[0,0,-100];y.DEFAULT_UP=[0,1,0];y["@type"]={type:"enum",values:{perspective:y.PERSPECTIVE,orthographic:y.ORTHOGRAPHIC,ortho2D:y.ORTHO2D}};y["@eye"]={type:"vec3",widget:"position"};y["@center"]={type:"vec3",widget:"position"};y["@layers"]={type:"layers"};y.cubemap_camera_parameters=[{name:"posx",dir:vec3.fromValues(1,0,0),up:vec3.fromValues(0,-1,0),crossx:2,crossy:1},{name:"negx",dir:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,-1,0),crossx:0,crossy:1},{name:"posy",dir:vec3.fromValues(0,1,0),up:vec3.fromValues(0,
0,1),crossx:1,crossy:0},{name:"negy",dir:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,-1),crossx:1,crossy:2},{name:"posz",dir:vec3.fromValues(0,0,1),up:vec3.fromValues(0,-1,0),crossx:1,crossy:1},{name:"negz",dir:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,-1,0),crossx:3,crossy:1}];y.prototype.onResourceRenamed=function(a,b){a==this.overwrite_material&&(this.overwrite_material=b)};y.prototype.getResources=function(a){this.overwrite_material&&this.overwrite_material.constructor===String&&(a[this.overwrite_material]=
!0);return a};Object.defineProperty(y.prototype,"type",{get:function(){return this._type},set:function(a){this._type!=a&&(this._must_update_projection_matrix=this._must_update_view_matrix=!0);this._type=a},enumerable:!0});Object.defineProperty(y.prototype,"eye",{get:function(){return this._eye},set:function(a){this._eye.set(a);this._must_update_view_matrix=!0},enumerable:!0});Object.defineProperty(y.prototype,"center",{get:function(){return this._center},set:function(a){this._center.set(a);this._must_update_view_matrix=
!0},enumerable:!0});var lb=vec3.create();Object.defineProperty(y.prototype,"focalLength",{get:function(){return vec3.distance(this._eye,this._center)},set:function(a){a=Math.max(0.001,a);vec3.sub(lb,this._center,this._eye);var b=vec3.length(lb);1E-4>b?lb.set([0,0,-1]):a/=b;vec3.scaleAndAdd(lb,this._eye,lb,a);this._center.set(lb);this._must_update_view_matrix=!0},enumerable:!0});Object.defineProperty(y.prototype,"up",{get:function(){return this._up},set:function(a){this._up.set(a);this._must_update_view_matrix=
!0},enumerable:!0});Object.defineProperty(y.prototype,"near",{get:function(){return this._near},set:function(a){this._near!=a&&(this._must_update_projection_matrix=!0);this._near=a},enumerable:!0});Object.defineProperty(y.prototype,"far",{get:function(){return this._far},set:function(a){this._far!=a&&(this._must_update_projection_matrix=!0);this._far=a},enumerable:!0});Object.defineProperty(y.prototype,"aspect",{get:function(){return this._aspect},set:function(a){this._aspect!=a&&(this._must_update_projection_matrix=
!0);this._aspect=a},enumerable:!0});Object.defineProperty(y.prototype,"final_aspect",{get:function(){return this._final_aspect},set:function(a){this._final_aspect!=a&&(this._must_update_projection_matrix=!0);this._final_aspect=a},enumerable:!1});Object.defineProperty(y.prototype,"fov",{get:function(){return this._fov},set:function(a){this._fov!=a&&(this._must_update_projection_matrix=!0);this._fov=a},enumerable:!0});Object.defineProperty(y.prototype,"frustum_size",{get:function(){return this._frustum_size},
set:function(a){this._frustum_size!=a&&(this._must_update_projection_matrix=!0,this._frustum_size=a)},enumerable:!0});Object.defineProperty(y.prototype,"orthographic",{get:function(){return this._ortho},set:function(a){!a||4>a.length||(this._ortho.set(a),this._must_update_projection_matrix=!0)},enumerable:!0});Object.defineProperty(y.prototype,"view_matrix",{get:function(){return this._view_matrix},set:function(a){this.fromViewMatrix(a)},enumerable:!0});Object.defineProperty(y.prototype,"projection_matrix",
{get:function(){return this._projection_matrix},set:function(a){throw"projection matrix cannot be set manually, use setCustomProjectionMatrix instead.";},enumerable:!0});Object.defineProperty(y.prototype,"viewport",{get:function(){return this._viewport},set:function(a){this._viewport.set(a)},enumerable:!0});Object.defineProperty(y.prototype,"viewport_offset",{get:function(){return this._viewport.subarray(0,2)},set:function(a){this._viewport.set(a)},enumerable:!0});Object.defineProperty(y.prototype,
"viewport_size",{get:function(){return this._viewport.subarray(2,4)},set:function(a){this._viewport.set(a,2)},enumerable:!0});Object.defineProperty(y.prototype,"background_color",{get:function(){return this._background_color},set:function(a){this._background_color.set(a)},enumerable:!0});Object.defineProperty(y.prototype,"render_to_texture",{get:function(){return!!this._frame},set:function(a){a?this._frame||(this._frame=new e.RenderFrameContext):this._frame=null},enumerable:!0});Object.defineProperty(y.prototype,
"frame",{set:function(a){throw"frame cannot be assigned manually, enable render_to_texture";},get:function(){return this._frame},enumerable:!1});Object.defineProperty(y.prototype,"frame_color_texture",{set:function(a){throw"frame_color_texture cannot be assigned manually, enable render_to_texture";},get:function(a){return this._frame?this._frame.getColorTexture():null},enumerable:!1});Object.defineProperty(y.prototype,"frame_depth_texture",{set:function(a){throw"frame_depth_texture cannot be assigned manually, enable render_to_texture";
},get:function(){return this._frame?this._frame.getDepthTexture():null},enumerable:!1});Object.defineProperty(y.prototype,"mustUpdate",{get:function(){return this._must_update_projection_matrix||this._must_update_view_matrix},set:function(a){this._must_update_projection_matrix=this._must_update_view_matrix=a},enumerable:!0});y.prototype.onAddedToNode=function(a){a.camera||(a.camera=this);LEvent.bind(a,"transformChanged",this.onNodeMoved,this)};y.prototype.onRemovedFromNode=function(a){a.camera==this&&
delete a.camera;LEvent.unbind(a,"transformChanged",this.onNodeMoved,this)};y.prototype.onAddedToScene=function(a){LEvent.bind(a,"collectCameras",this.onCollectCameras,this)};y.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"collectCameras",this.onCollectCameras,this);this._frame&&this._frame.clear();this._binded_render_frame&&(LEvent.unbind(this,"enableFrameContext",this.enableRenderFrameContext,this),LEvent.unbind(this,"showFrameContext",this.disableRenderFrameContext,this),this._binded_render_frame=
!1)};y.prototype.onNodeMoved=function(){this._must_update_view_matrix=!0};y.prototype.isRenderedToTexture=function(){return this.enabled&&this.render_to_texture};y.prototype.onCollectCameras=function(a,b){this.enabled&&(this.isRenderedToTexture()?b.unshift(this):b.push(this),this._frame?this._binded_render_frame||(LEvent.bind(this,"enableFrameContext",this.enableRenderFrameContext,this),LEvent.bind(this,"showFrameContext",this.disableRenderFrameContext,this),this._binded_render_frame=!0):this._binded_render_frame&&
(LEvent.unbind(this,"enableFrameContext",this.enableRenderFrameContext,this),LEvent.unbind(this,"showFrameContext",this.disableRenderFrameContext,this),this._binded_render_frame=!1))};y.prototype.lookAt=function(a,b,c){this._root&&this._root.transform?(this._root.transform.lookAt(a,b,c),this._eye.set(e.ZEROS),this._up.set([0,1,0]),this.focalLength=vec3.distance(a,b)):(vec3.copy(this._eye,a),vec3.copy(this._center,b),vec3.copy(this._up,c));this._must_update_view_matrix=!0};y.prototype.lookAtFromMatrix=
function(a,b){if(this._root&&this._root.transform){if(!b){var c=mat4.create();a=mat4.invert(c,a)}this._root.transform.matrix=a;this._eye.set(e.ZEROS);this._up.set([0,1,0]);this._must_update_view_matrix=!0;this.focalLength=1}else{c=mat4.create();mat4.invert(c,a);var d=b?a:c;this._view_matrix.set(b?c:a);vec3.transformMat4(this._eye,e.ZEROS,d);vec3.transformMat4(this._center,e.FRONT,d);mat4.rotateVec3(this._up,d,e.TOP)}};y.prototype.resetVectors=function(a){a=a||1;this._eye.set([0,0,0]);this._center.set([0,
0,-a]);this._up.set([0,1,0]);this._must_update_view_matrix=!0};y.prototype.updateMatrices=function(a){this._must_update_view_matrix=this._must_update_view_matrix||this._root&&!this._root._is_root;if(this._must_update_projection_matrix||this._must_update_view_matrix||a){!this._must_update_projection_matrix&&!a||this._use_custom_projection_matrix||(this.type==y.ORTHOGRAPHIC?mat4.ortho(this._projection_matrix,-this._frustum_size*this._final_aspect*0.5,this._frustum_size*this._final_aspect*0.5,0.5*-this._frustum_size,
0.5*this._frustum_size,this._near,this._far):this.type==y.ORTHO2D?mat4.ortho(this._projection_matrix,this._ortho[0],this._ortho[1],this._ortho[2],this._ortho[3],this._near,this._far):mat4.perspective(this._projection_matrix,this._fov*DEG2RAD,this._final_aspect,this._near,this._far));if(this._must_update_view_matrix||a)this._root&&this._root._is_root?mat4.lookAt(this._view_matrix,this._eye,this._center,this._up):mat4.lookAt(this._view_matrix,this.getEye(this._global_eye),this.getCenter(this._global_center),
this.getUp(this._global_up)),mat4.invert(this._model_matrix,this._view_matrix);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix);this._must_update_projection_matrix=this._must_update_view_matrix=!1}};y.prototype.updateFrustumPlanes=function(){geo.extractPlanes(this._viewprojection_matrix,this._frustum_planes);return this._frustum_planes};y.prototype.getModelMatrix=function(a){a=a||mat4.create();this._must_update_view_matrix&&this.updateMatrices();return mat4.copy(a,
this._model_matrix)};y.prototype.getViewMatrix=function(a){a=a||mat4.create();this._must_update_view_matrix&&this.updateMatrices();return mat4.copy(a,this._view_matrix)};y.prototype.getProjectionMatrix=function(a){a=a||mat4.create();this._must_update_projection_matrix&&this.updateMatrices();return mat4.copy(a,this._projection_matrix)};y.prototype.getViewProjectionMatrix=function(a,b){a=a||mat4.create();(this._must_update_view_matrix||this._must_update_projection_matrix||b)&&this.updateMatrices();
return mat4.copy(a,this._viewprojection_matrix)};y.prototype.getModelViewProjectionMatrix=function(a,b){b=b||mat4.create();(this._must_update_view_matrix||this._must_update_projection_matrix)&&this.updateMatrices();return mat4.multiply(b,this._viewprojection_matrix,a)};y.prototype.updateVectors=function(a){var b=vec3.subtract(vec3.create(),this._center,this._eye),b=vec3.length(b);this._eye=mat4.multiplyVec3(vec3.create(),a,vec3.create());this._center=mat4.multiplyVec3(vec3.create(),a,vec3.fromValues(0,
0,-b));this._up=mat4.rotateVec3(vec3.create(),a,vec3.fromValues(0,1,0));this.updateMatrices()};y.prototype.getLocalPoint=function(a,b){b=b||vec3.create();if(this._root&&this._root.transform)return mat4.multiplyVec3(b,this._root.transform.getGlobalMatrixRef(),a);this._must_update_view_matrix&&this.updateMatrices();return mat4.multiplyVec3(b,this._model_matrix,a)};y.prototype.getLocalVector=function(a,b){b=b||vec3.create();if(this._root&&this._root.transform)return mat4.rotateVec3(b,this._root.transform.getGlobalMatrixRef(),
a);this._must_update_view_matrix&&this.updateMatrices();return mat4.rotateVec3(b,this._model_matrix,a)};y.prototype.getEye=function(a){a=a||vec3.create();a[0]=this._eye[0];a[1]=this._eye[1];a[2]=this._eye[2];return this._root&&this._root.transform?this._root.transform.getGlobalPosition(a):a};y.prototype.getCenter=function(a){a=a||vec3.create();if(this._root&&this._root.transform)return mat4.multiplyVec3(a,this._root.transform.getGlobalMatrixRef(),this._center);a[0]=this._center[0];a[1]=this._center[1];
a[2]=this._center[2];return a};y.prototype.getFront=function(a){a=a||vec3.create();if(this._root&&this._root.transform)return a[0]=a[1]=0,a[2]=-1,mat4.rotateVec3(a,this._root.transform.getGlobalMatrixRef(),a);vec3.sub(a,this._center,this._eye);return vec3.normalize(a,a)};y.prototype.getUp=function(a){a=a||vec3.create();a[0]=this._up[0];a[1]=this._up[1];a[2]=this._up[2];return this._root&&this._root.transform?mat4.rotateVec3(a,this._root.transform.getGlobalMatrixRef(),a):a};y.prototype.getTop=function(a){a=
a||vec3.create();var b=vec3.sub(vec3.create(),this._center,this._eye),c=vec3.cross(vec3.create(),this._up,b);a=vec3.cross(a,b,c);vec3.normalize(a,a);return this._root&&this._root.transform&&this._root._parent?mat4.rotateVec3(a,this._root.transform.getGlobalMatrixRef(),a):a};y.prototype.getRight=function(a){a=a||vec3.create();var b=vec3.sub(vec3.create(),this._center,this._eye);a=vec3.cross(a,this._up,b);vec3.normalize(a,a);return this._root&&this._root.transform&&this._root._parent?mat4.rotateVec3(a,
this._root.transform.getGlobalMatrixRef(),a):a};y.prototype.setEye=function(a){this._eye.set(a);this._must_update_view_matrix=!0};y.prototype.setCenter=function(a){this._center.set(a);this._must_update_view_matrix=!0};y.prototype.setPerspective=function(a,b,c,d){this._fov=a;this._aspect=b;this._near=c;this._far=d;this._type=y.PERSPECTIVE;this._must_update_projection_matrix=!0};y.prototype.setOrthographic=function(a,b,c,d,f,e){this._near=f;this._far=e;this._ortho.set([a,b,c,d]);this._type=y.ORTHO2D;
this._must_update_projection_matrix=!0};y.prototype.move=function(a){this._root&&this._root.transform?this._root.transform.move(a):(vec3.add(this._center,this._center,a),vec3.add(this._eye,this._eye,a));this._must_update_view_matrix=!0};y.prototype.rotate=function(){var a=quat.create(),b=vec3.create();return function(c,d,f){0!=c&&(this._root&&this._root.transform?this._root.transform.rotate(c,d,!f):(f?this.getLocalVector(d,b):b.set(d),c=quat.setAxisAngle(a,b,0.0174532925*c),d=vec3.subtract(b,this._center,
this._eye),vec3.transformQuat(d,d,c),vec3.add(this._center,this._eye,d)),this._must_update_view_matrix=!0)}}();y.prototype.orbit=function(){var a=quat.create(),b=vec3.create();return function(c,d,f){c=c||0;if(0!=c){if(!d)throw"axis missing";this._root&&this._root.transform?this._root.transform.orbit(c,d,f||this.getCenter()):(f=f||this._center,c=quat.setAxisAngle(a,d,0.0174532925*c),d=vec3.subtract(b,this._eye,f),vec3.transformQuat(d,d,c),vec3.add(this._eye,f,d));this._must_update_view_matrix=!0}}}();
y.prototype.orbitDistanceFactor=function(a,b){b=b||this._center;var c=vec3.subtract(vec3.create(),this._eye,b);vec3.scale(c,c,a);vec3.add(this._eye,b,c);this._must_update_view_matrix=!0};y.prototype.panning=function(a,b){var c=vec3.create(),d=vec3.create(),f=vec3.create();return function(a,b,k){k=k||1;this.getLocalVector(e.TOP,c);this.getLocalVector(e.RIGHT,d);vec3.scaleAndAdd(f,e.ZEROS,c,b*k);vec3.scaleAndAdd(f,f,d,a*k);this.move(f)}}();y.prototype.setDistanceToCenter=function(a,b){if(this._root)console.warn("cannot use setDistanceToCenter in a camera attached to a node");
else{var c=vec3.sub(vec3.create(),this._center,this._eye),d=vec3.length(c);b?vec3.scaleAndAdd(this._eye,this._center,c,-a/d):vec3.scaleAndAdd(this._center,this._eye,c,a/d);this._must_update_view_matrix=!0}};y.prototype.setOrientation=function(a,b){var c=this.getCenter(),d=this.getEye(),f=[0,1,0],c=vec3.sub(vec3.create(),c,d),c=vec3.length(c),e=null,e=vec3.fromValues(0,0,-c);b&&(vec3.rotateY(e,e,-0.5*Math.PI),vec3.rotateY(f,f,-0.5*Math.PI));vec3.transformQuat(e,e,a);vec3.transformQuat(f,f,a);b&&(vec3.rotateY(e,
e,0.5*Math.PI),vec3.rotateY(f,f,0.5*Math.PI));this.center=vec3.add(vec3.create(),d,e);this.up=f;this._must_update_view_matrix=!0};y.prototype.setEulerAngles=function(a,b,c){var d=quat.create();quat.fromEuler(d,[a,b,c]);this.setOrientation(d)};y.prototype.fromViewMatrix=function(a){this._root&&this._root.transform?(a=mat4.invert(mat4.create(),a),this._root.transform.fromMatrix(a,!0)):(a=mat4.invert(mat4.create(),a),this.eye=vec3.transformMat4(vec3.create(),e.ZEROS,a),this.center=vec3.transformMat4(vec3.create(),
e.FRONT,a),this.up=mat4.rotateVec3(vec3.create(),a,e.TOP),this._must_update_view_matrix=!0)};y.prototype.setCustomProjectionMatrix=function(a){a?(this._use_custom_projection_matrix=!0,this._projection_matrix.set(a),this._must_update_projection_matrix=!1,mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix)):(this._use_custom_projection_matrix=!1,this._must_update_projection_matrix=!0)};y.prototype.setViewportInPixels=function(a,b,c,d){this._viewport[0]=a/gl.canvas.width;
this._viewport[1]=b/gl.canvas.height;this._viewport[2]=c/gl.canvas.width;this._viewport[3]=d/gl.canvas.height};y.prototype.project=function(a,b,c,d){c=c||vec3.create();if(!a)throw"camera project parameter 'vec' cannot be null";b=this.getLocalViewport(b);(this._must_update_view_matrix||this._must_update_projection_matrix)&&this.updateMatrices();vec3.project(c,a,this._viewprojection_matrix,b);d||(c[1]=b[3]-c[1]+2*b[1]);return c};y.prototype.projectNodeCenter=function(a,b,c,d){a=a.transform?a.transform.getGlobalPosition():
e.ZEROS;return this.project(a,b,c,d)};y.prototype.unproject=function(a,b,c){b=this.getLocalViewport(b);(this._must_update_view_matrix||this._must_update_projection_matrix)&&this.updateMatrices();return vec3.unproject(c||vec3.create(),a,this._viewprojection_matrix,b)};y.prototype.getLocalViewport=function(a,b){b=b||vec4.create();if(!a)return b[0]=gl.canvas.width*this._viewport[0],b[1]=gl.canvas.height*this._viewport[1],b[2]=gl.canvas.width*this._viewport[2],b[3]=gl.canvas.height*this._viewport[3],
b;b[0]=Math.floor(a[2]*this._viewport[0]+a[0]);b[1]=Math.floor(a[3]*this._viewport[1]+a[1]);b[2]=Math.ceil(a[2]*this._viewport[2]);b[3]=Math.ceil(a[3]*this._viewport[3]);return b};y.prototype.getRay=function(a,b,c,d,f){d||(c=this.getLocalViewport(c,this._viewport_in_pixels));(this._must_update_view_matrix||this._must_update_projection_matrix)&&this.updateMatrices();d=this.getEye();var h=vec3.unproject(vec3.create(),[a,b,1],this._viewprojection_matrix,c);if(!h)return null;this.type==y.ORTHOGRAPHIC&&
(d=vec3.unproject(d,[a,b,0],this._viewprojection_matrix,c));a=vec3.subtract(h,h,d);vec3.normalize(a,a);f=f||new e.Ray;f.origin.set(d);f.direction.set(a);return f};y.prototype.getRayInPixel=y.prototype.getRay;y.prototype.isPointInCamera=function(a,b,c){c=this.getLocalViewport(c,this._viewport_in_pixels);return a<c[0]||a>c[0]+c[2]||b<c[1]||b>c[1]+c[3]?!1:!0};y.prototype.configure=function(a){void 0!==a.uid&&(this.uid=a.uid);void 0!==a.layers&&(this.layers=a.layers);void 0!==a.enabled&&(this.enabled=
a.enabled);void 0!==a.type&&(this._type=a.type);void 0!==a.eye&&this._eye.set(a.eye);void 0!==a.center&&this._center.set(a.center);void 0!==a.up&&this._up.set(a.up);void 0!==a.near&&(this._near=a.near);void 0!==a.far&&(this._far=a.far);void 0!==a.fov&&(this._fov=a.fov);void 0!==a.aspect&&(this._aspect=a.aspect);void 0!==a.final_aspect&&(this._final_aspect=a.final_aspect);void 0!==a.frustum_size&&(this._frustum_size=a.frustum_size);void 0!==a.viewport&&this._viewport.set(a.viewport);void 0!==a.orthographic&&
this._ortho.set(a.orthographic);void 0!==a.background_color&&this._background_color.set(a.background_color);void 0!==a.render_to_texture&&(this.render_to_texture=a.render_to_texture);a.frame&&this._frame&&this._frame.configure(a.frame);void 0!==a.show_frame&&(this.show_frame=a.show_frame);void 0!==a.clear_color&&(this.clear_color=!!a.clear_color);void 0!==a.clear_depth&&(this.clear_depth=!!a.clear_depth);this.updateMatrices(!0)};y.prototype.serialize=function(){return{object_class:"Camera",uid:this.uid,
layers:this.layers,enabled:this.enabled,type:this._type,eye:vec3.toArray(this._eye),center:vec3.toArray(this._center),up:vec3.toArray(this._up),near:this._near,far:this._far,fov:this._fov,aspect:this._aspect,orthographic:vec4.toArray(this._ortho),background_color:vec4.toArray(this._background_color),frustum_size:this._frustum_size,viewport:Array.apply([],this._viewport),render_to_texture:this.render_to_texture,frame:this._frame?this._frame.serialize():null,show_frame:this.show_frame,clear_color:this.clear_color,
clear_depth:this.clear_depth}};y.prototype.checkLayersVisibility=function(a){return 0!==(this.layers&a)};y.prototype.getLayers=function(){for(var a=[],b=0;32>b;++b)this.layers&1<<b&&a.push(this._root.scene.layer_names[b]||"layer"+b);return a};y.prototype.setLayer=function(a,b){var c=1<<a;this.layers&=~c;b&&(this.layers|=c)};y.prototype.isInLayer=function(a){return 0!==(this.layers&1<<a)};y.prototype.getTransformMatrix=function(a){if(this._root&&this._root.transform)return null;var b=null,b="center"==
a?this._center:this._eye;a=mat4.create();mat4.setTranslation(a,b);return a};y.prototype.applyTransformMatrix=function(a,b,c){if(this._root&&this._root.transform)return!1;b=null;b="center"==c?this._center:this._eye;mat4.multiplyVec3(b,a,b);return this._must_update_view_matrix=!0};y.prototype.enableRenderFrameContext=function(){this._frame&&this._frame.enable()};y.prototype.disableRenderFrameContext=function(){this._frame&&(this._frame.disable(),this.show_frame&&e.Renderer.showRenderFrameContext(this._frame,
this))};y.prototype.prepare=function(){this._previous_viewprojection_matrix.set(this._viewprojection_matrix);this.updateMatrices();this.fillShaderUniforms()};y.prototype.fillShaderUniforms=function(){var a=this._uniforms;a.u_camera_planes[0]=this.near;a.u_camera_planes[1]=this.far;this.type==e.Camera.PERSPECTIVE?a.u_camera_perspective.set([this.fov*DEG2RAD,512/Math.tan(this.fov*DEG2RAD)]):a.u_camera_perspective.set([this._frustum_size,512/this._frustum_size]);a.u_camera_perspective[2]=this._projection_matrix[5];
this.getEye(a.u_camera_eye);this.getFront(a.u_camera_front);return a};e.registerComponent(y);e.Camera=y;sa.icon="mini-icon-fx.png";sa["@camera_uid"]={type:"String"};Object.defineProperty(sa.prototype,"use_antialiasing",{set:function(a){this.fx.apply_fxaa=a},get:function(){return this.fx.apply_fxaa},enumerable:!0});sa.prototype.configure=function(a){this.enabled=!!a.enabled;this.use_antialiasing=!!a.use_antialiasing;this.camera_uid=a.camera_uid;a.frame&&this.frame.configure(a.frame);a.fx&&this.fx.configure(a.fx)};
sa.prototype.serialize=function(){return{object_class:"CameraFX",enabled:this.enabled,use_antialiasing:this.use_antialiasing,frame:this.frame.serialize(),camera_uid:this.camera_uid,fx:this.fx.serialize()}};sa.prototype.getResources=function(a){this.fx.getResources(a);this.shader_material&&(a[this.shader_material]=!0);return a};sa.prototype.onResourceRenamed=function(a,b,c){if(this.shader_material==a)this.shader_material=b;else this.fx.onResourceRenamed(a,b,c)};sa.prototype.addFX=function(a){this.fx.addFX(a)};
sa.prototype.getFX=function(a){return this.fx.getFX(a)};sa.prototype.moveFX=function(a,b){return this.fx.moveFX(a,b)};sa.prototype.removeFX=function(a){return this.fx.removeFX(a)};sa.prototype.onAddedToScene=function(a){LEvent.bind(a,"enableFrameContext",this.onBeforeRender,this);LEvent.bind(a,"showFrameContext",this.onAfterRender,this)};sa.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"enableFrameContext",this.onBeforeRender,this);LEvent.unbind(a,"showFrameContext",this.onAfterRender,
this);this._binded_camera&&(LEvent.unbindAll(this._binded_camera,this),this._binded_camera=null)};sa.prototype.onBeforeRender=function(a,b){if(this.enabled){var c=this._root.camera;this.camera_uid&&(c=this._binded_camera&&this._binded_camera.uid==this.camera_uid?this._root.scene.findComponentByUId(this.camera_uid):this._binded_camera);c?(c&&c!=this._binded_camera&&(this._binded_camera&&LEvent.unbindAll(this._binded_camera,this),LEvent.bind(c,"enableFrameContext",this.enableCameraFBO,this),LEvent.bind(c,
"showFrameContext",this.showCameraFBO,this)),this._binded_camera=c):this._binded_camera&&(LEvent.unbindAll(this._binded_camera,this),this._binded_camera=null)}else this._binded_camera&&(LEvent.unbindAll(this._binded_camera,this),this._binded_camera=null)};sa.prototype.onAfterRender=function(a,b){};sa.prototype.enableCameraFBO=function(a,b){if(this.enabled){var c=this._viewport=this._binded_camera.getLocalViewport(null,this._viewport);this.frame.enable(b,c);b.ignore_viewports=!0}};sa.prototype.showCameraFBO=
function(a,b){this.enabled&&(b.ignore_viewports=!1,this.showFBO())};sa.prototype.showFBO=function(){if(this.enabled)if(this.frame.disable(),LEvent.trigger(e.Renderer,"beforeShowFrameContext",this.frame),this.shader_material){var a=e.ResourcesManager.getResource(this.shader_material),b=!1;a&&a.constructor===e.ShaderMaterial&&(b=a.applyToTexture(this.frame._color_texture));b||this.frame._color_texture.toViewport()}else this._viewport?(gl.setViewport(this._viewport),this.applyFX(),gl.setViewport(this.frame._fbo._old_viewport)):
this.applyFX()};sa.prototype.applyFX=function(){var a=this.frame._color_texture,b=this.frame._depth_texture;this.fx.apply_fxaa=this.use_antialiasing;this.fx.filter=this.frame.filter_texture;this.fx.applyFX(a,null,{depth_texture:b})};e.registerComponent(sa);Ea.icon="mini-icon-fx.png";Ea.prototype.configure=function(a){this.enabled=!!a.enabled;this.use_viewport_size=!!a.use_viewport_size;this.use_antialiasing=!!a.use_antialiasing;this.shader_material=a.shader_material;a.fx&&this.fx.configure(a.fx);
a.frame&&this.frame.configure(a.frame)};Ea.prototype.serialize=function(){return{object_class:"FrameFX",enabled:this.enabled,uid:this.uid,frame:this.frame.serialize(),shader_material:this.shader_material,use_antialiasing:this.use_antialiasing,use_viewport_size:this.use_viewport_size,fx:this.fx.serialize()}};Ea.prototype.getResources=function(a){this.fx.getResources(a);this.shader_material&&(a[this.shader_material]=!0);return a};Ea.prototype.onResourceRenamed=function(a,b,c){if(this.shader_material==
a)this.shader_material=b;else this.fx.onResourceRenamed(a,b,c)};Ea.prototype.addFX=function(a){this.fx.addFX(a)};Ea.prototype.getFX=function(a){return this.fx.getFX(a)};Ea.prototype.moveFX=function(a,b){return this.fx.moveFX(a,b)};Ea.prototype.removeFX=function(a){return this.fx.removeFX(a)};Ea.prototype.onAddedToScene=function(a){LEvent.bind(a,"enableFrameContext",this.onBeforeRender,this);LEvent.bind(a,"showFrameContext",this.onAfterRender,this)};Ea.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,
"enableFrameContext",this.onBeforeRender,this);LEvent.unbind(a,"showFrameContext",this.onAfterRender,this)};Ea.prototype.onBeforeRender=function(a,b){this.enabled&&this.enableFrameFBO(b)};Ea.prototype.onAfterRender=function(a,b){this.enabled&&this.showFBO()};Ea.prototype.enableFrameFBO=function(a){this.enabled&&this.frame.enable(a)};Ea.prototype.showFBO=function(){if(this.enabled)if(this.frame.disable(),LEvent.trigger(e.Renderer,"beforeShowFrameContext",this.frame),this.shader_material){var a=e.ResourcesManager.getResource(this.shader_material),
b=!1;a&&a.constructor===e.ShaderMaterial&&(b=a.applyToTexture(this.frame._color_texture));b||this.frame._color_texture.toViewport()}else this._viewport?(gl.setViewport(this._viewport),this.applyFX(),gl.setViewport(this.frame._fbo._old_viewport)):this.applyFX()};Ea.prototype.applyFX=function(){var a=this.frame._color_texture,b=this.frame._depth_texture;this.fx.apply_fxaa=this.use_antialiasing;this.fx.filter=this.frame.filter_texture;this.fx.applyFX(a,null,{depth_texture:b})};e.registerComponent(Ea);
u.NO_ATTENUATION=0;u.LINEAR_ATTENUATION=1;u.RANGE_ATTENUATION=2;u.AttenuationTypes={none:u.NO_ATTENUATION,linear:u.LINEAR_ATTENUATION,range:u.RANGE_ATTENUATION};u["@projective_texture"]={type:e.TYPES.TEXTURE};u["@extra_texture"]={type:e.TYPES.TEXTURE};u["@color"]={type:e.TYPES.COLOR};u["@attenuation_type"]={type:"enum",values:u.AttenuationTypes};Object.defineProperty(u.prototype,"type",{get:function(){return this._type},set:function(a){this._type=this._uniforms.u_light_info[0]=a},enumerable:!0});
Object.defineProperty(u.prototype,"position",{get:function(){return this._position},set:function(a){this._position.set(a)},enumerable:!0});Object.defineProperty(u.prototype,"target",{get:function(){return this._target},set:function(a){this._target.set(a)},enumerable:!0});Object.defineProperty(u.prototype,"extra",{get:function(){return this._uniforms.u_light_extra},set:function(a){a&&this._uniforms.u_light_extra.set(a)},enumerable:!0});Object.defineProperty(u.prototype,"up",{get:function(){return this._up},
set:function(a){this._up.set(a)},enumerable:!0});Object.defineProperty(u.prototype,"color",{get:function(){return this._color},set:function(a){this._color.set(a)},enumerable:!0});Object.defineProperty(u.prototype,"spot_cone",{get:function(){return this._spot_cone},set:function(a){this._spot_cone=a;this._uniforms.u_light_info[1]=a?1:0},enumerable:!0});u.OMNI=1;u.SPOT=2;u.DIRECTIONAL=3;u.DEFAULT_DIRECTIONAL_FRUSTUM_SIZE=50;u.use_shadowmap_depth_texture=!0;u.shadow_shaderblocks=[];u.shadow_shaderblocks_by_name=
[];u.prototype.onAddedToNode=function(a){a.light||(a.light=this)};u.prototype.onRemovedFromNode=function(a){a.light==this&&delete a.light};u.prototype.onAddedToScene=function(a){LEvent.bind(a,"collectLights",this.onCollectLights,this)};u.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"collectLights",this.onCollectLights,this);e.ResourcesManager.unregisterResource(":shadowmap_"+this.uid)};u.prototype.onCollectLights=function(a,b){this.enabled&&b.push(this)};u._temp_matrix=mat4.create();u._temp2_matrix=
mat4.create();u._temp3_matrix=mat4.create();u._temp_position=vec3.create();u._temp_target=vec3.create();u._temp_up=vec3.create();u._temp_front=vec3.create();u.prototype.updateLightCamera=function(){this._light_camera||(this._light_camera=new e.Components.Camera);var a=this._light_camera;a.eye=this.getPosition(u._temp_position);a.center=this.getTarget(u._temp_target);var b=this.getUp(u._temp_up),c=this.getFront(u._temp_front);0.999<Math.abs(vec3.dot(c,b))&&vec3.set(b,0,0,1);a.up=b;a.type=this.type==
u.DIRECTIONAL?e.Components.Camera.ORTHOGRAPHIC:e.Components.Camera.PERSPECTIVE;b=this.computeShadowmapFar();a.frustum_size=this.frustum_size||u.DEFAULT_DIRECTIONAL_FRUSTUM_SIZE;a.near=this.near;a.far=b;a.fov=this.angle_end||45;a.updateMatrices();this._light_matrix.set(a._viewprojection_matrix);return a};u.prototype.getLightCamera=function(){this._light_camera||this.updateLightCamera();return this._light_camera};u.prototype.updateVectors=function(){var a=vec3.create();return function(){if(this._root&&
this._root.transform){var b=this._root.transform.getGlobalMatrixRef();mat4.getTranslation(this._position,b);this.use_target||mat4.multiplyVec3(this._target,b,e.FRONT);mat4.multiplyVec3(this._up,b,e.TOP);mat4.rotateVec3(this._front,b,e.FRONT);mat4.rotateVec3(this._right,b,e.RIGHT);vec3.copy(this._top,this.up)}else vec3.subtract(this._front,this._target,this._position),vec3.normalize(this._front,this._front),vec3.normalize(a,this._up),vec3.cross(this._right,this._front,a),vec3.cross(this._top,this._right,
this._front)}}();u.prototype.getPosition=function(a){a=a||vec3.create();if(this._root&&this._root.transform)return this._root.transform.getGlobalPosition(a);a.set(this._position);return a};u.prototype.getTarget=function(a){a=a||vec3.create();if(this._root&&this._root.transform&&!this.use_target)return this._root.transform.localToGlobal(e.FRONT,a);a.set(this._target);return a};u.prototype.getUp=function(a){a=a||vec3.create();if(this._root&&this._root.transform)return this._root.transform.transformVector(e.TOP,
a);a.set(this._up);return a};u.prototype.getFront=function(a){a=a||vec3.create();this.getPosition(a);vec3.subtract(a,a,this.getTarget(u._temp_position));vec3.normalize(a,a);return a};u.prototype.getResources=function(a){this.projective_texture&&(a[this.projective_texture]=GL.Texture);this.extra_texture&&(a[this.extra_texture]=GL.Texture);return a};u.prototype.onResourceRenamed=function(a,b,c){this.projective_texture==a&&(this.projective_texture=b);this.extra_texture==a&&(this.extra_texture=b)};u.prototype.checkLayersVisibility=
function(a){return 0!==(this.layers&a)};u.prototype.isInLayer=function(a){return 0!==(this.layers&1<<a)};u.prototype.prepare=function(a){var b=this._uniforms,c=this._samplers;(this.projective_texture||this.cast_shadows||this.force_light_matrix)&&this.updateLightCamera();a.shadows_enabled&&this.cast_shadows||!this._shadowmap||(this._shadowmap=null,delete e.ResourcesManager.textures[":shadowmap_"+this.uid]);this.updateVectors();this.cast_shadows&&(this._shadow_shaderblock_info=u.shadow_shaderblocks_by_name[this.shadow_type]);
this.type==u.SPOT&&(b.u_light_angle[0]=this.angle*DEG2RAD,b.u_light_angle[1]=this.angle_end*DEG2RAD,b.u_light_angle[2]=Math.cos(this.angle*DEG2RAD*0.5),b.u_light_angle[3]=Math.cos(this.angle_end*DEG2RAD*0.5));vec3.scale(b.u_light_color,this.color,this.intensity);this._attenuation_info[0]=this.att_start;this._attenuation_info[1]=this.att_end;this._attenuation_info[2]=this.attenuation_type;b.u_light_offset=this.offset;if((a.update_shadowmaps||!this._shadowmap&&!e.ResourcesManager.isLoading())&&a.shadows_enabled&&
!a.lights_disabled&&!a.low_quality){var d=e.Renderer._visible_cameras,f=!1;if(!a.update_all_shadowmaps&&d&&this.type==u.OMNI&&this.attenuation_type>u.LINEAL_ATTENUATION)for(var h=this.computeShadowmapFar(),g=0;g<d.length;g++){if(geo.frustumTestSphere(d[g]._frustum_planes,this.position,h)!=CLIP_OUTSIDE){f=!0;break}}else f=!0;f&&this.generateShadowmap(a)}this._shadowmap&&!this.cast_shadows&&(this._shadowmap=null);this._samplers.length=0;a=this.cast_shadows&&this._shadowmap&&null!=this._light_matrix&&
!a.shadows_disabled;if(this.projective_texture){if(d=this.projective_texture.constructor===String?e.ResourcesManager.textures[this.projective_texture]:this.projective_texture)d.texture_type==gl.TEXTURE_CUBE_MAP?b.light_cubemap=e.Renderer.LIGHTPROJECTOR_TEXTURE_SLOT:b.light_texture=e.Renderer.LIGHTPROJECTOR_TEXTURE_SLOT;c[e.Renderer.LIGHTPROJECTOR_TEXTURE_SLOT]=d}else delete b.light_texture,delete b.light_cubemap;if(this.extra_texture){if(d=this.extra_texture.constructor===String?e.ResourcesManager.textures[this.extra_texture]:
this.extra_texture)d.texture_type==gl.TEXTURE_CUBE_MAP?b.extra_light_cubemap=e.Renderer.LIGHTEXTRA_TEXTURE_SLOT:b.extra_light_texture=e.Renderer.LIGHTEXTRA_TEXTURE_SLOT;c[e.Renderer.LIGHTEXTRA_TEXTURE_SLOT]=d}else delete b.extra_light_texture,delete b.extra_light_cubemap;a?(h=this.computeShadowmapFar(),b.u_shadow_params||(b.u_shadow_params=vec4.create()),b.u_shadow_params.set([1/this._shadowmap.width,this.shadow_bias,this.near,h]),b.shadowmap=e.Renderer.SHADOWMAP_TEXTURE_SLOT,b.u_light_matrix=this._light_matrix,
c[e.Renderer.SHADOWMAP_TEXTURE_SLOT]=this._shadowmap):(delete b.u_shadow_params,delete b.shadowmap)};u.prototype.computeShadowmapFar=function(){var a=this.far;this.type==u.OMNI?this.attenuation_type==u.RANGE_ATTENUATION&&this.att_end*Math.SQRT2<a&&(a=this.att_end/Math.SQRT2):this.attenuation_type==u.RANGE_ATTENUATION&&this.att_end<a&&(a=this.att_end);return a};u.prototype.computeLightIntensity=function(){var a=Math.max(this.color[0],this.color[1],this.color[2]);return Math.max(0,a*this.intensity)};
u.prototype.computeLightRadius=function(){return this.attenuation_type==u.NO_ATTENUATION||this.attenuation_type==u.LINEAR_ATTENUATION?-1:this.type==u.OMNI?this.att_end*Math.SQRT2:this.att_end};u.prototype.generateShadowmap=function(a){if(this.cast_shadows&&!(1E-4>this.computeLightIntensity())){var b=this.shadowmap_resolution;0==b&&(b=a.default_shadowmap_resolution);var c=this.type==u.OMNI?gl.TEXTURE_CUBE_MAP:gl.TEXTURE_2D;if(null==this._shadowmap||this._shadowmap.width!=b||this._shadowmap.texture_type!=
c){var d=gl.UNSIGNED_BYTE,f=gl.RGBA;e.Light.use_shadowmap_depth_texture&&gl.extensions.WEBGL_depth_texture&&this.type!=e.Light.OMNI&&(f=gl.DEPTH_COMPONENT,d=gl.UNSIGNED_INT);this._shadowmap=new GL.Texture(b,b,{type:d,texture_type:c,format:f,magFilter:gl.NEAREST,minFilter:gl.NEAREST});e.ResourcesManager.textures[":shadowmap_"+this.uid]=this._shadowmap;this._shadowmap.texture_type==gl.TEXTURE_2D&&(this._fbo=f==gl.RGBA?new GL.FBO([this._shadowmap]):new GL.FBO(null,this._shadowmap))}e.Renderer.setRenderPass(Rb);
e.Renderer._current_light=this;this.type==u.OMNI?(c=this.computeShadowmapFar(),this._shadowmap.unbind(),e.Renderer.renderToCubemap(this.getPosition(),b,this._shadowmap,a,this.near,c)):(b=this.getLightCamera(),e.Renderer.enableCamera(b,a,!0),this._shadowmap.unbind(),e.Renderer._current_target=this._shadowmap,this._fbo.bind(),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),e.Renderer.renderInstances(a),this._fbo.unbind(),e.Renderer._current_target=null);e.Renderer.setRenderPass(hb);
e.Renderer._current_light=null}};u.prototype.getGlobalMatrix=function(a){if(this._root&&this._root.transform)return this._root.transform.getGlobalMatrix(a);a=a||mat4.create();mat4.lookAt(a,this._position,this._target,e.TOP);return a};u.prototype.getTransformMatrix=function(a,b){if(this._root&&this._root.transform)return this._root.transform.getGlobalMatrix(b);var c=null;if("matrix"==a)return this.getGlobalMatrix(b);var c="target"==a?this.target:this.position,d=b||mat4.create();mat4.setTranslation(d,
c);return d};u.prototype.applyTransformMatrix=function(a,b,c){if(this._root&&this._root.transform)return!1;b=null;b="target"==c?this.target:this.position;mat4.multiplyVec3(b,a,b);return!0};u.prototype.applyShaderBlockFlags=function(a,b,c){if(!this.enabled)return a;a|=u.shader_block.flag_mask;this.attenuation_type&&(a|=u.attenuation_block.flag_mask);this.projective_texture&&(a|=u.light_texture_block.flag_mask);this.cast_shadows&&c.shadows_enabled&&(this.type!=u.OMNI&&(b=this._shadow_shaderblock_info?
this._shadow_shaderblock_info.shaderblock:null)&&(a|=b.flag_mask),this._shadowmap&&this._shadowmap.format==gl.RGBA&&(a|=e.Light.shadowmapping_depth_in_color_block.flag_mask));return a};u.registerShadowType=function(a,b){var c={id:this.shadow_shaderblocks.length,name:a,shaderblock:b};this.shadow_shaderblocks.push(c);this.shadow_shaderblocks_by_name[a]=c};e.registerComponent(u);e.Light=u;Object.defineProperty(U.prototype,"enabled",{get:function(){return this._enabled},set:function(a){this._enabled=
!!a;this.checkRenderInstances()},enumerable:!0});Object.defineProperty(U.prototype,"primitive",{get:function(){return this._primitive},set:function(a){a=void 0===a||null===a?-1:a|0;-1>a||10<a||(this._primitive=a,this.updateRIs())},enumerable:!0});Object.defineProperty(U.prototype,"material",{get:function(){return this._material},set:function(a){this._material=a;this.updateRIs()},enumerable:!0});Object.defineProperty(U.prototype,"mesh",{get:function(){return this._mesh},set:function(a){this._mesh=
a;this.updateRIs()},enumerable:!0});Object.defineProperty(U.prototype,"lod_mesh",{get:function(){return this._lod_mesh},set:function(a){this._lod_mesh=a;this.updateRIs()},enumerable:!0});Object.defineProperty(U.prototype,"submesh_id",{get:function(){return this._submesh_id},set:function(a){this._submesh_id=a},enumerable:!0});Object.defineProperty(U.prototype,"render_instance",{get:function(){return this._RI},set:function(a){throw"cannot set a render_instance, must use the collectRenderInstances process.";
},enumerable:!1});U.icon="mini-icon-teapot.png";U["@mesh"]={type:"mesh"};U["@lod_mesh"]={type:"mesh"};U["@material"]={type:"material"};U["@primitive"]={type:"enum",values:{Default:-1,Points:0,Lines:1,LineLoop:2,LineStrip:3,Triangles:4,TriangleStrip:5,TriangleFan:6,Wireframe:10}};U["@submesh_id"]={type:"enum",values:function(){var a=this.instance.getMesh();if(!(a&&a&&a.info&&a.info.groups)||2>a.info.groups.length)return null;for(var b={all:null},c=0;c<a.info.groups.length;++c)b[a.info.groups[c].name]=
c;return b}};U["@use_submaterials"]={type:e.TYPES.BOOLEAN,widget:null};U["@submaterials"]={widget:null};U.prototype.onAddedToScene=function(a){this.checkRenderInstances()};U.prototype.onRemovedFromScene=function(a){this.checkRenderInstances()};U.prototype.onAddedToNode=function(a){LEvent.bind(a,"materialChanged",this.updateRIs,this);LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this);this._RI.node=a};U.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"materialChanged",this.updateRIs,
this);LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};U.prototype.configure=function(a){a.uid&&(this.uid=a.uid);void 0!==a.enabled&&(this.enabled=a.enabled);this.mesh=a.mesh;this.lod_mesh=a.lod_mesh;void 0!==a.submesh_id&&(this.submesh_id=a.submesh_id);this.primitive=a.primitive;this.material=a.material;this.use_submaterials=!!a.use_submaterials;a.submaterials&&(this.submaterials=a.submaterials);a.material&&a.material.constructor===String&&(this.material=a.material)};U.prototype.serialize=
function(){var a={object_class:"MeshRenderer",enabled:this.enabled,uid:this.uid,mesh:this.mesh,lod_mesh:this.lod_mesh};this.material&&this.material.constructor===String&&(a.material=this.material);-1!=this.primitive&&(a.primitive=this.primitive);-1!=this.submesh_id&&(a.submesh_id=this.submesh_id);a.material=this.material;this.use_submaterials&&(a.use_submaterials=this.use_submaterials);a.submaterials=this.submaterials;return a};U.prototype.getMesh=function(){return this.mesh?this.mesh.constructor===
String?e.ResourcesManager.meshes[this.mesh]:this.mesh:null};U.prototype.getLODMesh=function(){return this.lod_mesh?this.lod_mesh.constructor===String?e.ResourcesManager.meshes[this.lod_mesh]:null:null};U.prototype.getAnyMesh=function(){return this.getMesh()||this.getLODMesh()};U.prototype.getResources=function(a){this.mesh&&this.mesh.constructor===String&&(a[this.mesh]=GL.Mesh);this.lod_mesh&&this.lod_mesh.constructor===String&&(a[this.lod_mesh]=GL.Mesh);this.material&&this.material.constructor===
String&&(a[this.material]=e.Material);if(this.use_submaterials)for(var b=0;b<this.submaterials.length;++b)this.submaterials[b]&&(a[this.submaterials[b]]=e.Material);return a};U.prototype.onResourceRenamed=function(a,b,c){this.mesh==a&&(this.mesh=b);this.lod_mesh==a&&(this.lod_mesh=b);this.material==a&&(this.material=b);if(this.morph_targets)for(var d in this.morph_targets)this.morph_targets[d].mesh==a&&(this.morph_targets[d].mesh=b)};U.prototype.checkRenderInstances=function(){};U.prototype.updateRIs=
function(){};U.prototype.onCollectInstances=function(a,b){if(this._enabled)if(this.use_submaterials)this.onCollectInstancesSubmaterials(b);else{var c=this.getAnyMesh();if(!c)return null;if(this._root){var d=this._RI,f=this._root.flags&&this._root.flags.is_static,h=this._root.transform;d.layers=this._root.layers;d.fromNode(this._root);var g=null,g=this.material?e.ResourcesManager.getResource(this.material):this._root.getMaterial();d.setMaterial(g);d.setMesh(c,this.primitive);if(-1!=this.submesh_id&&
null!=this.submesh_id&&c.info&&c.info.groups){if(g=c.info.groups[this.submesh_id])d.setRange(g.start,g.length),g.bounding&&d.setBoundingBox(g.bounding)}else d.setRange(0,-1);d.collision_mesh=c;f&&e.allow_static&&!this.isLoading()&&(this._must_update_static=!1,this._transform_version=h?h._version:0);b.push(d)}}};U.prototype.onCollectInstancesSubmaterials=function(a){this._RIs||(this._RIs=[]);var b=this.getMesh();if(b){var c=b.info.groups;if(c){var d=this._root.transform._global_matrix,f=vec3.create();
mat4.multiplyVec3(f,d,e.ZEROS);for(var d=null,h=0;h<this.submaterials.length;++h){var g=this.submaterials[h];if(g){var k=c[h];if(k&&(g=e.ResourcesManager.getResource(g))){var m=this._RIs[h];m||(m=this._RIs[h]=new e.RenderInstance(this._root,this));d?m.setMatrix(d.matrix,d.normal_matrix):m.setMatrix(this._root.transform._global_matrix);m.center.set(f);m.setMaterial(g);m.setMesh(b,this.primitive);m.setRange(k.start,k.length);a.push(m);d||(d=m)}}}}}};U.prototype.isLoading=function(){return this.mesh&&
e.ResourcesManager.isLoading(this.mesh)||this.lod_mesh&&e.ResourcesManager.isLoading(this.lod_mesh)||this.material&&e.ResourcesManager.isLoading(this.material)||this._root&&this._root.material&&this._root.material.constructor===String&&e.ResourcesManager.isLoading(this._root.material)?!0:!1};U.prototype.explodeSubmeshesToChildNodes=function(){var a=this._root;if(a){var b=this.getMesh();if(b&&b.info&&b.info.groups){a.removeComponent(this);for(var c=0;c<b.info.groups.length;++c){var d=b.info.groups[c],
f=new e.SceneNode;a.addChild(f);d=new e.Components.MeshRenderer({mesh:this.mesh,submesh_id:c,material:d.material});f.addComponent(d)}e.GlobalScene.refresh()}}};e.registerComponent(U);e.MeshRenderer=U;Object.defineProperty(V.prototype,"primitive",{get:function(){return this._primitive},set:function(a){a=void 0===a||null===a?-1:a|0;if(-1==a||0==a||1==a||4==a||10==a)this._primitive=a},enumerable:!0});V.MAX_BONES=64;V.gpu_skinning_supported=!0;V.icon="mini-icon-stickman.png";V["@mesh"]={widget:"mesh"};
V["@lod_mesh"]={widget:"mesh"};V["@primitive"]={widget:"combo",values:{Default:null,Points:0,Lines:1,Triangles:4,Wireframe:10}};V["@submesh_id"]={widget:"combo",values:function(){var a=this.instance.getMesh();if(!(a&&a&&a.info&&a.info.groups)||2>a.info.groups.length)return null;for(var b={all:null},c=0;c<a.info.groups.length;++c)b[a.info.groups[c].name]=c;return b}};V.prototype.onAddedToNode=function(a){a.meshrenderer||(a.meshrenderer=this);LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,
this)};V.prototype.onRemovedFromNode=function(a){a.meshrenderer&&delete a.meshrenderer;LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};V.prototype.configure=function(a){null!=a.enabled&&(this.enabled=!!a.enabled);this.cpu_skinning=!!a.cpu_skinning;this.ignore_transform=!!a.ignore_transform;this.mesh=a.mesh;this.lod_mesh=a.lod_mesh;this.submesh_id=a.submesh_id;this.primitive=a.primitive;this.two_sided=!!a.two_sided;void 0!==a.point_size&&(this.point_size=a.point_size);a.material&&
(this.material="string"==typeof a.material?a.material:new x(a.material))};V.prototype.serialize=function(){var a={object_class:"SkinnedMeshRenderer",enabled:this.enabled,apply_skinning:this.apply_skinning,cpu_skinning:this.cpu_skinning,ignore_transform:this.ignore_transform,mesh:this.mesh,lod_mesh:this.lod_mesh,primitive:this.primitive,submesh_id:this.submesh_id,two_sided:this.two_sided,point_size:this.point_size};this.material&&(a.material="string"==typeof this.material?this.material:this.material.serialize());
return a};V.prototype.getMesh=function(){return e.ResourcesManager.getMesh(this.mesh)};V.prototype.getLODMesh=function(){return e.ResourcesManager.getMesh(this.lod_mesh)};V.prototype.getResources=function(a){"string"==typeof this.mesh&&(a[this.mesh]=Mesh);"string"==typeof this.lod_mesh&&(a[this.lod_mesh]=Mesh);return a};V.prototype.onResourceRenamed=function(a,b,c){this.mesh==a&&(this.mesh=b);this.lod_mesh==a&&(this.lod_mesh=b)};V.prototype.getNodeMatrix=function(a){var b=this._root.scene;if(!b)return null;
a=b.getNode(a);if(!a)return null;a._is_bone=!0;return a.transform.getGlobalMatrixRef()};V.prototype.getBoneMatrices=function(a){var b=this._last_bones;if(!this._last_bones||this._last_bones.length!=a.bones.length)for(var b=this._last_bones=[],c=0;c<a.bones.length;++c)b[c]=mat4.create();for(c=0;c<a.bones.length;++c){var d=b[c],f=a.bones[c],e=this.getNodeMatrix(f[0]);e?(mat4.multiply(d,e,f[1]),a.bind_matrix&&mat4.multiply(d,d,a.bind_matrix)):mat4.identity(d)}return b};V.prototype.onCollectInstances=
function(a,b,c){if(this.enabled){c=this.getMesh();if(!c)return null;if(this._root&&(a=this._render_instance,a||(this._render_instance=a=new e.RenderInstance(this._root,this)),c.getBuffer("vertices")&&c.getBuffer("bone_indices"))){if(this.apply_skinning)if(V.gpu_skinning_supported&&!this.cpu_skinning){a.setMesh(c,this.primitive);var d=this.getBoneMatrices(c),f=12*d.length,h=this._u_bones;h&&h.length==f||(this._u_bones=h=new Float32Array(f));for(var g=0;g<d.length;g++)mat4.transpose(d[g],d[g]),h.set(d[g].subarray(0,
12),12*g,12*(g+1));V.num_supported_uniforms>=f?(a.uniforms.u_bones=h,delete a.samplers.u_bones):0<V.num_supported_textures?(g=this._bones_texture,g||(g=this._bones_texture=new GL.Texture(1,3*d.length,{format:gl.RGBA,type:gl.FLOAT,filter:gl.NEAREST}),g._data=new Float32Array(g.width*g.height*4)),g._data.set(h),g.uploadData(g._data,{no_flip:!0}),e.RM.textures[":bones"]=g,a.samplers.u_bones=g,delete a.uniforms.u_bones):console.error("impossible to get here")}else{if(!this._skinned_mesh||this._skinned_mesh._reference!=
c){this._skinned_mesh=new GL.Mesh;this._skinned_mesh._reference=c;d=c.getBuffer("vertices");h=c.getBuffer("normals");for(g in c.vertexBuffers)this._skinned_mesh.vertexBuffers[g]=c.vertexBuffers[g];for(g in c.indexBuffers)this._skinned_mesh.indexBuffers[g]=c.indexBuffers[g];this._skinned_mesh.createVertexBuffer("vertices","a_vertex",3,new Float32Array(d.data),gl.STREAM_DRAW);h&&this._skinned_mesh.createVertexBuffer("normals","a_normal",3,new Float32Array(h.data),gl.STREAM_DRAW)}this.applySkin(c,this._skinned_mesh);
a.setMesh(this._skinned_mesh,this.primitive);delete a.samplers.u_bones}else a.setMesh(c,this.primitive),delete a.samplers.u_bones;this.ignore_transform?mat4.identity(a.matrix):this._root.transform.getGlobalMatrix(a.matrix);mat4.multiplyVec3(a.center,a.matrix,vec3.create());-1!=this.submesh_id&&null!=this.submesh_id&&c.info&&c.info.groups?(g=c.info.groups[this.submesh_id])&&a.setRange(g.start,g.length):a.setRange(0,-1);a.material=this.material||this._root.getMaterial();this.apply_skinning&&(a.use_bounding=
!1);this.primitive==gl.POINTS&&(a.uniforms.u_point_size=this.point_size);b.push(a)}}};V.zero_matrix=new Float32Array(16);V.prototype.applySkin=function(a,b){var c=a.getBuffer("vertices").data,d=null;a.getBuffer("normals")&&(d=a.getBuffer("normals").data);var f=a.getBuffer("weights").data,e=a.getBuffer("bone_indices").data,g=b.getBuffer("vertices"),k=g.data,m=null,l=null;d&&(m=b.getBuffer("normals"),l=m.data);var n=this.getBoneMatrices(a);if(0==n.length)return null;vec3.create();vec3.create();for(var p=
mat4.create(),q=0,r=k.length/3;q<r;++q){c.subarray(3*q,3*q+3);var s=e.subarray(4*q,4*q+4),t=f.subarray(4*q,4*q+4),K=k.subarray(3*q,3*q+3),s=[n[s[0]],n[s[1]],n[s[2]],n[s[3]]];p.set(V.zero_matrix);mat4.scaleAndAdd(p,p,s[0],t[0]);0<t[1]&&mat4.scaleAndAdd(p,p,s[1],t[1]);0<t[2]&&mat4.scaleAndAdd(p,p,s[2],t[2]);0<t[3]&&mat4.scaleAndAdd(p,p,s[3],t[3]);mat4.multiplyVec3(K,p,c.subarray(3*q,3*q+3));l&&(t=l.subarray(3*q,3*q+3),mat4.rotateVec3(t,p,d.subarray(3*q,3*q+3)))}g.upload(gl.STREAM_DRAW);m&&m.upload(gl.STREAM_DRAW)};
V.prototype.extractSkeleton=function(){};e.registerComponent(V);e.SkinnedMeshRenderer=V;H.AUTOMATIC=0;H.CPU=1;H.STREAMS=2;H.TEXTURES=3;H.icon="mini-icon-teapot.png";H.force_GPU=!0;H["@mode"]={type:"enum",values:{automatic:H.AUTOMATIC,CPU:H.CPU,streams:H.STREAMS,textures:H.TEXTURES}};H.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};H.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this);
this._last_RI&&this.disableMorphingGPU(this._last_RI);this._last_RI=null};H.prototype.getResources=function(a){for(var b=0;b<this.morph_targets.length;++b)this.morph_targets[b].mesh&&(a[this.morph_targets[b].mesh]=GL.Mesh)};H.prototype.onResourceRenamed=function(a,b,c){for(c=0;c<this.morph_targets.length;++c)this.morph_targets[c].mesh==a&&(this.morph_targets[c].mesh=b)};H.prototype.clearWeights=function(){for(var a=0;a<this.morph_targets.length;++a)this.morph_targets[a].weight=0};H.prototype.addMorph=
function(a,b){b=b||0;var c=this.getMorphIndex(a);-1==c?this.morph_targets.push({mesh:a,weight:b}):this.morph_targets[c]={mesh:a,weight:b}};H.prototype.onCollectInstances=function(a,b){if(b.length&&!(16>H.max_supported_vertex_attribs)){var c=this.enabled?b[b.length-1]:null;c!=this._last_RI&&this._last_RI&&this.disableMorphingGPU(this._last_RI);if((this._last_RI=c)&&c.mesh)if(this._last_base_mesh=c.mesh,this._valid_morphs=this.computeValidMorphs(this._valid_morphs,c.mesh),this.mode===H.AUTOMATIC){if(void 0===
this._morph_texture_supported&&(this._morph_texture_supported=void 0!==gl.extensions.OES_texture_float&&1<gl.getParameter(gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)),0!=this._valid_morphs.length||H.force_GPU)this._valid_morphs.length<=H.max_supported_morph_targets_using_streams?this.applyMorphTargetsByGPU(c,this._valid_morphs):this._morph_texture_supported?this.applyMorphUsingTextures(c,this._valid_morphs):this.applyMorphBySoftware(c,this._valid_morphs)}else switch(this.mode){case H.STREAMS:this.applyMorphTargetsByGPU(c,
this._valid_morphs);break;case H.TEXTURES:this.applyMorphUsingTextures(c,this._valid_morphs);break;default:this.applyMorphBySoftware(c,this._valid_morphs)}}};H.prototype.computeValidMorphs=function(a,b){a=a||[];a.length=0;if(!b)return a;var c=this.morph_targets.concat();c.sort(function(a,b){return Math.abs(b.weight)-Math.abs(a.weight)});for(var d=0;d<c.length;++d){var f=c[d];if(f.mesh&&!(0.001>Math.abs(f.weight))){var h=e.ResourcesManager.resources[f.mesh];h&&h.constructor===GL.Mesh&&(h.info||(h.info=
{}),h.info.morph_target_from=b.filename,a.push({name:f.mesh,weight:f.weight,mesh:h}))}}return a};H.prototype.applyMorphTargetsByGPU=function(a,b){for(var c=a.mesh,d=c.vertexBuffers.vertices,f={},h=[],g=0;g<b.length&&4>g;++g){var k=b[g],m=k.mesh,l=m.vertexBuffers.vertices;l&&l.data.length==d.data.length&&(m=m.vertexBuffers.normals)&&(l=l.clone(!0),m=m.clone(!0),l.attribute=null,m.attribute=null,f["a_vertex_morph"+g]=l,f["a_normal_morph"+g]=m,h.push(k.weight))}a.vertex_buffers={};for(g in c.vertexBuffers)a.vertex_buffers[g]=
c.vertexBuffers[g];for(g in f)a.vertex_buffers[g]=f[g];a.samplers[e.Renderer.MORPHS_TEXTURE_SLOT]&&(delete a.uniforms.u_morph_vertices_texture,delete a.uniforms.u_morph_normals_texture,a.samplers[e.Renderer.MORPHS_TEXTURE_SLOT]=null,a.samplers[e.Renderer.MORPHS_TEXTURE2_SLOT]=null);if(c=this._stream_weights)if(c.fill)c.fill(0);else for(g=0;g<c.length;++g)c[g]=0;else c=this._stream_weights=new Float32Array(4);c.set(h);a.uniforms.u_morph_weights=c;a.addShaderBlock(H.shader_block);a.addShaderBlock(e.MorphDeformer.morphing_streams_block,
{u_morph_weights:c});a.removeShaderBlock(e.MorphDeformer.morphing_texture_block)};H.prototype.applyMorphUsingTextures=function(a,b){var c=a.mesh,d=c.vertexBuffers.vertices,f=c.vertexBuffers.normals;d._texture||(d._texture=this.createGeometryTexture(d));f._texture||(f._texture=this.createGeometryTexture(f));var h=[];this._morphtarget_vertices_texture&&this._morphtarget_vertices_texture.height==d._texture.height||(this._morphtarget_vertices_texture=new GL.Texture(d._texture.width,d._texture.height,
{format:gl.RGB,type:gl.FLOAT,filter:gl.NEAREST,wrap:gl.CLAMP_TO_EDGE,no_flip:!0}),this._morphtarget_normals_texture=new GL.Texture(f._texture.width,f._texture.height,{format:gl.RGB,type:gl.FLOAT,filter:gl.NEAREST,wrap:gl.CLAMP_TO_EDGE,no_flip:!0}),this._texture_size=vec4.fromValues(this._morphtarget_vertices_texture.width,this._morphtarget_vertices_texture.height,1/this._morphtarget_vertices_texture.width,1/this._morphtarget_vertices_texture.height));for(c=0;c<b.length;++c){var g=b[c],k=g.mesh,m=
k.vertexBuffers.vertices;m&&m.data.length==d.data.length&&(k=k.vertexBuffers.normals)&&(m._texture||(m._texture=this.createGeometryTexture(m)),k._texture||(k._texture=this.createGeometryTexture(k)),h.push({weight:g.weight,vertices:m._texture,normals:k._texture}))}var l=this.getMorphTextureShader();l.uniforms({u_base_texture:0,u_morph_texture:1});gl.disable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.ONE,gl.ONE);d._texture.bind(0);var n=GL.Mesh.getScreenQuad();this._morphtarget_vertices_texture.drawTo(function(){gl.clearColor(0,
0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);for(var a=0;a<h.length;++a)h[a].vertices.bind(1),l.uniforms({u_weight:h[a].weight}),l.draw(n,gl.TRIANGLES)});f._texture.bind(0);this._morphtarget_normals_texture.drawTo(function(){gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);for(var a=0;a<h.length;++a)h[a].normals.bind(1),l.uniforms({u_weight:h[a].weight}),l.draw(n,gl.TRIANGLES)});gl.disable(gl.BLEND);d=d.data.length/3;if(!this._ids_buffer||this._ids_buffer.data.length!=d){f=new Float32Array(d);for(c=0;c<
d;++c)f[c]=c;this._ids_buffer=new GL.Buffer(gl.ARRAY_BUFFER,f,1,gl.STATIC_DRAW);this._ids_buffer.attribute="a_morphing_ids"}a.uniforms.u_morph_vertices_texture=e.Renderer.MORPHS_TEXTURE_SLOT;a.samplers[e.Renderer.MORPHS_TEXTURE_SLOT]=this._morphtarget_vertices_texture;a.uniforms.u_morph_normals_texture=e.Renderer.MORPHS_TEXTURE2_SLOT;a.samplers[e.Renderer.MORPHS_TEXTURE2_SLOT]=this._morphtarget_normals_texture;a.uniforms.u_morph_texture_size=this._texture_size;a.vertex_buffers.a_morphing_ids=this._ids_buffer;
a.addShaderBlock(H.shader_block);a.addShaderBlock(e.MorphDeformer.morphing_texture_block,{u_morph_vertices_texture:e.Renderer.MORPHS_TEXTURE_SLOT,u_morph_normals_texture:e.Renderer.MORPHS_TEXTURE2_SLOT,u_morph_texture_size:this._texture_size});a.removeShaderBlock(e.MorphDeformer.morphing_streams_block)};H.prototype.disableMorphingGPU=function(a){a&&(a.samplers[e.Renderer.MORPHS_TEXTURE_SLOT]&&(a.samplers[e.Renderer.MORPHS_TEXTURE_SLOT]=null,a.samplers[e.Renderer.MORPHS_TEXTURE2_SLOT]=null,delete a.uniforms.u_morph_vertices_texture,
delete a.uniforms.u_morph_normals_texture),a.removeShaderBlock(e.MorphDeformer.shader_block),a.removeShaderBlock(e.MorphDeformer.morphing_streams_block),a.removeShaderBlock(e.MorphDeformer.morphing_texture_block))};H.prototype.applyMorphBySoftware=function(a,b){var c=a.mesh,d=c.vertexBuffers.vertices;this.disableMorphingGPU(a);for(var f="",d=0;d<b.length;++d)var e=b[d],f=f+(e.name+"|"+e.weight.toFixed(2)+"|");if(f==this._last_key)this._final_vertices_buffer&&(a.vertex_buffers.vertices=this._final_vertices_buffer),
this._final_normals_buffer&&(a.vertex_buffers.normals=this._final_normals_buffer);else{this._last_key=f;d=c.vertexBuffers.vertices;f=d.data;c=c.vertexBuffers.normals.data;this._final_vertices&&this._final_vertices.length==f.length||(this._final_vertices=new Float32Array(f.length),this._final_vertices_buffer=new GL.Buffer(gl.ARRAY_BUFFER,this._final_vertices,3,gl.STREAM_DRAW),this._final_vertices_buffer.attribute="a_vertex");this._final_normals&&this._final_normals.length==c.length||(this._final_normals=
new Float32Array(c.length),this._final_normals_buffer=new GL.Buffer(gl.ARRAY_BUFFER,this._final_normals,3,gl.STREAM_DRAW),this._final_normals_buffer.attribute="a_normal");var g=this._final_vertices,k=this._final_normals;g.set(f);k.set(c);for(var m=[],l=[],n=[],p=b.length,d=0;d<b.length;++d)e=b[d],m.push(e.mesh.vertexBuffers.vertices.data),l.push(e.mesh.vertexBuffers.normals.data),n.push(e.weight);d=0;for(e=g.length;d<e;d+=3)for(var q=g.subarray(d,d+3),r=k.subarray(d,d+3),s=0;s<p;++s){var t=m[s],K=
l[s],G=n[s];q[0]+=(t[d]-f[d])*G;q[1]+=(t[d+1]-f[d+1])*G;q[2]+=(t[d+2]-f[d+2])*G;r[0]+=(K[d]-c[d])*G;r[1]+=(K[d+1]-c[d+1])*G;r[2]+=(K[d+2]-c[d+2])*G}this._final_vertices_buffer.upload(gl.STREAM_DRAW);this._final_normals_buffer.upload(gl.STREAM_DRAW);a.vertex_buffers.vertices=this._final_vertices_buffer;a.vertex_buffers.normals=this._final_normals_buffer}};H._blend_shader_fragment_code="\n\tprecision highp float;\n\tuniform sampler2D u_base_texture;\n\tuniform sampler2D u_morph_texture;\n\tuniform float u_weight;\n\tvarying vec2 v_coord;\n\tvoid main() {\n\t\tgl_FragColor = u_weight * ( texture2D(u_morph_texture, v_coord) - texture2D(u_base_texture, v_coord) );\n\t\tgl_FragColor.w = 1.0;\n\t}\n";
H.prototype.getMorphTextureShader=function(){this._blend_shader||(this._blend_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,H._blend_shader_fragment_code));return this._blend_shader};H.prototype.createGeometryTexture=function(a){a=a.data;var b=gl.getParameter(gl.MAX_TEXTURE_SIZE),c=a.length/3,b=Math.min(b,c),c=Math.ceil(c/b),d=new Float32Array(b*c*3);d.set(a);return new GL.Texture(b,c,{format:gl.RGB,type:gl.FLOAT,filter:gl.NEAREST,wrap:gl.CLAMP_TO_EDGE,pixel_data:d,no_flip:!0})};H.prototype.getMorphIndex=
function(a){for(var b=0;b<this.morph_targets.length;++b)if(this.morph_targets[b].mesh==a)return b;return-1};H.prototype.setMorphMesh=function(a,b){a>=this.morph_targets.length||(this.morph_targets[a].mesh=b)};H.prototype.setMorphWeight=function(a,b){a>=this.morph_targets.length||(this.morph_targets[a].weight=b)};H.prototype.getPropertyInfoFromPath=function(a){if("morphs"==a[0]){if(1==a.length)return{node:this._root,target:this.morph_targets,type:"object"};var b=parseInt(a[1]);if(!(b>=this.morph_targets.length)&&
(a=a[2],"mesh"==a||"weight"==a))return{node:this._root,target:this.morph_targets[b],name:a,value:void 0!==this.morph_targets[b][a]?this.morph_targets[b][a]:null,type:"mesh"==a?"mesh":"number"}}};H.prototype.setPropertyValueFromPath=function(a,b,c){c=c||0;if(!(a.length<c+1)&&"morphs"==a[c]){var d=parseInt(a[c+1]);d>=this.morph_targets.length||(this.morph_targets[d][a[c+2]]=b)}};H.prototype.setProperty=function(a,b){if("enabled"==a)this.enabled=b;else if("morph"==a.substr(0,5)){a=a.substr(5);var c=
a.split("_"),d=parseInt(c[0]);d<this.morph_targets.length&&("weight"==c[1]?this.morph_targets[d].weight=b:"mesh"==c[1]&&(this.morph_targets[d].mesh=b))}};H.prototype.getPropertiesInfo=function(){for(var a={enabled:"boolean"},b=0;b<this.morph_targets.length;b++)a["morph"+b+"_weight"]="number",a["morph"+b+"_mesh"]="Mesh";return a};H.prototype.getBaseMesh=function(){if(!this._root)return null;if(this._last_base_mesh)return this._last_base_mesh;var a=this._root.getComponent(e.Components.MeshRenderer);
return a?e.ResourcesManager.resources[a.mesh]:null};H.prototype.optimizeMorphTargets=function(){for(var a=this.getBaseMesh(),b=this.morph_targets.concat(),c=0;c<b.length;++c){var d=b[c],f=e.ResourcesManager.meshes[d.mesh];if(f)if(f.removeVertexBuffer("coords",!0),f.removeIndexBuffer("triangles",!0),f.removeIndexBuffer("wireframe",!0),a&&0.1>H.computeMeshDifference(a,f)){var h=f.fullpath||f.filename;console.log("morph target is too similar to base mesh, removing it: "+h);d=this.morph_targets.indexOf(d);
this.morph_targets.splice(d,1);e.ResourcesManager.unregisterResource(h);(f=f.from_pack||f.from_prefab)&&(f=e.ResourcesManager.resources[f])&&f.removeResource(h)}else e.ResourcesManager.resourceModified(f)}console.log("Morph targets optimized")};H.computeMeshDifference=function(a,b){if(!(a&&b&&a.vertexBuffers.vertices&&b.vertexBuffers.vertices))return 0;var c=a.vertexBuffers.vertices.data,d=b.vertexBuffers.vertices.data;if(!c||!d||c.length!=d.length)return 0;for(var f=0,e=0;e<c.length;e+=3)f+=vec3.distance(c.subarray(e,
e+3),d.subarray(e,e+3));return f};e.registerComponent(H);e.MorphDeformer=H;H.morph_streams_enabled_shader_code="\n\t\n\t//max vertex attribs are 16 usually, so 10 are available after using 6 for V,N,UV,UV2,BW,BI\n\tattribute vec3 a_vertex_morph0;\n\tattribute vec3 a_normal_morph0;\n\tattribute vec3 a_vertex_morph1;\n\tattribute vec3 a_normal_morph1;\n\tattribute vec3 a_vertex_morph2;\n\tattribute vec3 a_normal_morph2;\n\tattribute vec3 a_vertex_morph3;\n\tattribute vec3 a_normal_morph3;\n\t\n\tuniform vec4 u_morph_weights;\n\t\n\tvoid applyMorphing( inout vec4 position, inout vec3 normal )\n\t{\n\t\tvec3 original_vertex = position.xyz;\n\t\tvec3 original_normal = normal.xyz;\n\t\t\n\t\tif(u_morph_weights[0] != 0.0)\n\t\t{\n\t\t\tposition.xyz += (a_vertex_morph0 - original_vertex) * u_morph_weights[0]; normal.xyz += (a_normal_morph0 - original_normal) * u_morph_weights[0];\n\t\t}\n\t\tif(u_morph_weights[1] != 0.0)\n\t\t{\n\t\t\tposition.xyz += (a_vertex_morph1 - original_vertex) * u_morph_weights[1]; normal.xyz += (a_normal_morph1 - original_normal) * u_morph_weights[1];\n\t\t}\n\t\tif(u_morph_weights[2] != 0.0)\n\t\t{\n\t\t\tposition.xyz += (a_vertex_morph2 - original_vertex) * u_morph_weights[2]; normal.xyz += (a_normal_morph2 - original_normal) * u_morph_weights[2];\n\t\t}\n\t\tif(u_morph_weights[3] != 0.0)\n\t\t{\n\t\t\tposition.xyz += (a_vertex_morph3 - original_vertex) * u_morph_weights[3]; normal.xyz += (a_normal_morph3 - original_normal) * u_morph_weights[3];\n\t\t}\n\t}\n";
H.morph_texture_enabled_shader_code="\n\t\n\tattribute float a_morphing_ids;\n\t\n\tuniform sampler2D u_morph_vertices_texture;\n\tuniform sampler2D u_morph_normals_texture;\n\tuniform vec4 u_morph_texture_size;\n\t\n\tuniform vec4 u_morph_weights;\n\t\n\tvoid applyMorphing( inout vec4 position, inout vec3 normal )\n\t{\n\t\tvec2 coord;\n\t\tcoord.x = ( mod( a_morphing_ids, u_morph_texture_size.x ) + 0.5 ) / u_morph_texture_size.x;\n\t\tcoord.y = 1.0 - ( floor( a_morphing_ids / u_morph_texture_size.x ) + 0.5 ) / u_morph_texture_size.y;\n\t\tposition.xyz += texture2D( u_morph_vertices_texture, coord ).xyz;\n\t\tnormal.xyz += texture2D( u_morph_normals_texture, coord ).xyz;\n\t}\n";
H.morph_enabled_shader_code="\n\t\n\t#pragma shaderblock morphing_mode\n";H.morph_disabled_shader_code="\nvoid applyMorphing( inout vec4 position, inout vec3 normal ) {}\n";var Nb=new e.ShaderBlock("morphing");Nb.addCode(GL.VERTEX_SHADER,H.morph_enabled_shader_code,H.morph_disabled_shader_code);Nb.register();H.shader_block=Nb;var zb=new e.ShaderBlock("morphing_streams");zb.defineContextMacros({morphing_mode:"morphing_streams"});zb.addCode(GL.VERTEX_SHADER,H.morph_streams_enabled_shader_code,H.morph_disabled_shader_code);
zb.register();H.morphing_streams_block=zb;var Ab=new e.ShaderBlock("morphing_texture");Ab.defineContextMacros({morphing_mode:"morphing_texture"});Ab.addCode(GL.VERTEX_SHADER,H.morph_texture_enabled_shader_code,H.morph_disabled_shader_code);Ab.register();H.morphing_texture_block=Ab;L.icon="mini-icon-stickman.png";L.MAX_BONES=64;L.MAX_TEXTURE_BONES=128;L.gpu_skinning_supported=!0;L.icon="mini-icon-stickman.png";L.apply_to_normals_by_software=!1;L["@skeleton_root_node"]={type:e.TYPES.SCENENODE};L.prototype.onAddedToNode=
function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};L.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};L.prototype.getBoneNode=function(a){var b=this._root,c=b.scene;if(!c)return null;if(this.skeleton_root_node){if(b=c.getNode(this.skeleton_root_node))return b.findNodeByName(a)}else return this.search_bones_in_parent?b.parentNode.findNode(a):c.getNode(a);return null};L.prototype.getBoneMatrix=function(a){a=
this.getBoneNode(a);if(!a)return null;a._is_bone=!0;return a.transform.getGlobalMatrixRef()};L.prototype.getBoneMatrices=function(a){var b=this._last_bones;if(!this._last_bones||this._last_bones.length!=a.bones.length)for(var b=this._last_bones=[],c=0;c<a.bones.length;++c)b[c]=mat4.create();for(c=0;c<a.bones.length;++c){var d=b[c],f=a.bones[c],e=this.getBoneMatrix(f[0]);e?(mat4.multiply(d,e,f[1]),a.bind_matrix&&mat4.multiply(d,d,a.bind_matrix)):mat4.identity(d)}return b};L.prototype.onCollectInstances=
function(a,b){if(b.length&&this.root){var c,d=this.root.getIndexOfComponent(this);if(d=this.root.getComponentByIndex(d-1))c=d._RI;c&&(this._ris_skinned.length=0,this.enabled?this.applySkinning(c):this.disableSkinning(c))}};L.prototype.applySkinning=function(a){var b=a.mesh;this._mesh=b;this._ris_skinned.push(a);if(b&&b.getBuffer("vertices")&&b.getBuffer("bone_indices")){if(L.gpu_skinning_supported&&!this.cpu_skinning){var c=this.getBoneMatrices(b),d=12*c.length;if(!c.length){console.warn("SkinDeformer.prototype.applySkinning: Bones not found");
return}b=this._u_bones;b&&b.length==d||(this._u_bones=b=new Float32Array(d));for(var f=0;f<c.length;f++)mat4.transpose(c[f],c[f]),b.set(c[f].subarray(0,12),12*f,12*(f+1));L.num_supported_uniforms>=d?(a.uniforms.u_bones=b,a.samplers[e.Renderer.BONES_TEXTURE_SLOT]=null,a.addShaderBlock(e.SkinDeformer.skinning_uniforms_block,{u_bones:b})):0<L.num_supported_textures?(f=this._bones_texture,f||(f=this._bones_texture=new GL.Texture(1,3*L.MAX_TEXTURE_BONES,{format:gl.RGBA,type:gl.FLOAT,filter:gl.NEAREST}),
f._data=new Float32Array(f.width*f.height*4)),f._data.set(b),f.uploadData(f._data,{no_flip:!0}),e.RM.textures[":bones_"+this.uid]=f,a.uniforms.u_bones=e.Renderer.BONES_TEXTURE_SLOT,a.samplers[e.Renderer.BONES_TEXTURE_SLOT]=f,a.addShaderBlock(e.SkinDeformer.skinning_texture_block,{u_bones:e.Renderer.BONES_TEXTURE_SLOT})):console.error("impossible to get here");a.addShaderBlock(e.SkinDeformer.skinning_block)}else{if(!this._skinned_mesh||this._skinned_mesh._reference!=b){this._skinned_mesh=new GL.Mesh;
this._skinned_mesh._reference=b;c=b.getBuffer("vertices");d=b.getBuffer("normals");for(f in b.vertexBuffers)this._skinned_mesh.vertexBuffers[f]=b.vertexBuffers[f];for(f in b.indexBuffers)this._skinned_mesh.indexBuffers[f]=b.indexBuffers[f];this._skinned_mesh.createVertexBuffer("vertices","a_vertex",3,new Float32Array(c.data),gl.STREAM_DRAW);d&&this._skinned_mesh.createVertexBuffer("normals","a_normal",3,new Float32Array(d.data),gl.STREAM_DRAW)}this.applySoftwareSkinning(b,this._skinned_mesh);a.setMesh(this._skinned_mesh,
this.primitive);a.samplers[e.Renderer.BONES_TEXTURE_SLOT]=null}this.ignore_transform?(mat4.identity(a.matrix),a.normal_matrix.set(a.matrix)):this._root.transform.getGlobalMatrix(a.matrix);mat4.multiplyVec3(a.center,a.matrix,e.ZEROS);a.use_bounding=!1}};L.prototype.disableSkinning=function(a){this._mesh=null;a.samplers.u_bones&&delete a.samplers.u_bones;a.removeShaderBlock(e.SkinDeformer.skinning_block);a.removeShaderBlock(e.SkinDeformer.skinning_uniforms_block);a.removeShaderBlock(e.SkinDeformer.skinning_texture_block)};
L.prototype.getMesh=function(){return this._mesh};L.prototype.applySoftwareSkinning=function(a,b){var c=a.getBuffer("vertices").data,d=null;a.getBuffer("normals")&&(d=a.getBuffer("normals").data);var f=a.getBuffer("weights").data,e=a.getBuffer("bone_indices").data,g=b.getBuffer("vertices"),k=g.data,m=null,l=null;L.zero_matrix||(L.zero_matrix=new Float32Array(16));var n=L.zero_matrix;d&&(m=b.getBuffer("normals"),l=m.data);var p=this.getBoneMatrices(a);if(0==p.length)return null;for(var q=vec3.create(),
r=vec3.create(),s=mat4.create(),t=0,K=k.length/3;t<K;++t){c.subarray(3*t,3*t+3);var G=e.subarray(4*t,4*t+4),O=f.subarray(4*t,4*t+4),C=k.subarray(3*t,3*t+3),G=[p[G[0]],p[G[1]],p[G[2]],p[G[3]]];s.set(n);mat4.scaleAndAdd(s,s,G[0],O[0]);0<O[1]&&mat4.scaleAndAdd(s,s,G[1],O[1]);0<O[2]&&mat4.scaleAndAdd(s,s,G[2],O[2]);0<O[3]&&mat4.scaleAndAdd(s,s,G[3],O[3]);mat4.multiplyVec3(C,s,c.subarray(3*t,3*t+3));if(l){var u=l.subarray(3*t,3*t+3);mat4.rotateVec3(u,s,d.subarray(3*t,3*t+3))}if(L.apply_to_normals_by_software)for(C[0]=
C[1]=C[2]=0,mat4.multiplyVec3(C,G[0],r),vec3.scale(C,C,O[0]),u=1;4>u;++u)0<O[u]&&(mat4.multiplyVec3(q,G[u],r),vec3.scaleAndAdd(C,C,q,O[u]))}g.upload(gl.STREAM_DRAW);m&&m.upload(gl.STREAM_DRAW)};L.prototype.extractSkeleton=function(){};L.prototype.applyBindPose=function(){var a=this._mesh;if(a&&a.bones){mat4.create();for(var a=this.getBones(),b=0;b<a.length;++b){var c=a[b];c._level=c.getHierarchyLevel()}}};L.prototype.getBones=function(){var a=this._mesh;if(!a&&!a.bones)return null;var b=[],c;for(c in a.bones){var d=
this.getBoneNode(a.bones[c][0]);d&&b.push(d)}return b};e.registerComponent(L);e.SkinDeformer=L;L.skinning_shader_code="\n\t//Skinning ******************* \n\t#ifndef MAX_BONES\n\t\t#define MAX_BONES 64\n\t#endif\n\t#ifdef USE_SKINNING_TEXTURE\n\t\tuniform sampler2D u_bones;\n\t#else\n\t\tuniform vec4 u_bones[ MAX_BONES * 3];\n\t#endif\n\tattribute vec4 a_weights;\n\tattribute vec4 a_bone_indices;\n\t\n\tvoid getMat(int id, inout mat4 m) {\n\t\n\t\t#ifdef USE_SKINNING_TEXTURE\n\t\t\tfloat i_max_texture_bones_offset = 1.0 / (128.0 * 3.0);\n\t\t\tm[0] = texture2D( u_bones, vec2( 0.0, (float(id*3)+0.5) * i_max_texture_bones_offset ) ); \n\t\t\tm[1] = texture2D( u_bones, vec2( 0.0, (float(id*3+1)+0.5) * i_max_texture_bones_offset ) );\n\t\t\tm[2] = texture2D( u_bones, vec2( 0.0, (float(id*3+2)+0.5) * i_max_texture_bones_offset ) );\n\t\t#else\n\t\t\tm[0] = u_bones[ id * 3];\n\t\t\tm[1] = u_bones[ id * 3 + 1];\n\t\t\tm[2] = u_bones[ id * 3 + 2];\n\t\t#endif\n\t}\n\t\n\tmat3 mat3_emu(mat4 m4) {\n\t  return mat3(\n\t\t  m4[0][0], m4[0][1], m4[0][2],\n\t\t  m4[1][0], m4[1][1], m4[1][2],\n\t\t  m4[2][0], m4[2][1], m4[2][2]);\n\t}\n\t\n\tvoid applySkinning(inout vec4 position, inout vec3 normal)\n\t{\n\t\t//toji version seems faster\n\t\tmat4 bone_matrix = mat4(0.0,0.0,0.0,0.0, 0.0,0.0,0.0,0.0, 0.0,0.0,0.0,0.0, 0.0,0.0,0.0,1.0);\n\t\t\n\t\tgetMat( int(a_bone_indices.x), bone_matrix );\n\t\tmat4 result = a_weights.x * bone_matrix;\n\t\tgetMat( int(a_bone_indices.y), bone_matrix);\n\t\tresult = result + a_weights.y * bone_matrix;\n\t\tgetMat( int(a_bone_indices.z), bone_matrix);\n\t\tresult = result + a_weights.z * bone_matrix;\n\t\tgetMat( int(a_bone_indices.w), bone_matrix);\n\t\tresult = result + a_weights.w * bone_matrix;\n\t\t\n\t\tposition.xyz = (position * result).xyz;\n\t\tnormal = normal * mat3_emu(result);\n\t}\n";
L.skinning_enabled_shader_code="\n#pragma shaderblock skinning_mode\n#define USING_SKINNING\n";L.skinning_disabled_shader_code="\nvoid applySkinning( inout vec4 position, inout vec3 normal) {}\n";var Ob=new e.ShaderBlock("skinning");Ob.addCode(GL.VERTEX_SHADER,L.skinning_enabled_shader_code,L.skinning_disabled_shader_code);Ob.register();L.skinning_block=Ob;var Bb=new e.ShaderBlock("skinning_uniforms");Bb.defineContextMacros({skinning_mode:"skinning_uniforms"});Bb.addCode(GL.VERTEX_SHADER,L.skinning_shader_code,
L.skinning_disabled_shader_code);Bb.register();L.skinning_uniforms_block=Bb;var Cb=new e.ShaderBlock("skinning_texture");Cb.defineContextMacros({skinning_mode:"skinning_texture"});Cb.addCode(GL.VERTEX_SHADER,"\n#define USE_SKINNING_TEXTURE\n"+L.skinning_shader_code,L.skinning_disabled_shader_code);Cb.register();L.skinning_texture_block=Cb;Ra.icon="mini-icon-teapot.png";Ra["@svg"]={type:"resource"};Ra.prototype.onAddedToScene=function(a){};Ra.prototype.onRemovedFromScene=function(a){};Ra.prototype.onAddedToNode=
function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this);this._RI.node=a};Ra.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};Ra.prototype.getMesh=function(){if(!this.svg)return null;var a=e.ResourcesManager.getResource(this.svg),b=null;this._svg_data===a&&(b=this._mesh);b||(b=this._mesh=GL.Mesh.cube());return b};Ra.prototype.onCollectInstances=function(a,b){if(this._enabled){var c=this.getMesh();if(!c)return null;
if(this._root){var d=this._RI;d.setMatrix(this._root.transform._global_matrix);mat4.multiplyVec3(d.center,d.matrix,e.ZEROS);var f=this._root.getMaterial();d.setMaterial(f);d.setMesh(c,GL.TRIANGLES);d.setRange(0,-1);d.collision_mesh=c;b.push(d)}}};Ra.prototype.configure=function(a){void 0!==a.enabled&&(this.enabled=a.enabled);this.svg=a.svg};Ra.prototype.serialize=function(){return{enabled:this.enabled,svg:this.svg}};Ra.prototype.getResources=function(a){"string"==typeof this.svg&&(a[this.svg]=e.Resource);
return a};Ra.prototype.onResourceRenamed=function(a,b,c){this.svg==a&&(this.svg=b)};xa.icon="mini-icon-dome.png";xa["@material"]={type:e.TYPES.MATERIAL};xa["@texture"]={type:e.TYPES.TEXTURE};xa.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};xa.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};xa.prototype.onAddedToScene=function(a){LEvent.bind(a,"start",this.onStart,this)};xa.prototype.onRemovedFromScene=
function(a){LEvent.unbind(a,"start",this.onStart,this)};Object.defineProperty(xa.prototype,"intensity",{set:function(a){this._intensity=a;this._material&&this._material._color.set([a,a,a,1])},get:function(){return this._intensity},enumerable:!0});Object.defineProperty(xa.prototype,"bake_to_cubemap",{set:function(a){(this._bake_to_cubemap=a)&&this.bakeToCubemap()},get:function(){return this._bake_to_cubemap},enumerable:!0});xa.prototype.getResources=function(a){this.texture&&this.texture.constructor===
String&&(a[this.texture]=GL.Texture);this.material&&this.material.constructor===String&&(a[this.material]=e.Material);return a};xa.prototype.onResourceRenamed=function(a,b,c){this.texture==a&&(this.texture=b)};xa.prototype.onCollectInstances=function(a,b){if(this._root&&this.enabled){var c=this._mesh;c||(c=this._mesh=GL.Mesh.cube({size:10}));var d=this._render_instance;d||(this._render_instance=d=new e.RenderInstance(this._root,this),d.priority=100,d.onPreRender=function(a){a=e.Renderer._current_camera.getEye();
mat4.identity(this.matrix);mat4.setTranslation(this.matrix,a);if(this.node.transform){var b=this.node.transform.getGlobalRotationMatrix();mat4.multiply(this.matrix,this.matrix,b)}vec3.copy(this.center,a)});var f=null;if(this.material)f=e.ResourcesManager.getResource(this.material);else{var h=null,h=this.use_environment&&e.Renderer._current_scene.info?e.Renderer._current_scene.info.textures.environment:this.texture;if(!h||!e.ResourcesManager.textures[h])return;(f=this._material)?f.color.set([this.intensity,
this.intensity,this.intensity]):(f=this._material=new e.ShaderMaterial({flags:{two_sided:!0,cast_shadows:!1,receive_shadows:!1,ignore_frustum:!0,ignore_lights:!0,depth_test:!1},use_scene_ambient:!1,color:[this.intensity,this.intensity,this.intensity]}),f.shader_code=new e.ShaderCode(xa.shader_code));f.setProperty("Texture",h)}d.setMesh(c);d.setMaterial(f);b.push(d);this.material&&f&&this._bake_to_cubemap&&(this._prev_mat!=f||this._mat_version!=f.version)&&(this._prev_mat=f,this._mat_version=f.version,
this.bakeToCubemap())}};xa.prototype.onStart=function(a){this._bake_to_cubemap&&this.bakeToCubemap()};xa.prototype.bakeToCubemap=function(a,b){var c=this;a=a||512;b=b||new e.RenderSettings;if(this.root&&this.root.scene){var d=this.root.scene;if(this._render_instance&&this._render_instance.material){var f=[];this.onCollectInstances(null,f);e.Renderer.processVisibleData(d,b,null,f,!0);b.render_helpers=!1;this._baked_texture=e.Renderer.renderToCubemap(vec3.create(),a,this._baked_texture,b,0.001,100,
vec4.create(),f);e.ResourcesManager.registerResource(":baked_skybox",this._baked_texture);this.root.scene.info&&(this.root.scene.info.textures.environment=":baked_skybox")}else setTimeout(function(){c.bakeToCubemap.bind(c)},500)}};xa.shader_code='\n\\js\n\tthis.createSampler("Texture","u_color_texture", { magFilter: GL.LINEAR, missing: "white"} );\n\tthis.queue = LS.RenderQueue.BACKGROUND;\n\tthis.render_state.cull_face = false;\n\tthis.render_state.front_face = GL.CW;\n\tthis.render_state.depth_test = false;\n\tthis.render_state.front_face = GL.CW;\n\tthis.flags.ignore_frustum = true;\n\tthis.flags.ignore_lights = true;\n\tthis.flags.cast_shadows = false;\n\tthis.flags.receive_shadows = false;\n\n\\color.vs\n\tprecision mediump float;\n\tattribute vec3 a_vertex;\n\tvarying vec3 v_world_position;\n\tuniform mat4 u_model;\n\tuniform mat4 u_viewprojection;\n\tvoid main() {\n\t\tvec4 vertex4 = u_model * vec4(a_vertex,1.0);\n\t\tv_world_position = vertex4.xyz;\n\t\tgl_Position = u_viewprojection * vertex4;\n\t}\n\\color.fs\n\tprecision mediump float;\n\tvarying vec3 v_world_position;\n\tuniform vec4 u_material_color;\n\tuniform vec3 u_camera_eye;\n\tuniform samplerCube u_color_texture;\n\tvec2 polarToCartesian(in vec3 V)\n\t{\n\t\treturn vec2( 0.5 - (atan(V.z, V.x) / -6.28318531), asin(V.y) / 1.57079633 * 0.5 + 0.5);\n\t}\n\tvoid main() {\n\t\tvec3 E = normalize( v_world_position - u_camera_eye);\n\t\tvec4 color = textureCube( u_color_texture, E );\n\t\tgl_FragColor = u_material_color * color;\n\t}\n\\picking.vs\n\tprecision mediump float;\n\tattribute vec3 a_vertex;\n\tuniform mat4 u_model;\n\tuniform mat4 u_viewprojection;\n\tvoid main() {\n\t\tvec4 vertex4 = vec4(a_vertex,1.0);\n\t\tgl_Position = (u_viewprojection * u_model) * vertex4;\n\t}\n\\picking.fs\n\tprecision mediump float;\n\tuniform vec4 u_material_color;\n\tvoid main() {\n\t\tgl_FragColor = u_material_color;\n\t}\n';
e.registerComponent(xa);e.Skybox=xa;Ua.icon="mini-icon-bg.png";Ua["@texture"]={type:"texture"};Ua["@material_name"]={type:"material"};Ua["@blend_mode"]={type:"enum",values:e.Blend};Ua["@opacity"]={type:"number",step:0.01};Ua.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};Ua.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};Ua.prototype.getResources=function(a){"string"==typeof this.texture&&
(a[this.texture]=GL.Texture);return a};Ua.prototype.onResourceRenamed=function(a,b,c){this.texture==a&&(this.texture=b)};Ua.prototype.onCollectInstances=function(a,b){if(this.enabled){var c=null;this.material_name&&(c=e.ResourcesManager.materials[this.material_name]);if(!c){var d=this.texture;if(!d)return;d.constructor===String&&(d=e.ResourcesManager.textures[d]);c=this._material?this._material:this._material=new e.StandardMaterial({shader:"lowglobal",queue:e.RenderQueue.BACKGROUND,flags:{cast_shadows:!1,
ignore_lights:!0,two_sided:!0,depth_test:!1,ignore_frustum:!0},use_scene_ambient:!1});c.setTexture("color",d);c.color.set(this.color);c.opacity=this.opacity;c.blend_mode=this.blend_mode}d=this._mesh;d||(d=this._mesh=GL.Mesh.plane({size:2}));var f=this._render_instance;f||(this._render_instance=f=new e.RenderInstance(this._root,this));f.setMesh(d);f.setMaterial(c);b.push(f)}};ya.icon="mini-icon-collider.png";ya.BOX=e.PhysicsInstance.BOX;ya.SPHERE=e.PhysicsInstance.SPHERE;ya.MESH=e.PhysicsInstance.MESH;
ya["@size"]={type:"vec3",step:0.01};ya["@center"]={type:"vec3",step:0.01};ya["@mesh"]={type:"mesh"};ya["@shape"]={type:"enum",values:{Box:ya.BOX,Sphere:ya.SPHERE,Mesh:ya.MESH}};ya.prototype.onAddedToScene=function(a){LEvent.bind(a,"collectPhysicInstances",this.onGetColliders,this)};ya.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"collectPhysicInstances",this.onGetColliders,this)};ya.prototype.getMesh=function(){return"string"===typeof this.mesh?e.ResourcesManager.meshes[this.mesh]:this.mesh};
ya.prototype.getResources=function(a){if(this.mesh)return"string"==typeof this.mesh&&(a[this.mesh]=Mesh),a};ya.prototype.onResourceRenamed=function(a,b,c){this.mesh==a&&(this.mesh=b)};ya.prototype.onGetColliders=function(a,b){if(this.enabled){var c=this._PI;c||(this._PI=c=new e.PhysicsInstance(this._root,this));this._root.transform&&c.matrix.set(this._root.transform._global_matrix);c.type=this.shape;c.layers=this._root.layers;var d=null;if(c.type===e.PhysicsInstance.MESH||this.use_mesh_bounding)d=
this.getMesh();c.type===e.PhysicsInstance.SPHERE?d?BBox.copy(c.oobb,d.bounding):BBox.setCenterHalfsize(c.oobb,this.center,[this.size[0],this.size[0],this.size[0]]):c.type===e.PhysicsInstance.BOX&&(d?BBox.copy(c.oobb,d.bounding):BBox.setCenterHalfsize(c.oobb,this.center,this.size));d?vec3.copy(c.center,BBox.getCenter(d.bounding)):vec3.copy(c.center,this.center);vec3.transformMat4(c.center,c.center,c.matrix);if(c.type===e.PhysicsInstance.MESH){if(!d)return;c.setMesh(d)}b.push(c)}};e.registerComponent(ya);
Object.defineProperty(La.prototype,"properties",{set:function(a){if(a&&a.constructor===Array){this._properties.length=a.length;this._properties_by_name={};for(var b=0;b<a.length;++b){var c=a[b];this._properties[b]=c;this._properties_by_name[c.name]=c}}},get:function(){return this._properties},enumerable:!0});La.icon="mini-icon-bg.png";La.prototype.onAddedToNode=function(a){a.custom||(a.custom=this)};La.prototype.onRemovedFromNode=function(a){a.custom==this&&delete a.custom};La.prototype.getResources=
function(a){return a};La.prototype.addProperty=function(a){this._properties.push(a);this._properties_by_name[a.name]&&console.warn("CustomData: there is a property with the same name");this._properties_by_name[a.name]=a};La.prototype.getProperty=function(a){return this._properties_by_name[a]};La.prototype.getPropertiesInfo=function(){return this._properties};La.prototype.updateProperty=function(a){this._properties_by_name[a.name]=a};La.prototype.getPropertyInfoFromPath=function(a){return(a=this._properties_by_name[a[0]])?
{node:this._root,target:a,name:"value",value:a.value,type:a.type}:null};La.prototype.setPropertyValueFromPath=function(a,b,c){if(a=this._properties_by_name[a[c||0]])a.value&&a.value.set?a.value.set(b):a.value=b};La.prototype.get=function(a){if(a=this._properties_by_name[a])return a.value};La.prototype.onResourceRenamed=function(a,b,c){};e.registerComponent(La);e.CustomData=La;var mb=vec3.create();Ia.icon="mini-icon-teapot.png";Ia["@texture"]={type:"texture"};Ia["@blend_mode"]={type:"enum",values:e.Blend};
Ia["@atlas"]={type:"component",filter:"SpriteAtlas"};Ia["@area"]={type:"vec4",step:0.001};Object.defineProperty(Ia.prototype,"size",{set:function(a){this._size.set(a)},get:function(){return this._size},enumerable:!0});Object.defineProperty(Ia.prototype,"area",{set:function(a){this._area.set(a)},get:function(){return this._area},enumerable:!0});Object.defineProperty(Ia.prototype,"atlas",{set:function(a){var b=null;a&&a.constructor===String?(this._atlas=a,(b=(this._root.scene||e.GlobalScene).findComponentByUId(a))&&
b.constructor!=e.Components.SpriteAtlas&&(console.warn("Atlas must be of type SpriteAtlas"),b=null)):(this._atlas=a?a.uid:null,b=a);this._atlas_component&&this._atlas_component!=b&&this._atlas_component.removeSprite(this);(this._atlas_component=b)&&this._atlas_component.addSprite(this)},get:function(){return this._atlas},enumerable:!0});Ia.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this);this._atlas_component&&this._atlas_component.addSprite(this)};
Ia.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this);this._atlas_component&&this._atlas_component.removeSprite(this)};Ia.prototype.onAddedToScene=function(a){this._atlas_component&&this._atlas_component.addSprite(this)};Ia.prototype.onRemovedFromScene=function(a){this._atlas_component&&this._atlas_component.removeSprite(this)};Ia.prototype.onCollectInstances=function(a,b){if(this.enabled&&!this._atlas&&this._root){var c=e.Components.Sprite._mesh;
c||(c=e.Components.Sprite._mesh=GL.Mesh.plane());var d=this._render_instance;d||(this._render_instance=d=new e.RenderInstance(this._root,this),d.setMesh(c,gl.TRIANGLES));this._material||(this._material=new e.StandardMaterial({shader_name:"lowglobal",flags:{two_sided:!0}}));this._material.setTexture("color",this.texture,{uvs:e.Material.COORDS_UV_TRANSFORMED,magFilter:this.filtering?gl.LINEAR:gl.NEAREST});this._material.blend_mode=this.blend_mode;d.setMaterial(this._material);this._root.transform&&
d.setMatrix(this._root.transform._global_matrix);mat4.getTranslation(d.center,this._root.transform._global_matrix);mb[0]=this._size[0]*(this.flip_x?-1:1);mb[1]=this._size[1];mb[2]=1;mat4.scale(d.matrix,d.matrix,mb);mat3.identity(this._material.uvs_matrix);mat3.translate(this._material.uvs_matrix,this._material.uvs_matrix,this._area.subarray(0,2));mat3.scale(this._material.uvs_matrix,this._material.uvs_matrix,this._area.subarray(2,4));b.push(d)}};Ia.prototype.getResources=function(a){"string"==typeof this.texture&&
(a[this.texture]=GL.Texture);return a};Ia.prototype.onResourceRenamed=function(a,b,c){this.texture==a&&(this.texture=b)};e.registerComponent(Ia);za.icon="mini-icon-teapot.png";za["@texture"]={type:"texture"};za["@areas"]={type:"texture_areas"};za.plane_vertices=[vec3.fromValues(-0.5,0.5,0),vec3.fromValues(0.5,-0.5,0),vec3.fromValues(0.5,0.5,0),vec3.fromValues(-0.5,-0.5,0)];za.plane_normal=vec3.fromValues(0,0,1);za.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,
this)};za.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};za.prototype.createMesh=function(){if(this._mesh_maxsprites!=this._max_sprites){for(var a=new Float32Array(12*this._max_sprites),b=new Float32Array(12*this._max_sprites),c=new Float32Array(8*this._max_sprites),d=new Float32Array(16*this._max_sprites),f=new Uint16Array(6*this._max_sprites),e=new Float32Array([0,0,1,1,1,0,0,1]),g=new Float32Array([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]),
k=0,m=this._max_sprites;k<m;++k)c.set(e,8*k),d.set(g,16*k),f[6*k]=4*k,f[6*k+1]=4*k+1,f[6*k+2]=4*k+2,f[6*k+3]=4*k,f[6*k+4]=4*k+3,f[6*k+5]=4*k+1;this._mesh=new GL.Mesh;this._mesh.addBuffers({vertices:a,normals:b,coords:c,colors:d},{triangles:f},gl.STREAM_DRAW);this._mesh_maxsprites=this._max_sprites}};za.prototype.updateMesh=function(){this._mesh||this.createMesh();for(var a=this._mesh,b=za.plane_vertices,c=za.plane_normal,d=a.getBuffer("vertices"),f=a.getBuffer("normals"),a=a.getBuffer("coords"),e=
d.data,g=f.data,k=a.data,m=0,l=0,n=Math.min(this._sprites.length,this._max_sprites);l<n;++l){var p=this._sprites[l];if(p.enabled){var q=null;if(p.matrix)q=p.matrix;else if(p._root&&p._root.transform)q=p._root.transform._global_matrix;else continue;mat4.rotateVec3(mb,q,c);for(var r=0;4>r;++r){var s=12*m+3*r,t=e.subarray(s,s+3);t.set(b[r]);t[0]*=p._size[0];t[1]*=p._size[1];vec3.transformMat4(t,t,q);g.set(mb,s)}s=p._area;p=s[0];q=s[1];r=s[2];s=s[3];k.set([p,q,p+r,q+s,p+r,q,p,q+s],8*m);m+=1}}m&&(d.upload(),
f.upload(),a.upload());this._last_index=6*m};za.prototype.onCollectInstances=function(a,b){if(this.enabled&&this._root&&this._sprites.length){this.updateMesh();var c=this._mesh;if(this._last_index){var d=this._render_instance;d||(this._render_instance=d=new e.RenderInstance(this._root,this),d.setMesh(c,gl.TRIANGLES));this._material||(this._material=new e.StandardMaterial({shader_name:"lowglobal",flags:{two_sided:!0}}));this._material.setTexture("COLOR",this.texture);d.setMaterial(this._material);
d.setRange(0,this._last_index);b.push(d)}}};za.prototype.addSprite=function(a){-1==this._sprites.indexOf(a)&&this._sprites.push(a)};za.prototype.removeSprite=function(a){a=this._sprites.indexOf(a);-1!=a&&this._sprites.splice(a,1)};za.prototype.getResources=function(a){"string"==typeof this.texture&&(a[this.texture]=GL.Texture);return a};za.prototype.onResourceRenamed=function(a,b,c){this.texture==a&&(this.texture=b)};e.registerComponent(za);za.Area=function(){this._start=vec2.create();this._size=
vec2.create()};B.max_recursive_level=32;B.recursive_level=0;B.propagable_events="finish beforeRenderMainPass beforeRenderInstances afterRenderInstances readyToRender renderGUI renderHelpers".split(" ");B.fx_propagable_events=["enableFrameContext","showFrameContext"];Object.defineProperty(B.prototype,"scene_path",{set:function(a){this._scene_path!=a&&(this._scene_path=a,this._root.scene&&this.reloadScene())},get:function(){return this._scene_path},enumerable:!0});Object.defineProperty(B.prototype,
"frame_fx",{set:function(a){this._frame_fx!=a&&(this._frame_fx=a,this.updateBindings())},get:function(){return this._frame_fx},enumerable:!0});B["@scene_path"]={type:e.TYPES.SCENE,widget:"resource"};B.icon="mini-icon-teapot.png";B.prototype.onAddedToScene=function(a){LEvent.bind(a,"collectData",this.onCollectData,this);LEvent.bind(a,"start",this.onStart,this);LEvent.bind(a,"update",this.onUpdate,this);for(var b in B.propagable_events)LEvent.bind(a,B.propagable_events[b],this.onEvent,this);this.updateBindings();
this._scene_path&&this.reloadScene()};B.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"collectData",this.onCollectData,this);LEvent.unbind(a,"start",this.onStart,this);LEvent.unbind(a,"update",this.onUpdate,this);var b=B.propagable_events.concat(B.fx_propagable_events),c;for(c in b)LEvent.unbind(a,b[c],this.onEvent,this)};B.prototype.onStart=function(){B.recursive_level+=1;this._scene_is_ready&&B.recursive_level<B.max_recursive_level&&this._scene.start();B.recursive_level-=1};B.prototype.onUpdate=
function(a,b){B.recursive_level+=1;this.send_events&&B.recursive_level<B.max_recursive_level&&this._scene.update(b);B.recursive_level-=1};B.prototype.onEvent=function(a,b){this.enabled&&this.send_events&&this._scene_path&&(B.recursive_level+=1,B.recursive_level<B.max_recursive_level&&LEvent.trigger(this._scene,a,b),B.recursive_level-=1)};B.prototype.updateBindings=function(){var a=this._root.scene;if(a){if(this._frame_fx&&!this._frame_fx_binded){for(var b in B.fx_propagable_events)LEvent.bind(a,B.fx_propagable_events[b],
this.onEvent,this);this._frame_fx_binded=!0}if(!this._frame_fx&&this._frame_fx_binded){for(b in B.fx_propagable_events)LEvent.unbind(a,B.fx_propagable_events[b],this.onEvent,this);this._frame_fx_binded=!1}}};B.prototype.onCollectData=function(){if(this.enabled&&this._scene_path&&this._scene_is_ready){var a=this._root.scene,b=this._scene;B.recursive_level+=1;B.recursive_level<B.max_recursive_level&&b.collectData();B.recursive_level-=1;var c=null;this._root.transform&&(c=this._root.transform.getGlobalMatrix());
if(this.include_instances&&(a._instances.push.apply(a._instances,b._instances),a._colliders.push.apply(a._colliders,b._colliders),c))for(var d=0;d<b._instances.length;++d)b._instances[d].applyTransform(c);this.include_lights&&a._lights.push.apply(a._lights,b._lights);this.include_cameras&&a._cameras.push.apply(a._cameras,b._cameras)}};B.prototype.load=function(){this.reloadScene()};B.prototype.unload=function(){this._scene_is_ready=!1;this._scene.clear()};B.prototype.reloadScene=function(){function a(){console.log("SceneInclude: scene loaded");
this._scene_is_ready=!0;this._root.scene._state==e.PLAYING&&this._scene.start()}this._scene_is_ready=!1;B.recursive_level+=1;B.recursive_level<B.max_recursive_level&&this._scene.loadFromResources(this._scene_path,a.bind(this));B.recursive_level-=1};B.prototype.getPropertyInfoFromPath=function(a){if(!a.length||"custom"!=a[0])return null;var b=this._scene.root.custom;return b?(a=b._properties_by_name[a[1]])?{node:this._root,target:a,name:"value",value:a.value,type:a.type}:null:null};B.prototype.setPropertyValueFromPath=
function(a,b,c){c=c||0;if(!a.length||"custom"!=a[c])return null;var d=this._scene.root.custom;if(!d)return null;d.setPropertyValueFromPath(a,b,c+1)};B.prototype.getEvents=function(){return{loaded:"event",unloaded:"event"}};B.prototype.getActions=function(){return{load:"function",unload:"function"}};B.prototype.getResources=function(a){this._scene_path&&(a[this._scene_path]=e.Scene);return a};B.prototype.onResourceRenamed=function(a,b,c){a==this._scene_path&&(this._scene_path=b)};e.registerComponent(B);
Fa.editor_color=[0.33,0.874,0.56,0.9];Fa.onShowMainAnnotation=function(a){"undefined"!=typeof AnnotationModule&&AnnotationModule.editAnnotation(a)};Fa.onShowPointAnnotation=function(a,b){function c(a){this.text=a}var d=a.getComponent(Fa);d&&"undefined"!=typeof AnnotationModule&&AnnotationModule.showDialog(b.text,{item:b,on_close:c.bind(b),on_delete:function(a){d.removeAnnotation(a.item);this._root.scene.requestFrame()},on_focus:function(a){AnnotationModule.focusInAnnotation(a.item);d._selected=a.item}})};
Fa.prototype.addAnnotation=function(a){this._selected=null;this.notes.push(a)};Fa.prototype.getAnnotation=function(a){return this.nodes[a]};Fa.prototype.removeAnnotation=function(a){this._selected=null;a=this.notes.indexOf(a);-1!=a&&this.notes.splice(a,1)};Fa.prototype.setStartTransform=function(){this.start_position=this.getObjectCenter()};Fa.prototype.getObjectCenter=function(){var a=vec3.create(),b=this._root.getMesh();b&&b.bounding&&vec3.copy(a,BBox.getCenter(b.bounding));return this._root.transform.localToGlobal(a)};
Fa.prototype.serialize=function(){for(var a={object_class:"AnnotationComponent",text:this.text,notes:[],start_position:this.start_position},b=0;b<this.notes.length;++b){var c=this.notes[b],d;for(d in c)c[d].constructor==Float32Array&&Array.prototype.slice.call(c[d]);a.notes.push(c)}return a};Fa.prototype.onAddedToScene=function(a){LEvent.bind(a,"mousedown",this.onMouse,this)};Fa.prototype.onRemovedFromScene=function(a){LEvent.bind(a,"mousedown",this.onMouse,this)};Fa.prototype.onMouse=function(a,
b){if("mousedown"==b.eventType){this._screen_pos[2]=0;var c=vec3.dist(this._screen_pos,[b.canvasx,gl.canvas.height-b.canvasy,0]);if(30>c)Fa.onShowMainAnnotation(this._root);for(var d=0;d<this.notes.length;++d){var f=this.notes[d],c=vec2.dist(f._end_screen,[b.mousex,gl.canvas.height-b.mousey]);if(30>c)return this._selected=f,Fa.onShowPointAnnotation(this._root,f),!0}}};Fa.prototype.renderEditor=function(a){if(this.text||this.notes.length){a=vec3.create();var b=this._root.getMesh();b&&vec3.copy(a,BBox.getCenter(b.bounding));
var c=e.Renderer._current_camera,d=this._root.transform.getGlobalPosition(),f=this.getObjectCenter(),h=c.getEye(),g=c.getLocalVector([1,0,0]);a=c.getLocalVector([0,1,0]);var b=c.getLocalVector([0,0,1]),h=Math.tan(c.fov*DEG2RAD)*vec3.dist(d,h),k=vec3.scale(vec3.create(),a,0.2*h),g=vec3.scale(vec3.create(),g,0.2*h),m=vec3.add(vec3.create(),d,k);vec3.add(m,g,m);c.project(m,null,this._screen_pos);gl.enable(gl.BLEND);gl.enable(gl.DEPTH_TEST);e.Draw.setColor([1,1,1,1]);var g=[],k=[],l=[],n=[];this.text&&
(g.push(d,m),k.push([1,1,1,0],[1,1,1,1]),window.EditorModule&&e.Draw.renderImage(m,EditorModule.icons_path+"/mini-icon-script.png",0.03*h));for(var p=this._root.transform.getGlobalMatrix(),d=0;d<this.notes.length;++d){var q=this.notes[d],m=mat4.multiplyVec3(vec3.create(),p,q.start),r=mat4.multiplyVec3(vec3.create(),p,q.end);q.end_world=r;l.push(r);g.push(m,r);this._selected==q?(n.push([1,1,1,1]),k.push([1,1,1,0.2],[1,1,0.8,1])):(n.push(e.Components.AnnotationComponent.editor_color),k.push([0,0,0,
0.2],e.Components.AnnotationComponent.editor_color));q._end_screen=c.project(r)}if((m=this.start_position)&&1<vec3.dist(m,f))for(c=vec3.dist(m,f)/20,f=vec3.subtract(vec3.create(),f,m),vec3.normalize(f,f),d=0;20>d;d+=2)p=vec3.scale(vec3.create(),f,d*c),vec3.add(p,p,m),g.push(p),p=vec3.scale(vec3.create(),f,(d+1)*c),vec3.add(p,p,m),g.push(p),k.push([0,1,0,0.2],[0,1,0,1]);e.Draw.setPointSize(12);e.Draw.renderPoints(l,n);e.Draw.setColor([0,0,0,0.5]);e.Draw.setPointSize(10);e.Draw.renderPoints(l,n);e.Draw.setColor([1,
1,1,1]);e.Draw.renderLines(g,k);gl.depthFunc(gl.GREATER);e.Draw.setAlpha(0.1);e.Draw.renderPoints(l,n);e.Draw.renderLines(g,k);gl.depthFunc(gl.LESS);gl.disable(gl.CULL_FACE);e.Draw.setColor(e.Components.AnnotationComponent.editor_color);for(d=0;d<this.notes.length;++d)q=this.notes[d],e.Draw.push(),e.Draw.fromTranslationFrontTop(q.end_world,b,a),e.Draw.translate([-1,-1,0]),e.Draw.scale([-4E-4*h,4E-4*h,4E-4*h]),f=q.text.split("\n")[0],e.Draw.renderText(f),e.Draw.pop();gl.disable(gl.BLEND)}};e.registerComponent(Fa);
ob.icon="mini-icon-rotator.png";ob.prototype.onAddedToScene=function(a){LEvent.bind(a,"update",this.onUpdate,this)};ob.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"update",this.onUpdate,this)};ob.prototype.onUpdate=function(a,b){if(this._root&&this.enabled){var c=this._root.scene;this._default||(this._default=this._root.transform.getRotation());vec3.normalize(this.axis,this.axis);if(this.swing){var d=quat.setAxisAngle(quat.create(),this.axis,Math.sin(this.speed*c._global_time*2*Math.PI)*
this.swing_amplitude*DEG2RAD);quat.multiply(this._root.transform._rotation,d,this._default);this._root.transform._must_update=!0}else this.local_space?this._root.transform.rotate(this.speed*b,this.axis):this._root.transform.rotateGlobal(this.speed*b,this.axis);c&&c.requestFrame()}};e.registerComponent(ob);A.NONE=0;A.ORBIT=1;A.ORBIT_HORIZONTAL=2;A.ROTATE=5;A.ROTATE_HORIZONTAL=6;A.PAN=10;A.PAN_XZ=11;A.CHANGE_DISTANCE=15;A.WALK=16;A.ELEVATE=17;A.FOV=18;A.icon="mini-icon-cameracontroller.png";A.mode_values=
{None:A.NONE,Orbit:A.ORBIT,"Orbit Horizontal":A.ORBIT_HORIZONTAL,Rotate:A.ROTATE,"Rotate Horizontal":A.ROTATE_HORIZONTAL,Pan:A.PAN,"Pan XZ":A.PAN_XZ,"Change Distance":A.CHANGE_DISTANCE,Walk:A.WALK,Elevate:A.ELEVATE};A.wheel_values={None:A.NONE,"Change Distance":A.CHANGE_DISTANCE,FOV:A.FOV,Walk:A.WALK,Elevate:A.ELEVATE};A["@no_button_action"]={type:"enum",values:A.mode_values};A["@left_button_action"]={type:"enum",values:A.mode_values};A["@middle_button_action"]={type:"enum",values:A.mode_values};
A["@right_button_action"]={type:"enum",values:A.mode_values};A["@mouse_wheel_action"]={type:"enum",values:A.wheel_values};A.prototype.onAddedToScene=function(a){LEvent.bind(a,"start",this.onStart,this);LEvent.bind(a,"finish",this.onFinish,this);LEvent.bind(a,"mousedown",this.onMouse,this);LEvent.bind(a,"mousemove",this.onMouse,this);LEvent.bind(a,"mousewheel",this.onMouse,this);LEvent.bind(a,"touchstart",this.onTouch,this);LEvent.bind(a,"touchmove",this.onTouch,this);LEvent.bind(a,"touchend",this.onTouch,
this);LEvent.bind(a,"keydown",this.onKey,this);LEvent.bind(a,"keyup",this.onKey,this);LEvent.bind(a,"update",this.onUpdate,this)};A.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,this)};A.prototype.onStart=function(a){this.lock_mouse&&e.Input.lockMouse(!0)};A.prototype.onFinish=function(a){this.lock_mouse&&e.Input.lockMouse(!1)};A.prototype.onUpdate=function(a){if(this._root&&this.enabled&&(a=this._root.camera)&&a.enabled){if(!this._root.transform&&this.keyboard_walk&&(0!=this._moving[0]||
0!=this._moving[1]||0!=this._moving[2])){var b=a.getLocalVector(this._moving);vec3.scale(b,b,this.walk_speed);a.move(b);a.updateMatrices()}this.smooth&&this._root.scene.requestFrame()}};A.prototype.processMouseButtonDownEvent=function(a,b,c){var d=this._camera=this._root.camera;if(d&&d.enabled)return a==A.PAN?this.testPerpendicularPlane(b.canvasx,gl.canvas.height-b.canvasy,d.getCenter(),c):a==A.PAN_XZ&&this.testOriginPlane(b.canvasx,gl.canvas.height-b.canvasy,c),!1};A.prototype.processMouseButtonMoveEvent=
function(a,b,c){var d=this._root,f=this._camera=d.camera;if(f&&f.enabled){var h=d._is_root,g=!1;if(a==A.NONE)return!1;if(a==A.ORBIT){c=b.deltax*this.rot_speed;b=-b.deltay*this.rot_speed;1E-4<Math.abs(c)&&(h?f.orbit(-c,[0,1,0]):(g=f.getEye(),d.transform.globalToLocal(g,g),d.transform.orbit(-c,[0,1,0],g)),f.updateMatrices(),g=!0);c=f.getRight();a=f.getFront();var k=f.getUp();a=vec3.dot(k,a);0.99<a&&0<b||-0.99>a&&0>b||(h?f.orbit(-b,c,this.orbit_center):(g=f.getEye(),d.transform.globalToLocal(g,g),d.transform.orbit(-b,
c,g)),g=!0)}else a==A.ORBIT_HORIZONTAL?(c=b.deltax*this.rot_speed,1E-4<Math.abs(c)&&(h?f.orbit(-c,[0,1,0]):(g=f.getEye(),d.transform.globalToLocal(g,g),d.transform.orbit(-c,[0,1,0],g)),f.updateMatrices(),g=!0)):a==A.ROTATE||a==A.ROTATE_HORIZONTAL?(f.rotate(-b.deltax*this.rot_speed*0.2,e.TOP),f.updateMatrices(),a==A.ROTATE&&(c=f.getLocalVector(e.RIGHT),h?f.rotate(-b.deltay*this.rot_speed*0.2,c):d.transform.rotate(-b.deltay*this.rot_speed*0.2,e.RIGHT),f.updateMatrices()),g=!0):a==A.PAN?(g=vec3.create(),
a=vec3.create(),k=vec3.create(),f.getCenter(a),this.testPerpendicularPlane(b.canvasx,gl.canvas.height-b.canvasy,a,g),vec3.sub(k,c,g),h?f.move(k):d.transform.translateGlobal(k),f.updateMatrices(),g=!0):a==A.PAN_XZ?(g=vec3.create(),k=vec3.create(),this.testOriginPlane(b.canvasx,gl.canvas.height-b.canvasy,g),vec3.sub(k,c,g),h?f.move(k):d.transform.translateGlobal(k),f.updateMatrices(),g=!0):a==A.CHANGE_DISTANCE?(f.orbitDistanceFactor(1+b.deltay*this.wheel_speed*-0.05),f.updateMatrices(),g=!0):a==A.WALK?
(k=f.getLocalVector([0,0,b.deltay*this.walk_speed]),f.move(k),f.updateMatrices(),g=!0):a==A.ELEVATE&&(f.move([0,b.deltay*this.walk_speed,0]),f.updateMatrices(),g=!0);return g}};A.prototype.onMouse=function(a,b){if(this._root&&this.enabled){var c=this._root,d=c.camera;if(d&&d.enabled)if(b||(b=a),"mousewheel"==b.eventType){var f=0<b.wheel?1:-1;switch(this.mouse_wheel_action){case A.CHANGE_DISTANCE:d.orbitDistanceFactor(1+-0.05*f*this.wheel_speed);d.updateMatrices();break;case A.FOV:d.fov-=f,d.updateMatrices()}c.scene.requestFrame()}else c=
!1,"mousedown"==b.eventType&&(e.Input.Mouse.isButtonPressed(GL.LEFT_MOUSE_BUTTON)&&(c|=this.processMouseButtonDownEvent(this.left_button_action,b,this._collision_left)),e.Input.Mouse.isButtonPressed(GL.MIDDLE_MOUSE_BUTTON)&&(c|=this.processMouseButtonDownEvent(this.middle_button_action,b,this._collision_middle)),e.Input.Mouse.isButtonPressed(GL.RIGHT_MOUSE_BUTTON)&&(c|=this.processMouseButtonDownEvent(this.right_button_action,b,this._collision_right)),this._dragging=!0),b.dragging||(this._dragging=
!1),"mousemove"==b.eventType&&this.lock_mouse&&document.pointerLockElement&&(c|=this.processMouseButtonMoveEvent(this.no_button_action,b,this._collision_none)),"mousemove"==b.eventType&&b.dragging&&this._dragging&&(e.Input.Mouse.isButtonPressed(GL.LEFT_MOUSE_BUTTON)&&(c|=this.processMouseButtonMoveEvent(this.left_button_action,b,this._collision_left)),e.Input.Mouse.isButtonPressed(GL.MIDDLE_MOUSE_BUTTON)&&(c|=this.processMouseButtonMoveEvent(this.middle_button_action,b,this._collision_middle)),e.Input.Mouse.isButtonPressed(GL.RIGHT_MOUSE_BUTTON)&&
(c|=this.processMouseButtonMoveEvent(this.right_button_action,b,this._collision_right))),c&&this._root.scene.requestFrame()}};A.prototype.onTouch=function(a,b){if(this._root&&this.enabled){var c=this._root.camera;if(c&&c.enabled){b||(b=a);if("touchstart"==b.type&&2==b.touches.length){var d=b.touches[0].clientX-b.touches[1].clientX,f=b.touches[0].clientY-b.touches[1].clientY;this._touch_distance=Math.sqrt(d*d+f*f);this._touch_center=[0.5*(b.touches[0].clientX+b.touches[1].clientX),0.5*(b.touches[0].clientY+
b.touches[1].clientY)];b.preventDefault();return!1}if("touchmove"==b.type&&2==b.touches.length)return d=b.touches[0].clientX-b.touches[1].clientX,f=b.touches[0].clientY-b.touches[1].clientY,d=Math.sqrt(d*d+f*f),0.1>d&&(d=0.1),f=this._touch_distance/d,this._touch_distance=d,c.orbitDistanceFactor(f),c.updateMatrices(),c.panning(-(0.5*(b.touches[0].clientX+b.touches[1].clientX)-this._touch_center[0]),0.5*(b.touches[0].clientY+b.touches[1].clientY)-this._touch_center[1],c.focalLength/gl.canvas.width),
this._touch_center[0]=0.5*(b.touches[0].clientX+b.touches[1].clientX),this._touch_center[1]=0.5*(b.touches[0].clientY+b.touches[1].clientY),c.updateMatrices(),this._root.scene.requestFrame(),b.preventDefault(),!1}}};A.prototype.testOriginPlane=function(a,b,c){a=this._root.camera.getRayInPixel(a,gl.canvas.height-b);c=c||vec3.create();return geo.testRayPlane(a.origin,a.direction,e.ZEROS,e.TOP,c)?!0:!1};A.prototype.testPerpendicularPlane=function(a,b,c,d){var f=this._root.camera;a=f.getRayInPixel(a,
gl.canvas.height-b);b=f.getFront();c=c||f.getCenter();d=d||vec3.create();return geo.testRayPlane(a.origin,a.direction,c,b,d)?!0:!1};A.prototype.onKey=function(a,b){this._root&&this.enabled&&(87==b.keyCode?this._moving[2]="keydown"==b.type?-1:0:83==b.keyCode?this._moving[2]="keydown"==b.type?1:0:65==b.keyCode?this._moving[0]="keydown"==b.type?-1:0:68==b.keyCode&&(this._moving[0]="keydown"==b.type?1:0),16==b.keyCode&&"keydown"==b.type&&vec3.scale(this._moving,this._moving,10))};e.registerComponent(A);
jb.icon="mini-icon-rotator.png";jb.prototype.onAddedToNode=function(a){LEvent.bind(a,"mousemove",this.onMouse,this);LEvent.bind(a,"update",this.onUpdate,this)};jb.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"mousemove",this.onMouse,this);LEvent.unbind(a,"update",this.onUpdate,this)};jb.prototype.onUpdate=function(a){};jb.prototype.onMouse=function(a,b){if(this._root&&this._root.transform&&b.dragging){var c=this._root.scene,d=c.getCamera().getLocalVector(e.Components.Transform.RIGHT);this._root.transform.rotateGlobal(b.deltax*
this.rot_speed[0],e.Components.Transform.UP);this._root.transform.rotateGlobal(b.deltay*this.rot_speed[1],d);c.requestFrame()}};e.registerComponent(jb);J.icon="mini-icon-billboard.png";J.POSX=1;J.NEGX=2;J.POSY=3;J.NEGY=4;J.POSZ=5;J.NEGZ=6;J["@node_id"]={type:"node"};J["@front"]={type:"enum",values:{"-Z":J.NEGZ,"+Z":J.POSZ,"-Y":J.NEGY,"+Y":J.POSY,"-X":J.NEGX,"+X":J.POSX}};J["@up"]={type:"enum",values:{"-Z":J.NEGZ,"+Z":J.POSZ,"-Y":J.NEGY,"+Y":J.POSY,"-X":J.NEGX,"+X":J.POSX}};J.prototype.onAddedToScene=
function(a){LEvent.bind(a,"beforeRender",this.onBeforeRender,this);LEvent.bind(a,"beforeRenderInstances",this.onBeforeRender,this)};J.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"beforeRender",this.onBeforeRender,this);LEvent.unbind(a,"beforeRenderInstances",this.onBeforeRender,this)};J.prototype.onBeforeRender=function(a){this.enabled&&(this.face_camera&&"beforeRenderInstances"==a||!this.face_camera&&"beforeRender"==a)&&this.updateOrientation()};J.prototype.updateOrientation=function(){if(this._root&&
this._root.transform){var a=this._root.scene,b=this._root.transform,c=null,d=null,f=b.getGlobalPosition(this._global_position);switch(this.up){case J.NEGX:d=vec3.fromValues(-1,0,0);break;case J.POSX:d=vec3.fromValues(1,0,0);break;case J.NEGZ:d=vec3.fromValues(0,0,-1);break;case J.POSZ:d=vec3.fromValues(0,0,1);break;case J.NEGY:d=vec3.fromValues(0,-1,0);break;default:d=vec3.fromValues(0,1,0)}if(this.node_id){a=a.getNode(this.node_id);if(!a||a==this._root)return;c=a.transform.getGlobalPosition(this._target_position)}else if(this.face_camera){a=
e.Renderer._main_camera||e.Renderer._current_camera;if(!a)return;c=a.getEye()}else return;this.cylindrical&&(c[1]=f[1]);b.lookAt(f,c,d,!0);switch(this.front){case J.POSY:quat.rotateX(b._rotation,b._rotation,-0.5*Math.PI);break;case J.NEGY:quat.rotateX(b._rotation,b._rotation,0.5*Math.PI);break;case J.POSX:quat.rotateY(b._rotation,b._rotation,0.5*Math.PI);break;case J.NEGX:quat.rotateY(b._rotation,b._rotation,-0.5*Math.PI);break;case J.POSZ:quat.rotateY(b._rotation,b._rotation,Math.PI)}b._on_change()}};
e.registerComponent(J);Ja.icon="mini-icon-fog.png";Ja.LINEAR=1;Ja.EXP=2;Ja.EXP2=3;Ja["@color"]={type:"color"};Ja["@density"]={type:"number",min:0,max:1,step:1E-4,precision:4};Ja["@type"]={type:"enum",values:{linear:Ja.LINEAR,exponential:Ja.EXP,"exponential 2":Ja.EXP2}};Ja.prototype.onAddedToScene=function(a){LEvent.bind(a,"fillSceneUniforms",this.fillSceneUniforms,this)};Ja.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"fillSceneUniforms",this.fillSceneUniforms,this)};Ja.prototype.fillSceneUniforms=
function(a,b){this.enabled&&(this._uniforms.u_fog_info[0]=this.start,this._uniforms.u_fog_info[1]=this.end,this._uniforms.u_fog_info[2]=this.density,this._uniforms.u_fog_color=this.color,e.Renderer.enableFrameShaderBlock("fog",this._uniforms))};e.registerComponent(Ja);var Db=new e.ShaderBlock("fog");Db.bindEvent("fs_functions","\tuniform vec3 u_fog_info;\n\tuniform vec3 u_fog_color;\n");Db.bindEvent("fs_final_pass","\tfloat cam_dist = length(u_camera_eye - v_pos);\n\tfloat fog = 1. - 1.0 / exp(max(0.0,cam_dist - u_fog_info.x) * u_fog_info.z);\n\tfinal_color.xyz = mix(final_color.xyz, u_fog_color, fog);\n");
Db.register();Ja.block=Db;pb.icon="mini-icon-follow.png";pb.prototype.onAddedToScene=function(a){LEvent.bind(a,"beforeRender",this.updatePosition,this)};pb.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"beforeRender",this.updatePosition,this)};pb.prototype.updatePosition=function(a,b){if(this._root){var c=null,c=this._root.scene;if(this.follow_camera){c=e.Renderer._main_camera;if(!c)return;c=c.getEye()}else{c=c.getNode(this.node_uid);if(!c||!c.transform)return;c=c.transform.getGlobalPosition()}this.fixed_y&&
(c[1]=this._root.transform._position[1]);this._root.transform&&(this._root.transform.position=c)}};e.registerComponent(pb);Object.defineProperty(F.prototype,"geometry",{get:function(){return this._geometry},set:function(a){this._geometry!=a&&(a=void 0===a||null===a?-1:a|0,F.VALID[a]&&(this._geometry=a,this._version++))},enumerable:!0});Object.defineProperty(F.prototype,"size",{get:function(){return this._size},set:function(a){this._size!=a&&(this._size=a,this._version++)},enumerable:!0});Object.defineProperty(F.prototype,
"subdivisions",{get:function(){return this._subdivisions},set:function(a){this._subdivisions!=a&&(this._subdivisions=a,this._version++)},enumerable:!0});Object.defineProperty(F.prototype,"primitive",{get:function(){return this._primitive},set:function(a){a=void 0===a||null===a?-1:a|0;if(-1==a||0==a||1==a||4==a||10==a)this._primitive=a},enumerable:!0});Object.defineProperty(F.prototype,"point_size",{get:function(){return this._point_size},set:function(a){this._point_size!=a&&(this._point_size=a)},
enumerable:!0});Object.defineProperty(F.prototype,"mesh",{get:function(){return this._custom_mesh||this._mesh},set:function(a){if(a&&a.constructor!==GL.Mesh)throw"mesh must be a GL.Mesh";if(this._custom_mesh=a)this._geometry=F.CUSTOM},enumerable:!1});F.CUBE=1;F.PLANE=2;F.CYLINDER=3;F.SPHERE=4;F.CIRCLE=5;F.HEMISPHERE=6;F.ICOSAHEDRON=7;F.CONE=8;F.QUAD=9;F.CUSTOM=100;F.VALID={1:"CUBE",2:"PLANE",3:"CYLINDER",4:"SPHERE",5:"CIRCLE",6:"HEMISPHERE",7:"ICOSAHEDRON",8:"CONE",9:"QUAD",100:"CUSTOM"};F.icon="mini-icon-cube.png";
F["@geometry"]={type:"enum",values:{Cube:F.CUBE,Plane:F.PLANE,Cylinder:F.CYLINDER,Sphere:F.SPHERE,Cone:F.CONE,Icosahedron:F.ICOSAHEDRON,Circle:F.CIRCLE,Hemisphere:F.HEMISPHERE,Quad:F.QUAD,Custom:F.CUSTOM}};F["@primitive"]={widget:"enum",values:{Default:-1,Points:0,Lines:1,Triangles:4,Wireframe:10}};F["@subdivisions"]={type:"number",step:1,min:1,precision:0};F["@point_size"]={type:"number",step:0.001};F.prototype.onAddedToNode=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,
this)};F.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};F.prototype.serialize=function(){var a=e.BaseComponent.prototype.serialize.call(this);this._geometry==F.CUSTOM&&this._custom_mesh&&(a.custom_mesh=this._custom_mesh.toJSON());return a};F.prototype.configure=function(a){e.BaseComponent.prototype.configure.call(this,a);this._geometry==F.PLANE&&!1===a.align_z&&(this._geometry=F.QUAD);a.geometry==F.CUSTOM&&a.custom_mesh&&(this._custom_mesh||
(this._custom_mesh=new GL.Mesh),this._custom_mesh.fromJSON(a.custom_mesh));this._version++};F.prototype.updateMesh=function(){var a=Math.max(0,this.subdivisions|0);switch(this._geometry){case F.CUBE:this._mesh=GL.Mesh.cube({size:this.size,normals:!0,coords:!0});break;case F.PLANE:this._mesh=GL.Mesh.plane({size:this.size,xz:!0,detail:a,normals:!0,coords:!0});break;case F.CYLINDER:this._mesh=GL.Mesh.cylinder({size:this.size,subdivisions:a,normals:!0,coords:!0});break;case F.SPHERE:this._mesh=GL.Mesh.sphere({size:this.size,
"long":a,lat:a,normals:!0,coords:!0});break;case F.CIRCLE:this._mesh=GL.Mesh.circle({size:this.size,slices:a,normals:!0,coords:!0});break;case F.HEMISPHERE:this._mesh=GL.Mesh.sphere({size:this.size,"long":a,lat:a,normals:!0,coords:!0,hemi:!0});break;case F.ICOSAHEDRON:this._mesh=GL.Mesh.icosahedron({size:this.size,subdivisions:a});break;case F.CONE:this._mesh=GL.Mesh.cone({radius:this.size,height:this.size,subdivisions:a});break;case F.QUAD:this._mesh=GL.Mesh.plane({size:this.size,xz:!1,detail:a,
normals:!0,coords:!0});break;case F.CUSTOM:this._mesh=this._custom_mesh}this._mesh_version=this._version};F.prototype.setCustomMesh=function(a){this._geometry=F.CUSTOM;this._mesh=this._custom_mesh=a};F.prototype.onCollectInstances=function(a,b){if(this.enabled&&this._root){var c=this._render_instance;c||(this._render_instance=c=new e.RenderInstance(this._root,this));this._mesh&&this._version==this._mesh_version||this.updateMesh();this._mesh&&(c.fromNode(this._root),c.setMesh(this._mesh,this._primitive),
this._root.mesh=this._mesh,c.setMaterial(this.material||this._root.getMaterial()),this.primitive==gl.POINTS&&(c.uniforms.u_point_size=this.point_size),b.push(c))}};e.registerComponent(F);Object.defineProperty(Ma.prototype,"textures",{set:function(a){if("object"==typeof a)for(var b in a)if(null===a[b]||a[b].constructor===String||a[b]===GL.Texture)this._textures[b]=a[b]},get:function(){return this._textures},enumerable:!0});Object.defineProperty(Ma.prototype,"render_settings",{set:function(a){a?"object"==
typeof a&&(this._render_settings||(this._render_settings=new e.RenderSettings),a.constructor===Array&&"RenderSettings"==a[3]?this._render_settings.configure(a[2]):this._render_settings.configure(a)):this._render_settings=null},get:function(){return this._render_settings},enumerable:!0});Ma.icon="mini-icon-bg.png";Ma.DEFAULT_AMBIENT_COLOR=vec3.fromValues(0.2,0.2,0.2);Ma.prototype.onAddedToScene=function(a){a.info=this};Ma.prototype.onRemovedFromScene=function(a){};Ma.prototype.getResources=function(a){for(var b in this._textures)"string"==
typeof this._textures[b]&&(a[this._textures[b]]=GL.Texture);return a};Ma.prototype.getPropertiesInfo=function(){return{ambient_color:"color","textures/environment":"texture","textures/irradiance":"texture",render_settings:"RenderSettings"}};Ma.prototype.setProperty=function(a,b){if("textures/"==a.substr(0,9)&&(!b||b.constructor===String||b.constructor===GL.Texture))return this._textures[a.substr(9)]=b,!0};Ma.prototype.getPropertyInfoFromPath=function(a){if("textures"==a[0]){if(1==a.length)return{node:this._root,
target:this._textures,type:"object"};a=a[1];return{node:this._root,target:this._textures,name:a,value:this._textures[a]||null,type:"texture"}}};Ma.prototype.setPropertyValueFromPath=function(a,b,c){c=c||0;a.length<c+1||"textures"==a[c]&&(this._textures[a[c+1]]=b)};Ma.prototype.onResourceRenamed=function(a,b,c){for(var d in this._textures)this._textures[d]==a&&(this._textures[d]=b)};e.registerComponent(Ma);e.GlobalInfo=Ma;"undefined"!=typeof LGraphTexture&&(LGraphTexture.getTexturesContainer=function(){return e.ResourcesManager.textures},
LGraphTexture.storeTexture=function(a,b){return e.ResourcesManager.registerResource(a,b)},LGraphTexture.loadTexture=e.ResourcesManager.load.bind(e.ResourcesManager));"undefined"!=typeof LGAudio&&(LGAudio.onProcessAudioURL=function(a){return e.RM.getFullURL(a)});la["@on_event"]={type:"enum",values:["start","render","beforeRenderScene","update","trigger"]};la["@filename"]={type:"resource",data_type:"graph"};Object.defineProperty(la.prototype,"graph",{enumerable:!1,get:function(){return this._graph},
set:function(a){console.error("graph cannot be set manually")}});Object.defineProperty(la.prototype,"filename",{enumerable:!1,get:function(){return this._filename},set:function(a){this._filename!=a&&(a&&(a=e.ResourcesManager.cleanFullpath(a)),this.from_file=!0,this._filename=a,this._loading=!1,this._graphcode=null,this.processGraph())}});Object.defineProperty(la.prototype,"graphcode",{enumerable:!1,get:function(){return this._graphcode},set:function(a){this._loading=!1;this._graphcode=a;this.from_file=
!0;this._filename=this._graphcode?this._graphcode.fullpath||this._graphcode.filename:null;this._graph_properties=this.serializeProperties();this.processGraph()}});la.icon="mini-icon-graph.png";la.prototype.configure=function(a){this._graph_version=-1;a.uid&&(this.uid=a.uid);null!=a.enabled&&(this.enabled=!!a.enabled);if(a.from_file)this.from_file=!0,this.filename=a.filename,a.graph_properties&&(this._loading?this._graph_properties=a.graph_properties:this.configureProperties(a.graph_properties));else if(a.graph_data)if(this.from_file=
!1,e.catch_exceptions)try{var b=JSON.parse(a.graph_data);this._graph.configure(b)}catch(c){console.error("Error configuring Graph data: "+c)}else b=JSON.parse(a.graph_data),this._graph.configure(b);a.on_event&&(this.on_event=a.on_event);null!=a.force_redraw&&(this.force_redraw=a.force_redraw)};la.prototype.serialize=function(){return{object_class:"GraphComponent",uid:this.uid,enabled:this.enabled,from_file:this.from_file,force_redraw:this.force_redraw,filename:this._filename,graph_properties:this.from_file?
this.serializeProperties():null,graph_data:this.from_file?null:JSON.stringify(this._graph.serialize()),on_event:this.on_event}};la.prototype.getResources=function(a){this._filename&&(a[this._filename]=!0);this._graph.sendEventToAllNodes("getResources",a);return a};la.prototype.onAddedToNode=function(a){this._graph._scenenode=a;this._default_node&&(this._default_node.properties.node_id=a.uid)};la.prototype.onRemovedFromNode=function(a){this._graph._scenenode=null};la.prototype.onAddedToScene=function(a){this._graph._scene=
a;LEvent.bind(a,"init",this.onSceneEvent,this);LEvent.bind(a,"start",this.onSceneEvent,this);LEvent.bind(a,"pause",this.onSceneEvent,this);LEvent.bind(a,"unpause",this.onSceneEvent,this);LEvent.bind(a,"finish",this.onSceneEvent,this);LEvent.bind(a,"beforeRenderMainPass",this.onSceneEvent,this);LEvent.bind(a,"beforeRenderScene",this.onSceneEvent,this);LEvent.bind(a,"update",this.onSceneEvent,this)};la.prototype.onRemovedFromScene=function(a){this._graph._scene=null;LEvent.unbind(a,"init",this.onSceneEvent,
this);LEvent.unbind(a,"start",this.onSceneEvent,this);LEvent.unbind(a,"pause",this.onSceneEvent,this);LEvent.unbind(a,"unpause",this.onSceneEvent,this);LEvent.unbind(a,"finish",this.onSceneEvent,this);LEvent.unbind(a,"beforeRenderMainPass",this.onSceneEvent,this);LEvent.unbind(a,"beforeRenderScene",this.onSceneEvent,this);LEvent.unbind(a,"update",this.onSceneEvent,this)};la.prototype.onResourceRenamed=function(a,b,c){a==this._filename&&(this._filename=b);this._graph.sendEventToAllNodes("onResourceRenamed",
[a,b,c])};la.prototype.onSceneEvent=function(a,b){"beforeRenderMainPass"==a&&(a="render");"init"==a?this._graph.sendEventToAllNodes("onInit"):"start"==a?(this._graph.sendEventToAllNodes("onStart"),this._graph.status=LGraph.STATUS_RUNNING):"pause"==a?(this._graph.sendEventToAllNodes("onPause"),this._graph.status=LGraph.STATUS_RUNNING):"unpause"==a?(this._graph.sendEventToAllNodes("onUnpause"),this._graph.status=LGraph.STATUS_RUNNING):"finish"==a&&(this._graph.sendEventToAllNodes("onStop"),this._graph.status=
LGraph.STATUS_STOPPED);this.on_event==a&&this.runGraph()};la.prototype.trigger=function(a){"trigger"==this.on_event&&this.runGraph()};la.prototype.runGraph=function(){this._root._in_tree&&this.enabled&&(!this.from_file||this._graphcode)&&(this._graph.runStep(1,e.catch_exceptions),this.force_redraw&&this._root.scene.requestFrame())};la.prototype.processGraph=function(a,b){if(this.from_file){var c=this;(this._graphcode=e.ResourcesManager.getResource(this._filename))||this._loading?(this._graph.configure(this._graphcode.data),
this._graph_properties&&(this.configureProperties(this._graph_properties),this._graph_properties=null),this._graph_version=this._graphcode._version):(this._loading=!0,e.ResourcesManager.load(this._filename,null,function(d,f){this._loading=!1;f==c.filename&&(c.processGraph(a),b&&b(c))}))}};la.prototype.getResources=function(a){a[this._filename]=!0;this._graph.sendEventToAllNodes("getResources",a);return a};la.prototype.serializeProperties=function(){var a={},b=this._graph.findNodesByType("scene/global");
if(!b.length)return a;for(var c=0;c<b.length;++c){var d=b[c];a[d.id]=d.properties.value}return a};la.prototype.configureProperties=function(a){var b=this._graph.findNodesByType("scene/global");if(!b.length)return a;for(var c=0;c<b.length;++c){var d=b[c];void 0!==a[d.id]&&(d.properties.value=a[d.id])}};la.prototype.getPropertyValue=function(a){var b=this._graph.findNodesByType("scene/global");if(!b.length)return null;for(var c=0;c<b.length;++c){var d=b[c];if(d.properties.name==a)return d.properties.value}};
la.prototype.setPropertyValue=function(a,b){var c=this._graph.findNodesByType("scene/global");if(c.length)for(var d=0;d<c.length;++d){var f=c[d];if(f.properties.name==a)return f.properties.value&&f.properties.value.set?f.properties.value.set(b):f.properties.value=b,!0}};e.registerComponent(la);ia.icon="mini-icon-graph.png";ia.buffer_size=[1024,512];Object.defineProperty(ia.prototype,"graph",{enumerable:!1,get:function(){return this._graph},set:function(a){console.error("graph cannot be set manually")}});
Object.defineProperty(ia.prototype,"render_node",{enumerable:!1,get:function(){return this._graph_frame_node},set:function(a){console.error("render_node cannot be set manually")}});Object.defineProperty(ia.prototype,"viewport_node",{enumerable:!1,get:function(){return this._graph_viewport_node},set:function(a){console.error("viewport_node cannot be set manually")}});ia.prototype.configure=function(a){if(this._graph&&a.graph_data&&(this.uid=a.uid,this.enabled=!!a.enabled,this.use_antialiasing=!!a.use_antialiasing,
this.use_node_camera=!!a.use_node_camera,a.frame&&this.frame.configure(a.frame),this._graph.configure(JSON.parse(a.graph_data)),this._graph_frame_node=this._graph.findNodesByTitle("Rendered Frame")[0],this._graph_viewport_node=this._graph.findNodesByType("texture/toviewport")[0],!this._graph_frame_node)){console.log("CONVERTING LEGACY DATA TO NEW FORMAT");this._graph_frame_node=LiteGraph.createNode("scene/frame","Rendered Frame");this._graph_frame_node.ignore_remove=!0;this._graph_frame_node.ignore_rename=
!0;this._graph.add(this._graph_frame_node);a=["Color Buffer","Depth Buffer","Extra Buffer"];for(var b=0;b<a.length;++b){var c=this._graph.findNodesByTitle(a[b])[0];if(c){var d=c.getOutputInfo(0);if(d.links){var d=d.links.concat(),f;for(f in d){var e=this._graph.links[d[f]];e&&this._graph_frame_node.connect(b,e.target_id,e.target_slot)}this._graph.remove(c)}}}}};ia.prototype.serialize=function(){return{object_class:"FXGraphComponent",uid:this.uid,enabled:this.enabled,use_antialiasing:this.use_antialiasing,
frame:this.frame.serialize(),use_node_camera:this.use_node_camera,graph_data:this._graph?JSON.stringify(this._graph.serialize()):null}};ia.prototype.getResources=function(a){if(this._graph)return this._graph.sendEventToAllNodes("getResources",a),a};ia.prototype.getPropertyValue=function(a){var b=this._graph.findNodesByType("scene/global");if(b.length)for(var c=0;c<b.length;++c){var d=b[c];if(d.properties.name==a)return d.properties.value}};ia.prototype.setPropertyValue=function(a,b){var c=this._graph.findNodesByType("scene/global");
if(c.length)for(var d=0;d<c.length;++d){var e=c[d];if(e.properties.name==a)return e.properties.value&&e.properties.value.set?e.properties.value.set(b):e.properties.value=b,!0}};ia.prototype.onResourceRenamed=function(a,b,c){this._graph&&this._graph.sendEventToAllNodes("onResourceRenamed",[a,b,c])};ia.prototype.onAddedToNode=function(a){this._graph&&(this._graph._scenenode=a)};ia.prototype.onRemovedFromNode=function(a){this._graph&&(this._graph._scenenode=null)};ia.prototype.onAddedToScene=function(a){this._graph&&
(this._graph._scene=a,LEvent.bind(a,"enableFrameContext",this.onBeforeRender,this),LEvent.bind(a,"showFrameContext",this.onAfterRender,this))};ia.prototype.onRemovedFromScene=function(a){this._graph&&(this._graph._scene=null,LEvent.unbind(a,"enableFrameContext",this.onBeforeRender,this),LEvent.unbind(a,"showFrameContext",this.onAfterRender,this),e.ResourcesManager.unregisterResource(":color_"+this.uid),e.ResourcesManager.unregisterResource(":depth_"+this.uid),e.ResourcesManager.unregisterResource(":extra_"+
this.uid))};ia.prototype.onBeforeRender=function(a,b){this._last_camera=e.Renderer._main_camera;if(this.enabled)if(this.use_node_camera){var c=this._root.camera;c&&c!=this._binded_camera&&(this._binded_camera&&LEvent.unbindAll(this._binded_camera,this),LEvent.bind(c,"enableFrameContext",this.enableCameraFBO,this),LEvent.bind(c,"showFrameContext",this.showCameraFBO,this));this._binded_camera=c}else this._binded_camera&&(LEvent.unbindAll(this._binded_camera,this),this._binded_camera=null),this.enableGlobalFBO(b);
else this._binded_camera&&(LEvent.unbindAll(this._binded_camera,this),this._binded_camera=null)};ia.prototype.onAfterRender=function(a,b){this.enabled&&(this.use_node_camera||this.showFBO())};ia.prototype.enableCameraFBO=function(a,b){if(this.enabled){var c=this._viewport=this._binded_camera.getLocalViewport(null,this._viewport);this.frame.enable(b,c);b.ignore_viewports=!0}};ia.prototype.showCameraFBO=function(a,b){this.enabled&&(b.ignore_viewports=!1,this.showFBO())};ia.prototype.enableGlobalFBO=
function(a){this.enabled&&this.frame.enable(a,null,e.Renderer._main_camera)};ia.prototype.showFBO=function(){if(this.enabled){this.frame.disable();e.ResourcesManager.textures[":color_"+this.uid]=this.frame._color_texture;e.ResourcesManager.textures[":depth_"+this.uid]=this.frame._depth_texture;if(this.frame.num_extra_textures)for(var a=0;a<this.frame.num_extra_textures;++a)e.ResourcesManager.textures[":extra"+a+"_"+this.uid]=this.frame._textures[a+1];this.use_node_camera&&this._viewport?(gl.setViewport(this._viewport),
this.applyGraph(),gl.setViewport(this.frame._fbo._old_viewport)):this.applyGraph()}};ia.prototype.applyGraph=function(){this._graph&&(this._graph_frame_node||(this._graph_frame_node=this._graph.findNodesByTitle("Rendered Frame")[0]),this._graph_frame_node._color_texture=":color_"+this.uid,this._graph_frame_node._depth_texture=":depth_"+this.uid,this._graph_frame_node._extra_texture=":extra0_"+this.uid,this._graph_frame_node._camera=this._last_camera,this._graph_viewport_node&&(this._graph_viewport_node.properties.filter=
this.frame.filter_texture,this._graph_viewport_node.properties.antialiasing=this.use_antialiasing),this._graph.runStep(1,e.catch_exceptions))};e.registerComponent(ia);(function(){function a(a){this.enabled=!0;this.value=0;this.delta=0.01;this.min_value=this.steps=0;this.max_value=1;this.min_angle=-120;this.max_angle=120;this.axis=vec3.fromValues(0,0,1);this._dragging=!1;a&&this.configure(a)}a.icon="mini-icon-knob.png";a.prototype.onAddedToScene=function(a){LEvent.bind(a,"mousedown",this.onMouse,this);
LEvent.bind(a,"mouseup",this.onMouse,this);LEvent.bind(a,"mousemove",this.onMouse,this);this.updateKnob()};a.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,this)};a.prototype.updateKnob=function(){this._root&&this.enabled&&(quat.setAxisAngle(this._root.transform._rotation,this.axis,(this.min_angle+this.value/(this.max_value-this.min_value)*(this.max_angle-this.min_angle))*DEG2RAD),this._root.transform.mustUpdate=!0)};a.prototype.onMouse=function(a,c){if(this.enabled)if("mousedown"==a){if(this._root&&
this._root._instances&&this._root._instances.length){var d=this._root._instances[0],f=e.Renderer.getCameraAtPosition(c.canvasx,c.canvasy);f&&(f=f.getRayInPixel(c.canvasx,c.canvasy))&&(this._dragging=geo.testRayBBox(f.origin,f.direction,d.aabb))}}else if("mouseup"==a)this._dragging=!1;else if(c.dragging&&this._dragging)return this.value-=c.deltay*this.delta,this.value>this.max_value?this.value=this.max_value:this.value<this.min_value&&(this.value=this.min_value),this.updateKnob(),LEvent.trigger(this,
"change",this.value),this._root&&LEvent.trigger(this._root,"knobChange",this.value),!1};e.registerComponent(a)})();Object.defineProperty(tb.prototype,"pos",{get:function(){return this._pos},set:function(a){this._pos.set(a)},enumerable:!0});Object.defineProperty(tb.prototype,"vel",{get:function(){return this._vel},set:function(a){this._vel.set(a)},enumerable:!0});W.BOX_EMISSOR=1;W.SPHERE_EMISSOR=2;W.MESH_EMISSOR=3;W.CUSTOM_EMISSOR=10;W["@emissor_type"]={type:"enum",values:{Box:W.BOX_EMISSOR,Sphere:W.SPHERE_EMISSOR,
Mesh:W.MESH_EMISSOR,Custom:W.CUSTOM_EMISSOR}};W.icon="mini-icon-particles.png";Object.defineProperty(W.prototype,"particle_start_color",{get:function(){return this._particle_start_color},set:function(a){a&&this._particle_start_color.set(a)},enumerable:!0});Object.defineProperty(W.prototype,"particle_end_color",{get:function(){return this._particle_end_color},set:function(a){a&&this._particle_end_color.set(a)},enumerable:!0});W.prototype.onAddedToScene=function(a){LEvent.bind(a,"update",this.onUpdate,
this);LEvent.bind(a,"start",this.onStart,this);LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this);LEvent.bind(a,"afterCameraEnabled",this.onAfterCamera,this)};W.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,this)};W.prototype.getResources=function(a){this.emissor_mesh&&(a[this.emissor_mesh]=Mesh);this.texture&&(a[this.texture]=Texture)};W.prototype.onResourceRenamed=function(a,b,c){this.emissor_mesh==a&&(this.emissor_mesh=b);this.texture==a&&(this.texture=b)};W.prototype.onAfterCamera=
function(a,b){this.enabled&&this.align_always&&this.updateMesh(b)};W.prototype.createParticle=function(a){a=a||new tb;switch(this.emissor_type){case W.BOX_EMISSOR:a._pos.set([this.emissor_size[0]*(Math.random()-0.5),this.emissor_size[1]*(Math.random()-0.5),this.emissor_size[2]*(Math.random()-0.5)]);break;case W.SPHERE_EMISSOR:var b=2*Math.PI*Math.random(),c=Math.acos(2*Math.random()-1);a._pos.set([Math.sin(c)*Math.cos(b),Math.sin(c)*Math.sin(b),Math.cos(c)]);vec3.multiply(a.pos,a.pos,this.emissor_size);
break;case W.MESH_EMISSOR:(b=this.emissor_mesh)&&b.constructor===String&&(b=e.ResourcesManager.getMesh(this.emissor_mesh)),b&&b.getBuffer("vertices")?(b=b.getBuffer("vertices").data,c=3*Math.floor(Math.random()*b.length/3),a._pos.set([b[c]+0.001*Math.random(),b[c+1]+0.001*Math.random(),b[c+2]+0.001*Math.random()])):a._pos.set([0,0,0])}a._vel.set([Math.random()-0.5,Math.random()-0.5,Math.random()-0.5]);a.life=this.particle_life;a.id=this._last_id;a.angle=0;a.size=1;a.rot=this.particle_rotation+0.25*
this.particle_rotation*Math.random();this._last_id+=1;this.independent_color&&(a.c=vec3.clone(this.particle_start_color));vec3.scale(a._vel,a._vel,this.particle_speed);if(this.emissor_type==W.CUSTOM_EMISSOR&&this.onCreateParticle)this.onCreateParticle(a,this);this.follow_emitter||vec3.add(a._pos,a._pos,this._emissor_pos);return a};W.prototype.onStart=function(a){if(this.enabled&&!(0>=this.warm_up_time)){a=1/30;for(var b=0;b<this.warm_up_time;b+=a)this.onUpdate(null,a,!0)}};W.prototype.onUpdate=function(a,
b,c){if(this.enabled){if(!this._root.scene)throw"update without scene? impossible";this._root.transform&&this._root.transform.getGlobalPosition(this._emissor_pos);0>this.emissor_rate&&(this.emissor_rate=0);if(!this.stop_update){var d=vec3.clone(this.physics_gravity),f=this.physics_friction;a=[];for(var h=vec3.create(),g=0,k=this._particles.length;g<k;++g){var m=this._particles[g];vec3.copy(h,m._vel);vec3.add(h,d,h);vec3.scale(h,h,b);f&&(h[0]-=h[0]*f,h[1]-=h[1]*f,h[2]-=h[2]*f);vec3.add(m._pos,h,m._pos);
m.angle+=m.rot*b;m.life-=b;if(this.onUpdateParticle)this.onUpdateParticle(m,b,this);0<m.life&&a.push(m)}if(0!=this.emissor_rate)for(b=(b+this._remining_dt)*this.emissor_rate,this._remining_dt=b%1/this.emissor_rate,b<<=0,b>this.max_particles&&(b=this.max_particles),g=0;g<b;g++)m=this.createParticle(),a.length<this.max_particles&&a.push(m);this._particles=a}this.align_always||c||(this.updateMesh(e.Renderer._current_camera),this._root.scene.requestFrame());LEvent.trigger(this._root.scene,"change")}};
W.prototype.createMesh=function(){if(this._mesh_maxparticles!=this.max_particles){this._vertices=new Float32Array(18*this.max_particles);this._coords=new Float32Array(12*this.max_particles);this._colors=new Float32Array(24*this.max_particles);this._extra2=new Float32Array(2*this.max_particles);for(var a=[1,1,0,1,1,0,0,1,0,0,1,0],b=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],c=0;c<this.max_particles;c++)this._coords.set(a,12*c),this._colors.set(b,24*c),this._extra2[2*c]=1,this._extra2[2*c+1]=
c;this._computed_grid_size=1;this._mesh=new GL.Mesh;this._mesh.addBuffers({vertices:this._vertices,coords:this._coords,colors:this._colors,extra2:this._extra2},null,gl.STREAM_DRAW);this._mesh_maxparticles=this.max_particles}};W._tmp_quat=quat.create();W.prototype.updateMesh=function(a){if(a){this._mesh_maxparticles!=this.max_particles&&this.createMesh();var b=a.getEye(),c=this._min_particle_size,d=a.getLocalVector([0,0,1]),f=a.getLocalVector([1,0,0]),h=a.getLocalVector([0,1,0]);a=vec3.create();var g=
vec3.fromValues(-1,0,-1),k=vec3.fromValues(1,0,-1),m=vec3.fromValues(-1,0,1),l=vec3.fromValues(1,0,1);this.align_with_camera&&(vec3.subtract(g,h,f),vec3.add(k,h,f),vec3.scale(m,k,-1),vec3.scale(l,g,-1));var f=vec3.create(),h=vec3.create(),n=vec3.create(),p=vec3.create(),q=this._particles;if(this.sort_in_z){for(var q=this._particles.concat(),r=geo.createPlane(b,d),s=1/Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),b=0;b<q.length;++b)q[b]._dist=Math.abs(vec3.dot(q[b]._pos,r)+r[3])*s;q.sort(function(a,b){return a._dist<
b._dist?1:a._dist>b._dist?-1:0});this._particles=q}0==this.particle_life&&(this.particle_life=1E-4);var r=new Float32Array([1,1,1,1]),s=this._particle_start_color,t=this._particle_end_color,K=!1;if(this._computed_grid_size!=this.texture_grid_size||1<this.texture_grid_size||this.point_particles)K=!0,this._computed_grid_size=this.texture_grid_size;for(var G=1/this.texture_grid_size,O=0,C=0,u=this.texture_grid_size<<2,w=this.animated_texture,x=this.loop_animation,y=this._root.scene.getTime()*this.animation_fps,
z=new Float32Array(60*this.particle_life<<0),D=new Float32Array(60*this.particle_life<<0),E=this.particle_size,A=1/(60*this.particle_life),b=0;b<z.length;b+=1)z[b]=e.getCurveValueAt(this.particle_opacity_curve,0,1,0,b*A),D[b]=e.getCurveValueAt(this.particle_size_curve,0,1,0,b*A);for(var A=this.point_particles,H=this._vertices.length,B=this._vertices,F=this._colors,L=this._extra2,N=this._coords,M=W._tmp_quat,P=O=b=0,Q=q.length;P<Q;++P)if(C=q[P],!(0>=C.life)){var O=1-C.life/this.particle_life,I=z[O*
z.length<<0];this.independent_color&&C.c?vec3.clone(r,C.c):vec3.lerp(r,s,t,O);this.premultiplied_alpha?(vec3.scale(r,r,I),r[3]=1):r[3]=I;if(!(0.001>I||(I=C.size*D[O*D.length<<0],Math.abs(I*E)<c)))if(A){if(B.set(C._pos,3*b),F.set(r,4*b),K&&(O=(w?(x?y:O)*u<<0:C.id)%u,O*=G,C=1-(O<<0)*G-G,O%=1,N[2*b]=O,N[2*b+1]=C),L[2*b]=I,L[2*b+1]=b,++b,3*b>=H)break}else if(I*=E,vec3.scale(n,m,I),vec3.scale(h,k,I),vec3.scale(f,g,I),vec3.scale(p,l,I),0!=C.angle&&(quat.setAxisAngle(M,d,C.angle*DEG2RAD),vec3.transformQuat(n,
n,M),vec3.transformQuat(h,h,M),vec3.transformQuat(f,f,M),vec3.transformQuat(p,p,M)),vec3.add(a,C._pos,h),B.set(a,18*b),vec3.add(a,C._pos,f),B.set(a,18*b+3),vec3.add(a,C._pos,p),B.set(a,18*b+6),vec3.add(a,C._pos,f),B.set(a,18*b+9),vec3.add(a,C._pos,n),B.set(a,18*b+12),vec3.add(a,C._pos,p),B.set(a,18*b+15),F.set(r,24*b),F.set(r,24*b+4),F.set(r,24*b+8),F.set(r,24*b+12),F.set(r,24*b+16),F.set(r,24*b+20),K&&(O=(w?(x?y:O)*u<<0:C.id)%u,O*=G,C=1-(O<<0)*G-G,O%=1,N.set([O+G,C+G,O,C+G,O+G,C,O,C+G,O,C,O+G,C],
12*b)),++b,18*b>=H)break}this._visible_particles=b;this._mesh.vertexBuffers.vertices.data=this._vertices;this._mesh.vertexBuffers.vertices.upload(gl.STREAM_DRAW);this._mesh.vertexBuffers.colors.data=this._colors;this._mesh.vertexBuffers.colors.upload(gl.STREAM_DRAW);this._mesh.vertexBuffers.extra2.data=this._extra2;this._mesh.vertexBuffers.extra2.upload(gl.STREAM_DRAW);K&&(this._mesh.vertexBuffers.coords.data=this._coords,this._mesh.vertexBuffers.coords.upload(gl.STREAM_DRAW))}};W._identity=mat4.create();
W.prototype.onCollectInstances=function(a,b,c){if(this._root&&this.enabled){this._material||(this._material=new e.StandardMaterial({shader_name:"lowglobal"}));this._material.opacity=this.opacity-0.01;this._material.setTexture("color",this.texture);this._material.blend_mode=this.additive_blending?e.Blend.ADD:e.Blend.ALPHA;this._material.constant_diffuse=!0;this._material.uvs_matrix[0]=this._material.uvs_matrix[4]=1/this.texture_grid_size;this._material.flags.depth_write=!1;this._material.flags.ignore_lights=
this.ignore_lights;if(!this._mesh)return null;a=this._render_instance;a||(this._render_instance=a=new e.RenderInstance(this._root,this));this.follow_emitter?mat4.translate(a.matrix,W._identity,this._root.transform._position):(mat4.copy(a.matrix,W._identity),this._root.transform&&this._root.transform.getGlobalPosition(a.center));c=this._root.material&&this.use_node_material?this._root.getMaterial():this._material;mat4.multiplyVec3(a.center,a.matrix,vec3.create());a.setMaterial(c);this.point_particles?
(a.setMesh(this._mesh,gl.POINTS),a.uniforms.u_point_size=this.particle_size,a.setRange(0,this._visible_particles)):(a.setMesh(this._mesh,gl.TRIANGLES),a.setRange(0,6*this._visible_particles),delete a.uniforms.u_point_size);a.use_bounding=!1;b.push(a)}};e.Particle=tb;e.registerComponent(W);ab.icon="mini-icon-text.png";ab.CSS_classname="LS3D_label";ab.prototype.onAddedToScene=function(a){LEvent.bind(a,"renderGUI",this.render,this)};ab.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"renderGUI",
this.render,this);this.removeHTML()};ab.prototype.createHTML=function(){var a=document.createElement("div");a.innerHTML=this.text;var b=a.style;b.className=this.constructor.CSS_classname;b.position="absolute";b.top=0;b.left=0;b.fontSize="20px";b.padding="10px";b.color="white";b.minWidth="100px";b.pointerEvents="none";b.backgroundColor="rgba(0,0,0,0.5)";b.borderRadius="2px";e.getGUIElement().appendChild(a);this._element=a};ab.prototype.removeHTML=function(){this._element&&(this._element.parentNode&&
this._element.parentNode.removeChild(this._element),this._element=null)};ab.prototype.render=function(a,b){var c=this._root,d=e.Renderer._main_camera;if(d)if(c.transform.getGlobalPosition(this._world_pos),d.project(this._world_pos,null,this._screen_pos),this.use_html)this._element||this.createHTML(),this._element.innerHTML!=this.text&&(this._element.innerHTML=this.text),this._element.style.display=!1===c.flags.visible?"none":"block",this.text?(c=this.constructor.CSS_classname+" "+this.className,this._element.className!=
c&&(this._element.className=c),this._element.style.left=this._screen_pos[0].toFixed(0)+"px",this._element.style.top=gl.canvas.height-(this._screen_pos[1]|0)-10+"px"):this._element.style.display="none";else if(this._element&&this.removeHTML(),gl.start2D){c=this._screen_pos[0]+5;d=gl.canvas.height-this._screen_pos[1]+10;gl.start2D();gl.font="20px Arial";var f=gl.measureText(this.text);gl.fillStyle="black";gl.globalAlpha=0.5;gl.fillRect(c-5,d-20,f.width+10,26);gl.globalAlpha=1;gl.fillStyle="white";gl.fillText(this.text,
c,d);gl.finish2D()}};e.registerComponent(ab);ca.icon="mini-icon-points.png";ca["@texture"]={widget:"texture"};ca["@color"]={widget:"color"};ca["@num_points"]={widget:"info"};ca["@size"]={type:"number",step:0.001,precision:3};ca.default_color=vec4.fromValues(1,1,1,1);Object.defineProperty(ca.prototype,"num_points",{set:function(a){},get:function(){return this._points.length},enumerable:!0});ca.prototype.addPoint=function(a,b,c,d){var e=new Float32Array(10);e.set(a,0);b?e.set(b,3):e.set(ca.default_color,
3);e[7]=void 0!==c?c:1;e[8]=void 0!=d?d:0;this._points.push(e);this._must_update=!0;return this._points.length-1};ca.prototype.clear=function(){this._points.length=0};ca.prototype.reset=ca.prototype.clear;ca.prototype.setPoint=function(a,b,c,d,e){if(a=this._points[a])b&&a.set(b,0),c&&a.set(c,3),void 0!==d&&(a[7]=d),void 0!==e&&(a[8]=e),this._must_update=!0};ca.prototype.setPointsFromMesh=function(a){};ca.prototype.removePoint=function(a){this._points.splice(a,1);this._must_update=!0};ca.prototype.onAddedToNode=
function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};ca.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};ca.prototype.getResources=function(a){this.mesh&&(a[this.emissor_mesh]=Mesh);this.texture&&(a[this.texture]=Texture)};ca.prototype.onResourceRenamed=function(a,b,c){this.mesh==a&&(this.mesh=b);this.texture==a&&(this.texture=b)};ca.prototype.createMesh=function(){var a=this.max_points|0;if(this._mesh_max_points!=
a){this._vertices=new Float32Array(3*a);this._colors=new Float32Array(4*a);this._extra2=new Float32Array(2*a);for(var b=0;b<a;b++)this._colors.set(ca.default_color,4*b),this._extra2[2*b]=1;this._mesh&&this._mesh.deleteBuffers();this._mesh=new GL.Mesh;this._mesh.addBuffers({vertices:this._vertices,colors:this._colors,extra2:this._extra2},null,gl.STREAM_DRAW);this._mesh_max_points=a}};ca.prototype.updateMesh=function(a){this._mesh_max_points!=(this.max_points|0)&&this.createMesh();var b=this._points;
if(this.sort_in_z&&a){var c=a.getEye();a=a.getFront();b=this._points.concat();c=geo.createPlane(c,a);a=Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]);for(var d=0;d<b.length;++d)b[d][9]=Math.abs(vec3.dot(b[d].subarray(0,3),c)+c[3])/a;b.sort(function(a,b){return a[9]<b[9]?1:a[9]>b[9]?-1:0})}d=0;c=this._vertices;a=this._colors;for(var d=this._extra2,e=this.premultiplied_alpha,h=0;h<b.length&&!(3*h>=c.length);++h){var g=b[h];c.set(g.subarray(0,3),3*h);var k=g.subarray(3,7);e&&vec3.scale(k,k,k[3]);a.set(k,4*
h);d.set(g.subarray(7,9),2*h)}this._mesh.vertexBuffers.vertices.data=c;this._mesh.vertexBuffers.vertices.upload();this._mesh.vertexBuffers.colors.data=a;this._mesh.vertexBuffers.colors.upload();this._mesh.vertexBuffers.extra2.data=d;this._mesh.vertexBuffers.extra2.upload()};ca._identity=mat4.create();ca.prototype.onCollectInstances=function(a,b,c){if(this._root&&0!=this._points.length&&this.enabled){a=e.Renderer._current_camera;this._last_premultiply!==this.premultiplied_alpha&&(this._must_update=
!0);this._must_update&&this.updateMesh(a);this._material||(this._material=new e.StandardMaterial({}),this._material.extra_macros={USE_POINT_CLOUD:"",USE_TEXTURED_POINTS:""});c=this._material;c.color.set(this.color);c.opacity=this.premultiplied_alpha?0.99:this.global_opacity-0.01;this._last_premultiply=this.premultiplied_alpha;c.setTexture(e.Material.COLOR,this.texture);c.blend_mode=this.additive_blending?e.Blend.ADD:e.Blend.ALPHA;c.constant_diffuse=!0;if(!this._mesh)return null;a=this._render_instance;
a||(this._render_instance=a=new e.RenderInstance(this._root,this));this.in_world_coordinates&&this._root.transform?a.matrix.set(this._root.transform._global_matrix):mat4.copy(a.matrix,ca._identity);c=this._root.material&&this.use_node_material?this._root.getMaterial():this._material;mat4.multiplyVec3(a.center,a.matrix,vec3.create());a.uniforms.u_point_size=this.size;a.setMaterial(c);a.setMesh(this._mesh,gl.POINTS);c=this._points.length;c>this._vertices.length/3&&(c=this._vertices.length/3);a.setRange(0,
c);b.push(a)}};ca.prototype.serialize=function(){var a=e.cloneObject(this);a.object_class="PointCloud";this.uid&&(a.uid=this.uid);if(this.serialize_points){for(var b=Array(this._points.length),c=0;c<this._points.length;c++)b[c]=typedArrayToArray(this._points[c]);a.points=b}return a};ca.prototype.configure=function(a){if(a){a.uid&&(this.uid=a.uid);if(a.points&&a.serialize_points){this._points=Array(a.points.length);for(var b=0;b<a.points.length;b++)this._points[b]=new Float32Array(a.points[b]);a.points=
null}e.cloneObject(a,this)}};e.registerComponent(ca);Aa.icon="mini-icon-lines.png";Aa["@color"]={widget:"color"};Aa["@lines"]={widget:"null"};Object.defineProperty(Aa.prototype,"lines",{set:function(a){this._lines=a},get:function(){return this._lines},enumerable:!0});Object.defineProperty(Aa.prototype,"num_lines",{set:function(a){},get:function(){return this._lines.length},enumerable:!0});Aa.prototype.clear=function(){this._lines.length=0};Aa.prototype.reset=Aa.prototype.clear;Aa.prototype.addPoint=
function(a,b){var c=null,d=null;this._lines.length?(d=this._lines[this._lines.length-1],c=new Float32Array(d.subarray(3,6)),d=new Float32Array(d.subarray(10,14))):(c=a,d=b);this.addLine(c,a,d,b)};Aa.prototype.addLine=function(a,b,c,d){var e=new Float32Array(14);e.set(a,0);e.set(b,3);c?e.set(c,6):e.set([1,1,1,1],6);d?e.set(d,10):c?e.set(c,10):e.set([1,1,1,1],10);this._lines.push(e);this._must_update=!0;return this._lines.length-1};Aa.prototype.setLine=function(a,b,c,d,e){a=this._lines[a];b&&a.set(b,
0);c&&a.set(c,3);d&&a.set(d,6);e&&a.set(e,10);this._must_update=!0};Aa.prototype.removeLine=function(a){this._lines.splice(a,1);this._must_update=!0};Aa.prototype.onAddedToScene=function(a){LEvent.bind(a,"afterRenderScene",this.onAfterRender,this)};Aa.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"afterRenderScene",this.onAfterRender,this)};Aa.prototype.createMesh=function(){this._mesh_max_lines!=this.max_lines&&(this._vertices=new Float32Array(6*this.max_lines),this._colors=new Float32Array(8*
this.max_lines),this._mesh=new GL.Mesh,this._mesh.addBuffers({vertices:this._vertices,colors:this._colors},null,gl.STREAM_DRAW),this._mesh_max_lines=this.max_lines)};Aa.prototype.updateMesh=function(){this._mesh_max_lines!=this.max_lines&&this.createMesh();for(var a=0,b=this._vertices,c=this._colors,d=this._lines,e=this._lines.length,h=b.length,a=0;a<e&&!(6*a>=h);++a){var g=d[a];b.set(g.subarray(0,6),6*a);c.set(g.subarray(6,14),8*a)}this._mesh.vertexBuffers.vertices.data=b;this._mesh.vertexBuffers.vertices.upload();
this._mesh.vertexBuffers.colors.data=c;this._mesh.vertexBuffers.colors.upload()};Aa.prototype.onAfterRender=function(a){this._root&&0!=this._lines.length&&this.enabled&&(this._must_update&&this.updateMesh(),e.Draw.renderMesh(this._mesh,GL.LINES))};e.registerComponent(Aa);N.LOOP=1;N.PINGPONG=2;N.ONCE=3;N.PAUSED=4;N.MODES={loop:N.LOOP,pingpong:N.PINGPONG,once:N.ONCE,paused:N.PAUSED};N.properties_order=["animation","take"];N["@animation"]={widget:"animation"};N["@root_node"]={type:"node"};N["@mode"]=
{type:"enum",values:N.MODES};N["@current_time"]={type:e.TYPES.NUMBER,min:0,units:"s"};N["@blend_time"]={type:e.TYPES.NUMBER,min:0,units:"s"};N["@take"]={type:"enum",values:function(){var a=this.instance.getAnimation();if(!a)return["default"];var a=a.takes,b=[],c;for(c in a)b.push(c);return b}};Object.defineProperty(N.prototype,"animation",{set:function(a){a!=this._animation&&(this._blend_animation=this._animation,this._animation=a,this.blend_time&&this._root&&this._root.scene&&(this._use_blend_animation=
!0,this._root.scene.frame!=this._blend_updated_frame&&(this._blend_current_time=this.current_time,this._blend_remaining_time=this.blend_time,this._blend_updated_frame=this._root.scene.frame)))},get:function(){return this._animation},enumerable:!0});Object.defineProperty(N.prototype,"take",{set:function(a){a!=this._take&&(this._blend_take=this._take,this._take=a,this.blend_time&&this._root&&this._root.scene&&(this._use_blend_animation=!0,this._root.scene.frame!=this._blend_updated_frame&&(this._blend_current_time=
this.current_time,this._blend_remaining_time=this.blend_time,this._blend_updated_frame=this._root.scene.frame)))},get:function(){return this._take},enumerable:!0});N.prototype.configure=function(a){a.play&&delete a.play;void 0!==a.enabled&&(this.enabled=!!a.enabled);a.range&&(this.range=a.range.concat());void 0!==a.mode&&(this.mode=a.mode);a.animation&&(this._animation=a.animation);a.take&&(this._take=a.take);null!=a.playback_speed&&(this.playback_speed=parseFloat(a.playback_speed));void 0!==a.root_node&&
(this.root_node=a.root_node);void 0!==a.playing&&(this.playing=a.playing);void 0!==a.blend_time&&(this.blend_time=a.blend_time)};N.icon="mini-icon-clock.png";N.prototype.onAddedToScene=function(a){LEvent.bind(a,"update",this.onUpdate,this)};N.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"update",this.onUpdate,this)};N.prototype.onUpdate=function(a,b){if(this.enabled&&this.playing&&(this.mode!=N.PAUSED&&(this.current_time+=b*this.playback_speed),this.onUpdateAnimation(b),this._use_blend_animation))this.onUpdateBlendAnimation(b)};
N.prototype.onUpdateAnimation=function(a){if(a=this.getAnimation())if(a=a.takes[this.take]){var b=this.current_time,c=0,d=a.duration,e=d;this.range&&(c=this.range[0],e=this.range[1],d=e-c);if(b>e)switch(this.mode){case N.ONCE:b=e;LEvent.trigger(this,"end_animation");this.playing=!1;break;case N.PINGPONG:b=0==(b/d|0)%2?this.current_time%d:d-this.current_time%d;break;case N.PINGPONG:b=e;break;default:b=(this.current_time-c)%d+c,LEvent.trigger(this,"animation_loop")}else b<c&&(b=c);this.applyAnimation(a,
b,this._last_time);this._last_time=b;(a=this._root.scene)&&a.requestFrame()}};N.prototype.onUpdateBlendAnimation=function(a){var b=this.getAnimation(this._blend_animation||this._animation||"");if(b&&(b=b.takes[this._blend_take||this._take||"default"])){this._blend_current_time+=a;this._blend_remaining_time-=a;0>=this._blend_remaining_time&&(this._use_blend_animation=!1);a=this._blend_current_time*this.playback_speed;var c=0,d=b.duration,e=d;this.range&&(c=this.range[0],e=this.range[1],d=e-c);if(a>
e)switch(this.mode){case N.ONCE:a=e;this._use_blend_animation=!1;break;case N.PINGPONG:a=0==(a/d|0)%2?this._blend_current_time%d:d-this._blend_current_time%d;break;case N.PINGPONG:a=e;break;default:a=(this._blend_current_time-c)%d+c}else a<c&&(a=c);this.applyAnimation(b,a,null,this._blend_remaining_time/this.blend_time);(b=this._root.scene)&&b.requestFrame()}};N.prototype.getAnimation=function(a){a=void 0===a?this.animation:a;return a&&"@"!=a[0]?(a=e.ResourcesManager.getResource(a))&&a.constructor===
e.Animation?a:null:this._root.scene.animation};N.prototype.getTake=function(a){var b=this.getAnimation();if(!b)return null;a=a||this.take;return(a=b.takes[a])?a:null};N.prototype.getDuration=function(){var a=this.getTake();return a?a.duration:-1};N.prototype.play=function(){this._root&&this._root.scene||console.error("cannot play an animation if the component doesnt belong to a node in a scene");this.playing=!0;this.current_time=0;this.range&&(this.current_time=this.range[0]);this._last_time=this.current_time;
LEvent.trigger(this,"start_animation")};N.prototype.pause=function(){this.playing=!1};N.prototype.stop=function(){this.playing=!1;this.current_time=0;this.range&&(this.current_time=this.range[0]);this._last_time=this.current_time};N.prototype.playRange=function(a,b){this.playing=!0;this._last_time=this.current_time=a;this.range=[a,b]};N.prototype.applyAnimation=function(a,b,c,d){void 0===c&&(c=b);if(this._root){var e=null;this.root_node&&this._root.scene&&(e="@"==this.root_node?this._root:this._root.scene.getNode(this.root_node));
a.applyTracks(b,c,void 0,e,this._root.scene,d,this.onPreApply,this.onApplySample)}};N.prototype._processSample=function(a,b,c,d){if(d=this._root.scene)if(a=d.getNode(a)){d=a.transform;switch(b){case "translate.X":d&&(d.position[0]=c);break;case "translate.Y":d&&(d.position[1]=c);break;case "translate.Z":d&&(d.position[2]=c);break;case "matrix":d&&d.fromMatrix(c)}a.transform&&a.transform.updateMatrix()}};N.prototype.getResources=function(a){this.animation&&(a[this.animation]=e.Animation)};N.prototype.onResourceRenamed=
function(a,b,c){this.animation==a&&(this.animation=b)};N.prototype.getEvents=function(){return{start_animation:"event",end_animation:"event"}};N.prototype.getActions=function(a){a=a||{};a.play="function";a.pause="function";a.stop="function";return a};e.registerComponent(N);bb.icon="mini-icon-reflector.png";bb["@texture_size"]={type:"enum",values:["viewport",64,128,256,512,1024,2048]};bb["@layers"]={type:"layers"};bb.prototype.onAddedToScene=function(a){LEvent.bind(a,"renderReflections",this.onRenderReflection,
this);LEvent.bind(a,"afterCameraEnabled",this.onCameraEnabled,this)};bb.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,this);for(var b in this._textures)e.ResourcesManager.unregisterResource(":reflection_"+b);this._textures={}};bb.prototype.onRenderReflection=function(a,b){if(this.enabled&&this._root){var c=this._root.scene;if(c&&(this.refresh_rate<<=0,0!=c._frame&&0==c._frame%this.refresh_rate||!this._rt)){var d=c=parseInt(this.texture_size),f=c,h=this._root.flags.visible;this.ignore_this_mesh&&
(this._root.flags.seen_by_reflections=!1);var g=b.layers;b.layers=this.layers;var k=e.Renderer._visible_cameras;e.Renderer.clearSamplers();for(var m=0;m<k.length;m++){var l=k[m];isNaN(c)&&"viewport"==this.texture_size&&(c=512,f=l.getLocalViewport(null,l._viewport_in_pixels),d=f[2],f=f[3]);this.use_cubemap&&(d=f=c);var n=this.use_cubemap?gl.TEXTURE_CUBE_MAP:gl.TEXTURE_2D,p=this.high_precision?gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE,q=this._textures[l.uid];q&&q.width==d&&q.height==f&&q.type==p&&q.texture_type==
n&&q.minFilter==(this.generate_mipmaps?gl.LINEAR_MIPMAP_LINEAR:gl.LINEAR)||(q=new GL.Texture(d,f,{type:p,texture_type:n,minFilter:this.generate_mipmaps?gl.LINEAR_MIPMAP_LINEAR:gl.LINEAR}),q.has_mipmaps=this.generate_mipmaps,this._textures[l.uid]=q);q._locked=!0;var n=this._root.transform.getGlobalPosition(),p=this._root.transform.getTop(),r=l.getEye(),s=l.getCenter(),t=l.getUp();if(this.use_mesh_info){var K=this._root.getMesh();K&&(n=this._root.transform.globalToLocal(BBox.getCenter(K.bounding)),
p=this._root.transform.globalVectorToLocal(e.UP))}vec3.add(n,n,this.offset);this._reflected_camera=K=this._reflected_camera||new e.Camera;K.configure(l.serialize());this.use_cubemap?K.eye=n:(K.fov=l.fov,K.aspect=l.aspect,K.eye=geo.reflectPointInPlane(r,n,p),K.center=geo.reflectPointInPlane(s,n,p),K.up=geo.reflectPointInPlane(t,[0,0,0],p),vec3.add(n,n,vec3.scale(vec3.create(),p,-this.clip_offset)),n=[p[0],p[1],p[2],vec3.dot(n,p)],b.clipping_plane=n);e.Renderer.renderInstancesToRT(K,q,b);this.blur&&
((n=this._textures["blur_"+l.uid])&&(Texture.compareFormats(q,n)||n.minFilter!=q.minFilter)&&(n=null),q.applyBlur(this.blur,this.blur,1,null,n));this.generate_mipmaps&&isPowerOfTwo(d)&&isPowerOfTwo(f)&&(q.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR),gl.generateMipmap(q.texture_type),q.unbind());q._locked=!1;this.texture_name&&e.ResourcesManager.registerResource(this.texture_name,q);e.ResourcesManager.registerResource(":reflection_"+l.uid,q);if(!this.all_cameras)break}b.clipping_plane=
null;b.layers=g;delete b.brightness_factor;delete b.colorclip_factor;this._root.flags.visible=h}}};bb.prototype.onCameraEnabled=function(a,b){if(this.enabled&&this._root&&this._root.material&&this._textures[b.uid]){var c=this._root.getMaterial();c&&(c.setTexture(x.ENVIRONMENT_TEXTURE,":reflection_"+b.uid).uvs=x.COORDS_FLIPPED_SCREEN)}};e.registerComponent(bb);aa.last_id=0;aa.icon="mini-icon-reflector.png";aa["@texture_size"]={type:"enum",values:["viewport",64,128,256,512,1024,2048]};aa["@layers"]=
{type:"layers"};aa["@background_color"]={type:"color"};Object.defineProperty(aa.prototype,"enabled",{set:function(a){a!=this._enabled&&(this._enabled=a)&&(this.onRenderReflection(),e.GlobalScene.requestFrame())},get:function(){return this._enabled},enumerable:!0});aa.prototype.onAddedToScene=function(a){LEvent.bind(a,"start",this.onRenderReflection,this);LEvent.bind(a,"renderReflections",this.onRenderReflection,this);this.assignCubemaps(a)};aa.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,
this);this._texture&&e.ResourcesManager.unregisterResource(this._texid);this._irradiance_texture&&e.ResourcesManager.unregisterResource(this._texid+"_IR");this._irradiance_texture=this._texture=null};aa.prototype.afterSerialize=function(a){this._irradiance_texture&&(a.irradiance_info=aa.cubemapToObject(this._irradiance_texture))};aa.prototype.afterConfigure=function(a){a.irradiance_info&&(this._irradiance_texture=aa.objectToCubemap(a.irradiance_info,this._irradiance_texture,this.high_precision),this.assignCubemaps())};
aa.prototype.onRenderReflection=function(a){this.updateTextures()};aa.prototype.updateTextures=function(a,b){if(this._enabled&&this._root&&this._root.scene){var c=this._root.scene;this._root.transform.getGlobalPosition(this._current);e.ResourcesManager.isLoading()||(this.refresh_rate|=0,1>this.refresh_rate&&this._texture&&!b||this._texture&&0!=c._frame%this.refresh_rate&&!b||(this.updateCubemap(this._current,a),this.generate_irradiance&&this.updateIrradiance()))}};aa.prototype.updateCubemap=function(a,
b){b=b||e.Renderer.default_render_settings;var c=this._root.scene;if(c){var d=parseInt(this.texture_size),f=b.layers;b.layers=this.layers;e.Renderer.clearSamplers();var h=gl.TEXTURE_CUBE_MAP,g=this.high_precision?gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE,k=this._texture;k&&k.width==d&&k.height==d&&k.type==g&&k.texture_type==h&&k.minFilter==(this.generate_mipmaps?gl.LINEAR_MIPMAP_LINEAR:gl.LINEAR)||(k=new GL.Texture(d,d,{type:g,texture_type:h,minFilter:this.generate_mipmaps?gl.LINEAR_MIPMAP_LINEAR:
gl.LINEAR}),k.has_mipmaps=this.generate_mipmaps,this._texture=k);a?this._position.set(a):a=this._root.transform.getGlobalPosition(this._position);k._in_current_fbo=!0;e.Renderer._visible_instances||(e.Renderer.processVisibleData(c,b),e.Renderer.regenerateShadowmaps(c,b));h=null;e.GlobalScene.info.textures.irradiance==this._irradiance_texture&&(h=e.GlobalScene.info.textures.irradiance,e.GlobalScene.info.textures.irradiance=null);e.Renderer.renderToCubemap(a,0,k,b,this.near,this.far,this.background_color);
h&&(e.GlobalScene.info.textures.irradiance=h);k._in_current_fbo=!1;this.generate_mipmaps&&isPowerOfTwo(d)&&(k.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR),gl.generateMipmap(k.texture_type),k.unbind());this.texture_name&&e.ResourcesManager.registerResource(this.texture_name,k);e.ResourcesManager.registerResource(this._texid,k);c.info&&(c.info.textures.environment=this._texid);b.layers=f}};aa.prototype.updateIrradiance=function(){if(this._root.scene&&(this._texture||this.updateCubemap(),
this._texture)){var a=this._texture,b=this.high_precision?gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;aa._downscale_cubemap||(aa._downscale_cubemap=new GL.Texture(32,32,{texture_type:gl.TEXTURE_CUBE_MAP,format:gl.RGB,filter:gl.LINEAR}),aa._downscale_cubemap_high=new GL.Texture(32,32,{type:gl.HIGH_PRECISION_FORMAT,texture_type:gl.TEXTURE_CUBE_MAP,format:gl.RGB,filter:gl.LINEAR}));var c=this.high_precision?aa._downscale_cubemap_high:aa._downscale_cubemap;a.copyTo(c);for(var a=GL.Texture.getTemporary(c.width,
c.height,c),d=c,c=a,e=0;8>e;++e){d.applyBlur(e,e,1,c);var h=d,d=c,c=h}c=d;d=this._irradiance_texture;d&&d.type==b||(d=this._irradiance_texture=new GL.Texture(4,4,{type:b,texture_type:gl.TEXTURE_CUBE_MAP,format:gl.RGB,filter:gl.LINEAR}));c.copyTo(d);for(e=0;4>e;++e)d.applyBlur(e,e,1);this.assignCubemaps();GL.Texture.releaseTemporary(a);return d}};aa.prototype.assignCubemaps=function(a){!a&&this._root&&(a=this._root.scene);a||(a=e.GlobalScene);this._texture&&(e.ResourcesManager.registerResource(this._texid,
this._texture),a.info&&(a.info.textures.environment=this._texid));if(this._irradiance_texture){var b=this._texid+"_IR";e.ResourcesManager.registerResource(b,this._irradiance_texture);a.info&&(a.info.textures.irradiance=b)}};aa.prototype.renderProbe=function(a,b){if(this._texture&&this._enabled){e.Draw.push();e.Draw.translate(this._position);e.Draw.scale(aa.helper_size);if(b)e.Draw.setColor(b),e.Draw.renderMesh(e.Renderer._sphere_mesh,GL.TRIANGLES);else{var c=GL.Shader.getCubemapShowShader();a?this._irradiance_texture.bind(0):
this._texture.bind(0);e.Draw.renderMesh(e.Renderer._sphere_mesh,GL.TRIANGLES,c);e.Draw.setColor(e.WHITE);e.Draw.scale(1.1);gl.enable(gl.CULL_FACE);gl.frontFace(gl.CW);e.Draw.renderMesh(e.Renderer._sphere_mesh,GL.TRIANGLES);gl.frontFace(gl.CCW)}e.Draw.pop()}};aa.cubemapToObject=function(a){for(var b=[],c=0;6>c;++c){var d=typedArrayToArray(a.getPixels(c));b.push(d)}return{texture_type:a.texture_type,size:a.width,format:a.format,faces:b}};aa.objectToCubemap=function(a,b,c){c=c?gl.HIGH_PRECISION_FORMAT:
gl.UNSIGNED_BYTE;b||(b=new GL.Texture(a.size,a.size,{type:c,texture_type:gl.TEXTURE_CUBE_MAP,format:GL.RGBA}));for(var d=0;d<a.faces.length;++d){var e;e=c==gl.FLOAT?new Float32Array(a.faces[d]):c==gl.HIGH_PRECISION_FORMAT?new Uint16Array(a.faces[d]):new Uint8Array(a.faces[d]);b.setPixels(e,!0,5==d,d)}return b};aa.visualize_helpers=!0;aa.visualize_irradiance=!1;aa.helper_size=1;e.registerComponent(aa);ea.show_probes=!1;ea.probes_size=1;ea.capture_cubemap_size=64;ea.final_cubemap_size=8;ea.OBJECT_MODE=
1;ea.VERTEX_MODE=2;ea.PIXEL_MODE=3;ea["@mode"]={type:"enum",values:{object:ea.OBJECT_MODE,vertex:ea.VERTEX_MODE,pixel:ea.PIXEL_MODE}};ea["@size"]={type:"vec3",min:0.1,step:0.1,precision:3};ea["@subdivisions"]={type:"vec3",min:1,max:100,step:1,precision:0};ea["@layers"]={widget:"layers"};ea["@background_color"]={type:"color"};ea.prototype.recompute=function(){var a=this.subdivisions,b=this.corner,c=this.size,c=vec3.fromValues(c[0]/a[0],c[1]/a[1],c[2]/a[2]),d=this.high_precision?gl.HIGH_PRECISION_FORMAT:
gl.UNSIGNED_BYTE,f=e.Renderer.default_render_settings,h=f.layers;f.layers=this.layers;e.GlobalScene.info.textures.irradiance=null;var g=ea.final_cubemap_size,k=ea.capture_cubemap_size,d={type:d,texture_type:gl.TEXTURE_CUBE_MAP,format:gl.RGB},m=this._temp_cubemap;m&&m.width==k&&m.height==k&&m.type==d.type||(this._temp_cubemap=new GL.Texture(k,k,d));if(!e.Renderer._visible_instances){k=this._root.scene;if(!k)throw"cannot compute irradiance without scene";e.Renderer.processVisibleData(k,f);e.Renderer.regenerateShadowmaps(k,
f)}this._irradiance_cubemaps.length=this.subdivisions[0]*this.subdivisions[1]*this.subdivisions[2];for(var k=this._root.transform?this._root.transform.getGlobalMatrixRef():null,m=vec3.create(),l=0,n=0;n<a[0];++n)for(var p=0;p<a[1];++p)for(var q=0;q<a[2];++q){m[0]=n*c[0]+b[0];m[1]=p*c[1]+b[1];m[2]=q*c[2]+b[2];k&&mat4.multiplyVec3(m,k,m);var r=this._irradiance_cubemaps[l];r&&r.type==d.type&&r.width==g||(this._irradiance_cubemaps[l]=r=new GL.Texture(g,g,d));this.captureIrradiance(m,r,f);l+=1}f.layers=
h};ea.prototype.captureIrradiance=function(a,b,c){e.Renderer.clearSamplers();e.Renderer.renderToCubemap(a,0,this._temp_cubemap,c,this.near,this.far,this.background_color);this._temp_cubemap.copyTo(b)};ea.prototype.encodeCacheInTexture=function(){};ea.prototype.renderEditor=function(){if(this.enabled&&ea.show_probes){var a=GL.Shader.getCubemapShowShader(),b=e.Renderer._sphere_mesh,c=this.subdivisions,d=this.corner,a=this.size,f=vec3.fromValues(a[0]/c[0],a[1]/c[1],a[2]/c[2]),a=GL.Shader.getCubemapShowShader(),
b=e.Renderer._sphere_mesh,h=ea.default_cubemap;h||(h=ea.default_cubemap=new GL.Texture(1,1,{texture_type:GL.TEXTURE_CUBE_MAP,format:GL.RGB,pixel_data:[255,255,255]}));for(var g=vec3.create(),k=this._root.transform?this._root.transform.getGlobalMatrixRef():null,m=0,l=0;l<c[0];++l)for(var n=0;n<c[1];++n)for(var p=0;p<c[2];++p)g[0]=l*f[0]+d[0],g[1]=n*f[1]+d[1],g[2]=p*f[2]+d[2],k&&mat4.multiplyVec3(g,k,g),e.Draw.push(),e.Draw.translate(g),e.Draw.scale(ea.probes_size),(this._irradiance_cubemaps[m++]||
h).bind(0),e.Draw.renderMesh(b,GL.TRIANGLES,a),e.Draw.pop()}};e.registerComponent(ea);w.secure_module=!1;w.block_execution=!1;w.catch_important_exceptions=!0;w.icon="mini-icon-script.png";w.templates={script:"//@unnamed\n//defined: component, node, scene, transform, globals\nthis.onStart = function()\n{\n}\n\nthis.onUpdate = function(dt)\n{\n\t//node.scene.refresh();\n}"};w["@code"]={type:"script"};w.BIND_TO_COMPONENT=1;w.BIND_TO_NODE=2;w.BIND_TO_SCENE=3;w.BIND_TO_RENDERER=4;w.API_functions={};w.API_events_to_function=
{};w.defineAPIFunction=function(a,b,c,d){c=c||a;b=b||w.BIND_TO_SCENE;b={name:a,target:b,event:c,info:d};w.API_functions[a]=b;w.API_events_to_function[c]=b};w.defineAPIFunction("onStart",w.BIND_TO_SCENE,"start");w.defineAPIFunction("onAwake",w.BIND_TO_SCENE,"awake");w.defineAPIFunction("onFinish",w.BIND_TO_SCENE,"finish");w.defineAPIFunction("onPrefabReady",w.BIND_TO_NODE,"prefabReady");w.defineAPIFunction("onUpdate",w.BIND_TO_SCENE,"update");w.defineAPIFunction("onFixedUpdate",w.BIND_TO_SCENE,"fixedUpdate");
w.defineAPIFunction("onNodeClicked",w.BIND_TO_NODE,"node_clicked");w.defineAPIFunction("onClicked",w.BIND_TO_NODE,"clicked");w.defineAPIFunction("onSceneRender",w.BIND_TO_SCENE,"beforeRender");w.defineAPIFunction("onCollectRenderInstances",w.BIND_TO_NODE,"collectRenderInstances");w.defineAPIFunction("onRender",w.BIND_TO_SCENE,"beforeRenderInstances");w.defineAPIFunction("onAfterRender",w.BIND_TO_SCENE,"afterRenderInstances");w.defineAPIFunction("onAfterSceneRender",w.BIND_TO_SCENE,"afterRender");
w.defineAPIFunction("onRenderHelpers",w.BIND_TO_SCENE,"renderHelpers");w.defineAPIFunction("onRenderGUI",w.BIND_TO_SCENE,"renderGUI");w.defineAPIFunction("onEnableFrameContext",w.BIND_TO_SCENE,"enableFrameContext");w.defineAPIFunction("onShowFrameContext",w.BIND_TO_SCENE,"showFrameContext");w.defineAPIFunction("onMouseDown",w.BIND_TO_SCENE,"mousedown");w.defineAPIFunction("onMouseMove",w.BIND_TO_SCENE,"mousemove");w.defineAPIFunction("onMouseUp",w.BIND_TO_SCENE,"mouseup");w.defineAPIFunction("onMouseWheel",
w.BIND_TO_SCENE,"mousewheel");w.defineAPIFunction("onKeyDown",w.BIND_TO_SCENE,"keydown");w.defineAPIFunction("onKeyUp",w.BIND_TO_SCENE,"keyup");w.defineAPIFunction("onGamepadConnected",w.BIND_TO_SCENE,"gamepadconnected");w.defineAPIFunction("onGamepadDisconnected",w.BIND_TO_SCENE,"gamepaddisconnected");w.defineAPIFunction("onButtonDown",w.BIND_TO_SCENE,"buttondown");w.defineAPIFunction("onButtonUp",w.BIND_TO_SCENE,"buttonup");w.defineAPIFunction("onDragStart",w.BIND_TO_SCENE,"dragstart");w.defineAPIFunction("onFileDrop",
w.BIND_TO_SCENE,"fileDrop");w.defineAPIFunction("onEditorEvent",w.BIND_TO_SCENE,"editorEvent");w.defineAPIFunction("onEditorRender",w.BIND_TO_SCENE,"renderEditor");w.defineAPIFunction("onEditorRenderGUI",w.BIND_TO_SCENE,"renderEditorGUI");w.coding_help="For a complete guide check: <a href='https://github.com/jagenjo/litescene.js/blob/master/guides/scripting.md' target='blank'>Scripting Guide</a>";w.active_scripts={};Object.defineProperty(w.prototype,"context",{set:function(a){console.error("Script: context cannot be assigned")},
get:function(){return this._script?this._script._context:null},enumerable:!1});Object.defineProperty(w.prototype,"name",{set:function(a){console.error("Script: name cannot be assigned, add to the first line //@name")},get:function(){return this._name},enumerable:!1});w.prototype.configure=function(a){a.uid&&(this.uid=a.uid);void 0!==a.enabled&&(this.enabled=a.enabled);void 0!==a.code&&(this.code=a.code);this._root&&this._root.scene&&this.processCode();a.properties&&this.setContextProperties(a.properties)};
w.prototype.serialize=function(){return{object_class:"Script",uid:this.uid,enabled:this.enabled,code:this.code,properties:e.cloneObject(this.getContextProperties())}};w.prototype.getContext=function(){return this._script?this._script._context:null};w.prototype.getCode=function(){return this.code};w.prototype.setCode=function(a,b,c){this.code=a;this._blocked_functions.clear();this.processCode(b,c)};w.prototype.reload=function(){this.processCode()};w.prototype.setBreakpoint=function(a,b){if(this._breakpoints||
b)this._breakpoints||(this._breakpoints={}),b?this._breakpoints[a]=!0:(delete this._breakpoints[a],0==Object.keys(this._breakpoints).length&&(this._breakpoints=null))};w.prototype.hasBreakpoint=function(a){return this._breakpoints?this._breakpoints[a]:!1};w.prototype.processCode=function(a,b){this._blocked_functions.clear();this._script.code=this.code;this._name="";if(this.code){var c=this.code.substr(0,128);if(0==c.indexOf("//@")){var d=c.indexOf("\n");-1==d&&(d=void 0);this._name=c.substr(3,d-3).trim()}}if(!this._root||
e.Script.block_execution)return!0;this._script&&this._script._context&&this._script._context.unbindAll();c=this._stored_properties||this.getContextProperties();d=this._script.compile({component:this,node:this._root,scene:this._root.scene,transform:this._root.transform,globals:e.Globals});a||this.hookEvents();b||this.setContextProperties(c);this._stored_properties=null;if(this._script._context&&!this._script._context._initialized){if(this._root&&this._script._context.onAddedToNode)this._script._context.onAddedToNode(this._root);
if(this._root&&this._root.scene){if(this._script._context.onAddedToScene)this._script._context.onAddedToScene(this._root.scene);if(this._script._context.onBind)this._script._context.onBind(this._root.scene);this._root.scene._state===e.PLAYING&&this._script._context.start&&this._script._context.start()}this._script._context._initialized=!0}this._name&&this._root&&this._root.scene&&(e.Script.active_scripts[this._name]=this);console.log(" + Script: "+this._name+" CTX: ",this._script._context);return d};
w.prototype.getContextProperties=function(){var a=this.getContext();if(a)return this.onSerialize?this.onSerialize():e.cloneObject(a,null,!1,!1,!0)};w.prototype.setContextProperties=function(a){if(a){var b=this.getContext();if(b){if(e.cloneObject(a,b,!1,!0,!0),b.onConfigure)b.onConfigure(a)}else this._stored_properties=a}};w.prototype.setProperty=function(a,b){var c=this.getContext();if(c&&void 0!==c[a])if(c[a].set)c[a](b);else c[a]=b;else this[a]&&(this[a]=b)};w.prototype.getPropertiesInfo=function(){var a=
this.getContext();if(!a)return{enabled:"boolean"};a=e.getObjectProperties(a);a.enabled="boolean";return a};w.prototype.onAction=function(a,b){var c=this.getContext();if(c.onAction)return c.onAction(a,b)};w.prototype.getActions=function(a){var b=this.getContext();if(!b||!b.getActions)return a;if(b=b.getActions())for(var c in b)a[c]=b[c];return a};w.prototype.getEvents=function(){var a=this.getContext();return a&&a.getEvents?a.getEvents():null};w.prototype.getPropertyInfoFromPath=function(a){if("context"==
a[0]){var b=this.getContext();if(1==a.length)return{name:"context",node:this._root,target:b,type:"object",value:b};a=a[1];if(b&&void 0!==b[a]){var c=b[a],d=b["@"+a];d||(d=b.constructor["@"+a]);var e="";d&&(e=d.type);e||null===c||void 0===c||(c.constructor===String?e="string":c.constructor===Boolean?e="boolean":c.length?e="vec"+c.length:c.constructor===Number?e="number":c.constructor===Function&&(e="function"));"function"==e&&(c=a);return{node:this._root,target:b,name:a,value:c,type:e}}}};w.prototype.setPropertyValueFromPath=
function(a,b,c){c=c||0;if(!(a.length<c+1)&&"context"==a[c]){var d=this.getContext();a=a[c+1];if(d&&void 0!==d[a]&&void 0!==d[a]&&(!d[a]||d[a].constructor!=Function))return d[a]&&d[a].set?d[a].set(b):d[a]=b,!0}};w.prototype.hookEvents=function(){var a=this._root;if(!a)throw"hooking events of a Script without a node";var b=a.scene||e.GlobalScene,c=this.getContext();if(c)for(var d in e.Script.API_functions){var f=d,h=e.Script.API_functions[f],g=null;switch(h.target){case w.BIND_TO_COMPONENT:g=this;break;
case w.BIND_TO_NODE:g=a;break;case w.BIND_TO_SCENE:g=b;break;case w.BIND_TO_RENDERER:g=e.Renderer}if(!g)throw"Script event without target?";c[f]&&c[f].constructor===Function?LEvent.isBind(g,h.event,this.onScriptEvent,this)||LEvent.bind(g,h.event,this.onScriptEvent,this):LEvent.unbind(g,h.event,this.onScriptEvent,this)}};w.prototype.onScriptEvent=function(a,b){if(this.enabled){if(!a)throw"Event without type";var c=e.Script.API_events_to_function[a];if(c){var d=!1;this._breakpoints&&this._breakpoints[c.name]&&
(d=!0,this.setBreakpoint(c.name,!1));if(this._blocked_functions.has(c.name))console.warn("Script: blocked function trying to be executed, skipping: "+c.name);else{if(d)debugger;return this._script.callMethod(c.name,b,!1,this)}}}};w.prototype.onAddedToNode=function(a){a.script||(a.script=this)};w.prototype.onRemovedFromNode=function(a){if(this._script._context&&this._script._context.onDestroy)this._script._context.onDestroy();a.script==this&&delete a.script};w.prototype.onAddedToScene=function(a){this._name&&
(e.Script.active_scripts[this._name]=this);if(this._script&&this._script._context&&this._script._context._initialized){if(this._script._context.onBind)this._script._context.onBind()}else if(this.constructor.catch_important_exceptions)try{this.processCode()}catch(b){console.error(b)}else this.processCode()};w.prototype.onRemovedFromScene=function(a){this._name&&e.Script.active_scripts[this._name]==this&&delete e.Script.active_scripts[this._name];LEvent.unbindAll(a,this);if(this._context){LEvent.unbindAll(a,
this._context,this);if(this._script._context.onUnbind)this._script._context.onUnbind(a);if(this._script._context.onRemovedFromScene)this._context.onRemovedFromScene(a)}};w.prototype.getComponentTitle=function(){return this.name};w.prototype.toInfoString=function(){return this._root?e.getObjectClassName(this)+" in node "+this._root.name:e.getObjectClassName(this)};w.prototype.onError=function(a){var b=this._root.scene;b&&(a.script=this,a.node=this._root,console.warn("Script: blocking function on script due to error: "+
a.method_name),this._blocked_functions.add(a.method_name),LEvent.trigger(this,"code_error",a),LEvent.trigger(b,"code_error",a),LEvent.trigger(e,"code_error",a),console.log("app finishing due to error in script, scene state is keep as it was during the error."),b.finish())};w.prototype.onCodeChange=function(a){this.processCode()};w.prototype.getResources=function(a){var b=this.getContext(),c;for(c in b){var d=b[c],f=b.constructor["@"+c];if(d&&f&&(e.RESOURCE_TYPES[f.type]&&(a[d]=!0),f.type==e.TYPES.ARRAY&&
d.length&&f.data_type&&f.data_type.constructor===String&&e.RESOURCE_TYPES[f.data_type.toLowerCase()]))for(f=0;f<d.length;++f)a[d[f]]=!0}if(b&&b.onGetResources)b.onGetResources(a)};w.prototype.onResourceRenamed=function(a,b,c){var d=this.getContext();if(d&&d.onResourceRenamed)d.onResourceRenamed(a,b,c)};e.registerComponent(w);e.Script=w;ra.coding_help=w.coding_help;Object.defineProperty(ra.prototype,"filename",{set:function(a){a&&(a=e.ResourcesManager.cleanFullpath(a));this._filename=a;this.processCode()},
get:function(){return this._filename},enumerable:!0});Object.defineProperty(ra.prototype,"context",{set:function(a){console.error("ScriptFromFile: context cannot be assigned")},get:function(){return this._script?this._script._context:null},enumerable:!1});Object.defineProperty(ra.prototype,"name",{set:function(a){console.error("Script: name cannot be assigned, set the first line with //@name")},get:function(){return this._name},enumerable:!1});ra.prototype.onAddedToScene=function(a){if(this._script&&
this._script._context&&this._script._context._initialized){if(this._script._context.onBind)this._script._context.onBind(a);if(this._script._context.onAddedToScene)this._script._context.onAddedToScene(a)}else if(this.constructor.catch_important_exceptions)try{this.processCode()}catch(b){console.error(b)}else this.processCode()};ra.prototype.reload=function(a){if(this.filename){var b=this;e.ResourcesManager.load(this.filename,null,function(c,d){d==b.filename&&(b.processCode(),a&&a(b))},!0)}};ra.prototype.processCode=
function(a,b,c){var d=this;if(this.filename){var f=e.ResourcesManager.getResource(this.filename);if(f)if(f=f.data,void 0===f)this._name="";else{if(this._script.code!=f){this._name="";if(f){var h=f.substr(0,128);if(0==h.indexOf("//@")){var g=h.indexOf("\n");-1==g&&(g=void 0);this._name=h.substr(3,g-3).trim()}}if(!this._root||e.Script.block_execution)return!0;this._script.code=f;this._script&&this._script._context&&this._script._context.unbindAll();f=this._stored_properties||this.getContextProperties();
h=this._script.compile({component:this,node:this._root,scene:this._root.scene,transform:this._root.transform,globals:e.Globals});a||this.hookEvents();c||this.setContextProperties(f);this._stored_properties=null;if(this._script._context&&!this._script._context._initialized){if(this._root&&this._script._context.onAddedToNode)this._script._context.onAddedToNode(this._root);if(this._root&&this._root.scene){if(this._script._context.onAddedToScene)this._script._context.onAddedToScene(this._root.scene);
if(this._script._context.onBind)this._script._context.onBind(this._root.scene);this._root.scene._state===e.PLAYING&&this._script._context.start&&this._script._context.start()}this._script._context._initialized=!0}this._name&&this._root&&this._root.scene&&(e.Script.active_scripts[this._name]=this);b&&b(this);console.log(" + Script: "+this._name+" CTX: ",this._script._context);return h}}else e.ResourcesManager.load(this.filename,null,function(c,e){e==d.filename&&(d.processCode(a),b&&b(d))})}};ra.prototype.configure=
function(a){a.uid&&(this.uid=a.uid);void 0!==a.enabled&&(this.enabled=a.enabled);void 0!==a.filename&&(this.filename=a.filename);a.properties&&this.setContextProperties(a.properties);this._root&&this._root.scene&&this.processCode()};ra.prototype.serialize=function(){return{object_class:"ScriptFromFile",uid:this.uid,enabled:this.enabled,filename:this.filename,properties:e.cloneObject(this.getContextProperties())}};ra.prototype.onAction=function(a,b){var c=this.getContext();if(c&&c.onAction)return c.onAction(a,
b)};ra.prototype.getActions=w.prototype.getActions();ra.prototype.getEvents=w.prototype.getEvents();ra.prototype.getResources=function(a){this.filename&&(a[this.filename]=e.Resource);var b=this.getContext();b&&b.getResources&&b.getResources(a)};ra.prototype.onResourceRenamed=function(a,b,c){this.filename==a&&(this.filename=b)};ra.prototype.getCodeResource=function(){return e.ResourcesManager.getResource(this.filename)};ra.prototype.getCode=function(){var a=e.ResourcesManager.getResource(this.filename);
return a?a.data:""};ra.prototype.setCode=function(a,b,c){var d=e.ResourcesManager.getResource(this.filename);if(!d)return"";d.data=a;this.processCode(b,null,c)};ra.updateComponents=function(a,b){if(a)for(var c=a.fullpath||a.filename,d=e.GlobalScene.findNodeComponents(e.ScriptFromFile),f=0;f<d.length;++f){var h=d[f];h.filename==c&&h.processCode(b)}};e.extendClass(ra,w);e.registerComponent(ra);e.ScriptFromFile=ra;Object.defineProperty(Ga.prototype,"primitive",{get:function(){return this._primitive},
set:function(a){a=void 0===a||null===a?-1:a|0;if(-1==a||0==a||1==a||4==a||10==a)this._primitive=a},enumerable:!0});Ga.icon="mini-icon-terrain.png";Ga["@subdivisions"]={type:"number",min:1,max:255,step:1,precision:0};Ga["@heightmap"]={type:"texture"};Ga["@action"]={widget:"button",callback:function(){this.options.instance&&this.options.instance.updateMesh()}};Ga["@primitive"]={type:"enum",values:{Default:null,Points:0,Lines:1,Triangles:4,Wireframe:10}};Ga.prototype.onAddedToNode=function(a){LEvent.bind(a,
"collectRenderInstances",this.onCollectInstances,this)};Ga.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this);this._root.mesh==this._mesh&&delete this._root.mesh};Ga.prototype.getResources=function(a){this.heightmap&&(a[this.heightmap]=Texture)};Ga.prototype.onResourceRenamed=function(a,b,c){this.heightmap==a&&(this.heightmap=b)};Ga.prototype.updateMesh=function(){if(this.heightmap){var a=e.ResourcesManager.textures[this.heightmap];if(a){var b=
a.img;if(b){this.subdivisions>b.width&&(this.subdivisions=b.width);this.subdivisions>b.height&&(this.subdivisions=b.height);255<this.subdivisions&&!gl.extensions.OES_element_index_uint&&(this.subdivisions=255);var a=0.5*this.size,c=this.subdivisions<<0,d=this.height,f=createCanvas(c,c),h=f.getContext("2d");h.drawImage(b,0,0,b.width,b.height,0,0,f.width,f.height);var b=h.getImageData(0,0,f.width,f.height).data,f=[],h=[],g=[],k=[],m=[],l,n;n=l=c-1;for(var p,q=a/(c-1),r=0;r<=n;r++)for(var s=r/n,t=0;t<=
l;t++){var K=t/l;p=b[r*c*4+4*t]/255;g.push(a*(2*K-1),p*d,a*(2*s-1));m.push(K,1-s);0==t||0==r||t==l-1||r==n-1?k.push(0,1,0):(p=[-(b[r*c*4+4*(t+1)]/255-b[r*c*4+4*(t-1)]/255)*d,2*q,-(b[(r+1)*c*4+4*t]/255-b[(r-1)*c*4+4*t]/255)*d],vec3.normalize(p,p),k.push(p[0],p[1],p[2]));t<l&&r<n&&(p=t+r*(l+1),f.push(p+1,p,p+l+1),f.push(p+1,p+l+1,p+l+2),h.push(p+1,p,p,p+l+1))}c=new GL.Mesh({vertices:g,normals:k,coords:m},{triangles:f,wireframe:h});c.setBoundingBox([0,0.5*this.height,0],[a,0.5*this.height,a]);this._mesh=
c;this._info=[this.heightmap,this.size,this.height,this.subdivisions,this.smooth]}}}};Ga.PLANE=null;Ga.prototype.onCollectInstances=function(a,b){!this._mesh&&this.heightmap&&this.updateMesh();this.auto_update&&this._info&&(this._info[0]==this.heightmap&&this._info[1]==this.size&&this._info[2]==this.height&&this._info[3]==this.subdivisions&&this._info[4]==this.smooth||this.updateMesh());var c=this._render_instance;c||(this._render_instance=c=new da(this._root,this));if(!this._mesh)return Ga.PLANE||
(Ga.PLANE=GL.Mesh.plane({xz:!0,normals:!0,coords:!0})),c.mesh=Ga.PLANE,c;c.material=this._root.getMaterial();c.setMesh(this._mesh,this.primitive);this._root.mesh=this._mesh;this._root.transform.getGlobalMatrix(c.matrix);mat4.multiplyVec3(c.center,c.matrix,vec3.create());c.flags=RI_DEFAULT_FLAGS;c.applyNodeFlags();b.push(c)};e.registerComponent(Ga);T.GRID_MODE=1;T.RADIAL_MODE=2;T.MESH_MODE=3;T.CHILDREN_MODE=4;T.CUSTOM_MODE=5;T.icon="mini-icon-cloner.png";T["@mesh"]={type:"mesh"};T["@lod_mesh"]={type:"mesh"};
T["@mode"]={type:"enum",values:{Grid:T.GRID_MODE,Radial:T.RADIAL_MODE,Children:T.CHILDREN_MODE,Custom:T.CUSTOM_MODE}};T["@count"]={type:"vec3",min:1,step:1,precision:0};T.prototype.onAddedToScene=function(a){LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this);LEvent.bind(a,"afterCollectData",this.onUpdateInstances,this)};T.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this);LEvent.unbind(a,"afterCollectData",this.onUpdateInstances,
this)};T.prototype.getMesh=function(){return this.mesh&&this.mesh.constructor===String?ub.meshes[this.mesh]:this.mesh};T.prototype.getLODMesh=function(){return this.lod_mesh&&this.lod_mesh.constructor===String?ub.meshes[this.lod_mesh]:this.lod_mesh};T.prototype.getResources=function(a){this.mesh&&this.mesh.constructor===String&&(a[this.mesh]=Mesh);this.lod_mesh&&this.lod_mesh.constructor===String&&(a[this.lod_mesh]=Mesh);return a};T.prototype.onResourceRenamed=function(a,b,c){this.mesh==a&&(this.mesh=
b);this.lod_mesh==a&&(this.lod_mesh=b)};T.generateTransformKey=function(a,b,c){var d=new Float32Array(9);d.set(a);d.set(b,3);d.set(c,6);return d};T.compareKeys=function(a,b){for(var c=0;c<a.length;++c)if(a[c]!=b[c])return!1;return!0};T.prototype.onCollectInstances=function(a,b){if(this.enabled){var c=this.getMesh();if(!c)return null;var d=this._root;if(this._root){this.updateRenderInstancesArray();var e=this._RIs,h=this.material||this._root.getMaterial();if(e){var g=b.length;b.length=g+e.length;for(var k=
0,m=e.length;k<m;++k){var l=e[k];l.setMesh(c);l.layers=d.layers;l.setMaterial(h);b[g+k]=l}}}}};T.prototype.updateRenderInstancesArray=function(){var a=0;this.mode===T.GRID_MODE?a=(this.count[0]|0)*(this.count[1]|0)*(this.count[2]|0):this.mode===T.RADIAL_MODE?a=this.count[0]|0:this.mode===T.MESH_MODE?a=0:this.mode===T.CHILDREN_MODE&&this._root&&this._root._children&&(a=this._root._children.length);if(!a)this._RIs&&(this._RIs.length=0);else if(!this._RIs||this._RIs.length!=a){this._RIs?this._RIs.length=
a:this._RIs=Array(a);for(var b=0;b<a;++b)this._RIs[b]||(this._RIs[b]=new e.RenderInstance(this._root,this))}};T.prototype.onUpdateInstances=function(a,b){if(this.enabled){var c=this._RIs;if(c&&c.length){var d=this._root.transform.getGlobalMatrix(mat4.create()),e=this._count[0]|0,h=this._count[1]|0,g=this._count[2]|0;if(this.mode==T.GRID_MODE){var k=vec3.scale(vec3.create(),this.size,0.5),m=vec3.create();1<e?m[0]=this.size[0]/(e-1):k[0]=0;1<h?m[1]=this.size[1]/(h-1):k[1]=0;1<g?m[2]=this.size[2]/(g-
1):k[2]=0;for(var l=0,n=vec3.create(),p=vec3.create(),q=0;q<e;++q)for(var r=0;r<h;++r)for(var s=0;s<g;++s){var t=c[l];if(!t)return;n[0]=q*m[0]-k[0];n[1]=r*m[1]-k[1];n[2]=s*m[2]-k[2];mat4.translate(t.matrix,d,n);t.setMatrix(t.matrix);mat4.multiplyVec3(t.center,t.matrix,p);++l;t.picking_node=null}}else if(this.mode==T.RADIAL_MODE)for(m=2*Math.PI/c.length,n=vec3.create(),p=vec3.create(),l=0,e=c.length;l<e;++l){t=c[l];if(!t)break;n[0]=Math.sin(m*l)*this.size[0];n[1]=0;n[2]=Math.cos(m*l)*this.size[0];
t.matrix.set(d);mat4.translate(t.matrix,t.matrix,n);mat4.rotateY(t.matrix,t.matrix,m*l);t.setMatrix(t.matrix);mat4.multiplyVec3(t.center,t.matrix,p);t.picking_node=null}else if(this.mode==T.CHILDREN_MODE&&this._root&&this._root._children)for(l=0,e=c.length;l<e;++l){t=c[l];if(!t)break;if(m=this._root._children[l])m.transform&&m.transform.getGlobalMatrix(d),t.setMatrix(d),t.picking_node=m}}}};e.registerComponent(T);Va.icon="mini-icon-graph.png";Va.rift_server_url="http://tamats.com/uploads/RiftServer_0_3.zip";
Va.prototype.onAddedToNode=function(a){var b=a.scene;LEvent.bind(b,"start",this.onStart,this);LEvent.bind(b,"finish",this.onStop,this);LEvent.bind(b,"beforeRender",this.onBeforeRender,this);LEvent.bind(b,"afterRender",this.onAfterRender,this);LEvent.bind(a,"collectCameras",this.onCollectCameras,this)};Va.prototype.onRemovedFromNode=function(a){var b=this._root.scene;LEvent.unbind(b,"start",this.onStart,this);LEvent.unbind(b,"finish",this.onStop,this);LEvent.unbind(b,"beforeRender",this.onBeforeRender,
this);LEvent.unbind(b,"afterRender",this.onAfterRender,this);LEvent.unbind(a,"collectCameras",this.onCollectCameras,this);Mb.color_rendertarget=null};Va.prototype.onCollectCameras=function(a,b){var c=Mb.main_camera;this._orientation&&c.setOrientation(this._orientation,!0);var d=c.getLocalVector([0.5*this.eye_distance,0,0]),f=vec3.scale(vec3.create(),d,-1);this._left_camera||(this._left_camera=new e.Camera,this._right_camera=new e.Camera);var h=c.serialize();this._left_camera.configure(h);this._right_camera.configure(h);
this._left_camera.eye=vec3.add(vec3.create(),c.eye,f);this._right_camera.eye=vec3.add(vec3.create(),c.eye,d);this._left_camera._viewport.set([0,0,0.5,1]);this._right_camera._viewport.set([0.5,0,0.5,1]);this._right_camera._ignore_clear=!0;b.push(this._left_camera,this._right_camera)};Va.prototype.onStart=function(a){a=new WebSocket("ws://localhost:1981");a.onopen=function(){console.log("VR connection stablished")};a.onmessage=this.onMessage.bind(this);a.onclose=function(){console.log("OVR connection lost")};
a.onerror=function(){console.error("Oculus Server not found in your machine. To run an app using Oculus Rift you need to use a client side app, you can download it from: "+OculusController.rift_server_url)};this._ws=a};Va.prototype.onMessage=function(a){var b=a.data,b=JSON.parse("["+b+"]");a=quat.create();a.set(b);b=quat.fromValues(-1,0,0,0);quat.multiply(a,b,a);this._orientation=a;this._root.scene&&this._root.scene.requestFrame()};Va.prototype.onStop=function(a){this._ws&&(this._ws.close(),this._ws=
null)};Va.prototype.onBeforeRender=function(a,b){var c=1024,d=512,c=v[2],d=v[3];this._color_texture&&this._color_texture.width==c&&this._color_texture.height==d||(this._color_texture=new GL.Texture(c,d,{format:gl.RGB,filter:gl.LINEAR}),e.ResourcesManager.textures[":vr_color_buffer"]=this._color_texture);e.Renderer.color_rendertarget=this.enabled?this._color_texture:null};Va.prototype.onAfterRender=function(a,b){this._color_texture&&this._color_texture.toViewport()};Sa.icon="mini-icon-clock.png";Sa.prototype.onAddedToScene=
function(a){};Sa.prototype.onRemovedFromScene=function(a){};Sa.prototype.addBaseNode=function(a){for(var b=null,c=a.uid,d=0;d<this.base_nodes.length;++d){var e=this.base_nodes[d];if(e.node_uid==c){b=e;break}}b||(b={node_uid:c,data:Array(10)},this.base_nodes.push(b));a.transform&&(b.data=a.transform.data)};Sa.prototype.removeBaseNode=function(a){if(a)if(a.constructor===String&&(a=this._root.scene.getNode(a)),a)for(var b=0;b<this.base_nodes.length;++b){if(this.base_nodes[b].node_uid==a.uid){this.base_nodes.splice(b,
1);this.purgePoses();break}}else console.warn("Node not found")};Sa.prototype.setChildrenAsBaseNodes=function(a){this.base_nodes.length=0;a&&this.addBaseNode(this._root);a=this._root.getDescendants();for(var b=0;b<a.length;++b)this.addBaseNode(a[b])};Sa.prototype.addPose=function(a){this.poses[a]={name:a,nodes:[]};this.updatePose(a)};Sa.prototype.removePose=function(a){delete this.poses[a]};Sa.prototype.updatePose=function(a){if(this._root&&this._root.scene){var b=this.poses[a];if(!b)return null;
for(var c=this._root.scene,d=b.nodes.length=0;d<this.base_nodes.length;++d){var e=c.getNode(this.base_nodes[d].node_uid);e?(e={node_uid:e.uid,data:Array.apply([],e.transform.data)},b.nodes.push(e)):console.warn("addPose error, node not found in scene")}return this.poses[a]=b}};Sa.prototype.applyPose=function(a,b){if(a&&this._root&&this._root.scene&&(void 0===b&&(b=1),!(0>=b))){var c=this.poses[a];if(!c)return null;var d=this._root.scene;if(d){for(var e=0;e<c.nodes.length;++e){var h=c.nodes[e],g=d.getNode(h.node_uid);
if(g&&g.transform)if(1<=b)g.transform.data=h.data;else{var k=g.transform,h=h.data;vec3.lerp(k._position,k._position,h,b);vec3.lerp(k._scaling,k._scaling,h.subarray(7,10),b);quat.slerp(k._rotation,k._rotation,h.subarray(3,7),b);g.transform._must_update=!0}}return this.poses[a]=c}}};Sa.prototype.purgePoses=function(){var a={},b=this._root.scene;if(b){for(var c=0;c<this.base_nodes.length;++c){var d=b.getNode(this.base_nodes[c].node_uid);d&&(a[d.uid]=!0)}for(c in this.poses)for(b=this.poses[c].nodes,
d=0;d<b.length;++d)a[b[d].node_uid]||(b.splice(d,1),d--)}};e.registerComponent(Sa);Object.defineProperty(cb.prototype,"render_in_viewport",{get:function(){return this._render_in_viewport},set:function(a){this._render_in_viewport!=a&&(this._render_in_viewport=a,this._root&&this._root.scene&&(a?LEvent.bind(this._root.scene,"collectRenderInstances",this.onCollectInstances,this):LEvent.unbind(this._root.scene,"collectRenderInstances",this.onCollectInstances,this)))},enumerable:!0});Object.defineProperty(cb.prototype,
"type",{get:function(){return this.path.type},set:function(a){this.path.type=a;this._must_update=!0},enumerable:!0});cb["@type"]={type:"enum",values:{line:e.Path.LINE,spline:e.Path.SPLINE,bezier:e.Path.BEZIER}};cb.prototype.onAddedToScene=function(a){this._render_in_viewport&&LEvent.bind(this._root.scene,"collectRenderInstances",this.onCollectInstances,this)};cb.prototype.onRemovedFromScene=function(a){this._render_in_viewport&&LEvent.unbind(this._root.scene,"collectRenderInstances",this.onCollectInstances,
this)};cb.prototype.onCollectInstances=function(a,b){if(this.enabled&&this._root&&0!=this.path.getSegments()){this._mesh&&!this._must_update||this.updateMesh();var c=this._render_instance;c||(this._render_instance=c=new e.RenderInstance(this._root,this));this._root.transform&&this._root.transform.getGlobalMatrix(c.matrix);c.setMatrix(c.matrix);mat4.getTranslation(c.center,c.matrix);c.setMesh(this._mesh,gl.LINE_STRIP);c.setRange(0,this._range);c.flags=RI_DEFAULT_FLAGS;c.applyNodeFlags();c.setMaterial(this.material||
this._root.getMaterial());b.push(c)}};cb.prototype.updateMesh=function(){this._mesh||(this._mesh=GL.Mesh.load({vertices:new Float32Array(3*this._max_points)}));var a=this._mesh.getVertexBuffer("vertices"),b=a.data,c=0,c=this.path.type==e.Path.LINE?this.path.getSegments()+1:10*this.path.getSegments();c>this._max_points&&(c=this._max_points);this.path.samplePointsTyped(c,b);a.upload(gl.STREAM_TYPE);this._range=c;this._must_update=!1};cb.prototype.addPoint=function(a){this.path.addPoint(a);this._must_update=
!0};Ka.prototype.setupContext=function(){this._engine||("undefined"==typeof THREE?console.error("ThreeJS library not loaded"):THREE.Scene?(this._engine={component:this,node:this._root,scene:new THREE.Scene,camera:new THREE.PerspectiveCamera(70,gl.canvas.width/gl.canvas.height,1,1E3),renderer:new THREE.WebGLRenderer({canvas:gl.canvas,context:gl}),root:new THREE.Object3D,ThreeJS:this.constructor},this._engine.scene.add(this._engine.root)):console.error("ThreeJS error parsing library"))};Ka.default_code=
"//renderer, camera, scene, already created, they are globals.\n//use root as your base Object3D node if you want to use the scene manipulators.\n\nthis.start = function() {\n}\n\nthis.render = function(){\n}\n\nthis.update = function(dt){\n}\n";Ka.library_url="http://threejs.org/build/three.js";Object.defineProperty(Ka.prototype,"code",{set:function(a){this._code=a;this.processCode()},get:function(){return this._code},enumerable:!0});Ka["@code"]={widget:"code",allow_inline:!1};Ka.prototype.onAddedToScene=
function(a){LEvent.bind(e.Renderer,"renderInstances",this.onEvent,this);LEvent.bind(a,"start",this.onEvent,this);LEvent.bind(a,"update",this.onEvent,this);LEvent.bind(a,"finish",this.onEvent,this);this.processCode()};Ka.prototype.clearScene=function(){if(this._engine){for(var a=this._engine.root,b=a.children.length-1;0<=b;b--)a.remove(a.children[b]);a=this._engine.scene;for(b=a.children.length-1;0<=b;b--)a.children[b]!=this._engine.root&&a.remove(a.children[b])}};Ka.prototype.onRemovedFromScene=function(a){LEvent.unbind(e.Renderer,
"renderInstances",this.onEvent,this);LEvent.unbindAll(a,this);this.autoclear&&this.clearScene()};Ka.prototype.onEvent=function(a,b){if(this.enabled&&this._engine){var c=this._engine;if("start"==a)this.autoclear&&this.clearScene(),this._script&&this._script.callMethod("start");else if("renderInstances"==a){var d=e.Renderer._current_camera;c.camera.fov=d.fov;c.camera.aspect=d._final_aspect;c.camera.near=d.near;c.camera.far=d.far;c.camera.updateProjectionMatrix();c.camera.position.fromArray(d._global_eye);
c.camera.lookAt(new THREE.Vector3(d._global_center[0],d._global_center[1],d._global_center[2]));Ka.copyTransform(this._root,c.root);c.renderer.setSize(gl.viewport_data[2],gl.viewport_data[3]);c.renderer.resetGLState?c.renderer.resetGLState():c.renderer.state.reset&&c.renderer.state.reset();this._script?this._script.callMethod("render"):c.renderer.render(c.scene,c.camera)}else"update"==a?this._script?this._script.callMethod("update",b):c.scene.update(b):"finish"==a&&this._script&&this._script.callMethod("finish")}};
Ka.copyTransform=function(a,b){if(a.constructor===e.SceneNode){var c=vec3.create();a.transform&&a.transform.getGlobalPosition(c);b.position.set(c[0],c[1],c[2]);c=quat.create();a.transform&&a.transform.getGlobalRotation(c);b.quaternion.set(c[0],c[1],c[2],c[3]);c=vec3.fromValues(1,1,1);a.transform&&a.transform.getGlobalScale(c);b.scale.set(c[0],c[1],c[2])}a.constructor===e.Transform?(c=vec3.create(),a.getGlobalPosition(c),b.position.set(c[0],c[1],c[2]),c=quat.create(),a.getGlobalRotation(c),b.quaternion.set(c[0],
c[1],c[2],c[3]),c=vec3.fromValues(1,1,1),a.getGlobalScale(c),b.scale.set(c[0],c[1],c[2])):b.constructor==e.Transform?b.fromMatrix(a.matrixWorld):b.constructor==e.SceneNode&&b.transform&&b.transform.fromMatrix(a.matrixWorld)};Ka.prototype.loadLibrary=function(a){if("undefined"!==typeof THREE)a&&a.call(this);else if(this._loading)LEvent.bind(this,"threejs_loaded",a,this);else if(this._loaded)a&&a.call(this);else{this._loading=!0;var b=this;e.Network.requestScript(Ka.library_url,function(){console.log("ThreeJS library loaded");
b._loading=!1;b._loaded=!0;LEvent.trigger(b,"threejs_loaded");LEvent.unbindAllEvent(b,"threejs_loaded");b._engine||b.setupContext()})}};Ka.prototype.processCode=function(a){if(this._script&&this._root&&this._root.scene)if(this._script.code=this.code,"undefined"==typeof THREE)this.loadLibrary(function(){this.processCode()});else return this._engine||this.setupContext(),this._root&&!e.Script.block_execution?this._script.compile(this._engine,!0):!0};e.registerComponent(Ka);ga.icon="mini-icon-brush.png";
ga.MODE_CANVAS2D=1;ga.MODE_WEBGL=2;ga.MODE_IMMEDIATE=3;ga["@mode"]={type:"enum",values:{Canvas2D:ga.MODE_CANVAS2D,WebGL:ga.MODE_WEBGL}};ga["@width"]={type:"number",step:1,precision:0};ga["@height"]={type:"number",step:1,precision:0};ga["@texture_name"]={type:"string"};Object.defineProperty(ga.prototype,"texture",{set:function(){throw"Canvas3D texture cannot be set manually";},get:function(){return this._texture},enumerable:!1});ga.prototype.onAddedToScene=function(a){LEvent.bind(a,"readyToRender",
this.onRender,this)};ga.prototype.onRemovedFromScene=function(a){LEvent.unbind(a,"readyToRender",this.onRender,this)};ga.prototype.onAddedToNode=function(a){this.texture_name||(this.texture_name=":canvas3D");LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,this)};ga.prototype.onRemovedFromNode=function(a){LEvent.unbind(a,"collectRenderInstances",this.onCollectInstances,this)};ga.prototype.onRender=function(){if(this.enabled){var a=this.width|0,b=this.height|0;this.mode==ga.MODE_CANVAS2D&&
(this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.width!=a&&(this._canvas.width=a),this._canvas.height!=b&&(this._canvas.height=b));this.mode==ga.MODE_IMMEDIATE||this._texture&&this._texture.width==a&&this._texture.height==b||(this._texture=new GL.Texture(a,b,{format:GL.RGBA,filter:GL.LINEAR,wrap:GL.CLAMP_TO_EDGE}));this.visible&&this.projectMouse();if(this.mode==ga.MODE_CANVAS2D){var c=this._canvas.getContext("2d");this._clear_buffer&&c.clearRect(0,0,this._canvas.width,
this._canvas.height);e.GUI._ctx=c;this._root.processActionInComponents("onRenderCanvas",[c,this._canvas,this._mouse,this]);e.GUI._ctx=gl;this._texture.uploadImage(this._canvas)}else if(this.mode==ga.MODE_WEBGL)c=gl,this._fbo||(this._fbo=new GL.FBO),this._fbo.setTextures([this._texture]),this._fbo.bind(),gl.start2D(),this._clear_buffer&&(gl.clearColor(0,0,0,0),gl.clear(GL.COLOR_BUFFER_BIT)),e.GUI._ctx=gl,this._root.processActionInComponents("onRenderCanvas",[c,this._texture,this._mouse,this]),gl.finish2D(),
this._fbo.unbind();else return;this._texture&&(this.generate_mipmaps&&isPowerOfTwo(a)&&isPowerOfTwo(b)?(this._texture.setParameter(GL.TEXTURE_MIN_FILTER,GL.LINEAR_MIPMAP_LINEAR),gl.generateMipmap(gl.TEXTURE_2D)):this._texture.setParameter(GL.TEXTURE_MIN_FILTER,GL.LINEAR),e.RM.registerResource(this.texture_name||":canvas3D",this._texture));this._prev_mouse&&(e.Input.Mouse=this._prev_mouse,this._prev_mouse=null);e.Input.current_click&&this._prev_click_mouse&&(e.Input.current_click=this._prev_click_mouse,
this._prev_click_mouse=null)}};ga.prototype.onCollectInstances=function(a,b){if(this.enabled&&this.visible&&this._texture){this._RI||(this._RI=new e.RenderInstance);var c=this._RI,d=null;this.use_node_material&&(d=this._root.getMaterial());d||(d=this._standard_material);d||(d=this._standard_material=new e.MaterialClasses.StandardMaterial({flags:{ignore_lights:!0,cast_shadows:!1},blend_mode:e.Blend.ALPHA}));d.setTexture("color",this.texture_name||":canvas3D");c.fromNode(this._root);c.setMaterial(d);
this._mesh||(this._mesh=GL.Mesh.plane());c.setMesh(this._mesh);b.push(c);return b}};ga.prototype.clear=function(a){this.mode==ga.MODE_CANVAS2D?this._canvas.getContext("2d").clearRect(0,0,this._canvas.width,this._canvas.height):this.mode==ga.MODE_WEBGL&&this._texture&&this._texture.fill([0,0,0,0]);if(a)this.onRender()};ga.prototype.projectMouse=function(){var a=e.Renderer._main_camera;if(a)if(this.root.transform){this._is_mouse_inside=!1;var b=e.Input.Mouse.x,c=e.Input.Mouse.y,d=this.width|0,f=this.height|
0;if(this.input_active){if(this._mouse[0]=-1,this._mouse[1]=-1,b=a.getRayInPixel(b,c),a.getFront(),a=vec3.create(),c=this.root.transform.localVectorToGlobal(e.FRONT,a),!this._skip_backside||0<vec3.dot(b.direction,c))a=this.root.transform.globalToLocal(b.origin,a),b=this.root.transform.globalVectorToLocal(b.direction),geo.testRayPlane(a,b,e.ZEROS,e.FRONT,this._mouse)&&(this._mouse[0]=(this._mouse[0]+0.5)*d,this._mouse[1]=f-(this._mouse[1]+0.5)*f)}else this._mouse[0]=-1,this._mouse[1]=-1;0<=this._mouse[0]&&
this._mouse[0]<d&&0<=this._mouse[1]&&this._mouse[1]<f&&(this._is_mouse_inside=!0);this._local_mouse.mousex=this._mouse[0];this._local_mouse.mousey=this._mouse[1];this._prev_mouse=e.Input.Mouse;e.Input.Mouse=this._local_mouse;e.Input.current_click&&(this._local_mouse_click.mousex=this._mouse[0],this._local_mouse_click.mousey=this._mouse[1],this._prev_click_mouse=e.Input.current_click,e.Input.current_click=this._local_mouse_click)}else this._mouse[0]=e.Input.Mouse.x,this._mouse[1]=e.Input.Mouse.y,this._is_mouse_inside=
!0};e.registerComponent(ga);Object.defineProperty(S.prototype,"enabled",{set:function(a){(this._enabled=a)?(a=this._root?this._root.scene:null)&&a.state===e.RUNNING&&this._video.autoplay&&(this._video.currentTime>=this._video.duration&&(this._video.currentTime=0),this._video.play()):this._video.pause()},get:function(){return this._enabled},enumerable:!0});Object.defineProperty(S.prototype,"ignore_proxy",{set:function(a){a!=this._ignore_proxy&&(this._ignore_proxy=a,this.load(this.src))},get:function(){return this._ignore_proxy},
enumerable:!0});Object.defineProperty(S.prototype,"src",{set:function(a){a!=this._src&&(this._src=a,this.load(this._src))},get:function(){return this._src},enumerable:!0});Object.defineProperty(S.prototype,"time",{set:function(a){this._video.currentTime=time},get:function(){return this._video.currentTime},enumerable:!1});Object.defineProperty(S.prototype,"texture",{set:function(a){throw"videoPlayer texture cannot be set";},get:function(){return this._texture},enumerable:!1});Object.defineProperty(S.prototype,
"autoplay",{set:function(a){this._autoplay=a},get:function(){return this._autoplay},enumerable:!0});Object.defineProperty(S.prototype,"muted",{set:function(a){this._video.muted=a},get:function(){return this._video.muted},enumerable:!0});Object.defineProperty(S.prototype,"duration",{set:function(a){throw"VideoPlayer duration cannot be assigned, is read-only";},get:function(){return this._video.duration},enumerable:!1});Object.defineProperty(S.prototype,"playback_rate",{set:function(a){0>a||(this._playback_rate=
a,this._video.playbackRate=a)},get:function(){return this._playback_rate},enumerable:!0});Object.defineProperty(S.prototype,"video",{set:function(a){if(!a||a.constructor!==HTMLVideoElement)throw"Video must a HTMLVideoElement";a!=this._video&&(this._video=a,this._video.muted=!1,this._video.autoplay=!1,this._video.playbackRate=this._playback_rate,this.bindVideoEvents(this._video))},get:function(){return this._video},enumerable:!1});S.NONE=0;S.PLANE=1;S.TO_MATERIAL=2;S.BACKGROUND=5;S.BACKGROUND_STRETCH=
6;S["@src"]={type:"resource"};S["@render_mode"]={type:"enum",values:{NONE:S.NONE,PLANE:S.PLANE,TO_MATERIAL:S.TO_MATERIAL,BACKGROUND_STRETCH:S.BACKGROUND_STRETCH}};S.prototype.onAddedToScene=function(a){LEvent.bind(a,"start",this.onStart,this);LEvent.bind(a,"pause",this.onPause,this);LEvent.bind(a,"unpause",this.onUnpause,this);LEvent.bind(a,"beforeRender",this.onBeforeRender,this);LEvent.bind(a,"beforeRenderScene",this.onBeforeRenderScene,this);LEvent.bind(a,"collectRenderInstances",this.onCollectInstances,
this);LEvent.bind(a,"finish",this.onFinish,this)};S.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,this)};S.prototype.onStart=function(){this.autoplay&&this.play()};S.prototype.onPause=function(){this.pause()};S.prototype.onUnpause=function(){this.autoplay&&this.play()};S.prototype.onFinish=function(){this.stop()};S.prototype.load=function(a,b){if(a){var c=e.RM.getFullURL(a,{ignore_proxy:this.ignore_proxy});if(this._url_loading!=c||b)this._url_loading=a,this._video.crossOrigin="anonymous",
this._video.src=c}};S.prototype.bindVideoEvents=function(a){a._component=this;a.has_litescene_events||(a.has_litescene_events=!0,this._video.addEventListener("loadedmetadata",function(a){console.log("Duration: "+this.duration+" seconds");console.log("Size: "+this.videoWidth+","+this.videoHeight);this.width=this.videoWidth;this.height=this.videoHeight;this._component&&(a=this._component._root?this._component._root.scene:null)&&a.state===e.RUNNING&&this._component._autoplay&&this._component.play()}),
this._video.addEventListener("error",function(a){console.error("Error loading video: "+this.src);if(this.error)switch(this.error.code){case this.error.MEDIA_ERR_ABORTED:console.error("You stopped the video.");break;case this.error.MEDIA_ERR_NETWORK:console.error("Network error - please try again later.");break;case this.error.MEDIA_ERR_DECODE:console.error("Video is broken..");break;case this.error.MEDIA_ERR_SRC_NOT_SUPPORTED:console.error("Sorry, your browser can't play this video.")}}),this._video.addEventListener("ended",
function(a){this._component&&(console.log("Ended."),(a=this._component._root?this._component._root.scene:null)&&a.state===e.RUNNING&&this._component._autoplay&&(this.currentTime=0,this._component.play()))}))};S.prototype.play=function(){this._video.videoWidth&&this._video.play()};S.prototype.playPause=function(){this._video.paused?this.play():this.pause()};S.prototype.stop=function(){this._video.pause();this._video.currentTime=0};S.prototype.pause=function(){this._video.pause()};S.prototype.onBeforeRender=
function(a){if(this.enabled&&0!=this._video.videoWidth){a=this._video;var b=this.generate_mipmaps;GL.isPowerOfTwo(a.videoWidth)&&GL.isPowerOfTwo(a.videoHeight)||(b=!1);this._texture&&this._texture.width==a.videoWidth&&this._texture.has_mipmaps==b||(this._texture=new GL.Texture(a.videoWidth,a.videoHeight,{format:GL.RGB,minFilter:b?gl.LINEAR_MIPMAP_LINEAR:gl.LINEAR,magFilter:gl.LINEAR}),this._texture.has_mipmaps=b);this._texture._video_time!=a.currentTime&&(this._texture.uploadImage(a),b&&(this._texture.bind(0),
gl.generateMipmap(this._texture.texture_type),this._texture.unbind(0)),this._texture._video_time=a.currentTime);this.texture_name&&e.RM.registerResource(this.texture_name,this._texture);this.render_mode==S.TO_MATERIAL&&(a=this._root.getMaterial())&&a.setTexture("color",this.texture_name)}};S.prototype.onBeforeRenderScene=function(a){this.enabled&&(this.render_mode==S.BACKGROUND||this.render_mode==S.BACKGROUND_STRETCH)&&this._texture&&(gl.disable(gl.BLEND),gl.disable(gl.CULL_FACE),gl.disable(gl.DEPTH_TEST),
this._texture.toViewport())};S.prototype.onCollectInstances=function(a,b){if(this.enabled&&this.render_mode==S.PLANE){this._material||(this._material=new e.StandardMaterial({flags:{ignore_lights:!0,two_sided:!0}}));if(!this._plane_ri){var c=this._plane_ri=new e.RenderInstance,d=GL.Mesh.plane();c.setMesh(d);c.setMaterial(this._material)}this._plane_ri.fromNode(this._root);this._material.setTexture("color",this._texture);b.push(this._plane_ri)}};e.registerComponent(S);ta.icon="mini-icon-cursor.png";
ta.PICKING=1;ta.BOUNDING=2;ta.COLLIDERS=3;ta.RENDER_INSTANCES=4;ta["@mode"]={type:"enum",values:{Picking:ta.PICKING,Bounding:ta.BOUNDING,Colliders:ta.COLLIDERS}};ta["@layers"]={type:"layers"};ta.prototype.onAddedToScene=function(a){LEvent.bind(a,"mousedown",this._onMouse,this);LEvent.bind(a,"mousemove",this._onMouse,this);LEvent.bind(a,"mouseup",this._onMouse,this)};ta.prototype.onRemovedFromScene=function(a){LEvent.unbindAll(a,this)};ta.prototype.getNodeUnderMouse=function(a){var b=this.layers;if(this.mode==
ta.PICKING)return e.Picking.getNodeAtCanvasPosition(a.canvasx,a.canvasy,null,b);var c=e.Renderer.getCameraAtPosition(a.canvasx,a.canvasy);if(!c)return null;a=c.getRayInPixel(a.canvasx,a.canvasy);if(this.mode==ta.BOUNDING){b=e.Physics.raycastRenderInstances(a.origin,a.direction,{layers:b});if(!b||!b.length)return null;this._last_collision=b[0];return b[0].node}if(this.mode==ta.RENDER_INSTANCES){b=e.Physics.raycastRenderInstances(a.origin,a.direction,{layers:b,triangle_collision:!0});if(!b||!b.length)return null;
this._last_collision=b[0];return b[0].node}if(this.mode==ta.COLLIDERS){b=e.Physics.raycast(a.origin,a.direction,{layers:b});if(!b||!b.length)return null;this._last_collision=b[0];return b[0].node}return null};ta.prototype._onMouse=function(a,b){if(this.enabled){if(("mousedown"==b.eventType||"mousewheel"==b.eventType)&&(this._clicked_node=this.getNodeUnderMouse(b))&&"mousedown"==b.eventType&&0==b.button&&(console.log("Node clicked: "+this._clicked_node.name),LEvent.trigger(this._clicked_node,"clicked",
this._clicked_node),LEvent.trigger(this._root,"node_clicked",this._clicked_node),LEvent.trigger(this._root.scene,"node_clicked",this._clicked_node),this.onNodeClicked))this.onNodeClicked(this._clicked_node);this._clicked_node&&(b.scene_node=this._clicked_node,LEvent.trigger(this._clicked_node,b.eventType,b));"mouseup"==b.eventType&&(this._clicked_node=null);if(this._clicked_node)return!0}};e.registerComponent(ta);Object.defineProperty(E.prototype,"root",{enumerable:!0,get:function(){return this._root},
set:function(a){throw"Root node cannot be replaced";}});Object.defineProperty(E.prototype,"time",{enumerable:!0,get:function(){return this._time},set:function(a){throw"Cannot set time directly";}});Object.defineProperty(E.prototype,"state",{enumerable:!0,get:function(){return this._state},set:function(a){throw"Cannot set state directly, use start, finish, pause, unpause";}});Object.defineProperty(E.prototype,"globalTime",{enumerable:!0,get:function(){return this._global_time},set:function(a){throw"Cannot set global_time directly";
}});Object.defineProperty(E.prototype,"frame",{enumerable:!0,get:function(){return this._frame},set:function(a){throw"Cannot set frame directly";}});E.supported_events="start update finish clear beforeReload change afterRender configure nodeAdded nodeChangeParent nodeComponentRemoved reload renderPicking scene_loaded serialize".split(" ");E.prototype.init=function(){this.id="";this.external_repository=null;this.global_scripts=[];this.external_scripts=[];this.preloaded_resources={};this.texture_atlas=
null;this._root.removeAllComponents();this._root.uid=e.generateUId("NODE-");this._nodes=[this._root];this._nodes_by_name={root:this._root};this._nodes_by_uid={};this._nodes_by_uid[this._root.uid]=this._root;this._components_by_uid={};this._spatial_container.clear();this.info=new e.Components.GlobalInfo;this._root.addComponent(this.info);this._root.addComponent(new e.Camera({eye:[0,100,100],center:[0,0,0]}));this._root.addComponent(new e.Light({position:vec3.fromValues(100,100,100),target:vec3.fromValues(0,
0,0)}));this._frame=0;this._last_collect_frame=-1;this._state=e.STOPPED;this._start_time=this._global_time=this._time=0;this._last_dt=1/60;this._must_redraw=!0;this._fixed_update_timestep=1/60;this._remaining_fixed_update_time=0;this.selected_node&&delete this.selected_node;this.layer_names=["main","secondary"];this.animation=null;this._local_resources={};this.extra={};this._renderer=e.Renderer};E.prototype.clear=function(){for(;this._root._children&&this._root._children.length;)this._root.removeChild(this._root._children[0],
!1,!0);this._root.processActionInComponents("onRemovedFromNode",this);this._root.processActionInComponents("onRemovedFromScene",this);this.init();LEvent.trigger(this,"clear");LEvent.trigger(this,"change")};E.prototype.configure=function(a){if(!a||a.constructor===String)throw"Scene configure requires object";LEvent.trigger(this,"preConfigure",a);this._root.removeAllComponents();a.uid&&(this.uid=a.uid);"Scene"!=(a.object_class||a.object_type)&&console.warn("Warning: object set to scene doesnt look like a propper one.",
a);a.external_repository&&(this.external_repository=a.external_repository);a.extra&&(this.extra=a.extra);a.root&&(this._spatial_container.clear(),this._root.configure(a.root));a.global_scripts&&(this.global_scripts=a.global_scripts.concat());a.external_scripts&&(this.external_scripts=a.external_scripts.concat());a.preloaded_resources&&(this.preloaded_resources=e.cloneObject(a.preloaded_resources));a.layer_names&&(this.layer_names=a.layer_names.concat());a.animation&&(this.animation=new e.Animation(a.animation));
a.editor&&(this._editor=a.editor);a.texture_atlas&&(this.texture_atlas=a.texture_atlas);LEvent.trigger(this,"configure",a);LEvent.trigger(this,"awake");LEvent.trigger(this,"change")};E.prototype.serialize=function(a){var b={};b.uid=this.uid;b.object_class=e.getObjectClassName(this);b.external_repository=this.external_repository;b.extra=this.extra||{};b.root=this.root.serialize(!1,a);this.animation&&(b.animation=this.animation.serialize());b.layer_names=this.layer_names.concat();b.global_scripts=this.global_scripts.concat();
b.external_scripts=this.external_scripts.concat();b.preloaded_resources=e.cloneObject(this.preloaded_resources);b.texture_atlas=e.cloneObject(this.texture_atlas);this._editor&&(b.editor=this._editor);LEvent.trigger(this,"serialize",b);return b};E.prototype.setFromJSON=function(a,b,c,d,f,h){function g(a){h&&h(n,a);n.init();n.configure(a);n.texture_atlas?e.RM.loadTextureAtlas(n.texture_atlas,k):k()}function k(){n.loadResources(m);LEvent.trigger(n,"load");e.ResourcesManager.isLoading()||m();b&&b(n)}
function m(){f&&f(n);LEvent.trigger(n,"loadCompleted")}function l(a,b){console.error("Error loading script: "+b);c&&c(a)}if(a){var n=this;if(a.constructor===String)try{a=JSON.parse(a)}catch(p){console.log("Error: "+p);return}d=e.Scene.getScriptsList(a,!0);d.length?this.loadScripts(d,function(){g(a)},l):g(a)}};E.prototype.load=function(a,b,c,d,f,h){function g(b){e.ResourcesManager.processResource(a,b,null,k)}function k(a,b){if(b)if("Scene"==b.object_class)m(b);else if("SceneNode"==b.object_class){var c=
b.serialize();m({object_class:"Scene",root:c})}else b._data&&b._data["scene.json"]?(c=JSON.parse(b._data["scene.json"]),m(c)):console.error("Error loading PACK, doesnt look like it has a valid scene inside")}function m(a){if(a.constructor!==Object)throw"response must be object";var b=e.Scene.getScriptsList(a,!0);b.length?q.loadScripts(b,function(){l(a)},c):l(a)}function l(c){h&&h(q,a);q.init();q.configure(c);b&&b(q,a);q.loadResources(n);LEvent.trigger(q,"load");e.ResourcesManager.isLoading()||n()}
function n(){f&&f(q,a);LEvent.trigger(q,"loadCompleted")}function p(b){var d=b&&b.target?b.target.status:0;console.warn("Error loading scene: "+a+" -> "+d);c&&c(a,d,b)}if(a){var q=this,r=e.ResourcesManager.getExtension(a),s=e.Formats.getFileFormatInfo(r);e.Network.request({url:a,nocache:!0,dataType:"json"==r?"json":s.dataType||"text",success:"json"==r?m:g,progress:d,error:p});this._state=e.LOADING;LEvent.trigger(this,"beforeLoad")}};E.prototype.loadFromResources=function(a,b,c,d,f){a=e.ResourcesManager.getFullURL(a);
this.load(a,b,c,d,f)};E.getScriptsList=function(a,b,c){if(!a)throw"Scene.getScriptsList: scene cannot be null";var d=[];a.external_scripts&&a.external_scripts.length&&(d=d.concat(a.external_scripts));if(a.global_scripts&&a.global_scripts.length)for(var f in a.global_scripts){var h=a.global_scripts[f];h&&"js"==e.ResourcesManager.getExtension(h)&&(e.ResourcesManager.getResource(h)&&b&&(h=e.ResourcesManager.cleanFullpath(h)),c&&(h=e.ResourcesManager.getFullURL(h)),d.push(h))}return d};E.prototype.loadScripts=
function(a,b,c,d){function f(){for(var a in g)URL.revokeObjectURL(g[a]);b&&b()}a=a||e.Scene.getScriptsList(this,!0);if(a.length)if(e._block_scripts)console.error("Safety: LS.block_scripts enabled, cannot request script");else{var h=[],g=[],k;for(k in a){var m=a[k],l=e.ResourcesManager.getResource(m);!l||d?h.push(e.ResourcesManager.getFullURL(m)):(m=new Blob([l.data],{encoding:"UTF-8",type:"text/plain;charset=UTF-8"}),m=URL.createObjectURL(m),h.push(m),g.push(m))}e.Network.requestScript(h,f,c)}else b&&
b()};E.prototype.checkComponentsCodeModification=function(){for(var a=0;a<this._nodes.length;++a){for(var b=this._nodes[a],c=0;c<b._components.length;++c){var d=b._components[c],f=e.getObjectClassName(d),h=e.Components[f];if(h!=d.constructor){var g=d.serialize(),h=new h(g),g=b.getIndexOfComponent(d);b.removeComponent(d);b.addComponent(h,g);console.log("Class replaced: "+f)}}if(b._missing_components&&b._missing_components.length){d=[];for(c=0;c<b._missing_components.length;++c)g=b._missing_components[c],
f=g[0],(h=e.Components[f])?(h=new h(g[1]),b.addComponent(h),console.log("Missing repaired: "+f)):d.push(g);b._missing_components=d.length?d:null}}};E.prototype.appendScene=function(a){a=a.root.childNodes;for(var b in a){var c=a[b],d=new e.SceneNode(c.id);this.root.addChild(d);d.configure(c.constructor==e.SceneNode?c.serialize():c)}};E.prototype.getCamera=function(){var a=this._root.camera;if(a)return a;if(this._cameras&&this._cameras.length)return this._cameras[0];this.collectData();return this._cameras[0]};
E.prototype.getActiveCameras=function(a){a&&LEvent.trigger(this,"collectCameras",this._cameras);return this._cameras};E.prototype.getAllCameras=function(){for(var a=[],b=0;b<this._nodes.length;++b){var c=this._nodes[b].getComponents(e.Components.Camera);c&&c.length&&(a=a.concat(c))}return a};E.prototype.getLight=function(){return this._root.light};E.prototype.getActiveLights=function(a){a&&LEvent.trigger(this,"collectLights",this._lights);return this._lights};E.prototype.onNodeAdded=function(a,b){if(b._in_tree&&
b._in_tree!=this)throw"Cannot add a node from other scene, clone it";b._name&&!this._nodes_by_name[b._name]&&(this._nodes_by_name[b._name]=b);if(!b.uid||this._nodes_by_uid[b.uid])b._uid=e.generateUId("NODE-");this._nodes_by_uid[b.uid]=b;this._nodes.push(b);b.processActionInComponents("onAddedToScene",this);for(var c=0;c<b._components.length;++c)b._components[c].uid?this._components_by_uid[b._components[c].uid]=b._components[c]:console.warn("component without uid?",b._components[c].uid);LEvent.trigger(this,
"nodeAdded",b);LEvent.trigger(this,"change")};E.prototype.onNodeRemoved=function(a,b){var c=this._nodes.indexOf(b);if(-1!=c){this._nodes.splice(c,1);b._name&&this._nodes_by_name[b._name]==b&&delete this._nodes_by_name[b._name];b.uid&&delete this._nodes_by_uid[b.uid];b.processActionInComponents("onRemovedFromScene",this);for(c=0;c<b._components.length;++c)delete this._components_by_uid[b._components[c].uid];LEvent.trigger(this,"nodeRemoved",b);LEvent.trigger(this,"change");return!0}};E.prototype.recomputeNodesArray=
function(){function a(d){b[c]=d;c+=1;if(d._children&&d._children.length)for(var e=0;e<d._children.length;++e)a(d._children[e])}var b=this._nodes,c=0;a(this._root)};E.prototype.attachSceneElement=function(a){this._spatial_container.add(a)};E.prototype.detachSceneElement=function(a){this._spatial_container.remove(a)};E.prototype.getNodes=function(a){a&&this.recomputeNodesArray();return this._nodes};E.prototype.getNode=function(a){if(""==a)return this.root;if(!a||a.constructor!==String)return null;if(a.charAt(0)==
e._uid_prefix)return this._nodes_by_uid[a];if(-1!=a.indexOf("|")){a=a.split("|");for(var b=this.root,c=0;c<a.length&&b;++c)b=b.getChildByName(a[c]);return b}return this._nodes_by_name[a]};E.prototype.getNodeByName=function(a){return this._nodes_by_name[a]};E.prototype.getNodeByUId=function(a){return this._nodes_by_uid[a]};E.prototype.getNodeByIndex=function(a){return this._nodes[a]};E.prototype.getElementById=E.prototype.getNode;E.prototype.filterNodes=function(a){for(var b=[],c=0;c<this._nodes.length;++c)a(this._nodes[c])&&
b.push(this._nodes[c]);return b};E.prototype.findComponentByUId=function(a){for(var b=0;b<this._nodes.length;++b){var c=this._nodes[b].getComponentByUId(a);if(c)return c}return null};E.prototype.findMaterialByUId=function(a){if(e.RM.materials[a])return e.RM.materials[a];for(var b=0;b<this._nodes.length;++b){var c=this._nodes[b].getMaterial();if(c&&c.uid==a)return c}return null};E.prototype.getPropertyInfo=function(a){a=a.split("/");var b=a[0].substr(0,5);return"@MAT-"==b?(b=e.RM.materials_by_uid[a[0]])?
b.getPropertyInfoFromPath(a.slice(1)):null:"@COMP"==b?(b=this.findComponentByUId(a[0]))?1==a.length?{node:b.root,target:b,name:b?e.getObjectClassName(b):"",type:"component",value:b}:b.getPropertyInfoFromPath(a.slice(1)):null:(b=this.getNode(a[0]))?b.getPropertyInfoFromPath(a.slice(1)):null};E.prototype.getPropertyInfoFromPath=function(a){if("@MAT-"==a[0].substr(0,5)){var b=e.RM.materials_by_uid[a[0]];return b?b.getPropertyInfoFromPath(a.slice(1)):null}return(b=this.getNode(a[0]))?b.getPropertyInfoFromPath(a.slice(1)):
null};E.prototype.getPropertyValue=function(a,b){var c=property_uid.split("/");if("@MAT-"==c[0].substr(0,5)){var d=e.RM.materials_by_uid[c[0]];return d?d.getPropertyValueFromPath(c.slice(1)):null}return(d=this.getNode(c[0]))?d.getPropertyValueFromPath(c.slice(1)):null};E.prototype.getPropertyValueFromPath=function(a){if("@MAT-"==a[0].substr(0,5)){var b=e.RM.materials_by_uid[a[0]];return b?b.getPropertyValueFromPath(a.slice(1)):null}return(b=this.getNode(a[0]))?b.getPropertyValueFromPath(a.slice(1)):
null};E.prototype.setPropertyValue=function(a,b,c){a=a.split("/");this.setPropertyValueFromPath(a,b,c,0)};E.prototype.setPropertyValueFromPath=function(a,b,c,d){d=d||0;if(!(a.length<d+1))return"@MAT-"==a[d].substr(0,5)?(c=e.RM.materials_by_uid[a[d]])?c.setPropertyValueFromPath(a,b,d+1):null:(c=c?c.findNode(a[d]):this.getNode(a[d]))?c.setPropertyValueFromPath(a,b,d+1):null};E.prototype.getResources=function(a,b,c,d){a=a||{};var f=null;a.constructor===Array&&(f=a,a={},b=!0);if(this.preloaded_resources)for(var h in this.preloaded_resources)a[h]=
!0;this.texture_atlas&&(a[this.texture_atlas.filename]=!0);for(h=0;h<this.global_scripts.length;++h)this.global_scripts[h]&&(a[this.global_scripts[h]]=!0);for(h=0;h<this._nodes.length;++h)this._nodes[h].getResources(a);if(c)for(h in a)(c=e.ResourcesManager.resources[h])&&c&&(c.from_prefab||c.from_pack)&&delete a[h];if(d)for(h in a)":"==h[0]&&delete a[h];for(h in a)(c=e.ResourcesManager.resources[h])&&c.getResources&&c.getResources(a);if(!b)return a;b=f||[];for(h in a)b.push(h);return b};E.prototype.loadResources=
function(a){function b(){LEvent.unbind(e.ResourcesManager,"end_loading_resources",b);a&&a()}var c=this.getResources([]),d=0,f;for(f in c)++d;0==d?a&&a():(LEvent.bind(e.ResourcesManager,"end_loading_resources",b),e.ResourcesManager.loadResources(c))};E.prototype.addPreloadResource=function(a){this.preloaded_resources[a]=!0};E.prototype.removePreloadResource=function(a){delete this.preloaded_resources[a]};E.prototype.start=function(){this._state!=e.PLAYING&&(this._state=e.PLAYING,this._start_time=0.001*
getTime(),LEvent.trigger(this,"init",this),this.triggerInNodes("init"),LEvent.trigger(this,"start",this),this.triggerInNodes("start"))};E.prototype.pause=function(){this._state==e.PLAYING&&(this._state=e.PAUSED,LEvent.trigger(this,"pause",this),this.triggerInNodes("pause"),this.purgeResidualEvents())};E.prototype.unpause=function(){this._state==e.PAUSED&&(this._state=e.PLAYING,LEvent.trigger(this,"unpause",this),this.triggerInNodes("unpause"),this.purgeResidualEvents())};E.prototype.finish=function(){this._state!=
e.STOPPED&&(this._state=e.STOPPED,LEvent.trigger(this,"finish",this),this.triggerInNodes("finish"),this.purgeResidualEvents())};E.prototype.render=function(a){this._renderer.render(this,a)};E.prototype.collectData=function(a){var b=this._instances,c=this._lights,d=this._colliders;b.length=0;c.length=0;d.length=0;a&&0!=a.length||(a=this._cameras,a.length=0,LEvent.trigger(this,"collectCameras",a));var e=this.getNodes();a=0;for(var h=e.length;a<h;++a){var g=e[a];!1!=g.flags.visible&&(g.transform&&g.transform.updateGlobalMatrix(),
g._instances.length=0,LEvent.trigger(g,"collectRenderInstances",g._instances),LEvent.trigger(g,"collectPhysicInstances",d),b.push.apply(b,g._instances))}LEvent.trigger(this,"collectRenderInstances",b);LEvent.trigger(this,"collectPhysicInstances",d);LEvent.trigger(this,"collectLights",c);LEvent.trigger(this,"collectData");a=0;for(h=b.length;a<h;++a)c=b[a],c.use_bounding&&c.updateAABB();a=0;for(h=d.length;a<h;++a)d[a].updateAABB();this._last_collect_frame=this._frame};E.prototype.update=function(a){LEvent.trigger(this,
"beforeUpdate",this);this._global_time=0.001*getTime();this._time+=a;this._last_dt=a;LEvent.trigger(this,"update",a);if(0<this._fixed_update_timestep)if(this._remaining_fixed_update_time+=a,LEvent.hasBind(this,"fixedUpdate"))for(;this._remaining_fixed_update_time>this._fixed_update_timestep;)LEvent.trigger(this,"fixedUpdate",this._fixed_update_timestep),this._remaining_fixed_update_time-=this._fixed_update_timestep;else this._remaining_fixed_update_time%=this._fixed_update_timestep;LEvent.trigger(this,
"afterUpdate",this)};E.prototype.triggerInNodes=function(a,b){LEvent.triggerArray(this._nodes,a,b)};E.prototype.generateUniqueNodeName=function(a){a=a||"node";var b=1,c=a.lastIndexOf("_");if(c){var d=a.substr(c+1);parseInt(d)&&(b=parseInt(d),a=a.substr(0,c))}for(c=a+"_"+b;null!=this.getNode(c);)c=a+"_"+b++;return c};E.prototype.requestFrame=function(){this._must_redraw=!0;LEvent.trigger(this,"requestFrame")};E.prototype.refresh=E.prototype.requestFrame;E.prototype.getTime=function(){return this._time};
E.prototype.purgeResidualEvents=function(){if(this.__events)for(var a in this.__events){var b=this.__events[a];if(b){for(var c=[],d=0;d<b.length;++d){var f=b[d][1];!f||!e.isClassComponent(f.constructor)||f._root&&f._root.scene===this?c.push(b[d]):console.warn("Event attached to the Scene belongs to a removed node, purged. Event:",a,"Class:",e.getObjectClassName(f))}this.__events[a]=c}}};E.prototype.getLayerNames=function(a){for(var b=[],c=0;32>c;++c)(void 0===a||a&1<<c)&&b.push(this.layer_names[c]||
"layer"+c);return b};E.prototype.findNodeComponents=function(a){if(a){var b=null;if(b=a.constructor===String?e.Components[a]:a){a=[];for(var c=this._nodes,d=0;d<c.length;++d)for(var f=c[d]._components,h=0;h<f.length;++h)f[h].constructor===b&&a.push(f[h]);return a}}};E.prototype.instantiate=function(a,b,c,d){if(!a||a.constructor!==String)throw"prefab must be the url to the prefab";var f=new e.SceneNode;b&&3===b.length&&(f.transform.position=b);c&&4===c.length&&(f.transform.rotation=c);d=d||this.root;
d.addChild(f);f.prefab=a;return f};E.prototype.toPack=function(a,b){var c=e.RM.removeExtension(a||"unnamed_scene",!0)+".SCENE.wbin",d=JSON.stringify(this.serialize());b||(b=this.getResources(null,!0,!0,!0));d=e.Pack.createPack(e.RM.getFilename(c),b,{"scene.json":d});d.fullpath=c;d.category="Scene";return d};E.prototype.updateStaticObjects=function(){var a=e.allow_static;e.allow_static=!1;this.collectData();e.allow_static=a};E.prototype.sendResourceRenamedEvent=function(a,b,c){for(var d=0;d<this.external_scripts.length;d++)this.external_scripts[d]==
a&&(this.external_scripts[d]=b);for(d=0;d<this.global_scripts.length;d++)this.global_scripts[d]==a&&(this.global_scripts[d]=b);for(d in this.preloaded_resources)d==a&&(delete this.preloaded_resources[a],this.preloaded_resources[b]=!0);this.texture_atlas&&this.texture_atlas.filename==a&&(this.texture_atlas.filename=b);for(var f=this._nodes.concat(),d=0;d<f.length;d++){var h=f[d];h.prefab&&h.prefab===a&&(h.prefab=b);for(var g=0;g<h._components.length;g++){var k=h._components[g];if(k.onResourceRenamed)k.onResourceRenamed(a,
b,c)}h.material&&(h.material==a?h.material=b:(h=h.getMaterial())&&h.onResourceRenamed?h.onResourceRenamed(a,b,c)&&e.RM.resourceModified(h):console.warn("sendResourceRenamedEvent: Material not found or it didnt have a onResourceRenamed"))}};E.prototype.getDataPath=function(a){return e.RM.cleanFullpath((this.extra.data_folder||this.extra.folder)+"/"+(a||""))};E.prototype.createAnimation=function(){if(this.animation)return this.animation;this.animation=new e.Animation;this.animation.name=e.Animation.DEFAULT_SCENE_NAME;
this.animation.createTake("default",e.Animation.DEFAULT_DURATION);return this.animation};e.Scene=E;e.Classes.Scene=E;e.Classes.SceneTree=E;M.prototype.init=function(a,b){b||(this.layers=3,this._name=name||"node_"+(1E4*Math.random()).toFixed(0),this._uid=e.generateUId("NODE-"),this._classList={},this._material=null,this.extra={},this.node_type=null,this.flags={visible:!0,is_static:!1,selectable:!0});a||(this._components&&this._components.length&&console.warn("SceneNode.init() should not be called if it contains components, call clear instead"),
this._components=[],this._missing_components=null,this.addComponent(new e.Transform))};e.extendClass(M,wa);e.extendClass(M,ma);Object.defineProperty(M.prototype,"name",{set:function(a){this.setName(a)},get:function(){return this._name},enumerable:!0});Object.defineProperty(M.prototype,"fullname",{set:function(a){throw"You cannot set fullname, it depends on the parent nodes";},get:function(){return this.getPathName()},enumerable:!1});Object.defineProperty(M.prototype,"uid",{set:function(a){a&&(a[0]!=
e._uid_prefix&&(console.warn("Invalid UID, renaming it to: "+a),a=e._uid_prefix+a),a!=this._uid&&(M._last_uid_changed=this._uid,this._in_tree&&this._in_tree._nodes_by_uid[this.uid]&&delete this._in_tree._nodes_by_uid[this.uid],this._uid=a,this._in_tree&&(this._in_tree._nodes_by_uid[this.uid]=this),LEvent.trigger(this,"uid_changed",a),this._in_tree&&LEvent.trigger(this._in_tree,"node_uid_changed",this)))},get:function(){return this._uid},enumerable:!0});Object.defineProperty(M.prototype,"visible",
{set:function(a){this.flags.visible=a},get:function(){return this.flags.visible},enumerable:!0});Object.defineProperty(M.prototype,"is_static",{set:function(a){this.flags.is_static=a},get:function(){return this.flags.is_static},enumerable:!0});Object.defineProperty(M.prototype,"material",{set:function(a){if(this._material!=a){if(this._material=a){if(a.constructor===String)return;a._root&&a._root!=this?console.warn("Cannot assign a material of one SceneNode to another, you must clone it or register it"):
a._root=this}LEvent.trigger(this,"materialChanged")}},get:function(){return this._material},enumerable:!0});Object.defineProperty(M.prototype,"prefab",{set:function(a){if(this._prefab=a){var b=this;e.RM.getResource(a)?this.reloadFromPrefab():e.ResourcesManager.load(a,function(){b.reloadFromPrefab()})}},get:function(){return this._prefab},enumerable:!0});M.prototype.clear=function(){this.removeAllComponents();this.removeAllChildren();this.init()};M.prototype.setName=function(a){if(this._name==a)return!0;
if(!e.validateName(a))return console.warn("invalid name for node: "+a),!1;var b=this._in_tree;if(!b)return this._name=a,!0;this._name&&delete b._nodes_by_name[this._name];(this._name=a)&&!b._nodes_by_name[a]&&(b._nodes_by_name[this._name]=this);LEvent.trigger(this,"name_changed",a);b&&LEvent.trigger(b,"node_name_changed",this);return!0};Object.defineProperty(M.prototype,"classList",{get:function(){return this._classList},set:function(a){},enumerable:!1});Object.defineProperty(M.prototype,"className",
{get:function(){var a=null;if(Object.keys)a=Object.keys(this._classList);else{var a=[],b;for(b in this._classList)a.push(b)}return a.join(" ")},set:function(a){this._classList={};if(a){a=a.split(" ");for(var b in a)this._classList[a[b]]=!0}},enumerable:!0});M.prototype.destroy=function(a){if(a&&a.constructor===Number&&0<a)setTimeout(this.destroy.bind(this,0),0.001*a);else{LEvent.trigger(this,"destroy");this.removeAllComponents();if(this.children)for(;this.children.length;)this.children[0].destroy();
this._parentNode&&this._parentNode.removeChild(this)}};M.prototype.getLocator=function(a){return a?this.uid+"/"+a:this.uid};M.prototype.getPropertyInfo=function(a){a=a.split("/");return this.getPropertyInfoFromPath(a)};M.prototype.getPropertyInfoFromPath=function(a){var b=this,c=!1;if(0==a.length)return{node:this,target:null,name:"",value:this,type:"node"};if(1==a.length){if("@"==a[0][0])return b=this.getComponentByUId(a[0]),{node:this,target:b,name:b?e.getObjectClassName(b):"",type:"component",value:b};
if("material"==a[0])return b=this.getMaterial(),{node:this,target:b,name:b?e.getObjectClassName(b):"",type:"material",value:b};if(b=this.getComponent(a[0]))return{node:this,target:b,name:b?e.getObjectClassName(b):"",type:"component",value:b};switch(a[0]){case "matrix":case "x":case "y":case "z":case "position":case "rotX":case "rotY":case "rotZ":b=this.transform;c=!0;break;default:b=this}}else if(1<a.length&&(b="@"==a[0][0]?this.getComponentByUId(a[0]):"material"==a[0]?this.getMaterial():"flags"==
a[0]?this.flags:this.getComponent(a[0]),!b))return null;return b?b!=this&&b.getPropertyInfoFromPath?b.getPropertyInfoFromPath(c?a:a.slice(1)):null:null};M.prototype.getPropertyValue=function(a){a=a.split("/");return this.getPropertyValueFromPath(a)};M.prototype.getPropertyValueFromPath=function(a){var b=this,c=a[0],d=!1;if(0==a.length)return null;if(1==a.length){if("@"==a[0][0])return this.getComponentByUId(a[0]);if("material"==a[0])return this.getMaterial();if(b=this.getComponent(a[0]))return b;
switch(a[0]){case "matrix":case "x":case "y":case "z":case "position":case "rotX":case "rotY":case "rotZ":b=this.transform;c=a[0];d=!0;break;default:b=this,c=a[0]}}else if(1<a.length&&("@"==a[0][0]?(c=a[1],b=this.getComponentByUId(a[0])):(b="material"==a[0]?this.getMaterial():"flags"==a[0]?this.flags:this.getComponent(a[0]),c=a[1]),!b))return null;var e=void 0;if(b.getPropertyValueFromPath&&b!=this){var h=b.getPropertyValueFromPath(d?a:a.slice(1));if(h)return h}b.getPropertyValue&&b!=this&&(e=b.getPropertyValue(c));
return void 0===e&&2<a.length&&b[c]&&b[c].getPropertyValueFromPath&&(h=b[c].getPropertyValueFromPath(d?a.slice(1):a.slice(2)))?(h.node=this,h):void 0===e&&void 0===b[c]?null:void 0!==e?e:b[c]};M.prototype.setPropertyValue=function(a,b){var c=a.split("/");return this.setPropertyValueFromPath(c,b,0)};M.prototype.setPropertyValueFromPath=function(a,b,c){c=c||0;if(!this.flags||!this.flags.locked){var d=null,e=a[c];if(a.length>c+1){if("@"==a[c][0]?(e=a[c+1],d=this.getComponentByUId(a[c])):(d="material"==
a[c]?this.getMaterial():"flags"==a[c]?this.flags:this.getComponent(a[c]),e=a[c+1]),!d)return null}else switch(a[c]){case "matrix":d=this.transform;break;case "position":case "rotation":case "x":case "y":case "z":case "xrotation":case "yrotation":case "zrotation":d=this.transform;e=a[c];break;case "translate.X":d=this.transform;e="x";break;case "translate.Y":d=this.transform;e="y";break;case "translate.Z":d=this.transform;e="z";break;case "rotateX.ANGLE":d=this.transform;e="pitch";break;case "rotateY.ANGLE":d=
this.transform;e="yaw";break;case "rotateZ.ANGLE":d=this.transform;e="roll";break;default:d=this}if(!d)return null;if(d.setPropertyValueFromPath&&d!=this&&!0===d.setPropertyValueFromPath(a,b,c+1)||d.setPropertyValue&&d!=this&&!0===d.setPropertyValue(e,b))return d;if(void 0!==d[e]){if(2<a.length&&d[e]&&d[e].setPropertyValueFromPath)return d[e].setPropertyValueFromPath(a,b,c+2);d[e]=b;return d}}};M.prototype.getResources=function(a,b){for(var c in this._components)this._components[c].getResources&&
this._components[c].getResources(a);if(this.material){this.material.constructor===String&&":"!=this.material[0]&&(a[this.material]=e.Material);var d=this.getMaterial();d&&d.getResources(a)}this.prefab&&(a[this.prefab]=e.Prefab);if(b)for(c in this._children)this._children[c].getResources(a,!0);return a};M.prototype.getTransform=function(){return this.transform};M.prototype.getMesh=function(a){var b=this.mesh,c=this.getComponent(e.Components.MeshRenderer);!b&&c&&(a&&(b=c.lod_mesh),b||(b=c.mesh));return b?
b.constructor===String?e.ResourcesManager.meshes[b]:b:null};M.prototype.getLight=function(){return this.light};M.prototype.getCamera=function(){return this.camera};M.prototype.load=function(a,b){var c=this;e.ResourcesManager.load(a,function(a){a&&(c.assign(a),b&&b())})};M.prototype.assign=function(a,b){if(a){if(a.constructor===String&&(a=e.ResourcesManager.getResource(a)),a)switch(a.constructor){case e.SceneNode:this.addChild(a);break;case e.Scene:var c=this;a.loadScripts(null,function(){a.loadResources(function(){c.addChild(a.root.clone())})});
break;case e.Prefab:this.prefab=a.fullpath||a.filename;break;case GL.Mesh:var d=this.getComponent(e.Components.MeshRenderer);d?d.configure({mesh:a.fullpath||a.filename}):this.addComponent(new e.MeshRenderer({mesh:mesh_name,submesh_id:submesh_id}));break;case e.Animation:(d=this.getComponent(e.Components.PlayAnimation))||(d=this.addComponent(new e.Components.PlayAnimation));d.animation=a.fullpath||a.filename;break;case e.Resource:"js"==e.ResourcesManager.getExtension(a.filename)&&((d=this.getComponent(e.Components.ScriptFromFile))||
(d=this.addComponent(new e.Components.ScriptFromFile)),d.src=a.fullpath||a.filename);break;default:console.error("feature not supported loading this type of resource",a)}}else console.error("assignResource cannot have null as resource")};M.prototype.setMesh=function(a,b){var c=this.getComponent(e.Components.MeshRenderer);c?c.configure({mesh:a,submesh_id:b}):this.addComponent(new e.MeshRenderer({mesh:a,submesh_id:b}))};M.prototype.getMaterial=function(){return this.material?this.material.constructor===
String?this._in_tree?"@"==this.material[0]?e.ResourcesManager.materials_by_uid[this.material]:e.ResourcesManager.materials[this.material]:null:this.material:null};M.prototype.reloadFromPrefab=function(){if(this.prefab){var a=e.ResourcesManager.resources[this.prefab];if(a){if(a.constructor!==e.Prefab)throw"prefab must be a LS.Prefab class";this.removeAllChildren();this.init(!0,!0);var b=a.prefab_data,b={children:a.prefab_data.children};this.configure(b);b=this.getResources({},!0);e.ResourcesManager.loadResources(b);
LEvent.trigger(this,"prefabReady",a)}}};M.prototype.setLayer=function(a,b){if(null==a)throw"setLayer expects layer";var c;if(a.constructor===String){if(c=(this.scene||e.GlobalScene).layer_names.indexOf(a),-1==c){console.error("Layer with name:",a,"not found in scene");return}}else c=a;c=1<<c;this.layers&=~c;b&&(this.layers|=c)};M.prototype.isInLayer=function(a){if(null==a)throw"setLayer expects layer";if(a.constructor===String){var b=(this.scene||e.GlobalScene).layer_names.indexOf(a);if(-1==b){console.error("Layer with name:",
a,"not found in scene");return}a=b}return 0!==(this.layers&1<<a)};M.prototype.getLayers=function(){var a=[];if(!this.scene)return a;for(var b=0;32>b;++b)this.layers&1<<b&&a.push(this.scene.layer_names[b]||"layer"+b);return a};M.prototype.insidePrefab=function(){for(var a=this;a;){if(a.prefab)return a;a=a._parentNode}return null};M.prototype.clone=function(){var a=this._in_tree,a=a?a.generateUniqueNodeName(this._name):this._name,a=new e.SceneNode(a),b=this.serialize();e.clearUIds(b);b.uid=e.generateUId("NODE-");
a.configure(b);return a};M.prototype.configure=function(a){a.name?this.setName(a.name):a.id&&this.setName(a.id);void 0!==a.layers&&(this.layers=a.layers);a.uid&&(this.uid=a.uid);a.className&&a.className.constructor==String&&(this.className=a.className);a.node_type&&(this.node_type=a.node_type,"JOINT"==a.node_type&&(this._is_bone=!0));a.camera&&this.addComponent(new e.Camera(a.camera));a.light&&this.addComponent(new e.Light(a.light));if(a.meshes)for(var b=0;b<a.meshes.length;++b)this.addMeshComponents(a.meshes[b],
a);else a.mesh&&this.addMeshComponents(a.mesh,a);(a.position||a.model||a.transform)&&!this.transform&&this.addComponent(new e.Transform);a.position&&(this.transform.position=a.position);a.model&&this.transform.fromMatrix(a.model);a.matrix&&this.transform.fromMatrix(a.matrix);a.transform&&this.transform.configure(a.transform);if(a.material){var c=a.material.material_class;c&&"newStandardMaterial"!=c||(c="StandardMaterial");var d=e.MaterialClasses[c];d?this.material="string"==typeof a.material?a.material:
new d(a.material):console.warn("Material not found: "+c)}if(a.flags)for(b in a.flags)this.flags[b]=a.flags[b];a.animation&&(this.animation=a.animation,this.addComponent(new e.Components.PlayAnimation({animation:this.animation})));a.extra&&(this.extra=a.extra);a.editor&&(this._editor=a.editor);a.comments&&(this.comments=a.comments);a.components&&this.configureComponents(a);a.prefab&&!this._is_root?this.prefab=a.prefab:this.configureChildren(a);LEvent.trigger(this,"configure",a)};M.prototype.addMeshComponents=
function(a,b){b=b||{};if(a){if(a.constructor!==String&&(b=a,a=b.mesh,!a))return console.warn("Mesh info without mesh id"),null;var c=e.ResourcesManager.meshes[a];if(c){var d={mesh:a};void 0!==b.submesh_id&&(d.submesh_id=b.submesh_id);void 0!==b.morph_targets&&(d.morph_targets=b.morph_targets);void 0!==b.material&&(d.material=b.material);d=new e.Components.MeshRenderer(d);if(c.primitive){switch(c.primitive){case "points":d.primitive=GL.POINTS;break;case "lines":d.primitive=GL.LINES;break;case "line_strip":d.primitive=
GL.LINE_STRIP}delete c.primitive}this.addComponent(d);c&&c.bones&&(d=new e.Components.SkinDeformer({search_bones_in_parent:!1}),this.addComponent(d));c&&c.morph_targets&&(d=new e.Components.MorphDeformer({morph_targets:c.morph_targets}),this.addComponent(d))}else console.warn("SceneNode mesh not found: "+a)}};M.prototype.serialize=function(a,b){var c={object_class:"SceneNode"};this._name&&(c.name=this._name);this.uid&&(c.uid=this.uid);this.className&&(c.className=this.className);c.layers=this.layers;
this.node_type&&(c.node_type=this.node_type);this.mesh&&"string"==typeof this.mesh&&(c.mesh=this.mesh);null!=this.submesh_id&&(c.submesh_id=this.submesh_id);this.material&&(c.material="string"==typeof this.material?this.material:this.material.serialize(b));!this.prefab||a||this._is_root||(c.prefab=this.prefab);this.flags&&(c.flags=e.cloneObject(this.flags));this.extra&&(c.extra=this.extra);this.comments&&(c.comments=this.comments);!this._children||this.prefab&&!a||(c.children=this.serializeChildren(b));
this._editor&&(c.editor=this._editor);this.serializeComponents(c,b);LEvent.trigger(this,"serialize",c);return c};M.prototype._onChildAdded=function(a,b){if(b&&this.transform){var c=a.transform.getGlobalMatrix(),d=this.transform.getGlobalMatrix();mat4.invert(d,d);a.transform.fromMatrix(mat4.multiply(d,d,c));a.transform.getGlobalMatrix()}this.transform&&(a.transform||a.transform.addComponent(new e.Transform),a.transform._parent=this.transform)};M.prototype._onChangeParent=function(a,b){if(b&&a.transform){var c=
this.transform.getGlobalMatrix(),d=a.transform.getGlobalMatrix();mat4.invert(d,d);this.transform.fromMatrix(mat4.multiply(d,d,c))}a.transform&&(this.transform._parent=a.transform)};M.prototype._onChildRemoved=function(a,b,c){this.transform&&a.transform&&(b?(b=a.transform.getGlobalMatrix(),a.transform._parent=null,a.transform.fromMatrix(b)):a.transform._parent=null);c&&a.removeAllComponents()};M.prototype.getBoundingBox=function(a,b){a=a||BBox.create();var c=this._instances;if(c)for(var d=0;d<c.length;++d)0==
d?a.set(c[d].aabb):BBox.merge(a,a,c[d].aabb);return b?a:c&&0!=c.length||!this.transform?a:BBox.fromPoint(this.transform.getGlobalPosition())};e.Scene.Node=M;e.SceneNode=M;e.Classes.SceneNode=M;e.Shaders.registerSnippet("surface","\n\t//used to store surface shading properties\n\tstruct SurfaceOutput {\n\t\tvec3 Albedo;\n\t\tvec3 Normal; //separated in case there is a normal map\n\t\tvec3 Emission;\n\t\tvec3 Ambient;\n\t\tfloat Specular;\n\t\tfloat Gloss;\n\t\tfloat Alpha;\n\t\tfloat Reflectivity;\n\t\tvec4 Extra; //for special purposes\n\t};\n\t\n\tSurfaceOutput getSurfaceOutput()\n\t{\n\t\tSurfaceOutput o;\n\t\to.Albedo = u_material_color.xyz;\n\t\to.Alpha = u_material_color.a;\n\t\to.Normal = normalize( v_normal );\n\t\to.Specular = 0.5;\n\t\to.Gloss = 10.0;\n\t\to.Ambient = vec3(1.0);\n\t\to.Emission = vec3(0.0);\n\t\to.Reflectivity = 0.0;\n\t\to.Extra = vec4(0.0);\n\t\treturn o;\n\t}\n");
e.Shaders.registerSnippet("light_structs","\n\t#ifndef SB_LIGHT_STRUCTS\n\t#define SB_LIGHT_STRUCTS\n\tuniform lowp vec4 u_light_info;\n\tuniform vec3 u_light_position;\n\tuniform vec3 u_light_front;\n\tuniform vec3 u_light_color;\n\tuniform vec4 u_light_angle; //cone start,end,phi,theta \n\tuniform vec4 u_light_att; //start,end \n\tuniform float u_light_offset; //ndotl offset\n\tuniform vec4 u_light_extra; //user data\n\tuniform mat4 u_light_matrix; //projection to light screen space\n\tuniform vec3 u_ambient_light;\n\tstruct Light {\n\t\tlowp vec4 Info; //type of light (3: DIRECTIONAL), falloff type, pass index, num passes \n\t\tvec3 Color;\n\t\tvec3 Ambient;\n\t\tvec3 Position;\n\t\tvec3 Front;\n\t\tvec4 ConeInfo; //for spotlights\n\t\tvec4 Attenuation; //start,end,type,extra\n\t\tfloat Offset; //phong_offset\n\t\tvec4 Extra; //users can use this\n\t\tmat4 Matrix; //converts to light space\n\t\tfloat Distance;\n\t};\n\t//Returns the info about the light\n\tLight getLight()\n\t{\n\t\tLight LIGHT;\n\t\tLIGHT.Info = u_light_info;\n\t\tLIGHT.Color = u_light_color;\n\t\tif(u_light_info.z == 0.0)\n\t\t\tLIGHT.Ambient = u_ambient_light;\n\t\telse\n\t\t\tLIGHT.Ambient = vec3(0.0);\n\t\tLIGHT.Position = u_light_position;\n\t\tLIGHT.Front = u_light_front;\n\t\tLIGHT.ConeInfo = u_light_angle; //for spotlights\n\t\tLIGHT.Attenuation = u_light_att; //start and end\n\t\tLIGHT.Offset = u_light_offset;\n\t\tLIGHT.Distance = length( u_light_position - v_pos );\n\t\tLIGHT.Extra = u_light_extra;\n\t\tLIGHT.Matrix = u_light_matrix; //converts to light space\n\t\treturn LIGHT;\n\t}\n\t//used to store light contribution\n\tstruct FinalLight {\n\t\tvec3 Color;\n\t\tvec3 Ambient;\n\t\tfloat Diffuse; //NdotL\n\t\tfloat Specular; //RdotL\n\t\tvec3 Emission;\n\t\tvec3 Reflection;\n\t\tfloat Attenuation;\n\t\tvec3 Vector; //light vector\n\t\tfloat Shadow; //1.0 means fully lit\n\t};\n\t#endif\n");
u._vs_shaderblock_code='\n\t#pragma shaderblock "testShadow"\n';u._enabled_fs_shaderblock_code='\n\t#pragma snippet "input"\n\t#pragma snippet "surface"\n\t#pragma snippet "light_structs"\n\t#pragma snippet "spotFalloff"\n\t#pragma shaderblock "applyIrradiance"\n\t#pragma shaderblock "attenuation"\n\t#pragma shaderblock SHADOWBLOCK "testShadow"\n\t\n\t//Light is separated in two functions, computeLight (how much light receives the object) and applyLight (compute resulting final color)\n\t// FINAL LIGHT EQUATION, takes all the info from FinalLight and computes the final color \n\t\n\t// HERE we fill FinalLight structure with all the info (colors,NdotL,diffuse,specular,etc) \n\tFinalLight computeLight(in SurfaceOutput o, in Input IN, in Light LIGHT )\n\t{\n\t\tFinalLight FINALLIGHT;\n\t\t// INIT\n\t\tFINALLIGHT.Color = LIGHT.Color;\n\t\tFINALLIGHT.Ambient = LIGHT.Ambient;\n\t\t\n\t\t// COMPUTE VECTORS\n\t\tvec3 N = o.Normal; //use the final normal (should be the same as IN.worldNormal)\n\t\tvec3 E = (u_camera_eye - v_pos);\n\t\tfloat cam_dist = length(E);\n\t\tE /= cam_dist;\n\t\t\n\t\tvec3 L = (LIGHT.Position - v_pos) / LIGHT.Distance;\n\t\t\n\t\tif( LIGHT.Info.x == 3.0 )\n\t\t\tL = -LIGHT.Front;\n\t\t\n\t\tFINALLIGHT.Vector = L;\n\t\tvec3 R = reflect(E,N);\n\t\t\n\t\t// IRRADIANCE\n\t\tapplyIrradiance( o, FINALLIGHT );\n\t\t// PHONG FORMULA\n\t\tfloat NdotL = 1.0;\n\t\tNdotL = dot(N,L);\n\t\tfloat EdotN = dot(E,N); //clamp(dot(E,N),0.0,1.0);\n\t\tNdotL = max( 0.0, NdotL + LIGHT.Offset );\n\t\tFINALLIGHT.Diffuse = abs(NdotL);\n\t\tFINALLIGHT.Specular = o.Specular * pow( clamp(dot(R,-L),0.001,1.0), o.Gloss );\n\t\t\n\t\t// ATTENUATION\n\t\tFINALLIGHT.Attenuation = 1.0;\n\t\t\n\t\t#ifdef BLOCK_ATTENUATION\n\t\t\tFINALLIGHT.Attenuation = computeAttenuation( LIGHT );\n\t\t#endif\n\t\tif( LIGHT.Info.x == 2.0 && LIGHT.Info.y == 1.0 )\n\t\t\tFINALLIGHT.Attenuation *= spotFalloff( LIGHT.Front, normalize( LIGHT.Position - v_pos ), LIGHT.ConeInfo.z, LIGHT.ConeInfo.w );\n\t\t\n\t\t// SHADOWS\n\t\tFINALLIGHT.Shadow = 1.0;\n\t\t#ifdef BLOCK_TESTSHADOW\n\t\t\tFINALLIGHT.Shadow = testShadow( LIGHT );\n\t\t#endif\n\t\t\n\t\t// LIGHT MODIFIERS\n\t\t#ifdef LIGHT_MODIFIER\n\t\t#endif\n\t\t// FINAL LIGHT FORMULA ************************* \n\t\treturn FINALLIGHT;\n\t}\n\t//here we apply the FINALLIGHT to the SurfaceOutput\n\tvec3 applyLight( in SurfaceOutput o, in FinalLight FINALLIGHT )\n\t{\n\t\tvec3 total_light = FINALLIGHT.Ambient * o.Ambient + FINALLIGHT.Color * FINALLIGHT.Diffuse * FINALLIGHT.Attenuation * FINALLIGHT.Shadow;\n\t\tvec3 final_color = o.Albedo * total_light;\n\t\tif(u_light_info.z == 0.0)\n\t\t\tfinal_color += o.Emission;\n\t\tfinal_color\t+= o.Albedo * (FINALLIGHT.Color * FINALLIGHT.Specular * FINALLIGHT.Attenuation * FINALLIGHT.Shadow);\n\t\treturn max( final_color, vec3(0.0) );\n\t}\n\t\n\t//all done in one single step\n\tvec3 processLight(in SurfaceOutput o, in Input IN, in Light LIGHT)\n\t{\n\t\tFinalLight FINALLIGHT = computeLight( o, IN,LIGHT );\n\t\treturn applyLight(o,FINALLIGHT);\n\t}\n\t\n';
u._disabled_shaderblock_code='\n\t#pragma snippet "input"\n\t#pragma snippet "surface"\n\t#pragma snippet "light_structs"\n\t#pragma shaderblock "applyIrradiance"\n\tFinalLight computeLight( in SurfaceOutput o, in Input IN, in Light LIGHT )\n\t{\n\t\tFinalLight FINALLIGHT;\n\t\tFINALLIGHT.Ambient = LIGHT.Ambient;\n\t\tFINALLIGHT.Diffuse = 0.0;\n\t\tFINALLIGHT.Specular = 0.0;\n\t\tFINALLIGHT.Attenuation = 0.0;\n\t\tFINALLIGHT.Shadow = 0.0;\n\t\tapplyIrradiance( o, FINALLIGHT );\n\t\treturn FINALLIGHT;\n\t}\n\tvec3 applyLight( in SurfaceOutput o, in FinalLight FINALLIGHT )\n\t{\n\t\tvec3 final_color = o.Albedo * o.Ambient * FINALLIGHT.Ambient;\n\t\tif(u_light_info.z == 0.0)\n\t\t\tfinal_color += o.Emission;\n\t\treturn final_color;\n\t}\n\t\n\t//all done in one single step\n\tvec3 processLight(in SurfaceOutput o, in Input IN, in Light LIGHT)\n\t{\n\t\tFinalLight FINALLIGHT = computeLight( o, IN,LIGHT );\n\t\treturn applyLight(o,FINALLIGHT);\n\t}\n\t\n';
var Eb=new e.ShaderBlock("light");Eb.addCode(GL.VERTEX_SHADER,u._vs_shaderblock_code,u._vs_shaderblock_code);Eb.addCode(GL.FRAGMENT_SHADER,u._enabled_fs_shaderblock_code,u._disabled_shaderblock_code);Eb.register();u.shader_block=Eb;u._attenuation_enabled_fragment_code="\n\tconst float LINEAR_ATTENUATION = 1.0;\n\tconst float RANGE_ATTENUATION = 2.0;\n\tfloat computeAttenuation( in Light LIGHT )\n\t{\n\t\t//no attenuation\n\t\tif(LIGHT.Attenuation.z == 0.0)\n\t\t\treturn 1.0;\n\t\t//directional light\n\t\tif( LIGHT.Info.x == 3.0 )\n\t\t\treturn 1.0;\n\t\tif( LIGHT.Attenuation.z == LINEAR_ATTENUATION )\n\t\t\treturn 10.0 / LIGHT.Distance;\n\t\tif( LIGHT.Attenuation.z == RANGE_ATTENUATION )\n\t\t{\n\t\t\tif(LIGHT.Distance >= LIGHT.Attenuation.y)\n\t\t\t\treturn 0.0;\n\t\t\tif(LIGHT.Distance >= LIGHT.Attenuation.x)\n\t\t\t\treturn 1.0 - (LIGHT.Distance - LIGHT.Attenuation.x) / (LIGHT.Attenuation.y - LIGHT.Attenuation.x);\n\t\t}\n\t\treturn 1.0;\n\t}\n";
u._attenuation_disabled_fragment_code="";var Sb=u.attenuation_block=new e.ShaderBlock("attenuation");Sb.addCode(GL.FRAGMENT_SHADER,u._attenuation_enabled_fragment_code,u._attenuation_disabled_fragment_code);Sb.register();u._light_texture_fragment_enabled_code="\nuniform sampler2D light_texture;\nvoid applyLightTexture( in Input IN, inout Light LIGHT )\n{\n\tvec4 v = LIGHT.Matrix * vec4( IN.worldPos,1.0 );\n\tvec2 uv = v.xy / v.w * 0.5 + vec2(0.5);\n\tLIGHT.Color *= texture2D( light_texture, uv ).xyz;\n}\n";
u._light_texture_fragment_disabled_code="\nvoid applyLightTexture( in Input IN, inout Light LIGHT )\n{\n}\n";var Tb=u.light_texture_block=new e.ShaderBlock("light_texture");Tb.addCode(GL.FRAGMENT_SHADER,u._light_texture_fragment_enabled_code,u._light_texture_fragment_disabled_code);Tb.register();u._shadowmap_cubemap_code="\n\t#define SHADOWMAP_ACTIVE\n\tuniform samplerCube shadowmap;\n\tuniform vec4 u_shadow_params; // (1.0/(texture_size), bias, near, far)\n\t\n\tfloat VectorToDepthValue(vec3 Vec)\n\t{\n\t\tvec3 AbsVec = abs(Vec);\n\t\tfloat LocalZcomp = max(AbsVec.x, max(AbsVec.y, AbsVec.z));\n\t\tfloat n = u_shadow_params.z;\n\t\tfloat f = u_shadow_params.w;\n\t\tfloat NormZComp = (f+n) / (f-n) - (2.0*f*n)/(f-n)/LocalZcomp;\n\t\treturn (NormZComp + 1.0) * 0.5;\n\t}\n\t\n\tfloat UnpackDepth32(vec4 depth)\n\t{\n\t\tconst vec4 bitShifts = vec4( 1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1);\n\t\treturn dot(depth.xyzw , bitShifts);\n\t}\n\t\n\tfloat testShadow( Light LIGHT, vec3 offset )\n\t{\n\t\tfloat shadow = 0.0;\n\t\tfloat depth = 0.0;\n\t\tfloat bias = u_shadow_params.y;\n\t\t\n\t\tvec3 l_vector = (v_pos - u_light_position);\n\t\tfloat dist = length(l_vector);\n\t\tfloat pixel_z = VectorToDepthValue( l_vector );\n\t\tif(pixel_z >= 0.998)\n\t\t\treturn 0.0; //fixes a little bit the far edge bug\n\t\tvec4 depth_color = textureCube( shadowmap, l_vector + offset * dist );\n\t\tfloat ShadowVec = UnpackDepth32( depth_color );\n\t\tif ( ShadowVec > pixel_z - bias )\n\t\t\treturn 0.0; //no shadow\n\t\treturn 1.0; //full shadow\n\t}\n";
u._shadowmap_vertex_enabled_code='\n\t#pragma snippet "light_structs"\n\tvarying vec4 v_light_coord;\n\tvoid applyLight( vec3 pos ) { v_light_coord = u_light_matrix * vec4(pos,1.0); }\n';u._shadowmap_vertex_disabled_code="\n\tvoid applyLight(vec3 pos) {}\n";u._shadowmap_2d_enabled_fragment_code="\n\t#ifndef TESTSHADOW\n\t\t#define TESTSHADOW\n\t#endif\n\tuniform sampler2D shadowmap;\n\tvarying vec4 v_light_coord;\n\tuniform vec4 u_shadow_params; // (1.0/(texture_size), bias, near, far)\n\t\n\tfloat UnpackDepth(vec4 depth)\n\t{\n\t\t#ifdef BLOCK_DEPTH_IN_COLOR\n\t\t\tconst vec4 bitShifts = vec4( 1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1);\n\t\t\treturn dot(depth.xyzw , bitShifts);\n\t\t#else\n\t\t\treturn depth.x;\n\t\t#endif\n\t}\n\tfloat texsize = 1.0 / u_shadow_params.x;\n\tfloat real_depth = 0.0;\n\t\n\tfloat pixelShadow( vec2 uv )\n\t{\n\t\tfloat sampleDepth = UnpackDepth( texture2D(shadowmap, uv) );\n\t\tfloat depth = (sampleDepth == 1.0) ? 1.0e9 : sampleDepth; //on empty data send it to far away\n\t\tif (depth > 0.0) \n\t\t\treturn real_depth > depth ? 0.0 : 1.0;\n\t\treturn 0.0;\n\t}\n\tfloat expFunc(float f)\n\t{\n\t\treturn f*f*f*(f*(f*6.0-15.0)+10.0);\n\t}\n\t\n\tfloat testShadow( Light LIGHT )\n\t{\n\t\tvec3 offset = vec3(0.0);\n\t\tfloat depth = 0.0;\n\t\tfloat bias = u_shadow_params.y;\n\t\t\n\t\tvec2 sample = (v_light_coord.xy / v_light_coord.w) * vec2(0.5) + vec2(0.5) + offset.xy;\n\t\t//is inside light frustum\n\t\tif (clamp(sample, 0.0, 1.0) != sample) \n\t\t\treturn LIGHT.Info.x == 3.0 ? 1.0 : 0.0; //outside of shadowmap, no shadow\n\t\t\n\t\treal_depth = (v_light_coord.z - bias) / v_light_coord.w * 0.5 + 0.5;\n\t\tvec2 topleft_uv = sample * texsize;\n\t\tvec2 offset_uv = fract( topleft_uv );\n\t\toffset_uv.x = expFunc(offset_uv.x);\n\t\toffset_uv.y = expFunc(offset_uv.y);\n\t\ttopleft_uv = floor(topleft_uv) * u_shadow_params.x;\n\t\tfloat topleft = pixelShadow( topleft_uv );\n\t\tfloat topright = pixelShadow( topleft_uv + vec2(u_shadow_params.x,0.0) );\n\t\tfloat bottomleft = pixelShadow( topleft_uv + vec2(0.0, u_shadow_params.x) );\n\t\tfloat bottomright = pixelShadow( topleft_uv + vec2(u_shadow_params.x, u_shadow_params.x) );\n\t\tfloat top = mix( topleft, topright, offset_uv.x );\n\t\tfloat bottom = mix( bottomleft, bottomright, offset_uv.x );\n\t\treturn mix( top, bottom, offset_uv.y );\n\t}\n";
u._shadowmap_2d_disabled_code="\nfloat testShadow( Light LIGHT ) { return 1.0; }\n";var Ub=new e.ShaderBlock("depth_in_color");Ub.register();u.shadowmapping_depth_in_color_block=Ub;var sb=new e.ShaderBlock("testShadow");sb.addCode(GL.VERTEX_SHADER,u._shadowmap_vertex_enabled_code,u._shadowmap_vertex_disabled_code);sb.addCode(GL.FRAGMENT_SHADER,u._shadowmap_2d_enabled_fragment_code,u._shadowmap_2d_disabled_code);sb.register();u.shadowmapping_2d_shader_block=sb;u.registerShadowType("hard",sb);var Fb=
new e.ShaderBlock("testShadow2D_hard");Fb.addCode(GL.VERTEX_SHADER,u._shadowmap_vertex_enabled_code,u._shadowmap_vertex_disabled_code);Fb.addCode(GL.FRAGMENT_SHADER,u._shadowmap_2d_enabled_code,"");Fb.register();u.shadowmapping_2D_hard_shader_block=Fb;var Gb=new e.ShaderBlock("testShadow2D_soft");Gb.addCode(GL.VERTEX_SHADER,u._shadowmap_vertex_enabled_code,u._shadowmap_vertex_disabled_code);Gb.addCode(GL.FRAGMENT_SHADER,u._shadowmap_2d_enabled_code,"");Gb.register();u.shadowmapping_2D_soft_block=
Gb;var wb=new e.ShaderBlock("environment_cubemap");wb.addCode(GL.FRAGMENT_SHADER,"\n\t#ifdef ENVIRONMENT_TEXTURE\n\t\tuniform sampler2D environment_texture;\n\t#endif\n\t#ifdef ENVIRONMENT_CUBEMAP\n\t\tuniform samplerCube environment_texture;\n\t#endif\n\tvec2 polarToCartesian(in vec3 V)\n\t{\n\t\treturn vec2( 0.5 - (atan(V.z, V.x) / -6.28318531), asin(V.y) / 1.57079633 * 0.5 + 0.5);\n\t}\n\t\n\tvec3 getEnvironmentColor( vec3 V, float area )\n\t{\n\t\t#ifdef ENVIRONMENT_TEXTURE\n\t\t\tvec2 uvs = polarToCartesian(V);\n\t\t\treturn texture2D( environment_texture, uvs ).xyz;\n\t\t#endif\n\t\t#ifdef ENVIRONMENT_CUBEMAP\n\t\t\treturn textureCube( environment_texture, -V ).xyz;\n\t\t#endif\n\t\treturn u_background_color.xyz;\n\t}\n",
"\n\tvec3 getEnvironmentColor( vec3 V, float area )\n\t{\n\t\treturn u_background_color.xyz;\n\t}\n",{ENVIRONMENT_CUBEMAP:""});wb.defineContextMacros({ENVIRONMENTBLOCK:"environment_cubemap"});wb.register();var vb=new e.ShaderBlock("environment_2D");vb.defineContextMacros({ENVIRONMENTBLOCK:"environment_2D"});vb.addCode(GL.FRAGMENT_SHADER,"\n\t#ifdef ENVIRONMENT_TEXTURE\n\t\tuniform sampler2D environment_texture;\n\t#endif\n\t#ifdef ENVIRONMENT_CUBEMAP\n\t\tuniform samplerCube environment_texture;\n\t#endif\n\tvec2 polarToCartesian(in vec3 V)\n\t{\n\t\treturn vec2( 0.5 - (atan(V.z, V.x) / -6.28318531), asin(V.y) / 1.57079633 * 0.5 + 0.5);\n\t}\n\t\n\tvec3 getEnvironmentColor( vec3 V, float area )\n\t{\n\t\t#ifdef ENVIRONMENT_TEXTURE\n\t\t\tvec2 uvs = polarToCartesian(V);\n\t\t\treturn texture2D( environment_texture, uvs ).xyz;\n\t\t#endif\n\t\t#ifdef ENVIRONMENT_CUBEMAP\n\t\t\treturn textureCube( environment_texture, -V ).xyz;\n\t\t#endif\n\t\treturn u_background_color.xyz;\n\t}\n",
"\n\tvec3 getEnvironmentColor( vec3 V, float area )\n\t{\n\t\treturn u_background_color.xyz;\n\t}\n",{ENVIRONMENT_TEXTURE:""});vb.register();var Vb=new e.ShaderBlock("environment");Vb.addCode(GL.FRAGMENT_SHADER,"\n\t#ifdef ENVIRONMENT_TEXTURE\n\t\tuniform sampler2D environment_texture;\n\t#endif\n\t#ifdef ENVIRONMENT_CUBEMAP\n\t\tuniform samplerCube environment_texture;\n\t#endif\n\tvec2 polarToCartesian(in vec3 V)\n\t{\n\t\treturn vec2( 0.5 - (atan(V.z, V.x) / -6.28318531), asin(V.y) / 1.57079633 * 0.5 + 0.5);\n\t}\n\t\n\tvec3 getEnvironmentColor( vec3 V, float area )\n\t{\n\t\t#ifdef ENVIRONMENT_TEXTURE\n\t\t\tvec2 uvs = polarToCartesian(V);\n\t\t\treturn texture2D( environment_texture, uvs ).xyz;\n\t\t#endif\n\t\t#ifdef ENVIRONMENT_CUBEMAP\n\t\t\treturn textureCube( environment_texture, -V ).xyz;\n\t\t#endif\n\t\treturn u_background_color.xyz;\n\t}\n",
"\n\tvec3 getEnvironmentColor( vec3 V, float area )\n\t{\n\t\treturn u_background_color.xyz;\n\t}\n");Vb.register();var Pb=new e.ShaderBlock("applyReflection");R.reflection_block=Pb;Pb.addCode(GL.FRAGMENT_SHADER,'\n\t#pragma shaderblock ENVIRONMENTBLOCK "environment"\n\t\n\tvec4 applyReflection( Input IN, SurfaceOutput o, vec4 final_color )\n\t{\n\t\tvec3 R = reflect( IN.viewDir, o.Normal );\n\t\tvec3 bg = vec3(0.0);\n\t\t//is last pass for this object?\n\t\tif(u_light_info.w == 0.0 || u_light_info.z == (u_light_info.w - 1.0))\n\t\t\tbg = getEnvironmentColor( R, 0.0 );\n\t\tfinal_color.xyz = mix( final_color.xyz, bg, clamp( o.Reflectivity, 0.0, 1.0) );\n\t\treturn final_color;\n\t}\n',
"\n\tvec4 applyReflection( Input IN, SurfaceOutput o, vec4 final_color )\n\t{\n\t\treturn final_color;\n\t}\n");Pb.register();var xb=new e.ShaderBlock("applyIrradiance");R.irradiance_block=xb;xb.addCode(GL.FRAGMENT_SHADER,"\n\tuniform samplerCube irradiance_texture;\n\t\n\tvoid applyIrradiance( in SurfaceOutput o, inout FinalLight FINALLIGHT )\n\t{\n\t\tFINALLIGHT.Ambient *= textureCube( irradiance_texture, o.Normal ).xyz;\n\t}\n","\n\tvoid applyIrradiance( in SurfaceOutput o, inout FinalLight FINALLIGHT )\n\t{\n\t}\n");
xb.register();e.Formats={supported:{},safe_parsing:!1,merge_smoothgroups:!1,addSupportedFormat:function(a,b){a.constructor===String&&(a=a.split(","));for(var c=0;c<a.length;++c){var d=a[c].toLowerCase();this.supported[d]&&console.warn("There is already another parser associated to this extension: "+d);this.supported[d]=b}},parse:function(a,b,c){c=c||{};var d=this.getFileFormatInfo(a);if(!d)return null;d.extension=c.extension?c.extension:e.ResourcesManager.getExtension(a);var f=this.supported[d.extension];
if(!f||!f.parse)return console.error("Parser Error: No parser found for "+d.extension+" format"),null;d=null;if(this.safe_parsing)try{d=f.parse(b,c,a)}catch(h){return console.error("Error parsing content",h),null}else d=f.parse(b,c,a);d&&(d.name=a);return d},TEXT_FORMAT:"text",JSON_FORMAT:"json",XML_FORMAT:"xml",BINARY_FORMAT:"binary",MESH_DATA:"MESH",IMAGE_DATA:"IMAGE",NONATIVE_IMAGE_DATA:"NONATIVE_IMAGE",SCENE_DATA:"SCENE",GENERIC_DATA:"GENERIC",getFileFormatInfo:function(a){a=a.substr(a.lastIndexOf(".")+
1).toLowerCase();return this.supported[a]},guessType:function(a){if(!a)return null;a=e.RM.getExtension(a).toLowerCase();return(a=this.supported[a])?a.resource:null},convertToDataURL:function(a){var b=document.createElement("canvas");b.width=a.width;b.height=a.height;var c=b.getContext("2d"),d=c.createImageData(a.width,a.height);if(3==a.bytesPerPixel)for(var e=0;e<b.width;++e)for(var h=0;h<b.height;++h){var g=h*b.width*4+4*e,k=(b.height-h-1)*b.width*3+3*e;d.data[g+2]=a.pixels[k];d.data[g+1]=a.pixels[k+
1];d.data[g+0]=a.pixels[k+2];d.data[g+3]=255}else for(e=0;e<b.width;++e)for(h=0;h<b.height;++h)g=h*b.width*4+4*e,k=(b.height-h-1)*b.width*4+4*e,d.data[g+0]=a.pixels[k+2],d.data[g+1]=a.pixels[k+1],d.data[g+2]=a.pixels[k+0],d.data[g+3]=a.pixels[k+3];c.putImageData(d,0,0);a.dataurl=b.toDataURL("image/png");return a.dataurl},computeMeshBounding:function(a){for(var b=[a[0],a[1],a[2]],c=[a[0],a[1],a[2]],d=0;d<a.length;d+=3){var e=[a[d],a[d+1],a[d+2]];e[0]<b[0]?b[0]=e[0]:e[0]>c[0]&&(c[0]=e[0]);e[1]<b[1]?
b[1]=e[1]:e[1]>c[1]&&(c[1]=e[1]);e[2]<b[2]?b[2]=e[2]:e[2]>c[2]&&(c[2]=e[2])}a=[0.5*(b[0]+c[0]),0.5*(b[1]+c[1]),0.5*(b[2]+c[2])];b=[b[0]-a[0],b[1]-a[1],b[2]-a[2]];return BBox.setCenterHalfsize(BBox.create(),a,b)}};e.Formats.addSupportedFormat("png,jpg,jpeg,webp,bmp,gif",{"native":!0,dataType:"arraybuffer",resource:"Texture",resourceClass:GL.Texture,has_preview:!0,type:"image"});e.Formats.addSupportedFormat("wbin",{dataType:"arraybuffer"});e.Formats.addSupportedFormat("json,js,txt,html,css,csv",{dataType:"text"});
e.Formats.addSupportedFormat("glsl",{dataType:"text",resource:"ShaderCode",resourceClass:e.ShaderCode});e.Formats.addSupportedFormat("zip",{dataType:"arraybuffer"});WBin.classes=e.Classes;e.Formats.addSupportedFormat("ase",{extension:"ase",type:"mesh",resource:"Mesh",format:"text",dataType:"text",parse:function(a,b,c){b=b||{};var d=[],f=[];c=[];var h=null,g=[],k=[],m=null,m=null,l=0,n=-1,p=null,q=[],r=this.flipAxis;null!=b.flipAxis&&(r=b.flipAxis);b=r||b.flipNormals;a=a.split("\n");for(var s=0;s<
a.length;++s)if(m=a[s].replace(/[ \t]+/g," ").replace(/\s\s*$/,"")," "==m[0]&&(m=m.substr(1,m.length)),""!=m)if(m=m.split(" "),"*MESH"==m[0]){if(l+=1,g=[],1<l)break}else if("*NODE_NAME"==m[0])m[1].substr(1,m[1].length-2);else if("*MESH_VERTEX"==m[0])r?g.push([-1*parseFloat(m[2]),parseFloat(m[4]),parseFloat(m[3])]):g.push([parseFloat(m[2]),parseFloat(m[3]),parseFloat(m[4])]);else if("*MESH_FACE"==m[0]){var t=parseInt(m[17]);n!=t&&(n=t,null!=p&&(p.length=d.length/3-p.start,0<p.length&&q.push(p)),p=
{name:"mat_"+t,start:d.length/3,length:-1,material:""});t=g[parseInt(m[3])];d.push(t[0],t[1],t[2]);t=g[parseInt(m[5])];d.push(t[0],t[1],t[2]);t=g[parseInt(m[7])];d.push(t[0],t[1],t[2])}else"*MESH_TVERTLIST"==m[0]?k=[]:"*MESH_TVERT"==m[0]?k.push([parseFloat(m[2]),parseFloat(m[3])]):"*MESH_TFACELIST"==m[0]?(h&&h.length&&c.push(h),h=[]):"*MESH_TFACE"==m[0]?(t=k[parseInt(m[2])],h.push(t[0],t[1]),t=k[parseInt(m[3])],h.push(t[0],t[1]),t=k[parseInt(m[4])],h.push(t[0],t[1])):"*MESH_MAPPINGCHANNEL"==m[0]?
(h&&c.push(h),h=[]):"*MESH_VERTEXNORMAL"==m[0]&&(b?f.push(-1*parseFloat(m[2]),parseFloat(m[4]),parseFloat(m[3])):f.push(parseFloat(m[2]),parseFloat(m[3]),parseFloat(m[4])));h&&c.push(h);h=d.length/3-p.start;p&&1<h&&(p.length=h,q.push(p));p={info:{}};p.vertices=new Float32Array(d);0<f.length&&(p.normals=new Float32Array(f));for(d=0;d<c.length;++d)f="",0<d&&(f=d+1),p["coords"+f]=new Float32Array(c[d]);p.bounding=e.Formats.computeMeshBounding(p.vertices);1<q.length&&(p.info.groups=q);return p}});e.Formats.addSupportedFormat("bvh",
{extension:"bvh",type:"scene",resource:"Scene",format:"text",dataType:"text",parse:function(a,b,c){var d=0,f=b=null,h=null,g=[],k=[],m=-1,l=-1,n=-1,p=0,q=[],r={Xposition:"x",Yposition:"y",Zposition:"z",Xrotation:"xrotation",Yrotation:"yrotation",Zrotation:"zrotation"},s=!1;a=a.split("\n");for(var t=a.length,K=0;K<t;++K){var G=a[K].trim();if("#"!=G[0]&&""!=G)if(G=G.split(/[\s]+/),f=G[0],!d)switch(f){case "HIERARCHY":d=1}else if(1==d)switch(f){case "ROOT":h=G[1];h=h.replace(/[^a-z0-9\.\-]/gi,"_");b=
h={name:h,node_type:"JOINT"};break;case "JOINT":f=h;g.push(f);h=G[1];h=h.replace(/[^a-z0-9\.\-]/gi,"_");h={name:h,node_type:"JOINT"};f.children||(f.children=[]);f.children.push(h);break;case "End":f=h;g.push(f);h={name:f.name+"_end",node_type:"JOINT"};f.children||(f.children=[]);f.children.push(h);break;case "}":s?s=!1:(h=g.pop())||(h=b);break;case "CHANNELS":for(f=2;f<G.length;++f){var u=G[f].toLowerCase();r[u]&&(u=r[u]);var C={node:h,property:u,data:[]};k.push(C);h._channels||(h._channels={});h._channels_order||
(h._channels_order=[]);h._channels[u]=C;h._channels_order.push(u)}break;case "OFFSET":f=h;G=G.slice(1).map(parseFloat);f.transform={position:G};break;case "MOTION":d=2}else if(2==d)"Frames:"==G[0]?m=parseInt(G[1]):"Frame"==G[0]&&"Time:"==G[1]&&(l=parseFloat(G[2])),-1!=m&&-1!=l&&(n=m*l,d=3);else if(3==d){q.push(p*l);for(f=0;f<k.length;++f)k[f].data.push(parseFloat(G[f]));++p}}d=[];this.processMotion(b,d,q);q={root:b,object_class:"SceneNode",resources:{}};for(g=0;g<d.length;++g)d[g].duration=n;c={name:e.ResourcesManager.getBasename(c)+
"_animation.wbin",object_class:"Animation",takes:{"default":{name:"default",duration:n,tracks:d}}};b.animation=c.name;q.resources[c.name]=c;console.log(q);return q},processMotion:function(a,b,c){var d=a._channels;if(d){var e=null,h=null,g=vec3.fromValues(1,0,0),k=vec3.fromValues(0,1,0),m=vec3.fromValues(0,0,1);if(d.xposition||d.yposition||d.zposition)e={name:a.name+"/Transform/position",property:a.name+"/Transform/position",type:"vec3",value_size:3,data:[],packed_data:!0};if(d.xrotation||d.yrotation||
d.zrotation)h={name:a.name+"/Transform/rotation",property:a.name+"/Transform/rotation",type:"quat",value_size:4,data:[],packed_data:!0};for(var l=0;l<c.length;++l){for(var n=c[l],p=vec3.create(),q=quat.create(),r=quat.create(),s=0;s<a._channels_order.length;++s)switch(a._channels_order[s]){case "xposition":p[0]=d.xposition.data[l]+a.transform.position[0];break;case "yposition":p[1]=d.yposition.data[l]+a.transform.position[1];break;case "zposition":p[2]=d.zposition.data[l]+a.transform.position[2];
break;case "xrotation":quat.setAxisAngle(r,g,d.xrotation.data[l]*DEG2RAD);quat.mul(q,q,r);break;case "yrotation":quat.setAxisAngle(r,k,d.yrotation.data[l]*DEG2RAD);quat.mul(q,q,r);break;case "zrotation":quat.setAxisAngle(r,m,d.zrotation.data[l]*DEG2RAD),quat.mul(q,q,r)}e&&e.data.push(n,p[0],p[1],p[2]);h&&h.data.push(n,q[0],q[1],q[2],q[3])}e&&b.push(e);h&&b.push(h)}if(a.children)for(s=0;s<a.children.length;++s)this.processMotion(a.children[s],b,c)}});(function(a){function b(a,b){var c=new XMLHttpRequest;
c.onload=function(){200==this.status&&b&&b(this.response)};-1==a.indexOf("://")&&(a=Collada.dataPath+a);c.open("get",a,!0);c.send()}var c=void 0===a.document,d=2*Math.PI/360;c&&(a.console={log:function(a){var b=Array.prototype.slice.call(arguments,0);self.postMessage({action:"log",params:b})},warn:function(a){var b=Array.prototype.slice.call(arguments,0);self.postMessage({action:"warn",params:b})},error:function(a){var b=Array.prototype.slice.call(arguments,0);self.postMessage({action:"error",params:b})}},
a.alert=console.error);a.Collada={libsPath:"./",workerPath:"./",no_flip:!0,use_transferables:!0,onerror:null,verbose:!1,config:{forceParser:!1},init:function(a){a=a||{};for(var b in a)this[b]=a[b];this.config=a;if(c)try{importScripts(this.libsPath+"gl-matrix-min.js",this.libsPath+"tinyxml.js")}catch(d){Collada.throwException(Collada.LIBMISSING_ERROR)}mat4.create();vec3.create();vec3.create();vec3.create();quat.create();c&&console.log("Collada worker ready")},load:function(a,c){b(a,function(a){a?c(Collada.parse(a)):
c(null)})},_xmlroot:null,_nodes_by_id:null,_nodes_by_sid:null,_transferables:null,_controllers_found:null,_geometries_found:null,safeString:function(a){return a?this.convertID?this.convertID(a):a.replace(/ /g,"_"):""},LIBMISSING_ERROR:"Libraries loading error, when using workers remember to pass the URL to the tinyxml.js in the options.libsPath",NOXMLPARSER_ERROR:"TinyXML not found, when using workers remember to pass the URL to the tinyxml.js in the options.libsPath (Workers do not allow to access the native XML DOMParser)",
throwException:function(a){if(c)self.postMessage({action:"exception",msg:a});else if(Collada.onerror)Collada.onerror(a);throw a;},getFilename:function(a){var b=a.lastIndexOf("\\");-1!=b&&(a=a.substr(b+1));b=a.lastIndexOf("/");-1!=b&&(a=a.substr(b+1));return a},last_name:0,generateName:function(a){a=(a||"name_")+this.last_name;this.last_name++;return a},parse:function(b,c,d){d=d||"_dae_"+Date.now()+".dae";var e=null;c=null;this._transferables=[];this.verbose&&console.log(" - XML parsing...");if(a.DOMParser&&
!this.config.forceParser)e=new DOMParser,c=e.parseFromString(b,"text/xml"),this.verbose&&console.log(" - XML parsed");else{if(!a.DOMImplementation)return Collada.throwException(Collada.NOXMLPARSER_ERROR);try{e=new DOMImplementation}catch(m){return Collada.throwException(Collada.NOXMLPARSER_ERROR)}c=e.loadXML(b);this.verbose&&console.log(" - XML parsed");b=c._nodes_by_id={};for(var e=0,l=c.all.length;e<l;++e){var n=c.all[e];b[n.id]=n;n.getAttribute("sid")&&(b[n.getAttribute("sid")]=n)}this.extra_functions||
(this.extra_functions=!0,DOMDocument.prototype.querySelector=DOMElement.prototype.querySelector=function(a){a=a.split(" ");for(var b=this;a.length;){var c=a.shift().split("#"),d=c[0],c=c[1],d=d?b.getElementsByTagName(d):b.childNodes;if(c)for(var e=0;e<d.length;e++){if(d.item(e).getAttribute("id")==c){if(0==a.length)return d.item(e);b=d.item(e);break}}else{if(0==a.length)return d.item(0);b=d.item(0)}}return null},DOMDocument.prototype.querySelectorAll=DOMElement.prototype.querySelectorAll=function(a){function b(a,
c){if(c){var e=c.shift(),e=a.getElementsByTagName(e);if(0==c.length)for(var f=0;f<e.length;f++)d.push(e.item(f));else for(f=0;f<e.length;f++)b(e.item(f),c.concat())}}var c=a.split(" ");if(1==c.length)return this.getElementsByTagName(a);var d=[];b(this,c);a=new DOMNodeList(this.documentElement);a._nodes=d;a.length=d.length;return a},Object.defineProperty(DOMElement.prototype,"textContent",{get:function(){return this.getChildNodes().item(0).toString()},set:function(){}}))}this._xmlroot=c;if(b=c.querySelector("COLLADA"))this._current_DAE_version=
b.getAttribute("version"),console.log("DAE Version:"+this._current_DAE_version);e=c.getElementsByTagName("visual_scene").item(0);if(!e)throw"visual_scene XML node not found in DAE";this._nodes_by_id={};this._nodes_by_sid={};this._controllers_found={};this._geometries_found={};b={object_class:"Scene",light:null,materials:{},meshes:{},resources:{},root:{children:[]},external_files:{}};if(n=c.getElementsByTagName("asset")[0])b.metadata=this.readAsset(n);l=e.childNodes;for(e=0;e<l.length;e++){var p=l.item(e);
1==p.nodeType&&(n=null,"node"==p.localName?n=this.readNodeTree(p,b,0,!1):console.warn("DAE contains unknown node type: "+p.localName),n&&b.root.children.push(n))}for(e=0;e<l.length;e++)"node"==l.item(e).localName&&this.readNodeInfo(l.item(e),b,0,!1);this.readLibraryControllers(b);if(e=this.readAnimations(c,b))d="animations_"+d.substr(0,d.indexOf(".")),b.resources[d]=e,b.root.animation=d;b.images=this.readImages(c);this._nodes_by_id={};this._nodes_by_sid={};this._controllers_found={};this._geometries_found=
{};this._xmlroot=null;return b},readAsset:function(a){for(var b={},c=0;c<a.childNodes.length;c++){var d=a.childNodes.item(c);if(1==d.nodeType)switch(d.localName){case "contributor":if(d=d.querySelector("authoring_tool"))b.authoring_tool=d.textContext;break;case "unit":b.unit=d.getAttribute("name");break;default:b[d.localName]=d.textContent}}return b},readNodeTree:function(a,b,c,d){var e=this.safeString(a.getAttribute("id")),l=this.safeString(a.getAttribute("sid")),n=this.safeString(a.getAttribute("name")),
p=e||l||n;if(!p)return console.warn("Collada: node without name or id, skipping it"),null;var n={name:n,id:p,sid:l,children:[],_depth:c},q=a.getAttribute("type");q&&(n.type=q);this._nodes_by_id[p]=n;e&&(this._nodes_by_id[e]=n);l&&(this._nodes_by_sid[l]=n,this._nodes_by_id[l]=n);n.model=this.readTransform(a,c,d);for(e=0;e<a.childNodes.length;e++)if(p=a.childNodes.item(e),1==p.nodeType)"node"==p.localName?(l=this.readNodeTree(p,b,c+1,d))&&n.children.push(l):"instance_node"==p.localName&&(l=this._xmlroot.querySelector("library_nodes"))&&
(p=p.getAttribute("url"),p=p.replace(/\./gi,"\\."),(l=l.querySelector(p))?(l=this.readNodeTree(l,b,c+1,d))&&n.children.push(l):console.warn("instanced node not found:"+p));return n},readNodeInfo:function(a,b,c,d,e){var l=this.safeString(a.getAttribute("id")),n=this.safeString(a.getAttribute("sid")),p=this.safeString(a.getAttribute("name"));if(p=l||n||p)e=this._nodes_by_id[p];else if(e)e=this._nodes_by_id[e.id||e.sid||e.name];else return console.warn("Collada: node without name or id, skipping it"),
null;e||(e=this._nodes_by_sid[n]);if(!e)return console.warn("Collada: Node not found by id: "+(l||n)),null;for(l=0;l<a.childNodes.length;l++){var q=a.childNodes.item(l);if(1==q.nodeType)if("node"==q.localName)this.readNodeInfo(q,b,c+1,d,a);else if("instance_node"==q.localName)this.readInstancedNodeInfo(q,b,c+1,d,a);else if("instance_geometry"==q.localName){var n=q.getAttribute("url"),r=n.toString().substr(1);e.mesh?(e.meshes||(e.meshes=[e.mesh]),e.meshes.push(r)):e.mesh=r;if(b.meshes[n])console.warn("DAE node references mesh but not found: "+
n);else if(p=this.readGeometry(n,d))p.name=r,b.meshes[r]=p;if(n=q.querySelectorAll("instance_material"))for(q=0;q<n.length;++q)if(p=n.item(q)){r=p.getAttribute("target").toString().substr(1);if(!b.materials[r]){var s=this.readMaterial(r);s&&(s.id=r,b.materials[s.id]=s)}0==q?e.material=r:(e.materials||(e.materials=[]),e.materials.push(r))}else console.warn("instance_material not found: "+l)}else if("instance_controller"==q.localName)if(n=q.getAttribute("url"),n=n.replace(/\./gi,"\\."),p=this._xmlroot.querySelector("controller"+
n)){p=this.readController(p,d,b);if(q=q.querySelector("bind_material"))for(var t=q.querySelectorAll("technique_common"),K=0;K<t.length;K++)for(var G=t.item(K).querySelectorAll("instance_material"),q=0;q<G.length;q++)(r=G.item(q))?(r=r.getAttribute("target").toString().substr(1),!b.materials[r]&&(s=this.readMaterial(r))&&(s.id=r,b.materials[s.id]=s),0==q?e.material=r:(e.materials||(e.materials=[]),e.materials.push(r))):console.warn("instance_material for controller not found: "+r);p&&(q=p,"morph"==
p.type&&(q=p.mesh,e.morph_targets=p.morph_targets),q.name=n.toString(),e.mesh=n.toString(),b.meshes[n]=q)}else console.warn("DAE, node controller not found: "+n);else"instance_light"==q.localName?(n=q.getAttribute("url"),this.readLight(e,n)):"instance_camera"==q.localName&&(n=q.getAttribute("url"),this.readCamera(e,n))}},readInstancedNodeInfo:function(a,b,c,d,e){e=this._xmlroot.querySelector("library_nodes");if(!e)return!1;a=a.getAttribute("url");a=a.replace(/\./gi,"\\.");e=e.querySelector(a);if(!e)return console.warn("instanced node not found:"+
a),!1;this.readNodeInfo(e,b,c+1,d);return!0},material_translate_table:{},light_translate_table:{point:"omni",directional:"directional",spot:"spot"},camera_translate_table:{xfov:"fov",aspect_ratio:"aspect",znear:"near",zfar:"far"},querySelectorAndId:function(a,b,c){a=a.querySelectorAll(b);for(b=0;b<a.length;b++){var d=a.item(b).getAttribute("id");if(d&&(d=d.toString(),d==c))return a.item(b)}return null},getFirstChildElement:function(a,b){for(var c=a.childNodes,d=0;d<c.length;++d){var e=c.item(d);if(e.localName&&
!b||b&&b==e.localName)return e}return null},readMaterial:function(a){a=this.querySelectorAndId(this._xmlroot,"library_materials material",a);if(!a)return null;a=a.querySelector("instance_effect");if(!a)return null;a=a.getAttribute("url").substr(1);a=this.querySelectorAndId(this._xmlroot,"library_effects effect",a);if(!a)return null;var b=a.querySelector("technique");if(!b)return null;var c=a.querySelectorAll("newparam");a={};for(var d=0;d<c.length;d++){var e=c[d].querySelector("init_from"),l;if(!e&&
(e=c[d].querySelector("source"),!l)){console.warn("no source found for material for newparam");continue}l=e.innerHTML;a[c[d].getAttribute("sid")]={parent:l}}l={};c=this.readImages(this._xmlroot);(e=b.querySelector("phong"))||(e=b.querySelector("blinn"));e||(e=b.querySelector("lambert"));if(!e)return null;l.type=e.localName;for(d=0;d<e.childNodes.length;++d){var n=e.childNodes.item(d);if(n.localName){b=n.localName.toString();this.material_translate_table[b]&&(b=this.material_translate_table[b]);var p=
this.getFirstChildElement(n);if(p)if("color"==p.localName.toString()){p=this.readContentAsFloats(p);if(n=n.getAttribute("opaque"))l.opaque_info=n;l[b]="RGB_ZERO"==n?p.subarray(0,4):p.subarray(0,3)}else"float"==p.localName.toString()?l[b]=this.readContentAsFloats(p)[0]:"texture"==p.localName.toString()&&(l.textures||(l.textures={}),n=p.getAttribute("texture"))&&(-1===n.indexOf(".")&&(n=this.getParentParam(a,n),c[n]&&(n=c[n].path)),n={map_id:n},p=p.getAttribute("texcoord"),n.uvs=p,l.textures[b]=n)}}l.object_class=
"Material";return l},getParentParam:function(a,b){return a[b]?a[b].parent?this.getParentParam(a,a[b].parent):b:b},readLight:function(a,b){function c(a,b){for(var d=0;d<b.childNodes.length;d++){var e=b.childNodes.item(d);if(e&&1==e.nodeType)switch(e.localName){case "color":a.color=Collada.readContentAsFloats(e);break;case "falloff_angle":a.angle_end=Collada.readContentAsFloats(e)[0],a.angle=a.angle_end-10}}}var d={},e=null;if(1<b.length)e=this._xmlroot.querySelector("library_lights "+b);else var l=
this._xmlroot.querySelector("library_lights"),e=this.getFirstChildElement(l,"light");if(!e)return null;var l=[],n=e.querySelector("technique_common");if(n)for(var p=0;p<n.childNodes.length;p++)1==n.childNodes.item(p).nodeType&&l.push(n.childNodes.item(p));e=e.querySelectorAll("technique");for(p=0;p<e.length;p++)for(var n=e.item(p),q=0;q<n.childNodes.length;q++)1==n.childNodes.item(q).nodeType&&l.push(n.childNodes.item(q));for(p=0;p<l.length;p++)switch(n=l[p],n.localName){case "point":d.type=this.light_translate_table[n.localName];
c(d,n);break;case "directional":d.type=this.light_translate_table[n.localName];c(d,n);break;case "spot":d.type=this.light_translate_table[n.localName];c(d,n);break;case "intensity":d.intensity=this.readContentAsFloats(n)[0]}a.model?(d.position=[a.model[12],a.model[13],a.model[14]],l=[-a.model[8],-a.model[9],-a.model[10]],d.target=[d.position[0]+l[0],d.position[1]+l[1],d.position[2]+l[2]]):(console.warn("Could not read light position for light: "+a.name+". Setting defaults."),d.position=[0,0,0],d.target=
[0,-1,0]);a.light=d},readCamera:function(a,b){var c={},d=this._xmlroot.querySelector("library_cameras "+b);if(!d)return null;var e=[],l=d.querySelector("technique_common");if(l)for(d=0;d<l.childNodes.length;d++)1==l.childNodes.item(d).nodeType&&e.push(l.childNodes.item(d));for(d=0;d<e.length;d++)for(var l=c,n=e[d],p=0;p<n.childNodes.length;p++){var q=n.childNodes.item(p);q&&1==q.nodeType&&(l[Collada.camera_translate_table[q.localName]||q.localName]=parseFloat(q.textContent))}c.yfov&&!c.fov&&(c.aspect?
c.fov=c.yfov*c.aspect:console.warn("Could not convert camera yfov to xfov because aspect ratio not set"));a.camera=c},readTransform:function(a,b,c){for(var e=mat4.create(),m=mat4.create(),l=quat.create(),n=0;n<a.childNodes.length;n++){var p=a.childNodes.item(n);if(p&&1==p.nodeType){if("matrix"==p.localName){e=this.readContentAsFloats(p);this.transformMatrix(e,0==b);break}if("translate"==p.localName){var q=this.readContentAsFloats(p);c&&0<b&&(p=q[1],q[1]=q[2],q[2]=-p);mat4.translate(e,e,q)}else"rotate"==
p.localName?(q=this.readContentAsFloats(p),4==q.length&&("jointOrientX"==p.getAttribute("sid")&&(q[3]+=90),c&&(p=q[1],q[1]=q[2],q[2]=-p),0!=q[3]&&(quat.setAxisAngle(l,q.subarray(0,3),q[3]*d),mat4.fromQuat(m,l),mat4.multiply(e,e,m)))):"scale"==p.localName&&(q=this.readContentAsFloats(p),c&&(p=q[1],q[1]=q[2],q[2]=-p),mat4.scale(e,e,q))}}return e},readTransform2:function(a,b,c){for(var e=mat4.create(),m=quat.create(),l=mat4.create(),n=quat.create(),p=vec3.create(),q=vec3.fromValues(1,1,1),r=0;r<a.childNodes.length;r++){var s=
a.childNodes.item(r);if("matrix"==s.localName)return e=this.readContentAsFloats(s),this.transformMatrix(e,0==b),e;if("translate"==s.localName){var t=this.readContentAsFloats(s);p.set(t)}else"rotate"==s.localName?(t=this.readContentAsFloats(s),4==t.length&&("jointOrientX"==s.getAttribute("sid")&&(t[3]+=90),c&&(s=t[1],t[1]=t[2],t[2]=-s),0!=t[3]&&(quat.setAxisAngle(n,t.subarray(0,3),t[3]*d),quat.multiply(m,m,n)))):"scale"==s.localName&&(t=this.readContentAsFloats(s),c&&(s=t[1],t[1]=t[2],t[2]=-s),q.set(t))}c&&
0<b&&(s=p[1],p[1]=p[2],p[2]=-s);mat4.translate(e,e,p);mat4.fromQuat(l,m);mat4.multiply(e,e,l);mat4.scale(e,e,q);return e},readGeometry:function(a,b,d){if(void 0!==this._geometries_found[a])return this._geometries_found[a];var e=this._xmlroot.getElementById(a.substr(1));if(!e)return console.warn("readGeometry: geometry not found: "+a),this._geometries_found[a]=null;if("controller"==e.localName)return e=this.readController(e,b,d),this._geometries_found[a]=e;if("geometry"!=e.localName)return console.warn("readGeometry: tag should be geometry, instead it was found: "+
e.localName),this._geometries_found[a]=null;d=e.querySelector("mesh");if(!d)return console.warn("readGeometry: mesh not found in geometry: "+a),this._geometries_found[a]=null;for(var m=e.sources={},l=d.querySelectorAll("source"),e=0;e<l.length;e++){var n=l.item(e);if(n.querySelector){var p=n.querySelector("float_array");if(p){var p=this.readContentAsFloats(p),q=n.querySelector("accessor"),r=parseInt(q.getAttribute("stride")),q=q.querySelector("param");m[n.getAttribute("id")]={stride:r,data:p,params:q.length}}}}l=
d.querySelector("vertices input");l=m[l.getAttribute("source").substr(1)];m[d.querySelector("vertices").getAttribute("id")]=l;l=null;(n=d.querySelector("polygons"))&&(l=this.readPolygons(n,m));l||(n=d.querySelectorAll("triangles"))&&n.length&&(l=this.readTriangles(n,m));l||(n=d.querySelectorAll("polylist"))&&n.length&&(l=this.readPolylistArray(n,m));l||(d=d.querySelector("linestrips"))&&(l=this.readLineStrip(m,d));if(!l)return console.log("no polygons or triangles in mesh: "+a),this._geometries_found[a]=
null;if(b&&!this.no_flip){b=0;d=l.vertices;e=0;for(m=d.length;e<m;e+=3)b=d[e+1],d[e+1]=d[e+2],d[e+2]=-b;d=l.normals;e=0;for(m=d.length;e<m;e+=3)b=d[e+1],d[e+1]=d[e+2],d[e+2]=-b}if(c&&this.use_transferables)for(e in l)(b=l[e])&&b.buffer&&100<b.length&&this._transferables.push(b.buffer);l.filename=a;l.object_class="Mesh";return this._geometries_found[a]=l},readPolygons:function(a,b){for(var c=[],d=0,e={},l=[],n=[],p=a.getAttribute("material"),q=[],r=[],s=0;s<a.childNodes.length;s++){var t=a.childNodes.item(s);
if("input"==t.localName){var u=this.readInput(t,b);u&&q.push(u)}else"p"==t.localName?r.push(t):t.localName&&console.warn("unknown xml tag in <polygons>: "+t.localName)}for(var t=1,G=q.length,s=0;s<G;++s)t=Math.max(t,q[s][4]+1);for(s=0;s<r.length;s++){var w=r[s];if(!w||!w.textContent)break;for(var w=w.textContent.trim().split(" "),C=-1,x=u=-1,y=0,z=w.length;y<z;y+=t){var D=w.slice(y,y+t).join(" "),x=u;if(e.hasOwnProperty(D))u=e[D];else{for(var A=0;A<G;++A){var u=q[A],E=u[1],B=u[3],H=parseInt(w[y+u[4]]);
0==A&&(l[E.length/u[2]]=H);for(var H=H*u[2],F=0;F<u[2];++F)E.push(B[H+F])}u=d;d+=1;e[D]=u}0==y&&(C=u);2<y/t&&(n.push(C),n.push(x));n.push(u)}}c.push({name:"group",start:0,length:n.length-0,material:p||""});if(!q.length)return console.warn("collada: <polygon> without buffers"),null;c={vertices:new Float32Array(q[0][1]),info:{groups:c},_remap:new Uint32Array(l)};this.transformMeshInfo(c,q,n);return c},readTriangles:function(a,b){for(var c=[],d=[],e=0,l={},n=[],p=[],q=0,r="",s=0;s<a.length;s++){var t=
a.item(s),r=t.getAttribute("material");parseFloat(t.getAttribute("count"));0==s&&(d=this.readShapeInputs(t,b));for(var t=t.querySelectorAll("p"),u=1,G=d.length,w=0;w<G;++w)u=Math.max(u,d[w][4]+1);for(w=0;w<t.length;w++){var C=t.item(w);if(!C||!C.textContent)break;for(var C=C.textContent.trim().split(" "),y=-1,x=0,z=C.length;x<z;x+=u){var D=C.slice(x,x+u).join(" ");if(l.hasOwnProperty(D))y=l[D];else{for(y=0;y<G;++y){var A=d[y],E=A[1],H=A[3],B=parseInt(C[x+A[4]]);0==y&&(n[E.length/A[2]]=B);for(var B=
B*A[2],F=0;F<A[2];++F)E.push(H[B+F])}y=e;e+=1;l[D]=y}p.push(y)}}r={name:"group"+s,start:q,length:p.length-q,material:r||""};q=p.length;c.push(r)}if(!d.length)return null;c={vertices:new Float32Array(d[0][1]),info:{groups:c},_remap:new Uint32Array(n)};this.transformMeshInfo(c,d,p);return c},readPolylistArray:function(a,b){for(var c=[],d=0;d<a.length;++d){var e=this.readPolylist(a[d],b);e&&c.push(e)}return 2>c.length?c[0]:e=this.mergeMeshes(c)},readPolylist:function(a,b){for(var c=[],d=0,e={},l=[],
n=[],p="",p=a.getAttribute("material")||"",c=this.readShapeInputs(a,b),q=a.querySelector("vcount"),q=this.readContentAsUInt32(q),r=a.querySelector("p"),r=this.readContentAsUInt32(r),s=0,t=1,u=c.length,G=0;G<u;++G)t=Math.max(t,c[G][4]+1);for(var G=0,w=q.length;G<w;++G){var C=q[G],y=-1,x=-1,z=-1;if(s>=r.length){console.warn("DAE has wrong number of polygons in polylist");break}for(var A=0;A<C;++A){var D=r.slice(s,s+t).join(" "),z=x;if(e.hasOwnProperty(D))x=e[D];else{for(x=0;x<u;++x){var E=c[x],B=E[1],
H=E[3],F=parseInt(r[s+E[4]]);0==x&&(l[B.length/E[2]]=F);for(var F=F*E[2],I=0;I<E[2];++I)B.push(H[F+I])}x=d;d+=1;e[D]=x}3<C&&(0==A&&(y=x),2<A&&(n.push(y),n.push(z)));n.push(x);s+=t}}d={vertices:new Float32Array(c[0][1]),info:{material:p},_remap:new Uint32Array(l)};this.transformMeshInfo(d,c,n);return d},readShapeInputs:function(a,b){for(var c=[],d=a.querySelectorAll("input"),e=0;e<d.length;e++){var l=d.item(e);l.getAttribute&&((l=this.readInput(l,b))?c.push(l):console.warn("no buffer in collada"))}return c},
readInput:function(a,b){if(!a.getAttribute)return null;var c=a.getAttribute("source").substr(1),d=null;if(-1!=c.indexOf("/")){var e=c.split("/"),l=this._xmlroot.getElementById(e[0]);l&&l.sources&&(d=l.sources[e[1]])}else d=b[c];if(!d)return console.warn("<input> source not found: "+c),null;c=a.getAttribute("semantic").toUpperCase();e=parseInt(a.getAttribute("offset"));l=0;a.getAttribute("set")&&(l=parseInt(a.getAttribute("set")));return[c,[],d.stride,d.data,e,l]},transformMeshInfo:function(a,b,c){for(var d=
{normal:"normals",texcoord:"coords"},e=1;e<b.length;++e){var l=b[e][0].toLowerCase(),n=b[e][1];n.length&&(d[l]&&(l=d[l]),a[l]&&(l+=b[e][5]),a[l]=new Float32Array(n))}c&&c.length&&(a.triangles=65536<a.vertices.length?new Uint32Array(c):new Uint16Array(c));return a},readLineStrip:function(a,b){for(var c=[],d=0,e={},l=[],n=b.querySelectorAll("input"),p=0;p<n.length;p++){var q=n.item(p);if(q.getAttribute){var r=q.getAttribute("semantic").toUpperCase(),s=a[q.getAttribute("source").substr(1)],t=parseInt(q.getAttribute("offset")),
u=0;q.getAttribute("set")&&(u=parseInt(q.getAttribute("set")));c.push([r,[],s.stride,s.data,t,u])}}n=b.querySelectorAll("p");q=c.length;for(p=0;p<n.length;p++){r=n.item(p);if(!r||!r.textContent)break;for(var r=r.textContent.trim().split(" "),G=-1,s=0,t=r.length;s<t;s+=q){u=r.slice(s,s+q).join(" ");if(e.hasOwnProperty(u))G=e[u];else{for(G=0;G<c.length;++G)for(var w=c[G],C=parseInt(r[s+G]),x=w[1],y=w[3],C=C*w[2],z=0;z<w[2];++z)x.push(y[C+z]);G=d;d+=1;e[u]=G}l.push(G)}}d={primitive:"line_strip",vertices:new Float32Array(c[0][1]),
info:{}};return this.transformMeshInfo(d,c,l)},findXMLNodeById:function(a,b,c){if(this._xmlroot._nodes_by_id){var d=this._xmlroot._nodes_by_id[c];if(d&&d.localName==b)return d}else if(d=this._xmlroot.getElementById(c))return d;a=a.childNodes;for(d=0;d<a.length;++d){var e=a.item(d);if(1==e.nodeType&&e.localName==b&&e.getAttribute("id")==c)return e}return null},readImages:function(a){var b=a.querySelector("library_images");if(!b)return null;a={};for(var b=b.childNodes,c=0;c<b.length;++c){var d=b.item(c);
if(1==d.nodeType){var e=d.querySelector("init_from");if(e&&e.textContent){var l=this.getFilename(e.textContent),n=d.getAttribute("id");a[n]={filename:l,map:n,name:d.getAttribute("name"),path:e.textContent}}}}return a},readAnimations:function(a,b){var c=a.querySelector("library_animations");if(!c)return null;for(var d=c.childNodes,c={object_class:"Animation",takes:{}},e={tracks:[]},l=e.tracks,n=0;n<d.length;++n){var p=d.item(n);if(1==p.nodeType&&"animation"==p.localName)if(p.getAttribute("id"))this.readAnimation(p,
l);else{var q=p.querySelectorAll("animation");if(q.length)for(p=0;p<q.length;++p){var r=q.item(p);this.readAnimation(r,l)}else this.readAnimation(p,l)}}if(!l.length)return null;for(n=d=0;n<l.length;++n)d<l[n].duration&&(d=l[n].duration);e.name="default";e.duration=d;c.takes[e.name]=e;return c},readAnimation:function(a,b){if("animation"!=a.localName)return null;a.getAttribute("id");var c=a.querySelectorAll("channel");if(!c.length)return null;for(var d=b||[],e=0;e<c.length;++e){var l=this.readChannel(c.item(e),
a);l&&d.push(l)}return d},readChannel:function(a,b){if("channel"!=a.localName||"animation"!=b.localName)return null;var d=a.getAttribute("source"),e=a.getAttribute("target"),m=this.findXMLNodeById(b,"sampler",d.substr(1));if(!m)return console.error("Error DAE: Sampler not found in "+d),null;for(var d={},l={},n={},p=m.querySelectorAll("input"),m=null,q=0;q<p.length;q++){var r=p.item(q),s=r.getAttribute("source"),t=r.getAttribute("semantic"),u=this.findXMLNodeById(b,"source",s.substr(1));if(u){var w=
u.querySelector("param");if(w){r=w.getAttribute("type");d[t]={source:s,type:r};var x=null;if("float"==r||"float4x4"==r)x=u.querySelector("float_array"),x=this.readContentAsFloats(x),n[s]=x,s=w.getAttribute("name"),"TIME"==s&&(m=x),"OUTPUT"==t&&(s=t),s?l[s]=r:console.warn("Collada: <param> without name attribute in <animation>")}}}if(!m)return console.error("Error DAE: no TIME info found in <channel>: "+a.getAttribute("source")),null;q=e.split("/");e={};r=this.safeString(q[0]);p=this._nodes_by_id[r];
if(!p)return console.warn("Node target '"+r+"' not found reading animation channel"),null;r=p.id+"/"+q[1];e.name=q[1];e.property=r;r="number";s=1;l=l.OUTPUT;switch(l){case "float":s=1;break;case "float3x3":s=9;r="mat3";break;case "float4x4":s=16,r="mat4"}e.type=r;e.value_size=s;e.duration=m[m.length-1];d=n[d.OUTPUT.source];if(!d)return null;n=s+1;r=new Float32Array(m.length*n);for(q=0;q<m.length;++q)r[q*n]=m[q],t=d.subarray(q*s,(q+1)*s),"float4x4"==l&&this.transformMatrix(t,p?0==p._depth:0),r.set(t,
q*n+1);c&&this.use_transferables&&r&&r.buffer&&100<r.length&&this._transferables.push(r.buffer);e.data=r;return e},findNode:function(a,b){if(a.id==b)return a;if(a.children)for(var c in a.children){var d=this.findNode(a.children[c],b);if(d)return d}return null},readLibraryControllers:function(a){var b=this._xmlroot.querySelector("library_controllers");if(!b)return null;for(var b=b.childNodes,c=0;c<b.length;++c){var d=b.item(c);if(1==d.nodeType&&"controller"==d.localName){var e=d.getAttribute("id");
this._controllers_found[e]||this.readController(d,null,a)}}},readController:function(a,b,c){if("controller"==!a.localName)return console.warn("readController: not a controller: "+a.localName),null;var d=a.getAttribute("id");if(this._controllers_found[d])return this._controllers_found[d];var e=null,l=a.querySelector("skin");l&&(e=this.readSkinController(l,b,c));(a=a.querySelector("morph"))&&(e=this.readMorphController(a,b,c,e));return this._controllers_found[d]=e},readSkinController:function(a,b,c){var d=
a.getAttribute("source");c=this.readGeometry(d,b,c);if(!c)return null;var e=this.readSources(a,b);if(!e)return null;b=null;(b=a.querySelector("bind_shape_matrix"))?(b=this.readContentAsFloats(b),this.transformMatrix(b,!0,!0)):b=mat4.create();var d=[],l=a.querySelector("joints");if(l){for(var n=null,p=null,q=l.querySelectorAll("input"),l=0;l<q.length;l++){var r=q[l],s=r.getAttribute("semantic").toUpperCase(),r=r.getAttribute("source"),r=e[r.substr(1)];"JOINT"==s?n=r:"INV_BIND_MATRIX"==s&&(p=r)}if(!p||
!n)return console.error("Error DAE: no joints or inv_bind sources found"),null;for(l=0;l<n.length;++l)q=p.subarray(16*l,16*l+16),s=n[l],(r=this._nodes_by_id[s])?(this.transformMatrix(q,0==r._depth,!0),d.push([s,q])):console.warn("Node "+s+" not found")}var r=0,t=[];if(a=a.querySelector("vertex_weights")){for(var u=null,q=a.querySelectorAll("input"),l=0;l<q.length;l++)"WEIGHT"==q[l].getAttribute("semantic").toUpperCase()&&(u=e[q.item(l).getAttribute("source").substr(1)]);if(!u)throw"no weights found";
var l=a.querySelector("vcount"),w=this.readContentAsUInt32(l),l=a.querySelector("v"),x=this.readContentAsUInt32(l);a=c.vertices.length/3;var e=new Float32Array(4*a),n=new Uint8Array(4*a),C=0,p=c._remap;if(!p)throw"no remap info found in mesh";for(var l=q=0,y=w.length;l<y;++l){var z=w[l],s=C;t.length=z;for(var A=0;A<z;++A)t[A]=[u[x[s+2*A+1]],x[s+2*A]];t.sort(this._bones_sort_func);4<t.length&&(t.length=4,r+=1);for(var D=n.subarray(4*l,4*l+4),s=e.subarray(4*l,4*l+4),E=0,A=0;A<t.length;++A)D[A]=t[A][1],
D[A]>q&&(q=D[A]),s[A]=t[A][0],E+=s[A];if(1>E)for(D=1/E,A=0;4>A;++A)s[A]*=D;C+=2*z}r&&console.warn("This mesh has "+r+" vertices with more than 4 bones, skipping extra bones. This could cause errors in the skinning.");r=new Float32Array(4*a);t=new Uint8Array(4*a);u=[];for(l=0;l<a;++l){A=4*p[l];s=e.subarray(A,A+4);D=n.subarray(A,A+4);for(w=0;3>w;++w){x=w;C=s[w];for(A=w+1;4>A;++A)s[A]<=C||(x=A,C=s[A]);x!=w&&(A=s[w],s[w]=s[x],s[x]=A,A=D[w],D[w]=D[x],D[x]=A)}r.set(s,4*l);t.set(D,4*l);s[0]&&(u[D[0]]=!0);
s[1]&&(u[D[1]]=!0);s[2]&&(u[D[2]]=!0);s[3]&&(u[D[3]]=!0)}q>=d.length&&console.warn("Mesh uses higher bone index than bones found");a=[];e={};for(l=0;l<u.length;++l)u[l]&&(e[l]=a.length,a.push(d[l]));if(a.length<d.length){for(l=0;l<t.length;l++)t[l]=e[t[l]];d=a}for(l=0;l<d.length;++l)a=d[l],(e=this._nodes_by_id[a[0]]||this._nodes_by_sid[a[0]])?a[0]=e.id||e.name:console.warn("Bone not found");c.weights=r;c.bone_indices=t;c.bones=d;c.bind_matrix=b}return c},_bones_sort_func:function(a,b){return b[0]-
a[0]},readMorphController:function(a,b,c,d){d=a.getAttribute("source");d=this.readGeometry(d,b,c);if(!d)return null;var e=this.readSources(a,b),l=[];a=a.querySelector("targets");if(!a)return null;for(var n=a.querySelectorAll("input"),p=a=null,q=0;q<n.length;q++){var r=n.item(q),s=r.getAttribute("semantic").toUpperCase(),r=e[r.getAttribute("source").substr(1)];"MORPH_TARGET"==s?a=r:"MORPH_WEIGHT"==s&&(p=r)}if(!a||!p)return console.warn("Morph controller without targets or weights. Skipping it."),null;
for(q in a)e="#"+a[q],n=this.readGeometry(e,b,c),c.meshes[e]=n,l.push({mesh:e,weight:p[q]});d.morph_targets=l;return d},readBindMaterials:function(a,b){for(var c=[],d=a.querySelectorAll("technique_common"),e=0;e<d.length;e++)for(var l=d.item(e).querySelectorAll("instance_material"),n=0;n<l.length;n++){var p=l.item(n);p&&c.push(p.getAttribute("symbol"))}return c},readSources:function(a,b){for(var c={},d=a.querySelectorAll("source"),e=0;e<d.length;e++){var l=d.item(e);if(l.querySelector)if(l.querySelector("float_array")){var n=
this.readContentAsFloats(l);c[l.getAttribute("id")]=n}else(n=l.querySelector("Name_array"))?(n=this.readContentAsStringsArray(n))&&(c[l.getAttribute("id")]=n):(n=l.querySelector("IDREF_array"))&&(n=this.readContentAsStringsArray(n))&&(c[l.getAttribute("id")]=n)}return c},readContentAsUInt32:function(a){if(!a)return null;a=a.textContent;a=a.replace(/\n/gi," ");a=a.replace(/\s\s+/gi," ");a=a.trim();if(0==a.length)return null;a=a.split(" ");for(var b=new Uint32Array(a.length),c=0;c<a.length;c++)b[c]=
parseInt(a[c]);return b},readContentAsFloats:function(a){if(!a)return null;var b=a.textContent,b=b.replace(/\n/gi," "),b=b.replace(/\s\s+/gi," "),b=b.replace(/\t/gi,""),b=b.trim(),b=b.split(" ");a.getAttribute("count");a=new Float32Array(b.length);for(var c=0;c<b.length;c++)a[c]=parseFloat(b[c]);return a},readContentAsStringsArray:function(a){if(!a)return null;for(var b=a.textContent,b=b.replace(/\n/gi," "),b=b.replace(/\s\s/gi," "),b=b.trim(),b=b.split(" "),c=0;c<b.length;c++)b[c]=b[c].trim();if(a.getAttribute("count")&&
parseInt(a.getAttribute("count"))!=b.length){var c=[],d="",e;for(e in b)d=d?d+(" "+b[e]):b[e],this._nodes_by_id[this.safeString(d)]&&(c.push(this.safeString(d)),d="");a=parseInt(a.getAttribute("count"));if(c.length==a)return c;console.error("Error: bone names have spaces, avoid using spaces in names");return null}return b},max3d_matrix_0:new Float32Array([0,-1,0,0,0,0,-1,0,1,0,0,-0,0,0,0,1]),transformMatrix:function(a,b,c){mat4.transpose(a,a);if(this.no_flip)return a;b?(b=new Float32Array(a.subarray(4,
8)),a.set(a.subarray(8,12),4),a.set(b,8),b=a.subarray(8,12),vec4.scale(b,b,-1)):(b=mat4.create(),b.set([a[0],a[2],-a[1]],0),b.set([a[8],a[10],-a[9]],4),b.set([-a[4],-a[6],a[5]],8),b.set([a[12],a[14],-a[13]],12),a.set(b));return a},mergeMeshes:function(a,b){b=b||{};for(var c={},d={},e={},l=[],n=0,p=[],q={triangles:!0,wireframe:!0},r=null,s=0,t=0;t<a.length;++t){var u=a[t],w=n;l.push(w);var x=u.vertices.length/3,n=n+x,C;for(C in u){var y=u[C];"info"!=C&&"_remap"!=C&&(q[C]?d[C]=d[C]?d[C]+y.length:y.length:
c[C]=c[C]?c[C]+y.length:y.length)}p.push({name:"mesh_"+(u.info.material||t),start:w,length:x,material:u.info.material||""})}for(C in c)t=b[C],null===t?delete c[C]:(t||(t=Float32Array),c[C]=new t(c[C]),e[C]=0);for(C in d)d[C]=new Uint32Array(d[C]),e[C]=0;for(t=0;t<a.length;++t){u=a[t];y=u.vertices;if(!y)return console.error("mesh without vertices");x=y.length/3;for(C in u)if(y=u[C],"info"!=C){if("_remap"==C){if(s)for(var n=y,w=s,A=0+y.length,z=0;z<A;++z)n[z]+=w;r?(n=new Uint32Array(r.length+y.length),
n.set(r),n.set(y,r.length),r=n):(r=new Uint32Array(y.length),r.set(y));s+=x}if(q[C]){d[C].set(y,e[C]);n=d[C];z=e[C];w=l[t];for(A=z+y.length;z<A;++z)n[z]+=w;e[C]+=y.length}else c[C]&&(c[C].set(y,e[C]),e[C]+=y.length)}}e={info:{groups:p}};for(t in c)e[t]=c[t];for(t in d)e[t]=d[t];r&&(e._remap=r);return e}};c?(Collada.loadInWorker=function(a,b){Collada.load(b,a)},Collada.parseInWorker=function(a,b){a(Collada.parse(b))}):(Collada.launchWorker=function(){var a=this.worker=new Worker(Collada.workerPath+
"collada.js");a.callback_ids={};a.addEventListener("error",function(a){if(Collada.onerror)Collada.onerror(err)});a.addEventListener("message",function(a){if(a.data)switch(a=a.data,a.action){case "log":console.log.apply(console,a.params);break;case "warn":console.warn.apply(console,a.params);break;case "exception":console.error.apply(console,a.params);if(Collada.onerror)Collada.onerror(a.msg);break;case "error":console.error.apply(console,a.params);break;case "result":var b=this.callback_ids[a.callback_id];
if(!b)throw"callback not found";b(a.result);break;default:console.warn("Unknown action:",a.action)}});this.callback_ids={};this.last_callback_id=1;this.toWorker("init",[this.config])},Collada.toWorker=function(a,b,c){this.worker||this.launchWorker();var d=this.last_callback_id++;this.worker.callback_ids[d]=c;this.worker.postMessage({func:a,params:b,callback_id:d})},Collada.loadInWorker=function(a,b){this.toWorker("loadInWorker",[a],b)},Collada.parseInWorker=function(a,b){this.toWorker("parseInWorker",
[a],b)});c&&self.addEventListener("message",function(a){if("init"==a.data.func)return Collada.init.apply(Collada,a.data.params);var b=a.data.func,c=a.data.params,d=a.data.callback_id;a=function(a){self.postMessage({action:"result",callback_id:d,result:a},Collada._transferables);Collada._transferables=null};var e=Collada[b];if(void 0===e)console.error("function not found:",b),a(null);else try{e.apply(Collada,c?[a].concat(c):[a])}catch(l){console.error("Error inside worker function call to "+b+" :: "+
l),a(null)}},!1)})("undefined"!=typeof window?window:self);e.Formats.addSupportedFormat("dae",{extension:"dae",type:"scene",resource:"SceneNode",format:"text",dataType:"text",convert_filenames_to_lowercase:!0,parse:function(a,b,c){function d(a){a.id&&!b.skip_renaming&&(a.uid="@"+h+"::"+a.id,f[a.id]=a.uid);a.type&&(a.node_type=a.type,delete a.type);if(a.material){var c=a.material.replace(/[^a-z0-9\.\-]/gi,"_")+".json";f[a.material]=c;a.material=c}if(a.materials)for(var e in a.materials)c=a.materials[e].replace(/[^a-z0-9\.\-]/gi,
"_")+".json",f[a.material]=c,a.materials[e]=c;if(a.meshes)for(e=0;e<a.meshes.length;e++)a.meshes[e]&&f[a.meshes[e]]&&(a.meshes[e]=f[a.meshes[e]]);a.mesh&&f[a.mesh]&&(a.mesh=f[a.mesh]);if(a.children)for(e in a.children)d(a.children[e])}if(!a||a.constructor!==String)return console.error("DAE parser requires string"),null;Collada.material_translate_table={reflectivity:"reflection_factor",specular:"specular_factor",shininess:"specular_gloss",emission:"emissive",diffuse:"color"};c=e.RM.getFilename(c);
a=Collada.parse(a,b,c);console.log(a);a.root.name=c;a.metadata&&"Z_UP"==a.metadata.up_axis&&(a.root.model=mat4.rotateX(mat4.create(),mat4.create(),-90*0.0174532925));var f={},h=c.substr(0,c.indexOf("."));c={};for(var g in a.meshes){var k=h+"__"+g+".wbin",k=k.replace(/[^a-z0-9\.\-]/gi,"_");f[g]=k;c[k]=a.meshes[g]}a.meshes=c;for(g in a.meshes)c=a.meshes[g],this.processMesh(c,f);d(a.root);for(g in a.meshes)if(c=a.meshes[g],c.bones)for(var m in c.bones)(k=f[c.bones[m][0]])&&(c.bones[m][0]=k);a.root.animation&&
(a.root.animation=this.renameResource(a.root.animation,a.root.animation+".wbin",a.resources));m={};for(g in a.materials)c=a.materials[g],this.processMaterial(c),m[c.id]=c;a.materials=m;for(g in a.resources)m=a.resources[g],e.ResourcesManager.getBasename(g)||console.warn("DAE contains resources without extension: "+g,m.constructor),"Animation"==m.object_class&&this.processAnimation(m,f);return a},renameResource:function(a,b,c){var d=c[a];if(!d)return c[b]||console.warn("Resource not found: "+a),b;
delete c[a];c[b]=d;return d.filename=b},processMesh:function(a,b){if(a.vertices){var c=a.vertices.length/3,d=a.coords?a.coords.length/2:0;if(d&&d!=c){var e=a.coords,h=new Float32Array(2*c);if(d>c)for(d=0;d<c;++d)h[2*d]=e[3*d],h[2*d+1]=e[3*d+1];a.coords=h}if(a.morph_targets)for(c=0;c<a.morph_targets.length;++c)e=a.morph_targets[c],e.mesh&&b[e.mesh]&&(e.mesh=b[e.mesh])}},processAnimation:function(a,b){for(var c in a.takes){for(var d=a.takes[c],e=0;e<d.tracks.length;++e){var h=d.tracks[e],g=h.property.indexOf("/");
if(g){var k=h.property.substr(0,g),m=h.property.substr(g);"/transform"==m&&(m="/matrix");b[k]&&(k=b[k],h.property=k+m)}}m={};for(e=0;e<d.tracks.length;++e)if(h=d.tracks[e],h.packed_data=!0,"rotateX.ANGLE"==h.name||"rotateY.ANGLE"==h.name||"rotateZ.ANGLE"==h.name)k=h.property.split("/")[0],m[k]||(m[k]={tracks:[]}),m[k].tracks.push(h);for(e in m){for(var k=m[e],g={data:[],type:"quat",value_size:4,property:e+"/Transform/rotation",name:"rotation"},l=[],n=0;n<k.tracks.length;++n)for(var h=k.tracks[n],
h=h.data,p=0;p<h.length;p+=2)l.push(h[p]);l.sort();h=-1;p=[];for(n=0;n<l.length;++n)l[n]!=h&&(p.push(l[n]),h=l[n]);l=p;g.data.length=l.length;for(n=0;n<g.data.length;++n){var q=l[n],r=quat.create();g.data[n]=[q,r];for(p=0;p<k.tracks.length;++p){var h=k.tracks[p],s;a:{s=h.data;for(var t=s.length,u=0;u<t;u+=2){if(s[u]==q){s=s[u+1];break a}if(s[u]>q){s=null;break a}}s=null}if(s)switch(s*=0.0174532925,h.name){case "rotateX.ANGLE":quat.rotateX(r,r,-s);break;case "rotateY.ANGLE":quat.rotateY(r,r,s);break;
case "rotateZ.ANGLE":quat.rotateZ(r,r,s)}}}d.tracks.push(g);for(p=0;p<k.tracks.length;++p)h=k.tracks[p],g=d.tracks.indexOf(h),-1!=g&&d.tracks.splice(g,1)}}},processMaterial:function(a){var b={specular_factor:"specular",transparent:"opacity"};a.object_class="StandardMaterial";a.id&&(a.id=a.id.replace(/[^a-z0-9\.\-]/gi,"_")+".json");void 0!==a.transparency&&(a.opacity=1);a.specular_factor&&a.specular_factor.length&&(a.specular_factor=a.specular_factor[0]);if(a.textures){var c={},d;for(d in a.textures){var f=
a.textures[d],h=d;b[h]&&(h=b[h]);var g=f.map_id;this.convert_filenames_to_lowercase&&(g=g.toLowerCase());var k=e.Material.COORDS_UV0;"TEX1"==f.uvs&&(k=e.Material.COORDS_UV1);f={texture:g,uvs:k};c[h]=f}a.textures=c}}});e.Formats.addSupportedFormat("dds",{extension:"dds",type:"image",dataType:"arraybuffer",resource:"Texture",format:"binary",parse:function(a,b){if(!a||a.constructor!==ArrayBuffer)throw"ParserDDS: data must be ArrayBuffer";var c=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),
d=new GL.Texture(0,0,b);if(!window.DDS)throw"dds.js script must be included, not found";DDS.loadDDSTextureFromMemoryEx(gl,c,a,d,!0);return d}});e.Formats.addSupportedFormat("jsmesh",{extension:"jsmesh",type:"mesh",format:"text",dataType:"string",parse:function(a,b){var c=null;"object"==typeof a?c=a:"string"==typeof a&&(c=JSON.parse(a));c.vertices.constructor==Array&&(c.vertices="number"==typeof c.vertices[0]?c.vertices:linearizeArray(c.vertices),c.normals&&(c.normals="number"==typeof c.normals[0]?
c.normals:linearizeArray(c.normals)),c.coords&&(c.coords="number"==typeof c.coords[0]?c.coords:linearizeArray(c.coords)),c.triangles&&(c.triangles="number"==typeof c.triangles[0]?c.triangles:linearizeArray(c.triangles)),c.vertices=new Float32Array(c.vertices),c.normals&&(c.normals=new Float32Array(c.normals)),c.coords&&(c.coords=new Float32Array(c.coords)),c.triangles&&(c.triangles=new Uint16Array(c.triangles)));c.bounding||(c.bounding=e.Formats.computeMeshBounding(c.vertices));return c}});e.Formats.addSupportedFormat("obj",
{extension:"obj",type:"mesh",resource:"Mesh",format:"text",dataType:"text",flipAxis:!1,parse:function(a,b){function c(a){var b,c,d,e=!1;if(-1==a.indexOf("-")){var f=t.get(a);if(void 0!==f)return f}else e=!0;d||(d=a.split("/"));if(1==d.length)d=c=b=parseInt(d[0]);else if(2==d.length)b=parseInt(d[0]),c=parseInt(d[1]),d=b;else if(3==d.length)b=parseInt(d[0]),c=parseInt(d[1]),d=parseInt(d[2]);else return console.log("Problem parsing: unknown number of values per face"),-1;0>b&&(b=h.length/3+b+1);0>d&&
(d=g.length/2+d+1);0>c&&(c=k.length/2+c+1);if(e&&(a=b+"/"+c+"/"+d,f=t.get(a),void 0!==f))return f;b-=1;c-=1;d-=1;m.push(h[3*b+0],h[3*b+1],h[3*b+2]);k.length&&n.push(k[2*c+0],k[2*c+1]);g.length&&l.push(g[3*d+0],g[3*d+1],g[3*d+2]);f=u;t.set(a,f);++u;return f}function d(a){a={name:a||"",material:"",start:-1,length:-1,indices:[]};p.push(a);return a}function e(a){if(!s.material)return s.material=a+".json",q[a]=s;var b=q[a];b||(b=d(r+"_"+a),b.material=a+".json",q[a]=b);return s=b}for(var h=[],g=[],k=[],
m=[],l=[],n=[],p=[],q={},r=null,s=d(),t=new Map,u=0,w={v:1,vt:2,vn:3,f:4,g:5,o:6,usemtl:7,mtllib:8},x,y,z,A=a.split("\n"),D=A.length,E=0;E<D;++E){var B=A[E],B=B.replace(/[ \t]+/g," ").replace(/\s\s*$/,"");if("\\"==B[B.length-1])var E=E+1,F=A[E].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),B=(B.substr(0,B.length-1)+F).replace(/[ \t]+/g," ").replace(/\s\s*$/,"");if("#"!=B[0]&&""!=B)switch(F=B.split(" "),B=w[F[0]],3>=B&&(x=parseFloat(F[1]),y=parseFloat(F[2]),2!=B&&(z=parseFloat(F[3]))),B){case 1:h.push(x,
y,z);break;case 2:k.push(x,y);break;case 3:g.push(x,y,z);break;case 4:if(4>F.length)continue;for(var H=[],B=1;B<F.length;++B)H.push(c(F[B]));s.indices.push(H[0],H[1],H[2]);for(B=2;B<H.length-1;++B)s.indices.push(H[0],H[B],H[B+1]);break;case 5:case 6:r=B=F[1];s.name?(q={},s=d(B)):s.name=B;break;case 7:e(F[1])}}w=[];x=0;y=[];for(B=0;B<p.length;++B)s=p[B],s.indices&&(s.start=x,s.length=s.indices.length,w=w.concat(s.indices),delete s.indices,x+=s.length,y.push(s));p=y;y={};if(!h.length)return console.error("mesh without vertices"),
null;y.vertices=new Float32Array(m);l.length&&(y.normals=new Float32Array(l));n.length&&(y.coords=new Float32Array(n));w&&0<w.length&&(y.triangles=new (65536<x?Uint32Array:Uint16Array)(w));y.bounding=GL.Mesh.computeBoundingBox(y.vertices);w={};1<p.length&&(w.groups=p);y.info=w;if(!y.bounding)return console.log("empty mesh"),null;(0==y.bounding.radius||isNaN(y.bounding.radius))&&console.log("no radius found in mesh");return y},parse2:function(a,b){b=b||{};for(var c=b.noindex?b.noindex:!1,d=[],e=[],
h=[],g=[],k=[],m=[],l=[],n={},p=0,q=null,r=null,s=0,t=0,u=0,w=r=0,y=0,x=null,z=!1,A=!1,B=!1,D=!1,E=0,F=this.flipAxis||b.flipAxis,H=F||b.flipNormals,I=null,M=0,L=[],N={},P={v:1,vt:2,vn:3,f:4,g:5,o:6},Q=a.split("\n"),S=Q.length,R=0;R<S;++R)if(q=Q[R],q=q.replace(/[ \t]+/g," ").replace(/\s\s*$/,""),"\\"==q[q.length-1]&&(R+=1,x=Q[R].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),q=(q.substr(0,q.length-1)+x).replace(/[ \t]+/g," ").replace(/\s\s*$/,"")),"#"!=q[0]&&""!=q){var x=q.split(" "),J=P[x[0]];D&&1==
J&&(D=!1);3>=J&&(r=parseFloat(x[1]),w=parseFloat(x[2]),y=parseFloat(x[3]));if(1==J)F?k.push(-1*r,y,w):k.push(r,w,y);else if(2==J)m.push(r,w);else if(3==J)H?l.push(-w,-y,r):l.push(r,w,y);else if(4==J){if(D=!0,!(4>x.length)){q=[];for(J=1;J<x.length;++J){var U=M+":"+x[J];if(!(U in n)||c){r=x[J].split("/");if(1==r.length)u=t=s=parseInt(r[0])-1;else if(2==r.length)s=parseInt(r[0])-1,t=parseInt(r[1])-1,u=-1;else if(3==r.length)s=parseInt(r[0])-1,t=parseInt(r[1])-1,u=parseInt(r[2])-1;else return console.log("Problem parsing: unknown number of values per face"),
!1;3<J&&c&&(r=d.length,d.push(d[r-9*(J-3)],d[r-9*(J-3)+1],d[r-9*(J-3)+2]),d.push(d[r-3],d[r-2],d[r-1]),r=e.length,e.push(e[r-6*(J-3)],e[r-6*(J-3)+1]),e.push(e[r-2],e[r-1]),r=h.length,h.push(h[r-9*(J-3)],h[r-9*(J-3)+1],h[r-9*(J-3)+2]),h.push(h[r-3],h[r-2],h[r-1]));y=w=r=0;3*s+2<k.length&&(z=!0,0>s&&(s=k.length/3+s+1),r=k[3*s+0],w=k[3*s+1],y=k[3*s+2]);d.push(r,w,y);w=r=0;2*t+1<m.length&&(A=!0,0>t&&(t=m.length/2+t+1),r=m[2*t+0],w=m[2*t+1]);e.push(r,w);w=r=0;y=1;-1!=u&&(3*u+2<l.length&&(B=!0,0>u&&(u=
l.length/3+u+1),r=l[3*u+0],w=l[3*u+1],y=l[3*u+2]),h.push(r,w,y));c||(n[U]=p++)}c||(s=n[U],q.push(s),E<s&&(E=s))}if(!c)for(x=2;x<q.length;x++)g.push(q[0],q[x-1],q[x])}}else if(5==J||6==J){if(1<x.length){q=g.length?g.length:d.length/3;null!=I&&(I.length=q-I.start,0<I.length&&(N[T]=I,L.push(I),M++));var T=x[1];N[T]&&(T=T+"."+M);I={name:T,start:q,length:-1,material:""}}}else if("mtllib"!=x[0])if("usemtl"==x[0])I&&(I.material=x[1]);else if("s"!=x[0]){console.warn("unknown code: "+q);break}}I&&1<g.length-
I.start&&(I.length=g.length-I.start,L.push(I));c={};z&&(c.vertices=new Float32Array(d));B&&0<h.length&&(c.normals=new Float32Array(h));A&&0<e.length&&(c.coords=new Float32Array(e));g&&0<g.length&&(c.triangles=new (65536<E?Uint32Array:Uint16Array)(g));c.bounding=GL.Mesh.computeBoundingBox(c.vertices);d={};1<L.length&&(d.groups=L);c.info=d;if(!c.bounding)return console.log("empty mesh"),null;(0==c.bounding.radius||isNaN(c.bounding.radius))&&console.log("no radius found in mesh");return c}});e.Formats.addSupportedFormat("mtl",
{extension:"mtl",type:"material",resource:"StandardMaterial",format:"text",dataType:"text",parse:function(a,b){function c(a){return[parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3])]}for(var d=a.split("\n"),f=d.length,h={},g=null,k=0;k<f;++k){var m=d[k].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),m=m.trim();if("#"!=m[0]&&""!=m){var m=m.split(" "),l=m[0];switch(l){case "newmtl":m=m[1]+".json";g={filename:m,textures:{}};h[m]=g;break;case "Ka":g.ambient=c(m);break;case "Kd":g.color=c(m);break;case "Ks":g.specular_factor=
parseFloat(m[1]);break;case "Ke":g.emissive=c(m);break;case "Ns":g.specular_gloss=parseFloat(m[1]);break;case "Tr":g.reflection=parseFloat(m[1]);break;case "map_Kd":g.textures.color=this.clearPath(m[1]);g.color=[1,1,1];break;case "map_Ka":g.textures.ambient=this.clearPath(m[1]);g.ambient=[1,1,1];break;case "map_Ks":g.textures.specular=this.clearPath(m[1]);g.specular_factor=1;break;case "map_d":g.textures.opacity=this.clearPath(m[1]);g.blend_mode=e.Blend.ALPHA;break;case "bump":case "map_bump":g.textures.bump=
this.clearPath(m[1]);break;case "d":g.opacity=parseFloat(m[1]);break;case "Tr":g.opacity=parseFloat(m[1]);break;case "illum":case "Tf":case "Ni":break;default:console.log("Unknown MTL info: ",l)}}}for(var n in h)d=h[n],d.ambient=[1,1,1],f=new e.StandardMaterial(d),e.RM.registerResource(d.filename,f);return null},clearPath:function(a){var b=a.lastIndexOf("\\");-1!=b&&(a=a.substr(b+1));a=e.RM.getFilename(a);e.RM.resources_renamed_recently[a]&&(a=e.RM.resources_renamed_recently[a]);return a.toLowerCase()}});
e.Formats.addSupportedFormat("stl",{extension:"stl",type:"mesh",format:"binary",dataType:"arraybuffer",parse:function(a,b){var c=[],d=[],f=[],h=new DataView(a,80),g=h.getUint32(0,!0);console.log("number of triangles: "+g);for(var k=4,m=vec3.create(),l=vec3.create(),n=vec3.create(),p=vec3.create(),q=0;q<g;q++){for(var r=h.getFloat32(k,!0),s=h.getFloat32(k+4,!0),t=h.getFloat32(k+8,!0),k=k+12,u=0;3>u;u++){var w=h.getFloat32(k,!0),x=h.getFloat32(k+4,!0),y=h.getFloat32(k+8,!0);c.push(w,y,-x);k+=12}0==
r&&0==s&&0==t&&(r=c.length,m.set(c.slice(r-9,r-6)),l.set(c.slice(r-6,r-3)),n.set(c.slice(r-3,r)),vec3.sub(l,l,m),vec3.sub(n,n,m),vec3.cross(p,n,l),r=p[0],s=p[1],t=p[2]);d.push(r,t,-s,r,t,-s,r,t,-s);k+=2}h={info:{}};h.vertices=new Float32Array(c);0<d.length&&(h.normals=new Float32Array(d));f&&0<f.length&&(h.triangles=new Uint16Array(f));h.bounding=e.Formats.computeMeshBounding(h.vertices);return h}});e.Formats.addSupportedFormat("tga",{extension:"tga",type:"image",dataType:"arraybuffer",format:"binary",
parse:function(a,b){if(!a||a.constructor!==ArrayBuffer)throw"ParserTGA: data must be ArrayBuffer";a=new Uint8Array(a);for(var c=new Uint8Array([0,0,2,0,0,0,0,0,0,0,0,0]),d=a.subarray(0,12),e=0;e<d.length;e++)if(c[e]!=d[e])return console.error("TGA header is not valid"),null;e=a.subarray(12,18);c={};c.width=256*e[1]+e[0];c.height=256*e[3]+e[2];c.bpp=e[4];c.bytesPerPixel=c.bpp/8;c.imageSize=c.width*c.height*c.bytesPerPixel;c.pixels=a.subarray(18,18+c.imageSize);c.pixels=new Uint8Array(c.pixels);for(var d=
c.pixels,e=0,h=c.imageSize,g=c.bytesPerPixel;e<h;e+=g){var k=d[e];d[e]=d[e+2];d[e+2]=k}c.format=32==c.bpp?"RGBA":"RGB";c.flipY=!0;return c}});Object.defineProperty(ja.prototype,"file_drop_enabled",{set:function(a){this.setFileDrop(a)},get:function(){return this._file_drop_enabled},enumerable:!0});ja.prototype.loadConfig=function(a,b,c){var d=this;e.Network.requestJSON(a,function(a){d.configure(a,c);b&&b(a)})};ja.prototype.configure=function(a,b){this.autoplay=void 0!==a.autoplay?a.autoplay:!0;a.debug?
this.enableDebug():this.enableDebug(!1);void 0!==a.resources&&e.ResourcesManager.setPath(a.resources);a.proxy&&e.ResourcesManager.setProxy(a.proxy);if(a.filesystems)for(var c in a.filesystems)e.ResourcesManager.registerFileSystem(c,a.filesystems[c]);a.allow_base_files&&(e.ResourcesManager.allow_base_files=a.allow_base_files);a.autoresize&&!this._resize_callback&&(this._resize_callback=function(){this.canvas.width=this.canvas.parentNode.offsetWidth;this.canvas.height=this.canvas.parentNode.offsetHeight}.bind(this),
window.addEventListener("resize",this._resize_callback));a.loadingbar?this.loading||this.enableLoadingBar():!1===a.loadingbar&&(this.loading=null);this.force_redraw=a.redraw||!1;a.debug_render&&this.setDebugRender(!0);a.scene_url&&this.loadScene(a.scene_url,b)};ja.STOPPED=0;ja.PLAYING=1;ja.PAUSED=2;ja.prototype.loadScene=function(a,b,c){var d=this,e=this.scene;this.loading&&(this.loading.visible=!0);e.load(a,null,null,function(a){if(null!=d.loading){var b=0;a.total&&(b=a.loaded/a.total);d.loading.scene_loaded=
b;c&&c(b)}},function(){d.autoplay&&d.play();d.loading&&(d.loading.visible=!1);b&&b()})};ja.prototype.setScene=function(a,b,c){function d(){g.configure(a);g.loadResources(f)}function f(){c&&c(g);h.autoplay&&h.play();g._must_redraw=!0;console.log("Scene playing");b&&b(g)}var h=this,g=this.scene;this.state==e.Player.PLAYING&&this.stop();g.clear();a&&a.constructor===String&&(a=JSON.parse(a));var k=e.Scene.getScriptsList(a);k&&k.length?(g.clear(),g.loadScripts(k,d)):d()};ja.prototype.pause=function(){this.state=
e.Player.PAUSED};ja.prototype.play=function(){this.state!=e.Player.PLAYING&&(this.debug&&console.log("Start"),this.state=e.Player.PLAYING,e.Input&&e.Input.reset(),e.GUI&&e.GUI.reset(),this.scene.start())};ja.prototype.stop=function(){this.state=e.Player.STOPPED;this.scene.finish();e.GUI&&e.GUI.reset()};ja.prototype.clear=function(){e.Input&&e.Input.reset();e.GUI&&e.GUI.reset();this.scene.clear()};ja.prototype.setFileDrop=function(a){function b(a){a.stopPropagation();a.preventDefault()}function c(a){e.addEventListener("dragexit",
this._onDragStop);e.addEventListener("dragover",this._onDragStop);e.addEventListener("drop",this._onDrop);a.stopPropagation();a.preventDefault()}function d(a){a.stopPropagation();a.preventDefault();e.removeEventListener("dragexit",this._onDragStop);e.removeEventListener("dragover",this._onDragStop);e.removeEventListener("drop",this._onDrop);if(a.dataTransfer.files.length)for(var b=0;b<a.dataTransfer.files.length;++b)!1===this._onfiledrop(a.dataTransfer.files[b],a)&&(a.stopPropagation(),a.stopImmediatePropagation())}
if(this._file_drop_enabled!=a){var e=this.canvas;a?(this._file_drop_enabled=a,this._onDrag=c.bind(this),this._onDrop=d.bind(this),this._onDragStop=b.bind(this),e.addEventListener("dragenter",this._onDrag)):e.removeEventListener("dragenter",this._onDrag)}};ja.prototype.enableLoadingBar=function(){this.loading={visible:!0,scene_loaded:0,resources_loaded:0};LEvent.bind(e.ResourcesManager,"start_loading_resources",function(a,b){this.loading&&(this.loading.resources_loaded=0)}.bind(this));LEvent.bind(e.ResourcesManager,
"loading_resources_progress",function(a,b){this.loading&&this.loading.resources_loaded<b&&(this.loading.resources_loaded=b)}.bind(this));LEvent.bind(e.ResourcesManager,"end_loading_resources",function(a,b){this.loading&&(this._total_loading=void 0,this.loading.resources_loaded=1,this.loading.visible=!1)}.bind(this))};ja.prototype._onfiledrop=function(a,b){return LEvent.trigger(e.GlobalScene,"fileDrop",{file:a,event:b})};ja.prototype._ondraw=function(){var a=this.scene;if(this.state==e.Player.PLAYING){if(this.onPreDraw)this.onPreDraw();
(a._must_redraw||this.force_redraw)&&a.render(a.info&&a.info.render_settings?a.info.render_settings:this.render_settings);if(this.onDraw)this.onDraw()}if(this.loading&&this.loading.visible&&(this.renderLoadingBar(this.loading),LEvent.trigger(this.scene,"render_loading"),this.onDrawLoading))this.onDrawLoading()};ja.prototype._onupdate=function(a){if(this.state==e.Player.PLAYING){e.Tween&&e.Tween.update(a);e.Input&&e.Input.update(a);if(this.onPreUpdate)this.onPreUpdate(a);this.scene.update(a);if(this.onUpdate)this.onUpdate(a)}};
ja.prototype._onmouse=function(a){if((!e.Input||!0!=e.Input.onMouse(a))&&this.state==e.Player.PLAYING&&(LEvent.trigger(this.scene,a.eventType||a.type,a,!0),this.onMouse))this.onMouse(a)};ja.prototype._ontouch=function(a){if(this.state==e.Player.PLAYING){if(!0===LEvent.trigger(this.scene,a.eventType||a.type,a,!0))return!1;if(this.onTouch)this.onTouch(a)}};ja.prototype._onkey=function(a){if(e.Input)e.Input.onKey(a);this.state!=e.Player.PLAYING||this.onKey&&this.onKey(a)||LEvent.trigger(this.scene,a.eventType||
a.type,a)};ja.prototype._ongamepad=function(a){this.state!=e.Player.PLAYING||this.onGamepad&&this.onGamepad(a)||LEvent.trigger(this.scene,a.eventType||a.type,a)};ja.prototype.renderLoadingBar=function(a){a&&Y.enableWebGLCanvas&&(gl.canvas.canvas2DtoWebGL_enabled||enableWebGLCanvas(gl.canvas),gl.start2D(),gl.fillColor=[0,0,0,1],gl.fillRect(0,0,gl.drawingBufferWidth,8),gl.fillColor=a.bar_color||[0.5,0.9,1,1],gl.fillRect(0,0,gl.drawingBufferWidth*a.scene_loaded,4),gl.fillColor=a.bar_color||[0.9,0.5,
1,1],gl.fillRect(0,4,gl.drawingBufferWidth*a.resources_loaded,4),gl.finish2D())};ja.prototype.enableDebug=function(a){this.debug=!!a;e.Script.catch_important_exceptions=!a;e.catch_exceptions=!a};ja.prototype.setDebugRender=function(a){if(!this.debug_render){if(!a)return;this.debug_render=new e.DebugRender}a?this.debug_render.enable():this.debug_render.disable()};e.Player=ja;e.getCurveValueAt=function(a,b,c,d,e){if(e<b||e>c)return d;b=[b,d];for(var h=0,h=0;h<a.length;h+=1){var g=a[h];if(e==g[0])return g[1];
if(e<g[0])return h=(e-b[0])/(g[0]-b[0]),b[1]*(1-h)+g[1]*h;b=g}g=[c,d];h=(e-b[0])/(g[0]-b[0]);return b[1]*(1-h)+g[1]*h};e.resampleCurve=function(a,b,c,d,f){var h=[];h.length=f;for(var g=(c-b)/f,k=0;k<f;k++)h[k]=e.getCurveValueAt(a,b,c,d,b+g*k);return h};Object.prototype.hasOwnProperty("defineAttribute")||(Object.defineProperty(Object.prototype,"defineAttribute",{value:function(a,b,c){c&&"string"==typeof c&&(c={type:c});var d=this;"function"!=typeof this&&(this[a]=b,d=this.constructor);Object.defineProperty(d,
"@"+a,{value:c||{},enumerable:!1})},enumerable:!1,writable:!0}),Object.defineProperty(Object.prototype,"getAttribute",{value:function(a){a="@"+a;return this.hasOwnProperty(a)?this[a]:this.constructor&&this.constructor.hasOwnProperty(a)?this.constructor[a]:null},enumerable:!1,writable:!0}));String.prototype.hasOwnProperty("hashCode")||Object.defineProperty(String.prototype,"hashCode",{value:function(){var a=0,b,c,d;if(0==this.length)return a;b=0;for(d=this.length;b<d;++b)c=this.charCodeAt(b),a=(a<<
5)-a+c,a|=0;return a},enumerable:!1});Object.equals=function(a,b){if(a===b)return!0;if(!(a instanceof Object&&b instanceof Object)||a.constructor!==b.constructor)return!1;for(var c in a)if(a.hasOwnProperty(c)&&(!b.hasOwnProperty(c)||a[c]!==b[c]&&("object"!==typeof a[c]||!Object.equals(a[c],b[c]))))return!1;for(c in b)if(b.hasOwnProperty(c)&&!a.hasOwnProperty(c))return!1;return!0};Array.prototype.hasOwnProperty("equal")||Object.defineProperty(Array.prototype,"equal",{value:function(a){for(var b=0;b<
this.length;++b)if(this[b]!=a[b])return!1;return!0},enumerable:!1});Float32Array.prototype.hasOwnProperty("equal")||Object.defineProperty(Float32Array.prototype,"equal",{value:function(a){for(var b=0;b<this.length;++b)if(this[b]!=a[b])return!1;return!0},enumerable:!1});E=e.GlobalScene=new e.Scene;e.newMeshNode=function(a,b){var c=new e.SceneNode(a);c.addComponent(new e.Components.MeshRenderer);c.setMesh(b);return c};e.newLightNode=function(a){a=new e.SceneNode(a);a.addComponent(new e.Components.Light);
return a};e.newCameraNode=function(a){a=new e.SceneNode(a);a.addComponent(new e.Components.Camera);return a};Y.LS=e})("undefined"!=typeof window?window:self);
